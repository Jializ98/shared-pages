[
  {
    "objectID": "workflow_micro_NYC.html",
    "href": "workflow_micro_NYC.html",
    "title": "workflow_micro_NYC",
    "section": "",
    "text": "Check the variogram\ndiagnistic for model\nscale up\nmarginal prediction\nKey highlights (coordinate them with Juwon):\n\nWithin-city variation, fall phenology: Katz et al., 2019 Xing et al., 2022. A few papers about intra-urban variation of phenology. Few about the fall phenology.\nPhenology pace, different taxa\n\nPreseason Optimization: At the year-, site-, and taxa-level. Individual-level pre-period might have some built-in relationship.\nPace: As for the algorithm, more uncertainty around 0% and 100%. Use thresholds within the period (20–80%) to represent pace.\nSpatial regression: Use nimble package to address spatial autocorrelation."
  },
  {
    "objectID": "workflow_micro_NYC.html#insert-tree-id-base-on-wu-data",
    "href": "workflow_micro_NYC.html#insert-tree-id-base-on-wu-data",
    "title": "workflow_micro_NYC",
    "section": "",
    "text": "For exploratory analysis, I used the street tree in NYC, with the phenology information established by Yiluan. These trees are part of the whole inventory, covering only 14 genera and being sampled. I select the trees which are within 500-m buffer around the weather underground sites.\n\n\nCode\n################ For phenology data ################\n\nmetadata &lt;- read_csv(\"~/lab-data/datasets/vegetation/PS/urban/metadata.csv\") %&gt;%\n  filter(site == \"NY\")\n\nfile_list &lt;- list.files(path = \"~/lab-data/datasets/vegetation/PS/urban/doy/\", pattern = \"^doy_NY_.*\\\\.rds$\", full.names = TRUE)\ndata_list &lt;- file_list %&gt;%\n  map(~ readRDS(.x))\nny_now &lt;- bind_rows(data_list)\n\ntree_location &lt;- metadata %&gt;%\n  mutate(genus = str_extract(taxa, \"^[^ ]+\")) %&gt;%\n  left_join(ny_now, by = \"id\") %&gt;%\n  filter(!is.na(doy)) %&gt;%\n  st_as_sf(coords = c(\"lon\", \"lat\"), crs = 4326)\n\nwu_location &lt;- read_csv(\"~/urban-cooling/data/raw/WU/NY/location.csv\") %&gt;%\n  st_as_sf(coords = c(\"Lon\", \"Lat\"), crs = 4326)\nwu_buffer &lt;- st_buffer(wu_location, dist = 500)\n\nintersects &lt;- st_intersects(tree_location, wu_buffer)\npoints_in_buffer &lt;- tree_location[lengths(intersects) &gt; 0, ]\npoints_in_buffer &lt;- tree_location %&gt;%\n  mutate(buffer_id = sapply(intersects, function(x) if (length(x) &gt; 0) x[1] else NA)) %&gt;% \n  left_join(wu_buffer %&gt;% st_drop_geometry() %&gt;% mutate(buffer_id = row_number()), by = \"buffer_id\") %&gt;%\n  filter(!is.na(buffer_id)) %&gt;%\n  select(-buffer_id)\n\n# write_csv(points_in_buffer, \"~/phenology-urban/data/proc/nyc/tree_WU_500_buffer_PS.csv\")\n# points_in_buffer &lt;- read_csv(\"data/proc/nyc/tree_WU_500_buffer_PS.csv\")\n\n\n\n\nCode\nnyboundary &lt;- st_read(\"~/urban-cooling/data/raw/NYC/boundary/nybb_dissolved.shp\") %&gt;%\n  st_transform(4326)\n\n\nReading layer `nybb_dissolved' from data source \n  `/Volumes/seas-zhukai/proj-urban-cooling/data/raw/NYC/boundary/nybb_dissolved.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 1 feature and 1 field\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 913175.1 ymin: 120128.4 xmax: 1067383 ymax: 272844.3\nProjected CRS: NAD83 / New York Long Island (ftUS)\n\n\nCode\nggplot() +\n  geom_sf(data = nyboundary, fill = \"grey\") +\n  geom_sf(data = wu_location, color = \"blue\", size = 1) +\n  geom_sf(data = points_in_buffer, color = \"red\", size = 0.05) +\n  theme_minimal()\n\n\n\n\n\nLocation of WU sites and trees"
  },
  {
    "objectID": "workflow_micro_NYC.html#creat-the-climate-variable",
    "href": "workflow_micro_NYC.html#creat-the-climate-variable",
    "title": "workflow_micro_NYC",
    "section": "2. Creat the climate variable",
    "text": "2. Creat the climate variable\n\n2.1 Read and clean the WU data (based on GHCNd)\nThere are 4 raw daily variables selected, i.e. AvgTemp, HighTemp, LowTemp and Precipitation_sum (Sum_mm). I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily GHCNd.\n\n\nCode\n# source(\"script/read_clean_WU.R\")\n# all_sites_temp &lt;- read_clean_WU(city = \"NY\", run_checks = TRUE)\nall_sites_temp &lt;- readRDS(\"~/urban-cooling/data/raw/WU/NY/NY_wu.rds\") %&gt;%\n  select(c(Date, HighTemp, AvgTemp, LowTemp, Sum_mm, name))\n\n\n\n\n2.2 Create seasonal temp/prcp variables\nThe seasonal variable is calculated for each site, year, and season. The season is defined as Winter: December(last year) to February, Spring: March to May, Summer: June to August, Fall: September to November.\n\n\nCode\n# filtered_seasonal_data &lt;- all_sites_temp %&gt;%\n#   mutate(\n#     year = year(Date),\n#     month = month(Date),\n#     season = case_when(\n#       month %in% 3:5 ~ \"spring\",\n#       month %in% 6:8 ~ \"summer\",\n#       month %in% 9:11 ~ \"fall\",\n#       TRUE ~ \"winter\"\n#     ),\n#     year = if_else(month == 12, year + 1, year)\n#   ) %&gt;%\n#   group_by(name, year, season, month) %&gt;%\n#   summarise(\n#     across(c(HighTemp, AvgTemp, LowTemp, Sum_mm), ~ sum(!is.na(.)), .names = \"count_{.col}\"),\n#     .groups = \"drop\"\n#   ) %&gt;%\n#   group_by(name, year, season) %&gt;%\n#   summarise(\n#     across(starts_with(\"count_\"), ~ sum(. &gt;= 10), .names = \"valid_months_{.col}\"),\n#     .groups = \"drop\"\n#   )\n# \n# seasonal_temp &lt;- all_sites_temp %&gt;%\n#   mutate(\n#     year = year(Date),\n#     month = month(Date),\n#     season = case_when(\n#       month %in% 3:5 ~ \"spring\",\n#       month %in% 6:8 ~ \"summer\",\n#       month %in% 9:11 ~ \"fall\",\n#       TRUE ~ \"winter\"\n#     ),\n#     year = if_else(month == 12, year + 1, year)\n#   ) %&gt;%\n#   # semi_join(valid_combinations, by = c(\"name\", \"year\", \"season\")) %&gt;%\n#   group_by(name, year, season) %&gt;%\n#   summarise(\n#     Avg_HighTemp = mean(HighTemp, na.rm = TRUE),\n#     Avg_AvgTemp = mean(AvgTemp, na.rm = TRUE),\n#     Avg_LowTemp = mean(LowTemp, na.rm = TRUE),\n#     Sum_Sum_mm = sum(Sum_mm, na.rm = TRUE),\n#     .groups = \"drop\"\n#   ) %&gt;%\n#   left_join(\n#     filtered_seasonal_data,\n#     by = c(\"name\", \"year\", \"season\")\n#   ) %&gt;%\n#   mutate(\n#     Avg_HighTemp = if_else(valid_months_count_HighTemp == 3, Avg_HighTemp, NA_real_),\n#     Avg_AvgTemp = if_else(valid_months_count_AvgTemp == 3, Avg_AvgTemp, NA_real_),\n#     Avg_LowTemp = if_else(valid_months_count_LowTemp == 3, Avg_LowTemp, NA_real_),\n#     Sum_Sum_mm = if_else(valid_months_count_Sum_mm == 3, Sum_Sum_mm, NA_real_)\n#   ) %&gt;%\n#   select(name, year, season, Avg_HighTemp, Avg_AvgTemp, Avg_LowTemp, Sum_Sum_mm) %&gt;%\n#   pivot_wider(\n#     names_from = season,\n#     values_from = c(Avg_HighTemp, Avg_AvgTemp, Avg_LowTemp, Sum_Sum_mm),\n#     names_glue = \"{.value}_{season}\"\n#   )\n# \n# seasonal_temp_doy &lt;- points_in_buffer %&gt;%\n#   left_join(seasonal_temp, by = c(\"Site\" = \"name\", \"year\" = \"year\"))\n# \n# saveRDS(seasonal_temp_doy, \"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\")\n\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\")\nhead(seasonal_temp_doy)\n\n\n# A tibble: 6 × 29\n    ...1     id taxa         site  genus  year start   end direction thres   doy\n   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;\n1 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0      11\n2 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.1    35\n3 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.2    55\n4 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.3    75\n5 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.4    87\n6 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.5    96\n# ℹ 18 more variables: geometry &lt;chr&gt;, Site &lt;chr&gt;, Avg_HighTemp_fall &lt;dbl&gt;,\n#   Avg_HighTemp_spring &lt;dbl&gt;, Avg_HighTemp_summer &lt;dbl&gt;,\n#   Avg_HighTemp_winter &lt;dbl&gt;, Avg_AvgTemp_fall &lt;dbl&gt;,\n#   Avg_AvgTemp_spring &lt;dbl&gt;, Avg_AvgTemp_summer &lt;dbl&gt;,\n#   Avg_AvgTemp_winter &lt;dbl&gt;, Avg_LowTemp_fall &lt;dbl&gt;, Avg_LowTemp_spring &lt;dbl&gt;,\n#   Avg_LowTemp_summer &lt;dbl&gt;, Avg_LowTemp_winter &lt;dbl&gt;, Sum_Sum_mm_fall &lt;dbl&gt;,\n#   Sum_Sum_mm_spring &lt;dbl&gt;, Sum_Sum_mm_summer &lt;dbl&gt;, Sum_Sum_mm_winter &lt;dbl&gt;"
  },
  {
    "objectID": "workflow_micro_NYC.html#explore-the-relationship-between-temperature-and-phenology",
    "href": "workflow_micro_NYC.html#explore-the-relationship-between-temperature-and-phenology",
    "title": "workflow_micro_NYC",
    "section": "3 Explore the relationship between temperature and phenology",
    "text": "3 Explore the relationship between temperature and phenology\n\n3.1 Seasonal climate variables\nI chose the Acer genus, 50% threshold as an example to plot the relationship. Overall, the warmer the winter/spring temperature, the earlier the spring phenology. The precipitation has no significant impact.\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"up\" & thres == 0.5 & genus == \"Acer\")\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_AvgTemp_spring\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_LowTemp_spring\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_HighTemp_spring\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Sum_Sum_mm_spring\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal precipitation and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_AvgTemp_winter\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_LowTemp_winter\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_HighTemp_winter\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Sum_Sum_mm_winter\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal precipitation and spring phenology\"\n)\n\n\n\n\n\n\n\nSpring average temp.\n\n\n\n\n\n\n\nSpring low temp.\n\n\n\n\n\n\n\nSpring high temp.\n\n\n\n\n\n\n\nSpring prcp. sum\n\n\n\n\n\n\n\n\n\nWinter average temp.\n\n\n\n\n\n\n\nWinter low temp.\n\n\n\n\n\n\n\nWinter high temp.\n\n\n\n\n\n\n\nWinter prcp. sum\n\n\n\n\n\n\nRelationship between seasonal climate and spring phenology\n\n\n\nOverall, the warmer the summer temperature, the later the fall phenology. Other relationship are not significant.\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"down\" & thres == 0.5 & genus == \"Acer\")\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_AvgTemp_summer\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_LowTemp_summer\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_HighTemp_summer\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Sum_Sum_mm_summer\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal precipitation and fall phenology\"\n)\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_AvgTemp_fall\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_LowTemp_fall\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_HighTemp_fall\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Sum_Sum_mm_fall\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal precipitation and fall phenology\"\n)\n\n\n\n\n\n\n\nSummer average temp.\n\n\n\n\n\n\n\nSummer low temp.\n\n\n\n\n\n\n\nSummer high temp.\n\n\n\n\n\n\n\nSummer prcp. sum\n\n\n\n\n\n\n\n\n\nFall average temp.\n\n\n\n\n\n\n\nFall low temp.\n\n\n\n\n\n\n\nFall high temp.\n\n\n\n\n\n\n\nFall prcp. sum\n\n\n\n\n\n\nRelationship between seasonal climate and fall phenology\n\n\n\nIn the mixed effect model, I treated the genus as a random effect.\nFor spring phenology\n\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"up\" & thres == 0.5)\n\nmodel &lt;- lmer(doy ~ Avg_AvgTemp_winter  + Sum_Sum_mm_winter  +\n                (1 | genus), \n              data = seasonal_temp_doy)\n\nfixed_effects &lt;- tidy(model, effects = \"fixed\")\n\nfixed_effects_table &lt;- fixed_effects %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (spring phenology ~ winter climate)\n\n\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\n(Intercept)\n126.657\n0.817\n154.935641\n0.0e+00\n\n\nAvg_AvgTemp_winter\n-2.125\n0.107\n-19.891618\n0.0e+00\n\n\nSum_Sum_mm_winter\n-0.009\n0.002\n-4.538583\n5.7e-06\n\n\n\n\n\n\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"down\" & thres == 0.5)\n\nmodel &lt;- lmer(doy ~ Avg_AvgTemp_summer  + Sum_Sum_mm_summer  +\n                (1 | genus), \n              data = seasonal_temp_doy)\n\nfixed_effects &lt;- tidy(model, effects = \"fixed\")\n\nfixed_effects_table &lt;- fixed_effects %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (fall phenology ~ summer climate)\n\n\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\n(Intercept)\n234.981\n7.622\n30.827566\n0.00000\n\n\nAvg_AvgTemp_summer\n2.345\n0.301\n7.799551\n0.00000\n\n\nSum_Sum_mm_summer\n0.005\n0.002\n2.876526\n0.00402\n\n\n\n\n\n\n\n3.2 Event period climate\n\n\n3.2.1 Create period temp/prcp variables\nThe seasonal climate variables use a fixed pre-season for every trees, not allowing heterogeneity within city. Also, the roughly divided season make it difficult to connect to phenology process, e.g. chilling and forcing accumulation. Therefore, some studies use varing preseason or optimal preseason.\nMeng et al., 2020, Wang et al., 2021: The preseason was defined as the period from November 1st in the previous year to the time of SOS in the current year. (most fixed)\nMeng et al., 2020, Yin et al., 2024: For each city, the period for which the absolute value of the partial correlation coefficient between SOS and Temp was highest was considered the optimal length of the preseason most relevant to SOS. (more flexible, cadidate time: 0 to 6 months prior to SOS, 5-day interval approach from January 1st to the average SOS date)\nMost flexible: The period variable is calculated for each site, year, and growing period. The period is defined as the period between the start of the phenology event and the day of year when the tree reaches the event threshold.\n\n\n\nDefinition of period\n\n\n\n\nCode\n# growing_temp_doy &lt;- points_in_buffer %&gt;%\n#   mutate(\n#     start_date = make_date(year) + days(start - 1), \n#     end_date = make_date(year) + days(doy - 1)\n#   ) %&gt;%\n#   rowwise() %&gt;%\n#   mutate(\n#     stats = list({\n#       current_index &lt;- cur_group_id()\n#       if (current_index %% 2000 == 0) {\n#         cat(\"Processing row:\", current_index, \"out of\", nrow(points_in_buffer), \"\\n\")\n#       }\n#       all_sites_temp %&gt;%\n#         filter(\n#           name == Site,\n#           Date &gt;= start_date & Date &lt;= end_date\n#         ) %&gt;%\n#         summarise(\n#           LowTemp_mean = mean(LowTemp, na.rm = TRUE),\n#           LowTemp_count = sum(!is.na(LowTemp)),\n#           AvgTemp_mean = mean(AvgTemp, na.rm = TRUE),\n#           AvgTemp_count = sum(!is.na(AvgTemp)),\n#           HighTemp_mean = mean(HighTemp, na.rm = TRUE),\n#           HighTemp_count = sum(!is.na(HighTemp)),\n#           Sum_mm_sum = sum(Sum_mm, na.rm = TRUE),\n#           Sum_mm_count = sum(!is.na(Sum_mm))\n#         )\n#     })\n#   ) %&gt;%\n#   unnest(stats)%&gt;%\n#   mutate(\n#     time_length = as.numeric(end_date - start_date, units = \"days\")\n#   )\n# \n# saveRDS(growing_temp_doy, \"~/phenology-urban/data/proc/nyc/growing_doy.rds\")\n\ngrowing_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/growing_doy.rds\")\nhead(growing_temp_doy)\n\n\n# A tibble: 6 × 24\n    ...1     id taxa         site  genus  year start   end direction thres   doy\n   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;\n1 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0      11\n2 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.1    35\n3 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.2    55\n4 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.3    75\n5 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.4    87\n6 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.5    96\n# ℹ 13 more variables: geometry &lt;chr&gt;, Site &lt;chr&gt;, start_date &lt;date&gt;,\n#   end_date &lt;date&gt;, LowTemp_mean &lt;dbl&gt;, LowTemp_count &lt;int&gt;,\n#   AvgTemp_mean &lt;dbl&gt;, AvgTemp_count &lt;int&gt;, HighTemp_mean &lt;dbl&gt;,\n#   HighTemp_count &lt;int&gt;, Sum_mm_sum &lt;dbl&gt;, Sum_mm_count &lt;int&gt;,\n#   time_length &lt;dbl&gt;\n\n\nThe period_desc is defined as the period between the day of year when the tree reaches the event threshold and the end of phenology event.\n\n\nCode\n# growing_temp_doy_desc &lt;- points_in_buffer %&gt;%\n#   mutate(\n#     start_date = make_date(year) + days(doy - 1), \n#     end_date = make_date(year) + days(end - 1)\n#   ) %&gt;%\n#   rowwise() %&gt;%\n#   mutate(\n#     stats = list({\n#       current_index &lt;- cur_group_id()\n#       if (current_index %% 2000 == 0) {\n#         cat(\"Processing row:\", current_index, \"out of\", nrow(points_in_buffer), \"\\n\")\n#       }\n#       all_sites_temp %&gt;%\n#         filter(\n#           name == Site,\n#           Date &gt;= start_date & Date &lt;= end_date\n#         ) %&gt;%\n#         summarise(\n#           LowTemp_mean = mean(LowTemp, na.rm = TRUE),\n#           LowTemp_count = sum(!is.na(LowTemp)),\n#           AvgTemp_mean = mean(AvgTemp, na.rm = TRUE),\n#           AvgTemp_count = sum(!is.na(AvgTemp)),\n#           HighTemp_mean = mean(HighTemp, na.rm = TRUE),\n#           HighTemp_count = sum(!is.na(HighTemp)),\n#           Sum_mm_sum = sum(Sum_mm, na.rm = TRUE),\n#           Sum_mm_count = sum(!is.na(Sum_mm))\n#         )\n#     })\n#   ) %&gt;%\n#   unnest(stats)%&gt;%\n#   mutate(\n#     time_length = as.numeric(end_date - start_date, units = \"days\")\n#   )\n# saveRDS(growing_temp_doy_desc, \"~/phenology-urban/data/proc/nyc/growing_doy_desc.rds\")\n\ngrowing_temp_doy_desc &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/growing_doy_desc.rds\")\nhead(growing_temp_doy_desc)\n\n\n# A tibble: 6 × 24\n    ...1     id taxa         site  genus  year start   end direction thres   doy\n   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;\n1 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0      11\n2 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.1    35\n3 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.2    55\n4 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.3    75\n5 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.4    87\n6 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.5    96\n# ℹ 13 more variables: geometry &lt;chr&gt;, Site &lt;chr&gt;, start_date &lt;date&gt;,\n#   end_date &lt;date&gt;, LowTemp_mean &lt;dbl&gt;, LowTemp_count &lt;int&gt;,\n#   AvgTemp_mean &lt;dbl&gt;, AvgTemp_count &lt;int&gt;, HighTemp_mean &lt;dbl&gt;,\n#   HighTemp_count &lt;int&gt;, Sum_mm_sum &lt;dbl&gt;, Sum_mm_count &lt;int&gt;,\n#   time_length &lt;dbl&gt;\n\n\n\n3.2.1 The current event period\nI tried period_length (start of the event to the day when tree reaches the threshold) as well as day of year. However, one issue is that a later doy or a longer green-up period already corresponds to warmer weather in the current period.\n\nShould I also explore the optimal pre-season (e.g. for each genus) within the city?\n\n\nCode\ngrowing_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/growing_doy.rds\") %&gt;%\n  filter(time_length != 0 & direction ==\"up\" & thres == 0.5 & genus == \"Acer\")\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"LowTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"HighTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\n\n\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"doy\",\n  title = \"Relationship between period precipitation and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"LowTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"HighTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"time_length\",\n  title = \"Relationship between period precipitation and spring phenology\"\n)\n\n\n\n\n\n\n\ndoy ~ average temp.\n\n\n\n\n\n\n\ndoy ~ low temp.\n\n\n\n\n\n\n\ndoy ~ high temp.\n\n\n\n\n\n\n\ndoy ~ prcp. sum\n\n\n\n\n\n\n\n\n\nperiod_length ~ average temp.\n\n\n\n\n\n\n\nperiod_length ~ low temp.\n\n\n\n\n\n\n\nperiod_length ~ high temp.\n\n\n\n\n\n\n\nperiod_length ~ prcp. sum\n\n\n\n\n\n\nRelationship between period climate and spring phenology\n\n\n\n\n\n3.2.2 The previous period\nThe climate condition in the previous period. Temp in dormancy -&gt; spring phenology. Temp in growing period -&gt; fall phenology. Compared to current period, the climate of the previous event is not structurally inherently linked to the timing of the subsequent event, and it can help connect to the underlying mechanisms.\n\n\nCode\ngrowing_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/growing_doy.rds\") %&gt;%\n  filter(thres == 0.5) %&gt;%\n  select(id, genus, year, direction, doy, time_length)\ngrowing_temp_doy_desc &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/growing_doy_desc.rds\") %&gt;%\n  filter(thres == 0.5) %&gt;%\n  select(id, genus, year, direction, LowTemp_mean, LowTemp_count, AvgTemp_mean, AvgTemp_count, HighTemp_mean, HighTemp_count, Sum_mm_sum, Sum_mm_count) %&gt;%\n  mutate(\n   join_year = case_when(\n     direction == \"up\" ~ year,\n     direction == \"down\" ~ year + 1\n   ),\n   join_direction = case_when(\n     direction == \"up\" ~ \"down\",\n     direction == \"down\" ~ \"up\"\n   ) \n  ) %&gt;%\n  select(-year, -direction)\n\ngrowing_doy_join &lt;- growing_temp_doy %&gt;%\n  left_join(growing_temp_doy_desc, by = c(\"id\" = \"id\", \"genus\" = \"genus\", \"year\" = \"join_year\", \"direction\" = \"join_direction\"))\n\n\nFor spring phenology, the warmer the dormancy period, the earlier the spring phenology. The warmer the dormancy period，the slower the green-up pace.\n\nCode\ngrowing_doy_spring &lt;- growing_doy_join %&gt;%\n  filter(direction == \"up\") %&gt;%\n  filter(genus == \"Acer\")\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"HighTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"LowTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"doy\",\n  title = \"Relationship between growing precipitation and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"HighTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"LowTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing precipitation and spring phenology\"\n)\n\n\n\n\n\n\n\ndoy vs. average temp.\n\n\n\n\n\n\n\ndoy vs. high temp.\n\n\n\n\n\n\n\ndoy vs. low temp.\n\n\n\n\n\n\n\ndoy vs. prcp. sum\n\n\n\n\n\n\n\n\n\nperiod_length vs. average temp.\n\n\n\n\n\n\n\nperiod_length vs. high temp.\n\n\n\n\n\n\n\nperiod_length vs. low temp.\n\n\n\n\n\n\n\nperiod_length vs. prcp. sum\n\n\n\n\n\n\nRelationship between previous period climate and spring phenology\n\n\n\n\n\nCode\ngrowing_temp_doy &lt;- growing_doy_join %&gt;%\n  filter(direction == \"up\")\n\nmodel1 &lt;- lmer(doy ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects1 &lt;- tidy(model1, effects = \"fixed\")\n\nfixed_effects_table1 &lt;- fixed_effects1 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"doy\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nmodel2 &lt;- lmer(time_length ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects2 &lt;- tidy(model2, effects = \"fixed\")\n\nfixed_effects_table2 &lt;- fixed_effects2 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"time_length\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nfixed_effects_table &lt;- rbind(fixed_effects_table1, fixed_effects_table2) %&gt;%\n  select(y_variable, everything())\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Dependent variable\", \"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (spring phenology ~ pervious period climate)\n\n\n\n\n\n\n\n\n\n\nDependent variable\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\ndoy\n(Intercept)\n121.770\n0.614\n198.443867\n0e+00\n\n\ndoy\nAvgTemp_mean\n-0.921\n0.051\n-17.893020\n0e+00\n\n\ndoy\nSum_mm_sum\n0.005\n0.001\n5.329484\n1e-07\n\n\ntime_length\n(Intercept)\n76.979\n0.872\n88.306877\n0e+00\n\n\ntime_length\nAvgTemp_mean\n3.542\n0.102\n34.663215\n0e+00\n\n\ntime_length\nSum_mm_sum\n-0.041\n0.002\n-22.918665\n0e+00\n\n\n\n\n\nFor fall phenology, the warmer the growing period, the later the fall phenology. The warmer the growing period，the faster the green-down pace.\n\nCode\ngrowing_doy_fall &lt;- growing_doy_join %&gt;%\n  filter(direction == \"down\") %&gt;%\n  filter(genus == \"Acer\")\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"HighTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"LowTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"doy\",\n  title = \"Relationship between growing precipitation and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"HighTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"LowTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing precipitation and fall phenology\"\n)\n\n\n\n\n\n\n\ndoy vs. average temp.\n\n\n\n\n\n\n\ndoy vs. high temp.\n\n\n\n\n\n\n\ndoy vs. low temp.\n\n\n\n\n\n\n\ndoy vs. prcp. sum\n\n\n\n\n\n\n\n\n\nperiod_length vs. average temp.\n\n\n\n\n\n\n\nperiod_length vs. high temp.\n\n\n\n\n\n\n\nperiod_length vs. low temp.\n\n\n\n\n\n\n\nperiod_length vs. prcp. sum\n\n\n\n\n\n\nRelationship between previous period climate and spring phenology\n\n\n\n\n\nCode\ngrowing_temp_doy &lt;- growing_doy_join %&gt;%\n  filter(direction == \"down\")\n\nmodel1 &lt;- lmer(doy ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects1 &lt;- tidy(model1, effects = \"fixed\")\n\nfixed_effects_table1 &lt;- fixed_effects1 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"doy\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nmodel2 &lt;- lmer(time_length ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects2 &lt;- tidy(model2, effects = \"fixed\")\n\nfixed_effects_table2 &lt;- fixed_effects2 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"time_length\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nfixed_effects_table &lt;- rbind(fixed_effects_table1, fixed_effects_table2) %&gt;%\n  select(y_variable, everything())\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Dependent variable\", \"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (fall phenology ~ pervious period climate)\n\n\n\n\n\n\n\n\n\n\nDependent variable\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\ndoy\n(Intercept)\n256.795\n2.461\n104.335144\n0\n\n\ndoy\nAvgTemp_mean\n1.751\n0.101\n17.263620\n0\n\n\ndoy\nSum_mm_sum\n0.014\n0.002\n7.322015\n0\n\n\ntime_length\n(Intercept)\n220.670\n2.596\n85.020263\n0\n\n\ntime_length\nAvgTemp_mean\n-4.939\n0.116\n-42.521789\n0\n\n\ntime_length\nSum_mm_sum\n-0.061\n0.002\n-27.798872\n0"
  },
  {
    "objectID": "workflow_micro_NYC.html#conclusion-and-next-step",
    "href": "workflow_micro_NYC.html#conclusion-and-next-step",
    "title": "workflow_micro_NYC",
    "section": "4 Conclusion and next step",
    "text": "4 Conclusion and next step\n\nThe preseason length varies significantly among genera.\nWithin the city, the relationship between phenology and temperature is still significant.\n\nThe warmer the preseason temperature, the earlier the start of season, considering the spatial autocorrelation of phenology in the model.\nAs for green-up pace, for most genera, the warmer preseason leads to faster green-up pace.\nThe response of end of season to temperature shows great variation among genera, including both the magnitude and direction.\nAs for green-down pace, for most genera, the warmer preseason leads to faster green-down pace.\nThe precipitation has no significant impact.\n\n\nNext steps:\n\nFuture steps:\n\nTest sensitivity by changing buffer size.\nAdd more taxa (data in DataDen and download latest PS images)"
  },
  {
    "objectID": "test.html",
    "href": "test.html",
    "title": "Hello, Quarto",
    "section": "",
    "text": "Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see https://quarto.org."
  },
  {
    "objectID": "test.html#meet-quarto",
    "href": "test.html#meet-quarto",
    "title": "Hello, Quarto",
    "section": "",
    "text": "Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see https://quarto.org."
  },
  {
    "objectID": "test.html#meet-the-penguins",
    "href": "test.html#meet-the-penguins",
    "title": "Hello, Quarto",
    "section": "Meet the penguins",
    "text": "Meet the penguins\n\nThe penguins data from the palmerpenguins package contains size measurements for 344 penguins from three species observed on three islands in the Palmer Archipelago, Antarctica.\nThe plot below shows the relationship between flipper and bill lengths of these penguins.\n\n\nCode\nggplot(penguins, \n       aes(x = flipper_length_mm, y = bill_length_mm)) +\n  geom_point(aes(color = species, shape = species)) +\n  scale_color_manual(values = c(\"darkorange\",\"purple\",\"cyan4\")) +\n  labs(\n    title = \"Flipper and bill length\",\n    subtitle = \"Dimensions for penguins at Palmer Station LTER\",\n    x = \"Flipper length (mm)\", y = \"Bill length (mm)\",\n    color = \"Penguin species\", shape = \"Penguin species\"\n  ) +\n  theme_minimal()\n\n\n\n\n\n\n\n\n\nAnother code\n\n\nCode\nggplot(penguins, \n       aes(x = flipper_length_mm, y = bill_length_mm)) +\n  geom_point(aes(color = species, shape = species)) +\n  scale_color_manual(values = c(\"yellow3\",\"purple\",\"cyan4\")) +\n  labs(\n    title = \"Flipper and bill length\",\n    subtitle = \"Dimensions for penguins at Palmer Station LTER\",\n    x = \"Flipper length (mm)\", y = \"Bill length (mm)\",\n    color = \"Penguin species\", shape = \"Penguin species\"\n  ) +\n  theme_minimal()"
  },
  {
    "objectID": "workflow_micro_DT.html",
    "href": "workflow_micro_DT.html",
    "title": "workflow_micro_DT",
    "section": "",
    "text": "Code\n################ For phenology data ################\n\nmetadata &lt;- read_csv(\"~/lab-data/datasets/vegetation/PS/urban/metadata.csv\") %&gt;%\n  filter(site == \"DT\")\n\nfile_list &lt;- list.files(path = \"~/lab-data/datasets/vegetation/PS/urban/doy/\", pattern = \"^doy_DT_.*\\\\.rds$\", full.names = TRUE)\ndata_list &lt;- file_list %&gt;%\n  map(~ readRDS(.x))\nDT_now &lt;- bind_rows(data_list)\n\ntree_location &lt;- metadata %&gt;%\n  mutate(genus = str_extract(taxa, \"^[^ ]+\")) %&gt;%\n  left_join(DT_now, by = \"id\") %&gt;%\n  filter(!is.na(doy)) %&gt;%\n  st_as_sf(coords = c(\"lon\", \"lat\"), crs = 4326)\n\nwu_location &lt;- read_csv(\"~/urban-cooling/data/raw/WU/DT/location.csv\") %&gt;%\n  st_as_sf(coords = c(\"Lon\", \"Lat\"), crs = 4326)\nwu_buffer &lt;- st_buffer(wu_location, dist = 500)\n\nintersects &lt;- st_intersects(tree_location, wu_buffer)\npoints_in_buffer &lt;- tree_location[lengths(intersects) &gt; 0, ]\npoints_in_buffer &lt;- tree_location %&gt;%\n  mutate(buffer_id = sapply(intersects, function(x) if (length(x) &gt; 0) x[1] else NA)) %&gt;% \n  left_join(wu_buffer %&gt;% st_drop_geometry() %&gt;% mutate(buffer_id = row_number()), by = \"buffer_id\") %&gt;%\n  filter(!is.na(buffer_id)) %&gt;%\n  select(-buffer_id)\n\n\n\n\nCode\n# nyboundary &lt;- st_read(\"~/urban-cooling/data/raw/NYC/boundary/nybb_dissolved.shp\") %&gt;%\n#   st_transform(4326)\n# \nggplot() +\n  # geom_sf(data = nyboundary, fill = \"grey\") +\n  geom_sf(data = wu_location, color = \"blue\", size = 1) +\n  geom_sf(data = points_in_buffer, color = \"red\", size = 0.05) +\n  theme_minimal()\n\n\n\n\n\nLocation of WU sites and trees\n\n\n\n\nCode\n# write_csv(points_in_buffer,\"~/phenology-urban/data/proc/DT/tree_WU_500_buffer_PS.csv\")\npoints_in_buffer &lt;- read_csv(\"~/phenology-urban/data/proc/DT/tree_WU_500_buffer_PS.csv\")"
  },
  {
    "objectID": "workflow_micro_DT.html#insert-tree-id-base-on-wu-data",
    "href": "workflow_micro_DT.html#insert-tree-id-base-on-wu-data",
    "title": "workflow_micro_DT",
    "section": "",
    "text": "Code\n################ For phenology data ################\n\nmetadata &lt;- read_csv(\"~/lab-data/datasets/vegetation/PS/urban/metadata.csv\") %&gt;%\n  filter(site == \"DT\")\n\nfile_list &lt;- list.files(path = \"~/lab-data/datasets/vegetation/PS/urban/doy/\", pattern = \"^doy_DT_.*\\\\.rds$\", full.names = TRUE)\ndata_list &lt;- file_list %&gt;%\n  map(~ readRDS(.x))\nDT_now &lt;- bind_rows(data_list)\n\ntree_location &lt;- metadata %&gt;%\n  mutate(genus = str_extract(taxa, \"^[^ ]+\")) %&gt;%\n  left_join(DT_now, by = \"id\") %&gt;%\n  filter(!is.na(doy)) %&gt;%\n  st_as_sf(coords = c(\"lon\", \"lat\"), crs = 4326)\n\nwu_location &lt;- read_csv(\"~/urban-cooling/data/raw/WU/DT/location.csv\") %&gt;%\n  st_as_sf(coords = c(\"Lon\", \"Lat\"), crs = 4326)\nwu_buffer &lt;- st_buffer(wu_location, dist = 500)\n\nintersects &lt;- st_intersects(tree_location, wu_buffer)\npoints_in_buffer &lt;- tree_location[lengths(intersects) &gt; 0, ]\npoints_in_buffer &lt;- tree_location %&gt;%\n  mutate(buffer_id = sapply(intersects, function(x) if (length(x) &gt; 0) x[1] else NA)) %&gt;% \n  left_join(wu_buffer %&gt;% st_drop_geometry() %&gt;% mutate(buffer_id = row_number()), by = \"buffer_id\") %&gt;%\n  filter(!is.na(buffer_id)) %&gt;%\n  select(-buffer_id)\n\n\n\n\nCode\n# nyboundary &lt;- st_read(\"~/urban-cooling/data/raw/NYC/boundary/nybb_dissolved.shp\") %&gt;%\n#   st_transform(4326)\n# \nggplot() +\n  # geom_sf(data = nyboundary, fill = \"grey\") +\n  geom_sf(data = wu_location, color = \"blue\", size = 1) +\n  geom_sf(data = points_in_buffer, color = \"red\", size = 0.05) +\n  theme_minimal()\n\n\n\n\n\nLocation of WU sites and trees\n\n\n\n\nCode\n# write_csv(points_in_buffer,\"~/phenology-urban/data/proc/DT/tree_WU_500_buffer_PS.csv\")\npoints_in_buffer &lt;- read_csv(\"~/phenology-urban/data/proc/DT/tree_WU_500_buffer_PS.csv\")"
  },
  {
    "objectID": "workflow_micro_DT.html#creat-the-climate-variable",
    "href": "workflow_micro_DT.html#creat-the-climate-variable",
    "title": "workflow_micro_DT",
    "section": "2. Creat the climate variable",
    "text": "2. Creat the climate variable\n\n2.1 Read and clean the WU data (based on GHCNd)\n\n\nCode\nsource(\"~/phenology-urban/script/read_clean_WU.R\")\n# all_sites_temp &lt;- read_clean_WU(city = \"DT\", run_checks = TRUE)\n# saveRDS(all_sites_temp, \"~/urban-cooling/data/raw/WU/DT/DT_wu.rds\")\nall_sites_temp &lt;- readRDS(\"~/urban-cooling/data/raw/WU/DT/DT_wu.rds\") %&gt;%\n  select(c(Date, HighTemp, AvgTemp, LowTemp, Sum_mm, name))\n\n\n\n\n2.2 Create seasonal temp/prcp variables"
  },
  {
    "objectID": "workflow_micro_DT.html#explore-the-relationship-between-temperature-and-phenology",
    "href": "workflow_micro_DT.html#explore-the-relationship-between-temperature-and-phenology",
    "title": "workflow_micro_DT",
    "section": "3 Explore the relationship between temperature and phenology",
    "text": "3 Explore the relationship between temperature and phenology\n\n3.1 Seasonal climate variables\nOverall, the warmer the summer temperature, the later the fall phenology. Other relationship are not significant.\nIn the mixed effect model, I treated the genus as a random effect.\nFor spring phenology\n\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/DT/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"up\" & thres == 0.5)\n\nmodel &lt;- lmer(doy ~ Avg_AvgTemp_winter  + Sum_Sum_mm_winter  +\n                (1 | genus), \n              data = seasonal_temp_doy)\n\nfixed_effects &lt;- tidy(model, effects = \"fixed\")\n\nfixed_effects_table &lt;- fixed_effects %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (spring phenology ~ winter climate)\n\n\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\n(Intercept)\n121.641\n1.250\n97.274997\n0.000\n\n\nAvg_AvgTemp_winter\n-1.821\n0.202\n-9.024978\n0.000\n\n\nSum_Sum_mm_winter\n0.005\n0.004\n1.232385\n0.218\n\n\n\n\n\n\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/DT/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"down\" & thres == 0.5)\n\nmodel &lt;- lmer(doy ~ Avg_AvgTemp_summer  + Sum_Sum_mm_summer  +\n                (1 | genus), \n              data = seasonal_temp_doy)\n\nfixed_effects &lt;- tidy(model, effects = \"fixed\")\n\nfixed_effects_table &lt;- fixed_effects %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (fall phenology ~ summer climate)\n\n\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\n(Intercept)\n198.036\n6.579\n30.1030020\n0.000\n\n\nAvg_AvgTemp_summer\n4.237\n0.280\n15.1484264\n0.000\n\n\nSum_Sum_mm_summer\n0.000\n0.002\n0.1092368\n0.913\n\n\n\n\n\n\n\n3.2 Event period climate\n\n\n3.2.1 Create period temp/prcp variables\n\n\n\n\n\n\n\nCode\n# growing_temp_doy &lt;- points_in_buffer %&gt;%\n#   mutate(\n#     start_date = make_date(year) + days(start - 1),\n#     end_date = make_date(year) + days(doy - 1)\n#   ) %&gt;%\n#   rowwise() %&gt;%\n#   mutate(\n#     stats = list({\n#       current_index &lt;- cur_group_id()\n#       if (current_index %% 2000 == 0) {\n#         cat(\"Processing row:\", current_index, \"out of\", nrow(points_in_buffer), \"\\n\")\n#       }\n#       all_sites_temp %&gt;%\n#         filter(\n#           name == Site,\n#           Date &gt;= start_date & Date &lt;= end_date\n#         ) %&gt;%\n#         summarise(\n#           LowTemp_mean = mean(LowTemp, na.rm = TRUE),\n#           LowTemp_count = sum(!is.na(LowTemp)),\n#           AvgTemp_mean = mean(AvgTemp, na.rm = TRUE),\n#           AvgTemp_count = sum(!is.na(AvgTemp)),\n#           HighTemp_mean = mean(HighTemp, na.rm = TRUE),\n#           HighTemp_count = sum(!is.na(HighTemp)),\n#           Sum_mm_sum = sum(Sum_mm, na.rm = TRUE),\n#           Sum_mm_count = sum(!is.na(Sum_mm))\n#         )\n#     })\n#   ) %&gt;%\n#   unnest(stats)%&gt;%\n#   mutate(\n#     time_length = as.numeric(end_date - start_date, units = \"days\")\n#   )\n\n# saveRDS(growing_temp_doy, \"~/phenology-urban/data/proc/DT/growing_doy.rds\")\n\ngrowing_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/DT/growing_doy.rds\")\nhead(growing_temp_doy)\n\n\n# A tibble: 6 × 24\n    ...1     id taxa         site  genus  year start   end direction thres   doy\n   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;\n1 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0      67\n2 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0.1    98\n3 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0.2   108\n4 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0.3   115\n5 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0.4   122\n6 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0.5   128\n# ℹ 13 more variables: geometry &lt;chr&gt;, Site &lt;chr&gt;, start_date &lt;date&gt;,\n#   end_date &lt;date&gt;, LowTemp_mean &lt;dbl&gt;, LowTemp_count &lt;int&gt;,\n#   AvgTemp_mean &lt;dbl&gt;, AvgTemp_count &lt;int&gt;, HighTemp_mean &lt;dbl&gt;,\n#   HighTemp_count &lt;int&gt;, Sum_mm_sum &lt;dbl&gt;, Sum_mm_count &lt;int&gt;,\n#   time_length &lt;dbl&gt;\n\n\n\n3.2.1 The current event period\n\n\n\n\nCode\ngrowing_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/DT/growing_doy.rds\") %&gt;%\n  filter(time_length != 0 & direction ==\"up\" & thres == 0.5)\n\nmodel1 &lt;- lmer(doy ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects1 &lt;- tidy(model1, effects = \"fixed\")\n\nfixed_effects_table1 &lt;- fixed_effects1 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"doy\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nmodel2 &lt;- lmer(time_length ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects2 &lt;- tidy(model2, effects = \"fixed\")\n\nfixed_effects_table2 &lt;- fixed_effects2 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"time_length\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nfixed_effects_table &lt;- rbind(fixed_effects_table1, fixed_effects_table2) %&gt;%\n  select(y_variable, everything())\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Dependent variable\", \"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (spring phenology ~ current period climate)\n\n\n\n\n\n\n\n\n\n\nDependent variable\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\ndoy\n(Intercept)\n117.208\n1.173\n99.906130\n0.000\n\n\ndoy\nAvgTemp_mean\n1.098\n0.111\n9.891255\n0.000\n\n\ndoy\nSum_mm_sum\n0.003\n0.002\n1.353886\n0.176\n\n\ntime_length\n(Intercept)\n104.872\n1.771\n59.230125\n0.000\n\n\ntime_length\nAvgTemp_mean\n-6.092\n0.193\n-31.636560\n0.000\n\n\ntime_length\nSum_mm_sum\n0.034\n0.004\n9.420579\n0.000\n\n\n\n\n\n\n\n3.2.2 The previous period\n\nFor spring phenology, the warmer the dormancy period, the earlier the spring phenology. The warmer the dormancy period，the slower the green-up pace.\n\n\nCode\ngrowing_temp_doy &lt;- growing_doy_join %&gt;%\n  filter(direction == \"up\")\n\nmodel1 &lt;- lmer(doy ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects1 &lt;- tidy(model1, effects = \"fixed\")\n\nfixed_effects_table1 &lt;- fixed_effects1 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"doy\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nmodel2 &lt;- lmer(time_length ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects2 &lt;- tidy(model2, effects = \"fixed\")\n\nfixed_effects_table2 &lt;- fixed_effects2 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"time_length\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nfixed_effects_table &lt;- rbind(fixed_effects_table1, fixed_effects_table2) %&gt;%\n  select(y_variable, everything())\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Dependent variable\", \"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (spring phenology ~ pervious period climate)\n\n\n\n\n\n\n\n\n\n\nDependent variable\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\ndoy\n(Intercept)\n122.700\n1.108\n110.7095997\n0.000000\n\n\ndoy\nAvgTemp_mean\n-0.231\n0.068\n-3.3812453\n0.000722\n\n\ndoy\nSum_mm_sum\n0.007\n0.002\n3.4260978\n0.000612\n\n\ntime_length\n(Intercept)\n78.762\n1.392\n56.5763854\n0.000000\n\n\ntime_length\nAvgTemp_mean\n0.546\n0.163\n3.3449871\n0.000823\n\n\ntime_length\nSum_mm_sum\n-0.002\n0.005\n-0.4416791\n0.659000\n\n\n\n\n\nFor fall phenology, the warmer the growing period, the later the fall phenology. The warmer the growing period，the faster the green-down pace.\n\n\nCode\ngrowing_temp_doy &lt;- growing_doy_join %&gt;%\n  filter(direction == \"down\")\n\nmodel1 &lt;- lmer(doy ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects1 &lt;- tidy(model1, effects = \"fixed\")\n\nfixed_effects_table1 &lt;- fixed_effects1 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"doy\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nmodel2 &lt;- lmer(time_length ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects2 &lt;- tidy(model2, effects = \"fixed\")\n\nfixed_effects_table2 &lt;- fixed_effects2 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"time_length\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nfixed_effects_table &lt;- rbind(fixed_effects_table1, fixed_effects_table2) %&gt;%\n  select(y_variable, everything())\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Dependent variable\", \"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (fall phenology ~ pervious period climate)\n\n\n\n\n\n\n\n\n\n\nDependent variable\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\ndoy\n(Intercept)\n250.916\n3.115\n80.560054\n0.00e+00\n\n\ndoy\nAvgTemp_mean\n2.085\n0.144\n14.483046\n0.00e+00\n\n\ndoy\nSum_mm_sum\n0.006\n0.002\n2.867466\n4.14e-03\n\n\ntime_length\n(Intercept)\n133.898\n5.265\n25.433816\n0.00e+00\n\n\ntime_length\nAvgTemp_mean\n-1.120\n0.250\n-4.483999\n7.30e-06\n\n\ntime_length\nSum_mm_sum\n-0.054\n0.004\n-15.352205\n0.00e+00"
  },
  {
    "objectID": "workflow_micro_DT.html#conclusion-and-next-step",
    "href": "workflow_micro_DT.html#conclusion-and-next-step",
    "title": "workflow_micro_DT",
    "section": "4 Conclusion and next step",
    "text": "4 Conclusion and next step\nWithin the city, the relationship between phenology and temperature is still significant.\n\nThe warmer the preseason temperature, the earlier the spring phenology.\nThe warmer the preseason temperature, the later the fall phenology.\nThe warmer the dormancy period，the slower the green-up pace. The warmer the growing period，the faster the green-down pace. (consistent results in lmer model)\nThe precipitation has no significant impact.\n\nNext steps:\n\nFind the optimal preseason? Related to process-based model\nEnlarge the samples in NYC.\nAdd the urban structure variables.\nEnlarge the city samples (downloading WU in other 6 cities).\n\nJuwon conducted research on the impact of climate change on urban trees, focusing specifically on changes in the start of the growing season in New York. He and Prof. Seto plan to expand this approach across the U.S., and he looks forward to potential collaborations."
  },
  {
    "objectID": "workflow_micro_NYC.html#raw-data",
    "href": "workflow_micro_NYC.html#raw-data",
    "title": "workflow_micro_NYC",
    "section": "1 Raw data",
    "text": "1 Raw data\n\n1.1 Insert tree id base on WU data\nFor exploratory analysis, I used the street tree in NYC, with the phenology information established by Yiluan. These trees are part of the whole inventory, covering 14 genera and being sampled. I select the trees which are within 500 m buffer around the weather underground sites (see Figure 1).\n\n\nCode\npoints_in_buffer &lt;- read_csv(paste0(\"~/phenology-urban/data/proc/urban/\",city,\"/tree_WU_500_buffer_PS.csv\"), show_col_types = FALSE)\n\npoints_in_buffer_sf &lt;- points_in_buffer %&gt;%\n  st_as_sf(coords = c(\"lon\", \"lat\"), crs = 4326)\n\nboundary &lt;- switch(\n  city,\n  \"NY\" = st_read(\"~/urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp\") %&gt;%\n    st_transform(4326),\n  \"DT\" = st_read(\"~/urban-cooling/data/raw/WU/DT/City_of_Detroit_Boundary/City_of_Detroit_Boundary.shp\") %&gt;%\n    st_transform(4326),\n  \"ST\" = st_read(\"~/urban-cooling/data/raw/WU/ST/seattle_boundary/CityUGA.shp\") %&gt;%\n    st_transform(4326) %&gt;%\n    filter(CITY_NM == \"Seattle\"),\n  \"HT\" = st_read(\"~/urban-cooling/data/raw/WU/HT/kx-houston-texas-city-limits-SHP/houston-texas-city-limits.shp\") %&gt;%\n    st_transform(4326),\n  \"TP\" = st_read(\"~/urban-cooling/data/raw/WU/TP/Municipal_Boundary/Municipal_Boundary.shp\") %&gt;%\n    st_transform(4326) %&gt;%\n    filter(NAME == \"Tampa\"),\n  \"DV\" = st_read(\"~/urban-cooling/data/raw/WU/DV/denver-boundary/denver-colorado-county-boundary.shp\") %&gt;%\n    st_transform(4326),\n  \"AT\" = st_read(\"~/urban-cooling/data/raw/WU/AT/TxDOT_City_Boundaries/Cities.shp\") %&gt;%\n    filter(CITY_NM == \"Austin\") %&gt;%\n    st_transform(4326),\n  stop(\"Invalid city abbreviation.\")\n)\n\n\nReading layer `nybb_dissolved' from data source \n  `/Volumes/seas-zhukai/proj-urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 1 feature and 1 field\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 913175.1 ymin: 120128.4 xmax: 1067383 ymax: 272844.3\nProjected CRS: NAD83 / New York Long Island (ftUS)\n\n\nCode\nwu_location &lt;- read_csv(paste0(\"~/urban-cooling/data/raw/WU/\", city, \"/location.csv\"), show_col_types = FALSE) %&gt;%\n  st_as_sf(coords = c(\"Lon\", \"Lat\"), crs = 4326)\n\nggplot() +\n  geom_sf(data = boundary, fill = \"grey\") +\n  geom_sf(data = wu_location, color = \"blue\", size = 1) +\n  geom_sf(data = points_in_buffer_sf, color = \"red\", size = 0.01) +\n  theme_minimal()\n\n\n\n\n\n\n\n\nFigure 1: Location of WU sites and trees\n\n\n\n\n\n\n\n1.2 Read and clean the WU data (based on GHCNd)\nThere are 4 raw daily variables selected, i.e. AvgTemp, HighTemp, LowTemp and Precipitation_sum (Sum_mm). I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily GHCNd.\n\n\nCode\n# all_sites_temp &lt;- read_clean_WU(city = \"ST\", run_checks = TRUE)\nall_sites_temp &lt;- readRDS(paste0(\"~/urban-cooling/data/raw/WU/\",city,\"/\",city,\"_wu.rds\")) %&gt;%\n  dplyr::select(c(Date, HighTemp, AvgTemp, LowTemp, Sum_mm, name))\n\n\n\n\n1.3 Shortwave data from Daymet\nTo control for the influence of other variables on phenology, I also incorporated shortwave radiation data derived from the Daymet daily dataset with a 1 km resolution. Shortwave radiation was extracted for the specific locations of the trees.\n\n\nCode\n# download\nsrad_daily &lt;- readRDS(paste0(\"~/phenology-urban/data/raw/\",city,\"/Daymet/daily2016-2024/srad_daily_2016-2023.rds\")) %&gt;%\n  select(id, value, date)"
  },
  {
    "objectID": "workflow_micro_NYC.html#find-the-optimal-preseason",
    "href": "workflow_micro_NYC.html#find-the-optimal-preseason",
    "title": "workflow_micro_NYC",
    "section": "2 Find the optimal preseason",
    "text": "2 Find the optimal preseason\nThe seasonal climate variables use a fixed pre-season for every trees, not allowing heterogeneity within city. Also, the roughly divided season make it difficult to connect to phenology process, e.g. chilling and forcing accumulation. Therefore, some studies use varing preseason or optimal preseason.\nMeng et al., 2020, Wang et al., 2021: The preseason was defined as the period from November 1st in the previous year to the time of SOS in the current year. (most fixed)\nMeng et al., 2020, Yin et al., 2024: For each city, the period for which the absolute value of the partial correlation coefficient between SOS and Temp was highest was considered the optimal length of the preseason most relevant to SOS. (more flexible, cadidate time: 0 to 6 months prior to SOS, 5-day interval approach from January 1st to the average SOS date)\nHere, based on the variable (phenology metric: SOS, EOS, green-up pace, green-down pace, temp. metric: t_avg, t_min, t_max), I find the optimal preseason at genus-city level (ignore the year for now due to sample size). The period for which the absolute value of the partial correlation coefficient between phenology and temp. metric is highest is considered the optimal length of the preseason most relevant to the certain phenology metric.\n\n\nCode\ncalculate_partial_correlation &lt;- function(insert_data, direction, thres, genus, pre_lengths, \n                                          phe_variable, temp_variable) {\n  subset_tree_pcor &lt;- insert_data %&gt;%\n    filter(direction == !!direction & thres == !!thres & genus == !!genus)\n  results &lt;- lapply(pre_lengths, function(pre_length) {\n    cat(\"Preseason length (days):\", pre_length, \"\\n\")\n    preseason_var &lt;- subset_tree_pcor %&gt;%\n      mutate(\n        start_date = make_date(year) + days(round(mean(doy)) - 1) - days(pre_length),\n        end_date = make_date(year) + days(round(mean(doy)) - 1)\n      )\n\n    temp_stats &lt;- all_sites_temp %&gt;%\n      # filter(name %in% preseason_var$Site) %&gt;%\n      inner_join(preseason_var, by = c(\"name\" = \"Site\")) %&gt;%\n      filter(Date &gt;= start_date & Date &lt;= end_date) %&gt;%\n      group_by(id,year) %&gt;%\n      summarise(\n        LowTemp_mean = mean(LowTemp, na.rm = TRUE),\n        LowTemp_count = sum(!is.na(LowTemp)),\n        AvgTemp_mean = mean(AvgTemp, na.rm = TRUE),\n        AvgTemp_count = sum(!is.na(AvgTemp)),\n        HighTemp_mean = mean(HighTemp, na.rm = TRUE),\n        HighTemp_count = sum(!is.na(HighTemp)),\n        Sum_mm_sum = sum(Sum_mm, na.rm = TRUE),\n        Sum_mm_count = sum(!is.na(Sum_mm)),\n        .groups = \"drop\"\n      )\n  \n    srad_stats &lt;- srad_daily %&gt;%\n      # filter(id %in% preseason_var$id) %&gt;%\n      inner_join(preseason_var, by = \"id\") %&gt;%\n      filter(date &gt;= start_date & date &lt;= end_date) %&gt;%\n      group_by(id,year) %&gt;%\n      summarise(\n        srad_mean = mean(value, na.rm = TRUE),\n        srad_count = sum(!is.na(value)),\n        .groups = \"drop\"\n      )\n    \n    preseason_var &lt;- preseason_var %&gt;%\n      left_join(temp_stats, by = c(\"id\",\"year\")) %&gt;%\n      left_join(srad_stats, by = c(\"id\",\"year\"))\n    \n    \n    if (temp_variable %in% c(\"LowTemp_mean\", \"HighTemp_mean\")){\n      selected_data &lt;- preseason_var %&gt;%\n      dplyr::select(\n        {{ phe_variable }}, LowTemp_mean, HighTemp_mean, Sum_mm_sum,  srad_mean\n      ) %&gt;%\n      na.omit()\n    } else {\n      selected_data &lt;- preseason_var %&gt;%\n      dplyr::select(\n        {{ phe_variable }}, AvgTemp_mean,Sum_mm_sum, srad_mean\n      ) %&gt;%\n      na.omit()\n    }\n    partial_corr &lt;- pcor(selected_data)\n    \n    correlation &lt;- partial_corr$estimate[\n        rownames(partial_corr$estimate) == phe_variable, \n        colnames(partial_corr$estimate) == temp_variable\n      ]\n    pvalue &lt;- partial_corr$p.value[\n        rownames(partial_corr$p.value) == phe_variable, \n        colnames(partial_corr$p.value) == temp_variable\n      ]\n  list(correlation = correlation, pvalue = pvalue, preseason_var = preseason_var)\n  })\n  \n  correlations &lt;- sapply(results, function(x) (x$correlation))\n  pvalues &lt;- sapply(results, function(x) (x$pvalue))\n  \n  \n  max_idx &lt;- which.max(abs(correlations))\n  \n  return(list(\n    optimal_pre_length = pre_lengths[max_idx],\n    pre_length_candidate  = pre_lengths,\n    pre_length_trend = correlations,\n    pvalue_trend = pvalues,\n    partial_correlation = results[[max_idx]]$correlation,\n    partial_corr_pvalue = results[[max_idx]]$pvalue,\n    preseason_var = results[[max_idx]]$preseason_var\n  ))\n}\n\n\npre_lengths &lt;- seq(5, 180, by = 5)\nall_genus &lt;- unique(points_in_buffer$genus)\ntemp_variable = \"AvgTemp_mean\"\n\n\n\n2.1 Spring phenology\n\nSOS date\nDefined as the day of year when individual tree growing season EVI curves first cross the green-up 50% threshold.\n\n\nCode\ndirection &lt;- \"up\"\nthres &lt;- 0.5\nphe_variable = \"doy\"\ninsert_data = points_in_buffer\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nspring_date_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nspring_date_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nspring_date_combined_results &lt;- do.call(rbind, lapply(spring_date_combined_results, as.data.frame))\n\n\n\n\nGreen-up Pace\nDefined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-up 20% threshold to the 80% threshold.\n\n\nCode\ndiff &lt;- points_in_buffer %&gt;%\n  group_by(year, id, direction) %&gt;%\n  filter(thres %in% c(0.2, 0.8)) %&gt;% \n  summarise(\n    doy_diff = abs(diff(doy[order(thres)])),\n    .groups = \"drop\"\n  )\n\npoints_with_diff &lt;- points_in_buffer %&gt;%\n  left_join(diff, by = c(\"year\", \"id\", \"direction\"))\n\ndirection &lt;- \"up\"\nthres &lt;- 0.2              # change to 0.5?\nphe_variable = \"doy_diff\"\ninsert_data = points_with_diff\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nspring_pace_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nspring_pace_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nspring_pace_combined_results &lt;- do.call(rbind, lapply(spring_pace_combined_results, as.data.frame))\n\n\n\n\n\n2.2 Fall phenology\n\nEOS date\nDefined as the day of year when individual tree growing season EVI curves first cross the green-down 50% threshold.\n\nCode\ndirection &lt;- \"down\"\nthres &lt;- 0.5\nphe_variable = \"doy\"\ninsert_data = points_in_buffer\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n \n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nfall_date_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nfall_date_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nfall_date_combined_results &lt;- do.call(rbind, lapply(fall_date_combined_results, as.data.frame))\n\n\n\n\n\n\nGreen-down Pace\nDefined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-down 20% threshold to the 80% threshold.\n\n\nCode\ndirection &lt;- \"down\"\nthres &lt;- 0.2\nphe_variable = \"doy_diff\"\ninsert_data = points_with_diff\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n \n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nfall_pace_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nfall_pace_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nfall_pace_combined_results &lt;- do.call(rbind, lapply(fall_pace_combined_results, as.data.frame))\n\n\n\n\n\n2.3 Optimal preseason length calculated by Tempavg\nFigure 2 displays the distribution of optimal preseason length and partial correlation coefficient calculated by Tempavg for SOS, Greenup pace, EOS and Greenup pace, respectively.\nAs for SOS, all genera have negetive partial correlation coefficients, which means the higher preseason average temperature, the earlier start of season. As for Greenup pace, most genera (except Carya, Celtis) have negetive partial correlation coefficients, which means the higher preseason average temperature, the faster green up pace. The preseason length varies significantly among genera.\nAs for EOS, most genera (except Populus, Platanus) have positive partial correlation coefficients, which means the higher preseason average temperature, the later end of season. As for Greenup pace, there is variation in impact direction among genera. The preseason length also varies significantly among genera.\n\nCode\ntavg_allyear_pcorr &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\",city,\"/tavg_allyear_pcorr.rds\")) %&gt;%\n  mutate(\n    # Create a flag for optimal_pre_length\n    is_optimal = ifelse(pre_length_candidate == optimal_pre_length, TRUE, FALSE),\n    # Create a flag for significant pvalue\n    is_significant = ifelse(pvalue_trend &lt; 0.05, TRUE, FALSE),\n    # Adjust transparency\n    alpha = ifelse(is_optimal, 1, 0.2),\n    shape = ifelse(is_significant, 21, 1),\n    size = ifelse(is_optimal, 2.5, 1.2)\n  ) %&gt;%\n  mutate(shape = factor(shape, levels = c(21, 1)),\n         size = factor(size, levels = c(1.2, 2.5)))\n  \n\n# Create the plot\nsos_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"SOS\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, shape = shape, size = size)) +  # Add points with alpha and fill\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt; 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 2.5), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Start of season\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n  \ngreenup_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"green-up pace\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt; 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 2.5), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Green-up pace\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\neos_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"EOS\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt; 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 2.5), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"End of season\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\n\ngreendown_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"green-down pace\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt; 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 2.5), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Green-down pace\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\nsos_p + greenup_p + plot_layout(guides = \"collect\") & theme(legend.position = \"right\")\neos_p + greendown_p + plot_layout(guides = \"collect\") & theme(legend.position = \"right\")\n\n\n\n\n\n\n\n\n\n\n\n\n(a) Spring phenology\n\n\n\n\n\n\n\n\n\n\n\n\n\n(b) Fall phenology\n\n\n\n\n\n\n\nFigure 2: Distribution of partial correlation coefficient and preseason length, calculated by Tempavg"
  },
  {
    "objectID": "workflow_micro_NYC.html#spatial-pattern-sos-tavg",
    "href": "workflow_micro_NYC.html#spatial-pattern-sos-tavg",
    "title": "workflow_micro_NYC",
    "section": "3 Spatial pattern (SOS ~ Tavg)",
    "text": "3 Spatial pattern (SOS ~ Tavg)\n\n3.1 Check spatial autocorrelation\nBoth fixed-effect model and mixed-effects model have heterogeneous residuals. Global Moran I for regression residuals test indicates the presence of spatial autocorrelation in the residuals. Lagrange Multiplier test suggests the spatial model should be applied.\n\n\nCode\ntavg_allyear_var &lt;- readRDS(\"~/phenology-urban/data/proc/urban/NY/tavg_allyear_var.rds\")\ngenera &lt;- unique(tavg_allyear_var$genus)\nvariogram_results &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"up\" & thres == 0.5 & genus == !!genus) %&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n  \n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_results[[i]] &lt;- data.frame(\n    genus = genus,\n    model = vgm_exn_fit$model,\n    psill = vgm_exn_fit$psill,\n    range = vgm_exn_fit$range\n  )\n}\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nOK: Error variance appears to be homoscedastic (p = 0.826).\n\n\nCode\nvariogram_summary &lt;- do.call(rbind, variogram_results)\nkable(variogram_summary, caption = \"Fitted semivariogram model for each genus\")\n\n\n\nFitted semivariogram model for each genus\n\n\ngenus\nmodel\npsill\nrange\n\n\n\n\nCarya\nSph\n119.539553\n0.0094942\n\n\nAcer\nSph\n95.395099\n-0.0375294\n\n\nQuercus\nSph\n91.362932\n-0.0532885\n\n\nPlatanus\nSph\n35.766955\n-0.0209021\n\n\nJuglans\nMat\n62.373693\n0.0012231\n\n\nLiquidambar\nSph\n63.214989\n0.0097814\n\n\nBetula\nMat\n82.330152\n-0.0272595\n\n\nPopulus\nMat\n37.382824\n-0.0000106\n\n\nMorus\nExp\n152.724414\n0.0010145\n\n\nUlmus\nSph\n106.504789\n-0.2291773\n\n\nFraxinus\nMat\n27.600177\n-0.0063073\n\n\nCeltis\nMat\n64.975068\n-0.0183950\n\n\nSalix\nMat\n86.863874\n-0.0014266\n\n\nAlnus\nSph\n9.277417\n0.0000048\n\n\n\n\n\n\n\n3.2 Spatial statistical model\nWe modeled the relationship between the day of year (()) and environmental covariates using a spatial hierarchical model. The response variable at location (_i), denoted as (y(_i)), was modeled as follows:\n\\[y(\\mathbf{s}_i) = \\mu(\\mathbf{s}_i) + w(\\mathbf{s}_i) + u_{\\text{year}(i)} + \\epsilon(\\mathbf{s}_i)\\]\nwhere:\n\nFixed Effects: \\[\\mu(\\mathbf{s}_i) = \\mathbf{X}_i \\boldsymbol{\\beta}\\]\n\n\\(\\mathbf{X}_i = [1, \\text{AvgTemp}, \\text{Precp}, \\text{srad}]\\) is the design matrix of predictors.\n\\(\\boldsymbol{\\beta} = [\\beta_0, \\beta_1, \\beta_2, \\beta_3]\\) are the regression coefficients for the intercept and covariates.\n\nSpatially Correlated Random Effect: \\[w(\\mathbf{s}_i) \\sim \\text{MVN}(\\mathbf{0}, \\mathbf{R} \\cdot \\sigma^2)\\]\n\n\\(\\mathbf{R}\\) is the spatial correlation matrix defined by a covariance function:\nMatérn Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\frac{2^{1-\\nu}}{\\Gamma(\\nu)} \\left(\\frac{\\sqrt{2\\nu} D_{ij}}{\\rho}\\right)^\\nu K_\\nu\\left(\\frac{\\sqrt{2\\nu} D_{ij}}{\\rho}\\right)\\]\nExponential Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\exp(-\\phi D_{ij})\\]\nGaussian Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\exp(-\\phi D_{ij}^2)\\]\nSpherical Covariance Function (if selected):\n\n\\[\\mathbf{R}_{ij} =\n        \\begin{cases}\n        \\sigma^2 \\cdot \\left(1 - \\frac{3 D_{ij}}{2\\rho} + \\frac{D_{ij}^3}{2\\rho ^3}\\right), & D_{ij} \\leq \\rho \\\\\n        0, & D_{ij} &gt; \\rho\n        \\end{cases}\\]\nYear-specific Random Effect: \\[u_{\\text{year}(i)} \\sim \\text{N}(0, \\tau^2_{\\text{year}})\\]\n\n\\(u_{\\text{year}(i)}\\) captures year-to-year variability, with \\(\\tau^2_{\\text{year}}\\) being the variance of the year effect.\n\nIndependent Nugget Effect: \\[\\epsilon(\\mathbf{s}_i) \\sim \\text{N}(0, \\tau^2)\\]\n\n\\(\\epsilon(\\mathbf{s}\\_i)\\) accounts for measurement error or small-scale variability.\n\n\n\nPrior Distributions\n\\[\\boldsymbol{\\beta} \\sim \\text{MVN}(\\mathbf{0}, 1000\\mathbf{I})\\]\n\\[\\sigma^2 \\sim \\text{Inverse-Gamma}(2.5, 120)\\]\n\\[\\phi \\sim \\text{Uniform}(5, 50) \\quad \\text{(Exponential or Gaussian covariance)}\\]\n\\[\\nu \\sim \\text{Uniform}(0.5, 5) \\quad \\text{(Matérn covariance only)}\\]\n\\[\\rho \\sim \\text{Uniform}(0, 1) \\quad \\text{(Matérn or Spherical covariance)}\\]\n\\[\\tau^2 \\sim \\text{Inverse-Gamma}(0.001, 0.001)\\]\n\\[\\tau^2_{\\text{year}} \\sim \\text{Inverse-Gamma}(2.001, 0.667)\\]\n\nProblem with year (replicate location):\n\nTreat year as random effect\n\nProblem with genus:\n\nFit each genus separately\n\n\nSOS in NYC\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/\"\nfiles &lt;- list.files(dir_path, pattern = \"^NY.*SOS\\\\.rds$\", full.names = TRUE)\nplots &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_SOS\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == \"AvgTemp\")\n  beta_median &lt;- median(param_data$value)\n  p &lt;- param_data %&gt;%\n    ggs_density() +\n    theme_bw() +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme(plot.title = element_text(hjust = 0.5)) +\n    annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4)\n  plots[[genus]] &lt;- p\n}\n\ncombined_plot &lt;- wrap_plots(plots, ncol = 2)\ncombined_plot\n\n\n\n\n\n\n\n\nFigure 3: The density of the posterior distribution of regression coefficients for Temp~avg~ with SOS as the response variable for each genus in New York city."
  },
  {
    "objectID": "workflow_micro_NYC.html#spatial-pattern",
    "href": "workflow_micro_NYC.html#spatial-pattern",
    "title": "workflow_micro_NYC",
    "section": "3 Spatial pattern",
    "text": "3 Spatial pattern\n\n3.1 Check spatial autocorrelation\nFirst, I fitted a linear mixed-effects model for each genus with environmental variables (AvgTemp_mean, Sum_mm_sum, and srad_mean) as predictors, with random effects for year and id, which represent temporal ((1 | year)) and spatial ((1 | id)) randomness, respectively.\nThen I conducted a variance decomposition analysis and compared the proportion of total variance explained by spatial effects and temporal effects respectively. Generally, spatial and temporal variations are both present, but their contributions vary across different genera. Some genera show higher spatial effects, while others have more balanced contributions from spatial and year components.\n\n\nCode\ntavg_allyear_var &lt;- readRDS(\"~/phenology-urban/data/proc/urban/NY/tavg_allyear_var.rds\")\nphe_types &lt;- c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\")\nall_genus &lt;- unique(tavg_allyear_var$genus)\nresults &lt;- list()\n\nfor (phe_type in phe_types) {\n  if (phe_type == \"SOS\") {\n    phe_metric &lt;- \"doy\"\n    direction &lt;- \"up\"\n    thres &lt;- 0.5\n  } else if (phe_type == \"EOS\") {\n    phe_metric &lt;- \"doy\"\n    direction &lt;- \"down\"\n    thres &lt;- 0.5\n  } else if (phe_type == \"GreenUp\") {\n    phe_metric &lt;- \"doy_diff\"\n    direction &lt;- \"up\"\n    thres &lt;- 0.2\n    tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n  } else {\n    phe_metric &lt;- \"doy_diff\"\n    direction &lt;- \"down\"\n    thres &lt;- 0.2\n    tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n  }\n    \n    for (genus in all_genus) {\n      tavg_SOS &lt;- tavg_allyear_var %&gt;%\n        filter(direction == !!direction & thres == thres & genus == !!genus) %&gt;%\n        na.omit()\n      model &lt;- as.formula(paste0(phe_metric, \" ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year) + (1 | id)\"))\n      full_model &lt;- lmer(model, data = tavg_SOS)\n      var_components &lt;- VarCorr(full_model)\n      \n      total_variance &lt;-  var_components$id[1, 1] +  var_components$year[1, 1] + attr(var_components, \"sc\")^2\n      spatial_contribution &lt;- var_components$id[1, 1]  / total_variance\n      year_contribution &lt;-  var_components$year[1, 1] / total_variance\n      residual_contribution &lt;- attr(var_components, \"sc\")^2 / total_variance\n      \n      variance_components &lt;- data.frame(\n            Metric = phe_type,\n            Genus = genus,\n            Component = c(\"Spatial\", \"Year\", \"Residual\"),\n            Variance = c(spatial_contribution, year_contribution, residual_contribution)\n          )\n          \n          results[[paste(phe_type, genus, sep = \"_\")]] &lt;- variance_components\n  }\n}\n\nfinal_results &lt;- do.call(rbind, results)\nfinal_results &lt;- final_results %&gt;%\n  group_by(Metric, Genus) %&gt;%\n  mutate(Variance_Proportion = Variance / sum(Variance),\n         Component = factor(Component, levels = c(\"Spatial\", \"Residual\", \"Year\")),\n         Metric = factor(Metric, levels = c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\")))\n\nggplot(final_results, aes(x = Genus, y = Variance_Proportion, fill = Component)) +\n  geom_bar(stat = \"identity\", position = \"stack\") +\n  facet_wrap(~Metric, scales = \"free_x\") +\n  labs(x = \"Genus\", y = \"Variance Proportion\", fill = \"Component\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  scale_fill_brewer(palette = \"Set2\") \n\n\n\n\n\n\n\n\nFigure 3: Variance decomposition analysis for spatial and temporal effects\n\n\n\n\n\nUsing SOS as an example, I used check_heteroscedasticity() to check for heteroscedasticity in the residuals. The results showed almost every model had heterogenerous residuals.\nFor fixed-effect model (SOS ~ AvgTemp_mean + Sum_mm_sum + srad_mean), Global Moran I for regression residuals test indicates the presence of spatial autocorrelation in the residuals. Lagrange Multiplier test suggests the spatial model should be applied.\nI computed the empirical semivariogram for the residuals to analyze spatial structure. The optimal theoretical semivariogram models (among Exp, Sph, Gau, Mat) were chosen to empirical semivariogram using fit.variogram().\n\n\nCode\ntavg_allyear_var &lt;- readRDS(\"~/phenology-urban/data/proc/urban/NY/tavg_allyear_var.rds\")\ngenera &lt;- unique(tavg_allyear_var$genus)\n\n\nvariogram_sos &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"up\" & thres == 0.5 & genus == !!genus) %&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_sos[[i]] &lt;- data.frame(\n    genus = genus,\n    SOS = vgm_exn_fit$model\n  )\n}\nvariogram_sos &lt;- do.call(rbind, variogram_sos)\n\n\nvariogram_eos &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"down\" & thres == 0.5 & genus == !!genus) %&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_eos[[i]] &lt;- data.frame(\n    genus = genus,\n    EOS = vgm_exn_fit$model\n  )\n}\nvariogram_eos &lt;- do.call(rbind, variogram_eos)\n\nvariogram_up &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"up\" & thres == 0.2 & genus == !!genus) %&gt;%\n    mutate(doy_diff = as.numeric(doy_diff))%&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy_diff ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_up[[i]] &lt;- data.frame(\n    genus = genus,\n    GreenUp = vgm_exn_fit$model\n  )\n}\n\n\n[1] \"a possible solution MIGHT be to scale semivariances and/or distances\"\n\n\n[1] \"a possible solution MIGHT be to scale semivariances and/or distances\"\n\n\n[1] \"a possible solution MIGHT be to scale semivariances and/or distances\"\n\n\n[1] \"a possible solution MIGHT be to scale semivariances and/or distances\"\n\n\nCode\nvariogram_up &lt;- do.call(rbind, variogram_up)\n\nvariogram_down &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"down\" & thres == 0.2 & genus == !!genus) %&gt;%\n    mutate(doy_diff = as.numeric(doy_diff))%&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy_diff ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_down[[i]] &lt;- data.frame(\n    genus = genus,\n    GreenDown = vgm_exn_fit$model\n  )\n}\nvariogram_down &lt;- do.call(rbind, variogram_down)\n\nvariogram_summary &lt;- variogram_sos %&gt;%\n  left_join(variogram_eos, by = \"genus\") %&gt;%\n  left_join(variogram_up, by = \"genus\") %&gt;%\n  left_join(variogram_down, by = \"genus\")\n\nkable(variogram_summary, caption = \"Fitted semivariogram model for each genus\")\n\n\n\nFitted semivariogram model for each genus\n\n\ngenus\nSOS\nEOS\nGreenUp\nGreenDown\n\n\n\n\nCarya\nSph\nSph\nSph\nMat\n\n\nAcer\nSph\nGau\nSph\nSph\n\n\nQuercus\nSph\nMat\nSph\nMat\n\n\nPlatanus\nSph\nGau\nSph\nSph\n\n\nJuglans\nMat\nMat\nSph\nMat\n\n\nLiquidambar\nSph\nExp\nGau\nSph\n\n\nBetula\nMat\nSph\nSph\nMat\n\n\nPopulus\nMat\nSph\nExp\nMat\n\n\nMorus\nExp\nMat\nMat\nSph\n\n\nUlmus\nSph\nSph\nMat\nSph\n\n\nFraxinus\nMat\nSph\nSph\nSph\n\n\nCeltis\nMat\nMat\nMat\nMat\n\n\nSalix\nMat\nMat\nExp\nMat\n\n\nAlnus\nSph\nGau\nSph\nMat\n\n\n\n\n\nSph: 26, Mat: 22, Gau: 4, Exp: 4 HT: Sph, Mat\n\n\n3.2 Spatial statistical model\nI modeled the relationship between the phenology and environmental covariates using a spatial hierarchical model. The response variable (phenology parameter) at location \\(\\mathbf{s}_i\\) and in year \\(\\mathbf{t}\\), denoted as \\(y(\\mathbf{s}_i, \\mathbf{t})\\), was modeled as following candidate model:\nModel 1: (current use)\n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w(\\mathbf{s}_i) + u(\\mathbf{t}) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\n\nFixed Effects: \\[\\mu(\\mathbf{s}_i,\\mathbf{t}) = \\mathbf{X}_{\\mathbf{s}_i,\\mathbf{t}} \\boldsymbol{\\beta}\\]\n\n\\(\\mathbf{X}_{\\mathbf{s}_i,\\mathbf{t}} = [1, \\text{AvgTemp}_{\\mathbf{s}_i,\\mathbf{t}}, \\text{Precp}_{\\mathbf{s}_i,\\mathbf{t}}, \\text{srad}_{\\mathbf{s}_i,\\mathbf{t}}]\\) is the design matrix of predictors.\n\\(\\boldsymbol{\\beta} = [\\beta_0, \\beta_1, \\beta_2, \\beta_3]\\) are the regression coefficients for the intercept and covariates.\n\nSpatially Correlated Random Effect: \\[w(\\mathbf{s}_i) \\sim \\text{MVN}(\\mathbf{0}, \\mathbf{R})\\]\n\n\\(\\mathbf{R}\\) is the spatial correlation matrix defined by a covariance function:\nMatérn Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\frac{2^{1-\\nu}}{\\Gamma(\\nu)} \\left(\\frac{\\sqrt{2\\nu} D_{ij}}{\\rho}\\right)^\\nu K_\\nu\\left(\\frac{\\sqrt{2\\nu} D_{ij}}{\\rho}\\right)\\]\nExponential Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\exp(-\\phi D_{ij})\\]\nGaussian Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\exp(-\\phi D_{ij}^2)\\]\nSpherical Covariance Function (if selected):\n\n\\[\\mathbf{R}_{ij} =\n        \\begin{cases}\n        \\sigma^2 \\cdot \\left(1 - \\frac{3 D_{ij}}{2\\rho} + \\frac{D_{ij}^3}{2\\rho ^3}\\right), & D_{ij} \\leq \\rho \\\\\n        0, & D_{ij} &gt; \\rho\n        \\end{cases}\\]\nYear-specific Random Effect: \\[u(\\mathbf{t}) \\sim \\text{N}(0, \\tau^2_{\\mathbf{t}})\\]\n\n\\(u_{\\mathbf{t}}\\) captures year-to-year variability, with \\(\\tau^2_{\\mathbf{t}}\\) being the variance of the year effect.\n\nIndependent Nugget Effect: \\[\\epsilon(\\mathbf{s}_i) \\sim \\text{N}(0, \\tau^2)\\]\n\n\\(\\epsilon(\\mathbf{s}_i, \\mathbf{t})\\) accounts for measurement error or small-scale variability.\n\n\nModel 2: (checked)\n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w(\\mathbf{s}_i, \\mathbf{t}) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\n\nFixed Effects: same as above.\nSpatio-temporal Random Effect: \\[w(\\mathbf{s}_i, \\mathbf{t}) \\sim \\text{MVN}(\\mathbf{0}, \\mathbf{R}_{\\mathbf{s}\\mathbf{t}})\\]\n\n\\(\\mathbf{R}\\) is the spatio-temporal correlation matrix defined by covariance function. The function format is the same.\nInstead, \\(D_{ij}\\) is the distance using 3-dimension coordinate, (scaled_longitude, scaled_latitude, scaled_year).\n\nIndependent Nugget Effect: same as above.\n\nModel 3: \n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w_t(\\mathbf{s}_i) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\n\nFixed Effects: same as above.\nSpatio-temporal Random Effect: \\[w_t(\\mathbf{s}_i) \\sim \\text{MVN}(\\mathbf{0}, \\mathbf{R}_{\\mathbf{t}})\\]\n\n\\(\\mathbf{R}_{\\mathbf{t}}\\) is fitted for each year. Or the parameters in covariance matrix, e.g., \\(\\phi(\\mathbf{t}_j) \\sim \\text{N}(0, \\tau^2_{\\phi})\\)\n\nIndependent Nugget Effect: same as above.\n\nModel 4: \n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w(\\mathbf{s}_i) + u(\\mathbf{t}) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\n\nFixed Effects: same as above.\nSpatially Correlated Random Effect: \\[w(\\mathbf{s}_i) \\sim \\text{MVN}(\\mathbf{0}, \\mathbf{R})\\]\n\n\\(\\mathbf{R}\\) is the spatial correlation matrix defined by a covariance function:\n\n\\[\\mathbf{R}_{ij} =\n\\begin{cases}\n0 \\text{ or a very samll value} & \\text{if } \\mathbf{t}_{i} \\neq \\mathbf{t}_{j} \\\\\n\\text{follow covariance function}  & \\text{otherwise}\n\\end{cases}\\]\nYear-specific Random Effect: same as above.\nIndependent Nugget Effect: same as above.\n\n\n3.2.0 Simulation for canndidate models\nFor model comparison, I simulated the data with the true slope of Avg_temp is -2. Both spatial variance (exp covariance) and temporal variance are included. Some records happen in the same location.\n\n################ Make up the simulation data ################\nset.seed(2025)\nlon_range &lt;- c(-74.25156, -73.70623)\nlat_range &lt;- c(40.50458, 40.91093)\nN &lt;- 200 \nlon &lt;- runif(N, min = lon_range[1], max = lon_range[2])\nlat &lt;- runif(N, min = lat_range[1], max = lat_range[2])\n\nyears &lt;- 2017:2023\nnyears &lt;- length(years)\nyear &lt;- sample(years, N, replace = TRUE)\n\n# fix effects: intercept, tavg, precp, srad\nintercept &lt;- 120\ntavg &lt;- runif(N, 0, 25)\nprecp &lt;- runif(N, 0, 500)\nsrad &lt;- runif(N, 300, 450)\n\nbeta &lt;- c(intercept, -2, 0.05, 0.05)\nX &lt;- cbind(1, tavg, precp, srad)\n\n# spatial effect\nsigma.sq &lt;- 80\nphi &lt;- 25\nspatial_effect &lt;- numeric(N)\n\nfor (y in years) {\n  year_idx &lt;- which(year == y)\n  if (length(year_idx) &gt; 1) {\n    lon_year &lt;- lon[year_idx]\n    lat_year &lt;- lat[year_idx]\n    dist_matrix_year &lt;- as.matrix(dist(cbind(lon_year, lat_year)))\n    cov_matrix_year &lt;- sigma.sq * exp(-phi * dist_matrix_year)\n    spatial_effect[year_idx] &lt;- mvrnorm(1, mu = rep(0, length(year_idx)), Sigma = cov_matrix_year)\n  } else {\n    spatial_effect[year_idx] &lt;- 0\n  }\n}\n\n# year effect\nyear_effect &lt;- rnorm(nyears, mean = 0, sd = 1)\n\nmu &lt;- numeric(N)\ny &lt;- numeric(N)\ntau &lt;- 1 \nfor (i in 1:N) {\n  year_idx &lt;- which(years == year[i])\n  mu[i] &lt;- X[i,] %*% beta + spatial_effect[i] + year_effect[year_idx]\n  y[i] &lt;- rnorm(1, mean = mu[i], sd = sqrt(1/tau))\n}\n\nsim_data &lt;- data.frame(\n  lon = lon,\n  lat = lat,\n  year = year,\n  AvgTemp_mean = tavg,\n  Sum_mm_sum = precp,\n  srad_mean = srad,\n  spatial_effect = spatial_effect,\n  doy = y\n)\n\n\n\nCode\n################ Result form Nimble using 4 model ################\n\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/\"\nfiles &lt;- list.files(dir_path, pattern = \"^SIM.*Exp\\\\.rds$\", full.names = TRUE)\nplots &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*SIM_(.*?)_tavg_SOS_Exp\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == \"AvgTemp\")\n  beta_median &lt;- median(param_data$value)\n  beta_mean &lt;- mean(param_data$value)\n  p &lt;- param_data %&gt;%\n    ggs_density() +\n    theme_bw() +\n    ggtitle(paste(\"Model:\", genus)) +\n    theme(plot.title = element_text(hjust = 0.5)) +\n    annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4) +\n    annotate(\"text\", x = beta_mean, y = 2, label = paste0(\"Mean: \", round(beta_mean, 2)),vjust = -1.5, color = \"red\", size = 4)\n  plots[[genus]] &lt;- p\n}\n\ncombined_plot &lt;- wrap_plots(plots, ncol = 2)\ncombined_plot\n\n\n\n\n\n\n\n\nFigure 4: The distribution of posterior for Temp coeffeicent using simulated data.\n\n\n\n\n\n\n\nCode\n################ Sensitivity to different covariance model ################\n\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/\"\n\nfiles &lt;- list.files(dir_path, pattern = \"^SIM_sp_random.*\\\\.rds$\", full.names = TRUE)\nplots &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*SIM_(.*?)_tavg_SOS_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  \n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == \"AvgTemp\")\n  beta_median &lt;- median(param_data$value)\n  beta_mean &lt;- mean(param_data$value)\n  p &lt;- param_data %&gt;%\n    ggs_density() +\n    theme_bw() +\n    ggtitle(paste(\"Model:\", genus)) +\n    theme(plot.title = element_text(hjust = 0.5)) +\n    annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4) +\n    annotate(\"text\", x = beta_mean, y = 2, label = paste0(\"Mean: \", round(beta_mean, 2)),vjust = -1.5, color = \"red\", size = 4)\n  plots[[genus]] &lt;- p\n}\n\ncombined_plot2 &lt;- wrap_plots(plots, ncol = 2)\ncombined_plot2\n\nfiles &lt;- list.files(dir_path, pattern = \"^SIM_joint.*\\\\.rds$\", full.names = TRUE)\nplots &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*SIM_(.*?)_tavg_SOS_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  \n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == \"AvgTemp\")\n  beta_median &lt;- median(param_data$value)\n  beta_mean &lt;- mean(param_data$value)\n  p &lt;- param_data %&gt;%\n    ggs_density() +\n    theme_bw() +\n    ggtitle(paste(\"Model:\", genus)) +\n    theme(plot.title = element_text(hjust = 0.5)) +\n    annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4) +\n    annotate(\"text\", x = beta_mean, y = 2, label = paste0(\"Mean: \", round(beta_mean, 2)),vjust = -1.5, color = \"red\", size = 4)\n  plots[[genus]] &lt;- p\n}\n\ncombined_plot &lt;- wrap_plots(plots, ncol = 2)\ncombined_plot\n\n\n\n\n\n\n\n\n\n\n\n(a) Model 1: Spatial random effect & year random effect\n\n\n\n\n\n\n\n\n\n\n\n(b) Model 2: Spatio-temporal random effect\n\n\n\n\n\n\nFigure 5: The distribution of posterior for Temp coeffeicent using simulated data and different covariance model.\n\n\n\n\n\n\n3.2.1 Nimble model code (run in separate script)\n\nspherical_covariance &lt;- nimbleFunction(\n  run = function(d = double(0), range = double(0), sigma.sq = double(0)) {\n    returnType(double(0)) \n    if (d &lt;= range) {\n      return (sigma.sq * (1 - (3 * d / (2 * range)) + (d^3 / (2 * range^3))))\n    } else {\n      return(0.0)\n    }\n  }\n)\n\nmatern_covariance &lt;- nimbleFunction(\n  run = function(d = double(0), range = double(0), sigma.sq = double(0), nu = double(0)) {\n    returnType(double(0))\n      if (d == 0) {\n        return(sigma.sq)\n      } else {\n        part &lt;- (2^(1 - nu)) / gamma(nu)  * (sqrt(2 * nu) * d / range)^nu\n        return(sigma.sq * part * besselK(d / range, nu))\n      }\n  }\n)\n\n# Define Nimble model code\nmodel_code &lt;- nimbleCode({\n  for (i in 1:N) {\n    y[i] ~ dnorm(mu[i], tau)\n    mu[i] &lt;- inprod(X[i, 1:P], beta[]) + spatial_effect[i] + year_effect[year[i]]\n  }\n  for (q in 1:nyears) {\n    year_effect[q] ~ dnorm(0, sd = sqrt(tau.year))\n  }\n  for (j in 1:P) {\n    beta[j] ~ dnorm(0, sd = 1000)\n  }\n  spatial_effect[1:N] ~ dmnorm(Mu[1:N], cov = cov_matrix[1:N, 1:N])\n  \n  # Choose the covariance function based on variogram fitting\n  if (cov_type == \"Mat\") {\n    for (m in 1:N) {\n      for (n in 1:N) {\n        cov_matrix[m, n] &lt;- matern_covariance(dist_matrix[m, n], range, sigma.sq, nu)\n      }\n    }\n  } else if (cov_type == \"Gau\") {\n    cov_matrix[1:N, 1:N] &lt;- sigma.sq * exp(-phi * dist_matrix[1:N, 1:N]^2)\n  } else if (cov_type == \"Exp\") {\n    cov_matrix[1:N, 1:N] &lt;- sigma.sq * exp(-phi * dist_matrix[1:N, 1:N])\n  } else if (cov_type == \"Sph\") {\n    for (m in 1:N) {\n      for (n in 1:N) {\n        cov_matrix[m, n] &lt;- spherical_covariance(dist_matrix[m, n], range, sigma.sq)\n      }\n    }\n  }\n  tau ~ dgamma(0.001, 0.001)\n  sigma.sq ~ dinvgamma(2.5, 120)\n  phi ~ dunif(5 / 1, 5 / 0.1)\n  tau.year ~ dinvgamma(2.001, 0.667)\n  range ~ dunif(0, 1)\n  nu ~ dunif(0.5, 5)\n})\n\n\n\n3.2.2 SOS in NYC\nMost genera showed negative association between temperature and the start of season, suggesting the warmer preseason, the earilier start of season. Only Fraxinus had a positive association, with a median coefficient of 0.15. There are significant genus-level differences in how temperature influences the spring phenology.\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/year_random/\"\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/sp_temp/\"\n\nfiles &lt;- list.files(dir_path, pattern = \"^NY.*SOS\\\\.rds$\", full.names = TRUE)\nplots &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_SOS\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == \"AvgTemp\")\n  beta_median &lt;- median(param_data$value)\n  p &lt;- param_data %&gt;%\n    ggs_density() +\n    theme_bw() +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme(plot.title = element_text(hjust = 0.5)) +\n    annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4)\n  plots[[genus]] &lt;- p\n}\n\ncombined_plot2 &lt;- wrap_plots(plots, ncol = 3)\ncombined_plot1\ncombined_plot2\n\n\n\n\n3.2.3 EOS in NYC\nThe response of end of season to temperature shows greater variation among genera compared to spring phenology. For Acer, Betula, Liquidambar, Populus, Quercus, Salix, Ulmus, warmer preseason leads to earlier end of season. In contrast, Catya, Celtis, Fracinus and Juglans exhibited positive associations.\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/year_random/\"\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/sp_temp/\"\n\nfiles &lt;- list.files(dir_path, pattern = \"^NY.*EOS\\\\.rds$\", full.names = TRUE)\nplots &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_EOS\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == \"AvgTemp\")\n  beta_median &lt;- median(param_data$value)\n  p &lt;- param_data %&gt;%\n    ggs_density() +\n    theme_bw() +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme(plot.title = element_text(hjust = 0.5)) +\n    annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4)\n  plots[[genus]] &lt;- p\n}\n\ncombined_plot1 &lt;- wrap_plots(plots, ncol = 3)\ncombined_plot1\n\n\n\n\n3.2.4 GreenUp pace in NYC\nThe response of green-up pace to temperature shows great variation among genera. For most genera, the warmer the preseason, the faster the green-up pace (shorter green-up length). For Celtis and Ulmus, warmer preseason is associated with slower green-up pace (longer green-up length).\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/sp_temp/\"\nfiles &lt;- list.files(dir_path, pattern = \"^NY.*Up\\\\.rds$\", full.names = TRUE)\nplots &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == \"AvgTemp\")\n  beta_median &lt;- median(param_data$value)\n  p &lt;- param_data %&gt;%\n    ggs_density() +\n    theme_bw() +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme(plot.title = element_text(hjust = 0.5)) +\n    annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4)\n  plots[[genus]] &lt;- p\n}\n\ncombined_plot &lt;- wrap_plots(plots, ncol = 3)\ncombined_plot\n\n\n\n\n3.2.5 GreenDown pace in NYC\nThe response of green-down pace to temperature shows great variation among genera. For Acer, Betula, Carya, Celtis, Fraxinus, Morus, Platanus and Quercus, the warmer the preseason, the faster the green-down pace (shorter green-down length). For Juglans, Populus, Salix and Liquidambar, warmer preseason is associated with slower green-down pace (longer green-down length).\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/sp_temp/\"\nfiles &lt;- list.files(dir_path, pattern = \"^NY.*Down\\\\.rds$\", full.names = TRUE)\nplots &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == \"AvgTemp\")\n  beta_median &lt;- median(param_data$value)\n  p &lt;- param_data %&gt;%\n    ggs_density() +\n    theme_bw() +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme(plot.title = element_text(hjust = 0.5)) +\n    annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4)\n  plots[[genus]] &lt;- p\n}\n\ncombined_plot3 &lt;- wrap_plots(plots, ncol = 3)\ncombined_plot3\n\n\n\n\n3.2.6 Comparison\nThe genus Alnus has fewer data points, leading to non-convergence of the posterior distribution. So it is ignored here.\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/\"\nSOS_files &lt;- list.files(dir_path, pattern = \"^NY.*SOS\\\\.rds$\", full.names = TRUE)\nEOS_files &lt;- list.files(dir_path, pattern = \"^NY.*EOS\\\\.rds$\", full.names = TRUE)\nGup_files &lt;- list.files(dir_path, pattern = \"^NY.*Up\\\\.rds$\", full.names = TRUE)\nGdown_files &lt;- list.files(dir_path, pattern = \"^NY.*Down\\\\.rds$\", full.names = TRUE)\n\nparam_sos_list &lt;- list()\nfor (i in seq_along(SOS_files)) {\n  file &lt;- SOS_files[i]\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = genus)\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == !!genus)\n  param_sos_list[[i]] &lt;- param_data\n}\n\nparam_eos_list &lt;- list()\nfor (i in seq_along(EOS_files)) {\n  file &lt;- EOS_files[i]\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = genus)\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == !!genus)\n  param_eos_list[[i]] &lt;- param_data\n}\n\nparam_gup_list &lt;- list()\nfor (i in seq_along(Gup_files)) {\n  file &lt;- Gup_files[i]\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = genus)\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == !!genus)\n  param_gup_list[[i]] &lt;- param_data\n}\n\nparam_gdown_list &lt;- list()\nfor (i in seq_along(Gdown_files)) {\n  file &lt;- Gdown_files[i]\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = genus)\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == !!genus)\n  param_gdown_list[[i]] &lt;- param_data\n}\n\ncombined_param_sos_data &lt;- bind_rows(param_sos_list) %&gt;% filter(Parameter != \"Alnus\")\ncombined_param_eos_data &lt;- bind_rows(param_eos_list) %&gt;% filter(Parameter != \"Alnus\")\ncombined_param_gup_data &lt;- bind_rows(param_gup_list) %&gt;% filter(Parameter != \"Alnus\")\ncombined_param_gdown_data &lt;- bind_rows(param_gdown_list) %&gt;% filter(Parameter != \"Alnus\")\ncombined_param_data &lt;- combined_param_sos_data %&gt;%\n  mutate(phe_type = \"SOS\") %&gt;%\n  bind_rows(combined_param_eos_data %&gt;% mutate(phe_type = \"EOS\"))%&gt;%\n  bind_rows(combined_param_gup_data %&gt;% mutate(phe_type = \"GreenUp\"))%&gt;%\n  bind_rows(combined_param_gdown_data %&gt;% mutate(phe_type = \"GreenDown\"))\n\n# ggmcmc\nlist(SOS=combined_param_sos_data, EOS=combined_param_eos_data, GreenUp=combined_param_gup_data, GreenDown = combined_param_gdown_data) %&gt;% \n  ggs_caterpillar(thick_ci = c(0.05, 0.95),\n                  thin_ci = c(0.025, 0.975),\n                  horizontal = FALSE) +\n  theme_classic() +\n  labs(y = \"Genus\",\n       x = \"The posterior of regression coefficients for Tavg\") +\n  theme(\n    axis.title.x = element_text(size = 12),\n    axis.title.y = element_text(size = 12),\n    axis.text.x = element_text(size = 10, angle = 45, hjust = 1),\n    axis.text.y = element_text(size = 10)\n  )\n\n\n\n## geom_linerange\nsummary_data &lt;- combined_param_data %&gt;%\n  group_by(Parameter, phe_type) %&gt;%\n  summarise(\n    mean_value = mean(value, na.rm = TRUE),\n    lower = quantile(value, probs = 0.025),\n    upper = quantile(value, probs = 0.975),\n    .groups = \"drop\"\n  )\nsummary_data$phe_type &lt;- factor(summary_data$phe_type, levels = c(\"SOS\", \"GreenUp\", \"EOS\", \"GreenDown\"))\n\nggplot(summary_data, aes(x = Parameter, y = mean_value, color = phe_type)) +\n  geom_point(size = 3, position = position_dodge(width = 0.5)) +  \n  geom_linerange(aes(ymin = lower, ymax = upper), size = 0.5, \n                 position = position_dodge(width = 0.5)) + \n  geom_vline(xintercept = 0, linetype = \"dashed\", color = \"red\") +\n  theme_classic() +\n  labs(\n    x = \"Genus\",\n    y = \"The posterior of regression coefficients for Tavg\",\n    color = \"Phenological parameter\"\n  ) +\n  scale_color_manual(\n    values = c(\"SOS\" = \"darkgreen\", \"GreenUp\" = \"darkolivegreen3\", \"EOS\" = \"chocolate4\",  \"GreenDown\" = \"coral\")\n    #coral/chocolate\n  ) +\n  theme(\n    axis.title = element_text(size = 12),\n    axis.text.x = element_text(size = 10, angle = 45, hjust = 1), \n    axis.text.y = element_text(size = 10)\n  )\n\n# combined_param_data&lt;- bind_rows(param_data_list) \n# p &lt;- ggplot(combined_param_data, aes(x = Parameter, y = value, color = phe_type)) +\n#   geom_boxplot(outlier.shape = NA, width = 0.5) + \n#   theme_minimal() +\n#   labs(\n#     x = \"Genus\",\n#     y = \"The distribution of the posterior of regression coefficients\",\n#     color = \"Phenological Type\"\n#   ) +\n#   theme(\n#     axis.title = element_text(size = 14),\n#     axis.text.x = element_text(size = 12, angle = 45, hjust = 1),\n#     axis.text.y = element_text(size = 12),\n#     plot.title = element_text(size = 16, face = \"bold\", hjust = 0.5)\n#   )"
  },
  {
    "objectID": "workflow_micro_NYC.html#intro",
    "href": "workflow_micro_NYC.html#intro",
    "title": "workflow_micro_NYC",
    "section": "",
    "text": "Check the variogram\ndiagnistic for model\nscale up\nmarginal prediction\nKey highlights (coordinate them with Juwon):\n\nWithin-city variation, fall phenology: Katz et al., 2019 Xing et al., 2022. A few papers about intra-urban variation of phenology. Few about the fall phenology.\nPhenology pace, different taxa\n\nPreseason Optimization: At the year-, site-, and taxa-level. Individual-level pre-period might have some built-in relationship.\nPace: As for the algorithm, more uncertainty around 0% and 100%. Use thresholds within the period (20–80%) to represent pace.\nSpatial regression: Use nimble package to address spatial autocorrelation."
  }
]