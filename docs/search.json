[
  {
    "objectID": "workflow_micro_NYC.html",
    "href": "workflow_micro_NYC.html",
    "title": "workflow_micro_NYC",
    "section": "",
    "text": "Action term for last discussion\n\nR-INLA (rather than estimating the joint posterior distribution of the parameters via MCMC, INLA focusing on individual posterior marginals of the model parameters, which is enough to make inference of the model parameters and latent effects in most cases)\nInfererence: Sptatial random effects\nPredictions\nComparison to regular model\nEcological questions -&gt; journal goals\n\nKey highlights (coordinate them with Juwon):\n\nWithin-city variation: fine-scale of phenology and climate observations, across large range.\nSpring & Fall phenology: Katz et al., 2019 Xing et al., 2022. A few papers about intra-urban variation of phenology. Few about the fall phenology.\nPhenology pace, different taxa\n\nMethods\n\nPreseason Optimization: At the year-, site-, and taxa-level. Individual-level pre-period might have some built-in relationship.\nSpatial regression: Use R-INLA package to address spatial autocorrelation."
  },
  {
    "objectID": "workflow_micro_NYC.html#insert-tree-id-base-on-wu-data",
    "href": "workflow_micro_NYC.html#insert-tree-id-base-on-wu-data",
    "title": "workflow_micro_NYC",
    "section": "",
    "text": "For exploratory analysis, I used the street tree in NYC, with the phenology information established by Yiluan. These trees are part of the whole inventory, covering only 14 genera and being sampled. I select the trees which are within 500-m buffer around the weather underground sites.\n\n\nCode\n################ For phenology data ################\n\nmetadata &lt;- read_csv(\"~/lab-data/datasets/vegetation/PS/urban/metadata.csv\") %&gt;%\n  filter(site == \"NY\")\n\nfile_list &lt;- list.files(path = \"~/lab-data/datasets/vegetation/PS/urban/doy/\", pattern = \"^doy_NY_.*\\\\.rds$\", full.names = TRUE)\ndata_list &lt;- file_list %&gt;%\n  map(~ readRDS(.x))\nny_now &lt;- bind_rows(data_list)\n\ntree_location &lt;- metadata %&gt;%\n  mutate(genus = str_extract(taxa, \"^[^ ]+\")) %&gt;%\n  left_join(ny_now, by = \"id\") %&gt;%\n  filter(!is.na(doy)) %&gt;%\n  st_as_sf(coords = c(\"lon\", \"lat\"), crs = 4326)\n\nwu_location &lt;- read_csv(\"~/urban-cooling/data/raw/WU/NY/location.csv\") %&gt;%\n  st_as_sf(coords = c(\"Lon\", \"Lat\"), crs = 4326)\nwu_buffer &lt;- st_buffer(wu_location, dist = 500)\n\nintersects &lt;- st_intersects(tree_location, wu_buffer)\npoints_in_buffer &lt;- tree_location[lengths(intersects) &gt; 0, ]\npoints_in_buffer &lt;- tree_location %&gt;%\n  mutate(buffer_id = sapply(intersects, function(x) if (length(x) &gt; 0) x[1] else NA)) %&gt;% \n  left_join(wu_buffer %&gt;% st_drop_geometry() %&gt;% mutate(buffer_id = row_number()), by = \"buffer_id\") %&gt;%\n  filter(!is.na(buffer_id)) %&gt;%\n  select(-buffer_id)\n\n# write_csv(points_in_buffer, \"~/phenology-urban/data/proc/nyc/tree_WU_500_buffer_PS.csv\")\n# points_in_buffer &lt;- read_csv(\"data/proc/nyc/tree_WU_500_buffer_PS.csv\")\n\n\n\n\nCode\nnyboundary &lt;- st_read(\"~/urban-cooling/data/raw/NYC/boundary/nybb_dissolved.shp\") %&gt;%\n  st_transform(4326)\n\n\nReading layer `nybb_dissolved' from data source \n  `/Volumes/seas-zhukai/proj-urban-cooling/data/raw/NYC/boundary/nybb_dissolved.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 1 feature and 1 field\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 913175.1 ymin: 120128.4 xmax: 1067383 ymax: 272844.3\nProjected CRS: NAD83 / New York Long Island (ftUS)\n\n\nCode\nggplot() +\n  geom_sf(data = nyboundary, fill = \"grey\") +\n  geom_sf(data = wu_location, color = \"blue\", size = 1) +\n  geom_sf(data = points_in_buffer, color = \"red\", size = 0.05) +\n  theme_minimal()\n\n\n\n\n\nLocation of WU sites and trees"
  },
  {
    "objectID": "workflow_micro_NYC.html#creat-the-climate-variable",
    "href": "workflow_micro_NYC.html#creat-the-climate-variable",
    "title": "workflow_micro_NYC",
    "section": "2. Creat the climate variable",
    "text": "2. Creat the climate variable\n\n2.1 Read and clean the WU data (based on GHCNd)\nThere are 4 raw daily variables selected, i.e. AvgTemp, HighTemp, LowTemp and Precipitation_sum (Sum_mm). I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily GHCNd.\n\n\nCode\n# source(\"script/read_clean_WU.R\")\n# all_sites_temp &lt;- read_clean_WU(city = \"NY\", run_checks = TRUE)\nall_sites_temp &lt;- readRDS(\"~/urban-cooling/data/raw/WU/NY/NY_wu.rds\") %&gt;%\n  select(c(Date, HighTemp, AvgTemp, LowTemp, Sum_mm, name))\n\n\n\n\n2.2 Create seasonal temp/prcp variables\nThe seasonal variable is calculated for each site, year, and season. The season is defined as Winter: December(last year) to February, Spring: March to May, Summer: June to August, Fall: September to November.\n\n\nCode\n# filtered_seasonal_data &lt;- all_sites_temp %&gt;%\n#   mutate(\n#     year = year(Date),\n#     month = month(Date),\n#     season = case_when(\n#       month %in% 3:5 ~ \"spring\",\n#       month %in% 6:8 ~ \"summer\",\n#       month %in% 9:11 ~ \"fall\",\n#       TRUE ~ \"winter\"\n#     ),\n#     year = if_else(month == 12, year + 1, year)\n#   ) %&gt;%\n#   group_by(name, year, season, month) %&gt;%\n#   summarise(\n#     across(c(HighTemp, AvgTemp, LowTemp, Sum_mm), ~ sum(!is.na(.)), .names = \"count_{.col}\"),\n#     .groups = \"drop\"\n#   ) %&gt;%\n#   group_by(name, year, season) %&gt;%\n#   summarise(\n#     across(starts_with(\"count_\"), ~ sum(. &gt;= 10), .names = \"valid_months_{.col}\"),\n#     .groups = \"drop\"\n#   )\n# \n# seasonal_temp &lt;- all_sites_temp %&gt;%\n#   mutate(\n#     year = year(Date),\n#     month = month(Date),\n#     season = case_when(\n#       month %in% 3:5 ~ \"spring\",\n#       month %in% 6:8 ~ \"summer\",\n#       month %in% 9:11 ~ \"fall\",\n#       TRUE ~ \"winter\"\n#     ),\n#     year = if_else(month == 12, year + 1, year)\n#   ) %&gt;%\n#   # semi_join(valid_combinations, by = c(\"name\", \"year\", \"season\")) %&gt;%\n#   group_by(name, year, season) %&gt;%\n#   summarise(\n#     Avg_HighTemp = mean(HighTemp, na.rm = TRUE),\n#     Avg_AvgTemp = mean(AvgTemp, na.rm = TRUE),\n#     Avg_LowTemp = mean(LowTemp, na.rm = TRUE),\n#     Sum_Sum_mm = sum(Sum_mm, na.rm = TRUE),\n#     .groups = \"drop\"\n#   ) %&gt;%\n#   left_join(\n#     filtered_seasonal_data,\n#     by = c(\"name\", \"year\", \"season\")\n#   ) %&gt;%\n#   mutate(\n#     Avg_HighTemp = if_else(valid_months_count_HighTemp == 3, Avg_HighTemp, NA_real_),\n#     Avg_AvgTemp = if_else(valid_months_count_AvgTemp == 3, Avg_AvgTemp, NA_real_),\n#     Avg_LowTemp = if_else(valid_months_count_LowTemp == 3, Avg_LowTemp, NA_real_),\n#     Sum_Sum_mm = if_else(valid_months_count_Sum_mm == 3, Sum_Sum_mm, NA_real_)\n#   ) %&gt;%\n#   select(name, year, season, Avg_HighTemp, Avg_AvgTemp, Avg_LowTemp, Sum_Sum_mm) %&gt;%\n#   pivot_wider(\n#     names_from = season,\n#     values_from = c(Avg_HighTemp, Avg_AvgTemp, Avg_LowTemp, Sum_Sum_mm),\n#     names_glue = \"{.value}_{season}\"\n#   )\n# \n# seasonal_temp_doy &lt;- points_in_buffer %&gt;%\n#   left_join(seasonal_temp, by = c(\"Site\" = \"name\", \"year\" = \"year\"))\n# \n# saveRDS(seasonal_temp_doy, \"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\")\n\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\")\nhead(seasonal_temp_doy)\n\n\n# A tibble: 6 × 29\n    ...1     id taxa         site  genus  year start   end direction thres   doy\n   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;\n1 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0      11\n2 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.1    35\n3 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.2    55\n4 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.3    75\n5 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.4    87\n6 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.5    96\n# ℹ 18 more variables: geometry &lt;chr&gt;, Site &lt;chr&gt;, Avg_HighTemp_fall &lt;dbl&gt;,\n#   Avg_HighTemp_spring &lt;dbl&gt;, Avg_HighTemp_summer &lt;dbl&gt;,\n#   Avg_HighTemp_winter &lt;dbl&gt;, Avg_AvgTemp_fall &lt;dbl&gt;,\n#   Avg_AvgTemp_spring &lt;dbl&gt;, Avg_AvgTemp_summer &lt;dbl&gt;,\n#   Avg_AvgTemp_winter &lt;dbl&gt;, Avg_LowTemp_fall &lt;dbl&gt;, Avg_LowTemp_spring &lt;dbl&gt;,\n#   Avg_LowTemp_summer &lt;dbl&gt;, Avg_LowTemp_winter &lt;dbl&gt;, Sum_Sum_mm_fall &lt;dbl&gt;,\n#   Sum_Sum_mm_spring &lt;dbl&gt;, Sum_Sum_mm_summer &lt;dbl&gt;, Sum_Sum_mm_winter &lt;dbl&gt;"
  },
  {
    "objectID": "workflow_micro_NYC.html#explore-the-relationship-between-temperature-and-phenology",
    "href": "workflow_micro_NYC.html#explore-the-relationship-between-temperature-and-phenology",
    "title": "workflow_micro_NYC",
    "section": "3 Explore the relationship between temperature and phenology",
    "text": "3 Explore the relationship between temperature and phenology\n\n3.1 Seasonal climate variables\nI chose the Acer genus, 50% threshold as an example to plot the relationship. Overall, the warmer the winter/spring temperature, the earlier the spring phenology. The precipitation has no significant impact.\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"up\" & thres == 0.5 & genus == \"Acer\")\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_AvgTemp_spring\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_LowTemp_spring\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_HighTemp_spring\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Sum_Sum_mm_spring\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal precipitation and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_AvgTemp_winter\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_LowTemp_winter\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_HighTemp_winter\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and spring phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Sum_Sum_mm_winter\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal precipitation and spring phenology\"\n)\n\n\n\n\n\n\n\nSpring average temp.\n\n\n\n\n\n\n\nSpring low temp.\n\n\n\n\n\n\n\nSpring high temp.\n\n\n\n\n\n\n\nSpring prcp. sum\n\n\n\n\n\n\n\n\n\nWinter average temp.\n\n\n\n\n\n\n\nWinter low temp.\n\n\n\n\n\n\n\nWinter high temp.\n\n\n\n\n\n\n\nWinter prcp. sum\n\n\n\n\n\n\nRelationship between seasonal climate and spring phenology\n\n\n\nOverall, the warmer the summer temperature, the later the fall phenology. Other relationship are not significant.\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"down\" & thres == 0.5 & genus == \"Acer\")\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_AvgTemp_summer\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_LowTemp_summer\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_HighTemp_summer\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Sum_Sum_mm_summer\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal precipitation and fall phenology\"\n)\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_AvgTemp_fall\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_LowTemp_fall\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Avg_HighTemp_fall\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = seasonal_temp_doy, \n  x_var = \"Sum_Sum_mm_fall\", \n  y_var = \"doy\",\n  title = \"Relationship between seasonal precipitation and fall phenology\"\n)\n\n\n\n\n\n\n\nSummer average temp.\n\n\n\n\n\n\n\nSummer low temp.\n\n\n\n\n\n\n\nSummer high temp.\n\n\n\n\n\n\n\nSummer prcp. sum\n\n\n\n\n\n\n\n\n\nFall average temp.\n\n\n\n\n\n\n\nFall low temp.\n\n\n\n\n\n\n\nFall high temp.\n\n\n\n\n\n\n\nFall prcp. sum\n\n\n\n\n\n\nRelationship between seasonal climate and fall phenology\n\n\n\nIn the mixed effect model, I treated the genus as a random effect.\nFor spring phenology\n\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"up\" & thres == 0.5)\n\nmodel &lt;- lmer(doy ~ Avg_AvgTemp_winter  + Sum_Sum_mm_winter  +\n                (1 | genus), \n              data = seasonal_temp_doy)\n\nfixed_effects &lt;- tidy(model, effects = \"fixed\")\n\nfixed_effects_table &lt;- fixed_effects %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (spring phenology ~ winter climate)\n\n\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\n(Intercept)\n126.657\n0.817\n154.935641\n0.0e+00\n\n\nAvg_AvgTemp_winter\n-2.125\n0.107\n-19.891618\n0.0e+00\n\n\nSum_Sum_mm_winter\n-0.009\n0.002\n-4.538583\n5.7e-06\n\n\n\n\n\n\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"down\" & thres == 0.5)\n\nmodel &lt;- lmer(doy ~ Avg_AvgTemp_summer  + Sum_Sum_mm_summer  +\n                (1 | genus), \n              data = seasonal_temp_doy)\n\nfixed_effects &lt;- tidy(model, effects = \"fixed\")\n\nfixed_effects_table &lt;- fixed_effects %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (fall phenology ~ summer climate)\n\n\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\n(Intercept)\n234.981\n7.622\n30.827566\n0.00000\n\n\nAvg_AvgTemp_summer\n2.345\n0.301\n7.799551\n0.00000\n\n\nSum_Sum_mm_summer\n0.005\n0.002\n2.876526\n0.00402\n\n\n\n\n\n\n\n3.2 Event period climate\n\n\n3.2.1 Create period temp/prcp variables\nThe seasonal climate variables use a fixed pre-season for every trees, not allowing heterogeneity within city. Also, the roughly divided season make it difficult to connect to phenology process, e.g. chilling and forcing accumulation. Therefore, some studies use varing preseason or optimal preseason.\nMeng et al., 2020, Wang et al., 2021: The preseason was defined as the period from November 1st in the previous year to the time of SOS in the current year. (most fixed)\nMeng et al., 2020, Yin et al., 2024: For each city, the period for which the absolute value of the partial correlation coefficient between SOS and Temp was highest was considered the optimal length of the preseason most relevant to SOS. (more flexible, cadidate time: 0 to 6 months prior to SOS, 5-day interval approach from January 1st to the average SOS date)\nMost flexible: The period variable is calculated for each site, year, and growing period. The period is defined as the period between the start of the phenology event and the day of year when the tree reaches the event threshold.\n\n\n\nDefinition of period\n\n\n\n\nCode\n# growing_temp_doy &lt;- points_in_buffer %&gt;%\n#   mutate(\n#     start_date = make_date(year) + days(start - 1), \n#     end_date = make_date(year) + days(doy - 1)\n#   ) %&gt;%\n#   rowwise() %&gt;%\n#   mutate(\n#     stats = list({\n#       current_index &lt;- cur_group_id()\n#       if (current_index %% 2000 == 0) {\n#         cat(\"Processing row:\", current_index, \"out of\", nrow(points_in_buffer), \"\\n\")\n#       }\n#       all_sites_temp %&gt;%\n#         filter(\n#           name == Site,\n#           Date &gt;= start_date & Date &lt;= end_date\n#         ) %&gt;%\n#         summarise(\n#           LowTemp_mean = mean(LowTemp, na.rm = TRUE),\n#           LowTemp_count = sum(!is.na(LowTemp)),\n#           AvgTemp_mean = mean(AvgTemp, na.rm = TRUE),\n#           AvgTemp_count = sum(!is.na(AvgTemp)),\n#           HighTemp_mean = mean(HighTemp, na.rm = TRUE),\n#           HighTemp_count = sum(!is.na(HighTemp)),\n#           Sum_mm_sum = sum(Sum_mm, na.rm = TRUE),\n#           Sum_mm_count = sum(!is.na(Sum_mm))\n#         )\n#     })\n#   ) %&gt;%\n#   unnest(stats)%&gt;%\n#   mutate(\n#     time_length = as.numeric(end_date - start_date, units = \"days\")\n#   )\n# \n# saveRDS(growing_temp_doy, \"~/phenology-urban/data/proc/nyc/growing_doy.rds\")\n\ngrowing_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/growing_doy.rds\")\nhead(growing_temp_doy)\n\n\n# A tibble: 6 × 24\n    ...1     id taxa         site  genus  year start   end direction thres   doy\n   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;\n1 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0      11\n2 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.1    35\n3 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.2    55\n4 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.3    75\n5 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.4    87\n6 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.5    96\n# ℹ 13 more variables: geometry &lt;chr&gt;, Site &lt;chr&gt;, start_date &lt;date&gt;,\n#   end_date &lt;date&gt;, LowTemp_mean &lt;dbl&gt;, LowTemp_count &lt;int&gt;,\n#   AvgTemp_mean &lt;dbl&gt;, AvgTemp_count &lt;int&gt;, HighTemp_mean &lt;dbl&gt;,\n#   HighTemp_count &lt;int&gt;, Sum_mm_sum &lt;dbl&gt;, Sum_mm_count &lt;int&gt;,\n#   time_length &lt;dbl&gt;\n\n\nThe period_desc is defined as the period between the day of year when the tree reaches the event threshold and the end of phenology event.\n\n\nCode\n# growing_temp_doy_desc &lt;- points_in_buffer %&gt;%\n#   mutate(\n#     start_date = make_date(year) + days(doy - 1), \n#     end_date = make_date(year) + days(end - 1)\n#   ) %&gt;%\n#   rowwise() %&gt;%\n#   mutate(\n#     stats = list({\n#       current_index &lt;- cur_group_id()\n#       if (current_index %% 2000 == 0) {\n#         cat(\"Processing row:\", current_index, \"out of\", nrow(points_in_buffer), \"\\n\")\n#       }\n#       all_sites_temp %&gt;%\n#         filter(\n#           name == Site,\n#           Date &gt;= start_date & Date &lt;= end_date\n#         ) %&gt;%\n#         summarise(\n#           LowTemp_mean = mean(LowTemp, na.rm = TRUE),\n#           LowTemp_count = sum(!is.na(LowTemp)),\n#           AvgTemp_mean = mean(AvgTemp, na.rm = TRUE),\n#           AvgTemp_count = sum(!is.na(AvgTemp)),\n#           HighTemp_mean = mean(HighTemp, na.rm = TRUE),\n#           HighTemp_count = sum(!is.na(HighTemp)),\n#           Sum_mm_sum = sum(Sum_mm, na.rm = TRUE),\n#           Sum_mm_count = sum(!is.na(Sum_mm))\n#         )\n#     })\n#   ) %&gt;%\n#   unnest(stats)%&gt;%\n#   mutate(\n#     time_length = as.numeric(end_date - start_date, units = \"days\")\n#   )\n# saveRDS(growing_temp_doy_desc, \"~/phenology-urban/data/proc/nyc/growing_doy_desc.rds\")\n\ngrowing_temp_doy_desc &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/growing_doy_desc.rds\")\nhead(growing_temp_doy_desc)\n\n\n# A tibble: 6 × 24\n    ...1     id taxa         site  genus  year start   end direction thres   doy\n   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;\n1 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0      11\n2 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.1    35\n3 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.2    55\n4 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.3    75\n5 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.4    87\n6 856615 187268 Carya glabra NY    Carya  2017    11   173 up          0.5    96\n# ℹ 13 more variables: geometry &lt;chr&gt;, Site &lt;chr&gt;, start_date &lt;date&gt;,\n#   end_date &lt;date&gt;, LowTemp_mean &lt;dbl&gt;, LowTemp_count &lt;int&gt;,\n#   AvgTemp_mean &lt;dbl&gt;, AvgTemp_count &lt;int&gt;, HighTemp_mean &lt;dbl&gt;,\n#   HighTemp_count &lt;int&gt;, Sum_mm_sum &lt;dbl&gt;, Sum_mm_count &lt;int&gt;,\n#   time_length &lt;dbl&gt;\n\n\n\n3.2.1 The current event period\nI tried period_length (start of the event to the day when tree reaches the threshold) as well as day of year. However, one issue is that a later doy or a longer green-up period already corresponds to warmer weather in the current period.\n\nShould I also explore the optimal pre-season (e.g. for each genus) within the city?\n\n\nCode\ngrowing_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/growing_doy.rds\") %&gt;%\n  filter(time_length != 0 & direction ==\"up\" & thres == 0.5 & genus == \"Acer\")\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"LowTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"HighTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\n\n\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"doy\",\n  title = \"Relationship between period precipitation and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"LowTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"HighTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between period temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_temp_doy, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"time_length\",\n  title = \"Relationship between period precipitation and spring phenology\"\n)\n\n\n\n\n\n\n\ndoy ~ average temp.\n\n\n\n\n\n\n\ndoy ~ low temp.\n\n\n\n\n\n\n\ndoy ~ high temp.\n\n\n\n\n\n\n\ndoy ~ prcp. sum\n\n\n\n\n\n\n\n\n\nperiod_length ~ average temp.\n\n\n\n\n\n\n\nperiod_length ~ low temp.\n\n\n\n\n\n\n\nperiod_length ~ high temp.\n\n\n\n\n\n\n\nperiod_length ~ prcp. sum\n\n\n\n\n\n\nRelationship between period climate and spring phenology\n\n\n\n\n\n3.2.2 The previous period\nThe climate condition in the previous period. Temp in dormancy -&gt; spring phenology. Temp in growing period -&gt; fall phenology. Compared to current period, the climate of the previous event is not structurally inherently linked to the timing of the subsequent event, and it can help connect to the underlying mechanisms.\n\n\nCode\ngrowing_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/growing_doy.rds\") %&gt;%\n  filter(thres == 0.5) %&gt;%\n  select(id, genus, year, direction, doy, time_length)\ngrowing_temp_doy_desc &lt;- readRDS(\"~/phenology-urban/data/proc/nyc/growing_doy_desc.rds\") %&gt;%\n  filter(thres == 0.5) %&gt;%\n  select(id, genus, year, direction, LowTemp_mean, LowTemp_count, AvgTemp_mean, AvgTemp_count, HighTemp_mean, HighTemp_count, Sum_mm_sum, Sum_mm_count) %&gt;%\n  mutate(\n   join_year = case_when(\n     direction == \"up\" ~ year,\n     direction == \"down\" ~ year + 1\n   ),\n   join_direction = case_when(\n     direction == \"up\" ~ \"down\",\n     direction == \"down\" ~ \"up\"\n   ) \n  ) %&gt;%\n  select(-year, -direction)\n\ngrowing_doy_join &lt;- growing_temp_doy %&gt;%\n  left_join(growing_temp_doy_desc, by = c(\"id\" = \"id\", \"genus\" = \"genus\", \"year\" = \"join_year\", \"direction\" = \"join_direction\"))\n\n\nFor spring phenology, the warmer the dormancy period, the earlier the spring phenology. The warmer the dormancy period，the slower the green-up pace.\n\nCode\ngrowing_doy_spring &lt;- growing_doy_join %&gt;%\n  filter(direction == \"up\") %&gt;%\n  filter(genus == \"Acer\")\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"HighTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"LowTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"doy\",\n  title = \"Relationship between growing precipitation and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"HighTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"LowTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and spring phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_spring, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing precipitation and spring phenology\"\n)\n\n\n\n\n\n\n\ndoy vs. average temp.\n\n\n\n\n\n\n\ndoy vs. high temp.\n\n\n\n\n\n\n\ndoy vs. low temp.\n\n\n\n\n\n\n\ndoy vs. prcp. sum\n\n\n\n\n\n\n\n\n\nperiod_length vs. average temp.\n\n\n\n\n\n\n\nperiod_length vs. high temp.\n\n\n\n\n\n\n\nperiod_length vs. low temp.\n\n\n\n\n\n\n\nperiod_length vs. prcp. sum\n\n\n\n\n\n\nRelationship between previous period climate and spring phenology\n\n\n\n\n\nCode\ngrowing_temp_doy &lt;- growing_doy_join %&gt;%\n  filter(direction == \"up\")\n\nmodel1 &lt;- lmer(doy ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects1 &lt;- tidy(model1, effects = \"fixed\")\n\nfixed_effects_table1 &lt;- fixed_effects1 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"doy\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nmodel2 &lt;- lmer(time_length ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects2 &lt;- tidy(model2, effects = \"fixed\")\n\nfixed_effects_table2 &lt;- fixed_effects2 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"time_length\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nfixed_effects_table &lt;- rbind(fixed_effects_table1, fixed_effects_table2) %&gt;%\n  select(y_variable, everything())\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Dependent variable\", \"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (spring phenology ~ pervious period climate)\n\n\n\n\n\n\n\n\n\n\nDependent variable\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\ndoy\n(Intercept)\n121.770\n0.614\n198.443867\n0e+00\n\n\ndoy\nAvgTemp_mean\n-0.921\n0.051\n-17.893020\n0e+00\n\n\ndoy\nSum_mm_sum\n0.005\n0.001\n5.329484\n1e-07\n\n\ntime_length\n(Intercept)\n76.979\n0.872\n88.306877\n0e+00\n\n\ntime_length\nAvgTemp_mean\n3.542\n0.102\n34.663215\n0e+00\n\n\ntime_length\nSum_mm_sum\n-0.041\n0.002\n-22.918665\n0e+00\n\n\n\n\n\nFor fall phenology, the warmer the growing period, the later the fall phenology. The warmer the growing period，the faster the green-down pace.\n\nCode\ngrowing_doy_fall &lt;- growing_doy_join %&gt;%\n  filter(direction == \"down\") %&gt;%\n  filter(genus == \"Acer\")\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"HighTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"LowTemp_mean\", \n  y_var = \"doy\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"doy\",\n  title = \"Relationship between growing precipitation and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"AvgTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"HighTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"LowTemp_mean\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing temperature and fall phenology\"\n)\n\ncreate_scatter_plot(\n  data = growing_doy_fall, \n  x_var = \"Sum_mm_sum\", \n  y_var = \"time_length\",\n  title = \"Relationship between growing precipitation and fall phenology\"\n)\n\n\n\n\n\n\n\ndoy vs. average temp.\n\n\n\n\n\n\n\ndoy vs. high temp.\n\n\n\n\n\n\n\ndoy vs. low temp.\n\n\n\n\n\n\n\ndoy vs. prcp. sum\n\n\n\n\n\n\n\n\n\nperiod_length vs. average temp.\n\n\n\n\n\n\n\nperiod_length vs. high temp.\n\n\n\n\n\n\n\nperiod_length vs. low temp.\n\n\n\n\n\n\n\nperiod_length vs. prcp. sum\n\n\n\n\n\n\nRelationship between previous period climate and spring phenology\n\n\n\n\n\nCode\ngrowing_temp_doy &lt;- growing_doy_join %&gt;%\n  filter(direction == \"down\")\n\nmodel1 &lt;- lmer(doy ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects1 &lt;- tidy(model1, effects = \"fixed\")\n\nfixed_effects_table1 &lt;- fixed_effects1 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"doy\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nmodel2 &lt;- lmer(time_length ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects2 &lt;- tidy(model2, effects = \"fixed\")\n\nfixed_effects_table2 &lt;- fixed_effects2 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"time_length\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nfixed_effects_table &lt;- rbind(fixed_effects_table1, fixed_effects_table2) %&gt;%\n  select(y_variable, everything())\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Dependent variable\", \"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (fall phenology ~ pervious period climate)\n\n\n\n\n\n\n\n\n\n\nDependent variable\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\ndoy\n(Intercept)\n256.795\n2.461\n104.335144\n0\n\n\ndoy\nAvgTemp_mean\n1.751\n0.101\n17.263620\n0\n\n\ndoy\nSum_mm_sum\n0.014\n0.002\n7.322015\n0\n\n\ntime_length\n(Intercept)\n220.670\n2.596\n85.020263\n0\n\n\ntime_length\nAvgTemp_mean\n-4.939\n0.116\n-42.521789\n0\n\n\ntime_length\nSum_mm_sum\n-0.061\n0.002\n-27.798872\n0"
  },
  {
    "objectID": "workflow_micro_NYC.html#conclusion-and-next-step",
    "href": "workflow_micro_NYC.html#conclusion-and-next-step",
    "title": "workflow_micro_NYC",
    "section": "4 Conclusion and next step",
    "text": "4 Conclusion and next step\n\nConclusion\n\nOptimal preseason length for phenology varies among genera.\nWithin the city, trees indeed respond to temperature variations, result in phenology variation\nAcross cities, some pattern noticed.\n\n\n\nNext steps:\n\nWhat can the urban phenology heterogenity be used for?\n\nThe preview of future warming: compared with the sensitivity in natural environment.\nFine-scale urban phenology: compared with other urban phenology sensitivity detected at coarser scale.\n\nScale up\n\nCities\nGenera\n\nMarginal prediction\n\nPrediction results, show their spatial variance\nClimate at weather points / interpolated climate\n\nSensitivity\n\nHow about use buffer size\nUse the Daymet climate infomation directly"
  },
  {
    "objectID": "test.html",
    "href": "test.html",
    "title": "Hello, Quarto",
    "section": "",
    "text": "Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see https://quarto.org."
  },
  {
    "objectID": "test.html#meet-quarto",
    "href": "test.html#meet-quarto",
    "title": "Hello, Quarto",
    "section": "",
    "text": "Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see https://quarto.org."
  },
  {
    "objectID": "test.html#meet-the-penguins",
    "href": "test.html#meet-the-penguins",
    "title": "Hello, Quarto",
    "section": "Meet the penguins",
    "text": "Meet the penguins\n\nThe penguins data from the palmerpenguins package contains size measurements for 344 penguins from three species observed on three islands in the Palmer Archipelago, Antarctica.\nThe plot below shows the relationship between flipper and bill lengths of these penguins.\n\n\nCode\nggplot(penguins, \n       aes(x = flipper_length_mm, y = bill_length_mm)) +\n  geom_point(aes(color = species, shape = species)) +\n  scale_color_manual(values = c(\"darkorange\",\"purple\",\"cyan4\")) +\n  labs(\n    title = \"Flipper and bill length\",\n    subtitle = \"Dimensions for penguins at Palmer Station LTER\",\n    x = \"Flipper length (mm)\", y = \"Bill length (mm)\",\n    color = \"Penguin species\", shape = \"Penguin species\"\n  ) +\n  theme_minimal()\n\n\n\n\n\n\n\n\n\nAnother code\n\n\nCode\nggplot(penguins, \n       aes(x = flipper_length_mm, y = bill_length_mm)) +\n  geom_point(aes(color = species, shape = species)) +\n  scale_color_manual(values = c(\"yellow3\",\"purple\",\"cyan4\")) +\n  labs(\n    title = \"Flipper and bill length\",\n    subtitle = \"Dimensions for penguins at Palmer Station LTER\",\n    x = \"Flipper length (mm)\", y = \"Bill length (mm)\",\n    color = \"Penguin species\", shape = \"Penguin species\"\n  ) +\n  theme_minimal()"
  },
  {
    "objectID": "workflow_micro_DT.html",
    "href": "workflow_micro_DT.html",
    "title": "workflow_micro_DT",
    "section": "",
    "text": "Code\n################ For phenology data ################\n\nmetadata &lt;- read_csv(\"~/lab-data/datasets/vegetation/PS/urban/metadata.csv\") %&gt;%\n  filter(site == \"DT\")\n\nfile_list &lt;- list.files(path = \"~/lab-data/datasets/vegetation/PS/urban/doy/\", pattern = \"^doy_DT_.*\\\\.rds$\", full.names = TRUE)\ndata_list &lt;- file_list %&gt;%\n  map(~ readRDS(.x))\nDT_now &lt;- bind_rows(data_list)\n\ntree_location &lt;- metadata %&gt;%\n  mutate(genus = str_extract(taxa, \"^[^ ]+\")) %&gt;%\n  left_join(DT_now, by = \"id\") %&gt;%\n  filter(!is.na(doy)) %&gt;%\n  st_as_sf(coords = c(\"lon\", \"lat\"), crs = 4326)\n\nwu_location &lt;- read_csv(\"~/urban-cooling/data/raw/WU/DT/location.csv\") %&gt;%\n  st_as_sf(coords = c(\"Lon\", \"Lat\"), crs = 4326)\nwu_buffer &lt;- st_buffer(wu_location, dist = 500)\n\nintersects &lt;- st_intersects(tree_location, wu_buffer)\npoints_in_buffer &lt;- tree_location[lengths(intersects) &gt; 0, ]\npoints_in_buffer &lt;- tree_location %&gt;%\n  mutate(buffer_id = sapply(intersects, function(x) if (length(x) &gt; 0) x[1] else NA)) %&gt;% \n  left_join(wu_buffer %&gt;% st_drop_geometry() %&gt;% mutate(buffer_id = row_number()), by = \"buffer_id\") %&gt;%\n  filter(!is.na(buffer_id)) %&gt;%\n  select(-buffer_id)\n\n\n\n\nCode\n# nyboundary &lt;- st_read(\"~/urban-cooling/data/raw/NYC/boundary/nybb_dissolved.shp\") %&gt;%\n#   st_transform(4326)\n# \nggplot() +\n  # geom_sf(data = nyboundary, fill = \"grey\") +\n  geom_sf(data = wu_location, color = \"blue\", size = 1) +\n  geom_sf(data = points_in_buffer, color = \"red\", size = 0.05) +\n  theme_minimal()\n\n\n\n\n\nLocation of WU sites and trees\n\n\n\n\nCode\n# write_csv(points_in_buffer,\"~/phenology-urban/data/proc/DT/tree_WU_500_buffer_PS.csv\")\npoints_in_buffer &lt;- read_csv(\"~/phenology-urban/data/proc/DT/tree_WU_500_buffer_PS.csv\")"
  },
  {
    "objectID": "workflow_micro_DT.html#insert-tree-id-base-on-wu-data",
    "href": "workflow_micro_DT.html#insert-tree-id-base-on-wu-data",
    "title": "workflow_micro_DT",
    "section": "",
    "text": "Code\n################ For phenology data ################\n\nmetadata &lt;- read_csv(\"~/lab-data/datasets/vegetation/PS/urban/metadata.csv\") %&gt;%\n  filter(site == \"DT\")\n\nfile_list &lt;- list.files(path = \"~/lab-data/datasets/vegetation/PS/urban/doy/\", pattern = \"^doy_DT_.*\\\\.rds$\", full.names = TRUE)\ndata_list &lt;- file_list %&gt;%\n  map(~ readRDS(.x))\nDT_now &lt;- bind_rows(data_list)\n\ntree_location &lt;- metadata %&gt;%\n  mutate(genus = str_extract(taxa, \"^[^ ]+\")) %&gt;%\n  left_join(DT_now, by = \"id\") %&gt;%\n  filter(!is.na(doy)) %&gt;%\n  st_as_sf(coords = c(\"lon\", \"lat\"), crs = 4326)\n\nwu_location &lt;- read_csv(\"~/urban-cooling/data/raw/WU/DT/location.csv\") %&gt;%\n  st_as_sf(coords = c(\"Lon\", \"Lat\"), crs = 4326)\nwu_buffer &lt;- st_buffer(wu_location, dist = 500)\n\nintersects &lt;- st_intersects(tree_location, wu_buffer)\npoints_in_buffer &lt;- tree_location[lengths(intersects) &gt; 0, ]\npoints_in_buffer &lt;- tree_location %&gt;%\n  mutate(buffer_id = sapply(intersects, function(x) if (length(x) &gt; 0) x[1] else NA)) %&gt;% \n  left_join(wu_buffer %&gt;% st_drop_geometry() %&gt;% mutate(buffer_id = row_number()), by = \"buffer_id\") %&gt;%\n  filter(!is.na(buffer_id)) %&gt;%\n  select(-buffer_id)\n\n\n\n\nCode\n# nyboundary &lt;- st_read(\"~/urban-cooling/data/raw/NYC/boundary/nybb_dissolved.shp\") %&gt;%\n#   st_transform(4326)\n# \nggplot() +\n  # geom_sf(data = nyboundary, fill = \"grey\") +\n  geom_sf(data = wu_location, color = \"blue\", size = 1) +\n  geom_sf(data = points_in_buffer, color = \"red\", size = 0.05) +\n  theme_minimal()\n\n\n\n\n\nLocation of WU sites and trees\n\n\n\n\nCode\n# write_csv(points_in_buffer,\"~/phenology-urban/data/proc/DT/tree_WU_500_buffer_PS.csv\")\npoints_in_buffer &lt;- read_csv(\"~/phenology-urban/data/proc/DT/tree_WU_500_buffer_PS.csv\")"
  },
  {
    "objectID": "workflow_micro_DT.html#creat-the-climate-variable",
    "href": "workflow_micro_DT.html#creat-the-climate-variable",
    "title": "workflow_micro_DT",
    "section": "2. Creat the climate variable",
    "text": "2. Creat the climate variable\n\n2.1 Read and clean the WU data (based on GHCNd)\n\n\nCode\nsource(\"~/phenology-urban/script/read_clean_WU.R\")\n# all_sites_temp &lt;- read_clean_WU(city = \"DT\", run_checks = TRUE)\n# saveRDS(all_sites_temp, \"~/urban-cooling/data/raw/WU/DT/DT_wu.rds\")\nall_sites_temp &lt;- readRDS(\"~/urban-cooling/data/raw/WU/DT/DT_wu.rds\") %&gt;%\n  select(c(Date, HighTemp, AvgTemp, LowTemp, Sum_mm, name))\n\n\n\n\n2.2 Create seasonal temp/prcp variables"
  },
  {
    "objectID": "workflow_micro_DT.html#explore-the-relationship-between-temperature-and-phenology",
    "href": "workflow_micro_DT.html#explore-the-relationship-between-temperature-and-phenology",
    "title": "workflow_micro_DT",
    "section": "3 Explore the relationship between temperature and phenology",
    "text": "3 Explore the relationship between temperature and phenology\n\n3.1 Seasonal climate variables\nOverall, the warmer the summer temperature, the later the fall phenology. Other relationship are not significant.\nIn the mixed effect model, I treated the genus as a random effect.\nFor spring phenology\n\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/DT/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"up\" & thres == 0.5)\n\nmodel &lt;- lmer(doy ~ Avg_AvgTemp_winter  + Sum_Sum_mm_winter  +\n                (1 | genus), \n              data = seasonal_temp_doy)\n\nfixed_effects &lt;- tidy(model, effects = \"fixed\")\n\nfixed_effects_table &lt;- fixed_effects %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (spring phenology ~ winter climate)\n\n\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\n(Intercept)\n121.641\n1.250\n97.274997\n0.000\n\n\nAvg_AvgTemp_winter\n-1.821\n0.202\n-9.024978\n0.000\n\n\nSum_Sum_mm_winter\n0.005\n0.004\n1.232385\n0.218\n\n\n\n\n\n\n\nCode\nseasonal_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/DT/seasonal_doy.rds\") %&gt;%\n  mutate(time_length = doy - start) %&gt;%\n  filter(direction ==\"down\" & thres == 0.5)\n\nmodel &lt;- lmer(doy ~ Avg_AvgTemp_summer  + Sum_Sum_mm_summer  +\n                (1 | genus), \n              data = seasonal_temp_doy)\n\nfixed_effects &lt;- tidy(model, effects = \"fixed\")\n\nfixed_effects_table &lt;- fixed_effects %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (fall phenology ~ summer climate)\n\n\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\n(Intercept)\n198.036\n6.579\n30.1030020\n0.000\n\n\nAvg_AvgTemp_summer\n4.237\n0.280\n15.1484264\n0.000\n\n\nSum_Sum_mm_summer\n0.000\n0.002\n0.1092368\n0.913\n\n\n\n\n\n\n\n3.2 Event period climate\n\n\n3.2.1 Create period temp/prcp variables\n\n\n\n\n\n\n\nCode\n# growing_temp_doy &lt;- points_in_buffer %&gt;%\n#   mutate(\n#     start_date = make_date(year) + days(start - 1),\n#     end_date = make_date(year) + days(doy - 1)\n#   ) %&gt;%\n#   rowwise() %&gt;%\n#   mutate(\n#     stats = list({\n#       current_index &lt;- cur_group_id()\n#       if (current_index %% 2000 == 0) {\n#         cat(\"Processing row:\", current_index, \"out of\", nrow(points_in_buffer), \"\\n\")\n#       }\n#       all_sites_temp %&gt;%\n#         filter(\n#           name == Site,\n#           Date &gt;= start_date & Date &lt;= end_date\n#         ) %&gt;%\n#         summarise(\n#           LowTemp_mean = mean(LowTemp, na.rm = TRUE),\n#           LowTemp_count = sum(!is.na(LowTemp)),\n#           AvgTemp_mean = mean(AvgTemp, na.rm = TRUE),\n#           AvgTemp_count = sum(!is.na(AvgTemp)),\n#           HighTemp_mean = mean(HighTemp, na.rm = TRUE),\n#           HighTemp_count = sum(!is.na(HighTemp)),\n#           Sum_mm_sum = sum(Sum_mm, na.rm = TRUE),\n#           Sum_mm_count = sum(!is.na(Sum_mm))\n#         )\n#     })\n#   ) %&gt;%\n#   unnest(stats)%&gt;%\n#   mutate(\n#     time_length = as.numeric(end_date - start_date, units = \"days\")\n#   )\n\n# saveRDS(growing_temp_doy, \"~/phenology-urban/data/proc/DT/growing_doy.rds\")\n\ngrowing_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/DT/growing_doy.rds\")\nhead(growing_temp_doy)\n\n\n# A tibble: 6 × 24\n    ...1     id taxa         site  genus  year start   end direction thres   doy\n   &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;     &lt;dbl&gt; &lt;dbl&gt;\n1 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0      67\n2 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0.1    98\n3 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0.2   108\n4 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0.3   115\n5 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0.4   122\n6 292612 242783 Betula popu… DT    Betu…  2017    67   199 up          0.5   128\n# ℹ 13 more variables: geometry &lt;chr&gt;, Site &lt;chr&gt;, start_date &lt;date&gt;,\n#   end_date &lt;date&gt;, LowTemp_mean &lt;dbl&gt;, LowTemp_count &lt;int&gt;,\n#   AvgTemp_mean &lt;dbl&gt;, AvgTemp_count &lt;int&gt;, HighTemp_mean &lt;dbl&gt;,\n#   HighTemp_count &lt;int&gt;, Sum_mm_sum &lt;dbl&gt;, Sum_mm_count &lt;int&gt;,\n#   time_length &lt;dbl&gt;\n\n\n\n3.2.1 The current event period\n\n\n\n\nCode\ngrowing_temp_doy &lt;- readRDS(\"~/phenology-urban/data/proc/DT/growing_doy.rds\") %&gt;%\n  filter(time_length != 0 & direction ==\"up\" & thres == 0.5)\n\nmodel1 &lt;- lmer(doy ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects1 &lt;- tidy(model1, effects = \"fixed\")\n\nfixed_effects_table1 &lt;- fixed_effects1 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"doy\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nmodel2 &lt;- lmer(time_length ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects2 &lt;- tidy(model2, effects = \"fixed\")\n\nfixed_effects_table2 &lt;- fixed_effects2 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"time_length\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nfixed_effects_table &lt;- rbind(fixed_effects_table1, fixed_effects_table2) %&gt;%\n  select(y_variable, everything())\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Dependent variable\", \"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (spring phenology ~ current period climate)\n\n\n\n\n\n\n\n\n\n\nDependent variable\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\ndoy\n(Intercept)\n117.208\n1.173\n99.906130\n0.000\n\n\ndoy\nAvgTemp_mean\n1.098\n0.111\n9.891255\n0.000\n\n\ndoy\nSum_mm_sum\n0.003\n0.002\n1.353886\n0.176\n\n\ntime_length\n(Intercept)\n104.872\n1.771\n59.230125\n0.000\n\n\ntime_length\nAvgTemp_mean\n-6.092\n0.193\n-31.636560\n0.000\n\n\ntime_length\nSum_mm_sum\n0.034\n0.004\n9.420579\n0.000\n\n\n\n\n\n\n\n3.2.2 The previous period\n\nFor spring phenology, the warmer the dormancy period, the earlier the spring phenology. The warmer the dormancy period，the slower the green-up pace.\n\n\nCode\ngrowing_temp_doy &lt;- growing_doy_join %&gt;%\n  filter(direction == \"up\")\n\nmodel1 &lt;- lmer(doy ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects1 &lt;- tidy(model1, effects = \"fixed\")\n\nfixed_effects_table1 &lt;- fixed_effects1 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"doy\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nmodel2 &lt;- lmer(time_length ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects2 &lt;- tidy(model2, effects = \"fixed\")\n\nfixed_effects_table2 &lt;- fixed_effects2 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"time_length\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nfixed_effects_table &lt;- rbind(fixed_effects_table1, fixed_effects_table2) %&gt;%\n  select(y_variable, everything())\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Dependent variable\", \"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (spring phenology ~ pervious period climate)\n\n\n\n\n\n\n\n\n\n\nDependent variable\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\ndoy\n(Intercept)\n122.700\n1.108\n110.7095997\n0.000000\n\n\ndoy\nAvgTemp_mean\n-0.231\n0.068\n-3.3812453\n0.000722\n\n\ndoy\nSum_mm_sum\n0.007\n0.002\n3.4260978\n0.000612\n\n\ntime_length\n(Intercept)\n78.762\n1.392\n56.5763854\n0.000000\n\n\ntime_length\nAvgTemp_mean\n0.546\n0.163\n3.3449871\n0.000823\n\n\ntime_length\nSum_mm_sum\n-0.002\n0.005\n-0.4416791\n0.659000\n\n\n\n\n\nFor fall phenology, the warmer the growing period, the later the fall phenology. The warmer the growing period，the faster the green-down pace.\n\n\nCode\ngrowing_temp_doy &lt;- growing_doy_join %&gt;%\n  filter(direction == \"down\")\n\nmodel1 &lt;- lmer(doy ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects1 &lt;- tidy(model1, effects = \"fixed\")\n\nfixed_effects_table1 &lt;- fixed_effects1 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"doy\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nmodel2 &lt;- lmer(time_length ~ AvgTemp_mean  + Sum_mm_sum  +\n                (1 | genus), \n              data = growing_temp_doy)\n\nfixed_effects2 &lt;- tidy(model2, effects = \"fixed\")\n\nfixed_effects_table2 &lt;- fixed_effects2 %&gt;%\n  select(term, estimate, std.error, statistic) %&gt;%\n  mutate(\n    y_variable = \"time_length\",\n    estimate = round(estimate, 3),\n    std.error = round(std.error, 3),\n    p.value = signif(2 * (1 - pnorm(abs(statistic))), 3)\n  )\n\nfixed_effects_table &lt;- rbind(fixed_effects_table1, fixed_effects_table2) %&gt;%\n  select(y_variable, everything())\n\nkable(fixed_effects_table, format = \"markdown\", col.names = c(\"Dependent variable\", \"Term\", \"Estimate\", \"Std. Error\", \"t value\", \"P-Value\"))\n\n\n\nCoefficents for model (fall phenology ~ pervious period climate)\n\n\n\n\n\n\n\n\n\n\nDependent variable\nTerm\nEstimate\nStd. Error\nt value\nP-Value\n\n\n\n\ndoy\n(Intercept)\n250.916\n3.115\n80.560054\n0.00e+00\n\n\ndoy\nAvgTemp_mean\n2.085\n0.144\n14.483046\n0.00e+00\n\n\ndoy\nSum_mm_sum\n0.006\n0.002\n2.867466\n4.14e-03\n\n\ntime_length\n(Intercept)\n133.898\n5.265\n25.433816\n0.00e+00\n\n\ntime_length\nAvgTemp_mean\n-1.120\n0.250\n-4.483999\n7.30e-06\n\n\ntime_length\nSum_mm_sum\n-0.054\n0.004\n-15.352205\n0.00e+00"
  },
  {
    "objectID": "workflow_micro_DT.html#conclusion-and-next-step",
    "href": "workflow_micro_DT.html#conclusion-and-next-step",
    "title": "workflow_micro_DT",
    "section": "4 Conclusion and next step",
    "text": "4 Conclusion and next step\nWithin the city, the relationship between phenology and temperature is still significant.\n\nThe warmer the preseason temperature, the earlier the spring phenology.\nThe warmer the preseason temperature, the later the fall phenology.\nThe warmer the dormancy period，the slower the green-up pace. The warmer the growing period，the faster the green-down pace. (consistent results in lmer model)\nThe precipitation has no significant impact.\n\nNext steps:\n\nFind the optimal preseason? Related to process-based model\nEnlarge the samples in NYC.\nAdd the urban structure variables.\nEnlarge the city samples (downloading WU in other 6 cities).\n\nJuwon conducted research on the impact of climate change on urban trees, focusing specifically on changes in the start of the growing season in New York. He and Prof. Seto plan to expand this approach across the U.S., and he looks forward to potential collaborations."
  },
  {
    "objectID": "workflow_micro_NYC.html#raw-data",
    "href": "workflow_micro_NYC.html#raw-data",
    "title": "workflow_micro_NYC",
    "section": "1 Raw data",
    "text": "1 Raw data\n\n1.1 Insert tree id base on WU data\nFor exploratory analysis, I used the street tree in 4 cities, with the phenology information established by Yiluan. These trees are part of the whole inventory, covering 14 genera and being sampled. I select the trees which are within 500 m buffer around the weather underground sites (see Figure 1).\n\n\nCode\ncities = c(\"NY\", \"HT\", \"DV\", \"ST\")\nplots = list()\n\nfor (city in cities){\n  points_in_buffer &lt;- read_csv(paste0(\"~/phenology-urban/data/proc/urban/\",city,\"/tree_WU_500_buffer_PS.csv\"), show_col_types = FALSE)\n  points_in_buffer_sf &lt;- points_in_buffer %&gt;%\n    st_as_sf(coords = c(\"lon\", \"lat\"), crs = 4326)\n  # us_boundary &lt;- st_read(\"~/urban-niche/data/raw/CONUS/boundary/us_boundarydissolve.shp\") %&gt;%\n  #     st_transform(4326)\n  \n  boundary &lt;- switch(\n    city,\n    \"NY\" = st_read(\"~/urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp\",quiet = TRUE) %&gt;%\n      st_transform(4326),\n    \"DT\" = st_read(\"~/urban-cooling/data/raw/WU/DT/City_of_Detroit_Boundary/City_of_Detroit_Boundary.shp\",quiet = TRUE) %&gt;%\n      st_transform(4326),\n    \"ST\" = st_read(\"~/urban-cooling/data/raw/WU/ST/seattle_boundary/CityUGA.shp\",quiet = TRUE) %&gt;%\n      st_transform(4326) %&gt;%\n      filter(CITY_NM == \"Seattle\"),\n    \"HT\" = st_read(\"~/urban-cooling/data/raw/WU/HT/HGAC_City_Boundaries/HGAC_City_Boundaries.shp\",quiet = TRUE) %&gt;%\n      filter(NAME == \"Houston\") %&gt;%\n      st_transform(4326),\n    \"TP\" = st_read(\"~/urban-cooling/data/raw/WU/TP/Municipal_Boundary/Municipal_Boundary.shp\") %&gt;%\n      st_transform(4326) %&gt;%\n      filter(NAME == \"Tampa\"),\n    \"DV\" = st_read(\"~/urban-cooling/data/raw/WU/DV/DRCOG_Municipalities/DRCOG_Municipalities.shp\",quiet = TRUE) %&gt;%\n      filter(city == \"Denver\") %&gt;%\n      st_transform(4326),\n    \"AT\" = st_read(\"~/urban-cooling/data/raw/WU/AT/TxDOT_City_Boundaries/Cities.shp\",quiet = TRUE) %&gt;%\n      filter(CITY_NM == \"Austin\") %&gt;%\n      st_transform(4326),\n    stop(\"Invalid city abbreviation.\")\n  )\n  \n  wu_location &lt;- read_csv(paste0(\"~/urban-cooling/data/raw/WU/\", city, \"/location.csv\"), show_col_types = FALSE) %&gt;%\n    st_as_sf(coords = c(\"Lon\", \"Lat\"), crs = 4326)\n  \n  p = ggplot() +\n    geom_sf(data = boundary, fill = \"grey90\") +\n    # geom_sf(data = us_boundary, color = \"blue\", size = 1) +\n    geom_sf(data = wu_location, color = \"blue\", size = 0.5) +\n    geom_point(data = points_in_buffer, aes(x = lon, y = lat), color = \"red\",size = 0.01, alpha = 0.01) +\n    labs(title = city) +\n    theme_minimal()+\n    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1))\n  plots[[city]] = p\n}\n\n\ncombined_plot &lt;- wrap_plots(plots, ncol = 2)\ncombined_plot\n\ncity = \"NY\"\n\n\n\n\n\n\n\n\nFigure 1: Location of WU sites and trees\n\n\n\n\n\n\n\n1.2 Read and clean the WU data (based on GHCNd)\nThere are 4 raw daily variables selected, i.e. AvgTemp, HighTemp, LowTemp and Precipitation_sum (Sum_mm). I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily GHCNd.\n\n\nCode\n# all_sites_temp &lt;- read_clean_WU(city = \"ST\", run_checks = TRUE)\nall_sites_temp &lt;- readRDS(paste0(\"~/urban-cooling/data/raw/WU/\",city,\"/\",city,\"_wu.rds\")) %&gt;%\n  dplyr::select(c(Date, HighTemp, AvgTemp, LowTemp, Sum_mm, name))\n\n\n\n\n1.3 Shortwave data from Daymet\nTo control for the influence of other variables on phenology, I also incorporated shortwave radiation data derived from the Daymet daily dataset with a 1 km resolution. Shortwave radiation was extracted for the specific locations of the trees.\n\n\nCode\n# download\nsrad_daily &lt;- readRDS(paste0(\"~/phenology-urban/data/raw/\",city,\"/Daymet/daily2016-2024/srad_daily_2016-2023.rds\")) %&gt;%\n  select(id, value, date)"
  },
  {
    "objectID": "workflow_micro_NYC.html#find-the-optimal-preseason",
    "href": "workflow_micro_NYC.html#find-the-optimal-preseason",
    "title": "workflow_micro_NYC",
    "section": "2 Find the optimal preseason",
    "text": "2 Find the optimal preseason\nThe seasonal climate variables use a fixed pre-season for every trees, not allowing heterogeneity within city. Also, the roughly divided season make it difficult to connect to phenology process, e.g. chilling and forcing accumulation. Therefore, some studies use varing preseason or optimal preseason.\nMeng et al., 2020, Wang et al., 2021: The preseason was defined as the period from November 1st in the previous year to the time of SOS in the current year. (most fixed)\nMeng et al., 2020, Yin et al., 2024: For each city, the period for which the absolute value of the partial correlation coefficient between SOS and Temp was highest was considered the optimal length of the preseason most relevant to SOS. (more flexible, cadidate time: 0 to 6 months prior to SOS, 5-day interval approach from January 1st to the average SOS date)\nHere, based on the variable (phenology metric: SOS, EOS, green-up pace, green-down pace, temp. metric: t_avg, t_min, t_max), I find the optimal preseason at genus-city level (ignore the year for now due to sample size). The period for which the absolute value of the partial correlation coefficient between phenology and temp. metric is highest is considered the optimal length of the preseason most relevant to the certain phenology metric.\n\n\nCode\ncalculate_partial_correlation &lt;- function(insert_data, direction, thres, genus, pre_lengths, \n                                          phe_variable, temp_variable) {\n  subset_tree_pcor &lt;- insert_data %&gt;%\n    filter(direction == !!direction & thres == !!thres & genus == !!genus)\n  results &lt;- lapply(pre_lengths, function(pre_length) {\n    cat(\"Preseason length (days):\", pre_length, \"\\n\")\n    preseason_var &lt;- subset_tree_pcor %&gt;%\n      mutate(\n        start_date = make_date(year) + days(round(mean(doy)) - 1) - days(pre_length),\n        end_date = make_date(year) + days(round(mean(doy)) - 1)\n      )\n\n    temp_stats &lt;- all_sites_temp %&gt;%\n      # filter(name %in% preseason_var$Site) %&gt;%\n      inner_join(preseason_var, by = c(\"name\" = \"Site\")) %&gt;%\n      filter(Date &gt;= start_date & Date &lt;= end_date) %&gt;%\n      group_by(id,year) %&gt;%\n      summarise(\n        LowTemp_mean = mean(LowTemp, na.rm = TRUE),\n        LowTemp_count = sum(!is.na(LowTemp)),\n        AvgTemp_mean = mean(AvgTemp, na.rm = TRUE),\n        AvgTemp_count = sum(!is.na(AvgTemp)),\n        HighTemp_mean = mean(HighTemp, na.rm = TRUE),\n        HighTemp_count = sum(!is.na(HighTemp)),\n        Sum_mm_sum = sum(Sum_mm, na.rm = TRUE),\n        Sum_mm_count = sum(!is.na(Sum_mm)),\n        .groups = \"drop\"\n      )\n  \n    srad_stats &lt;- srad_daily %&gt;%\n      # filter(id %in% preseason_var$id) %&gt;%\n      inner_join(preseason_var, by = \"id\") %&gt;%\n      filter(date &gt;= start_date & date &lt;= end_date) %&gt;%\n      group_by(id,year) %&gt;%\n      summarise(\n        srad_mean = mean(value, na.rm = TRUE),\n        srad_count = sum(!is.na(value)),\n        .groups = \"drop\"\n      )\n    \n    preseason_var &lt;- preseason_var %&gt;%\n      left_join(temp_stats, by = c(\"id\",\"year\")) %&gt;%\n      left_join(srad_stats, by = c(\"id\",\"year\"))\n    \n    \n    if (temp_variable %in% c(\"LowTemp_mean\", \"HighTemp_mean\")){\n      selected_data &lt;- preseason_var %&gt;%\n      dplyr::select(\n        {{ phe_variable }}, LowTemp_mean, HighTemp_mean, Sum_mm_sum,  srad_mean\n      ) %&gt;%\n      na.omit()\n    } else {\n      selected_data &lt;- preseason_var %&gt;%\n      dplyr::select(\n        {{ phe_variable }}, AvgTemp_mean,Sum_mm_sum, srad_mean\n      ) %&gt;%\n      na.omit()\n    }\n    partial_corr &lt;- pcor(selected_data)\n    \n    correlation &lt;- partial_corr$estimate[\n        rownames(partial_corr$estimate) == phe_variable, \n        colnames(partial_corr$estimate) == temp_variable\n      ]\n    pvalue &lt;- partial_corr$p.value[\n        rownames(partial_corr$p.value) == phe_variable, \n        colnames(partial_corr$p.value) == temp_variable\n      ]\n  list(correlation = correlation, pvalue = pvalue, preseason_var = preseason_var)\n  })\n  \n  correlations &lt;- sapply(results, function(x) (x$correlation))\n  pvalues &lt;- sapply(results, function(x) (x$pvalue))\n  \n  \n  max_idx &lt;- which.max(abs(correlations))\n  \n  return(list(\n    optimal_pre_length = pre_lengths[max_idx],\n    pre_length_candidate  = pre_lengths,\n    pre_length_trend = correlations,\n    pvalue_trend = pvalues,\n    partial_correlation = results[[max_idx]]$correlation,\n    partial_corr_pvalue = results[[max_idx]]$pvalue,\n    preseason_var = results[[max_idx]]$preseason_var\n  ))\n}\n\n\npre_lengths &lt;- seq(5, 180, by = 5)\nall_genus &lt;- unique(points_in_buffer$genus)\ntemp_variable = \"AvgTemp_mean\"\n\n\n\n2.1 Spring phenology\n\nSOS date\nDefined as the day of year when individual tree growing season EVI curves first cross the green-up 50% threshold.\n\n\nCode\ndirection &lt;- \"up\"\nthres &lt;- 0.5\nphe_variable = \"doy\"\ninsert_data = points_in_buffer\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nspring_date_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nspring_date_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nspring_date_combined_results &lt;- do.call(rbind, lapply(spring_date_combined_results, as.data.frame))\n\n\n\n\nGreen-up Pace\nDefined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-up 20% threshold to the 80% threshold.\n\n\nCode\ndiff &lt;- points_in_buffer %&gt;%\n  group_by(year, id, direction) %&gt;%\n  filter(thres %in% c(0.2, 0.8)) %&gt;% \n  summarise(\n    doy_diff = abs(diff(doy[order(thres)])),\n    .groups = \"drop\"\n  )\n\npoints_with_diff &lt;- points_in_buffer %&gt;%\n  left_join(diff, by = c(\"year\", \"id\", \"direction\"))\n\ndirection &lt;- \"up\"\nthres &lt;- 0.2              # change to 0.5?\nphe_variable = \"doy_diff\"\ninsert_data = points_with_diff\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nspring_pace_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nspring_pace_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nspring_pace_combined_results &lt;- do.call(rbind, lapply(spring_pace_combined_results, as.data.frame))\n\n\n\n\n\n2.2 Fall phenology\n\nEOS date\nDefined as the day of year when individual tree growing season EVI curves first cross the green-down 50% threshold.\n\nCode\ndirection &lt;- \"down\"\nthres &lt;- 0.5\nphe_variable = \"doy\"\ninsert_data = points_in_buffer\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n \n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nfall_date_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nfall_date_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nfall_date_combined_results &lt;- do.call(rbind, lapply(fall_date_combined_results, as.data.frame))\n\n\n\n\n\n\nGreen-down Pace\nDefined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-down 20% threshold to the 80% threshold.\n\n\nCode\ndirection &lt;- \"down\"\nthres &lt;- 0.2\nphe_variable = \"doy_diff\"\ninsert_data = points_with_diff\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n \n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nfall_pace_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nfall_pace_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nfall_pace_combined_results &lt;- do.call(rbind, lapply(fall_pace_combined_results, as.data.frame))\n\n\n\n\n\n2.3 Optimal preseason length calculated by Tempavg\nFigure 2 displays the distribution of optimal preseason length and partial correlation coefficient calculated by Tempavg for SOS, Greenup pace, EOS and Greenup pace, respectively.\nAs for SOS, all genera have negetive partial correlation coefficients, which means the higher preseason average temperature, the earlier start of season. As for Greenup pace, most genera (except Carya, Celtis) have negetive partial correlation coefficients, which means the higher preseason average temperature, the faster green up pace. The preseason length varies significantly among genera.\nAs for EOS, most genera (except Populus, Platanus) have positive partial correlation coefficients, which means the higher preseason average temperature, the later end of season. As for Greenup pace, there is variation in impact direction among genera. The preseason length also varies significantly among genera.\n\nCode\ntavg_allyear_pcorr &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\",city,\"/tavg_allyear_pcorr.rds\")) %&gt;%\n  mutate(\n    # Create a flag for optimal_pre_length\n    is_optimal = ifelse(pre_length_candidate == optimal_pre_length, TRUE, FALSE),\n    # Create a flag for significant pvalue\n    is_significant = ifelse(pvalue_trend &lt; 0.05, TRUE, FALSE),\n    # Adjust transparency\n    alpha = ifelse(is_optimal, 1, 0.2),\n    shape = ifelse(is_significant, 21, 1),\n    size = ifelse(is_optimal, 4, 1.2)\n  ) %&gt;%\n  mutate(shape = factor(shape, levels = c(21, 1)),\n         size = factor(size, levels = c(1.2, 4)))\n  \n\n# Create the plot\nsos_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"SOS\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, shape = shape, size = size)) +  # Add points with alpha and fill\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Start of season\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n  \ngreenup_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"green-up pace\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Green-up pace\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\neos_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"EOS\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"End of season\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\n\ngreendown_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"green-down pace\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Green-down pace\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\nsos_p + greenup_p + plot_layout(guides = \"collect\") & theme(legend.position = \"right\")\neos_p + greendown_p + plot_layout(guides = \"collect\") & theme(legend.position = \"right\")\n\n\n\n\n\n\n\n\n\n\n\n\n(a) Spring phenology\n\n\n\n\n\n\n\n\n\n\n\n\n\n(b) Fall phenology\n\n\n\n\n\n\n\nFigure 2: Distribution of partial correlation coefficient and preseason length, calculated by Tempavg"
  },
  {
    "objectID": "workflow_micro_NYC.html#spatial-pattern-sos-tavg",
    "href": "workflow_micro_NYC.html#spatial-pattern-sos-tavg",
    "title": "workflow_micro_NYC",
    "section": "3 Spatial pattern (SOS ~ Tavg)",
    "text": "3 Spatial pattern (SOS ~ Tavg)\n\n3.1 Check spatial autocorrelation\nBoth fixed-effect model and mixed-effects model have heterogeneous residuals. Global Moran I for regression residuals test indicates the presence of spatial autocorrelation in the residuals. Lagrange Multiplier test suggests the spatial model should be applied.\n\n\nCode\ntavg_allyear_var &lt;- readRDS(\"~/phenology-urban/data/proc/urban/NY/tavg_allyear_var.rds\")\ngenera &lt;- unique(tavg_allyear_var$genus)\nvariogram_results &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"up\" & thres == 0.5 & genus == !!genus) %&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n  \n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_results[[i]] &lt;- data.frame(\n    genus = genus,\n    model = vgm_exn_fit$model,\n    psill = vgm_exn_fit$psill,\n    range = vgm_exn_fit$range\n  )\n}\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nWarning: Heteroscedasticity (non-constant error variance) detected (p &lt; .001).\n\n\nOK: Error variance appears to be homoscedastic (p = 0.826).\n\n\nCode\nvariogram_summary &lt;- do.call(rbind, variogram_results)\nkable(variogram_summary, caption = \"Fitted semivariogram model for each genus\")\n\n\n\nFitted semivariogram model for each genus\n\n\ngenus\nmodel\npsill\nrange\n\n\n\n\nCarya\nSph\n119.539553\n0.0094942\n\n\nAcer\nSph\n95.395099\n-0.0375294\n\n\nQuercus\nSph\n91.362932\n-0.0532885\n\n\nPlatanus\nSph\n35.766955\n-0.0209021\n\n\nJuglans\nMat\n62.373693\n0.0012231\n\n\nLiquidambar\nSph\n63.214989\n0.0097814\n\n\nBetula\nMat\n82.330152\n-0.0272595\n\n\nPopulus\nMat\n37.382824\n-0.0000106\n\n\nMorus\nExp\n152.724414\n0.0010145\n\n\nUlmus\nSph\n106.504789\n-0.2291773\n\n\nFraxinus\nMat\n27.600177\n-0.0063073\n\n\nCeltis\nMat\n64.975068\n-0.0183950\n\n\nSalix\nMat\n86.863874\n-0.0014266\n\n\nAlnus\nSph\n9.277417\n0.0000048\n\n\n\n\n\n\n\n3.2 Spatial statistical model\nWe modeled the relationship between the day of year (()) and environmental covariates using a spatial hierarchical model. The response variable at location (_i), denoted as (y(_i)), was modeled as follows:\n\\[y(\\mathbf{s}_i) = \\mu(\\mathbf{s}_i) + w(\\mathbf{s}_i) + u_{\\text{year}(i)} + \\epsilon(\\mathbf{s}_i)\\]\nwhere:\n\nFixed Effects: \\[\\mu(\\mathbf{s}_i) = \\mathbf{X}_i \\boldsymbol{\\beta}\\]\n\n\\(\\mathbf{X}_i = [1, \\text{AvgTemp}, \\text{Precp}, \\text{srad}]\\) is the design matrix of predictors.\n\\(\\boldsymbol{\\beta} = [\\beta_0, \\beta_1, \\beta_2, \\beta_3]\\) are the regression coefficients for the intercept and covariates.\n\nSpatially Correlated Random Effect: \\[w(\\mathbf{s}_i) \\sim \\text{MVN}(\\mathbf{0}, \\mathbf{R} \\cdot \\sigma^2)\\]\n\n\\(\\mathbf{R}\\) is the spatial correlation matrix defined by a covariance function:\nMatérn Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\frac{2^{1-\\nu}}{\\Gamma(\\nu)} \\left(\\frac{\\sqrt{2\\nu} D_{ij}}{\\rho}\\right)^\\nu K_\\nu\\left(\\frac{\\sqrt{2\\nu} D_{ij}}{\\rho}\\right)\\]\nExponential Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\exp(-\\phi D_{ij})\\]\nGaussian Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\exp(-\\phi D_{ij}^2)\\]\nSpherical Covariance Function (if selected):\n\n\\[\\mathbf{R}_{ij} =\n        \\begin{cases}\n        \\sigma^2 \\cdot \\left(1 - \\frac{3 D_{ij}}{2\\rho} + \\frac{D_{ij}^3}{2\\rho ^3}\\right), & D_{ij} \\leq \\rho \\\\\n        0, & D_{ij} &gt; \\rho\n        \\end{cases}\\]\nYear-specific Random Effect: \\[u_{\\text{year}(i)} \\sim \\text{N}(0, \\tau^2_{\\text{year}})\\]\n\n\\(u_{\\text{year}(i)}\\) captures year-to-year variability, with \\(\\tau^2_{\\text{year}}\\) being the variance of the year effect.\n\nIndependent Nugget Effect: \\[\\epsilon(\\mathbf{s}_i) \\sim \\text{N}(0, \\tau^2)\\]\n\n\\(\\epsilon(\\mathbf{s}\\_i)\\) accounts for measurement error or small-scale variability.\n\n\n\nPrior Distributions\n\\[\\boldsymbol{\\beta} \\sim \\text{MVN}(\\mathbf{0}, 1000\\mathbf{I})\\]\n\\[\\sigma^2 \\sim \\text{Inverse-Gamma}(2.5, 120)\\]\n\\[\\phi \\sim \\text{Uniform}(5, 50) \\quad \\text{(Exponential or Gaussian covariance)}\\]\n\\[\\nu \\sim \\text{Uniform}(0.5, 5) \\quad \\text{(Matérn covariance only)}\\]\n\\[\\rho \\sim \\text{Uniform}(0, 1) \\quad \\text{(Matérn or Spherical covariance)}\\]\n\\[\\tau^2 \\sim \\text{Inverse-Gamma}(0.001, 0.001)\\]\n\\[\\tau^2_{\\text{year}} \\sim \\text{Inverse-Gamma}(2.001, 0.667)\\]\n\nProblem with year (replicate location):\n\nTreat year as random effect\n\nProblem with genus:\n\nFit each genus separately\n\n\nSOS in NYC\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/\"\nfiles &lt;- list.files(dir_path, pattern = \"^NY.*SOS\\\\.rds$\", full.names = TRUE)\nplots &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_SOS\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == \"AvgTemp\")\n  beta_median &lt;- median(param_data$value)\n  p &lt;- param_data %&gt;%\n    ggs_density() +\n    theme_bw() +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme(plot.title = element_text(hjust = 0.5)) +\n    annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4)\n  plots[[genus]] &lt;- p\n}\n\ncombined_plot &lt;- wrap_plots(plots, ncol = 2)\ncombined_plot\n\n\n\n\n\n\n\n\nFigure 3: The density of the posterior distribution of regression coefficients for Temp~avg~ with SOS as the response variable for each genus in New York city."
  },
  {
    "objectID": "workflow_micro_NYC.html#spatial-pattern",
    "href": "workflow_micro_NYC.html#spatial-pattern",
    "title": "workflow_micro_NYC",
    "section": "3 Spatial pattern",
    "text": "3 Spatial pattern\n\n3.1 Check spatial autocorrelation\nFirst, I fitted a linear mixed-effects model for each genus with environmental variables (AvgTemp_mean, Sum_mm_sum, and srad_mean) as predictors, with random effects for year and id, which represent temporal ((1 | year)) and spatial ((1 | id)) randomness, respectively.\nThen I conducted a variance decomposition analysis and compared the proportion of total variance explained by spatial effects and temporal effects respectively. Generally, spatial and temporal variations are both present, but their contributions vary across different genera. Some genera show higher spatial effects, while others have more balanced contributions from spatial and year components.\n\n\nCode\ntavg_allyear_var &lt;- readRDS(\"~/phenology-urban/data/proc/urban/DV/tavg_allyear_var.rds\")\nphe_types &lt;- c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\")\nall_genus &lt;- unique(tavg_allyear_var$genus)\nresults &lt;- list()\n\nfor (phe_type in phe_types) {\n  if (phe_type == \"SOS\") {\n    phe_metric &lt;- \"doy\"\n    direction &lt;- \"up\"\n    thres &lt;- 0.5\n  } else if (phe_type == \"EOS\") {\n    phe_metric &lt;- \"doy\"\n    direction &lt;- \"down\"\n    thres &lt;- 0.5\n  } else if (phe_type == \"GreenUp\") {\n    phe_metric &lt;- \"doy_diff\"\n    direction &lt;- \"up\"\n    thres &lt;- 0.2\n    tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n  } else {\n    phe_metric &lt;- \"doy_diff\"\n    direction &lt;- \"down\"\n    thres &lt;- 0.2\n    tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n  }\n    \n    for (genus in all_genus) {\n      tavg_SOS &lt;- tavg_allyear_var %&gt;%\n        filter(direction == !!direction & thres == thres & genus == !!genus) %&gt;%\n        na.omit()\n      model &lt;- as.formula(paste0(phe_metric, \" ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year) + (1 | id)\"))\n      full_model &lt;- lmer(model, data = tavg_SOS)\n      var_components &lt;- VarCorr(full_model)\n      \n      total_variance &lt;-  var_components$id[1, 1] +  var_components$year[1, 1] + attr(var_components, \"sc\")^2\n      spatial_contribution &lt;- var_components$id[1, 1]  / total_variance\n      year_contribution &lt;-  var_components$year[1, 1] / total_variance\n      residual_contribution &lt;- attr(var_components, \"sc\")^2 / total_variance\n      \n      variance_components &lt;- data.frame(\n            Metric = phe_type,\n            Genus = genus,\n            Component = c(\"Spatial\", \"Year\", \"Residual\"),\n            Variance = c(spatial_contribution, year_contribution, residual_contribution)\n          )\n          \n          results[[paste(phe_type, genus, sep = \"_\")]] &lt;- variance_components\n  }\n}\n\nfinal_results &lt;- do.call(rbind, results)\nfinal_results &lt;- final_results %&gt;%\n  group_by(Metric, Genus) %&gt;%\n  mutate(Variance_Proportion = Variance / sum(Variance),\n         Component = factor(Component, levels = c(\"Spatial\", \"Residual\", \"Year\")),\n         Metric = factor(Metric, levels = c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\")))\n\nggplot(final_results, aes(x = Genus, y = Variance_Proportion, fill = Component)) +\n  geom_bar(stat = \"identity\", position = \"stack\") +\n  facet_wrap(~Metric, scales = \"free_x\") +\n  labs(x = \"Genus\", y = \"Variance Proportion\", fill = \"Component\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  scale_fill_brewer(palette = \"Set2\") \n\n\n\n\n\n\n\n\nFigure 5: Variance decomposition analysis for spatial and temporal effects\n\n\n\n\n\n\n\n\n\n\nCode\ntavg_allyear_var &lt;- readRDS(\"~/phenology-urban/data/proc/urban/NY/tavg_allyear_var.rds\")\ngenera &lt;- unique(tavg_allyear_var$genus)\n\n\nvariogram_sos &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"up\" & thres == 0.5 & genus == !!genus) %&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_sos[[i]] &lt;- data.frame(\n    genus = genus,\n    SOS = vgm_exn_fit$model\n  )\n}\nvariogram_sos &lt;- do.call(rbind, variogram_sos)\n\n\nvariogram_eos &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"down\" & thres == 0.5 & genus == !!genus) %&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_eos[[i]] &lt;- data.frame(\n    genus = genus,\n    EOS = vgm_exn_fit$model\n  )\n}\nvariogram_eos &lt;- do.call(rbind, variogram_eos)\n\nvariogram_up &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"up\" & thres == 0.2 & genus == !!genus) %&gt;%\n    mutate(doy_diff = as.numeric(doy_diff))%&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy_diff ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_up[[i]] &lt;- data.frame(\n    genus = genus,\n    GreenUp = vgm_exn_fit$model\n  )\n}\nvariogram_up &lt;- do.call(rbind, variogram_up)\n\nvariogram_down &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"down\" & thres == 0.2 & genus == !!genus) %&gt;%\n    mutate(doy_diff = as.numeric(doy_diff))%&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy_diff ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_down[[i]] &lt;- data.frame(\n    genus = genus,\n    GreenDown = vgm_exn_fit$model\n  )\n}\nvariogram_down &lt;- do.call(rbind, variogram_down)\n\nvariogram_summary &lt;- variogram_sos %&gt;%\n  left_join(variogram_eos, by = \"genus\") %&gt;%\n  left_join(variogram_up, by = \"genus\") %&gt;%\n  left_join(variogram_down, by = \"genus\")\n\nkable(variogram_summary, caption = \"Fitted semivariogram model for each genus\")\n\n\n\n\n\n3.2 Spatial statistical model\nI modeled the relationship between the phenology and environmental covariates using a spatial hierarchical model. The response variable (phenology parameter) at location \\(\\mathbf{s}_i\\) and in year \\(\\mathbf{t}\\), denoted as \\(y(\\mathbf{s}_i, \\mathbf{t})\\), was modeled as following candidate model:\nModel 1: (current use)\n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w(\\mathbf{s}_i) + u(\\mathbf{t}) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\n\nFixed Effects: \\[\\mu(\\mathbf{s}_i,\\mathbf{t}) = \\mathbf{X}_{\\mathbf{s}_i,\\mathbf{t}} \\boldsymbol{\\beta}\\]\n\n\\(\\mathbf{X}_{\\mathbf{s}_i,\\mathbf{t}} = [1, \\text{AvgTemp}_{\\mathbf{s}_i,\\mathbf{t}}, \\text{Precp}_{\\mathbf{s}_i,\\mathbf{t}}, \\text{srad}_{\\mathbf{s}_i,\\mathbf{t}}]\\) is the design matrix of predictors.\n\\(\\boldsymbol{\\beta} = [\\beta_0, \\beta_1, \\beta_2, \\beta_3]\\) are the regression coefficients for the intercept and covariates.\n\nSpatially Correlated Random Effect: \\[w(\\mathbf{s}_i) \\sim \\text{MVN}(\\mathbf{0}, \\mathbf{R})\\]\n\n\\(\\mathbf{R}\\) is the spatial correlation matrix defined by a covariance function:\nMatérn Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\frac{2^{1-\\nu}}{\\Gamma(\\nu)} \\left(\\frac{\\sqrt{2\\nu} D_{ij}}{\\rho}\\right)^\\nu K_\\nu\\left(\\frac{\\sqrt{2\\nu} D_{ij}}{\\rho}\\right)\\]\nExponential Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\exp(-\\phi D_{ij})\\]\nGaussian Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\exp(-\\phi D_{ij}^2)\\]\nSpherical Covariance Function (if selected):\n\n\\[\\mathbf{R}_{ij} =\n        \\begin{cases}\n        \\sigma^2 \\cdot \\left(1 - \\frac{3 D_{ij}}{2\\rho} + \\frac{D_{ij}^3}{2\\rho ^3}\\right), & D_{ij} \\leq \\rho \\\\\n        0, & D_{ij} &gt; \\rho\n        \\end{cases}\\]\nYear-specific Random Effect: \\[u(\\mathbf{t}) \\sim \\text{N}(0, \\tau^2_{\\mathbf{t}})\\]\n\n\\(u_{\\mathbf{t}}\\) captures year-to-year variability, with \\(\\tau^2_{\\mathbf{t}}\\) being the variance of the year effect.\n\nIndependent Nugget Effect: \\[\\epsilon(\\mathbf{s}_i) \\sim \\text{N}(0, \\tau^2)\\]\n\n\\(\\epsilon(\\mathbf{s}_i, \\mathbf{t})\\) accounts for measurement error or small-scale variability.\n\n\n\n\n3.3 Inference from spatial model\n\n3.3.1 SOS in NYC\nMCMC\nMost genera showed negative association between temperature and the start of season, suggesting the warmer preseason, the earilier start of season. Only Fraxinus had a positive association, with a median coefficient of 0.15. There are significant genus-level differences in how temperature influences the spring phenology.\nAs for the spatial field, only Salix seems to be ideal. Other genera exhibit either uniform spatial effects or noticeable local variations, even extremely high value.\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/year_random/\"\n\nfiles &lt;- list.files(dir_path, pattern = \"^NY.*SOS\\\\.rds$\", full.names = TRUE)\nplots &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_SOS\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == \"AvgTemp\")\n  beta_median &lt;- median(param_data$value)\n  p &lt;- param_data %&gt;%\n    ggs_density() +\n    theme_bw() +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme(plot.title = element_text(hjust = 0.5)) +\n    annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4)\n  plots[[genus]] &lt;- p\n}\n\ncombined_plot &lt;- wrap_plots(plots, ncol = 3)\ncombined_plot\n\n\nspherical_covariance &lt;- function(d, range, sigma.sq) {\n  result &lt;- matrix(0, nrow = nrow(d), ncol = ncol(d))\n  for (i in 1:nrow(d)) {\n    for (j in 1:ncol(d)) {\n      if (d[i, j] &lt;= range) {\n        result[i, j] &lt;- sigma.sq * (1 - (3 * d[i, j] / (2 * range)) + (d[i, j]^3 / (2 * range^3)))\n      } else {\n        result[i, j] &lt;- 0.0\n      }\n    }\n  }\n  return(result)\n}\n\nmatern_covariance &lt;- function(d, range, sigma.sq, nu) {\n  result &lt;- matrix(0, nrow = nrow(d), ncol = ncol(d))\n  for (i in 1:nrow(d)) {\n    for (j in 1:ncol(d)) {\n      if (d[i, j] == 0) {\n        result[i, j] &lt;- 0.0\n      } else {\n        part &lt;- (2^(1 - nu)) / gamma(nu) * (sqrt(2 * nu) * d[i, j] / range)^nu\n        result[i, j] &lt;- sigma.sq * part * besselK(sqrt(2 * nu) * d[i, j] / range, nu)\n      }\n    }\n  }\n  return(result)\n}\n\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/year_random/\"\ncity = \"NY\"\nphe_type = \"SOS\"\nif (phe_type == \"SOS\") {\n  phe_metric &lt;- \"doy\"\n  direction &lt;- \"up\"\n  thres &lt;- 0.5\n} else if (phe_type == \"EOS\") {\n  phe_metric &lt;- \"doy\"\n  direction &lt;- \"down\"\n  thres &lt;- 0.5\n} else if (phe_type == \"GreenUp\") {\n  phe_metric &lt;- \"doy_diff\"\n  direction &lt;- \"up\"\n  thres &lt;- 0.2\n  tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n} else {\n  phe_metric &lt;- \"doy_diff\"\n  direction &lt;- \"down\"\n  thres &lt;- 0.2\n  tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n}\n\npattern = paste0(\"^\",city,\".*\",phe_type,\"\\\\.rds$\")\nfiles &lt;- list.files(dir_path, pattern = \"^NY.*SOS\\\\.rds$\", full.names = TRUE)\nplots_mean &lt;- list()\nplots_sd &lt;- list()\nplots_extend &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  \n  spatial_mean &lt;- model_data$summary[grep(\"spatial_effect\", rownames(model_data$summary)), \"Mean\"]\n  spatial_sd &lt;- model_data$summary[grep(\"spatial_effect\", rownames(model_data$summary)), \"St.Dev.\"]\n  \n  tavg_allyear_var &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\", city, \"/tavg_allyear_var.rds\"))  %&gt;%\n    filter(direction == !!direction & thres == !!thres & genus == !!genus) %&gt;%\n    na.omit()\n  # %&gt;%\n  #   st_as_sf(coords = c(\"lon\", \"lat\"), crs = 4326)\n  # \n  OLS_formula &lt;- as.formula(paste0(phe_metric, \" ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year)\"))\n  random_OLS &lt;- lmer(OLS_formula, data = tavg_allyear_var)\n  tavg_allyear_var$residual_random &lt;- tavg_allyear_var[[phe_metric]] - fitted(random_OLS)\n  coordinates(tavg_allyear_var) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_allyear_var, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  cov_type &lt;- as.character(vgm_exn_fit$model)\n  \n  \n  tavg_allyear_var &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\", city, \"/tavg_allyear_var.rds\"))  %&gt;%\n    filter(direction == !!direction & thres == !!thres & genus == !!genus) %&gt;%\n    na.omit()\n    \n  monitors &lt;- switch(\n    cov_type,\n    \"Mat\" = c(\"range\", \"sigma.sq\", \"nu\"),\n    \"Gau\" = c(\"tau\", \"sigma.sq\", \"phi\"),\n    \"Exp\" = c(\"tau\", \"sigma.sq\", \"phi\"),\n    \"Sph\" = c(\"range\", \"sigma.sq\"),\n    stop(\"Unknown cov_type!\")\n  )\n  params &lt;- list(range = NULL, sigma.sq = NULL, nu = NULL, phi = NULL)\n  for (param in names(params)) {\n    if (param %in% monitors) {\n      params[[param]] &lt;- model_data$summary[grep(param, rownames(model_data$summary)), \"Mean\"]\n    }\n  }\n  grid &lt;- expand.grid(\n    lon = seq(min(tavg_allyear_var$lon), max(tavg_allyear_var$lon), length.out = 100),\n    lat = seq(min(tavg_allyear_var$lat), max(tavg_allyear_var$lat), length.out = 100)\n    )\n  coords_known &lt;- tavg_allyear_var[, c(\"lon\", \"lat\")]\n  coords_pred &lt;- grid[, c(\"lon\", \"lat\")]\n  dist_matrix &lt;- as.matrix(dist(coords_known))\n  dist_matrix_known_pred &lt;- as.matrix(dist(rbind(coords_pred, coords_known)))[1:nrow(coords_pred), (nrow(coords_pred) + 1):(nrow(coords_pred) + nrow(coords_known))]\n  \n  if (cov_type == \"Mat\") {\n      cov_matrix &lt;- matern_covariance(dist_matrix, params$range, params$sigma.sq, params$nu)\n  } else if (cov_type == \"Gau\") {\n      cov_matrix &lt;- params$sigma.sq * exp(-params$phi * dist_matrix^2)\n  } else if (cov_type == \"Exp\") {\n      cov_matrix &lt;- params$sigma.sq * exp(-params$phi * dist_matrix)\n  } else if (cov_type == \"Sph\") {\n      cov_matrix &lt;- spherical_covariance(d = dist_matrix, range = params$range, sigma.sq = params$sigma.sq)\n  }\n  cov_matrix &lt;- cov_matrix + diag(1e-6, nrow(dist_matrix))\n  \n  if (cov_type == \"Mat\") {\n      cov_matrix_pred &lt;- matern_covariance(dist_matrix_known_pred, params$range, params$sigma.sq, params$nu)\n  } else if (cov_type == \"Gau\") {\n      cov_matrix_pred &lt;- params$sigma.sq * exp(-params$phi * dist_matrix_known_pred^2)\n  } else if (cov_type == \"Exp\") {\n      cov_matrix_pred &lt;- params$sigma.sq * exp(-params$phi * dist_matrix_known_pred)\n  } else if (cov_type == \"Sph\") {\n      cov_matrix_pred &lt;- spherical_covariance(d = dist_matrix_known_pred, range = params$range, sigma.sq = params$sigma.sq)\n  }\n  \n  spatial_effect_pred &lt;- cov_matrix_pred %*% solve(cov_matrix) %*% spatial_mean\n  \n  grid$spatial_effect &lt;- spatial_effect_pred\n  p &lt;- ggplot(grid, aes(x = lon, y = lat, fill = spatial_effect)) +\n    geom_tile() +\n    scale_fill_gradient(low = \"white\", high = \"red\") +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme_minimal() +\n    \n    labs(fill = \"Mean\")\n  \n  plots_extend[[genus]] &lt;- p\n\n  # tavg_allyear_var$spatial_mean &lt;- spatial_mean\n  # tavg_allyear_var$spatial_sd &lt;- spatial_sd\n  # \n  # p_mean &lt;- ggplot() +\n  #   geom_point(data = tavg_allyear_var, aes(x = lon, y = lat, color = spatial_mean), size = 2) +\n  #   scale_color_gradient2(low = \"blue\", mid = \"white\", high = \"red\", midpoint = 0) +\n  #   theme_minimal() +\n  #   ggtitle(paste(\"Genus:\", genus)) +\n  #   labs(color = \"Mean\")\n  # p_sd &lt;- ggplot() +\n  #   geom_point(data = tavg_allyear_var, aes(x = lon, y = lat, color = spatial_sd), size = 2) +\n  #   scale_color_gradient(low = \"white\", high = \"red\") +\n  #   theme_minimal() +\n  #   ggtitle(paste(\"Genus:\", genus)) +\n  #   labs(color = \"SD\")\n  # plots_mean[[genus]] &lt;- p_mean\n  # plots_sd[[genus]] &lt;- p_sd\n}\n\ncombined_plot_extend &lt;- wrap_plots(plots_extend, ncol = 3)\ncombined_plot_extend\n\n\n\n\n\n\n\n\n\n\n\n(a) Distribution of posterior for coeffeicents\n\n\n\n\n\n\n\n\n\n\n\n(b) Spatial field\n\n\n\n\n\n\nFigure 6: The density of the posterior distribution of regression coefficients for Temp~avg~ with SOS as the response variable for each genus in New York city.\n\n\n\n\nINLA\nAs for the INLA model, the coefficients do not show significant differences from the MCMC model, with most genera showed negative association between temperature and the start of season.\nCompared to the previous MCMC results, these spatial fields appear to be smoother overall, with gradual transitions rather than sharp local variations.Some genera (Ulmus, Alnus) have fewer high/low value clusters due to fewer observations.\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/\"\ncity = \"NY\"\nphe_type = \"GreenDown\"\nplots_mean &lt;- list()\nplots_sd &lt;- list()\nplots_semi &lt;- list()\n\npattern = paste0(\"^\",city,\".*\",phe_type,\"\\\\.rds$\")\nfiles &lt;- list.files(dir_path, pattern = pattern, full.names = TRUE)\nplots_tavg &lt;- list()\ncoef_summary &lt;- data.frame()\n\n# for one genus\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  # beta_names &lt;- c(\"beta[0]\", \"beta[AvgTemp_mean]\", \"beta[Sum_mm_sum]\", \"beta[srad_mean]\")\n  # df_list &lt;- lapply(seq_along(model_data$res$marginals.fixed), function(i) {\n  #   data.frame(x = model_data$res$marginals.fixed[[i]][,1], \n  #              density = model_data$res$marginals.fixed[[i]][,2], \n  #              beta = beta_names[i])\n  # })\n  # df &lt;- bind_rows(df_list)\n  beta_avg_temp &lt;- model_data$res$marginals.fixed[[2]]\n  df &lt;- data.frame(\n    x = beta_avg_temp[, 1],\n    density = beta_avg_temp[, 2],\n    beta = \"beta[AvgTemp_mean]\"\n  )\n  plot_tavg &lt;- ggplot(df, aes(x = x, y = density)) +\n    geom_line(linewidth = 1, color = \"blue\") +\n    # facet_wrap(~beta, scales = \"free\", labeller = label_parsed) + \n    theme_minimal() +\n    labs(x = \"Coefficient Value\", y = \"Density\") +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme(legend.position = \"none\")\n  plots_tavg[[genus]] &lt;- plot_tavg\n\n  proj &lt;- inla.mesh.projector(model_data$mesh,dims = c(300, 300))\n  mean_s &lt;- inla.mesh.project(proj, model_data$res$summary.random$s$mean)\n  sd_s &lt;- inla.mesh.project(proj, model_data$res$summary.random$s$sd)\n  df &lt;- expand.grid(x = proj$x, y = proj$y)\n  df$mean_s &lt;- as.vector(mean_s)\n  df$sd_s &lt;- as.vector(sd_s)\n  \n  p_mean &lt;- ggplot(df, aes(x = x, y = y, fill = mean_s)) +\n    geom_raster() +\n    scale_fill_viridis(na.value = \"transparent\") +\n    ggtitle(paste(\"Genus:\", genus)) +\n    coord_fixed(ratio = 0.8) + theme_bw() +\n    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1))\n  \n  p_sd &lt;- ggplot(df, aes(x = x, y = y, fill = sd_s)) +\n    geom_raster() +\n    scale_fill_viridis(na.value = \"transparent\") +\n    ggtitle(paste(\"Genus:\", genus)) +\n    coord_fixed(ratio = 1) + theme_bw()+\n    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1))\n\n  #Plot the decay of spatial autocorrelation across a user-defined range\n  \n  spde.est &lt;- inla.spde2.result(inla = model_data$res, name = \"spatial.field\",\n                                spde = model_data$spde, do.transf = TRUE)\n  Kappa = inla.zmarginal(spde.est$marginals.kappa[[1]], silent = TRUE)[1]$mean\n  MaxRange &lt;- 50000\n  Resolution &lt;- 100\n  d.vec &lt;- seq(0, MaxRange, length = Resolution)\n  Cor.M &lt;- (Kappa * d.vec) * besselK(Kappa * d.vec, 1)\n  Cor.M[1] &lt;- 1\n  CorData &lt;- data.frame(Distance = d.vec, Correlation = Cor.M)\n  p_semi &lt;- ggplot(CorData, aes(x = Distance, y = Correlation)) +\n    geom_line(linewidth = 1, alpha = 0.8, color = \"blue\") +\n    coord_fixed(ratio = MaxRange) +\n    labs(x = \"Distance (m)\", y = \"Correlation\", title = \"Matern Correlation Function\") +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme_minimal()\n  \n  plots_mean[[genus]] &lt;- p_mean\n  plots_sd[[genus]] &lt;- p_sd\n  plots_semi[[genus]] &lt;- p_semi\n\n}\n\ncombined_plot_tavg &lt;- wrap_plots(plots_tavg, ncol = 3)\ncombined_plot_tavg\n\ncombined_plot_semi &lt;- wrap_plots(plots_semi, ncol = 3)\ncombined_plot_mean &lt;- wrap_plots(plots_mean, ncol = 3)\ncombined_plot_sd &lt;- wrap_plots(plots_sd, ncol = 3)\ncombined_plot_mean\n\n\n\n\n\n\n\n\n\n\n\n(a) Distribution of posterior for coeffeicents\n\n\n\n\n\n\n\n\n\n\n\n(b) Spatial field\n\n\n\n\n\n\nFigure 7: The density of the posterior distribution of regression coefficients for Temp~avg~ with SOS as the response variable for each genus in New York city.\n\n\n\n\n\n\n3.3.2 Other phenophases in NYC\nSince the spatial fiels are more smooth, the coefficient estimates are more valid.\nThe genus Alnus has fewer data points, leading to non-convergence of the posterior distribution. So it is ignored here.\nThe magnitude of their responses vary among genera. However, the direction of their response is relatively consistent among most genera, with a 1- to 4-day advancement in SOS, 1-8 days delay in EOS (except Platanus), 1-2 days faster in GreenUp pace (except Celtis), and 1-2 days faster in GreenDown pace (except Carya) as preseason temperature increases 1 degree C.\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/\"\ncity = \"NY\"\npattern = paste0(\"^\",city,\".*\\\\.rds$\")\nfiles &lt;- list.files(dir_path, pattern = pattern, full.names = TRUE)\ncoef_summary &lt;- data.frame()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  phe_type &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\3\", basename(file))\n  fixed_summary &lt;- model_data$fix_effect %&gt;%\n    mutate(genus = genus, phe_type = phe_type)\n  coef_summary &lt;- coef_summary %&gt;%\n    rbind(fixed_summary)\n}\n\ncoef_summary_df &lt;- coef_summary %&gt;%\n  mutate(SigAlpha = ifelse(Sig == \"*\", 1, 0.2),\n         phe_type = factor(phe_type, levels = c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\"))) %&gt;%\n  filter(Factor != \"Alnus\")\n\n\ncoef_summary_plot &lt;- ggplot(coef_summary_df, aes(x = factor(Factor, levels = rev(unique(Factor))), \n                       y = Estimate)) +\n  geom_point(aes(alpha = SigAlpha), position = position_dodge(w = 0.5), size = 3) +\n  geom_errorbar(aes(ymin = Lower, ymax = Upper, alpha = SigAlpha), \n                position = position_dodge(w = 0.5), \n                width = 0.3) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  coord_flip() +\n  facet_wrap(~phe_type, scales = \"free\") + \n  labs(x = NULL, y = \"Estimate\") +\n  scale_alpha_identity() +\n  theme(legend.position = \"right\") +\n  # geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +\n  geom_text(aes(label = Estimate, y = Estimate), vjust = -0.9, show.legend = FALSE, size = 3) +\n  guides(alpha = \"none\") +\n  theme_minimal()+\n  theme(aspect.ratio = 1)\ncoef_summary_plot\n\n\n\n\n\n\n\n\nFigure 8: The distribution of the posterior of regression coefficients for Temp~avg~ for each genus in New York city (Thick line: 90% CI, thin line: 95% CI, point: mean value).\n\n\n\n\n\n\n\n3.3.3 Prediction\nMore appropriate way to prepresent heterogeneity?\n\nThe prediction is located at the weather station, because I don’t interpolate the weather data to cover the whole city.\n\n\n\nCode\nNY_Acer_tavg_SOS &lt;- readRDS(\"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/NY_Acer_tavg_SOS.rds\")\n\ncity = \"NY\"\nphe_type = \"SOS\"\ngenus = \"Acer\"\nmean_doy_acer &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\",city,\"/tavg_allyear_var.rds\")) %&gt;%\n  filter(genus == !!genus & thres == 0.5 & direction == \"up\" ) %&gt;%\n  summarise(doy = mean(doy)) %&gt;%\n  pull(doy)\n\npreseason &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\",city,\"/tavg_allyear_pcorr.rds\")) %&gt;%\n  filter(genus == !!genus & type == !!phe_type) %&gt;%\n  summarise(pre = mean(optimal_pre_length)) %&gt;%\n  pull(pre)\nstart_date = make_date(2023) + days(round(mean_doy_acer) - 1) - days(preseason)\nend_date = make_date(2023) + days(round(mean_doy_acer) - 1)\n\nNY_weather &lt;- readRDS(paste0(\"~/urban-cooling/data/raw/WU/\",city,\"/\",city,\"_wu.rds\")) %&gt;%\n  filter(Date &gt;= start_date & Date &lt;= end_date) %&gt;%\n  group_by(name) %&gt;%\n  summarise(AvgTemp_mean = mean(AvgTemp),\n            Sum_mm_sum = sum(Sum_mm),\n            year = as.factor(2023))\n\nNY_srad &lt;- readRDS(paste0(\"~/phenology-urban/data/raw/\",city,\"/Daymet/daily2016-2024/srad_wu_2023.rds\")) %&gt;%\n  filter(time &gt;= start_date & time &lt;= end_date) %&gt;%\n  group_by(Site) %&gt;%\n  summarise(srad_mean = mean(value)) %&gt;%\n  inner_join(NY_weather, by = c(\"Site\" = \"name\"))\n\nprediction &lt;- read_csv(paste0(\"~/urban-cooling/data/raw/WU/\",city,\"/location.csv\"), show_col_types = FALSE) %&gt;%\n  inner_join(NY_srad, by = \"Site\") %&gt;%\n  na.omit()\nindex &lt;- inla.stack.index(stack = NY_Acer_tavg_SOS$stk.full, tag = \"pred\")$data\ncoorp &lt;- prediction[, c(\"Lon\", \"Lat\")]\npred_mean &lt;- NY_Acer_tavg_SOS$res$summary.fitted.values[index, \"mean\"]\npred_ll &lt;- NY_Acer_tavg_SOS$res$summary.fitted.values[index, \"0.025quant\"]\npred_ul &lt;- NY_Acer_tavg_SOS$res$summary.fitted.values[index, \"0.975quant\"]\n\npred_ph_2023 &lt;- rbind(\n  data.frame(\n    Lon = coorp[, 1], Lat = coorp[, 2],\n    value = pred_mean, variable = \"pred_mean\"\n  ),\n  data.frame(\n    Lon = coorp[, 1], Lat = coorp[, 2],\n    value = pred_ll, variable = \"pred_ll\"\n  ),\n  data.frame(\n    Lon = coorp[, 1], Lat = coorp[, 2],\n    value = pred_ul, variable = \"pred_ul\"\n  )\n)\npred_ph_2023$variable &lt;- as.factor(pred_ph_2023$variable)\n\nggplot(pred_ph_2023) +\n  geom_point(aes(Lon, Lat, color  = value)) +\n  facet_wrap(~variable, nrow = 1) +\n  coord_fixed(ratio = 1) +\n  scale_color_gradient(\n    name = \"Predicted SOS\\nin 2023\",\n    low = \"blue\", high = \"orange\"\n  ) +\n  theme_bw()\n\n\n\n\n\n\n\n\nFigure 9: Prediction for the SOS of Acer in 2023 in New York city.\n\n\n\n\n\n\n\n3.3.4 Comparison across cities\nFor SOS, most genera all cities showed negative association between temperature and the start of season. Only some genera in DV and ST had a positive association.\nFor EOS, the difference among cities is the most obvious. Almost all genera in NY and ST had a positive association, while most genera in DV had a negative association. Precipitation/humidity/elevation?\nFor GreenUp, most genera had a positive association.\nFor GreenDown, almost all genera in DV and NY had a negative association, while most genera in ST and HT had a negative association.\n\n\nCode\n### INLA\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/\"\npattern = paste0(\"^.*\\\\.rds$\")\nfiles &lt;- list.files(dir_path, pattern = pattern, full.names = TRUE)\ncoef_summary &lt;- data.frame()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  city &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\1\", basename(file))\n  genus &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  phe_type &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\3\", basename(file))\n  fixed_summary &lt;- model_data$fix_effect %&gt;%\n    mutate(city = city, genus = genus, phe_type = phe_type)\n  coef_summary &lt;- coef_summary %&gt;%\n    rbind(fixed_summary)\n}\n\ncoef_summary_df &lt;- coef_summary %&gt;%\n  mutate(SigAlpha = ifelse(Sig == \"*\", 1, 0.2),\n         phe_type = factor(phe_type, levels = c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\")),\n         city = factor(city, levels = c(\"NY\", \"DV\", \"HT\", \"ST\")))\n\n\ncoef_summary_plot &lt;- ggplot(coef_summary_df, aes(x = factor(Factor, levels = unique(Factor)), y = Estimate, color = city)) +\n  geom_point(aes(alpha = SigAlpha), position = position_dodge(w = 0.5), size = 1.2) +\n  geom_errorbar(aes(ymin = Lower, ymax = Upper, alpha = SigAlpha), \n                position = position_dodge(w = 0.5), \n                linewidth = 0.5,\n                width = 0.3) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  # coord_flip() +\n  facet_wrap(~phe_type, scales = \"free\") +\n  labs(x = NULL, y = \"Estimate\") +\n  scale_alpha_identity() +\n  scale_color_manual(\n    values = c(\"NY\" = \"darkolivegreen4\", \"HT\" = \"navyblue\", \"DV\" = \"chocolate\", \"ST\" = \"purple\")\n  ) +\n  theme(legend.position = \"right\") +\n  # geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +\n  # geom_text(aes(label = Estimate, y = Estimate), vjust = -0.9, show.legend = FALSE, size = 3) +\n  guides(alpha = \"none\") +\n  theme_minimal()+\n  theme(\n    axis.text.x = element_text(size = 10, angle = 45, hjust = 1))\ncoef_summary_plot\n\n\n\n\n\n\n\n\nFigure 10: The distribution of the posterior of regression coefficients for Temp~avg~ on phenology for each genus (Line: 95% CI, point: mean value).\n\n\n\n\n\n\n\n3.3.5 Simulation for model’s validation\nPotential issue:\n\nThe variance among years may be captured by the spatial covariance.\nThe covariance matrix is incorrectly specified.\n\nIn this step, I primarily aimed to simulate data to verify whether the model is feasible and whether INLA can effectively capture the model parameters and assess uncertainty. Additionally, I examined whether the method can still detect signals when an incorrect covariance matrix is specified.\nI simulated the data with the true slope of Avg_temp is -2. Both spatial covariance and temporal variance are included, and spatial covariance just happened among the records from the same year. Some records happen in the same location.\nThe results demonstrate that this modeling approach is feasible.\n\n################ Make up the simulation data ################\nset.seed(2025)\nlon_range &lt;- c(-74.25156, -73.70623)\nlat_range &lt;- c(40.50458, 40.91093)\nN &lt;- 200 \nlon &lt;- runif(N, min = lon_range[1], max = lon_range[2])\nlat &lt;- runif(N, min = lat_range[1], max = lat_range[2])\n\nyears &lt;- 2017:2023\nnyears &lt;- length(years)\nyear &lt;- sample(years, N, replace = TRUE)\n\n# fix effects: intercept, tavg, precp, srad\nintercept &lt;- 120\ntavg &lt;- runif(N, 0, 25)\nprecp &lt;- runif(N, 0, 500)\nsrad &lt;- runif(N, 300, 450)\n\nbeta &lt;- c(intercept, -2, 0.05, 0.05)\nX &lt;- cbind(1, tavg, precp, srad)\n\n# spatial effect\nsigma.sq &lt;- 80\nphi &lt;- 25\nspatial_effect &lt;- numeric(N)\n\nfor (y in years) {\n  year_idx &lt;- which(year == y)\n  if (length(year_idx) &gt; 1) {\n    lon_year &lt;- lon[year_idx]\n    lat_year &lt;- lat[year_idx]\n    dist_matrix_year &lt;- as.matrix(dist(cbind(lon_year, lat_year)))\n    cov_matrix_year &lt;- sigma.sq * exp(-phi * dist_matrix_year)\n    spatial_effect[year_idx] &lt;- mvrnorm(1, mu = rep(0, length(year_idx)), Sigma = cov_matrix_year)\n  } else {\n    spatial_effect[year_idx] &lt;- 0\n  }\n}\n\n# year effect\nyear_effect &lt;- rnorm(nyears, mean = 0, sd = 1)\n\nmu &lt;- numeric(N)\ny &lt;- numeric(N)\ntau &lt;- 1 \nfor (i in 1:N) {\n  year_idx &lt;- which(years == year[i])\n  mu[i] &lt;- X[i,] %*% beta + spatial_effect[i] + year_effect[year_idx]\n  y[i] &lt;- rnorm(1, mean = mu[i], sd = sqrt(1/tau))\n}\n\nsim_data &lt;- data.frame(\n  lon = lon,\n  lat = lat,\n  year = year,\n  AvgTemp_mean = tavg,\n  Sum_mm_sum = precp,\n  srad_mean = srad,\n  spatial_effect = spatial_effect,\n  doy = y\n)\n\n\n\nCode\n################ MCMC ################\n\n# dir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/\"\n# \n# files &lt;- list.files(dir_path, pattern = \"^SIM_sp_random.*\\\\.rds$\", full.names = TRUE)\n# plots &lt;- list()\n# \n# for (file in files) {\n#   model_data &lt;- readRDS(file)\n#   genus &lt;- sub(\".*SIM_(.*?)_tavg_SOS_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n#   \n#   beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n#   param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n#     filter(Parameter == \"AvgTemp\")\n#   beta_median &lt;- median(param_data$value)\n#   beta_mean &lt;- mean(param_data$value)\n#   p &lt;- param_data %&gt;%\n#     ggs_density() +\n#     theme_bw() +\n#     ggtitle(paste(\"Model:\", genus)) +\n#     theme(plot.title = element_text(hjust = 0.5)) +\n#     annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4) +\n#     annotate(\"text\", x = beta_mean, y = 2, label = paste0(\"Mean: \", round(beta_mean, 2)),vjust = -1.5, color = \"red\", size = 4)\n#   plots[[genus]] &lt;- p\n# }\n# \n# combined_plot2 &lt;- wrap_plots(plots, ncol = 2)\n# combined_plot2\n# \n# files &lt;- list.files(dir_path, pattern = \"^SIM_joint.*\\\\.rds$\", full.names = TRUE)\n# plots &lt;- list()\n# \n# for (file in files) {\n#   model_data &lt;- readRDS(file)\n#   genus &lt;- sub(\".*SIM_(.*?)_tavg_SOS_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n#   \n#   beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n#   param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n#     filter(Parameter == \"AvgTemp\")\n#   beta_median &lt;- median(param_data$value)\n#   beta_mean &lt;- mean(param_data$value)\n#   p &lt;- param_data %&gt;%\n#     ggs_density() +\n#     theme_bw() +\n#     ggtitle(paste(\"Model:\", genus)) +\n#     theme(plot.title = element_text(hjust = 0.5)) +\n#     annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4) +\n#     annotate(\"text\", x = beta_mean, y = 2, label = paste0(\"Mean: \", round(beta_mean, 2)),vjust = -1.5, color = \"red\", size = 4)\n#   plots[[genus]] &lt;- p\n# }\n# \n# combined_plot &lt;- wrap_plots(plots, ncol = 2)\n# combined_plot\n\n################ INLA ################\n\nmodel_data &lt;- readRDS(\"~/phenology-urban/data/proc/urban/sp_model/SIM_INLA_tavg_SOS.rds\")\ngenus = \"Simulation\"\n\n# fixed effect\n\nbeta_avg_temp &lt;- model_data$res$marginals.fixed\ndf_list &lt;- lapply(names(beta_avg_temp), function(nm) {\n  data.frame(\n    x = beta_avg_temp[[nm]][, 1],\n    density = beta_avg_temp[[nm]][, 2],\n    beta = paste0(\"beta[\", nm, \"]\") \n  )\n})\ndf &lt;- do.call(rbind, df_list)\nfix_effect &lt;- as.data.frame(summary(model_data$res)$fixed) %&gt;%\n  rename(Mean = mean, Lower = `0.025quant`,Upper = `0.975quant`) %&gt;%\n  mutate(Sig = ifelse(Lower*Upper&gt;0, \"*\", \"\")) \nfix_effect &lt;- data.frame(\n  Factor = rownames(fix_effect),  # Add Factor column\n  fix_effect, \n  row.names = NULL) %&gt;%\n  mutate(Factor = case_when(\n    Factor == \"Intercept\" ~ \"beta[Intercept]\",\n    Factor == \"AvgTemp_mean\" ~ \"beta[AvgTemp_mean]\",\n    Factor == \"Sum_mm_sum\" ~ \"beta[Sum_mm_sum]\",\n    Factor == \"srad_mean\" ~ \"beta[srad_mean]\"\n  )) \n\ndf_with_mean &lt;- df %&gt;%\n  left_join(fix_effect %&gt;% select(Factor, Mean), by = c(\"beta\" = \"Factor\"))\nannot_data &lt;- df_with_mean %&gt;%\n  group_by(beta) %&gt;%\n  summarise(\n    Mean = first(Mean),\n    max_density = max(density)\n  )\n\nplot_tavg &lt;- ggplot(df_with_mean, aes(x = x, y = density)) +\n  geom_line(linewidth = 1, color = \"blue\") +\n  geom_text(\n    aes(x = Mean, y = max_density * 0.95, \n        label = paste0(\"Mean = \", round(Mean, 3))),\n    data = annot_data,\n    color = \"red\", size = 4, hjust = 1.1\n  ) +\n  facet_wrap(~beta, scales = \"free\", labeller = label_parsed) + \n  theme_minimal() +\n  labs(x = \"Coefficient Value\", y = \"Density\") +\n  ggtitle(paste(\"Genus:\", genus)) +\n  theme(legend.position = \"none\")\n\nplot_tavg\n\n# spatial field\nproj &lt;- inla.mesh.projector(model_data$mesh,dims = c(300, 300))\nmean_s &lt;- inla.mesh.project(proj, model_data$res$summary.random$s$mean)\nsd_s &lt;- inla.mesh.project(proj, model_data$res$summary.random$s$sd)\ndf &lt;- expand.grid(x = proj$x, y = proj$y)\ndf$mean_s &lt;- as.vector(mean_s)\ndf$sd_s &lt;- as.vector(sd_s)\n\ngmean &lt;- ggplot(df, aes(x = x, y = y, fill = mean_s)) +\n  geom_raster() +\n  scale_fill_viridis(na.value = \"transparent\") +\n  coord_fixed(ratio = 1) + theme_bw()  +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.9))\n\ngsd &lt;- ggplot(df, aes(x = x, y = y, fill = sd_s)) +\n  geom_raster() +\n  scale_fill_viridis(na.value = \"transparent\") +\n  coord_fixed(ratio = 1) +\n  theme_bw() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.9))\n\ngmean + gsd\n\n\n\n\n\n\n\n\n\n\n\n(a) Distribution of posterior for coeffeicents\n\n\n\n\n\n\n\n\n\n\n\n(b) Spatial field\n\n\n\n\n\n\nFigure 11: The distribution of posterior for coeffeicent and spatial field using simulated data and R-INLA.\n\n\n\n\n\n\n3.3.6 Comparison with OLS\nI think there is no dramatic difference between the OLS and INLA models. However, I believe this is appropriate, as the spatial part does not significantly impact the coefficient, and primarily accounts for the unexplained residuals in the linear regression.\n\n\nCode\n### INLA\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/ols_model/\"\npattern = paste0(\"^.*\\\\.rds$\")\nfiles &lt;- list.files(dir_path, pattern = pattern, full.names = TRUE)\ncoef_summary &lt;- data.frame()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  city &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\1\", basename(file))\n  genus &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  phe_type &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\3\", basename(file))\n  fixed_summary &lt;- model_data$fix_effect %&gt;%\n    mutate(city = city, genus = genus, phe_type = phe_type)\n  coef_summary &lt;- coef_summary %&gt;%\n    rbind(fixed_summary)\n}\n\ncoef_summary_df &lt;- coef_summary %&gt;%\n  mutate(SigAlpha = ifelse(Sig == \"*\", 1, 0.2),\n         phe_type = factor(phe_type, levels = c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\")),\n         city = factor(city, levels = c(\"NY\", \"DV\", \"HT\", \"ST\")))\n\n\ncoef_summary_plot &lt;- ggplot(coef_summary_df, aes(x = factor(Factor, levels = unique(Factor)), y = Estimate, color = city)) +\n  geom_point(aes(alpha = SigAlpha), position = position_dodge(w = 0.5), size = 1.2) +\n  geom_errorbar(aes(ymin = Lower, ymax = Upper, alpha = SigAlpha), \n                position = position_dodge(w = 0.5), \n                linewidth = 0.5,\n                width = 0.3) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  # coord_flip() +\n  facet_wrap(~phe_type, scales = \"free\") +\n  labs(x = NULL, y = \"Estimate\") +\n  scale_alpha_identity() +\n  scale_color_manual(\n    values = c(\"NY\" = \"darkolivegreen4\", \"HT\" = \"navyblue\", \"DV\" = \"chocolate\", \"ST\" = \"purple\")\n  ) +\n  theme(legend.position = \"right\") +\n  # geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +\n  # geom_text(aes(label = Estimate, y = Estimate), vjust = -0.9, show.legend = FALSE, size = 3) +\n  guides(alpha = \"none\") +\n  theme_minimal()+\n  theme(\n    axis.text.x = element_text(size = 10, angle = 45, hjust = 1))\ncoef_summary_plot\n\n\n\n\n\n\n\n\nFigure 12: The distribution of the posterior of regression coefficients for Temp~avg~ on phenology for each genus (Line: 95% CI, point: mean value)."
  },
  {
    "objectID": "workflow_micro_NYC.html#intro",
    "href": "workflow_micro_NYC.html#intro",
    "title": "workflow_micro_NYC",
    "section": "",
    "text": "Action term for last discussion\n\nR-INLA (rather than estimating the joint posterior distribution of the parameters via MCMC, INLA focusing on individual posterior marginals of the model parameters, which is enough to make inference of the model parameters and latent effects in most cases)\nInfererence: Sptatial random effects\nPredictions\nComparison to regular model\nEcological questions -&gt; journal goals\n\nKey highlights (coordinate them with Juwon):\n\nWithin-city variation: fine-scale of phenology and climate observations, across large range.\nSpring & Fall phenology: Katz et al., 2019 Xing et al., 2022. A few papers about intra-urban variation of phenology. Few about the fall phenology.\nPhenology pace, different taxa\n\nMethods\n\nPreseason Optimization: At the year-, site-, and taxa-level. Individual-level pre-period might have some built-in relationship.\nSpatial regression: Use R-INLA package to address spatial autocorrelation."
  },
  {
    "objectID": "equation.html",
    "href": "equation.html",
    "title": "Potential model",
    "section": "",
    "text": "Model 1: (current use)\n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w(\\mathbf{s}_i) + u(\\mathbf{t}) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\n\\(y(\\mathbf{s}_i, \\mathbf{t})\\) is the response variable at location \\(\\mathbf{s}_i\\) and time \\(\\mathbf{t}\\).\nModel 2:\n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w(\\mathbf{s}_i, \\mathbf{t}) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\nModel 3:\n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w_t(\\mathbf{s}_i) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\nModel 4:\n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w(\\mathbf{s}_i) + u(\\mathbf{t}) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\nPrior distribution \\[ \\tau \\sim \\text{Gamma}(0.001, 0.001) \\] \\[ \\sigma^2 \\sim \\text{Inverse-Gamma}(2.5, 120) \\] \\[ \\phi \\sim \\text{Uniform}\\left(5, 50\\right) \\] \\[ \\tau_{\\mathbf{t}} \\sim \\text{Inverse-Gamma}(2.001, 0.667) \\] \\[ \\text{range} \\sim \\text{Uniform}(0, 1) \\] \\[\\nu \\sim \\text{Uniform}(0.5, 5) \\] \\[\\beta_j \\sim \\text{Normal}(0, 1000) \\quad \\text{for all } j \\]\nInitial values\n\\[\\beta_j = 0\\] \\[ \\tau = 1 \\] \\[ \\sigma^2 = 80\\] \\[ \\phi = 25 \\] \\[ \\tau_{\\mathbf{t}} = 1 \\] \\[ \\text{range} = 0.5 \\] \\[ \\nu = 1 \\]"
  },
  {
    "objectID": "workflow_micro_NYC.html#phenological-indicators-and-optimal-preseason",
    "href": "workflow_micro_NYC.html#phenological-indicators-and-optimal-preseason",
    "title": "workflow_micro_NYC",
    "section": "2 Phenological indicators and optimal preseason",
    "text": "2 Phenological indicators and optimal preseason\nThe phenological metrics are defined as follows:\n\n\n\n\n\n\nFigure 2: Phenology metrics calculated based on EVI curve from PlanetScope\n\n\n\n\n\nCode\ncalculate_partial_correlation &lt;- function(insert_data, direction, thres, genus, pre_lengths, \n                                          phe_variable, temp_variable) {\n  subset_tree_pcor &lt;- insert_data %&gt;%\n    filter(direction == !!direction & thres == !!thres & genus == !!genus)\n  results &lt;- lapply(pre_lengths, function(pre_length) {\n    cat(\"Preseason length (days):\", pre_length, \"\\n\")\n    preseason_var &lt;- subset_tree_pcor %&gt;%\n      mutate(\n        start_date = make_date(year) + days(round(mean(doy)) - 1) - days(pre_length),\n        end_date = make_date(year) + days(round(mean(doy)) - 1)\n      )\n\n    temp_stats &lt;- all_sites_temp %&gt;%\n      # filter(name %in% preseason_var$Site) %&gt;%\n      inner_join(preseason_var, by = c(\"name\" = \"Site\")) %&gt;%\n      filter(Date &gt;= start_date & Date &lt;= end_date) %&gt;%\n      group_by(id,year) %&gt;%\n      summarise(\n        LowTemp_mean = mean(LowTemp, na.rm = TRUE),\n        LowTemp_count = sum(!is.na(LowTemp)),\n        AvgTemp_mean = mean(AvgTemp, na.rm = TRUE),\n        AvgTemp_count = sum(!is.na(AvgTemp)),\n        HighTemp_mean = mean(HighTemp, na.rm = TRUE),\n        HighTemp_count = sum(!is.na(HighTemp)),\n        Sum_mm_sum = sum(Sum_mm, na.rm = TRUE),\n        Sum_mm_count = sum(!is.na(Sum_mm)),\n        .groups = \"drop\"\n      )\n  \n    srad_stats &lt;- srad_daily %&gt;%\n      # filter(id %in% preseason_var$id) %&gt;%\n      inner_join(preseason_var, by = \"id\") %&gt;%\n      filter(date &gt;= start_date & date &lt;= end_date) %&gt;%\n      group_by(id,year) %&gt;%\n      summarise(\n        srad_mean = mean(value, na.rm = TRUE),\n        srad_count = sum(!is.na(value)),\n        .groups = \"drop\"\n      )\n    \n    preseason_var &lt;- preseason_var %&gt;%\n      left_join(temp_stats, by = c(\"id\",\"year\")) %&gt;%\n      left_join(srad_stats, by = c(\"id\",\"year\"))\n    \n    \n    if (temp_variable %in% c(\"LowTemp_mean\", \"HighTemp_mean\")){\n      selected_data &lt;- preseason_var %&gt;%\n      dplyr::select(\n        {{ phe_variable }}, LowTemp_mean, HighTemp_mean, Sum_mm_sum,  srad_mean\n      ) %&gt;%\n      na.omit()\n    } else {\n      selected_data &lt;- preseason_var %&gt;%\n      dplyr::select(\n        {{ phe_variable }}, AvgTemp_mean,Sum_mm_sum, srad_mean\n      ) %&gt;%\n      na.omit()\n    }\n    partial_corr &lt;- pcor(selected_data)\n    \n    correlation &lt;- partial_corr$estimate[\n        rownames(partial_corr$estimate) == phe_variable, \n        colnames(partial_corr$estimate) == temp_variable\n      ]\n    pvalue &lt;- partial_corr$p.value[\n        rownames(partial_corr$p.value) == phe_variable, \n        colnames(partial_corr$p.value) == temp_variable\n      ]\n  list(correlation = correlation, pvalue = pvalue, preseason_var = preseason_var)\n  })\n  \n  correlations &lt;- sapply(results, function(x) (x$correlation))\n  pvalues &lt;- sapply(results, function(x) (x$pvalue))\n  \n  \n  max_idx &lt;- which.max(abs(correlations))\n  \n  return(list(\n    optimal_pre_length = pre_lengths[max_idx],\n    pre_length_candidate  = pre_lengths,\n    pre_length_trend = correlations,\n    pvalue_trend = pvalues,\n    partial_correlation = results[[max_idx]]$correlation,\n    partial_corr_pvalue = results[[max_idx]]$pvalue,\n    preseason_var = results[[max_idx]]$preseason_var\n  ))\n}\n\n\npre_lengths &lt;- seq(5, 180, by = 5)\nall_genus &lt;- unique(points_in_buffer$genus)\ntemp_variable = \"AvgTemp_mean\"\n\n\n\n2.1 Spring phenology\n\nSOS date\nDefined as the day of year when individual tree growing season EVI curves first cross the green-up 50% threshold.\n\n\nCode\ndirection &lt;- \"up\"\nthres &lt;- 0.5\nphe_variable = \"doy\"\ninsert_data = points_in_buffer\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nspring_date_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nspring_date_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nspring_date_combined_results &lt;- do.call(rbind, lapply(spring_date_combined_results, as.data.frame))\n\n\n\n\nGreen-up Pace\nDefined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-up 20% threshold to the 80% threshold.\n\n\nCode\ndiff &lt;- points_in_buffer %&gt;%\n  group_by(year, id, direction) %&gt;%\n  filter(thres %in% c(0.2, 0.8)) %&gt;% \n  summarise(\n    doy_diff = abs(diff(doy[order(thres)])),\n    .groups = \"drop\"\n  )\n\npoints_with_diff &lt;- points_in_buffer %&gt;%\n  left_join(diff, by = c(\"year\", \"id\", \"direction\"))\n\ndirection &lt;- \"up\"\nthres &lt;- 0.2              # change to 0.5?\nphe_variable = \"doy_diff\"\ninsert_data = points_with_diff\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nspring_pace_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nspring_pace_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nspring_pace_combined_results &lt;- do.call(rbind, lapply(spring_pace_combined_results, as.data.frame))\n\n\n\n\n\n2.2 Fall phenology\n\nEOS date\nDefined as the day of year when individual tree growing season EVI curves first cross the green-down 50% threshold.\n\nCode\ndirection &lt;- \"down\"\nthres &lt;- 0.5\nphe_variable = \"doy\"\ninsert_data = points_in_buffer\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n \n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nfall_date_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nfall_date_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nfall_date_combined_results &lt;- do.call(rbind, lapply(fall_date_combined_results, as.data.frame))\n\n\n\n\n\n\nGreen-down Pace\nDefined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-down 20% threshold to the 80% threshold.\n\n\nCode\ndirection &lt;- \"down\"\nthres &lt;- 0.2\nphe_variable = \"doy_diff\"\ninsert_data = points_with_diff\n\nall_results &lt;- list()\nall_results &lt;- lapply(all_genus, function(genus) {\n  cat(\"Processing genus:\", genus, \"\\n\")\n \n  result &lt;- calculate_partial_correlation(\n    insert_data = insert_data,\n    direction = direction,\n    thres = thres,\n    genus = genus,\n    pre_lengths = pre_lengths,\n    phe_variable = phe_variable,\n    temp_variable = temp_variable\n  )\n  return(result)\n})\n\nfall_pace_preseason_var &lt;- do.call(rbind, lapply(all_results, function(x) x$preseason_var))\nfall_pace_combined_results &lt;- lapply(all_results, function(x) {\n  list(\n    genus = unique(x$preseason_var$genus),\n    optimal_pre_length = x$optimal_pre_length,\n    partial_correlation = x$partial_correlation,\n    partial_corr_pvalue = x$partial_corr_pvalue,\n    pre_length_candidate = x$pre_length_candidate,\n    pre_length_trend = x$pre_length_trend,\n    pvalue_trend = x$pvalue_trend\n  )\n})\nfall_pace_combined_results &lt;- do.call(rbind, lapply(fall_pace_combined_results, as.data.frame))\n\n\n\n\n\n2.3 Optimal preseason length calculated by Tempavg\nDefined as the period (5-180 days, with 5-day steps) before phenological event for which the partial correlation coefficient between mean phenological event date and average temperature was highest, controlling other climate variables. Meng et al., 2020, Yin et al., 2024\n\n\n\n\n\n\nFigure 3: Conceptual diagram for optimal preseason\n\n\n\nFigure 4 displays the distribution of optimal preseason length and partial correlation coefficient calculated by Tempavg for SOS, Greenup pace, EOS and Greenup pace, respectively.\nOptimal preseason length for spring phenology varies among genera. As for SOS, all genera have negetive partial correlation coefficients, which means the higher preseason average temperature, the earlier start of season. As for Greenup pace, most genera (except Carya, Celtis) have negetive partial correlation coefficients, which means the higher preseason average temperature, the faster green up pace. The preseason length varies significantly among genera.\nBoth the optimal preseason length for fall phenology and the response direction vary significantly among genera. As for EOS, most genera (except Populus, Platanus) have positive partial correlation coefficients, which means the higher preseason average temperature, the later end of season. As for Greenup pace, there is variation in impact direction among genera. The preseason length also varies significantly among genera.\n\nCode\ntavg_allyear_pcorr &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\",city,\"/tavg_allyear_pcorr.rds\")) %&gt;%\n  mutate(\n    # Create a flag for optimal_pre_length\n    is_optimal = ifelse(pre_length_candidate == optimal_pre_length, TRUE, FALSE),\n    # Create a flag for significant pvalue\n    is_significant = ifelse(pvalue_trend &lt; 0.05, TRUE, FALSE),\n    # Adjust transparency\n    alpha = ifelse(is_optimal, 1, 0.2),\n    shape = ifelse(is_significant, 21, 1),\n    size = ifelse(is_optimal, 4, 1.2)\n  ) %&gt;%\n  mutate(shape = factor(shape, levels = c(21, 1)),\n         size = factor(size, levels = c(1.2, 4)))\n  \n\n# Create the plot\nsos_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"SOS\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, shape = shape, size = size)) +  # Add points with alpha and fill\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Start of season\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n  \ngreenup_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"green-up pace\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Green-up pace\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\neos_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"EOS\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"End of season\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\n\ngreendown_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"green-down pace\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Green-down pace\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\nsos_p + greenup_p + plot_layout(guides = \"collect\") & theme(legend.position = \"right\")\neos_p + greendown_p + plot_layout(guides = \"collect\") & theme(legend.position = \"right\")\n\n\n\n\n\n\n\n\n\n\n\n\n(a) Spring phenology\n\n\n\n\n\n\n\n\n\n\n\n\n\n(b) Fall phenology\n\n\n\n\n\n\n\nFigure 4: Distribution of partial correlation coefficient and preseason length, calculated by Tempavg"
  },
  {
    "objectID": "equation.html#candidate-model",
    "href": "equation.html#candidate-model",
    "title": "test",
    "section": "Candidate model",
    "text": "Candidate model\nModel 2: Use Spatio-temporal Random Effect\n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w(\\mathbf{s}_i, \\mathbf{t}) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\n\nFixed Effects: same as above.\nSpatio-temporal Random Effect: \\[w(\\mathbf{s}_i, \\mathbf{t}) \\sim \\text{MVN}(\\mathbf{0}, \\mathbf{R}_{\\mathbf{s}\\mathbf{t}})\\]\n\n\\(\\mathbf{R}\\) is the spatio-temporal correlation matrix defined by covariance function. The function format is the same.\nInstead, \\(D_{ij}\\) is the distance using 3-dimension coordinate, (scaled_longitude, scaled_latitude, scaled_year).\n\nIndependent Nugget Effect: same as above.\n\nModel 3:\n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w_t(\\mathbf{s}_i) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\n\nFixed Effects: same as above.\nSpatio-temporal Random Effect: \\[w_t(\\mathbf{s}_i) \\sim \\text{MVN}(\\mathbf{0}, \\mathbf{R}_{\\mathbf{t}})\\]\n\n\\(\\mathbf{R}_{\\mathbf{t}}\\) is fitted for each year. Or the parameters in covariance matrix, e.g., \\(\\phi(\\mathbf{t}_j) \\sim \\text{N}(0, \\tau^2_{\\phi})\\)\n\nIndependent Nugget Effect: same as above.\n\nModel 4:\n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w(\\mathbf{s}_i) + u(\\mathbf{t}) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\n\nFixed Effects: same as above.\nSpatially Correlated Random Effect: \\[w(\\mathbf{s}_i) \\sim \\text{MVN}(\\mathbf{0}, \\mathbf{R})\\]\n\n\\(\\mathbf{R}\\) is the spatial correlation matrix defined by a covariance function:\n\n\\[\\mathbf{R}_{ij} =\n\\begin{cases}\n0 \\text{ or a very samll value} & \\text{if } \\mathbf{t}_{i} \\neq \\mathbf{t}_{j} \\\\\n\\text{follow covariance function}  & \\text{otherwise}\n\\end{cases}\\]\nYear-specific Random Effect: same as above.\nIndependent Nugget Effect: same as above."
  },
  {
    "objectID": "workflow_cooling_did.html",
    "href": "workflow_cooling_did.html",
    "title": "workflow_cooling_DiD",
    "section": "",
    "text": "In this project, I will explore the cooling effect of urban trees on micro-climate in New York City (NYC). It is impractical to conduct controlled experiments at the city scale that isolate the impact of adding or removing trees on temperature, while controlling for other factors. However, the causal inference methods offer a promising alternative via identifying the valid controls and treatment groups from observational data."
  },
  {
    "objectID": "workflow_cooling_did.html#read-in-the-tree-planting-and-removal-data",
    "href": "workflow_cooling_did.html#read-in-the-tree-planting-and-removal-data",
    "title": "workflow_cooling_DiD",
    "section": "2.1 Read in the tree planting and removal data",
    "text": "2.1 Read in the tree planting and removal data\nThe original data from working orders tracks NYC Parks work done on trees. Only the closed orders, without cancel date were selected. The orders were joined with planting space, to define the exact location. The plant/removal date is based on order ClosedDate, which ranged from 3/3/2015 to 11/7/2024.\n\nThe planting data is filtered to include only work types of “Tree Plant-Park Tree”, “Tree Plant-Street Tree”, “Tree Plant-Street Tree Block”. And the planting should be the only action applied to this location during the study period.\nSimilarly, the removal data is filtered to include only work types of “Tree Removal”, “Tree Removal for Tree Planting”, “Tree Down”. And the removal should be the only action applied to this location.\n\n\nCode\nexp_all &lt;- readRDS(\"~/urban-cooling/data/proc/nyc/ForMS/exp_all.rds\") %&gt;%\n  mutate(change = factor(change, \n                         levels = c(1, -1),   \n                         labels = c(\"planting\", \"removal\")))  \n\n\nggplot(exp_all, aes(x = Year, fill = change)) +\n  geom_histogram(binwidth = 0.5, position = \"dodge\", color = \"black\") +\n  labs(\n    title = \"Trees planted and removed every year\",\n    x = \"Year\",\n    y = \"Number of trees\",\n    fill = \"Type\"\n  ) +\n  scale_fill_manual(values = c(\"planting\" = \"skyblue\", \"removal\" = \"tomato\")) +\n  scale_x_continuous(\n    breaks = seq(2014, 2025, by = 1),  \n    limits = c(2014, 2025)\n  ) +\n  theme_classic()\n\nnycboundary &lt;- st_read(\"~/urban-cooling/data/raw/NYC/boundary/nybb_dissolved.shp\", quiet = T)\nggplot() +\n  geom_sf(data = nycboundary, fill = \"grey95\", color = \"black\") +\n  geom_sf(data = exp_all %&gt;% filter(Year == 2020), aes(color = change), size = 0.1, alpha = 0.5) +\n  scale_color_manual(values = c(\"planting\" = \"skyblue\", \"removal\" = \"tomato\")) +\n  labs(\n    title = \"Planting and Removal Trees in NYC (2020)\",\n    color = \"Change Type\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"bottom\")\n\n\n\n\n\n\n\n\n\n\n\n\n(a) Histogram of tree planting and removal in NYC (2015-2025)\n\n\n\n\n\n\n\n\n\n\n\n\n\n(b) Fall phenology\n\n\n\n\n\n\n\nFigure 1: Distribution of tree planting and removal orders from 2015 to 2024"
  },
  {
    "objectID": "workflow_cooling_did.html#read-and-clean-the-wu-data-based-on-ghcnd",
    "href": "workflow_cooling_did.html#read-and-clean-the-wu-data-based-on-ghcnd",
    "title": "workflow_cooling_DiD",
    "section": "2.2 Read and clean the WU data (based on GHCNd)",
    "text": "2.2 Read and clean the WU data (based on GHCNd)\nThere are 9 raw daily variables selected, i.e. AvgTemp, HighTemp, LowTemp, Prcp, AvgDew, Humidity, WindSpeed, HighPressure, LowPressure. I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily GHCNd.\n\nCode\ncity = \"NY\"\n# all_sites_temp &lt;- read_clean_WU(city = city, run_checks = TRUE)\nall_sites_temp &lt;- readRDS(paste0(\"~/urban-cooling/data/raw/WU/\",city,\"/\",city,\"_wu_9var.rds\")) %&gt;%\n  mutate(\n    LowTemp = case_when(LowTemp_Flag ~ NA_real_, TRUE ~ LowTemp),\n    AvgTemp = case_when(AvgTemp_Flag ~ NA_real_, TRUE ~ AvgTemp),\n    HighTemp = case_when(HighTemp_Flag ~ NA_real_, TRUE ~ HighTemp),\n    AvgDew = case_when(AvgDew_Flag ~ NA_real_, TRUE ~ AvgDew),\n    Humidity = case_when(Humidity_Flag ~ NA_real_, TRUE ~ Humidity),\n    HighPressure = case_when(HighPressure_Flag ~ NA_real_, TRUE ~ HighPressure),\n    LowPressure = case_when(LowPressure_Flag ~ NA_real_, TRUE ~ LowPressure),\n    WindSpeed = case_when(WindSpeed_Flag ~ NA_real_, TRUE ~ WindSpeed),\n    Prcp = case_when(Prcp_Flag ~ NA_real_, TRUE ~ Prcp)\n  ) %&gt;%\n  dplyr::select(c(Date,name, HighTemp, AvgTemp, LowTemp, AvgDew,Humidity,HighPressure,LowPressure,WindSpeed,Prcp ))\n\nwu_location &lt;- read_csv(paste0(\"~/urban-cooling/data/raw/WU/\", city, \"/location.csv\"), show_col_types = FALSE) %&gt;%\n  st_as_sf(coords = c(\"Lon\", \"Lat\"), crs = 4326)\n\nggplot() +\n  geom_sf(data = nycboundary, fill = \"grey\") +\n  geom_sf(data = wu_location, color = \"blue\", size = 1) +\n  theme_minimal()\n\n\n\n\n\n\n\nDistribution of WU stations in NYC"
  },
  {
    "objectID": "workflow_cooling_did.html#join-the-planting-with-climate-information",
    "href": "workflow_cooling_did.html#join-the-planting-with-climate-information",
    "title": "workflow_cooling_DiD",
    "section": "2.3 Join the planting with climate information",
    "text": "2.3 Join the planting with climate information\nThe treated weather stations are those that have trees within a 100 m buffer.\n\n\nCode\nbuffer_size = 100\n\nplanting &lt;- exp_all %&gt;%\n  filter(change == \"planting\") %&gt;%\n  select(\"ClosedDate\", \"Year\", \"Month\", \"Day\", \"WorkOrderGlobalID\")\n\nwu_buffer &lt;- st_buffer(wu_location, dist = buffer_size)\n\nintersects &lt;- st_intersects(planting, wu_buffer)\n\nplanting_in_buffer &lt;- planting %&gt;%\n  mutate(buffer_id = sapply(intersects, function(x) if (length(x) == 1) x[1] else NA)) %&gt;% \n  left_join(wu_buffer %&gt;% st_drop_geometry() %&gt;% mutate(buffer_id = row_number()), by = \"buffer_id\") %&gt;%\n  filter(!is.na(buffer_id)) \n\nif (nrow(planting %&gt;% filter(lengths(intersects) &gt; 1)) &gt; 0) {\n  planting_in_buffer &lt;- planting_in_buffer %&gt;%\n    select(WorkOrderGlobalID, Site) %&gt;%\n    rbind(\n      multiple_intersections %&gt;%\n        rowwise() %&gt;%\n        mutate(\n          Site = {\n            current_row_index &lt;- which(planting$WorkOrderGlobalID == WorkOrderGlobalID)\n            if (length(current_row_index) == 0 || is.na(current_row_index) || current_row_index &gt; length(intersects)) {\n              NA_character_\n            } else {\n              intersected_buffers &lt;- intersects[[current_row_index]]\n              if (length(intersected_buffers) == 0) {\n                NA_character_\n              } else {\n                point_geom &lt;- st_geometry(planting)[current_row_index]\n                buffer_geoms &lt;- st_geometry(wu_location)[intersected_buffers]\n                distances &lt;- st_distance(point_geom, buffer_geoms)\n                nearest_index &lt;- which.min(distances)\n                wu_buffer$Site[intersected_buffers[nearest_index]]\n              }\n            }\n          }\n        ) %&gt;%\n        ungroup()\n    )\n}"
  },
  {
    "objectID": "workflow_cooling_did.html#join-canopy-coverage-value",
    "href": "workflow_cooling_did.html#join-canopy-coverage-value",
    "title": "workflow_cooling_DiD",
    "section": "2.4 Join canopy coverage value",
    "text": "2.4 Join canopy coverage value\nI introduced the tree canopy coverage in 2020 as a control variable, as it serves as a background context that influences temperature.\n\nCode\ncanopy2020 &lt;- rast(\"~/urban-cooling/data/raw/NYC/nlcd_tcc/clipped/nlcd_tcc_NY_2020.tif\")\n\nwu_buffer_canopy &lt;- st_transform(wu_buffer, crs(canopy2020)) %&gt;%\n  vect() %&gt;%\n  extract(canopy2020, ., fun = mean, na.rm = TRUE)\nwu_buffer$avg_canopy &lt;- wu_buffer_canopy[, 2]\nwu_buffer &lt;- wu_buffer %&gt;%\n  st_drop_geometry() %&gt;%\n  mutate(avg_canopy = ifelse(is.nan(avg_canopy), NA, avg_canopy))\n\nggplot(wu_buffer, aes(x = avg_canopy)) +\n  geom_histogram() +\n  labs(\n    x = \"Canopy coverage (%)\",\n    y = \"Frequancy\"\n  ) +\n  theme_classic()\n\n\n\n\n\n\n\n\n\n\nFigure 2: Distribution of tree canopy coverage in 2020 for weather stations"
  },
  {
    "objectID": "workflow_cooling_did.html#short-window-cooling",
    "href": "workflow_cooling_did.html#short-window-cooling",
    "title": "workflow_cooling_DiD",
    "section": "3.1 Short-window cooling",
    "text": "3.1 Short-window cooling\n\nModel\nI aim to investigate the impact of urban tree planting on temperature, specifically analyzing temperature variations within 14 days before and after tree planting events. To identify the causal effect of tree planting, I employ a multi-period Difference-in-Differences (DiD) approach.\n\\[\\text{HighTemp}_{ym} = \\alpha + \\beta \\cdot \\text{Treat}_{ym} +  \\mathbf{X}_{ym} \\cdot \\gamma + \\lambda_y +\\lambda_m+ \\varepsilon_{ym}\\]\nWhere:\n\n\\(\\text{HighTemp}_{ym}\\) represents the high temperature in year \\(y\\), month \\(m\\).\n\\(\\text{Treat}_{ym}\\) is the treatment indicator, taking a value of 1 if the site have planted tree, and 0 otherwise.\n\\(\\mathbf{X}_{ym}\\) includes a set of control variables, including precipitation, dew point, wind speed, pressure, and tree canopy coverage.\n\\(\\lambda_y\\) represents year fixed effects.\n\\(\\lambda_m\\) represents month fixed effects.\n\\(\\varepsilon_{ym}\\) is the error term.\n\\(\\beta\\) is the key coefficient, measuring the average treatment effect on temperature due to tree planting.\n\nAnd the dataset looks like:\n\n\nCode\nmatched_data &lt;- planting_in_buffer %&gt;%\n  mutate(ClosedDate = as.Date(ClosedDate)) %&gt;%\n  inner_join(all_sites_temp, by = c(\"Site\" = \"name\")) %&gt;%\n  filter(Date &gt;= (ClosedDate - 14) & Date &lt;= (ClosedDate + 14)) %&gt;%\n  mutate(treat = 15)\n         \n\nexcluded_sites_dates &lt;- matched_data %&gt;%\n  st_drop_geometry() %&gt;%\n  select(Site, Date, ClosedDate) %&gt;%\n  distinct()\n\nother_sites_data &lt;- all_sites_temp %&gt;%\n  filter(Date %in% matched_data$Date) %&gt;% \n  anti_join(excluded_sites_dates, by = c(\"name\" = \"Site\", \"Date\" = \"Date\")) %&gt;%\n  mutate(treat = 0) %&gt;%\n  rename(Site = name) %&gt;%\n  left_join(excluded_sites_dates %&gt;% select(Date, ClosedDate) %&gt;% st_drop_geometry() %&gt;% distinct(), by = \"Date\")\n\nmatched_data &lt;- matched_data  %&gt;%\n  st_drop_geometry() %&gt;% \n  bind_rows(other_sites_data)\n\ndid_input &lt;- matched_data %&gt;%\n  left_join(wu_buffer, by = \"Site\") %&gt;%\n  mutate(time = as.integer(Date - ClosedDate +15),\n         ClosedDate_id = as.integer(factor(ClosedDate)),\n         AvgPress = (HighPressure + LowPressure)/2) %&gt;%\n  filter(!is.na(AvgTemp) & !is.na(AvgDew) & !is.na(WindSpeed) & !is.na(Prcp) & !is.na(AvgPress) & !is.na(avg_canopy)) %&gt;%\n  mutate(Year = as.factor(year(ClosedDate)), Month = as.factor(month(ClosedDate)), Day = as.factor(day(ClosedDate))) %&gt;%\n  select(ClosedDate_id,ClosedDate, Year, Month,treat, time, AvgTemp, Prcp,AvgDew, WindSpeed , AvgPress, avg_canopy)\n\nhead(did_input)\n\n\n# A tibble: 6 × 12\n  ClosedDate_id ClosedDate Year  Month treat  time AvgTemp  Prcp AvgDew\n          &lt;int&gt; &lt;date&gt;     &lt;fct&gt; &lt;fct&gt; &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;\n1            87 2024-10-15 2024  10       15     1    17.9     0   14.4\n2            87 2024-10-15 2024  10       15     2    17       0   13.4\n3            87 2024-10-15 2024  10       15     3    18.6     0   14.6\n4            87 2024-10-15 2024  10       15     4    18.5     0   15.4\n5            87 2024-10-15 2024  10       15     5    20.3     0   13.2\n6            87 2024-10-15 2024  10       15     6    18.1     0   12.6\n# ℹ 3 more variables: WindSpeed &lt;dbl&gt;, AvgPress &lt;dbl&gt;, avg_canopy &lt;dbl&gt;\n\n\n\nClosedDate: This is the time when tree is planted.\ntreat: This is the time when a site becomes treated (tree planted in its buffer). For site that are never treated, this variable is set equal to 0.\ntime: record the time step in days (1-14 : pre-period for tree planting, 16-29: post-period).\n\n\nshort_did &lt;- att_gt(yname = \"AvgTemp\",\n                   gname = \"treat\",\n                   idname = \"ClosedDate_id\",\n                   tname = \"time\",\n                   xformla = ~ Year + Month + Prcp + AvgDew + WindSpeed + AvgPress + avg_canopy,\n                   data = did_input,\n                   panel = FALSE\n                   )\n\nagg.es &lt;- aggte(short_did, type = \"dynamic\")\n# summary(agg.es)\nggdid(agg.es, ylim = c(-.3, .3))\n\n\n\n\n\n\n\nFigure 3: Parallel trend test\n\n\n\n\n\n\n\nDiscussion and next step\nAfter conducting a preliminary DID (Difference-in-Differences) analysis, I found that the parallel trend assumption is not satisfied (Figure 3). I speculate there are several reasons for this:\n\nTheoretical Considerations: Tree planting may not induce short-term temperature changes. In reality, planting starts with saplings that are not yet capable of providing cooling effects.\n\nWould a long-term comparison be more effective, such as comparing the highest summer temperatures before planting with those in the years following planting?\n\nData Issues:\n\nSpatial Dispersion: Out of more than 80,000 trees, only 702 are located around 112 stations.\nThis also leads to a dispersion in planting times: when a planting event occurs, many stations do not experience any changes in tree planting.\nConsequently, in the DID calculation, the number of control and treatment groups is highly imbalanced.\nShould other meteorological data be used? Perhaps grid data with broader coverage?"
  },
  {
    "objectID": "urban_phenology_update.html",
    "href": "urban_phenology_update.html",
    "title": "Urban phenology updates - Share on lab meeting",
    "section": "",
    "text": "Phenology, the timing of periodic plant life cycle events, is sensitive to biotic and abiotic environment.\nSpatial unevenness of urban thermal environment might lead to the spatial heterogeneity of phenology.\n\nNegative correlation between the flowering date and the monthly mean LST in February–April.\n\n\n\n\n\n\n\nFigure 1: Katz et al., 2019\n\n\n\n\nA significant spatial variation for First flowing date of 35 species, which negatively correlated withdaily LST.\n\n\n\n\n\n\n\nFigure 2: Xing et al., 2022\n\n\n\nRequire phenology records and climate information within city:\n\nAs for phenology, we need broader data collection to capture a more comprehensive picture of vegetation and further enable city-to-city comparisons.\n\nMedium-resolution satellite data might fail to capture the fine-scale variations in tree phenology within the heterogeneous urban landscapes.\nGenus / Species information is lost in remote sensing data\n\nAs for urban micro-climate.\n\nLand surface temperature could not accurately represent tree growing environment.\nDecoupling between urban microclimates and surrounding free-air conditions."
  },
  {
    "objectID": "urban_phenology_update.html#introduction",
    "href": "urban_phenology_update.html#introduction",
    "title": "Urban phenology updates - Share on lab meeting",
    "section": "",
    "text": "Phenology, the timing of periodic plant life cycle events, is sensitive to biotic and abiotic environment.\nSpatial unevenness of urban thermal environment might lead to the spatial heterogeneity of phenology.\n\nNegative correlation between the flowering date and the monthly mean LST in February–April.\n\n\n\n\n\n\n\nFigure 1: Katz et al., 2019\n\n\n\n\nA significant spatial variation for First flowing date of 35 species, which negatively correlated withdaily LST.\n\n\n\n\n\n\n\nFigure 2: Xing et al., 2022\n\n\n\nRequire phenology records and climate information within city:\n\nAs for phenology, we need broader data collection to capture a more comprehensive picture of vegetation and further enable city-to-city comparisons.\n\nMedium-resolution satellite data might fail to capture the fine-scale variations in tree phenology within the heterogeneous urban landscapes.\nGenus / Species information is lost in remote sensing data\n\nAs for urban micro-climate.\n\nLand surface temperature could not accurately represent tree growing environment.\nDecoupling between urban microclimates and surrounding free-air conditions."
  },
  {
    "objectID": "urban_phenology_update.html#question-and-hypothesis",
    "href": "urban_phenology_update.html#question-and-hypothesis",
    "title": "Urban phenology updates - Share on lab meeting",
    "section": "Question and Hypothesis",
    "text": "Question and Hypothesis\n\nQuestion: What is the spatial heterogeneity of individual tree phenology from the same genus within a city, and across cities located in different climate regions?\nHypothesis: The heterogeneous urban landscape amplifies the variation of individual phenology within cities.\nGoal: Insights into how vegetation adapts to altered environmental conditions under urbanization and predict future pathways under global warming."
  },
  {
    "objectID": "urban_phenology_update.html#raw-data",
    "href": "urban_phenology_update.html#raw-data",
    "title": "Urban phenology updates - Share on lab meeting",
    "section": "1 Raw data",
    "text": "1 Raw data\n\n1.1 Read and clean the WU data (based on GHCNd)\nThe urban microclimate information comes from the Weather Underground program. There are 4 raw daily variables selected, i.e. AvgTemp, HighTemp, LowTemp and Precipitation_sum (Sum_mm). I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily GHCNd.\nFor initial analysis, I collect the date from 4 cities, i.e. New York, Houston, Detroit, and Seattle.\n\n\nCode\n# No. of WU sites\ndata &lt;- data.frame(\n  Category = c(\"DV\", \"NY\", \"ST\", \"HT\"),\n  Number_of_Sites = c(226, 148, 367, 171)\n)\nggplot(data, aes(x = Category, y = Number_of_Sites)) +\n  geom_bar(stat = \"identity\", fill = \"steelblue\") +\n  geom_text(aes(label = Number_of_Sites), vjust = -0.5, size = 4) +\n  labs(x = \"Category\", y = \"Number of Sites\") +\n    theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 18),\n        axis.title.y = element_text(size = 18),\n        title = element_text(size = 20)) +\n  theme_minimal()\n\n\n\n\n\n\n\n\nFigure 3: Number of WU sites in each city\n\n\n\n\n\n\n\n1.2 Shortwave data from Daymet\nTo control for the influence of other variables on phenology, I also incorporated shortwave radiation data derived from the Daymet daily dataset with a 1 km resolution. Shortwave radiation was extracted for the specific locations of the trees.\n\n\nCode\n# download\n\ncity = \"NY\"\ndata_dir &lt;- paste0(\"~/phenology-urban/data/raw/\", city, \"/Daymet/daily2016-2024/\")\nfile &lt;- list.files(data_dir, pattern = \"srad_daily_2023_ncss\\\\.nc$\", full.names = TRUE)\nsrad_nc &lt;- terra::rast(file)\n\nsrad_df &lt;- as.data.frame(srad_nc[[1]], xy = TRUE)\nggplot(srad_df, aes(x = x, y = y, fill = srad_1)) +\n  geom_raster() +\n  scale_fill_viridis_c(name = \"W/m²\") +\n  labs(title = \"Shortwave Radiation (W/m²) - 2023-01-01\", x = \"x\", y = \"y\") +\n  theme_minimal()\n\n\n\n\n\n\n\n\nFigure 4: The shortwave radiation raster in 2023-01-01, NY\n\n\n\n\n\n\n\n1.3 Select the street tree base on WU data\nI used the street tree in the above 4 cities, with the phenology records established by Yiluan. These trees are part of the whole inventory, covering 14 genera and being sampled. I select the trees which are within 500 m buffer around the Weather Underground sites (see Figure 5).\n\n\nCode\ncities = c(\"NY\", \"HT\", \"DV\", \"ST\")\nplots = list()\n\nfor (city in cities){\n  points_in_buffer &lt;- read_csv(paste0(\"~/phenology-urban/data/proc/urban/\",city,\"/tree_WU_500_buffer_PS.csv\"), show_col_types = FALSE)\n  points_in_buffer_sf &lt;- points_in_buffer %&gt;%\n    st_as_sf(coords = c(\"lon\", \"lat\"), crs = 4326)\n  # us_boundary &lt;- st_read(\"~/urban-niche/data/raw/CONUS/boundary/us_boundarydissolve.shp\") %&gt;%\n  #     st_transform(4326)\n  \n  boundary &lt;- switch(\n    city,\n    \"NY\" = st_read(\"~/urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp\",quiet = TRUE) %&gt;%\n      st_transform(4326),\n    \"DT\" = st_read(\"~/urban-cooling/data/raw/WU/DT/City_of_Detroit_Boundary/City_of_Detroit_Boundary.shp\",quiet = TRUE) %&gt;%\n      st_transform(4326),\n    \"ST\" = st_read(\"~/urban-cooling/data/raw/WU/ST/seattle_boundary/CityUGA.shp\",quiet = TRUE) %&gt;%\n      st_transform(4326) %&gt;%\n      filter(CITY_NM == \"Seattle\"),\n    \"HT\" = st_read(\"~/urban-cooling/data/raw/WU/HT/HGAC_City_Boundaries/HGAC_City_Boundaries.shp\",quiet = TRUE) %&gt;%\n      filter(NAME == \"Houston\") %&gt;%\n      st_transform(4326),\n    \"TP\" = st_read(\"~/urban-cooling/data/raw/WU/TP/Municipal_Boundary/Municipal_Boundary.shp\") %&gt;%\n      st_transform(4326) %&gt;%\n      filter(NAME == \"Tampa\"),\n    \"DV\" = st_read(\"~/urban-cooling/data/raw/WU/DV/DRCOG_Municipalities/DRCOG_Municipalities.shp\",quiet = TRUE) %&gt;%\n      filter(city == \"Denver\") %&gt;%\n      st_transform(4326),\n    \"AT\" = st_read(\"~/urban-cooling/data/raw/WU/AT/TxDOT_City_Boundaries/Cities.shp\",quiet = TRUE) %&gt;%\n      filter(CITY_NM == \"Austin\") %&gt;%\n      st_transform(4326),\n    stop(\"Invalid city abbreviation.\")\n  )\n  \n  wu_location &lt;- read_csv(paste0(\"~/urban-cooling/data/raw/WU/\", city, \"/location.csv\"), show_col_types = FALSE) %&gt;%\n    st_as_sf(coords = c(\"Lon\", \"Lat\"), crs = 4326)\n  \n  p = ggplot() +\n    geom_sf(data = boundary, fill = \"grey90\") +\n    # geom_sf(data = us_boundary, color = \"blue\", size = 1) +\n    geom_sf(data = wu_location, color = \"blue\", size = 0.5) +\n    geom_point(data = points_in_buffer, aes(x = lon, y = lat), color = \"red\",size = 0.01, alpha = 0.01) +\n    labs(title = city) +\n    theme_minimal()+\n    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1))\n  plots[[city]] = p\n}\n\n\ncombined_plot &lt;- wrap_plots(plots, ncol = 2)\ncombined_plot\n\n\n\n\n\n\n\n\nFigure 5: Location of WU sites and trees"
  },
  {
    "objectID": "urban_phenology_update.html#method",
    "href": "urban_phenology_update.html#method",
    "title": "Urban phenology updates - Share on lab meeting",
    "section": "2 Method",
    "text": "2 Method\n\n2.1 Phenological indicators\nThe tree locations points were overlapped with Planetscope imageries to extract the reflectance values. After smoothing and regression, we could get the EVI curve. The phenological metrics were calculated based on the EVI curve:\n\n\n\n\n\n\nFigure 6: Extract reflectance from PlanetScope based on tree location, an example in NY\n\n\n\n\n\n\n\n\n\nFigure 7: Phenology metrics calculated based on EVI curve from PlanetScope\n\n\n\n\nSpring phenology\n\nSOS: Defined as the day of year when individual tree growing season EVI curves first cross the green-up 50% threshold.\nGreen-up Pace: Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-up 20% threshold to the 80% threshold.\n\nFall phenology\n\nEOS: Defined as the day of year when individual tree growing season EVI curves first cross the green-down 50% threshold.\nGreen-down Pace: Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-down 20% threshold to the 80% threshold.\n\n\n\n\n2.2 Optimal preseason length calculated by Tempavg\nDefined as the period (5-180 days, with 5-day steps) before phenological event for which the partial correlation coefficient between mean phenological event date and average temperature was highest, controlling other climate variables. Meng et al., 2020, Yin et al., 2024\n\n\n\n\n\n\nFigure 8: Conceptual diagram for optimal preseason\n\n\n\nFigure 9 displays the distribution of optimal preseason length and partial correlation coefficient calculated by Tempavg for SOS, Greenup pace, EOS and Greenup pace, respectively.\nOptimal preseason length for spring phenology varies among genera. As for SOS, all genera have negetive partial correlation coefficients, which means the higher preseason average temperature, the earlier start of season. As for Greenup pace, most genera (except Carya, Celtis) have negetive partial correlation coefficients, which means the higher preseason average temperature, the faster green up pace. The preseason length varies significantly among genera.\nBoth the optimal preseason length for fall phenology and the response direction vary significantly among genera. As for EOS, most genera (except Populus, Platanus) have positive partial correlation coefficients, which means the higher preseason average temperature, the later end of season. As for Greenup pace, there is variation in impact direction among genera. The preseason length also varies significantly among genera.\n\nCode\ntavg_allyear_pcorr &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\",city,\"/tavg_allyear_pcorr.rds\")) %&gt;%\n  mutate(\n    # Create a flag for optimal_pre_length\n    is_optimal = ifelse(pre_length_candidate == optimal_pre_length, TRUE, FALSE),\n    # Create a flag for significant pvalue\n    is_significant = ifelse(pvalue_trend &lt; 0.05, TRUE, FALSE),\n    # Adjust transparency\n    alpha = ifelse(is_optimal, 1, 0.2),\n    shape = ifelse(is_significant, 21, 1),\n    size = ifelse(is_optimal, 4, 1.2)\n  ) %&gt;%\n  mutate(shape = factor(shape, levels = c(21, 1)),\n         size = factor(size, levels = c(1.2, 4)))\n  \n\n# Create the plot\nsos_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"SOS\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, shape = shape, size = size)) +  # Add points with alpha and fill\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Start of season\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n  \ngreenup_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"green-up pace\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Green-up pace\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\neos_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"EOS\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"End of season\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\n\ngreendown_p &lt;- ggplot((tavg_allyear_pcorr %&gt;% filter(type == \"green-down pace\")), aes(x = pre_length_candidate, y = pre_length_trend, color = genus, fill = genus, group = genus)) +\n  geom_line(aes(alpha = 0.1)) +  # Add lines for trends\n  geom_point(aes(alpha = alpha, size = size, shape = shape)) +  # Add points with alpha and fill\n    geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  scale_alpha_identity() +  # Use the alpha values directly\n  scale_shape_manual(\n    name = \"Significance\", \n    values = c(21, 1),\n    labels = c(\"p &lt;= 0.05\", \"p &gt; 0.05\")   \n    ) +\n  scale_size_manual(\n    name = \"Pre-season length\",  \n    values = c(1.2, 4), \n    labels = c(\"Others\", \"Optimal preseason length\")\n  ) +\n  guides(\n    shape = guide_legend(override.aes = list(fill = c(\"black\", NA),color = \"black\")))+\n  labs(\n    title = \"Green-down pace\",\n    x = \"Pre-season length\",\n    y = \"Partial correlation coefficient\"\n  ) +\n  theme_minimal() +\n  theme(legend.position = \"right\",\n        axis.title.x = element_text(size = 14), \n        axis.title.y = element_text(size = 14),\n        title = element_text(size = 14))\n\nsos_p + greenup_p + plot_layout(guides = \"collect\") & theme(legend.position = \"right\")\neos_p + greendown_p + plot_layout(guides = \"collect\") & theme(legend.position = \"right\")\n\n\n\n\n\n\n\n\n\n\n\n\n(a) Spring phenology\n\n\n\n\n\n\n\n\n\n\n\n\n\n(b) Fall phenology\n\n\n\n\n\n\n\nFigure 9: Distribution of partial correlation coefficient and preseason length, calculated by Tempavg\n\n\n\n\n\n2.3 Brief summary of the data\nSo far, we have collected the phenology records and preseason climate information. The overall data variation is shown as below:\n\n\nCode\nfixed_genera &lt;- c(\"Acer\", \"Alnus\", \"Betula\", \"Carya\", \"Celtis\", \"Fraxinus\", \n                  \"Juglans\", \"Liquidambar\", \"Morus\", \"Platanus\", \"Populus\", \n                  \"Quercus\", \"Salix\", \"Ulmus\")\ncolor_palette &lt;- setNames(viridis(length(fixed_genera)), fixed_genera)\n\nplots &lt;- map(cities, function(city){\n  tavg_allyear_var &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\", city, \"/tavg_allyear_var.rds\"))\n  \n  phe_type = \"SOS\"\n  if (phe_type == \"SOS\") {\n    phe_metric &lt;- \"doy\"\n    direction &lt;- \"up\"\n    thres &lt;- 0.5\n  } else if (phe_type == \"EOS\") {\n    phe_metric &lt;- \"doy\"\n    direction &lt;- \"down\"\n    thres &lt;- 0.5\n  } else if (phe_type == \"GreenUp\") {\n    phe_metric &lt;- \"doy_diff\"\n    direction &lt;- \"up\"\n    thres &lt;- 0.2\n    tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n  } else {\n    phe_metric &lt;- \"doy_diff\"\n    direction &lt;- \"down\"\n    thres &lt;- 0.2\n    tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n  }\n  \n  tavg_allyear_var &lt;- tavg_allyear_var %&gt;%\n      filter(direction == !!direction & thres == !!thres) %&gt;%\n      na.omit()\n  \n  doy_temp_summary &lt;- tavg_allyear_var %&gt;%\n    group_by(genus) %&gt;%\n    summarise(\n      mean_doy = mean(doy, na.rm = TRUE),\n      IQR_d = quantile(doy, 0.75, na.rm = TRUE) - quantile(doy, 0.25, na.rm = TRUE),\n      lower_whisker_d = max(quantile(doy, 0.25, na.rm = TRUE) - 1.5 * IQR_d, min(doy, na.rm = TRUE)),\n      upper_whisker_d = min(quantile(doy, 0.75, na.rm = TRUE) + 1.5 * IQR_d, max(doy, na.rm = TRUE)),\n      mean_temp = mean(AvgTemp_mean, na.rm = TRUE),\n      IQR_t = quantile(AvgTemp_mean, 0.75, na.rm = TRUE) - quantile(AvgTemp_mean, 0.25, na.rm = TRUE),\n      lower_whisker_t = max(quantile(AvgTemp_mean, 0.25, na.rm = TRUE) - 1.5 * IQR_t, min(AvgTemp_mean, na.rm = TRUE)),\n      upper_whisker_t = min(quantile(AvgTemp_mean, 0.75, na.rm = TRUE) + 1.5 * IQR_t, max(AvgTemp_mean, na.rm = TRUE))\n    )\n  \n  ggplot(doy_temp_summary, aes(x = mean_temp, y = mean_doy, color = genus)) +\n    geom_point(size = 3) +\n    geom_errorbar(aes(ymin = lower_whisker_d, ymax = upper_whisker_d), width = 0.2, linewidth = 1, alpha = 0.5) +\n    geom_errorbarh(aes(xmin = lower_whisker_t, xmax = upper_whisker_t), height = 1, linewidth = 1,  alpha = 0.5) +\n    scale_color_manual(values = color_palette) + \n    labs(x = \"Average preseason temperature\", y = \"SOS\", title = city) +\n    theme_minimal() +\n    theme(axis.text.x = element_text(size = 10),\n          axis.text.y = element_text(size = 10),\n          title = element_text(size = 14),\n          legend.position = \"right\")\n  })\n\nwrap_plots(plots, ncol = 2) + plot_layout(guides = \"collect\")  & \n  theme(legend.position = \"right\")\n\n\n\n\n\nThe variation range of phenology (e.g., SOS) and preseason temperature (AvgTemp) in different cities\n\n\n\n\n\n\n2.4 Spatial model\nI modeled the relationship between the phenology and environmental covariates using a spatial hierarchical model. The response variable (phenology parameter) at location \\(\\mathbf{s}_i\\) and in year \\(\\mathbf{t}\\), denoted as \\(y(\\mathbf{s}_i, \\mathbf{t})\\), was modeled as following model:\nModel: (current use)\n\\[y(\\mathbf{s}_i, \\mathbf{t}) = \\mu(\\mathbf{s}_i,\\mathbf{t}) + w(\\mathbf{s}_i) + u(\\mathbf{t}) + \\epsilon(\\mathbf{s}_i, \\mathbf{t})\\]\nwhere:\n\nFixed Effects: \\[\\mu(\\mathbf{s}_i,\\mathbf{t}) = \\mathbf{X}_{\\mathbf{s}_i,\\mathbf{t}} \\boldsymbol{\\beta}\\]\n\n\\(\\mathbf{X}_{\\mathbf{s}_i,\\mathbf{t}} = [1, \\text{AvgTemp}_{\\mathbf{s}_i,\\mathbf{t}}, \\text{Precp}_{\\mathbf{s}_i,\\mathbf{t}}, \\text{srad}_{\\mathbf{s}_i,\\mathbf{t}}]\\) is the design matrix of predictors.\n\\(\\boldsymbol{\\beta} = [\\beta_0, \\beta_1, \\beta_2, \\beta_3]\\) are the regression coefficients for the intercept and covariates.\n\\(\\beta_1\\) is the coefficient for the average temperature, which is the main interest in this study.\n\nSpatially Correlated Random Effect: \\[w(\\mathbf{s}_i) \\sim \\text{MVN}(\\mathbf{0}, \\mathbf{R})\\]\n\n\\(\\mathbf{R}\\) is the spatial correlation matrix defined by a covariance function.\nIn MCMC, I chose the optimal covariance function based on the variogram fitting:\n\nMatérn Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\frac{2^{1-\\nu}}{\\Gamma(\\nu)} \\left(\\frac{\\sqrt{2\\nu} D_{ij}}{\\rho}\\right)^\\nu K_\\nu\\left(\\frac{\\sqrt{2\\nu} D_{ij}}{\\rho}\\right)\\]\nExponential Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\exp(-\\phi D_{ij})\\]\nGaussian Covariance Function (if selected): \\[\\mathbf{R}_{ij} = \\sigma^2 \\cdot \\exp(-\\phi D_{ij}^2)\\]\nSpherical Covariance Function (if selected):\n\n\\[\\mathbf{R}_{ij} =\n        \\begin{cases}\n        \\sigma^2 \\cdot \\left(1 - \\frac{3 D_{ij}}{2\\rho} + \\frac{D_{ij}^3}{2\\rho ^3}\\right), & D_{ij} \\leq \\rho \\\\\n        0, & D_{ij} &gt; \\rho\n        \\end{cases}\\]\nIn INLA, a spatial process with a Matérn covariance can be obtained as the weak solution to a stochastic partial differential equation (SPDE). The SPDE method uses the Finite Element Method (FEM) to approximate a spatial Gaussian Random Field (GRF). It constructs a triangulated mesh, where each node serves as a basis for interpolation. Basis functions are defined to be 1 at a node and decay to 0 at neighboring triangles, ensuring local influence. By discretizing the SPDE, the problem transforms into a sparse Gaussian Markov Random Field (GMRF), making computations more efficient for large spatial datasets.\n\nYear-specific Random Effect: \\[u(\\mathbf{t}) \\sim \\text{N}(0, \\tau^2_{\\mathbf{t}})\\]\n\n\\(u_{\\mathbf{t}}\\) captures year-to-year variability, with \\(\\tau^2_{\\mathbf{t}}\\) being the variance of the year effect.\n\nIndependent Nugget Effect: \\[\\epsilon(\\mathbf{s}_i) \\sim \\text{N}(0, \\tau^2)\\]\n\n\\(\\epsilon(\\mathbf{s}_i, \\mathbf{t})\\) accounts for measurement error or small-scale variability.\n\n\nGet the posterior distribution of model parameters:\n\nMCMC: In NIMBLE package, the MCMC algorithm was used to sample from the posterior distribution of the model parameters.\nINLA: In INLA package, the Integrated Nested Laplace Approximation (INLA) was used to approximate the posterior distribution of the model parameters. Rather than estimating the joint posterior distribution of the parameters via MCMC, INLA focusing on individual posterior marginals of the model parameters, which is enough to make inference of the model parameters and latent effects in most cases."
  },
  {
    "objectID": "urban_phenology_update.html#results",
    "href": "urban_phenology_update.html#results",
    "title": "Urban phenology updates - Share on lab meeting",
    "section": "3 Results",
    "text": "3 Results\n\n3.1 SOS in NYC\n\n3.1.1 MCMC\nCode example:\n\n  #################### Model Specification ####################\n  \nmodel_code &lt;- nimbleCode({\n    for (i in 1:N) {\n      y[i] ~ dnorm(mu[i], tau)\n      mu[i] &lt;- inprod(X[i, 1:P], beta[]) + spatial_effect[i] + year_effect[year[i]]\n    }\n    for (q in 1:nyears) {\n      year_effect[q] ~ dnorm(0, sd = sqrt(tau.year))\n    }\n    for (j in 1:P) {\n      beta[j] ~ dnorm(0, sd = 1000)\n    }\n    spatial_effect[1:N] ~ dmnorm(Mu[1:N], cov = cov_matrix[1:N, 1:N])\n    \n    ### Choose the covariance function based on variogram fitting\n    if (N_knots &lt;= N_unique){\n      if (cov_type == \"Mat\") {\n        knots_cov_matrix[1:N_knots, 1:N_knots] &lt;- matern_covariance(knots_dist_matrix[1:N_knots, 1:N_knots], range, sigma.sq, nu) + I[1:N_knots, 1:N_knots]\n        data_knots_cov_matrix[1:N, 1:N_knots] &lt;- matern_covariance(data_knots_dist_matrix[1:N, 1:N_knots], range, sigma.sq, nu)\n      } else if (cov_type == \"Gau\") {\n        knots_cov_matrix[1:N_knots, 1:N_knots] &lt;- sigma.sq * exp(-phi * knots_dist_matrix[1:N_knots, 1:N_knots]^2) + I[1:N_knots, 1:N_knots]\n        data_knots_cov_matrix[1:N, 1:N_knots] &lt;- sigma.sq * exp(-phi * data_knots_dist_matrix[1:N, 1:N_knots]^2)\n      } else if (cov_type == \"Exp\") {\n        knots_cov_matrix[1:N_knots, 1:N_knots] &lt;- sigma.sq * exp(-phi * knots_dist_matrix[1:N_knots, 1:N_knots]) + I[1:N_knots, 1:N_knots]\n        data_knots_cov_matrix[1:N, 1:N_knots] &lt;- sigma.sq * exp(-phi * data_knots_dist_matrix[1:N, 1:N_knots])\n      } else if (cov_type == \"Sph\") {\n        knots_cov_matrix[1:N_knots, 1:N_knots] &lt;- spherical_covariance(knots_dist_matrix[1:N_knots, 1:N_knots], range, sigma.sq) + I[1:N_knots, 1:N_knots]\n        data_knots_cov_matrix[1:N, 1:N_knots] &lt;- spherical_covariance(data_knots_dist_matrix[1:N, 1:N_knots], range, sigma.sq)\n      }\n      knots_cov_chol_inv[1:N_knots, 1:N_knots] &lt;- inverse(chol(knots_cov_matrix[1:N_knots, 1:N_knots]))\n      cov_matrix[1:N, 1:N] &lt;- data_knots_cov_matrix[1:N, 1:N_knots] %*% \n        knots_cov_chol_inv[1:N_knots, 1:N_knots] %*% t(knots_cov_chol_inv[1:N_knots, 1:N_knots]) %*% \n        t(data_knots_cov_matrix[1:N, 1:N_knots]) + I[1:N, 1:N]\n    } else {\n      if (cov_type == \"Mat\") {\n        cov_matrix[1:N, 1:N] &lt;-  matern_covariance(dist_matrix[1:N, 1:N], range, sigma.sq, nu) + I[1:N, 1:N]\n      } else if (cov_type == \"Gau\") {\n        cov_matrix[1:N, 1:N] &lt;- sigma.sq * exp(-phi * dist_matrix[1:N, 1:N]^2) + I[1:N, 1:N]\n      } else if (cov_type == \"Exp\") {\n        cov_matrix[1:N, 1:N] &lt;- sigma.sq * exp(-phi * dist_matrix[1:N, 1:N]) + I[1:N, 1:N]\n      } else if (cov_type == \"Sph\") {\n        cov_matrix[1:N, 1:N] &lt;- spherical_covariance(dist_matrix[1:N, 1:N], range, sigma.sq) + I[1:N, 1:N]\n      }\n    }\n    \n    ### Priors\n      \n    tau ~ dgamma(0.001, 0.001)\n    sigma.sq ~ dinvgamma(2.5, 120)\n    phi ~ dunif(5 / 1, 5 / 0.1)\n    tau.year ~ dinvgamma(2.001, 0.667)\n    range ~ dunif(0, 1)\n    nu ~ dunif(0.5, 5)\n  })\n  \n  ### Data inputs\n  \n  nyears &lt;- length(unique(tavg_phe_df$year))\n  X &lt;- model.matrix(sp_formula, data = tavg_phe_df)\n  y &lt;- tavg_phe_df[[all.vars(sp_formula)[1]]]\n  year_index &lt;- as.integer(factor(tavg_phe_df$year))  # Create fixed year indices\n  data &lt;- list(y = y, X = X)  # Remove 'year' from data\n  inits &lt;- list(\n    beta = rep(0, ncol(X)),\n    tau = 1, sigma.sq = 80, phi = 25, tau.year = 1,\n    range = 0.5,\n    spatial_effect = rep(0, N), \n    nu = 1,\n    year_effect = rep(0, nyears)\n  )\n  \n  ### Change based on semi-variogram fitting\n  constants &lt;- list(N = N, N_knots = N_knots, N_unique = N_unique, P = ncol(X), Mu = rep(0, N), nyears = nyears, \n                    dist_matrix = dist_matrix, knots_dist_matrix = knots_dist_matrix, \n                    data_knots_dist_matrix = data_knots_dist_matrix,\n                    year = year_index, I = diag(1e-6,N), cov_type = cov_type)  # Add 'year' to constants\n  monitors &lt;- switch(\n    cov_type,\n    \"Mat\" = c(\"beta\", \"tau.year\", \"range\", \"sigma.sq\", \"nu\", \"spatial_effect\", \"year_effect\"),\n    \"Gau\" = c(\"beta\", \"tau\", \"sigma.sq\", \"phi\", \"tau.year\", \"spatial_effect\", \"year_effect\"),\n    \"Exp\" = c(\"beta\", \"tau\", \"sigma.sq\", \"phi\", \"tau.year\", \"spatial_effect\", \"year_effect\"),\n    \"Sph\" = c(\"beta\", \"tau.year\", \"range\", \"sigma.sq\", \"spatial_effect\", \"year_effect\"),\n    stop(\"Unknown cov_type!\")\n  )\n  \n  ni &lt;- 10000   # nb iterations \n  nt &lt;- 50       # thinning interval\n  nb &lt;- ni / 2    # nb iterations as burn-in \n  nc &lt;- 1         # nb chains\n  \n  \n  #################### Run/Save the model ####################\n  \n  modelMCMCrun &lt;- nimbleMCMC(code = model_code, data = data, constants = constants, inits = inits, \n                             monitors = monitors,\n                             niter = ni, nburnin = nb, thin = nt, nchains = nc, setSeed = 2025,\n                             progressBar = TRUE, \n                             samplesAsCodaMCMC = TRUE, \n                             summary = TRUE, \n                             WAIC = TRUE)\n\nMost genera showed negative association between temperature and the start of season, suggesting the warmer preseason, the earilier start of season. Only Fraxinus had a positive association, with a median coefficient of 0.15. There are significant genus-level differences in how temperature influences the spring phenology.\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/year_random/\"\n\nfiles &lt;- list.files(dir_path, pattern = \"^NY.*SOS\\\\.rds$\", full.names = TRUE)\nplots &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\".*NY_(.*?)_tavg_SOS\\\\.rds\", \"\\\\1\", basename(file))\n  beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n  param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n    filter(Parameter == \"AvgTemp\")\n  beta_median &lt;- median(param_data$value)\n  p &lt;- param_data %&gt;%\n    ggs_density() +\n    theme_bw() +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme(plot.title = element_text(hjust = 0.5)) +\n    annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4)\n  plots[[genus]] &lt;- p\n}\n\ncombined_plot &lt;- wrap_plots(plots, ncol = 5)\ncombined_plot\n\n\n\n\n\n\n\n\nFigure 10: The density of the posterior distribution of regression coefficients for Temp~avg~ with SOS as the response variable for each genus in New York city, generated via MCMC.\n\n\n\n\n\nAs for the spatial field, only Salix seems to be ideal. Other genera exhibit either uniform spatial effects or noticeable local variations, even extremely high value.\n\n\nCode\nspherical_covariance &lt;- function(d, range, sigma.sq) {\n  result &lt;- matrix(0, nrow = nrow(d), ncol = ncol(d))\n  for (i in 1:nrow(d)) {\n    for (j in 1:ncol(d)) {\n      if (d[i, j] &lt;= range) {\n        result[i, j] &lt;- sigma.sq * (1 - (3 * d[i, j] / (2 * range)) + (d[i, j]^3 / (2 * range^3)))\n      } else {\n        result[i, j] &lt;- 0.0\n      }\n    }\n  }\n  return(result)\n}\n\nmatern_covariance &lt;- function(d, range, sigma.sq, nu) {\n  result &lt;- matrix(0, nrow = nrow(d), ncol = ncol(d))\n  for (i in 1:nrow(d)) {\n    for (j in 1:ncol(d)) {\n      if (d[i, j] == 0) {\n        result[i, j] &lt;- 0.0\n      } else {\n        part &lt;- (2^(1 - nu)) / gamma(nu) * (sqrt(2 * nu) * d[i, j] / range)^nu\n        result[i, j] &lt;- sigma.sq * part * besselK(sqrt(2 * nu) * d[i, j] / range, nu)\n      }\n    }\n  }\n  return(result)\n}\n\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/year_random/\"\ncity = \"NY\"\nphe_type = \"SOS\"\nif (phe_type == \"SOS\") {\n  phe_metric &lt;- \"doy\"\n  direction &lt;- \"up\"\n  thres &lt;- 0.5\n} else if (phe_type == \"EOS\") {\n  phe_metric &lt;- \"doy\"\n  direction &lt;- \"down\"\n  thres &lt;- 0.5\n} else if (phe_type == \"GreenUp\") {\n  phe_metric &lt;- \"doy_diff\"\n  direction &lt;- \"up\"\n  thres &lt;- 0.2\n  tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n} else {\n  phe_metric &lt;- \"doy_diff\"\n  direction &lt;- \"down\"\n  thres &lt;- 0.2\n  tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n}\n\npattern = paste0(\"^\",city,\".*\",phe_type,\"\\\\.rds$\")\nfiles &lt;- list.files(dir_path, pattern = \"^NY.*SOS\\\\.rds$\", full.names = TRUE)\nplots_mean &lt;- list()\nplots_sd &lt;- list()\nplots_extend &lt;- list()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  \n  spatial_mean &lt;- model_data$summary[grep(\"spatial_effect\", rownames(model_data$summary)), \"Mean\"]\n  spatial_sd &lt;- model_data$summary[grep(\"spatial_effect\", rownames(model_data$summary)), \"St.Dev.\"]\n  \n  tavg_allyear_var &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\", city, \"/tavg_allyear_var.rds\"))  %&gt;%\n    filter(direction == !!direction & thres == !!thres & genus == !!genus) %&gt;%\n    na.omit()\n  # %&gt;%\n  #   st_as_sf(coords = c(\"lon\", \"lat\"), crs = 4326)\n  # \n  OLS_formula &lt;- as.formula(paste0(phe_metric, \" ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year)\"))\n  random_OLS &lt;- lmer(OLS_formula, data = tavg_allyear_var)\n  tavg_allyear_var$residual_random &lt;- tavg_allyear_var[[phe_metric]] - fitted(random_OLS)\n  coordinates(tavg_allyear_var) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_allyear_var, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  cov_type &lt;- as.character(vgm_exn_fit$model)\n  \n  \n  tavg_allyear_var &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\", city, \"/tavg_allyear_var.rds\"))  %&gt;%\n    filter(direction == !!direction & thres == !!thres & genus == !!genus) %&gt;%\n    na.omit()\n    \n  monitors &lt;- switch(\n    cov_type,\n    \"Mat\" = c(\"range\", \"sigma.sq\", \"nu\"),\n    \"Gau\" = c(\"tau\", \"sigma.sq\", \"phi\"),\n    \"Exp\" = c(\"tau\", \"sigma.sq\", \"phi\"),\n    \"Sph\" = c(\"range\", \"sigma.sq\"),\n    stop(\"Unknown cov_type!\")\n  )\n  params &lt;- list(range = NULL, sigma.sq = NULL, nu = NULL, phi = NULL)\n  for (param in names(params)) {\n    if (param %in% monitors) {\n      params[[param]] &lt;- model_data$summary[grep(param, rownames(model_data$summary)), \"Mean\"]\n    }\n  }\n  grid &lt;- expand.grid(\n    lon = seq(min(tavg_allyear_var$lon), max(tavg_allyear_var$lon), length.out = 100),\n    lat = seq(min(tavg_allyear_var$lat), max(tavg_allyear_var$lat), length.out = 100)\n    )\n  coords_known &lt;- tavg_allyear_var[, c(\"lon\", \"lat\")]\n  coords_pred &lt;- grid[, c(\"lon\", \"lat\")]\n  dist_matrix &lt;- as.matrix(dist(coords_known))\n  dist_matrix_known_pred &lt;- as.matrix(dist(rbind(coords_pred, coords_known)))[1:nrow(coords_pred), (nrow(coords_pred) + 1):(nrow(coords_pred) + nrow(coords_known))]\n  \n  if (cov_type == \"Mat\") {\n      cov_matrix &lt;- matern_covariance(dist_matrix, params$range, params$sigma.sq, params$nu)\n  } else if (cov_type == \"Gau\") {\n      cov_matrix &lt;- params$sigma.sq * exp(-params$phi * dist_matrix^2)\n  } else if (cov_type == \"Exp\") {\n      cov_matrix &lt;- params$sigma.sq * exp(-params$phi * dist_matrix)\n  } else if (cov_type == \"Sph\") {\n      cov_matrix &lt;- spherical_covariance(d = dist_matrix, range = params$range, sigma.sq = params$sigma.sq)\n  }\n  cov_matrix &lt;- cov_matrix + diag(1e-6, nrow(dist_matrix))\n  \n  if (cov_type == \"Mat\") {\n      cov_matrix_pred &lt;- matern_covariance(dist_matrix_known_pred, params$range, params$sigma.sq, params$nu)\n  } else if (cov_type == \"Gau\") {\n      cov_matrix_pred &lt;- params$sigma.sq * exp(-params$phi * dist_matrix_known_pred^2)\n  } else if (cov_type == \"Exp\") {\n      cov_matrix_pred &lt;- params$sigma.sq * exp(-params$phi * dist_matrix_known_pred)\n  } else if (cov_type == \"Sph\") {\n      cov_matrix_pred &lt;- spherical_covariance(d = dist_matrix_known_pred, range = params$range, sigma.sq = params$sigma.sq)\n  }\n  \n  spatial_effect_pred &lt;- cov_matrix_pred %*% solve(cov_matrix) %*% spatial_mean\n  \n  grid$spatial_effect &lt;- spatial_effect_pred\n  p &lt;- ggplot(grid, aes(x = lon, y = lat, fill = spatial_effect)) +\n    geom_tile() +\n    scale_fill_gradient(low = \"white\", high = \"red\") +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme_minimal() +\n    labs(fill = \"Mean\") +\n    theme(axis.text.x = element_text(angle = 45, hjust = 1))\n  \n  plots_extend[[genus]] &lt;- p\n\n  # tavg_allyear_var$spatial_mean &lt;- spatial_mean\n  # tavg_allyear_var$spatial_sd &lt;- spatial_sd\n  # \n  # p_mean &lt;- ggplot() +\n  #   geom_point(data = tavg_allyear_var, aes(x = lon, y = lat, color = spatial_mean), size = 2) +\n  #   scale_color_gradient2(low = \"blue\", mid = \"white\", high = \"red\", midpoint = 0) +\n  #   theme_minimal() +\n  #   ggtitle(paste(\"Genus:\", genus)) +\n  #   labs(color = \"Mean\")\n  # p_sd &lt;- ggplot() +\n  #   geom_point(data = tavg_allyear_var, aes(x = lon, y = lat, color = spatial_sd), size = 2) +\n  #   scale_color_gradient(low = \"white\", high = \"red\") +\n  #   theme_minimal() +\n  #   ggtitle(paste(\"Genus:\", genus)) +\n  #   labs(color = \"SD\")\n  # plots_mean[[genus]] &lt;- p_mean\n  # plots_sd[[genus]] &lt;- p_sd\n}\n\ncombined_plot_extend &lt;- wrap_plots(plots_extend, ncol = 5)\ncombined_plot_extend\n\n\n\n\n\n\n\n\nFigure 11: Spatial fields, generated via MCMC\n\n\n\n\n\n\n\n3.1.2 INLA\nCode example:\n\n#################### Prepare the mesh and spde ####################\n### Build the mesh \ncoord &lt;- cbind(tavg_allyear_var$lon, tavg_allyear_var$lat) # coordinates of observations\ndomain &lt;- inla.nonconvex.hull(as.matrix(coord),\n                              concave = -.07,convex = -0.05, resolution=c(100,100))\n\nmesh &lt;- inla.mesh.2d(boundary = domain, loc = coord,\n                     max.edge = c(10000, 20000), \n                     cutoff = 1000 # prevent close points from being connected\n)\n# mesh$n\n# ggplot() +\n#   geom_sf(data=ny_boundary,color='turquoise',fill='transparent') +\n#   gg(mesh) +\n#   geom_sf(data=tavg_allyear_var_sf,col='purple',size=1.7,alpha=0.5)\n\n### Build the spde \n\nspde &lt;- inla.spde2.matern(mesh = mesh, alpha = 2, constr = TRUE)\nA.phe &lt;- inla.spde.make.A(mesh = mesh, loc = coord)\ns.index &lt;- inla.spde.make.index(name = \"spatial.field\",\n                                n.spde = spde$n.spde)\n# dim(A.phe)\n\ncoorp &lt;- cbind(prediction$Lon, prediction$Lat) \nA.phe.p &lt;- inla.spde.make.A(mesh = mesh, loc = coorp)\n\n#################### Stack the data ####################\nstk.e &lt;- inla.stack(\n  tag = \"est\",\n  data = list(y = tavg_allyear_var[[phe_metric]]),\n  A = list(1, A.phe),\n  effects = list(data.frame(Intercept = rep(1, nrow(coord)),\n                            AvgTemp_mean = tavg_allyear_var$AvgTemp_mean,\n                            Sum_mm_sum = tavg_allyear_var$Sum_mm_sum,\n                            srad_mean = tavg_allyear_var$srad_mean,\n                            year = tavg_allyear_var$year), \n                 s = s.index)\n)\n\n\nstk.p &lt;- inla.stack(\n  tag = \"pred\",\n  data = list(y = NA),\n  A = list(1, A.phe.p),\n  effects = list(data.frame(Intercept = rep(1, nrow(coorp)),\n                            AvgTemp_mean = prediction$AvgTemp_mean,\n                            Sum_mm_sum = prediction$Sum_mm_sum,\n                            srad_mean = prediction$srad_mean,\n                            year = prediction$year), \n                 s = s.index)\n)\n\n# stk.full has stk.e and stk.p\nstk.full &lt;- inla.stack(stk.e, stk.p)\n\n#################### Run/Save the model ####################\n### Run the model\nformula &lt;- y ~ 0 + Intercept + AvgTemp_mean + Sum_mm_sum + srad_mean + f(year, model = 'iid') + f(spatial.field, model = spde)\n\nres &lt;- inla(formula,\n            family = \"gaussian\",\n            data = inla.stack.data(stk.full),\n            control.compute = list(return.marginals = TRUE, waic = TRUE),\n            control.predictor = list(\n              compute = TRUE,\n              A = inla.stack.A(stk.full)\n            )\n)\n\nAs for the INLA model, the coefficients do not show significant differences from the MCMC model, with most genera showed negative association between temperature and the start of season.\nWhy so convergent? INLA first finds the Maximum A Posteriori (MAP) estimate, which is the highest point of the posterior distribution. Then it uses Laplace Approximation, which inherently assumes that the posterior distribution is approximately normal near its peak (the MAP estimate).\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/\"\ncity = \"NY\"\nphe_type = \"GreenDown\"\nplots_mean &lt;- list()\nplots_sd &lt;- list()\nplots_semi &lt;- list()\n\npattern = paste0(\"^\",city,\".*\",phe_type,\"\\\\.rds$\")\nfiles &lt;- list.files(dir_path, pattern = pattern, full.names = TRUE)\nplots_tavg &lt;- list()\ncoef_summary &lt;- data.frame()\n\n# for one genus\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  # beta_names &lt;- c(\"beta[0]\", \"beta[AvgTemp_mean]\", \"beta[Sum_mm_sum]\", \"beta[srad_mean]\")\n  # df_list &lt;- lapply(seq_along(model_data$res$marginals.fixed), function(i) {\n  #   data.frame(x = model_data$res$marginals.fixed[[i]][,1], \n  #              density = model_data$res$marginals.fixed[[i]][,2], \n  #              beta = beta_names[i])\n  # })\n  # df &lt;- bind_rows(df_list)\n  beta_avg_temp &lt;- model_data$res$marginals.fixed[[2]]\n  df &lt;- data.frame(\n    x = beta_avg_temp[, 1],\n    density = beta_avg_temp[, 2],\n    beta = \"beta[AvgTemp_mean]\"\n  )\n  plot_tavg &lt;- ggplot(df, aes(x = x, y = density)) +\n    geom_line(linewidth = 1, color = \"blue\") +\n    # facet_wrap(~beta, scales = \"free\", labeller = label_parsed) + \n    theme_minimal() +\n    labs(x = \"Coefficient Value\", y = \"Density\") +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme(legend.position = \"none\")\n  plots_tavg[[genus]] &lt;- plot_tavg\n\n  proj &lt;- inla.mesh.projector(model_data$mesh,dims = c(300, 300))\n  mean_s &lt;- inla.mesh.project(proj, model_data$res$summary.random$s$mean)\n  sd_s &lt;- inla.mesh.project(proj, model_data$res$summary.random$s$sd)\n  df &lt;- expand.grid(x = proj$x, y = proj$y)\n  df$mean_s &lt;- as.vector(mean_s)\n  df$sd_s &lt;- as.vector(sd_s)\n  \n  p_mean &lt;- ggplot(df, aes(x = x, y = y, fill = mean_s)) +\n    geom_raster() +\n    scale_fill_viridis(na.value = \"transparent\") +\n    ggtitle(paste(\"Genus:\", genus)) +\n    coord_fixed(ratio = 0.8) + theme_bw() +\n    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1))\n  \n  p_sd &lt;- ggplot(df, aes(x = x, y = y, fill = sd_s)) +\n    geom_raster() +\n    scale_fill_viridis(na.value = \"transparent\") +\n    ggtitle(paste(\"Genus:\", genus)) +\n    coord_fixed(ratio = 1) + theme_bw()+\n    theme(axis.text.x = element_text(size = 10, angle = 45, hjust = 1))\n\n  #Plot the decay of spatial autocorrelation across a user-defined range\n  \n  spde.est &lt;- inla.spde2.result(inla = model_data$res, name = \"spatial.field\",\n                                spde = model_data$spde, do.transf = TRUE)\n  Kappa = inla.zmarginal(spde.est$marginals.kappa[[1]], silent = TRUE)[1]$mean\n  MaxRange &lt;- 50000\n  Resolution &lt;- 100\n  d.vec &lt;- seq(0, MaxRange, length = Resolution)\n  Cor.M &lt;- (Kappa * d.vec) * besselK(Kappa * d.vec, 1)\n  Cor.M[1] &lt;- 1\n  CorData &lt;- data.frame(Distance = d.vec, Correlation = Cor.M)\n  p_semi &lt;- ggplot(CorData, aes(x = Distance, y = Correlation)) +\n    geom_line(linewidth = 1, alpha = 0.8, color = \"blue\") +\n    coord_fixed(ratio = MaxRange) +\n    labs(x = \"Distance (m)\", y = \"Correlation\", title = \"Matern Correlation Function\") +\n    ggtitle(paste(\"Genus:\", genus)) +\n    theme_minimal()\n  \n  plots_mean[[genus]] &lt;- p_mean\n  plots_sd[[genus]] &lt;- p_sd\n  plots_semi[[genus]] &lt;- p_semi\n\n}\n\ncombined_plot_tavg &lt;- wrap_plots(plots_tavg, ncol = 5)\ncombined_plot_tavg\n\n\n\n\n\n\n\n\nFigure 12: The density of the posterior distribution of regression coefficients for Temp~avg~ with SOS as the response variable for each genus in New York city, generated via INLA.\n\n\n\n\n\nCompared to the previous MCMC results, these spatial fields appear to be smoother overall, with gradual transitions rather than sharp local variations.Some genera (Ulmus, Alnus) have fewer high/low value clusters due to fewer observations.\n\n\nCode\ncombined_plot_semi &lt;- wrap_plots(plots_semi, ncol = 5)\ncombined_plot_mean &lt;- wrap_plots(plots_mean, ncol = 5)\ncombined_plot_sd &lt;- wrap_plots(plots_sd, ncol = 5)\n\ncombined_plot_mean\n\n\n\n\n\n\n\n\nFigure 13: Spatial fields generated via INLA.\n\n\n\n\n\n\n\n\n3.2 Other phenophases in NYC\nSince the spatial fiels are more smooth, the coefficient estimates are more valid.\nThe genus Alnus has fewer data points, leading to non-convergence of the posterior distribution. So it is ignored here.\nThe magnitude of their responses vary among genera. However, the direction of their response is relatively consistent among most genera, with a 1- to 4-day advancement in SOS, 1-8 days delay in EOS (except Platanus), 1-2 days faster in GreenUp pace (except Celtis), and 1-2 days faster in GreenDown pace (except Carya) as preseason temperature increases 1 degree C.\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/\"\ncity = \"NY\"\npattern = paste0(\"^\",city,\".*\\\\.rds$\")\nfiles &lt;- list.files(dir_path, pattern = pattern, full.names = TRUE)\ncoef_summary &lt;- data.frame()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  phe_type &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\3\", basename(file))\n  fixed_summary &lt;- model_data$fix_effect %&gt;%\n    mutate(genus = genus, phe_type = phe_type)\n  coef_summary &lt;- coef_summary %&gt;%\n    rbind(fixed_summary)\n}\n\ncoef_summary_df &lt;- coef_summary %&gt;%\n  mutate(SigAlpha = ifelse(Sig == \"*\", 1, 0.2),\n         phe_type = factor(phe_type, levels = c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\"))) %&gt;%\n  filter(Factor != \"Alnus\")\n\n\ncoef_summary_plot &lt;- ggplot(coef_summary_df, aes(x = factor(Factor, levels = rev(unique(Factor))), \n                       y = Estimate)) +\n  geom_point(aes(alpha = SigAlpha), position = position_dodge(w = 0.5), size = 3) +\n  geom_errorbar(aes(ymin = Lower, ymax = Upper, alpha = SigAlpha), \n                position = position_dodge(w = 0.5), \n                width = 0.3) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  coord_flip() +\n  facet_wrap(~phe_type, scales = \"free\") + \n  labs(x = NULL, y = \"Estimate\") +\n  scale_alpha_identity() +\n  theme(legend.position = \"right\") +\n  # geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +\n  geom_text(aes(label = Estimate, y = Estimate), vjust = -0.9, show.legend = FALSE, size = 4) +\n  guides(alpha = \"none\") +\n  theme_minimal()+\n  theme(aspect.ratio = 1,\n        strip.text = element_text(size = 12, face = \"bold\"))\ncoef_summary_plot\n\n\n\n\n\n\n\n\nFigure 14: The distribution of the posterior of regression coefficients for Temp~avg~ for each genus in New York city (Thick line: 90% CI, thin line: 95% CI, point: mean value).\n\n\n\n\n\n\n\n3.3 Comparison across cities\nFor SOS, most genera all cities showed negative association between temperature and the start of season. Only some genera in DV and ST had a positive association.\nFor EOS, the difference among cities is the most obvious. Almost all genera in NY and ST had a positive association, while most genera in DV had a negative association. Precipitation/humidity/elevation?\nFor GreenUp, most genera had a positive association.\nFor GreenDown, almost all genera in DV and NY had a negative association, while most genera in ST and HT had a positive association.\n\n\nCode\n### INLA\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/\"\npattern = paste0(\"^.*\\\\.rds$\")\nfiles &lt;- list.files(dir_path, pattern = pattern, full.names = TRUE)\ncoef_summary &lt;- data.frame()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  city &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\1\", basename(file))\n  genus &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  phe_type &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\3\", basename(file))\n  fixed_summary &lt;- model_data$fix_effect %&gt;%\n    mutate(city = city, genus = genus, phe_type = phe_type)\n  coef_summary &lt;- coef_summary %&gt;%\n    rbind(fixed_summary)\n}\n\ncoef_summary_df &lt;- coef_summary %&gt;%\n  mutate(SigAlpha = ifelse(Sig == \"*\", 1, 0.2),\n         phe_type = factor(phe_type, levels = c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\")),\n         city = factor(city, levels = c(\"NY\", \"DV\", \"HT\", \"ST\")))\n\n\ncoef_summary_plot &lt;- ggplot(coef_summary_df, aes(x = factor(Factor, levels = unique(Factor)), y = Estimate, color = city)) +\n  geom_point(aes(alpha = SigAlpha), position = position_dodge(w = 0.5), size = 1.2) +\n  geom_errorbar(aes(ymin = Lower, ymax = Upper, alpha = SigAlpha), \n                position = position_dodge(w = 0.5), \n                linewidth = 0.5,\n                width = 0.3) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  # coord_flip() +\n  facet_wrap(~phe_type, scales = \"free\") +\n  labs(x = NULL, y = \"Estimate\") +\n  scale_alpha_identity() +\n  scale_color_manual(\n    values = c(\"NY\" = \"darkolivegreen4\", \"HT\" = \"navyblue\", \"DV\" = \"chocolate\", \"ST\" = \"purple\")\n  ) +\n  theme(legend.position = \"right\") +\n  # geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +\n  # geom_text(aes(label = Estimate, y = Estimate), vjust = -0.9, show.legend = FALSE, size = 3) +\n  guides(alpha = \"none\") +\n  theme_minimal()+\n  theme(\n    axis.text.x = element_text(size = 10, angle = 45, hjust = 1),\n    strip.text = element_text(size = 12, face = \"bold\"))\ncoef_summary_plot\n\n\n\n\n\n\n\n\nFigure 15: The distribution of the posterior of regression coefficients for Temp~avg~ on phenology for each genus (Line: 95% CI, point: mean value).\n\n\n\n\n\n\n\n3.4 Prediction\nMore appropriate way to prepresent heterogeneity?\n\nThe prediction is located at the weather station, because I don’t interpolate the weather data to cover the whole city.\n\nOut of sample\n\n\nCode\nNY_Acer_tavg_SOS &lt;- readRDS(\"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/NY_Acer_tavg_SOS.rds\")\n\ncity = \"NY\"\nphe_type = \"SOS\"\ngenus = \"Acer\"\nmean_doy_acer &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\",city,\"/tavg_allyear_var.rds\")) %&gt;%\n  filter(genus == !!genus & thres == 0.5 & direction == \"up\" ) %&gt;%\n  summarise(doy = mean(doy)) %&gt;%\n  pull(doy)\n\npreseason &lt;- readRDS(paste0(\"~/phenology-urban/data/proc/urban/\",city,\"/tavg_allyear_pcorr.rds\")) %&gt;%\n  filter(genus == !!genus & type == !!phe_type) %&gt;%\n  summarise(pre = mean(optimal_pre_length)) %&gt;%\n  pull(pre)\nstart_date = make_date(2023) + days(round(mean_doy_acer) - 1) - days(preseason)\nend_date = make_date(2023) + days(round(mean_doy_acer) - 1)\n\nNY_weather &lt;- readRDS(paste0(\"~/urban-cooling/data/raw/WU/\",city,\"/\",city,\"_wu.rds\")) %&gt;%\n  filter(Date &gt;= start_date & Date &lt;= end_date) %&gt;%\n  group_by(name) %&gt;%\n  summarise(AvgTemp_mean = mean(AvgTemp),\n            Sum_mm_sum = sum(Sum_mm),\n            year = as.factor(2023))\n\nNY_srad &lt;- readRDS(paste0(\"~/phenology-urban/data/raw/\",city,\"/Daymet/daily2016-2024/srad_wu_2023.rds\")) %&gt;%\n  filter(time &gt;= start_date & time &lt;= end_date) %&gt;%\n  group_by(Site) %&gt;%\n  summarise(srad_mean = mean(value)) %&gt;%\n  inner_join(NY_weather, by = c(\"Site\" = \"name\"))\n\nprediction &lt;- read_csv(paste0(\"~/urban-cooling/data/raw/WU/\",city,\"/location.csv\"), show_col_types = FALSE) %&gt;%\n  inner_join(NY_srad, by = \"Site\") %&gt;%\n  na.omit()\nindex &lt;- inla.stack.index(stack = NY_Acer_tavg_SOS$stk.full, tag = \"pred\")$data\ncoorp &lt;- prediction[, c(\"Lon\", \"Lat\")]\npred_mean &lt;- NY_Acer_tavg_SOS$res$summary.fitted.values[index, \"mean\"]\npred_ll &lt;- NY_Acer_tavg_SOS$res$summary.fitted.values[index, \"0.025quant\"]\npred_ul &lt;- NY_Acer_tavg_SOS$res$summary.fitted.values[index, \"0.975quant\"]\n\npred_ph_2023 &lt;- rbind(\n  data.frame(\n    Lon = coorp[, 1], Lat = coorp[, 2],\n    value = pred_mean, variable = \"pred_mean\"\n  ),\n  data.frame(\n    Lon = coorp[, 1], Lat = coorp[, 2],\n    value = pred_ll, variable = \"pred_ll\"\n  ),\n  data.frame(\n    Lon = coorp[, 1], Lat = coorp[, 2],\n    value = pred_ul, variable = \"pred_ul\"\n  )\n)\npred_ph_2023$variable &lt;- as.factor(pred_ph_2023$variable)\n\nggplot(pred_ph_2023) +\n  geom_point(aes(Lon, Lat, color  = value)) +\n  facet_wrap(~variable, nrow = 1) +\n  coord_fixed(ratio = 1) +\n  scale_color_gradient(\n    name = \"Predicted SOS\\nin 2023\",\n    low = \"blue\", high = \"orange\"\n  ) +\n  theme_bw()\n\n\n\n\n\n\n\n\nFigure 16: Prediction for the SOS of Acer in 2023 in New York city. The prediction are made at the weather station.\n\n\n\n\n\nIn sample\nOverall, the fitted values show a high consistency with the actual values, with points concentrated around the 1:1 line. Except for GreenDown, the model’s fitted values exhibit lower variation.\n\n\nCode\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/insample_pred/\"\npattern = paste0(\"^NY.*\\\\.rds$\")\nfiles &lt;- list.files(dir_path, pattern = pattern, full.names = TRUE)\ncompare &lt;- data.frame()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  genus &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  phe_type &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\3\", basename(file))\n  compare_one &lt;- data.frame(t(model_data$compare)) %&gt;%\n    mutate(value = as.numeric(value), \n           true_value = as.numeric(true_value),\n           genus = genus,\n           phe_type = phe_type)\n  compare &lt;- bind_rows(compare, compare_one)}\n\n# slope_data &lt;- compare %&gt;%\n#   group_by(phe_type) %&gt;%\n#   summarise(slope = round(coef(lm(value ~ true_value, data = cur_data()))[2], 3),\n#             mean_x = mean(true_value, na.rm = TRUE),\n#             mean_y = mean(value, na.rm = TRUE)) \n\nggplot(compare, aes(x = true_value, y = value, color= genus)) +\n  geom_point(size = 0.5, alpha = 0.2) +\n  geom_abline(intercept = 0, slope = 1, linetype = 2, color = \"red\") +\n  # geom_smooth(method = \"lm\", formula = y ~ x, se = FALSE, color = \"blue\") +\n  # geom_text(data = slope_data, aes(x = mean_x, y = mean_y, label = paste(\"Slope =\", slope)),color = \"blue\", size = 5, inherit.aes = FALSE) +\n  facet_wrap(~ factor(phe_type, levels = c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\")),\n             scales = \"free\") +\n  labs(x = \"True value\", y = \"Fitted value\") +\n  theme_classic()\n\n\n\n\n\n\n\n\nFigure 17: Comparison between fitted value and ture value in New York city."
  },
  {
    "objectID": "urban_phenology_update.html#model-validation",
    "href": "urban_phenology_update.html#model-validation",
    "title": "Urban phenology updates - Share on lab meeting",
    "section": "4 Model validation",
    "text": "4 Model validation\n\n4.1 Check spatial autocorrelation\nFirst, I fitted a linear mixed-effects model for each genus with environmental variables (AvgTemp_mean, Sum_mm_sum, and srad_mean) as predictors, with random effects for year and id, which represent temporal ((1 | year)) and spatial ((1 | id)) randomness, respectively.\nThen I conducted a variance decomposition analysis and compared the proportion of total variance explained by spatial effects and temporal effects respectively. Generally, spatial and temporal variations are both present, but their contributions vary across different genera. Some genera show higher spatial effects, while others have more balanced contributions from spatial and year components.\n\n\nCode\ntavg_allyear_var &lt;- readRDS(\"~/phenology-urban/data/proc/urban/DV/tavg_allyear_var.rds\")\nphe_types &lt;- c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\")\nall_genus &lt;- unique(tavg_allyear_var$genus)\nresults &lt;- list()\n\nfor (phe_type in phe_types) {\n  if (phe_type == \"SOS\") {\n    phe_metric &lt;- \"doy\"\n    direction &lt;- \"up\"\n    thres &lt;- 0.5\n  } else if (phe_type == \"EOS\") {\n    phe_metric &lt;- \"doy\"\n    direction &lt;- \"down\"\n    thres &lt;- 0.5\n  } else if (phe_type == \"GreenUp\") {\n    phe_metric &lt;- \"doy_diff\"\n    direction &lt;- \"up\"\n    thres &lt;- 0.2\n    tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n  } else {\n    phe_metric &lt;- \"doy_diff\"\n    direction &lt;- \"down\"\n    thres &lt;- 0.2\n    tavg_allyear_var$doy_diff &lt;- as.numeric(tavg_allyear_var$doy_diff)\n  }\n    \n    for (genus in all_genus) {\n      tavg_SOS &lt;- tavg_allyear_var %&gt;%\n        filter(direction == !!direction & thres == thres & genus == !!genus) %&gt;%\n        na.omit()\n      model &lt;- as.formula(paste0(phe_metric, \" ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year) + (1 | id)\"))\n      full_model &lt;- lmer(model, data = tavg_SOS)\n      var_components &lt;- VarCorr(full_model)\n      \n      total_variance &lt;-  var_components$id[1, 1] +  var_components$year[1, 1] + attr(var_components, \"sc\")^2\n      spatial_contribution &lt;- var_components$id[1, 1]  / total_variance\n      year_contribution &lt;-  var_components$year[1, 1] / total_variance\n      residual_contribution &lt;- attr(var_components, \"sc\")^2 / total_variance\n      \n      variance_components &lt;- data.frame(\n            Metric = phe_type,\n            Genus = genus,\n            Component = c(\"Spatial\", \"Year\", \"Residual\"),\n            Variance = c(spatial_contribution, year_contribution, residual_contribution)\n          )\n          \n          results[[paste(phe_type, genus, sep = \"_\")]] &lt;- variance_components\n  }\n}\n\nfinal_results &lt;- do.call(rbind, results)\nfinal_results &lt;- final_results %&gt;%\n  group_by(Metric, Genus) %&gt;%\n  mutate(Variance_Proportion = Variance / sum(Variance),\n         Component = factor(Component, levels = c(\"Spatial\", \"Residual\", \"Year\")),\n         Metric = factor(Metric, levels = c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\")))\n\nggplot(final_results, aes(x = Genus, y = Variance_Proportion, fill = Component)) +\n  geom_bar(stat = \"identity\", position = \"stack\") +\n  facet_wrap(~Metric, scales = \"free_x\") +\n  labs(x = \"Genus\", y = \"Variance Proportion\", fill = \"Component\") +\n  theme_minimal() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +\n  scale_fill_brewer(palette = \"Set2\") \n\n\n\n\n\n\n\n\nFigure 18: Variance decomposition analysis for spatial and temporal effects\n\n\n\n\n\n\n\n\n\n\nCode\ntavg_allyear_var &lt;- readRDS(\"~/phenology-urban/data/proc/urban/ST/tavg_allyear_var.rds\")\ngenera &lt;- unique(tavg_allyear_var$genus)\n\n\nvariogram_sos &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"up\" & thres == 0.5 & genus == !!genus) %&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_sos[[i]] &lt;- data.frame(\n    genus = genus,\n    SOS = vgm_exn_fit$model\n  )\n}\nvariogram_sos &lt;- do.call(rbind, variogram_sos)\n\n\nvariogram_eos &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"down\" & thres == 0.5 & genus == !!genus) %&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_eos[[i]] &lt;- data.frame(\n    genus = genus,\n    EOS = vgm_exn_fit$model\n  )\n}\nvariogram_eos &lt;- do.call(rbind, variogram_eos)\n\nvariogram_up &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"up\" & thres == 0.2 & genus == !!genus) %&gt;%\n    mutate(doy_diff = as.numeric(doy_diff))%&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy_diff ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_up[[i]] &lt;- data.frame(\n    genus = genus,\n    GreenUp = vgm_exn_fit$model\n  )\n}\nvariogram_up &lt;- do.call(rbind, variogram_up)\n\nvariogram_down &lt;- list()\nfor (i in 1:14) {\n  genus = genera[i]\n  tavg_SOS &lt;- tavg_allyear_var %&gt;%\n    filter(direction == \"down\" & thres == 0.2 & genus == !!genus) %&gt;%\n    mutate(doy_diff = as.numeric(doy_diff))%&gt;%\n    na.omit()\n  random_OLS &lt;- lmer(doy_diff ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year), data = tavg_SOS)\n  # print(check_heteroscedasticity(random_OLS))\n  tavg_SOS$residual_random &lt;- tavg_SOS$doy - fitted(random_OLS)\n\n  coordinates(tavg_SOS) &lt;- ~ lon + lat\n  vgm.emt &lt;- variogram(residual_random ~ 1, tavg_SOS, cloud = FALSE)\n  vgm.las.init &lt;- vgm(model = c(\"Exp\", \"Sph\", \"Gau\", \"Mat\"))\n  vgm_exn_fit &lt;- fit.variogram(vgm.emt, vgm.las.init)\n  variogram_down[[i]] &lt;- data.frame(\n    genus = genus,\n    GreenDown = vgm_exn_fit$model\n  )\n}\nvariogram_down &lt;- do.call(rbind, variogram_down)\n\nvariogram_summary &lt;- variogram_sos %&gt;%\n  left_join(variogram_eos, by = \"genus\") %&gt;%\n  left_join(variogram_up, by = \"genus\") %&gt;%\n  left_join(variogram_down, by = \"genus\")\n\nkable(variogram_summary, caption = \"Fitted semivariogram model for each genus\")\n\n\n\n\n\n4.2 Simulation for model’s validation\nPotential issue:\n\nThe variance among years may be captured by the spatial covariance.\nThe covariance matrix is incorrectly specified.\n\nIn this step, I primarily aimed to simulate data to verify whether the model is feasible and whether INLA can effectively capture the model parameters and assess uncertainty. Additionally, I examined whether the method can still detect signals when an incorrect covariance matrix is specified.\nI simulated the data with the true slope of Avg_temp is -2. Both spatial covariance and temporal variance are included, and spatial covariance just happened among the records from the same year. Some records happen in the same location.\nThe results demonstrate that this modeling approach is feasible.\n\n################ Make up the simulation data ################\nset.seed(2025)\nlon_range &lt;- c(-74.25156, -73.70623)\nlat_range &lt;- c(40.50458, 40.91093)\nN &lt;- 200 \nlon &lt;- runif(N, min = lon_range[1], max = lon_range[2])\nlat &lt;- runif(N, min = lat_range[1], max = lat_range[2])\n\nyears &lt;- 2017:2023\nnyears &lt;- length(years)\nyear &lt;- sample(years, N, replace = TRUE)\n\n# fix effects: intercept, tavg, precp, srad\nintercept &lt;- 120\ntavg &lt;- runif(N, 0, 25)\nprecp &lt;- runif(N, 0, 500)\nsrad &lt;- runif(N, 300, 450)\n\nbeta &lt;- c(intercept, -2, 0.05, 0.05)\nX &lt;- cbind(1, tavg, precp, srad)\n\n# spatial effect\nsigma.sq &lt;- 80\nphi &lt;- 25\nspatial_effect &lt;- numeric(N)\n\nfor (y in years) {\n  year_idx &lt;- which(year == y)\n  if (length(year_idx) &gt; 1) {\n    lon_year &lt;- lon[year_idx]\n    lat_year &lt;- lat[year_idx]\n    dist_matrix_year &lt;- as.matrix(dist(cbind(lon_year, lat_year)))\n    cov_matrix_year &lt;- sigma.sq * exp(-phi * dist_matrix_year)\n    spatial_effect[year_idx] &lt;- mvrnorm(1, mu = rep(0, length(year_idx)), Sigma = cov_matrix_year)\n  } else {\n    spatial_effect[year_idx] &lt;- 0\n  }\n}\n\n# year effect\nyear_effect &lt;- rnorm(nyears, mean = 0, sd = 1)\n\nmu &lt;- numeric(N)\ny &lt;- numeric(N)\ntau &lt;- 1 \nfor (i in 1:N) {\n  year_idx &lt;- which(years == year[i])\n  mu[i] &lt;- X[i,] %*% beta + spatial_effect[i] + year_effect[year_idx]\n  y[i] &lt;- rnorm(1, mean = mu[i], sd = sqrt(1/tau))\n}\n\nsim_data &lt;- data.frame(\n  lon = lon,\n  lat = lat,\n  year = year,\n  AvgTemp_mean = tavg,\n  Sum_mm_sum = precp,\n  srad_mean = srad,\n  spatial_effect = spatial_effect,\n  doy = y\n)\n\n\n\nCode\n################ MCMC ################\n\n# dir_path &lt;- \"~/phenology-urban/data/proc/urban/sp_model/\"\n# \n# files &lt;- list.files(dir_path, pattern = \"^SIM_sp_random.*\\\\.rds$\", full.names = TRUE)\n# plots &lt;- list()\n# \n# for (file in files) {\n#   model_data &lt;- readRDS(file)\n#   genus &lt;- sub(\".*SIM_(.*?)_tavg_SOS_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n#   \n#   beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n#   param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n#     filter(Parameter == \"AvgTemp\")\n#   beta_median &lt;- median(param_data$value)\n#   beta_mean &lt;- mean(param_data$value)\n#   p &lt;- param_data %&gt;%\n#     ggs_density() +\n#     theme_bw() +\n#     ggtitle(paste(\"Model:\", genus)) +\n#     theme(plot.title = element_text(hjust = 0.5)) +\n#     annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4) +\n#     annotate(\"text\", x = beta_mean, y = 2, label = paste0(\"Mean: \", round(beta_mean, 2)),vjust = -1.5, color = \"red\", size = 4)\n#   plots[[genus]] &lt;- p\n# }\n# \n# combined_plot2 &lt;- wrap_plots(plots, ncol = 2)\n# combined_plot2\n# \n# files &lt;- list.files(dir_path, pattern = \"^SIM_joint.*\\\\.rds$\", full.names = TRUE)\n# plots &lt;- list()\n# \n# for (file in files) {\n#   model_data &lt;- readRDS(file)\n#   genus &lt;- sub(\".*SIM_(.*?)_tavg_SOS_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n#   \n#   beta_label &lt;- data.frame(Parameter = \"beta[2]\", Label = \"AvgTemp\")\n#   param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%\n#     filter(Parameter == \"AvgTemp\")\n#   beta_median &lt;- median(param_data$value)\n#   beta_mean &lt;- mean(param_data$value)\n#   p &lt;- param_data %&gt;%\n#     ggs_density() +\n#     theme_bw() +\n#     ggtitle(paste(\"Model:\", genus)) +\n#     theme(plot.title = element_text(hjust = 0.5)) +\n#     annotate(\"text\", x = beta_median, y = 0, label = paste0(\"Median: \", round(beta_median, 2)),vjust = -1.5, color = \"red\", size = 4) +\n#     annotate(\"text\", x = beta_mean, y = 2, label = paste0(\"Mean: \", round(beta_mean, 2)),vjust = -1.5, color = \"red\", size = 4)\n#   plots[[genus]] &lt;- p\n# }\n# \n# combined_plot &lt;- wrap_plots(plots, ncol = 2)\n# combined_plot\n\n################ INLA ################\n\nmodel_data &lt;- readRDS(\"~/phenology-urban/data/proc/urban/sp_model/SIM_INLA_tavg_SOS.rds\")\ngenus = \"Simulation\"\n\n# fixed effect\n\nbeta_avg_temp &lt;- model_data$res$marginals.fixed\ndf_list &lt;- lapply(names(beta_avg_temp), function(nm) {\n  data.frame(\n    x = beta_avg_temp[[nm]][, 1],\n    density = beta_avg_temp[[nm]][, 2],\n    beta = paste0(\"beta[\", nm, \"]\") \n  )\n})\ndf &lt;- do.call(rbind, df_list)\nfix_effect &lt;- as.data.frame(summary(model_data$res)$fixed) %&gt;%\n  rename(Mean = mean, Lower = `0.025quant`,Upper = `0.975quant`) %&gt;%\n  mutate(Sig = ifelse(Lower*Upper&gt;0, \"*\", \"\")) \nfix_effect &lt;- data.frame(\n  Factor = rownames(fix_effect),  # Add Factor column\n  fix_effect, \n  row.names = NULL) %&gt;%\n  mutate(Factor = case_when(\n    Factor == \"Intercept\" ~ \"beta[Intercept]\",\n    Factor == \"AvgTemp_mean\" ~ \"beta[AvgTemp_mean]\",\n    Factor == \"Sum_mm_sum\" ~ \"beta[Sum_mm_sum]\",\n    Factor == \"srad_mean\" ~ \"beta[srad_mean]\"\n  )) \n\ndf_with_mean &lt;- df %&gt;%\n  left_join(fix_effect %&gt;% select(Factor, Mean), by = c(\"beta\" = \"Factor\"))\nannot_data &lt;- df_with_mean %&gt;%\n  group_by(beta) %&gt;%\n  summarise(\n    Mean = first(Mean),\n    max_density = max(density)\n  )\n\nplot_tavg &lt;- ggplot(df_with_mean, aes(x = x, y = density)) +\n  geom_line(linewidth = 1, color = \"blue\") +\n  geom_text(\n    aes(x = Mean, y = max_density * 0.95, \n        label = paste0(\"Mean = \", round(Mean, 3))),\n    data = annot_data,\n    color = \"red\", size = 4, hjust = 1.1\n  ) +\n  facet_wrap(~beta, scales = \"free\", labeller = label_parsed) + \n  theme_minimal() +\n  labs(x = \"Coefficient Value\", y = \"Density\") +\n  ggtitle(paste(\"Genus:\", genus)) +\n  theme(legend.position = \"none\")\n\nplot_tavg\n\n# spatial field\nproj &lt;- inla.mesh.projector(model_data$mesh,dims = c(300, 300))\nmean_s &lt;- inla.mesh.project(proj, model_data$res$summary.random$s$mean)\nsd_s &lt;- inla.mesh.project(proj, model_data$res$summary.random$s$sd)\ndf &lt;- expand.grid(x = proj$x, y = proj$y)\ndf$mean_s &lt;- as.vector(mean_s)\ndf$sd_s &lt;- as.vector(sd_s)\n\ngmean &lt;- ggplot(df, aes(x = x, y = y, fill = mean_s)) +\n  geom_raster() +\n  scale_fill_viridis(na.value = \"transparent\") +\n  coord_fixed(ratio = 1) + theme_bw()  +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.9))\n\ngsd &lt;- ggplot(df, aes(x = x, y = y, fill = sd_s)) +\n  geom_raster() +\n  scale_fill_viridis(na.value = \"transparent\") +\n  coord_fixed(ratio = 1) +\n  theme_bw() +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.9))\n\ngmean + gsd\n\n\n\n\n\n\n\n\n\n\n\n(a) Distribution of posterior for coeffeicents\n\n\n\n\n\n\n\n\n\n\n\n(b) Spatial field\n\n\n\n\n\n\nFigure 19: The distribution of posterior for coeffeicent and spatial field using simulated data and R-INLA.\n\n\n\n\n\n\n4.3 Comparison with OLS\nI think there is no dramatic difference between the OLS and INLA models. However, I believe this is appropriate, as the spatial part does not significantly impact the coefficient, and primarily accounts for the unexplained residuals in the linear regression.\n\n\nCode\n### INLA\ndir_path &lt;- \"~/phenology-urban/data/proc/urban/ols_model/\"\npattern = paste0(\"^.*\\\\.rds$\")\nfiles &lt;- list.files(dir_path, pattern = pattern, full.names = TRUE)\ncoef_summary &lt;- data.frame()\n\nfor (file in files) {\n  model_data &lt;- readRDS(file)\n  city &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\1\", basename(file))\n  genus &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\2\", basename(file))\n  phe_type &lt;- sub(\"(.*?)_(.*?)_tavg_(.*?)\\\\.rds\", \"\\\\3\", basename(file))\n  fixed_summary &lt;- model_data$fix_effect %&gt;%\n    mutate(city = city, genus = genus, phe_type = phe_type)\n  coef_summary &lt;- coef_summary %&gt;%\n    rbind(fixed_summary)\n}\n\ncoef_summary_df &lt;- coef_summary %&gt;%\n  mutate(SigAlpha = ifelse(Sig == \"*\", 1, 0.2),\n         phe_type = factor(phe_type, levels = c(\"SOS\", \"EOS\", \"GreenUp\", \"GreenDown\")),\n         city = factor(city, levels = c(\"NY\", \"DV\", \"HT\", \"ST\")))\n\n\ncoef_summary_plot &lt;- ggplot(coef_summary_df, aes(x = factor(Factor, levels = unique(Factor)), y = Estimate, color = city)) +\n  geom_point(aes(alpha = SigAlpha), position = position_dodge(w = 0.5), size = 1.2) +\n  geom_errorbar(aes(ymin = Lower, ymax = Upper, alpha = SigAlpha), \n                position = position_dodge(w = 0.5), \n                linewidth = 0.5,\n                width = 0.3) +\n  geom_hline(yintercept = 0, linetype = \"dashed\", color = \"red\", alpha =0.5) +\n  # coord_flip() +\n  facet_wrap(~phe_type, scales = \"free\") +\n  labs(x = NULL, y = \"Estimate\") +\n  scale_alpha_identity() +\n  scale_color_manual(\n    values = c(\"NY\" = \"darkolivegreen4\", \"HT\" = \"navyblue\", \"DV\" = \"chocolate\", \"ST\" = \"purple\")\n  ) +\n  theme(legend.position = \"right\") +\n  # geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +\n  # geom_text(aes(label = Estimate, y = Estimate), vjust = -0.9, show.legend = FALSE, size = 3) +\n  guides(alpha = \"none\") +\n  theme_minimal()+\n  theme(\n    axis.text.x = element_text(size = 10, angle = 45, hjust = 1),\n    strip.text = element_text(size = 12, face = \"bold\")\n    )\ncoef_summary_plot\n\n\n\n\n\n\n\n\nFigure 20: The distribution of the posterior of regression coefficients for Temp~avg~ on phenology for each genus (Line: 95% CI, point: mean value)."
  },
  {
    "objectID": "urban_phenology_update.html#conclusion-and-next-step",
    "href": "urban_phenology_update.html#conclusion-and-next-step",
    "title": "Urban phenology updates - Share on lab meeting",
    "section": "5 Conclusion and next step",
    "text": "5 Conclusion and next step\n\nConclusion\n\nOptimal preseason length for phenology varies among genera.\nWithin the city, trees indeed respond to temperature variation, result in phenology variation\nAcross cities, some variation patterns noticed.\n\n\n\nNext steps\n\nWhat can the urban phenology heterogenity be used for? - Goal\n\nThe preview of future warming: compared with the sensitivity in natural environment.\nFine-scale urban phenology: compared with other urban phenology sensitivity detected at coarser scale.\n\nScale up\n\nCities\nGenera\n\nSensitivity\n\nHow about use buffer size"
  },
  {
    "objectID": "equation.html#candidate-package",
    "href": "equation.html#candidate-package",
    "title": "Potential model",
    "section": "Candidate package",
    "text": "Candidate package\nnimble\n\nMCMC algorithm.\nFlexible and clear for covariance definition.\n\nINLA\n\nINLA algorithm.\nFixed covariance definition.\n\nspBayes\n\nMCMC algorithm.\nPowerful for spato-temporal model.\nQ: support random effects for each year? flexible covariance funtion?"
  }
]