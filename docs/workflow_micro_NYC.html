<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jiali Zhu">
<meta name="dcterms.date" content="2025-01-29">

<title>workflow_micro_NYC</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-2d01dac5deb81f30d2e298efbbbf2476.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">workflow_micro_NYC</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jiali Zhu </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 29, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="intro" class="level2">
<h2 class="anchored" data-anchor-id="intro">Intro</h2>
<ul>
<li><p>Check the variogram</p></li>
<li><p>diagnistic for model</p></li>
<li><p>scale up</p></li>
<li><p>marginal prediction</p></li>
<li><p>Key highlights (coordinate them with Juwon):</p>
<ul>
<li><p>Within-city variation, fall phenology: <a href="https://www.sciencedirect.com/science/article/pii/S0048969718343675">Katz et al., 2019</a> <a href="https://link.springer.com/article/10.1007/s00484-022-02322-1">Xing et al., 2022</a>. A few papers about intra-urban variation of phenology. Few about the fall phenology.</p></li>
<li><p>Phenology pace, different taxa</p></li>
</ul></li>
<li><p>Preseason Optimization: At the year-, site-, and taxa-level. Individual-level pre-period might have some built-in relationship.</p></li>
<li><p>Pace: As for the algorithm, more uncertainty around 0% and 100%. Use thresholds within the period (20â€“80%) to represent pace.</p></li>
<li><p>Spatial regression: Use <code>nimble</code> package to address spatial autocorrelation.</p></li>
</ul>
</section>
<section id="raw-data" class="level2">
<h2 class="anchored" data-anchor-id="raw-data">1 Raw data</h2>
<section id="insert-tree-id-base-on-wu-data" class="level3">
<h3 class="anchored" data-anchor-id="insert-tree-id-base-on-wu-data">1.1 Insert tree id base on WU data</h3>
<p>For exploratory analysis, I used the street tree in NYC, with the phenology information established by Yiluan. These trees are part of the whole inventory, covering 14 genera and being sampled. I select the trees which are within <strong>500 m</strong> buffer around the weather underground sites (see <a href="#fig-tree_wu_sites" class="quarto-xref">Figure&nbsp;1</a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>points_in_buffer <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tree_WU_500_buffer_PS.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>points_in_buffer_sf <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>boundary <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  city,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NY"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DT/City_of_Detroit_Boundary/City_of_Detroit_Boundary.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ST"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/ST/seattle_boundary/CityUGA.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Seattle"</span>),</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"HT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/HT/kx-houston-texas-city-limits-SHP/houston-texas-city-limits.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"TP"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/TP/Municipal_Boundary/Municipal_Boundary.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Tampa"</span>),</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DV"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DV/denver-boundary/denver-colorado-county-boundary.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/AT/TxDOT_City_Boundaries/Cities.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Austin"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Invalid city abbreviation."</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `nybb_dissolved' from data source 
  `/Volumes/seas-zhukai/proj-urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp' 
  using driver `ESRI Shapefile'
Simple feature collection with 1 feature and 1 field
Geometry type: MULTIPOLYGON
Dimension:     XY
Bounding box:  xmin: 913175.1 ymin: 120128.4 xmax: 1067383 ymax: 272844.3
Projected CRS: NAD83 / New York Long Island (ftUS)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>wu_location <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>, city, <span class="st">"/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> boundary, <span class="at">fill =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wu_location, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> points_in_buffer_sf, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.01</span>) <span class="sc">+</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-tree_wu_sites" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tree_wu_sites-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_files/figure-html/fig-tree_wu_sites-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tree_wu_sites-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Location of WU sites and trees
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="read-and-clean-the-wu-data-based-on-ghcnd" class="level3">
<h3 class="anchored" data-anchor-id="read-and-clean-the-wu-data-based-on-ghcnd">1.2 Read and clean the WU data (based on GHCNd)</h3>
<p>There are 4 raw daily variables selected, i.e.&nbsp;AvgTemp, HighTemp, LowTemp and Precipitation_sum (Sum_mm). I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily <a href="https://www.ncei.noaa.gov/products/land-based-station/global-historical-climatology-network-daily">GHCNd</a>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># all_sites_temp &lt;- read_clean_WU(city = "ST", run_checks = TRUE)</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>all_sites_temp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>,city,<span class="st">"/"</span>,city,<span class="st">"_wu.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(Date, HighTemp, AvgTemp, LowTemp, Sum_mm, name))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="shortwave-data-from-daymet" class="level3">
<h3 class="anchored" data-anchor-id="shortwave-data-from-daymet">1.3 Shortwave data from Daymet</h3>
<p>To control for the influence of other variables on phenology, I also incorporated shortwave radiation data derived from the Daymet daily dataset with a 1 km resolution. Shortwave radiation was extracted for the specific locations of the trees.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># download</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>srad_daily <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/raw/"</span>,city,<span class="st">"/Daymet/daily2016-2024/srad_daily_2016-2023.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, value, date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="find-the-optimal-preseason" class="level2">
<h2 class="anchored" data-anchor-id="find-the-optimal-preseason">2 Find the optimal preseason</h2>
<p>The seasonal climate variables use a fixed pre-season for every trees, not allowing heterogeneity within city. Also, the roughly divided season make it difficult to connect to phenology process, e.g.&nbsp;chilling and forcing accumulation. Therefore, some studies use varing preseason or optimal preseason.</p>
<p><a href="https://www.sciencedirect.com/science/article/pii/S0168192319304484?via%3Dihub">Meng et al., 2020</a>, <a href="https://onlinelibrary.wiley.com/doi/10.1111/gcb.15777">Wang et al., 2021</a>: The preseason was defined as the period from November 1st in the previous year to the time of <code>SOS</code> in the current year. (most fixed)</p>
<p><a href="https://www.pnas.org/doi/10.1073/pnas.1911117117#sec-3">Meng et al., 2020</a>, <a href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2023EF004127">Yin et al., 2024</a>: For each city, the period for which the absolute value of the partial correlation coefficient between <code>SOS</code> and <code>Temp</code> was highest was considered the optimal length of the preseason most relevant to <code>SOS</code>. (more flexible, cadidate time: 0 to 6 months prior to SOS, 5-day interval approach from January 1st to the average SOS date)</p>
<p>Here, based on the variable (phenology metric: <code>SOS</code>, <code>EOS</code>, <code>green-up pace</code>, <code>green-down pace</code>, temp. metric: t_avg, t_min, t_max), I find the optimal preseason at genus-city level (ignore the year for now due to sample size). The period for which the absolute value of the partial correlation coefficient between phenology and temp. metric is highest is considered the optimal length of the preseason most relevant to the certain phenology metric.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>calculate_partial_correlation <span class="ot">&lt;-</span> <span class="cf">function</span>(insert_data, direction, thres, genus, pre_lengths, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                                          phe_variable, temp_variable) {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  subset_tree_pcor <span class="ot">&lt;-</span> insert_data <span class="sc">%&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="sc">!!</span>thres <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(pre_lengths, <span class="cf">function</span>(pre_length) {</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Preseason length (days):"</span>, pre_length, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    preseason_var <span class="ot">&lt;-</span> subset_tree_pcor <span class="sc">%&gt;%</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">start_date =</span> <span class="fu">make_date</span>(year) <span class="sc">+</span> <span class="fu">days</span>(<span class="fu">round</span>(<span class="fu">mean</span>(doy)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">days</span>(pre_length),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">end_date =</span> <span class="fu">make_date</span>(year) <span class="sc">+</span> <span class="fu">days</span>(<span class="fu">round</span>(<span class="fu">mean</span>(doy)) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    temp_stats <span class="ot">&lt;-</span> all_sites_temp <span class="sc">%&gt;%</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># filter(name %in% preseason_var$Site) %&gt;%</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(preseason_var, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"Site"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> start_date <span class="sc">&amp;</span> Date <span class="sc">&lt;=</span> end_date) <span class="sc">%&gt;%</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(id,year) <span class="sc">%&gt;%</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">LowTemp_mean =</span> <span class="fu">mean</span>(LowTemp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">LowTemp_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(LowTemp)),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">AvgTemp_mean =</span> <span class="fu">mean</span>(AvgTemp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">AvgTemp_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(AvgTemp)),</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">HighTemp_mean =</span> <span class="fu">mean</span>(HighTemp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">HighTemp_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(HighTemp)),</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">Sum_mm_sum =</span> <span class="fu">sum</span>(Sum_mm, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">Sum_mm_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(Sum_mm)),</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    srad_stats <span class="ot">&lt;-</span> srad_daily <span class="sc">%&gt;%</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>      <span class="co"># filter(id %in% preseason_var$id) %&gt;%</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(preseason_var, <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(date <span class="sc">&gt;=</span> start_date <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> end_date) <span class="sc">%&gt;%</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(id,year) <span class="sc">%&gt;%</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">srad_mean =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">srad_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)),</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    preseason_var <span class="ot">&lt;-</span> preseason_var <span class="sc">%&gt;%</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(temp_stats, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span>,<span class="st">"year"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(srad_stats, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span>,<span class="st">"year"</span>))</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (temp_variable <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"LowTemp_mean"</span>, <span class="st">"HighTemp_mean"</span>)){</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>      selected_data <span class="ot">&lt;-</span> preseason_var <span class="sc">%&gt;%</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        {{ phe_variable }}, LowTemp_mean, HighTemp_mean, Sum_mm_sum,  srad_mean</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>      <span class="fu">na.omit</span>()</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>      selected_data <span class="ot">&lt;-</span> preseason_var <span class="sc">%&gt;%</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>        {{ phe_variable }}, AvgTemp_mean,Sum_mm_sum, srad_mean</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>      <span class="fu">na.omit</span>()</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    partial_corr <span class="ot">&lt;-</span> <span class="fu">pcor</span>(selected_data)</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    correlation <span class="ot">&lt;-</span> partial_corr<span class="sc">$</span>estimate[</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rownames</span>(partial_corr<span class="sc">$</span>estimate) <span class="sc">==</span> phe_variable, </span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(partial_corr<span class="sc">$</span>estimate) <span class="sc">==</span> temp_variable</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    pvalue <span class="ot">&lt;-</span> partial_corr<span class="sc">$</span>p.value[</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rownames</span>(partial_corr<span class="sc">$</span>p.value) <span class="sc">==</span> phe_variable, </span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(partial_corr<span class="sc">$</span>p.value) <span class="sc">==</span> temp_variable</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">correlation =</span> correlation, <span class="at">pvalue =</span> pvalue, <span class="at">preseason_var =</span> preseason_var)</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>  correlations <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(x) (x<span class="sc">$</span>correlation))</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>  pvalues <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(x) (x<span class="sc">$</span>pvalue))</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>  max_idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(<span class="fu">abs</span>(correlations))</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimal_pre_length =</span> pre_lengths[max_idx],</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_candidate  =</span> pre_lengths,</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_trend =</span> correlations,</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">pvalue_trend =</span> pvalues,</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_correlation =</span> results[[max_idx]]<span class="sc">$</span>correlation,</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_corr_pvalue =</span> results[[max_idx]]<span class="sc">$</span>pvalue,</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">preseason_var =</span> results[[max_idx]]<span class="sc">$</span>preseason_var</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>pre_lengths <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">5</span>, <span class="dv">180</span>, <span class="at">by =</span> <span class="dv">5</span>)</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>all_genus <span class="ot">&lt;-</span> <span class="fu">unique</span>(points_in_buffer<span class="sc">$</span>genus)</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>temp_variable <span class="ot">=</span> <span class="st">"AvgTemp_mean"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="spring-phenology" class="level3">
<h3 class="anchored" data-anchor-id="spring-phenology">2.1 Spring phenology</h3>
<section id="sos-date" class="level4">
<h4 class="anchored" data-anchor-id="sos-date"><code>SOS</code> date</h4>
<p>Defined as the day of year when individual tree growing season EVI curves first cross the green-up 50% threshold.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>phe_variable <span class="ot">=</span> <span class="st">"doy"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>insert_data <span class="ot">=</span> points_in_buffer</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_genus, <span class="cf">function</span>(genus) {</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processing genus:"</span>, genus, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">calculate_partial_correlation</span>(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">insert_data =</span> insert_data,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> direction,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">thres =</span> thres,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_lengths =</span> pre_lengths,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">phe_variable =</span> phe_variable,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_variable =</span> temp_variable</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>spring_date_preseason_var <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) x<span class="sc">$</span>preseason_var))</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>spring_date_combined_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) {</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> <span class="fu">unique</span>(x<span class="sc">$</span>preseason_var<span class="sc">$</span>genus),</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimal_pre_length =</span> x<span class="sc">$</span>optimal_pre_length,</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_correlation =</span> x<span class="sc">$</span>partial_correlation,</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_corr_pvalue =</span> x<span class="sc">$</span>partial_corr_pvalue,</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_candidate =</span> x<span class="sc">$</span>pre_length_candidate,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_trend =</span> x<span class="sc">$</span>pre_length_trend,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">pvalue_trend =</span> x<span class="sc">$</span>pvalue_trend</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>spring_date_combined_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(spring_date_combined_results, as.data.frame))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="green-up-pace" class="level4">
<h4 class="anchored" data-anchor-id="green-up-pace">Green-up Pace</h4>
<p>Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-up 20% threshold to the 80% threshold.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, id, direction) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(thres <span class="sc">%in%</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_diff =</span> <span class="fu">abs</span>(<span class="fu">diff</span>(doy[<span class="fu">order</span>(thres)])),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>points_with_diff <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(diff, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"id"</span>, <span class="st">"direction"</span>))</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>thres <span class="ot">&lt;-</span> <span class="fl">0.2</span>              <span class="co"># change to 0.5?</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>phe_variable <span class="ot">=</span> <span class="st">"doy_diff"</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>insert_data <span class="ot">=</span> points_with_diff</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_genus, <span class="cf">function</span>(genus) {</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processing genus:"</span>, genus, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">calculate_partial_correlation</span>(</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">insert_data =</span> insert_data,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> direction,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">thres =</span> thres,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_lengths =</span> pre_lengths,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">phe_variable =</span> phe_variable,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_variable =</span> temp_variable</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>spring_pace_preseason_var <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) x<span class="sc">$</span>preseason_var))</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>spring_pace_combined_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) {</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> <span class="fu">unique</span>(x<span class="sc">$</span>preseason_var<span class="sc">$</span>genus),</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimal_pre_length =</span> x<span class="sc">$</span>optimal_pre_length,</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_correlation =</span> x<span class="sc">$</span>partial_correlation,</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_corr_pvalue =</span> x<span class="sc">$</span>partial_corr_pvalue,</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_candidate =</span> x<span class="sc">$</span>pre_length_candidate,</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_trend =</span> x<span class="sc">$</span>pre_length_trend,</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">pvalue_trend =</span> x<span class="sc">$</span>pvalue_trend</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>spring_pace_combined_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(spring_pace_combined_results, as.data.frame))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="fall-phenology" class="level3">
<h3 class="anchored" data-anchor-id="fall-phenology">2.2 Fall phenology</h3>
<section id="eos-date" class="level4">
<h4 class="anchored" data-anchor-id="eos-date"><code>EOS</code> date</h4>
<p>Defined as the day of year when individual tree growing season EVI curves first cross the green-down 50% threshold.</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>phe_variable <span class="ot">=</span> <span class="st">"doy"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>insert_data <span class="ot">=</span> points_in_buffer</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_genus, <span class="cf">function</span>(genus) {</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processing genus:"</span>, genus, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">calculate_partial_correlation</span>(</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">insert_data =</span> insert_data,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> direction,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">thres =</span> thres,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_lengths =</span> pre_lengths,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">phe_variable =</span> phe_variable,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_variable =</span> temp_variable</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>fall_date_preseason_var <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) x<span class="sc">$</span>preseason_var))</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>fall_date_combined_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) {</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> <span class="fu">unique</span>(x<span class="sc">$</span>preseason_var<span class="sc">$</span>genus),</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimal_pre_length =</span> x<span class="sc">$</span>optimal_pre_length,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_correlation =</span> x<span class="sc">$</span>partial_correlation,</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_corr_pvalue =</span> x<span class="sc">$</span>partial_corr_pvalue,</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_candidate =</span> x<span class="sc">$</span>pre_length_candidate,</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_trend =</span> x<span class="sc">$</span>pre_length_trend,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">pvalue_trend =</span> x<span class="sc">$</span>pvalue_trend</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>fall_date_combined_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(fall_date_combined_results, as.data.frame))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell quarto-layout-panel" data-layout-ncol="2">

</div>
</section>
<section id="green-down-pace" class="level4">
<h4 class="anchored" data-anchor-id="green-down-pace">Green-down Pace</h4>
<p>Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-down 20% threshold to the 80% threshold.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>phe_variable <span class="ot">=</span> <span class="st">"doy_diff"</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>insert_data <span class="ot">=</span> points_with_diff</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_genus, <span class="cf">function</span>(genus) {</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processing genus:"</span>, genus, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">calculate_partial_correlation</span>(</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">insert_data =</span> insert_data,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> direction,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">thres =</span> thres,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_lengths =</span> pre_lengths,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">phe_variable =</span> phe_variable,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_variable =</span> temp_variable</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>fall_pace_preseason_var <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) x<span class="sc">$</span>preseason_var))</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>fall_pace_combined_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) {</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> <span class="fu">unique</span>(x<span class="sc">$</span>preseason_var<span class="sc">$</span>genus),</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimal_pre_length =</span> x<span class="sc">$</span>optimal_pre_length,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_correlation =</span> x<span class="sc">$</span>partial_correlation,</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_corr_pvalue =</span> x<span class="sc">$</span>partial_corr_pvalue,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_candidate =</span> x<span class="sc">$</span>pre_length_candidate,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_trend =</span> x<span class="sc">$</span>pre_length_trend,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">pvalue_trend =</span> x<span class="sc">$</span>pvalue_trend</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>fall_pace_combined_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(fall_pace_combined_results, as.data.frame))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="optimal-preseason-length-calculated-by-tempavg" class="level3">
<h3 class="anchored" data-anchor-id="optimal-preseason-length-calculated-by-tempavg">2.3 Optimal preseason length calculated by Temp<sub>avg</sub></h3>
<p><a href="#fig-partial_preseason" class="quarto-xref">Figure&nbsp;2</a> displays the distribution of optimal preseason length and partial correlation coefficient calculated by Temp<sub>avg</sub> for <code>SOS</code>, <code>Greenup pace</code>, <code>EOS</code> and <code>Greenup pace</code>, respectively.</p>
<p>As for <code>SOS</code>, all genera have negetive partial correlation coefficients, which means the higher preseason average temperature, the earlier start of season. As for <code>Greenup pace</code>, most genera (except Carya, Celtis) have negetive partial correlation coefficients, which means the higher preseason average temperature, the faster green up pace. The preseason length varies significantly among genera.</p>
<p>As for <code>EOS</code>, most genera (except Populus, Platanus) have positive partial correlation coefficients, which means the higher preseason average temperature, the later end of season. As for <code>Greenup pace</code>, there is variation in impact direction among genera. The preseason length also varies significantly among genera.</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>tavg_allyear_pcorr <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tavg_allyear_pcorr.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a flag for optimal_pre_length</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_optimal =</span> <span class="fu">ifelse</span>(pre_length_candidate <span class="sc">==</span> optimal_pre_length, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a flag for significant pvalue</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_significant =</span> <span class="fu">ifelse</span>(pvalue_trend <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust transparency</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fu">ifelse</span>(is_optimal, <span class="dv">1</span>, <span class="fl">0.2</span>),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">ifelse</span>(is_significant, <span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fu">ifelse</span>(is_optimal, <span class="fl">2.5</span>, <span class="fl">1.2</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">shape =</span> <span class="fu">factor</span>(shape, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>)),</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">size =</span> <span class="fu">factor</span>(size, <span class="at">levels =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.5</span>)))</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>sos_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"SOS"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">shape =</span> shape, <span class="at">size =</span> size)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt; 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.5</span>), </span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Start of season"</span>,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>greenup_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"green-up pace"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt; 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.5</span>), </span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Green-up pace"</span>,</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>eos_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"EOS"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt; 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.5</span>), </span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"End of season"</span>,</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>greendown_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"green-down pace"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt; 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.5</span>), </span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Green-down pace"</span>,</span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>sos_p <span class="sc">+</span> greenup_p <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>eos_p <span class="sc">+</span> greendown_p <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-partial_preseason" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-partial_preseason-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-partial_preseason" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-partial_preseason-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-partial_preseason-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_files/figure-html/fig-partial_preseason-1.png" class="img-fluid figure-img" data-ref-parent="fig-partial_preseason" width="1248">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-partial_preseason-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Spring phenology
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-partial_preseason" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-partial_preseason-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-partial_preseason-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_files/figure-html/fig-partial_preseason-2.png" class="img-fluid figure-img" data-ref-parent="fig-partial_preseason" width="1248">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-partial_preseason-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Fall phenology
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-partial_preseason-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Distribution of partial correlation coefficient and preseason length, calculated by Temp<sub>avg</sub>
</figcaption>
</figure>
</div>
</section>
</section>
<section id="spatial-pattern" class="level2">
<h2 class="anchored" data-anchor-id="spatial-pattern">3 Spatial pattern</h2>
<section id="check-spatial-autocorrelation" class="level3">
<h3 class="anchored" data-anchor-id="check-spatial-autocorrelation">3.1 Check spatial autocorrelation</h3>
<p>First, I fitted a linear mixed-effects model for each genus with environmental variables (<code>AvgTemp_mean</code>, <code>Sum_mm_sum</code>, and <code>srad_mean</code>) as predictors, with random effects for <code>year</code> and <code>id</code>, which represent temporal (<code>(1 | year)</code>) and spatial (<code>(1 | id)</code>) randomness, respectively.</p>
<p>Then I conducted a variance decomposition analysis and compared the proportion of total variance explained by spatial effects and temporal effects respectively. Generally, spatial and temporal variations are both present, but their contributions vary across different genera. Some genera show higher spatial effects, while others have more balanced contributions from spatial and year components.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/NY/tavg_allyear_var.rds"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>all_genus <span class="ot">&lt;-</span> <span class="fu">unique</span>(tavg_allyear_var<span class="sc">$</span>genus)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"SOS"</span>) {</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"EOS"</span>) {</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"GreenUp"</span>) {</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (genus <span class="cf">in</span> all_genus) {</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>      tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> thres <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">na.omit</span>()</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>      model <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(phe_metric, <span class="st">" ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year) + (1 | id)"</span>))</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>      full_model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(model, <span class="at">data =</span> tavg_SOS)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>      var_components <span class="ot">&lt;-</span> <span class="fu">VarCorr</span>(full_model)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>      total_variance <span class="ot">&lt;-</span>  var_components<span class="sc">$</span>id[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">+</span>  var_components<span class="sc">$</span>year[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">attr</span>(var_components, <span class="st">"sc"</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>      spatial_contribution <span class="ot">&lt;-</span> var_components<span class="sc">$</span>id[<span class="dv">1</span>, <span class="dv">1</span>]  <span class="sc">/</span> total_variance</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>      year_contribution <span class="ot">&lt;-</span>  var_components<span class="sc">$</span>year[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">/</span> total_variance</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>      residual_contribution <span class="ot">&lt;-</span> <span class="fu">attr</span>(var_components, <span class="st">"sc"</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> total_variance</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>      variance_components <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>            <span class="at">Metric =</span> phe_type,</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>            <span class="at">Genus =</span> genus,</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>            <span class="at">Component =</span> <span class="fu">c</span>(<span class="st">"Spatial"</span>, <span class="st">"Year"</span>, <span class="st">"Residual"</span>),</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>            <span class="at">Variance =</span> <span class="fu">c</span>(spatial_contribution, year_contribution, residual_contribution)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>          results[[<span class="fu">paste</span>(phe_type, genus, <span class="at">sep =</span> <span class="st">"_"</span>)]] <span class="ot">&lt;-</span> variance_components</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>final_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, results)</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>final_results <span class="ot">&lt;-</span> final_results <span class="sc">%&gt;%</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Metric, Genus) <span class="sc">%&gt;%</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Variance_Proportion =</span> Variance <span class="sc">/</span> <span class="fu">sum</span>(Variance),</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>         <span class="at">Component =</span> <span class="fu">factor</span>(Component, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Spatial"</span>, <span class="st">"Residual"</span>, <span class="st">"Year"</span>)),</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>         <span class="at">Metric =</span> <span class="fu">factor</span>(Metric, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)))</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(final_results, <span class="fu">aes</span>(<span class="at">x =</span> Genus, <span class="at">y =</span> Variance_Proportion, <span class="at">fill =</span> Component)) <span class="sc">+</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"stack"</span>) <span class="sc">+</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Metric, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Genus"</span>, <span class="at">y =</span> <span class="st">"Variance Proportion"</span>, <span class="at">fill =</span> <span class="st">"Component"</span>) <span class="sc">+</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-check_variance" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-check_variance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_files/figure-html/fig-check_variance-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-check_variance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Variance decomposition analysis for spatial and temporal effects
</figcaption>
</figure>
</div>
</div>
</div>
<p>Using <code>SOS</code> as an example, I used <code>check_heteroscedasticity()</code> to check for heteroscedasticity in the residuals. The results showed almost every model had heterogenerous residuals.</p>
<p>For fixed-effect model (<code>SOS</code> ~ <code>AvgTemp_mean</code> + <code>Sum_mm_sum</code> + <code>srad_mean</code>), <code>Global Moran I</code> for regression residuals test indicates the presence of spatial autocorrelation in the residuals. <code>Lagrange Multiplier</code> test suggests the spatial model should be applied.</p>
<p>I computed the empirical semivariogram for the residuals to analyze spatial structure. The optimal theoretical semivariogram models (among Exp, Sph, Gau, Mat) were chosen to empirical semivariogram using <code>fit.variogram()</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/NY/tavg_allyear_var.rds"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>genera <span class="ot">&lt;-</span> <span class="fu">unique</span>(tavg_allyear_var<span class="sc">$</span>genus)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>variogram_sos <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"up"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  variogram_sos[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">SOS =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>variogram_sos <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_sos)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>variogram_eos <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"down"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>  variogram_eos[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">EOS =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>variogram_eos <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_eos)</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>variogram_up <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"up"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.2</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">doy_diff =</span> <span class="fu">as.numeric</span>(doy_diff))<span class="sc">%&gt;%</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy_diff <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>  variogram_up[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">GreenUp =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a possible solution MIGHT be to scale semivariances and/or distances"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a possible solution MIGHT be to scale semivariances and/or distances"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a possible solution MIGHT be to scale semivariances and/or distances"</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a possible solution MIGHT be to scale semivariances and/or distances"</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>variogram_up <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_up)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>variogram_down <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"down"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.2</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">doy_diff =</span> <span class="fu">as.numeric</span>(doy_diff))<span class="sc">%&gt;%</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy_diff <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  variogram_down[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">GreenDown =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>variogram_down <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_down)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>variogram_summary <span class="ot">&lt;-</span> variogram_sos <span class="sc">%&gt;%</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_eos, <span class="at">by =</span> <span class="st">"genus"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_up, <span class="at">by =</span> <span class="st">"genus"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_down, <span class="at">by =</span> <span class="st">"genus"</span>)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(variogram_summary, <span class="at">caption =</span> <span class="st">"Fitted semivariogram model for each genus"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Fitted semivariogram model for each genus</caption>
<thead>
<tr class="header">
<th style="text-align: left;">genus</th>
<th style="text-align: left;">SOS</th>
<th style="text-align: left;">EOS</th>
<th style="text-align: left;">GreenUp</th>
<th style="text-align: left;">GreenDown</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Carya</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Mat</td>
</tr>
<tr class="even">
<td style="text-align: left;">Acer</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Gau</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Sph</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Quercus</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Mat</td>
</tr>
<tr class="even">
<td style="text-align: left;">Platanus</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Gau</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Sph</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Juglans</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Mat</td>
</tr>
<tr class="even">
<td style="text-align: left;">Liquidambar</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Exp</td>
<td style="text-align: left;">Gau</td>
<td style="text-align: left;">Sph</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Betula</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Mat</td>
</tr>
<tr class="even">
<td style="text-align: left;">Populus</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Exp</td>
<td style="text-align: left;">Mat</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Morus</td>
<td style="text-align: left;">Exp</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Sph</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ulmus</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Sph</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Fraxinus</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Sph</td>
</tr>
<tr class="even">
<td style="text-align: left;">Celtis</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Mat</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Salix</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Mat</td>
<td style="text-align: left;">Exp</td>
<td style="text-align: left;">Mat</td>
</tr>
<tr class="even">
<td style="text-align: left;">Alnus</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Gau</td>
<td style="text-align: left;">Sph</td>
<td style="text-align: left;">Mat</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Sph: 26, Mat: 22, Gau: 4, Exp: 4 HT: Sph, Mat</p>
</section>
<section id="spatial-statistical-model" class="level3">
<h3 class="anchored" data-anchor-id="spatial-statistical-model">3.2 Spatial statistical model</h3>
<p>I modeled the relationship between the phenology and environmental covariates using a spatial hierarchical model. The response variable (phenology parameter) at location <span class="math inline">\(\mathbf{s}_i\)</span> and in year <span class="math inline">\(\mathbf{t}\)</span>, denoted as <span class="math inline">\(y(\mathbf{s}_i, \mathbf{t})\)</span>, was modeled as following candidate model:</p>
<p><strong>Model 1: (current use)</strong></p>
<p><span class="math display">\[y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w(\mathbf{s}_i) + u(\mathbf{t}) + \epsilon(\mathbf{s}_i, \mathbf{t})\]</span></p>
<p>where:</p>
<ul>
<li><p><em>Fixed Effects</em>: <span class="math display">\[\mu(\mathbf{s}_i,\mathbf{t}) = \mathbf{X}_{\mathbf{s}_i,\mathbf{t}} \boldsymbol{\beta}\]</span></p>
<ul>
<li><span class="math inline">\(\mathbf{X}_{\mathbf{s}_i,\mathbf{t}} = [1, \text{AvgTemp}_{\mathbf{s}_i,\mathbf{t}}, \text{Precp}_{\mathbf{s}_i,\mathbf{t}}, \text{srad}_{\mathbf{s}_i,\mathbf{t}}]\)</span> is the design matrix of predictors.</li>
<li><span class="math inline">\(\boldsymbol{\beta} = [\beta_0, \beta_1, \beta_2, \beta_3]\)</span> are the regression coefficients for the intercept and covariates.</li>
</ul></li>
<li><p><em>Spatially Correlated Random Effect</em>: <span class="math display">\[w(\mathbf{s}_i) \sim \text{MVN}(\mathbf{0}, \mathbf{R})\]</span></p>
<ul>
<li><p><span class="math inline">\(\mathbf{R}\)</span> is the spatial correlation matrix defined by a covariance function:</p></li>
<li><p>MatÃ©rn Covariance Function (if selected): <span class="math display">\[\mathbf{R}_{ij} = \sigma^2 \cdot \frac{2^{1-\nu}}{\Gamma(\nu)} \left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)^\nu K_\nu\left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)\]</span></p></li>
<li><p>Exponential Covariance Function (if selected): <span class="math display">\[\mathbf{R}_{ij} = \sigma^2 \cdot \exp(-\phi D_{ij})\]</span></p></li>
<li><p>Gaussian Covariance Function (if selected): <span class="math display">\[\mathbf{R}_{ij} = \sigma^2 \cdot \exp(-\phi D_{ij}^2)\]</span></p></li>
<li><p>Spherical Covariance Function (if selected):</p></li>
</ul>
<p><span class="math display">\[\mathbf{R}_{ij} =
        \begin{cases}
        \sigma^2 \cdot \left(1 - \frac{3 D_{ij}}{2\rho} + \frac{D_{ij}^3}{2\rho ^3}\right), &amp; D_{ij} \leq \rho \\
        0, &amp; D_{ij} &gt; \rho
        \end{cases}\]</span></p></li>
<li><p><em>Year-specific Random Effect</em>: <span class="math display">\[u(\mathbf{t}) \sim \text{N}(0, \tau^2_{\mathbf{t}})\]</span></p>
<ul>
<li><span class="math inline">\(u_{\mathbf{t}}\)</span> captures year-to-year variability, with <span class="math inline">\(\tau^2_{\mathbf{t}}\)</span> being the variance of the year effect.</li>
</ul></li>
<li><p><em>Independent Nugget Effect</em>: <span class="math display">\[\epsilon(\mathbf{s}_i) \sim \text{N}(0, \tau^2)\]</span></p>
<ul>
<li><span class="math inline">\(\epsilon(\mathbf{s}_i, \mathbf{t})\)</span> accounts for measurement error or small-scale variability.</li>
</ul></li>
</ul>
<p><strong>Model 2: (checked)</strong></p>
<p><span class="math display">\[y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w(\mathbf{s}_i, \mathbf{t}) + \epsilon(\mathbf{s}_i, \mathbf{t})\]</span></p>
<p>where:</p>
<ul>
<li><p><em>Fixed Effects</em>: same as above.</p></li>
<li><p><em>Spatio-temporal Random Effect</em>: <span class="math display">\[w(\mathbf{s}_i, \mathbf{t}) \sim \text{MVN}(\mathbf{0}, \mathbf{R}_{\mathbf{s}\mathbf{t}})\]</span></p>
<ul>
<li><p><span class="math inline">\(\mathbf{R}\)</span> is the spatio-temporal correlation matrix defined by covariance function. The function format is the same.</p></li>
<li><p>Instead, <span class="math inline">\(D_{ij}\)</span> is the distance using 3-dimension coordinate, (scaled_longitude, scaled_latitude, scaled_year).</p></li>
</ul></li>
<li><p><em>Independent Nugget Effect</em>: same as above.</p></li>
</ul>
<p><strong>Model 3: </strong></p>
<p><span class="math display">\[y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w_t(\mathbf{s}_i) + \epsilon(\mathbf{s}_i, \mathbf{t})\]</span></p>
<p>where:</p>
<ul>
<li><p><em>Fixed Effects</em>: same as above.</p></li>
<li><p><em>Spatio-temporal Random Effect</em>: <span class="math display">\[w_t(\mathbf{s}_i) \sim \text{MVN}(\mathbf{0}, \mathbf{R}_{\mathbf{t}})\]</span></p>
<ul>
<li><span class="math inline">\(\mathbf{R}_{\mathbf{t}}\)</span> is fitted for each year. Or the parameters in covariance matrix, e.g., <span class="math inline">\(\phi(\mathbf{t}_j) \sim \text{N}(0, \tau^2_{\phi})\)</span></li>
</ul></li>
<li><p><em>Independent Nugget Effect</em>: same as above.</p></li>
</ul>
<p><strong>Model 4: </strong></p>
<p><span class="math display">\[y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w(\mathbf{s}_i) + u(\mathbf{t}) + \epsilon(\mathbf{s}_i, \mathbf{t})\]</span></p>
<p>where:</p>
<ul>
<li><p><em>Fixed Effects</em>: same as above.</p></li>
<li><p><em>Spatially Correlated Random Effect</em>: <span class="math display">\[w(\mathbf{s}_i) \sim \text{MVN}(\mathbf{0}, \mathbf{R})\]</span></p>
<ul>
<li><span class="math inline">\(\mathbf{R}\)</span> is the spatial correlation matrix defined by a covariance function:</li>
</ul>
<p><span class="math display">\[\mathbf{R}_{ij} =
\begin{cases}
0 \text{ or a very samll value} &amp; \text{if } \mathbf{t}_{i} \neq \mathbf{t}_{j} \\
\text{follow covariance function}  &amp; \text{otherwise}
\end{cases}\]</span></p></li>
<li><p><em>Year-specific Random Effect</em>: same as above.</p></li>
<li><p><em>Independent Nugget Effect</em>: same as above.</p></li>
</ul>
<section id="simulation-for-canndidate-models" class="level5">
<h5 class="anchored" data-anchor-id="simulation-for-canndidate-models">3.2.0 Simulation for canndidate models</h5>
<p>For model comparison, I simulated the data with the true slope of <code>Avg_temp</code> is <strong>-2</strong>. Both spatial variance (exp covariance) and temporal variance are included. Some records happen in the same location.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">################ Make up the simulation data ################</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>lon_range <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">74.25156</span>, <span class="sc">-</span><span class="fl">73.70623</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>lat_range <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">40.50458</span>, <span class="fl">40.91093</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">200</span> </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>lon <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="at">min =</span> lon_range[<span class="dv">1</span>], <span class="at">max =</span> lon_range[<span class="dv">2</span>])</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>lat <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="at">min =</span> lat_range[<span class="dv">1</span>], <span class="at">max =</span> lat_range[<span class="dv">2</span>])</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="dv">2017</span><span class="sc">:</span><span class="dv">2023</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>nyears <span class="ot">&lt;-</span> <span class="fu">length</span>(years)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>year <span class="ot">&lt;-</span> <span class="fu">sample</span>(years, N, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co"># fix effects: intercept, tavg, precp, srad</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">&lt;-</span> <span class="dv">120</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>tavg <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">0</span>, <span class="dv">25</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>precp <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">0</span>, <span class="dv">500</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>srad <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">300</span>, <span class="dv">450</span>)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(intercept, <span class="sc">-</span><span class="dv">2</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, tavg, precp, srad)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co"># spatial effect</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>sigma.sq <span class="ot">&lt;-</span> <span class="dv">80</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>spatial_effect <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (y <span class="cf">in</span> years) {</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  year_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(year <span class="sc">==</span> y)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(year_idx) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    lon_year <span class="ot">&lt;-</span> lon[year_idx]</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    lat_year <span class="ot">&lt;-</span> lat[year_idx]</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    dist_matrix_year <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">cbind</span>(lon_year, lat_year)))</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    cov_matrix_year <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix_year)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    spatial_effect[year_idx] <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(year_idx)), <span class="at">Sigma =</span> cov_matrix_year)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    spatial_effect[year_idx] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="co"># year effect</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>year_effect <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nyears, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>  year_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(years <span class="sc">==</span> year[i])</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>  mu[i] <span class="ot">&lt;-</span> X[i,] <span class="sc">%*%</span> beta <span class="sc">+</span> spatial_effect[i] <span class="sc">+</span> year_effect[year_idx]</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>  y[i] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> mu[i], <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau))</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">lon =</span> lon,</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">lat =</span> lat,</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> year,</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">AvgTemp_mean =</span> tavg,</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sum_mm_sum =</span> precp,</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">srad_mean =</span> srad,</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatial_effect =</span> spatial_effect,</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">doy =</span> y</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">################ Result form Nimble using 4 model ################</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/"</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^SIM.*Exp</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*SIM_(.*?)_tavg_SOS_Exp</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  beta_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Model:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_mean, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean: "</span>, <span class="fu">round</span>(beta_mean, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>combined_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-model_simulate_check" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-model_simulate_check-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_files/figure-html/fig-model_simulate_check-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-model_simulate_check-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: The distribution of posterior for Temp coeffeicent using simulated data.
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="do">################ Sensitivity to different covariance model ################</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/"</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^SIM_sp_random.*</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*SIM_(.*?)_tavg_SOS_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  beta_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Model:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_mean, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean: "</span>, <span class="fu">round</span>(beta_mean, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>combined_plot2 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>combined_plot2</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^SIM_joint.*</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*SIM_(.*?)_tavg_SOS_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>  beta_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Model:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_mean, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean: "</span>, <span class="fu">round</span>(beta_mean, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>combined_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-model_sen_check" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-model_sen_check-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="fig-model_sen_check-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-model_sen_check-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_files/figure-html/fig-model_sen_check-1.png" class="img-fluid figure-img" data-ref-parent="fig-model_sen_check" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-model_sen_check-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Model 1: Spatial random effect &amp; year random effect
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-model_sen_check-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-model_sen_check-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_files/figure-html/fig-model_sen_check-2.png" class="img-fluid figure-img" data-ref-parent="fig-model_sen_check" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-model_sen_check-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Model 2: Spatio-temporal random effect
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-model_sen_check-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: The distribution of posterior for Temp coeffeicent using simulated data and different covariance model.
</figcaption>
</figure>
</div>
</div>
</section>
<section id="nimble-model-code-run-in-separate-script" class="level5">
<h5 class="anchored" data-anchor-id="nimble-model-code-run-in-separate-script">3.2.1 Nimble model code (run in separate script)</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>spherical_covariance <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">run =</span> <span class="cf">function</span>(<span class="at">d =</span> <span class="fu">double</span>(<span class="dv">0</span>), <span class="at">range =</span> <span class="fu">double</span>(<span class="dv">0</span>), <span class="at">sigma.sq =</span> <span class="fu">double</span>(<span class="dv">0</span>)) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">returnType</span>(<span class="fu">double</span>(<span class="dv">0</span>)) </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (d <span class="sc">&lt;=</span> range) {</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span> (sigma.sq <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> (<span class="dv">3</span> <span class="sc">*</span> d <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> range)) <span class="sc">+</span> (d<span class="sc">^</span><span class="dv">3</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> range<span class="sc">^</span><span class="dv">3</span>))))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fl">0.0</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>matern_covariance <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">run =</span> <span class="cf">function</span>(<span class="at">d =</span> <span class="fu">double</span>(<span class="dv">0</span>), <span class="at">range =</span> <span class="fu">double</span>(<span class="dv">0</span>), <span class="at">sigma.sq =</span> <span class="fu">double</span>(<span class="dv">0</span>), <span class="at">nu =</span> <span class="fu">double</span>(<span class="dv">0</span>)) {</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">returnType</span>(<span class="fu">double</span>(<span class="dv">0</span>))</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (d <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(sigma.sq)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>        part <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">^</span>(<span class="dv">1</span> <span class="sc">-</span> nu)) <span class="sc">/</span> <span class="fu">gamma</span>(nu)  <span class="sc">*</span> (<span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> nu) <span class="sc">*</span> d <span class="sc">/</span> range)<span class="sc">^</span>nu</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(sigma.sq <span class="sc">*</span> part <span class="sc">*</span> <span class="fu">besselK</span>(d <span class="sc">/</span> range, nu))</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Nimble model code</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>model_code <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    y[i] <span class="sc">~</span> <span class="fu">dnorm</span>(mu[i], tau)</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    mu[i] <span class="ot">&lt;-</span> <span class="fu">inprod</span>(X[i, <span class="dv">1</span><span class="sc">:</span>P], beta[]) <span class="sc">+</span> spatial_effect[i] <span class="sc">+</span> year_effect[year[i]]</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (q <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nyears) {</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    year_effect[q] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(tau.year))</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>P) {</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    beta[j] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1000</span>)</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>  spatial_effect[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dmnorm</span>(Mu[<span class="dv">1</span><span class="sc">:</span>N], <span class="at">cov =</span> cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N])</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose the covariance function based on variogram fitting</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Mat"</span>) {</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>        cov_matrix[m, n] <span class="ot">&lt;-</span> <span class="fu">matern_covariance</span>(dist_matrix[m, n], range, sigma.sq, nu)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Gau"</span>) {</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Exp"</span>) {</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N])</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Sph"</span>) {</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>        cov_matrix[m, n] <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(dist_matrix[m, n], range, sigma.sq)</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="fl">0.001</span>, <span class="fl">0.001</span>)</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>  sigma.sq <span class="sc">~</span> <span class="fu">dinvgamma</span>(<span class="fl">2.5</span>, <span class="dv">120</span>)</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>  phi <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">5</span> <span class="sc">/</span> <span class="dv">1</span>, <span class="dv">5</span> <span class="sc">/</span> <span class="fl">0.1</span>)</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>  tau.year <span class="sc">~</span> <span class="fu">dinvgamma</span>(<span class="fl">2.001</span>, <span class="fl">0.667</span>)</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>  range <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>  nu <span class="sc">~</span> <span class="fu">dunif</span>(<span class="fl">0.5</span>, <span class="dv">5</span>)</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="sos-in-nyc" class="level5">
<h5 class="anchored" data-anchor-id="sos-in-nyc">3.2.2 SOS in NYC</h5>
<p>Most genera showed negative association between temperature and the start of season, suggesting the warmer preseason, the earilier start of season. Only Fraxinus had a positive association, with a median coefficient of 0.15. There are significant genus-level differences in how temperature influences the spring phenology.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/year_random/"</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/sp_temp/"</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*SOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_SOS</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>combined_plot2 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>combined_plot1</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>combined_plot2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="eos-in-nyc" class="level5">
<h5 class="anchored" data-anchor-id="eos-in-nyc">3.2.3 EOS in NYC</h5>
<p>The response of end of season to temperature shows greater variation among genera compared to spring phenology. For Acer, Betula, Liquidambar, Populus, Quercus, Salix, Ulmus, warmer preseason leads to earlier end of season. In contrast, Catya, Celtis, Fracinus and Juglans exhibited positive associations.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/year_random/"</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/sp_temp/"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*EOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_EOS</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>combined_plot1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>combined_plot1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="greenup-pace-in-nyc" class="level5">
<h5 class="anchored" data-anchor-id="greenup-pace-in-nyc">3.2.4 GreenUp pace in NYC</h5>
<p>The response of green-up pace to temperature shows great variation among genera. For most genera, the warmer the preseason, the faster the green-up pace (shorter green-up length). For Celtis and Ulmus, warmer preseason is associated with slower green-up pace (longer green-up length).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/sp_temp/"</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*Up</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>combined_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="greendown-pace-in-nyc" class="level5">
<h5 class="anchored" data-anchor-id="greendown-pace-in-nyc">3.2.5 GreenDown pace in NYC</h5>
<p>The response of green-down pace to temperature shows great variation among genera. For Acer, Betula, Carya, Celtis, Fraxinus, Morus, Platanus and Quercus, the warmer the preseason, the faster the green-down pace (shorter green-down length). For Juglans, Populus, Salix and Liquidambar, warmer preseason is associated with slower green-down pace (longer green-down length).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/sp_temp/"</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*Down</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>combined_plot3 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>combined_plot3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="comparison" class="level5">
<h5 class="anchored" data-anchor-id="comparison">3.2.6 Comparison</h5>
<p>The genus Alnus has fewer data points, leading to non-convergence of the posterior distribution. So it is ignored here.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/"</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>SOS_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*SOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>EOS_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*EOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>Gup_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*Up</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>Gdown_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*Down</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>param_sos_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(SOS_files)) {</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  file <span class="ot">&lt;-</span> SOS_files[i]</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> genus)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="sc">!!</span>genus)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  param_sos_list[[i]] <span class="ot">&lt;-</span> param_data</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>param_eos_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(EOS_files)) {</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  file <span class="ot">&lt;-</span> EOS_files[i]</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> genus)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="sc">!!</span>genus)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>  param_eos_list[[i]] <span class="ot">&lt;-</span> param_data</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>param_gup_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(Gup_files)) {</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  file <span class="ot">&lt;-</span> Gup_files[i]</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> genus)</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="sc">!!</span>genus)</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>  param_gup_list[[i]] <span class="ot">&lt;-</span> param_data</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>param_gdown_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(Gdown_files)) {</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>  file <span class="ot">&lt;-</span> Gdown_files[i]</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> genus)</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="sc">!!</span>genus)</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>  param_gdown_list[[i]] <span class="ot">&lt;-</span> param_data</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>combined_param_sos_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(param_sos_list) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Parameter <span class="sc">!=</span> <span class="st">"Alnus"</span>)</span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>combined_param_eos_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(param_eos_list) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Parameter <span class="sc">!=</span> <span class="st">"Alnus"</span>)</span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>combined_param_gup_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(param_gup_list) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Parameter <span class="sc">!=</span> <span class="st">"Alnus"</span>)</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>combined_param_gdown_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(param_gdown_list) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Parameter <span class="sc">!=</span> <span class="st">"Alnus"</span>)</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>combined_param_data <span class="ot">&lt;-</span> combined_param_sos_data <span class="sc">%&gt;%</span></span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">phe_type =</span> <span class="st">"SOS"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(combined_param_eos_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">phe_type =</span> <span class="st">"EOS"</span>))<span class="sc">%&gt;%</span></span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(combined_param_gup_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">phe_type =</span> <span class="st">"GreenUp"</span>))<span class="sc">%&gt;%</span></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(combined_param_gdown_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">phe_type =</span> <span class="st">"GreenDown"</span>))</span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a><span class="co"># ggmcmc</span></span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="at">SOS=</span>combined_param_sos_data, <span class="at">EOS=</span>combined_param_eos_data, <span class="at">GreenUp=</span>combined_param_gup_data, <span class="at">GreenDown =</span> combined_param_gdown_data) <span class="sc">%&gt;%</span> </span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggs_caterpillar</span>(<span class="at">thick_ci =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>),</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>                  <span class="at">thin_ci =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>),</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>                  <span class="at">horizontal =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Genus"</span>,</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"The posterior of regression coefficients for Tavg"</span>) <span class="sc">+</span></span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a><span class="do">## geom_linerange</span></span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a>summary_data <span class="ot">&lt;-</span> combined_param_data <span class="sc">%&gt;%</span></span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Parameter, phe_type) <span class="sc">%&gt;%</span></span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_value =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.975</span>),</span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb27-86"><a href="#cb27-86" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-87"><a href="#cb27-87" aria-hidden="true" tabindex="-1"></a>summary_data<span class="sc">$</span>phe_type <span class="ot">&lt;-</span> <span class="fu">factor</span>(summary_data<span class="sc">$</span>phe_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenDown"</span>))</span>
<span id="cb27-88"><a href="#cb27-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-89"><a href="#cb27-89" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(summary_data, <span class="fu">aes</span>(<span class="at">x =</span> Parameter, <span class="at">y =</span> mean_value, <span class="at">color =</span> phe_type)) <span class="sc">+</span></span>
<span id="cb27-90"><a href="#cb27-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.5</span>)) <span class="sc">+</span>  </span>
<span id="cb27-91"><a href="#cb27-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">size =</span> <span class="fl">0.5</span>, </span>
<span id="cb27-92"><a href="#cb27-92" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.5</span>)) <span class="sc">+</span> </span>
<span id="cb27-93"><a href="#cb27-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb27-94"><a href="#cb27-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb27-95"><a href="#cb27-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb27-96"><a href="#cb27-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Genus"</span>,</span>
<span id="cb27-97"><a href="#cb27-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"The posterior of regression coefficients for Tavg"</span>,</span>
<span id="cb27-98"><a href="#cb27-98" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Phenological parameter"</span></span>
<span id="cb27-99"><a href="#cb27-99" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-100"><a href="#cb27-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb27-101"><a href="#cb27-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"SOS"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>, <span class="st">"GreenUp"</span> <span class="ot">=</span> <span class="st">"darkolivegreen3"</span>, <span class="st">"EOS"</span> <span class="ot">=</span> <span class="st">"chocolate4"</span>,  <span class="st">"GreenDown"</span> <span class="ot">=</span> <span class="st">"coral"</span>)</span>
<span id="cb27-102"><a href="#cb27-102" aria-hidden="true" tabindex="-1"></a>    <span class="co">#coral/chocolate</span></span>
<span id="cb27-103"><a href="#cb27-103" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-104"><a href="#cb27-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb27-105"><a href="#cb27-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb27-106"><a href="#cb27-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>), </span>
<span id="cb27-107"><a href="#cb27-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb27-108"><a href="#cb27-108" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-109"><a href="#cb27-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-110"><a href="#cb27-110" aria-hidden="true" tabindex="-1"></a><span class="co"># combined_param_data&lt;- bind_rows(param_data_list) </span></span>
<span id="cb27-111"><a href="#cb27-111" aria-hidden="true" tabindex="-1"></a><span class="co"># p &lt;- ggplot(combined_param_data, aes(x = Parameter, y = value, color = phe_type)) +</span></span>
<span id="cb27-112"><a href="#cb27-112" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_boxplot(outlier.shape = NA, width = 0.5) + </span></span>
<span id="cb27-113"><a href="#cb27-113" aria-hidden="true" tabindex="-1"></a><span class="co">#   theme_minimal() +</span></span>
<span id="cb27-114"><a href="#cb27-114" aria-hidden="true" tabindex="-1"></a><span class="co">#   labs(</span></span>
<span id="cb27-115"><a href="#cb27-115" aria-hidden="true" tabindex="-1"></a><span class="co">#     x = "Genus",</span></span>
<span id="cb27-116"><a href="#cb27-116" aria-hidden="true" tabindex="-1"></a><span class="co">#     y = "The distribution of the posterior of regression coefficients",</span></span>
<span id="cb27-117"><a href="#cb27-117" aria-hidden="true" tabindex="-1"></a><span class="co">#     color = "Phenological Type"</span></span>
<span id="cb27-118"><a href="#cb27-118" aria-hidden="true" tabindex="-1"></a><span class="co">#   ) +</span></span>
<span id="cb27-119"><a href="#cb27-119" aria-hidden="true" tabindex="-1"></a><span class="co">#   theme(</span></span>
<span id="cb27-120"><a href="#cb27-120" aria-hidden="true" tabindex="-1"></a><span class="co">#     axis.title = element_text(size = 14),</span></span>
<span id="cb27-121"><a href="#cb27-121" aria-hidden="true" tabindex="-1"></a><span class="co">#     axis.text.x = element_text(size = 12, angle = 45, hjust = 1),</span></span>
<span id="cb27-122"><a href="#cb27-122" aria-hidden="true" tabindex="-1"></a><span class="co">#     axis.text.y = element_text(size = 12),</span></span>
<span id="cb27-123"><a href="#cb27-123" aria-hidden="true" tabindex="-1"></a><span class="co">#     plot.title = element_text(size = 16, face = "bold", hjust = 0.5)</span></span>
<span id="cb27-124"><a href="#cb27-124" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="conclusion-and-next-step" class="level2">
<h2 class="anchored" data-anchor-id="conclusion-and-next-step">4 Conclusion and next step</h2>
<ul>
<li><p>The preseason length varies significantly among genera.</p></li>
<li><p>Within the city, the relationship between phenology and temperature is still significant.</p>
<ul>
<li>The warmer the preseason temperature, the earlier the start of season, considering the spatial autocorrelation of phenology in the model.</li>
<li>As for green-up pace, for most genera, the warmer preseason leads to faster green-up pace.</li>
<li>The response of end of season to temperature shows great variation among genera, including both the magnitude and direction.</li>
<li>As for green-down pace, for most genera, the warmer preseason leads to faster green-down pace.</li>
<li>The precipitation has no significant impact.</li>
</ul></li>
</ul>
<p>Next steps:</p>
<ul>
<li>Future steps:
<ul>
<li>Test sensitivity by changing buffer size.</li>
<li>Add more taxa (data in DataDen and download latest PS images)</li>
</ul></li>
</ul>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb28" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "workflow_micro_NYC"</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Jiali Zhu"</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "today"</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Code"</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-packages</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zhulabtools)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a><span class="fu">load_packages</span>(<span class="fu">c</span>(<span class="st">"dplyr"</span>,<span class="st">"lubridate"</span>, <span class="st">"ggplot2"</span>, <span class="st">"sf"</span>,<span class="st">"sp"</span>, <span class="st">"readr"</span>, <span class="st">"purrr"</span>, <span class="st">"stringr"</span>,<span class="st">"glue"</span>, <span class="st">"tidyr"</span>, <span class="st">"broom"</span>,<span class="st">"lme4"</span>, <span class="st">"knitr"</span>, <span class="st">"broom.mixed"</span>, <span class="st">"ppcor"</span>, <span class="st">"spdep"</span>, <span class="st">"spatialreg"</span>, <span class="st">"lmtest"</span>,<span class="st">"car"</span>, <span class="st">"spBayes"</span>, <span class="st">"coda"</span>, <span class="st">"patchwork"</span>, <span class="st">"performance"</span>, <span class="st">"terra"</span>, <span class="st">"ggpmisc"</span>, <span class="st">"gstat"</span>, <span class="st">"ggmcmc"</span>))</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a><span class="co"># source("~/phenology-urban/script/read_clean_WU.R")</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>select <span class="ot">&lt;-</span> dplyr<span class="sc">::</span>select</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="fu">## Intro</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Check the variogram</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>diagnistic for model</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>scale up</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>marginal prediction</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Key highlights (coordinate them with Juwon):</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Within-city variation, fall phenology: <span class="co">[</span><span class="ot">Katz et al., 2019</span><span class="co">](https://www.sciencedirect.com/science/article/pii/S0048969718343675)</span> <span class="co">[</span><span class="ot">Xing et al., 2022</span><span class="co">](https://link.springer.com/article/10.1007/s00484-022-02322-1)</span>. A few papers about intra-urban variation of phenology. Few about the fall phenology.</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Phenology pace, different taxa</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Preseason Optimization: At the year-, site-, and taxa-level. Individual-level pre-period might have some built-in relationship.</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Pace: As for the algorithm, more uncertainty around 0% and 100%. Use thresholds within the period (20â€“80%) to represent pace.</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Spatial regression: Use <span class="in">`nimble`</span> package to address spatial autocorrelation.</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a><span class="fu">## 1 Raw data</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1.1 Insert tree id base on WU data</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>For exploratory analysis, I used the street tree in NYC, with the phenology information established by Yiluan. These trees are part of the whole inventory, covering 14 genera and being sampled. I select the trees which are within **500 m** buffer around the weather underground sites (see @fig-tree_wu_sites).</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tree_wu_sites</span></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a><span class="do">################ For phenology data ################</span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>metadata <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"~/lab-data/datasets/vegetation/PS/urban/metadata.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(site <span class="sc">==</span> <span class="sc">!!</span>city)</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>file_list <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">"~/lab-data/datasets/vegetation/PS/urban/doy"</span>, <span class="at">pattern =</span> <span class="fu">paste0</span>(<span class="st">"^doy_"</span>,city,<span class="st">"_.*</span><span class="sc">\\</span><span class="st">.rds$"</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> file_list <span class="sc">%&gt;%</span></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">readRDS</span>(.x))</span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>all_doy <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(data_list)</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>tree_location <span class="ot">&lt;-</span> metadata <span class="sc">%&gt;%</span></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">genus =</span> <span class="fu">str_extract</span>(taxa, <span class="st">"^[^ ]+"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(all_doy, <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(doy))</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>just_tree_location <span class="ot">&lt;-</span> tree_location <span class="sc">%&gt;%</span></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a>wu_location <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>, city, <span class="st">"/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a>wu_buffer <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(wu_location, <span class="at">dist =</span> <span class="dv">500</span>)</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a>intersects <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(just_tree_location, wu_buffer)</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>id_buffer <span class="ot">&lt;-</span> just_tree_location <span class="sc">%&gt;%</span></span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">buffer_id =</span> <span class="fu">sapply</span>(intersects, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">1</span>) x[<span class="dv">1</span>] <span class="cf">else</span> <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(wu_buffer <span class="sc">%&gt;%</span> <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">buffer_id =</span> <span class="fu">row_number</span>()), <span class="at">by =</span> <span class="st">"buffer_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(buffer_id)) <span class="sc">%&gt;%</span></span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(id, Site) <span class="sc">%&gt;%</span></span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>    just_tree_location <span class="sc">%&gt;%</span></span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">lengths</span>(intersects) <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>      <span class="at">Site =</span> {</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a>        current_row_index <span class="ot">&lt;-</span> <span class="fu">which</span>(just_tree_location<span class="sc">$</span>id <span class="sc">==</span> id)</span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a>        intersected_buffers <span class="ot">&lt;-</span> intersects[[current_row_index]]</span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>        point_geom <span class="ot">&lt;-</span> geometry</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>        buffer_geoms <span class="ot">&lt;-</span> wu_location[intersected_buffers, ]<span class="sc">$</span>geometry</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>        distances <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(point_geom, buffer_geoms)</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>        nearest_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(distances)</span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>        wu_buffer<span class="sc">$</span>Site[intersected_buffers[nearest_index]]</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(id, Site)</span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>points_in_buffer <span class="ot">&lt;-</span> tree_location <span class="sc">%&gt;%</span></span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(id_buffer, <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Site))</span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a><span class="co"># write_csv(points_in_buffer, paste0("~/phenology-urban/data/proc/urban/", city, "/tree_WU_500_buffer_PS.csv"))</span></span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-tree_wu_sites</span></span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Location of WU sites and trees"</span></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a>points_in_buffer <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tree_WU_500_buffer_PS.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a>points_in_buffer_sf <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a>boundary <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a>  city,</span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NY"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DT/City_of_Detroit_Boundary/City_of_Detroit_Boundary.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ST"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/ST/seattle_boundary/CityUGA.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Seattle"</span>),</span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a>  <span class="st">"HT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/HT/kx-houston-texas-city-limits-SHP/houston-texas-city-limits.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a>  <span class="st">"TP"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/TP/Municipal_Boundary/Municipal_Boundary.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Tampa"</span>),</span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a>  <span class="st">"DV"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DV/denver-boundary/denver-colorado-county-boundary.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/AT/TxDOT_City_Boundaries/Cities.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Austin"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Invalid city abbreviation."</span>)</span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a>wu_location <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>, city, <span class="st">"/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> boundary, <span class="at">fill =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wu_location, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> points_in_buffer_sf, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="fl">0.01</span>) <span class="sc">+</span></span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1.2 Read and clean the WU data (based on GHCNd)</span></span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a>There are 4 raw daily variables selected, i.e. AvgTemp, HighTemp, LowTemp and Precipitation_sum (Sum_mm). I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily <span class="co">[</span><span class="ot">GHCNd</span><span class="co">](https://www.ncei.noaa.gov/products/land-based-station/global-historical-climatology-network-daily)</span>.</span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: read_wu_data</span></span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a><span class="co"># all_sites_temp &lt;- read_clean_WU(city = "ST", run_checks = TRUE)</span></span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a>all_sites_temp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>,city,<span class="st">"/"</span>,city,<span class="st">"_wu.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(Date, HighTemp, AvgTemp, LowTemp, Sum_mm, name))</span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1.3 Shortwave data from Daymet</span></span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a>To control for the influence of other variables on phenology, I also incorporated shortwave radiation data derived from the Daymet daily dataset with a 1 km resolution. Shortwave radiation was extracted for the specific locations of the trees.</span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: plot_function</span></span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a><span class="co"># download</span></span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a>srad_daily <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/raw/"</span>,city,<span class="st">"/Daymet/daily2016-2024/srad_daily_2016-2023.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(id, value, date)</span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2 Find the optimal preseason</span></span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a>The seasonal climate variables use a fixed pre-season for every trees, not allowing heterogeneity within city. Also, the roughly divided season make it difficult to connect to phenology process, e.g. chilling and forcing accumulation. Therefore, some studies use varing preseason or optimal preseason.</span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Meng et al., 2020</span><span class="co">](https://www.sciencedirect.com/science/article/pii/S0168192319304484?via%3Dihub)</span>, <span class="co">[</span><span class="ot">Wang et al., 2021</span><span class="co">](https://onlinelibrary.wiley.com/doi/10.1111/gcb.15777)</span>: The preseason was defined as the period from November 1st in the previous year to the time of <span class="in">`SOS`</span> in the current year. (most fixed)</span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">Meng et al., 2020</span><span class="co">](https://www.pnas.org/doi/10.1073/pnas.1911117117#sec-3)</span>, <span class="co">[</span><span class="ot">Yin et al., 2024</span><span class="co">](https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2023EF004127)</span>: For each city, the period for which the absolute value of the partial correlation coefficient between <span class="in">`SOS`</span> and <span class="in">`Temp`</span> was highest was considered the optimal length of the preseason most relevant to <span class="in">`SOS`</span>. (more flexible, cadidate time: 0 to 6 months prior to SOS, 5-day interval approach from January 1st to the average SOS date)</span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a>Here, based on the variable (phenology metric: <span class="in">`SOS`</span>, <span class="in">`EOS`</span>, <span class="in">`green-up pace`</span>, <span class="in">`green-down pace`</span>, temp. metric: t_avg, t_min, t_max), I find the optimal preseason at genus-city level (ignore the year for now due to sample size). The period for which the absolute value of the partial correlation coefficient between phenology and temp. metric is highest is considered the optimal length of the preseason most relevant to the certain phenology metric.</span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: optimal_preseason_fun</span></span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a>calculate_partial_correlation <span class="ot">&lt;-</span> <span class="cf">function</span>(insert_data, direction, thres, genus, pre_lengths, </span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a>                                          phe_variable, temp_variable) {</span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a>  subset_tree_pcor <span class="ot">&lt;-</span> insert_data <span class="sc">%&gt;%</span></span>
<span id="cb28-217"><a href="#cb28-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="sc">!!</span>thres <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus)</span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(pre_lengths, <span class="cf">function</span>(pre_length) {</span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Preseason length (days):"</span>, pre_length, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a>    preseason_var <span class="ot">&lt;-</span> subset_tree_pcor <span class="sc">%&gt;%</span></span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a>        <span class="at">start_date =</span> <span class="fu">make_date</span>(year) <span class="sc">+</span> <span class="fu">days</span>(<span class="fu">round</span>(<span class="fu">mean</span>(doy)) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">days</span>(pre_length),</span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a>        <span class="at">end_date =</span> <span class="fu">make_date</span>(year) <span class="sc">+</span> <span class="fu">days</span>(<span class="fu">round</span>(<span class="fu">mean</span>(doy)) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a>    temp_stats <span class="ot">&lt;-</span> all_sites_temp <span class="sc">%&gt;%</span></span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a>      <span class="co"># filter(name %in% preseason_var$Site) %&gt;%</span></span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(preseason_var, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"Site"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> start_date <span class="sc">&amp;</span> Date <span class="sc">&lt;=</span> end_date) <span class="sc">%&gt;%</span></span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(id,year) <span class="sc">%&gt;%</span></span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a>        <span class="at">LowTemp_mean =</span> <span class="fu">mean</span>(LowTemp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a>        <span class="at">LowTemp_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(LowTemp)),</span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a>        <span class="at">AvgTemp_mean =</span> <span class="fu">mean</span>(AvgTemp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a>        <span class="at">AvgTemp_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(AvgTemp)),</span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a>        <span class="at">HighTemp_mean =</span> <span class="fu">mean</span>(HighTemp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a>        <span class="at">HighTemp_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(HighTemp)),</span>
<span id="cb28-238"><a href="#cb28-238" aria-hidden="true" tabindex="-1"></a>        <span class="at">Sum_mm_sum =</span> <span class="fu">sum</span>(Sum_mm, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-239"><a href="#cb28-239" aria-hidden="true" tabindex="-1"></a>        <span class="at">Sum_mm_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(Sum_mm)),</span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a>    srad_stats <span class="ot">&lt;-</span> srad_daily <span class="sc">%&gt;%</span></span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a>      <span class="co"># filter(id %in% preseason_var$id) %&gt;%</span></span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a>      <span class="fu">inner_join</span>(preseason_var, <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(date <span class="sc">&gt;=</span> start_date <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> end_date) <span class="sc">%&gt;%</span></span>
<span id="cb28-247"><a href="#cb28-247" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(id,year) <span class="sc">%&gt;%</span></span>
<span id="cb28-248"><a href="#cb28-248" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a>        <span class="at">srad_mean =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a>        <span class="at">srad_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)),</span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a>    preseason_var <span class="ot">&lt;-</span> preseason_var <span class="sc">%&gt;%</span></span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(temp_stats, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span>,<span class="st">"year"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(srad_stats, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id"</span>,<span class="st">"year"</span>))</span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (temp_variable <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"LowTemp_mean"</span>, <span class="st">"HighTemp_mean"</span>)){</span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a>      selected_data <span class="ot">&lt;-</span> preseason_var <span class="sc">%&gt;%</span></span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb28-262"><a href="#cb28-262" aria-hidden="true" tabindex="-1"></a>        {{ phe_variable }}, LowTemp_mean, HighTemp_mean, Sum_mm_sum,  srad_mean</span>
<span id="cb28-263"><a href="#cb28-263" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a>      <span class="fu">na.omit</span>()</span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a>      selected_data <span class="ot">&lt;-</span> preseason_var <span class="sc">%&gt;%</span></span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">select</span>(</span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a>        {{ phe_variable }}, AvgTemp_mean,Sum_mm_sum, srad_mean</span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a>      <span class="fu">na.omit</span>()</span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a>    partial_corr <span class="ot">&lt;-</span> <span class="fu">pcor</span>(selected_data)</span>
<span id="cb28-273"><a href="#cb28-273" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-274"><a href="#cb28-274" aria-hidden="true" tabindex="-1"></a>    correlation <span class="ot">&lt;-</span> partial_corr<span class="sc">$</span>estimate[</span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rownames</span>(partial_corr<span class="sc">$</span>estimate) <span class="sc">==</span> phe_variable, </span>
<span id="cb28-276"><a href="#cb28-276" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(partial_corr<span class="sc">$</span>estimate) <span class="sc">==</span> temp_variable</span>
<span id="cb28-277"><a href="#cb28-277" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a>    pvalue <span class="ot">&lt;-</span> partial_corr<span class="sc">$</span>p.value[</span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rownames</span>(partial_corr<span class="sc">$</span>p.value) <span class="sc">==</span> phe_variable, </span>
<span id="cb28-280"><a href="#cb28-280" aria-hidden="true" tabindex="-1"></a>        <span class="fu">colnames</span>(partial_corr<span class="sc">$</span>p.value) <span class="sc">==</span> temp_variable</span>
<span id="cb28-281"><a href="#cb28-281" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb28-282"><a href="#cb28-282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">correlation =</span> correlation, <span class="at">pvalue =</span> pvalue, <span class="at">preseason_var =</span> preseason_var)</span>
<span id="cb28-283"><a href="#cb28-283" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb28-284"><a href="#cb28-284" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-285"><a href="#cb28-285" aria-hidden="true" tabindex="-1"></a>  correlations <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(x) (x<span class="sc">$</span>correlation))</span>
<span id="cb28-286"><a href="#cb28-286" aria-hidden="true" tabindex="-1"></a>  pvalues <span class="ot">&lt;-</span> <span class="fu">sapply</span>(results, <span class="cf">function</span>(x) (x<span class="sc">$</span>pvalue))</span>
<span id="cb28-287"><a href="#cb28-287" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-288"><a href="#cb28-288" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-289"><a href="#cb28-289" aria-hidden="true" tabindex="-1"></a>  max_idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(<span class="fu">abs</span>(correlations))</span>
<span id="cb28-290"><a href="#cb28-290" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-291"><a href="#cb28-291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb28-292"><a href="#cb28-292" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimal_pre_length =</span> pre_lengths[max_idx],</span>
<span id="cb28-293"><a href="#cb28-293" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_candidate  =</span> pre_lengths,</span>
<span id="cb28-294"><a href="#cb28-294" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_trend =</span> correlations,</span>
<span id="cb28-295"><a href="#cb28-295" aria-hidden="true" tabindex="-1"></a>    <span class="at">pvalue_trend =</span> pvalues,</span>
<span id="cb28-296"><a href="#cb28-296" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_correlation =</span> results[[max_idx]]<span class="sc">$</span>correlation,</span>
<span id="cb28-297"><a href="#cb28-297" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_corr_pvalue =</span> results[[max_idx]]<span class="sc">$</span>pvalue,</span>
<span id="cb28-298"><a href="#cb28-298" aria-hidden="true" tabindex="-1"></a>    <span class="at">preseason_var =</span> results[[max_idx]]<span class="sc">$</span>preseason_var</span>
<span id="cb28-299"><a href="#cb28-299" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-300"><a href="#cb28-300" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-301"><a href="#cb28-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-302"><a href="#cb28-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-303"><a href="#cb28-303" aria-hidden="true" tabindex="-1"></a>pre_lengths <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">5</span>, <span class="dv">180</span>, <span class="at">by =</span> <span class="dv">5</span>)</span>
<span id="cb28-304"><a href="#cb28-304" aria-hidden="true" tabindex="-1"></a>all_genus <span class="ot">&lt;-</span> <span class="fu">unique</span>(points_in_buffer<span class="sc">$</span>genus)</span>
<span id="cb28-305"><a href="#cb28-305" aria-hidden="true" tabindex="-1"></a>temp_variable <span class="ot">=</span> <span class="st">"AvgTemp_mean"</span></span>
<span id="cb28-306"><a href="#cb28-306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-307"><a href="#cb28-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-308"><a href="#cb28-308" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.1 Spring phenology</span></span>
<span id="cb28-309"><a href="#cb28-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-310"><a href="#cb28-310" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `SOS` date</span></span>
<span id="cb28-311"><a href="#cb28-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-312"><a href="#cb28-312" aria-hidden="true" tabindex="-1"></a>Defined as the day of year when individual tree growing season EVI curves first cross the green-up 50% threshold.</span>
<span id="cb28-313"><a href="#cb28-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-316"><a href="#cb28-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-317"><a href="#cb28-317" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: optimal_preseason_SOS</span></span>
<span id="cb28-318"><a href="#cb28-318" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb28-319"><a href="#cb28-319" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-320"><a href="#cb28-320" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-321"><a href="#cb28-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-322"><a href="#cb28-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-323"><a href="#cb28-323" aria-hidden="true" tabindex="-1"></a>direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb28-324"><a href="#cb28-324" aria-hidden="true" tabindex="-1"></a>thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb28-325"><a href="#cb28-325" aria-hidden="true" tabindex="-1"></a>phe_variable <span class="ot">=</span> <span class="st">"doy"</span></span>
<span id="cb28-326"><a href="#cb28-326" aria-hidden="true" tabindex="-1"></a>insert_data <span class="ot">=</span> points_in_buffer</span>
<span id="cb28-327"><a href="#cb28-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-328"><a href="#cb28-328" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-329"><a href="#cb28-329" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_genus, <span class="cf">function</span>(genus) {</span>
<span id="cb28-330"><a href="#cb28-330" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processing genus:"</span>, genus, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-331"><a href="#cb28-331" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">calculate_partial_correlation</span>(</span>
<span id="cb28-332"><a href="#cb28-332" aria-hidden="true" tabindex="-1"></a>    <span class="at">insert_data =</span> insert_data,</span>
<span id="cb28-333"><a href="#cb28-333" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> direction,</span>
<span id="cb28-334"><a href="#cb28-334" aria-hidden="true" tabindex="-1"></a>    <span class="at">thres =</span> thres,</span>
<span id="cb28-335"><a href="#cb28-335" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb28-336"><a href="#cb28-336" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_lengths =</span> pre_lengths,</span>
<span id="cb28-337"><a href="#cb28-337" aria-hidden="true" tabindex="-1"></a>    <span class="at">phe_variable =</span> phe_variable,</span>
<span id="cb28-338"><a href="#cb28-338" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_variable =</span> temp_variable</span>
<span id="cb28-339"><a href="#cb28-339" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-340"><a href="#cb28-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb28-341"><a href="#cb28-341" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-342"><a href="#cb28-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-343"><a href="#cb28-343" aria-hidden="true" tabindex="-1"></a>spring_date_preseason_var <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) x<span class="sc">$</span>preseason_var))</span>
<span id="cb28-344"><a href="#cb28-344" aria-hidden="true" tabindex="-1"></a>spring_date_combined_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) {</span>
<span id="cb28-345"><a href="#cb28-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb28-346"><a href="#cb28-346" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> <span class="fu">unique</span>(x<span class="sc">$</span>preseason_var<span class="sc">$</span>genus),</span>
<span id="cb28-347"><a href="#cb28-347" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimal_pre_length =</span> x<span class="sc">$</span>optimal_pre_length,</span>
<span id="cb28-348"><a href="#cb28-348" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_correlation =</span> x<span class="sc">$</span>partial_correlation,</span>
<span id="cb28-349"><a href="#cb28-349" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_corr_pvalue =</span> x<span class="sc">$</span>partial_corr_pvalue,</span>
<span id="cb28-350"><a href="#cb28-350" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_candidate =</span> x<span class="sc">$</span>pre_length_candidate,</span>
<span id="cb28-351"><a href="#cb28-351" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_trend =</span> x<span class="sc">$</span>pre_length_trend,</span>
<span id="cb28-352"><a href="#cb28-352" aria-hidden="true" tabindex="-1"></a>    <span class="at">pvalue_trend =</span> x<span class="sc">$</span>pvalue_trend</span>
<span id="cb28-353"><a href="#cb28-353" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-354"><a href="#cb28-354" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-355"><a href="#cb28-355" aria-hidden="true" tabindex="-1"></a>spring_date_combined_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(spring_date_combined_results, as.data.frame))</span>
<span id="cb28-356"><a href="#cb28-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-357"><a href="#cb28-357" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-358"><a href="#cb28-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-359"><a href="#cb28-359" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Green-up Pace</span></span>
<span id="cb28-360"><a href="#cb28-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-361"><a href="#cb28-361" aria-hidden="true" tabindex="-1"></a>Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-up 20% threshold to the 80% threshold.</span>
<span id="cb28-362"><a href="#cb28-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-365"><a href="#cb28-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-366"><a href="#cb28-366" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: optimal_preseason_greenup_pace</span></span>
<span id="cb28-367"><a href="#cb28-367" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb28-368"><a href="#cb28-368" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-369"><a href="#cb28-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-370"><a href="#cb28-370" aria-hidden="true" tabindex="-1"></a>diff <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb28-371"><a href="#cb28-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year, id, direction) <span class="sc">%&gt;%</span></span>
<span id="cb28-372"><a href="#cb28-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(thres <span class="sc">%in%</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb28-373"><a href="#cb28-373" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb28-374"><a href="#cb28-374" aria-hidden="true" tabindex="-1"></a>    <span class="at">doy_diff =</span> <span class="fu">abs</span>(<span class="fu">diff</span>(doy[<span class="fu">order</span>(thres)])),</span>
<span id="cb28-375"><a href="#cb28-375" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb28-376"><a href="#cb28-376" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-377"><a href="#cb28-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-378"><a href="#cb28-378" aria-hidden="true" tabindex="-1"></a>points_with_diff <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb28-379"><a href="#cb28-379" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(diff, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"id"</span>, <span class="st">"direction"</span>))</span>
<span id="cb28-380"><a href="#cb28-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-381"><a href="#cb28-381" aria-hidden="true" tabindex="-1"></a>direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb28-382"><a href="#cb28-382" aria-hidden="true" tabindex="-1"></a>thres <span class="ot">&lt;-</span> <span class="fl">0.2</span>              <span class="co"># change to 0.5?</span></span>
<span id="cb28-383"><a href="#cb28-383" aria-hidden="true" tabindex="-1"></a>phe_variable <span class="ot">=</span> <span class="st">"doy_diff"</span></span>
<span id="cb28-384"><a href="#cb28-384" aria-hidden="true" tabindex="-1"></a>insert_data <span class="ot">=</span> points_with_diff</span>
<span id="cb28-385"><a href="#cb28-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-386"><a href="#cb28-386" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-387"><a href="#cb28-387" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_genus, <span class="cf">function</span>(genus) {</span>
<span id="cb28-388"><a href="#cb28-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processing genus:"</span>, genus, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-389"><a href="#cb28-389" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">calculate_partial_correlation</span>(</span>
<span id="cb28-390"><a href="#cb28-390" aria-hidden="true" tabindex="-1"></a>    <span class="at">insert_data =</span> insert_data,</span>
<span id="cb28-391"><a href="#cb28-391" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> direction,</span>
<span id="cb28-392"><a href="#cb28-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">thres =</span> thres,</span>
<span id="cb28-393"><a href="#cb28-393" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb28-394"><a href="#cb28-394" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_lengths =</span> pre_lengths,</span>
<span id="cb28-395"><a href="#cb28-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">phe_variable =</span> phe_variable,</span>
<span id="cb28-396"><a href="#cb28-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_variable =</span> temp_variable</span>
<span id="cb28-397"><a href="#cb28-397" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-398"><a href="#cb28-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb28-399"><a href="#cb28-399" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-400"><a href="#cb28-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-401"><a href="#cb28-401" aria-hidden="true" tabindex="-1"></a>spring_pace_preseason_var <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) x<span class="sc">$</span>preseason_var))</span>
<span id="cb28-402"><a href="#cb28-402" aria-hidden="true" tabindex="-1"></a>spring_pace_combined_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) {</span>
<span id="cb28-403"><a href="#cb28-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb28-404"><a href="#cb28-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> <span class="fu">unique</span>(x<span class="sc">$</span>preseason_var<span class="sc">$</span>genus),</span>
<span id="cb28-405"><a href="#cb28-405" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimal_pre_length =</span> x<span class="sc">$</span>optimal_pre_length,</span>
<span id="cb28-406"><a href="#cb28-406" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_correlation =</span> x<span class="sc">$</span>partial_correlation,</span>
<span id="cb28-407"><a href="#cb28-407" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_corr_pvalue =</span> x<span class="sc">$</span>partial_corr_pvalue,</span>
<span id="cb28-408"><a href="#cb28-408" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_candidate =</span> x<span class="sc">$</span>pre_length_candidate,</span>
<span id="cb28-409"><a href="#cb28-409" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_trend =</span> x<span class="sc">$</span>pre_length_trend,</span>
<span id="cb28-410"><a href="#cb28-410" aria-hidden="true" tabindex="-1"></a>    <span class="at">pvalue_trend =</span> x<span class="sc">$</span>pvalue_trend</span>
<span id="cb28-411"><a href="#cb28-411" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-412"><a href="#cb28-412" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-413"><a href="#cb28-413" aria-hidden="true" tabindex="-1"></a>spring_pace_combined_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(spring_pace_combined_results, as.data.frame))</span>
<span id="cb28-414"><a href="#cb28-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-415"><a href="#cb28-415" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-416"><a href="#cb28-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-417"><a href="#cb28-417" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.2 Fall phenology</span></span>
<span id="cb28-418"><a href="#cb28-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-419"><a href="#cb28-419" aria-hidden="true" tabindex="-1"></a><span class="fu">#### `EOS` date</span></span>
<span id="cb28-420"><a href="#cb28-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-421"><a href="#cb28-421" aria-hidden="true" tabindex="-1"></a>Defined as the day of year when individual tree growing season EVI curves first cross the green-down 50% threshold.</span>
<span id="cb28-422"><a href="#cb28-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-425"><a href="#cb28-425" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-426"><a href="#cb28-426" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: optimal_preseason_EOS</span></span>
<span id="cb28-427"><a href="#cb28-427" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-ncol: 2</span></span>
<span id="cb28-428"><a href="#cb28-428" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb28-429"><a href="#cb28-429" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-430"><a href="#cb28-430" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-431"><a href="#cb28-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-432"><a href="#cb28-432" aria-hidden="true" tabindex="-1"></a>direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb28-433"><a href="#cb28-433" aria-hidden="true" tabindex="-1"></a>thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb28-434"><a href="#cb28-434" aria-hidden="true" tabindex="-1"></a>phe_variable <span class="ot">=</span> <span class="st">"doy"</span></span>
<span id="cb28-435"><a href="#cb28-435" aria-hidden="true" tabindex="-1"></a>insert_data <span class="ot">=</span> points_in_buffer</span>
<span id="cb28-436"><a href="#cb28-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-437"><a href="#cb28-437" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-438"><a href="#cb28-438" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_genus, <span class="cf">function</span>(genus) {</span>
<span id="cb28-439"><a href="#cb28-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processing genus:"</span>, genus, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-440"><a href="#cb28-440" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb28-441"><a href="#cb28-441" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">calculate_partial_correlation</span>(</span>
<span id="cb28-442"><a href="#cb28-442" aria-hidden="true" tabindex="-1"></a>    <span class="at">insert_data =</span> insert_data,</span>
<span id="cb28-443"><a href="#cb28-443" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> direction,</span>
<span id="cb28-444"><a href="#cb28-444" aria-hidden="true" tabindex="-1"></a>    <span class="at">thres =</span> thres,</span>
<span id="cb28-445"><a href="#cb28-445" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb28-446"><a href="#cb28-446" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_lengths =</span> pre_lengths,</span>
<span id="cb28-447"><a href="#cb28-447" aria-hidden="true" tabindex="-1"></a>    <span class="at">phe_variable =</span> phe_variable,</span>
<span id="cb28-448"><a href="#cb28-448" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_variable =</span> temp_variable</span>
<span id="cb28-449"><a href="#cb28-449" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-450"><a href="#cb28-450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb28-451"><a href="#cb28-451" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-452"><a href="#cb28-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-453"><a href="#cb28-453" aria-hidden="true" tabindex="-1"></a>fall_date_preseason_var <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) x<span class="sc">$</span>preseason_var))</span>
<span id="cb28-454"><a href="#cb28-454" aria-hidden="true" tabindex="-1"></a>fall_date_combined_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) {</span>
<span id="cb28-455"><a href="#cb28-455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb28-456"><a href="#cb28-456" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> <span class="fu">unique</span>(x<span class="sc">$</span>preseason_var<span class="sc">$</span>genus),</span>
<span id="cb28-457"><a href="#cb28-457" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimal_pre_length =</span> x<span class="sc">$</span>optimal_pre_length,</span>
<span id="cb28-458"><a href="#cb28-458" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_correlation =</span> x<span class="sc">$</span>partial_correlation,</span>
<span id="cb28-459"><a href="#cb28-459" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_corr_pvalue =</span> x<span class="sc">$</span>partial_corr_pvalue,</span>
<span id="cb28-460"><a href="#cb28-460" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_candidate =</span> x<span class="sc">$</span>pre_length_candidate,</span>
<span id="cb28-461"><a href="#cb28-461" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_trend =</span> x<span class="sc">$</span>pre_length_trend,</span>
<span id="cb28-462"><a href="#cb28-462" aria-hidden="true" tabindex="-1"></a>    <span class="at">pvalue_trend =</span> x<span class="sc">$</span>pvalue_trend</span>
<span id="cb28-463"><a href="#cb28-463" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-464"><a href="#cb28-464" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-465"><a href="#cb28-465" aria-hidden="true" tabindex="-1"></a>fall_date_combined_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(fall_date_combined_results, as.data.frame))</span>
<span id="cb28-466"><a href="#cb28-466" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-467"><a href="#cb28-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-468"><a href="#cb28-468" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Green-down Pace</span></span>
<span id="cb28-469"><a href="#cb28-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-470"><a href="#cb28-470" aria-hidden="true" tabindex="-1"></a>Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-down 20% threshold to the 80% threshold.</span>
<span id="cb28-471"><a href="#cb28-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-474"><a href="#cb28-474" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-475"><a href="#cb28-475" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: optimal_preseason_greendown_pace</span></span>
<span id="cb28-476"><a href="#cb28-476" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb28-477"><a href="#cb28-477" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: TRUE</span></span>
<span id="cb28-478"><a href="#cb28-478" aria-hidden="true" tabindex="-1"></a>direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb28-479"><a href="#cb28-479" aria-hidden="true" tabindex="-1"></a>thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb28-480"><a href="#cb28-480" aria-hidden="true" tabindex="-1"></a>phe_variable <span class="ot">=</span> <span class="st">"doy_diff"</span></span>
<span id="cb28-481"><a href="#cb28-481" aria-hidden="true" tabindex="-1"></a>insert_data <span class="ot">=</span> points_with_diff</span>
<span id="cb28-482"><a href="#cb28-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-483"><a href="#cb28-483" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-484"><a href="#cb28-484" aria-hidden="true" tabindex="-1"></a>all_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_genus, <span class="cf">function</span>(genus) {</span>
<span id="cb28-485"><a href="#cb28-485" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processing genus:"</span>, genus, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-486"><a href="#cb28-486" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb28-487"><a href="#cb28-487" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">calculate_partial_correlation</span>(</span>
<span id="cb28-488"><a href="#cb28-488" aria-hidden="true" tabindex="-1"></a>    <span class="at">insert_data =</span> insert_data,</span>
<span id="cb28-489"><a href="#cb28-489" aria-hidden="true" tabindex="-1"></a>    <span class="at">direction =</span> direction,</span>
<span id="cb28-490"><a href="#cb28-490" aria-hidden="true" tabindex="-1"></a>    <span class="at">thres =</span> thres,</span>
<span id="cb28-491"><a href="#cb28-491" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb28-492"><a href="#cb28-492" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_lengths =</span> pre_lengths,</span>
<span id="cb28-493"><a href="#cb28-493" aria-hidden="true" tabindex="-1"></a>    <span class="at">phe_variable =</span> phe_variable,</span>
<span id="cb28-494"><a href="#cb28-494" aria-hidden="true" tabindex="-1"></a>    <span class="at">temp_variable =</span> temp_variable</span>
<span id="cb28-495"><a href="#cb28-495" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-496"><a href="#cb28-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb28-497"><a href="#cb28-497" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-498"><a href="#cb28-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-499"><a href="#cb28-499" aria-hidden="true" tabindex="-1"></a>fall_pace_preseason_var <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) x<span class="sc">$</span>preseason_var))</span>
<span id="cb28-500"><a href="#cb28-500" aria-hidden="true" tabindex="-1"></a>fall_pace_combined_results <span class="ot">&lt;-</span> <span class="fu">lapply</span>(all_results, <span class="cf">function</span>(x) {</span>
<span id="cb28-501"><a href="#cb28-501" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb28-502"><a href="#cb28-502" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> <span class="fu">unique</span>(x<span class="sc">$</span>preseason_var<span class="sc">$</span>genus),</span>
<span id="cb28-503"><a href="#cb28-503" aria-hidden="true" tabindex="-1"></a>    <span class="at">optimal_pre_length =</span> x<span class="sc">$</span>optimal_pre_length,</span>
<span id="cb28-504"><a href="#cb28-504" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_correlation =</span> x<span class="sc">$</span>partial_correlation,</span>
<span id="cb28-505"><a href="#cb28-505" aria-hidden="true" tabindex="-1"></a>    <span class="at">partial_corr_pvalue =</span> x<span class="sc">$</span>partial_corr_pvalue,</span>
<span id="cb28-506"><a href="#cb28-506" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_candidate =</span> x<span class="sc">$</span>pre_length_candidate,</span>
<span id="cb28-507"><a href="#cb28-507" aria-hidden="true" tabindex="-1"></a>    <span class="at">pre_length_trend =</span> x<span class="sc">$</span>pre_length_trend,</span>
<span id="cb28-508"><a href="#cb28-508" aria-hidden="true" tabindex="-1"></a>    <span class="at">pvalue_trend =</span> x<span class="sc">$</span>pvalue_trend</span>
<span id="cb28-509"><a href="#cb28-509" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-510"><a href="#cb28-510" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-511"><a href="#cb28-511" aria-hidden="true" tabindex="-1"></a>fall_pace_combined_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, <span class="fu">lapply</span>(fall_pace_combined_results, as.data.frame))</span>
<span id="cb28-512"><a href="#cb28-512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-513"><a href="#cb28-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-516"><a href="#cb28-516" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-517"><a href="#cb28-517" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: store_resuts</span></span>
<span id="cb28-518"><a href="#cb28-518" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: FALSE</span></span>
<span id="cb28-519"><a href="#cb28-519" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb28-520"><a href="#cb28-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-521"><a href="#cb28-521" aria-hidden="true" tabindex="-1"></a><span class="co"># tavg_allyear_var &lt;- spring_date_preseason_var %&gt;%</span></span>
<span id="cb28-522"><a href="#cb28-522" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(doy_diff = "NA") %&gt;%</span></span>
<span id="cb28-523"><a href="#cb28-523" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(spring_pace_preseason_var, fall_pace_preseason_var) %&gt;%</span></span>
<span id="cb28-524"><a href="#cb28-524" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(fall_date_preseason_var %&gt;% mutate(doy_diff = "NA")) %&gt;%</span></span>
<span id="cb28-525"><a href="#cb28-525" aria-hidden="true" tabindex="-1"></a><span class="co">#   saveRDS(paste0("~/phenology-urban/data/proc/urban/", city, "/tavg_allyear_var.rds"))</span></span>
<span id="cb28-526"><a href="#cb28-526" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-527"><a href="#cb28-527" aria-hidden="true" tabindex="-1"></a><span class="co"># tavg_allyear_pcorr &lt;- spring_date_combined_results %&gt;%</span></span>
<span id="cb28-528"><a href="#cb28-528" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(type = "SOS") %&gt;%</span></span>
<span id="cb28-529"><a href="#cb28-529" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(spring_pace_combined_results %&gt;% mutate(type = "green-up pace")) %&gt;%</span></span>
<span id="cb28-530"><a href="#cb28-530" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(fall_pace_combined_results %&gt;% mutate(type = "green-down pace")) %&gt;%</span></span>
<span id="cb28-531"><a href="#cb28-531" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(fall_date_combined_results %&gt;% mutate(type = "EOS"))%&gt;%</span></span>
<span id="cb28-532"><a href="#cb28-532" aria-hidden="true" tabindex="-1"></a><span class="co">#   saveRDS(paste0("~/phenology-urban/data/proc/urban/", city, "/tavg_allyear_pcorr.rds"))</span></span>
<span id="cb28-533"><a href="#cb28-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-534"><a href="#cb28-534" aria-hidden="true" tabindex="-1"></a><span class="co"># thigh_allyear_var &lt;- spring_date_preseason_var %&gt;%</span></span>
<span id="cb28-535"><a href="#cb28-535" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(doy_diff = "NA") %&gt;%</span></span>
<span id="cb28-536"><a href="#cb28-536" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(spring_pace_preseason_var, fall_pace_preseason_var) %&gt;%</span></span>
<span id="cb28-537"><a href="#cb28-537" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(fall_date_preseason_var %&gt;% mutate(doy_diff = "NA")) %&gt;%</span></span>
<span id="cb28-538"><a href="#cb28-538" aria-hidden="true" tabindex="-1"></a><span class="co">#   saveRDS("~/phenology-urban/data/proc/urban/", city, "/thigh_allyear_var.rds")</span></span>
<span id="cb28-539"><a href="#cb28-539" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-540"><a href="#cb28-540" aria-hidden="true" tabindex="-1"></a><span class="co"># thigh_allyear_pcorr &lt;- spring_date_combined_results %&gt;%</span></span>
<span id="cb28-541"><a href="#cb28-541" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(type = "SOS") %&gt;%</span></span>
<span id="cb28-542"><a href="#cb28-542" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(spring_pace_combined_results %&gt;% mutate(type = "green-up pace")) %&gt;%</span></span>
<span id="cb28-543"><a href="#cb28-543" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(fall_pace_combined_results %&gt;% mutate(type = "green-down pace")) %&gt;%</span></span>
<span id="cb28-544"><a href="#cb28-544" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(fall_date_combined_results %&gt;% mutate(type = "EOS"))%&gt;%</span></span>
<span id="cb28-545"><a href="#cb28-545" aria-hidden="true" tabindex="-1"></a><span class="co">#   saveRDS("~/phenology-urban/data/proc/urban/", city, "/thigh_allyear_pcorr.rds")</span></span>
<span id="cb28-546"><a href="#cb28-546" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-547"><a href="#cb28-547" aria-hidden="true" tabindex="-1"></a><span class="co"># tlow_allyear_var &lt;- spring_date_preseason_var %&gt;%</span></span>
<span id="cb28-548"><a href="#cb28-548" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(doy_diff = "NA") %&gt;%</span></span>
<span id="cb28-549"><a href="#cb28-549" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(spring_pace_preseason_var, fall_pace_preseason_var) %&gt;%</span></span>
<span id="cb28-550"><a href="#cb28-550" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(fall_date_preseason_var %&gt;% mutate(doy_diff = "NA")) %&gt;%</span></span>
<span id="cb28-551"><a href="#cb28-551" aria-hidden="true" tabindex="-1"></a><span class="co">#   saveRDS("~/phenology-urban/data/proc/urban/", city, "/tlow_allyear_var.rds")</span></span>
<span id="cb28-552"><a href="#cb28-552" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb28-553"><a href="#cb28-553" aria-hidden="true" tabindex="-1"></a><span class="co"># tlow_allyear_pcorr &lt;- spring_date_combined_results %&gt;%</span></span>
<span id="cb28-554"><a href="#cb28-554" aria-hidden="true" tabindex="-1"></a><span class="co">#   mutate(type = "SOS") %&gt;%</span></span>
<span id="cb28-555"><a href="#cb28-555" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(spring_pace_combined_results %&gt;% mutate(type = "green-up pace")) %&gt;%</span></span>
<span id="cb28-556"><a href="#cb28-556" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(fall_pace_combined_results %&gt;% mutate(type = "green-down pace")) %&gt;%</span></span>
<span id="cb28-557"><a href="#cb28-557" aria-hidden="true" tabindex="-1"></a><span class="co">#   rbind(fall_date_combined_results %&gt;% mutate(type = "EOS"))%&gt;%</span></span>
<span id="cb28-558"><a href="#cb28-558" aria-hidden="true" tabindex="-1"></a><span class="co">#   saveRDS("~/phenology-urban/data/proc/urban/", city, "/tlow_allyear_pcorr.rds")</span></span>
<span id="cb28-559"><a href="#cb28-559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-560"><a href="#cb28-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-561"><a href="#cb28-561" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.3 Optimal preseason length calculated by Temp~avg~</span></span>
<span id="cb28-562"><a href="#cb28-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-563"><a href="#cb28-563" aria-hidden="true" tabindex="-1"></a>@fig-partial_preseason displays the distribution of optimal preseason length and partial correlation coefficient calculated by Temp~avg~ for <span class="in">`SOS`</span>, <span class="in">`Greenup pace`</span>, <span class="in">`EOS`</span> and <span class="in">`Greenup pace`</span>, respectively.</span>
<span id="cb28-564"><a href="#cb28-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-565"><a href="#cb28-565" aria-hidden="true" tabindex="-1"></a>As for <span class="in">`SOS`</span>, all genera have negetive partial correlation coefficients, which means the higher preseason average temperature, the earlier start of season. As for <span class="in">`Greenup pace`</span>, most genera (except Carya, Celtis) have negetive partial correlation coefficients, which means the higher preseason average temperature, the faster green up pace. The preseason length varies significantly among genera.</span>
<span id="cb28-566"><a href="#cb28-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-567"><a href="#cb28-567" aria-hidden="true" tabindex="-1"></a>As for <span class="in">`EOS`</span>, most genera (except Populus, Platanus) have positive partial correlation coefficients, which means the higher preseason average temperature, the later end of season. As for <span class="in">`Greenup pace`</span>, there is variation in impact direction among genera. The preseason length also varies significantly among genera.</span>
<span id="cb28-568"><a href="#cb28-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-571"><a href="#cb28-571" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-572"><a href="#cb28-572" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-partial_preseason</span></span>
<span id="cb28-573"><a href="#cb28-573" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-ncol: 1</span></span>
<span id="cb28-574"><a href="#cb28-574" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of partial correlation coefficient and preseason length, calculated by Temp~avg~"</span></span>
<span id="cb28-575"><a href="#cb28-575" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap: </span></span>
<span id="cb28-576"><a href="#cb28-576" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Spring phenology"</span></span>
<span id="cb28-577"><a href="#cb28-577" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Fall phenology"</span></span>
<span id="cb28-578"><a href="#cb28-578" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-579"><a href="#cb28-579" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 13</span></span>
<span id="cb28-580"><a href="#cb28-580" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 6</span></span>
<span id="cb28-581"><a href="#cb28-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-582"><a href="#cb28-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-583"><a href="#cb28-583" aria-hidden="true" tabindex="-1"></a>tavg_allyear_pcorr <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tavg_allyear_pcorr.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-584"><a href="#cb28-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-585"><a href="#cb28-585" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a flag for optimal_pre_length</span></span>
<span id="cb28-586"><a href="#cb28-586" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_optimal =</span> <span class="fu">ifelse</span>(pre_length_candidate <span class="sc">==</span> optimal_pre_length, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb28-587"><a href="#cb28-587" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a flag for significant pvalue</span></span>
<span id="cb28-588"><a href="#cb28-588" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_significant =</span> <span class="fu">ifelse</span>(pvalue_trend <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb28-589"><a href="#cb28-589" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust transparency</span></span>
<span id="cb28-590"><a href="#cb28-590" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fu">ifelse</span>(is_optimal, <span class="dv">1</span>, <span class="fl">0.2</span>),</span>
<span id="cb28-591"><a href="#cb28-591" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">ifelse</span>(is_significant, <span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb28-592"><a href="#cb28-592" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fu">ifelse</span>(is_optimal, <span class="fl">2.5</span>, <span class="fl">1.2</span>)</span>
<span id="cb28-593"><a href="#cb28-593" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-594"><a href="#cb28-594" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">shape =</span> <span class="fu">factor</span>(shape, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>)),</span>
<span id="cb28-595"><a href="#cb28-595" aria-hidden="true" tabindex="-1"></a>         <span class="at">size =</span> <span class="fu">factor</span>(size, <span class="at">levels =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.5</span>)))</span>
<span id="cb28-596"><a href="#cb28-596" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-597"><a href="#cb28-597" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-598"><a href="#cb28-598" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb28-599"><a href="#cb28-599" aria-hidden="true" tabindex="-1"></a>sos_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"SOS"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb28-600"><a href="#cb28-600" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb28-601"><a href="#cb28-601" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">shape =</span> shape, <span class="at">size =</span> size)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb28-602"><a href="#cb28-602" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-603"><a href="#cb28-603" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb28-604"><a href="#cb28-604" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb28-605"><a href="#cb28-605" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb28-606"><a href="#cb28-606" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb28-607"><a href="#cb28-607" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt; 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb28-608"><a href="#cb28-608" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb28-609"><a href="#cb28-609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb28-610"><a href="#cb28-610" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb28-611"><a href="#cb28-611" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.5</span>), </span>
<span id="cb28-612"><a href="#cb28-612" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb28-613"><a href="#cb28-613" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-614"><a href="#cb28-614" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb28-615"><a href="#cb28-615" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb28-616"><a href="#cb28-616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-617"><a href="#cb28-617" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Start of season"</span>,</span>
<span id="cb28-618"><a href="#cb28-618" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb28-619"><a href="#cb28-619" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb28-620"><a href="#cb28-620" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-621"><a href="#cb28-621" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-622"><a href="#cb28-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb28-623"><a href="#cb28-623" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb28-624"><a href="#cb28-624" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb28-625"><a href="#cb28-625" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb28-626"><a href="#cb28-626" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-627"><a href="#cb28-627" aria-hidden="true" tabindex="-1"></a>greenup_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"green-up pace"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb28-628"><a href="#cb28-628" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb28-629"><a href="#cb28-629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb28-630"><a href="#cb28-630" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-631"><a href="#cb28-631" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb28-632"><a href="#cb28-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb28-633"><a href="#cb28-633" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb28-634"><a href="#cb28-634" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb28-635"><a href="#cb28-635" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt; 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb28-636"><a href="#cb28-636" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb28-637"><a href="#cb28-637" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb28-638"><a href="#cb28-638" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb28-639"><a href="#cb28-639" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.5</span>), </span>
<span id="cb28-640"><a href="#cb28-640" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb28-641"><a href="#cb28-641" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-642"><a href="#cb28-642" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb28-643"><a href="#cb28-643" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb28-644"><a href="#cb28-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-645"><a href="#cb28-645" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Green-up pace"</span>,</span>
<span id="cb28-646"><a href="#cb28-646" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb28-647"><a href="#cb28-647" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb28-648"><a href="#cb28-648" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-649"><a href="#cb28-649" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-650"><a href="#cb28-650" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb28-651"><a href="#cb28-651" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb28-652"><a href="#cb28-652" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb28-653"><a href="#cb28-653" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb28-654"><a href="#cb28-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-655"><a href="#cb28-655" aria-hidden="true" tabindex="-1"></a>eos_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"EOS"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb28-656"><a href="#cb28-656" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb28-657"><a href="#cb28-657" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb28-658"><a href="#cb28-658" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-659"><a href="#cb28-659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb28-660"><a href="#cb28-660" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb28-661"><a href="#cb28-661" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb28-662"><a href="#cb28-662" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb28-663"><a href="#cb28-663" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt; 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb28-664"><a href="#cb28-664" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb28-665"><a href="#cb28-665" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb28-666"><a href="#cb28-666" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb28-667"><a href="#cb28-667" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.5</span>), </span>
<span id="cb28-668"><a href="#cb28-668" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb28-669"><a href="#cb28-669" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-670"><a href="#cb28-670" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb28-671"><a href="#cb28-671" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb28-672"><a href="#cb28-672" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-673"><a href="#cb28-673" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"End of season"</span>,</span>
<span id="cb28-674"><a href="#cb28-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb28-675"><a href="#cb28-675" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb28-676"><a href="#cb28-676" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-677"><a href="#cb28-677" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-678"><a href="#cb28-678" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb28-679"><a href="#cb28-679" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb28-680"><a href="#cb28-680" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb28-681"><a href="#cb28-681" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb28-682"><a href="#cb28-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-683"><a href="#cb28-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-684"><a href="#cb28-684" aria-hidden="true" tabindex="-1"></a>greendown_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"green-down pace"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb28-685"><a href="#cb28-685" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb28-686"><a href="#cb28-686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb28-687"><a href="#cb28-687" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-688"><a href="#cb28-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb28-689"><a href="#cb28-689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb28-690"><a href="#cb28-690" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb28-691"><a href="#cb28-691" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb28-692"><a href="#cb28-692" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt; 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb28-693"><a href="#cb28-693" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb28-694"><a href="#cb28-694" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb28-695"><a href="#cb28-695" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb28-696"><a href="#cb28-696" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">2.5</span>), </span>
<span id="cb28-697"><a href="#cb28-697" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb28-698"><a href="#cb28-698" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-699"><a href="#cb28-699" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb28-700"><a href="#cb28-700" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb28-701"><a href="#cb28-701" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-702"><a href="#cb28-702" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Green-down pace"</span>,</span>
<span id="cb28-703"><a href="#cb28-703" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb28-704"><a href="#cb28-704" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb28-705"><a href="#cb28-705" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-706"><a href="#cb28-706" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-707"><a href="#cb28-707" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb28-708"><a href="#cb28-708" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb28-709"><a href="#cb28-709" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb28-710"><a href="#cb28-710" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb28-711"><a href="#cb28-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-712"><a href="#cb28-712" aria-hidden="true" tabindex="-1"></a>sos_p <span class="sc">+</span> greenup_p <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb28-713"><a href="#cb28-713" aria-hidden="true" tabindex="-1"></a>eos_p <span class="sc">+</span> greendown_p <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb28-714"><a href="#cb28-714" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-715"><a href="#cb28-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-716"><a href="#cb28-716" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3 Spatial pattern</span></span>
<span id="cb28-717"><a href="#cb28-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-718"><a href="#cb28-718" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.1 Check spatial autocorrelation</span></span>
<span id="cb28-719"><a href="#cb28-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-720"><a href="#cb28-720" aria-hidden="true" tabindex="-1"></a>First, I fitted a linear mixed-effects model for each genus with environmental variables (<span class="in">`AvgTemp_mean`</span>, <span class="in">`Sum_mm_sum`</span>, and <span class="in">`srad_mean`</span>) as predictors, with random effects for <span class="in">`year`</span> and <span class="in">`id`</span>, which represent temporal (<span class="in">`(1 | year)`</span>) and spatial (<span class="in">`(1 | id)`</span>) randomness, respectively.</span>
<span id="cb28-721"><a href="#cb28-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-722"><a href="#cb28-722" aria-hidden="true" tabindex="-1"></a>Then I conducted a variance decomposition analysis and compared the proportion of total variance explained by spatial effects and temporal effects respectively. Generally, spatial and temporal variations are both present, but their contributions vary across different genera. Some genera show higher spatial effects, while others have more balanced contributions from spatial and year components.</span>
<span id="cb28-723"><a href="#cb28-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-726"><a href="#cb28-726" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-727"><a href="#cb28-727" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-check_variance</span></span>
<span id="cb28-728"><a href="#cb28-728" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-729"><a href="#cb28-729" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-730"><a href="#cb28-730" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Variance decomposition analysis for spatial and temporal effects"</span></span>
<span id="cb28-731"><a href="#cb28-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-732"><a href="#cb28-732" aria-hidden="true" tabindex="-1"></a>tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/NY/tavg_allyear_var.rds"</span>)</span>
<span id="cb28-733"><a href="#cb28-733" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb28-734"><a href="#cb28-734" aria-hidden="true" tabindex="-1"></a>all_genus <span class="ot">&lt;-</span> <span class="fu">unique</span>(tavg_allyear_var<span class="sc">$</span>genus)</span>
<span id="cb28-735"><a href="#cb28-735" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-736"><a href="#cb28-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-737"><a href="#cb28-737" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb28-738"><a href="#cb28-738" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"SOS"</span>) {</span>
<span id="cb28-739"><a href="#cb28-739" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb28-740"><a href="#cb28-740" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb28-741"><a href="#cb28-741" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb28-742"><a href="#cb28-742" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"EOS"</span>) {</span>
<span id="cb28-743"><a href="#cb28-743" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb28-744"><a href="#cb28-744" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb28-745"><a href="#cb28-745" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb28-746"><a href="#cb28-746" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"GreenUp"</span>) {</span>
<span id="cb28-747"><a href="#cb28-747" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb28-748"><a href="#cb28-748" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb28-749"><a href="#cb28-749" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb28-750"><a href="#cb28-750" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb28-751"><a href="#cb28-751" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb28-752"><a href="#cb28-752" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb28-753"><a href="#cb28-753" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb28-754"><a href="#cb28-754" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb28-755"><a href="#cb28-755" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb28-756"><a href="#cb28-756" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-757"><a href="#cb28-757" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-758"><a href="#cb28-758" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (genus <span class="cf">in</span> all_genus) {</span>
<span id="cb28-759"><a href="#cb28-759" aria-hidden="true" tabindex="-1"></a>      tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb28-760"><a href="#cb28-760" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> thres <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb28-761"><a href="#cb28-761" aria-hidden="true" tabindex="-1"></a>        <span class="fu">na.omit</span>()</span>
<span id="cb28-762"><a href="#cb28-762" aria-hidden="true" tabindex="-1"></a>      model <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(phe_metric, <span class="st">" ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year) + (1 | id)"</span>))</span>
<span id="cb28-763"><a href="#cb28-763" aria-hidden="true" tabindex="-1"></a>      full_model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(model, <span class="at">data =</span> tavg_SOS)</span>
<span id="cb28-764"><a href="#cb28-764" aria-hidden="true" tabindex="-1"></a>      var_components <span class="ot">&lt;-</span> <span class="fu">VarCorr</span>(full_model)</span>
<span id="cb28-765"><a href="#cb28-765" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb28-766"><a href="#cb28-766" aria-hidden="true" tabindex="-1"></a>      total_variance <span class="ot">&lt;-</span>  var_components<span class="sc">$</span>id[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">+</span>  var_components<span class="sc">$</span>year[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">attr</span>(var_components, <span class="st">"sc"</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb28-767"><a href="#cb28-767" aria-hidden="true" tabindex="-1"></a>      spatial_contribution <span class="ot">&lt;-</span> var_components<span class="sc">$</span>id[<span class="dv">1</span>, <span class="dv">1</span>]  <span class="sc">/</span> total_variance</span>
<span id="cb28-768"><a href="#cb28-768" aria-hidden="true" tabindex="-1"></a>      year_contribution <span class="ot">&lt;-</span>  var_components<span class="sc">$</span>year[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">/</span> total_variance</span>
<span id="cb28-769"><a href="#cb28-769" aria-hidden="true" tabindex="-1"></a>      residual_contribution <span class="ot">&lt;-</span> <span class="fu">attr</span>(var_components, <span class="st">"sc"</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> total_variance</span>
<span id="cb28-770"><a href="#cb28-770" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb28-771"><a href="#cb28-771" aria-hidden="true" tabindex="-1"></a>      variance_components <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-772"><a href="#cb28-772" aria-hidden="true" tabindex="-1"></a>            <span class="at">Metric =</span> phe_type,</span>
<span id="cb28-773"><a href="#cb28-773" aria-hidden="true" tabindex="-1"></a>            <span class="at">Genus =</span> genus,</span>
<span id="cb28-774"><a href="#cb28-774" aria-hidden="true" tabindex="-1"></a>            <span class="at">Component =</span> <span class="fu">c</span>(<span class="st">"Spatial"</span>, <span class="st">"Year"</span>, <span class="st">"Residual"</span>),</span>
<span id="cb28-775"><a href="#cb28-775" aria-hidden="true" tabindex="-1"></a>            <span class="at">Variance =</span> <span class="fu">c</span>(spatial_contribution, year_contribution, residual_contribution)</span>
<span id="cb28-776"><a href="#cb28-776" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb28-777"><a href="#cb28-777" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb28-778"><a href="#cb28-778" aria-hidden="true" tabindex="-1"></a>          results[[<span class="fu">paste</span>(phe_type, genus, <span class="at">sep =</span> <span class="st">"_"</span>)]] <span class="ot">&lt;-</span> variance_components</span>
<span id="cb28-779"><a href="#cb28-779" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-780"><a href="#cb28-780" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-781"><a href="#cb28-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-782"><a href="#cb28-782" aria-hidden="true" tabindex="-1"></a>final_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, results)</span>
<span id="cb28-783"><a href="#cb28-783" aria-hidden="true" tabindex="-1"></a>final_results <span class="ot">&lt;-</span> final_results <span class="sc">%&gt;%</span></span>
<span id="cb28-784"><a href="#cb28-784" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Metric, Genus) <span class="sc">%&gt;%</span></span>
<span id="cb28-785"><a href="#cb28-785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Variance_Proportion =</span> Variance <span class="sc">/</span> <span class="fu">sum</span>(Variance),</span>
<span id="cb28-786"><a href="#cb28-786" aria-hidden="true" tabindex="-1"></a>         <span class="at">Component =</span> <span class="fu">factor</span>(Component, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Spatial"</span>, <span class="st">"Residual"</span>, <span class="st">"Year"</span>)),</span>
<span id="cb28-787"><a href="#cb28-787" aria-hidden="true" tabindex="-1"></a>         <span class="at">Metric =</span> <span class="fu">factor</span>(Metric, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)))</span>
<span id="cb28-788"><a href="#cb28-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-789"><a href="#cb28-789" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(final_results, <span class="fu">aes</span>(<span class="at">x =</span> Genus, <span class="at">y =</span> Variance_Proportion, <span class="at">fill =</span> Component)) <span class="sc">+</span></span>
<span id="cb28-790"><a href="#cb28-790" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"stack"</span>) <span class="sc">+</span></span>
<span id="cb28-791"><a href="#cb28-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Metric, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb28-792"><a href="#cb28-792" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Genus"</span>, <span class="at">y =</span> <span class="st">"Variance Proportion"</span>, <span class="at">fill =</span> <span class="st">"Component"</span>) <span class="sc">+</span></span>
<span id="cb28-793"><a href="#cb28-793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-794"><a href="#cb28-794" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb28-795"><a href="#cb28-795" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) </span>
<span id="cb28-796"><a href="#cb28-796" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-797"><a href="#cb28-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-798"><a href="#cb28-798" aria-hidden="true" tabindex="-1"></a>Using <span class="in">`SOS`</span> as an example, I used <span class="in">`check_heteroscedasticity()`</span> to check for heteroscedasticity in the residuals. The results showed almost every model had heterogenerous residuals.</span>
<span id="cb28-799"><a href="#cb28-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-800"><a href="#cb28-800" aria-hidden="true" tabindex="-1"></a>For fixed-effect model (<span class="in">`SOS`</span> \~ <span class="in">`AvgTemp_mean`</span> + <span class="in">`Sum_mm_sum`</span> + <span class="in">`srad_mean`</span>), <span class="in">`Global Moran I`</span> for regression residuals test indicates the presence of spatial autocorrelation in the residuals. <span class="in">`Lagrange Multiplier`</span> test suggests the spatial model should be applied.</span>
<span id="cb28-801"><a href="#cb28-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-802"><a href="#cb28-802" aria-hidden="true" tabindex="-1"></a>I computed the empirical semivariogram for the residuals to analyze spatial structure. The optimal theoretical semivariogram models (among Exp, Sph, Gau, Mat) were chosen to empirical semivariogram using <span class="in">`fit.variogram()`</span>.</span>
<span id="cb28-803"><a href="#cb28-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-806"><a href="#cb28-806" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-807"><a href="#cb28-807" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check_sp_auto</span></span>
<span id="cb28-808"><a href="#cb28-808" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-809"><a href="#cb28-809" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-810"><a href="#cb28-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-811"><a href="#cb28-811" aria-hidden="true" tabindex="-1"></a>tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/NY/tavg_allyear_var.rds"</span>)</span>
<span id="cb28-812"><a href="#cb28-812" aria-hidden="true" tabindex="-1"></a>genera <span class="ot">&lt;-</span> <span class="fu">unique</span>(tavg_allyear_var<span class="sc">$</span>genus)</span>
<span id="cb28-813"><a href="#cb28-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-814"><a href="#cb28-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-815"><a href="#cb28-815" aria-hidden="true" tabindex="-1"></a>variogram_sos <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-816"><a href="#cb28-816" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb28-817"><a href="#cb28-817" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb28-818"><a href="#cb28-818" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb28-819"><a href="#cb28-819" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"up"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb28-820"><a href="#cb28-820" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb28-821"><a href="#cb28-821" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb28-822"><a href="#cb28-822" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb28-823"><a href="#cb28-823" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb28-824"><a href="#cb28-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-825"><a href="#cb28-825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb28-826"><a href="#cb28-826" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-827"><a href="#cb28-827" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb28-828"><a href="#cb28-828" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb28-829"><a href="#cb28-829" aria-hidden="true" tabindex="-1"></a>  variogram_sos[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-830"><a href="#cb28-830" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb28-831"><a href="#cb28-831" aria-hidden="true" tabindex="-1"></a>    <span class="at">SOS =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb28-832"><a href="#cb28-832" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-833"><a href="#cb28-833" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-834"><a href="#cb28-834" aria-hidden="true" tabindex="-1"></a>variogram_sos <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_sos)</span>
<span id="cb28-835"><a href="#cb28-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-836"><a href="#cb28-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-837"><a href="#cb28-837" aria-hidden="true" tabindex="-1"></a>variogram_eos <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-838"><a href="#cb28-838" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb28-839"><a href="#cb28-839" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb28-840"><a href="#cb28-840" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb28-841"><a href="#cb28-841" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"down"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb28-842"><a href="#cb28-842" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb28-843"><a href="#cb28-843" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb28-844"><a href="#cb28-844" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb28-845"><a href="#cb28-845" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb28-846"><a href="#cb28-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-847"><a href="#cb28-847" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb28-848"><a href="#cb28-848" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-849"><a href="#cb28-849" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb28-850"><a href="#cb28-850" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb28-851"><a href="#cb28-851" aria-hidden="true" tabindex="-1"></a>  variogram_eos[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-852"><a href="#cb28-852" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb28-853"><a href="#cb28-853" aria-hidden="true" tabindex="-1"></a>    <span class="at">EOS =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb28-854"><a href="#cb28-854" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-855"><a href="#cb28-855" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-856"><a href="#cb28-856" aria-hidden="true" tabindex="-1"></a>variogram_eos <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_eos)</span>
<span id="cb28-857"><a href="#cb28-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-858"><a href="#cb28-858" aria-hidden="true" tabindex="-1"></a>variogram_up <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-859"><a href="#cb28-859" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb28-860"><a href="#cb28-860" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb28-861"><a href="#cb28-861" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb28-862"><a href="#cb28-862" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"up"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.2</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb28-863"><a href="#cb28-863" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">doy_diff =</span> <span class="fu">as.numeric</span>(doy_diff))<span class="sc">%&gt;%</span></span>
<span id="cb28-864"><a href="#cb28-864" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb28-865"><a href="#cb28-865" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy_diff <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb28-866"><a href="#cb28-866" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb28-867"><a href="#cb28-867" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb28-868"><a href="#cb28-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-869"><a href="#cb28-869" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb28-870"><a href="#cb28-870" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-871"><a href="#cb28-871" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb28-872"><a href="#cb28-872" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb28-873"><a href="#cb28-873" aria-hidden="true" tabindex="-1"></a>  variogram_up[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-874"><a href="#cb28-874" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb28-875"><a href="#cb28-875" aria-hidden="true" tabindex="-1"></a>    <span class="at">GreenUp =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb28-876"><a href="#cb28-876" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-877"><a href="#cb28-877" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-878"><a href="#cb28-878" aria-hidden="true" tabindex="-1"></a>variogram_up <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_up)</span>
<span id="cb28-879"><a href="#cb28-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-880"><a href="#cb28-880" aria-hidden="true" tabindex="-1"></a>variogram_down <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-881"><a href="#cb28-881" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb28-882"><a href="#cb28-882" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb28-883"><a href="#cb28-883" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb28-884"><a href="#cb28-884" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"down"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.2</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb28-885"><a href="#cb28-885" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">doy_diff =</span> <span class="fu">as.numeric</span>(doy_diff))<span class="sc">%&gt;%</span></span>
<span id="cb28-886"><a href="#cb28-886" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb28-887"><a href="#cb28-887" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy_diff <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb28-888"><a href="#cb28-888" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb28-889"><a href="#cb28-889" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb28-890"><a href="#cb28-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-891"><a href="#cb28-891" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb28-892"><a href="#cb28-892" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-893"><a href="#cb28-893" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb28-894"><a href="#cb28-894" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb28-895"><a href="#cb28-895" aria-hidden="true" tabindex="-1"></a>  variogram_down[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-896"><a href="#cb28-896" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb28-897"><a href="#cb28-897" aria-hidden="true" tabindex="-1"></a>    <span class="at">GreenDown =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb28-898"><a href="#cb28-898" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-899"><a href="#cb28-899" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-900"><a href="#cb28-900" aria-hidden="true" tabindex="-1"></a>variogram_down <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_down)</span>
<span id="cb28-901"><a href="#cb28-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-902"><a href="#cb28-902" aria-hidden="true" tabindex="-1"></a>variogram_summary <span class="ot">&lt;-</span> variogram_sos <span class="sc">%&gt;%</span></span>
<span id="cb28-903"><a href="#cb28-903" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_eos, <span class="at">by =</span> <span class="st">"genus"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-904"><a href="#cb28-904" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_up, <span class="at">by =</span> <span class="st">"genus"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-905"><a href="#cb28-905" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_down, <span class="at">by =</span> <span class="st">"genus"</span>)</span>
<span id="cb28-906"><a href="#cb28-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-907"><a href="#cb28-907" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(variogram_summary, <span class="at">caption =</span> <span class="st">"Fitted semivariogram model for each genus"</span>)</span>
<span id="cb28-908"><a href="#cb28-908" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-909"><a href="#cb28-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-910"><a href="#cb28-910" aria-hidden="true" tabindex="-1"></a>Sph: 26, Mat: 22, Gau: 4, Exp: 4</span>
<span id="cb28-911"><a href="#cb28-911" aria-hidden="true" tabindex="-1"></a>HT: Sph, Mat</span>
<span id="cb28-912"><a href="#cb28-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-913"><a href="#cb28-913" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.2 Spatial statistical model</span></span>
<span id="cb28-914"><a href="#cb28-914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-915"><a href="#cb28-915" aria-hidden="true" tabindex="-1"></a>I modeled the relationship between the phenology and environmental covariates using a spatial hierarchical model. The response variable (phenology parameter) at location $\mathbf{s}_i$ and in year $\mathbf{t}$, denoted as $y(\mathbf{s}_i, \mathbf{t})$, was modeled as following candidate model:</span>
<span id="cb28-916"><a href="#cb28-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-917"><a href="#cb28-917" aria-hidden="true" tabindex="-1"></a>**Model 1: (current use)**</span>
<span id="cb28-918"><a href="#cb28-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-919"><a href="#cb28-919" aria-hidden="true" tabindex="-1"></a>$$y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w(\mathbf{s}_i) + u(\mathbf{t}) + \epsilon(\mathbf{s}_i, \mathbf{t})$$</span>
<span id="cb28-920"><a href="#cb28-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-921"><a href="#cb28-921" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb28-922"><a href="#cb28-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-923"><a href="#cb28-923" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Fixed Effects*: $$\mu(\mathbf{s}_i,\mathbf{t}) = \mathbf{X}_{\mathbf{s}_i,\mathbf{t}} \boldsymbol{\beta}$$</span>
<span id="cb28-924"><a href="#cb28-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-925"><a href="#cb28-925" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\mathbf{X}_{\mathbf{s}_i,\mathbf{t}} = [1, \text{AvgTemp}_{\mathbf{s}_i,\mathbf{t}}, \text{Precp}_{\mathbf{s}_i,\mathbf{t}}, \text{srad}_{\mathbf{s}_i,\mathbf{t}}]$ is the design matrix of predictors.</span>
<span id="cb28-926"><a href="#cb28-926" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\boldsymbol{\beta} = <span class="co">[</span><span class="ot">\beta_0, \beta_1, \beta_2, \beta_3</span><span class="co">]</span>$ are the regression coefficients for the intercept and covariates.</span>
<span id="cb28-927"><a href="#cb28-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-928"><a href="#cb28-928" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Spatially Correlated Random Effect*: $$w(\mathbf{s}_i) \sim \text{MVN}(\mathbf{0}, \mathbf{R})$$</span>
<span id="cb28-929"><a href="#cb28-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-930"><a href="#cb28-930" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\mathbf{R}$ is the spatial correlation matrix defined by a covariance function:</span>
<span id="cb28-931"><a href="#cb28-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-932"><a href="#cb28-932" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>MatÃ©rn Covariance Function (if selected): $$\mathbf{R}_{ij} = \sigma^2 \cdot \frac{2^{1-\nu}}{\Gamma(\nu)} \left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)^\nu K_\nu\left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)$$</span>
<span id="cb28-933"><a href="#cb28-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-934"><a href="#cb28-934" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Exponential Covariance Function (if selected): $$\mathbf{R}_{ij} = \sigma^2 \cdot \exp(-\phi D_{ij})$$</span>
<span id="cb28-935"><a href="#cb28-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-936"><a href="#cb28-936" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Gaussian Covariance Function (if selected): $$\mathbf{R}_{ij} = \sigma^2 \cdot \exp(-\phi D_{ij}^2)$$</span>
<span id="cb28-937"><a href="#cb28-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-938"><a href="#cb28-938" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Spherical Covariance Function (if selected):</span>
<span id="cb28-939"><a href="#cb28-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-940"><a href="#cb28-940" aria-hidden="true" tabindex="-1"></a>    $$\mathbf{R}_{ij} =</span>
<span id="cb28-941"><a href="#cb28-941" aria-hidden="true" tabindex="-1"></a>            \begin{cases}</span>
<span id="cb28-942"><a href="#cb28-942" aria-hidden="true" tabindex="-1"></a>            \sigma^2 \cdot \left(1 - \frac{3 D_{ij}}{2\rho} + \frac{D_{ij}^3}{2\rho ^3}\right), &amp; D_{ij} \leq \rho <span class="sc">\\</span></span>
<span id="cb28-943"><a href="#cb28-943" aria-hidden="true" tabindex="-1"></a>            0, &amp; D_{ij} &gt; \rho</span>
<span id="cb28-944"><a href="#cb28-944" aria-hidden="true" tabindex="-1"></a>            \end{cases}$$</span>
<span id="cb28-945"><a href="#cb28-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-946"><a href="#cb28-946" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Year-specific Random Effect*: $$u(\mathbf{t}) \sim \text{N}(0, \tau^2_{\mathbf{t}})$$</span>
<span id="cb28-947"><a href="#cb28-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-948"><a href="#cb28-948" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$u_{\mathbf{t}}$ captures year-to-year variability, with $\tau^2_{\mathbf{t}}$ being the variance of the year effect.</span>
<span id="cb28-949"><a href="#cb28-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-950"><a href="#cb28-950" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Independent Nugget Effect*: $$\epsilon(\mathbf{s}_i) \sim \text{N}(0, \tau^2)$$</span>
<span id="cb28-951"><a href="#cb28-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-952"><a href="#cb28-952" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\epsilon(\mathbf{s}_i, \mathbf{t})$ accounts for measurement error or small-scale variability.</span>
<span id="cb28-953"><a href="#cb28-953" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-954"><a href="#cb28-954" aria-hidden="true" tabindex="-1"></a>**Model 2: (checked)**</span>
<span id="cb28-955"><a href="#cb28-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-956"><a href="#cb28-956" aria-hidden="true" tabindex="-1"></a>$$y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w(\mathbf{s}_i, \mathbf{t}) + \epsilon(\mathbf{s}_i, \mathbf{t})$$</span>
<span id="cb28-957"><a href="#cb28-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-958"><a href="#cb28-958" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb28-959"><a href="#cb28-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-960"><a href="#cb28-960" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Fixed Effects*: same as above.</span>
<span id="cb28-961"><a href="#cb28-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-962"><a href="#cb28-962" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Spatio-temporal Random Effect*: $$w(\mathbf{s}_i, \mathbf{t}) \sim \text{MVN}(\mathbf{0}, \mathbf{R}_{\mathbf{s}\mathbf{t}})$$</span>
<span id="cb28-963"><a href="#cb28-963" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-964"><a href="#cb28-964" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\mathbf{R}$ is the spatio-temporal correlation matrix defined by covariance function. The function format is the same.</span>
<span id="cb28-965"><a href="#cb28-965" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-966"><a href="#cb28-966" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Instead, $D_{ij}$ is the distance using 3-dimension coordinate, (scaled_longitude, scaled_latitude, scaled_year).</span>
<span id="cb28-967"><a href="#cb28-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-968"><a href="#cb28-968" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Independent Nugget Effect*: same as above.</span>
<span id="cb28-969"><a href="#cb28-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-970"><a href="#cb28-970" aria-hidden="true" tabindex="-1"></a>**Model 3: **</span>
<span id="cb28-971"><a href="#cb28-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-972"><a href="#cb28-972" aria-hidden="true" tabindex="-1"></a>$$y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w_t(\mathbf{s}_i) + \epsilon(\mathbf{s}_i, \mathbf{t})$$</span>
<span id="cb28-973"><a href="#cb28-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-974"><a href="#cb28-974" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb28-975"><a href="#cb28-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-976"><a href="#cb28-976" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Fixed Effects*: same as above.</span>
<span id="cb28-977"><a href="#cb28-977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-978"><a href="#cb28-978" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Spatio-temporal Random Effect*: $$w_t(\mathbf{s}_i) \sim \text{MVN}(\mathbf{0}, \mathbf{R}_{\mathbf{t}})$$</span>
<span id="cb28-979"><a href="#cb28-979" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-980"><a href="#cb28-980" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\mathbf{R}_{\mathbf{t}}$ is fitted for each year. Or the parameters in covariance matrix, e.g., $\phi(\mathbf{t}_j) \sim \text{N}(0, \tau^2_{\phi})$</span>
<span id="cb28-981"><a href="#cb28-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-982"><a href="#cb28-982" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Independent Nugget Effect*: same as above.</span>
<span id="cb28-983"><a href="#cb28-983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-984"><a href="#cb28-984" aria-hidden="true" tabindex="-1"></a>**Model 4: **</span>
<span id="cb28-985"><a href="#cb28-985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-986"><a href="#cb28-986" aria-hidden="true" tabindex="-1"></a>$$y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w(\mathbf{s}_i) + u(\mathbf{t}) + \epsilon(\mathbf{s}_i, \mathbf{t})$$</span>
<span id="cb28-987"><a href="#cb28-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-988"><a href="#cb28-988" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb28-989"><a href="#cb28-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-990"><a href="#cb28-990" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Fixed Effects*: same as above.</span>
<span id="cb28-991"><a href="#cb28-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-992"><a href="#cb28-992" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Spatially Correlated Random Effect*: $$w(\mathbf{s}_i) \sim \text{MVN}(\mathbf{0}, \mathbf{R})$$</span>
<span id="cb28-993"><a href="#cb28-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-994"><a href="#cb28-994" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\mathbf{R}$ is the spatial correlation matrix defined by a covariance function:</span>
<span id="cb28-995"><a href="#cb28-995" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-996"><a href="#cb28-996" aria-hidden="true" tabindex="-1"></a>    $$\mathbf{R}_{ij} = </span>
<span id="cb28-997"><a href="#cb28-997" aria-hidden="true" tabindex="-1"></a>    \begin{cases} </span>
<span id="cb28-998"><a href="#cb28-998" aria-hidden="true" tabindex="-1"></a>    0 \text{ or a very samll value} &amp; \text{if } \mathbf{t}_{i} \neq \mathbf{t}_{j} <span class="sc">\\</span></span>
<span id="cb28-999"><a href="#cb28-999" aria-hidden="true" tabindex="-1"></a>    \text{follow covariance function}  &amp; \text{otherwise}</span>
<span id="cb28-1000"><a href="#cb28-1000" aria-hidden="true" tabindex="-1"></a>    \end{cases}$$</span>
<span id="cb28-1001"><a href="#cb28-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1002"><a href="#cb28-1002" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Year-specific Random Effect*: same as above.</span>
<span id="cb28-1003"><a href="#cb28-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1004"><a href="#cb28-1004" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Independent Nugget Effect*: same as above.</span>
<span id="cb28-1005"><a href="#cb28-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1006"><a href="#cb28-1006" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 3.2.0 Simulation for canndidate models</span></span>
<span id="cb28-1007"><a href="#cb28-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1008"><a href="#cb28-1008" aria-hidden="true" tabindex="-1"></a>For model comparison, I simulated the data with the true slope of <span class="in">`Avg_temp`</span> is **-2**. Both spatial variance (exp covariance) and temporal variance are included. Some records happen in the same location.</span>
<span id="cb28-1009"><a href="#cb28-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1012"><a href="#cb28-1012" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1013"><a href="#cb28-1013" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-model_simulate</span></span>
<span id="cb28-1014"><a href="#cb28-1014" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-1015"><a href="#cb28-1015" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1016"><a href="#cb28-1016" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb28-1017"><a href="#cb28-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1018"><a href="#cb28-1018" aria-hidden="true" tabindex="-1"></a><span class="do">################ Make up the simulation data ################</span></span>
<span id="cb28-1019"><a href="#cb28-1019" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb28-1020"><a href="#cb28-1020" aria-hidden="true" tabindex="-1"></a>lon_range <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">74.25156</span>, <span class="sc">-</span><span class="fl">73.70623</span>)</span>
<span id="cb28-1021"><a href="#cb28-1021" aria-hidden="true" tabindex="-1"></a>lat_range <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">40.50458</span>, <span class="fl">40.91093</span>)</span>
<span id="cb28-1022"><a href="#cb28-1022" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">200</span> </span>
<span id="cb28-1023"><a href="#cb28-1023" aria-hidden="true" tabindex="-1"></a>lon <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="at">min =</span> lon_range[<span class="dv">1</span>], <span class="at">max =</span> lon_range[<span class="dv">2</span>])</span>
<span id="cb28-1024"><a href="#cb28-1024" aria-hidden="true" tabindex="-1"></a>lat <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="at">min =</span> lat_range[<span class="dv">1</span>], <span class="at">max =</span> lat_range[<span class="dv">2</span>])</span>
<span id="cb28-1025"><a href="#cb28-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1026"><a href="#cb28-1026" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="dv">2017</span><span class="sc">:</span><span class="dv">2023</span></span>
<span id="cb28-1027"><a href="#cb28-1027" aria-hidden="true" tabindex="-1"></a>nyears <span class="ot">&lt;-</span> <span class="fu">length</span>(years)</span>
<span id="cb28-1028"><a href="#cb28-1028" aria-hidden="true" tabindex="-1"></a>year <span class="ot">&lt;-</span> <span class="fu">sample</span>(years, N, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1029"><a href="#cb28-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1030"><a href="#cb28-1030" aria-hidden="true" tabindex="-1"></a><span class="co"># fix effects: intercept, tavg, precp, srad</span></span>
<span id="cb28-1031"><a href="#cb28-1031" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">&lt;-</span> <span class="dv">120</span></span>
<span id="cb28-1032"><a href="#cb28-1032" aria-hidden="true" tabindex="-1"></a>tavg <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">0</span>, <span class="dv">25</span>)</span>
<span id="cb28-1033"><a href="#cb28-1033" aria-hidden="true" tabindex="-1"></a>precp <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">0</span>, <span class="dv">500</span>)</span>
<span id="cb28-1034"><a href="#cb28-1034" aria-hidden="true" tabindex="-1"></a>srad <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">300</span>, <span class="dv">450</span>)</span>
<span id="cb28-1035"><a href="#cb28-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1036"><a href="#cb28-1036" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(intercept, <span class="sc">-</span><span class="dv">2</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>)</span>
<span id="cb28-1037"><a href="#cb28-1037" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, tavg, precp, srad)</span>
<span id="cb28-1038"><a href="#cb28-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1039"><a href="#cb28-1039" aria-hidden="true" tabindex="-1"></a><span class="co"># spatial effect</span></span>
<span id="cb28-1040"><a href="#cb28-1040" aria-hidden="true" tabindex="-1"></a>sigma.sq <span class="ot">&lt;-</span> <span class="dv">80</span></span>
<span id="cb28-1041"><a href="#cb28-1041" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb28-1042"><a href="#cb28-1042" aria-hidden="true" tabindex="-1"></a>spatial_effect <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb28-1043"><a href="#cb28-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1044"><a href="#cb28-1044" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (y <span class="cf">in</span> years) {</span>
<span id="cb28-1045"><a href="#cb28-1045" aria-hidden="true" tabindex="-1"></a>  year_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(year <span class="sc">==</span> y)</span>
<span id="cb28-1046"><a href="#cb28-1046" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(year_idx) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb28-1047"><a href="#cb28-1047" aria-hidden="true" tabindex="-1"></a>    lon_year <span class="ot">&lt;-</span> lon[year_idx]</span>
<span id="cb28-1048"><a href="#cb28-1048" aria-hidden="true" tabindex="-1"></a>    lat_year <span class="ot">&lt;-</span> lat[year_idx]</span>
<span id="cb28-1049"><a href="#cb28-1049" aria-hidden="true" tabindex="-1"></a>    dist_matrix_year <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">cbind</span>(lon_year, lat_year)))</span>
<span id="cb28-1050"><a href="#cb28-1050" aria-hidden="true" tabindex="-1"></a>    cov_matrix_year <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix_year)</span>
<span id="cb28-1051"><a href="#cb28-1051" aria-hidden="true" tabindex="-1"></a>    spatial_effect[year_idx] <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(year_idx)), <span class="at">Sigma =</span> cov_matrix_year)</span>
<span id="cb28-1052"><a href="#cb28-1052" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb28-1053"><a href="#cb28-1053" aria-hidden="true" tabindex="-1"></a>    spatial_effect[year_idx] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb28-1054"><a href="#cb28-1054" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1055"><a href="#cb28-1055" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1056"><a href="#cb28-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1057"><a href="#cb28-1057" aria-hidden="true" tabindex="-1"></a><span class="co"># year effect</span></span>
<span id="cb28-1058"><a href="#cb28-1058" aria-hidden="true" tabindex="-1"></a>year_effect <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nyears, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb28-1059"><a href="#cb28-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1060"><a href="#cb28-1060" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb28-1061"><a href="#cb28-1061" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb28-1062"><a href="#cb28-1062" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb28-1063"><a href="#cb28-1063" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb28-1064"><a href="#cb28-1064" aria-hidden="true" tabindex="-1"></a>  year_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(years <span class="sc">==</span> year[i])</span>
<span id="cb28-1065"><a href="#cb28-1065" aria-hidden="true" tabindex="-1"></a>  mu[i] <span class="ot">&lt;-</span> X[i,] <span class="sc">%*%</span> beta <span class="sc">+</span> spatial_effect[i] <span class="sc">+</span> year_effect[year_idx]</span>
<span id="cb28-1066"><a href="#cb28-1066" aria-hidden="true" tabindex="-1"></a>  y[i] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> mu[i], <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau))</span>
<span id="cb28-1067"><a href="#cb28-1067" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1068"><a href="#cb28-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1069"><a href="#cb28-1069" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-1070"><a href="#cb28-1070" aria-hidden="true" tabindex="-1"></a>  <span class="at">lon =</span> lon,</span>
<span id="cb28-1071"><a href="#cb28-1071" aria-hidden="true" tabindex="-1"></a>  <span class="at">lat =</span> lat,</span>
<span id="cb28-1072"><a href="#cb28-1072" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> year,</span>
<span id="cb28-1073"><a href="#cb28-1073" aria-hidden="true" tabindex="-1"></a>  <span class="at">AvgTemp_mean =</span> tavg,</span>
<span id="cb28-1074"><a href="#cb28-1074" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sum_mm_sum =</span> precp,</span>
<span id="cb28-1075"><a href="#cb28-1075" aria-hidden="true" tabindex="-1"></a>  <span class="at">srad_mean =</span> srad,</span>
<span id="cb28-1076"><a href="#cb28-1076" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatial_effect =</span> spatial_effect,</span>
<span id="cb28-1077"><a href="#cb28-1077" aria-hidden="true" tabindex="-1"></a>  <span class="at">doy =</span> y</span>
<span id="cb28-1078"><a href="#cb28-1078" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1079"><a href="#cb28-1079" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1080"><a href="#cb28-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1081"><a href="#cb28-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1082"><a href="#cb28-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1085"><a href="#cb28-1085" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1086"><a href="#cb28-1086" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-model_simulate_check</span></span>
<span id="cb28-1087"><a href="#cb28-1087" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-1088"><a href="#cb28-1088" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb28-1089"><a href="#cb28-1089" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb28-1090"><a href="#cb28-1090" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The distribution of posterior for Temp coeffeicent using simulated data."</span></span>
<span id="cb28-1091"><a href="#cb28-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1092"><a href="#cb28-1092" aria-hidden="true" tabindex="-1"></a><span class="do">################ Result form Nimble using 4 model ################</span></span>
<span id="cb28-1093"><a href="#cb28-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1094"><a href="#cb28-1094" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/"</span></span>
<span id="cb28-1095"><a href="#cb28-1095" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^SIM.*Exp</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1096"><a href="#cb28-1096" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1097"><a href="#cb28-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1098"><a href="#cb28-1098" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb28-1099"><a href="#cb28-1099" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb28-1100"><a href="#cb28-1100" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*SIM_(.*?)_tavg_SOS_Exp</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb28-1101"><a href="#cb28-1101" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1102"><a href="#cb28-1102" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb28-1103"><a href="#cb28-1103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1104"><a href="#cb28-1104" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb28-1105"><a href="#cb28-1105" aria-hidden="true" tabindex="-1"></a>  beta_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb28-1106"><a href="#cb28-1106" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb28-1107"><a href="#cb28-1107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb28-1108"><a href="#cb28-1108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb28-1109"><a href="#cb28-1109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Model:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb28-1110"><a href="#cb28-1110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb28-1111"><a href="#cb28-1111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb28-1112"><a href="#cb28-1112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_mean, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean: "</span>, <span class="fu">round</span>(beta_mean, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb28-1113"><a href="#cb28-1113" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb28-1114"><a href="#cb28-1114" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1115"><a href="#cb28-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1116"><a href="#cb28-1116" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb28-1117"><a href="#cb28-1117" aria-hidden="true" tabindex="-1"></a>combined_plot</span>
<span id="cb28-1118"><a href="#cb28-1118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1119"><a href="#cb28-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1120"><a href="#cb28-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1121"><a href="#cb28-1121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1124"><a href="#cb28-1124" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1125"><a href="#cb28-1125" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-model_sen_check</span></span>
<span id="cb28-1126"><a href="#cb28-1126" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-1127"><a href="#cb28-1127" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb28-1128"><a href="#cb28-1128" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The distribution of posterior for Temp coeffeicent using simulated data and different covariance model."</span></span>
<span id="cb28-1129"><a href="#cb28-1129" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap: </span></span>
<span id="cb28-1130"><a href="#cb28-1130" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Model 1: Spatial random effect &amp; year random effect"</span></span>
<span id="cb28-1131"><a href="#cb28-1131" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Model 2: Spatio-temporal random effect"</span></span>
<span id="cb28-1132"><a href="#cb28-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1133"><a href="#cb28-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1134"><a href="#cb28-1134" aria-hidden="true" tabindex="-1"></a><span class="do">################ Sensitivity to different covariance model ################</span></span>
<span id="cb28-1135"><a href="#cb28-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1136"><a href="#cb28-1136" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/"</span></span>
<span id="cb28-1137"><a href="#cb28-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1138"><a href="#cb28-1138" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^SIM_sp_random.*</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1139"><a href="#cb28-1139" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1140"><a href="#cb28-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1141"><a href="#cb28-1141" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb28-1142"><a href="#cb28-1142" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb28-1143"><a href="#cb28-1143" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*SIM_(.*?)_tavg_SOS_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb28-1144"><a href="#cb28-1144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1145"><a href="#cb28-1145" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1146"><a href="#cb28-1146" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb28-1147"><a href="#cb28-1147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1148"><a href="#cb28-1148" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb28-1149"><a href="#cb28-1149" aria-hidden="true" tabindex="-1"></a>  beta_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb28-1150"><a href="#cb28-1150" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb28-1151"><a href="#cb28-1151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb28-1152"><a href="#cb28-1152" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb28-1153"><a href="#cb28-1153" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Model:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb28-1154"><a href="#cb28-1154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb28-1155"><a href="#cb28-1155" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb28-1156"><a href="#cb28-1156" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_mean, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean: "</span>, <span class="fu">round</span>(beta_mean, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb28-1157"><a href="#cb28-1157" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb28-1158"><a href="#cb28-1158" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1159"><a href="#cb28-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1160"><a href="#cb28-1160" aria-hidden="true" tabindex="-1"></a>combined_plot2 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb28-1161"><a href="#cb28-1161" aria-hidden="true" tabindex="-1"></a>combined_plot2</span>
<span id="cb28-1162"><a href="#cb28-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1163"><a href="#cb28-1163" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^SIM_joint.*</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1164"><a href="#cb28-1164" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1165"><a href="#cb28-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1166"><a href="#cb28-1166" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb28-1167"><a href="#cb28-1167" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb28-1168"><a href="#cb28-1168" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*SIM_(.*?)_tavg_SOS_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb28-1169"><a href="#cb28-1169" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1170"><a href="#cb28-1170" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1171"><a href="#cb28-1171" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb28-1172"><a href="#cb28-1172" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1173"><a href="#cb28-1173" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb28-1174"><a href="#cb28-1174" aria-hidden="true" tabindex="-1"></a>  beta_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb28-1175"><a href="#cb28-1175" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb28-1176"><a href="#cb28-1176" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb28-1177"><a href="#cb28-1177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb28-1178"><a href="#cb28-1178" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Model:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb28-1179"><a href="#cb28-1179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb28-1180"><a href="#cb28-1180" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb28-1181"><a href="#cb28-1181" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_mean, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean: "</span>, <span class="fu">round</span>(beta_mean, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb28-1182"><a href="#cb28-1182" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb28-1183"><a href="#cb28-1183" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1184"><a href="#cb28-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1185"><a href="#cb28-1185" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb28-1186"><a href="#cb28-1186" aria-hidden="true" tabindex="-1"></a>combined_plot</span>
<span id="cb28-1187"><a href="#cb28-1187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1188"><a href="#cb28-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1189"><a href="#cb28-1189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1190"><a href="#cb28-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1191"><a href="#cb28-1191" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 3.2.1 Nimble model code (run in separate script)</span></span>
<span id="cb28-1192"><a href="#cb28-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1195"><a href="#cb28-1195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1196"><a href="#cb28-1196" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: model_build</span></span>
<span id="cb28-1197"><a href="#cb28-1197" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-1198"><a href="#cb28-1198" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1199"><a href="#cb28-1199" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb28-1200"><a href="#cb28-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1201"><a href="#cb28-1201" aria-hidden="true" tabindex="-1"></a>spherical_covariance <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb28-1202"><a href="#cb28-1202" aria-hidden="true" tabindex="-1"></a>  <span class="at">run =</span> <span class="cf">function</span>(<span class="at">d =</span> <span class="fu">double</span>(<span class="dv">0</span>), <span class="at">range =</span> <span class="fu">double</span>(<span class="dv">0</span>), <span class="at">sigma.sq =</span> <span class="fu">double</span>(<span class="dv">0</span>)) {</span>
<span id="cb28-1203"><a href="#cb28-1203" aria-hidden="true" tabindex="-1"></a>    <span class="fu">returnType</span>(<span class="fu">double</span>(<span class="dv">0</span>)) </span>
<span id="cb28-1204"><a href="#cb28-1204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (d <span class="sc">&lt;=</span> range) {</span>
<span id="cb28-1205"><a href="#cb28-1205" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span> (sigma.sq <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> (<span class="dv">3</span> <span class="sc">*</span> d <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> range)) <span class="sc">+</span> (d<span class="sc">^</span><span class="dv">3</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> range<span class="sc">^</span><span class="dv">3</span>))))</span>
<span id="cb28-1206"><a href="#cb28-1206" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb28-1207"><a href="#cb28-1207" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="fl">0.0</span>)</span>
<span id="cb28-1208"><a href="#cb28-1208" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-1209"><a href="#cb28-1209" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1210"><a href="#cb28-1210" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1211"><a href="#cb28-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1212"><a href="#cb28-1212" aria-hidden="true" tabindex="-1"></a>matern_covariance <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb28-1213"><a href="#cb28-1213" aria-hidden="true" tabindex="-1"></a>  <span class="at">run =</span> <span class="cf">function</span>(<span class="at">d =</span> <span class="fu">double</span>(<span class="dv">0</span>), <span class="at">range =</span> <span class="fu">double</span>(<span class="dv">0</span>), <span class="at">sigma.sq =</span> <span class="fu">double</span>(<span class="dv">0</span>), <span class="at">nu =</span> <span class="fu">double</span>(<span class="dv">0</span>)) {</span>
<span id="cb28-1214"><a href="#cb28-1214" aria-hidden="true" tabindex="-1"></a>    <span class="fu">returnType</span>(<span class="fu">double</span>(<span class="dv">0</span>))</span>
<span id="cb28-1215"><a href="#cb28-1215" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (d <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb28-1216"><a href="#cb28-1216" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(sigma.sq)</span>
<span id="cb28-1217"><a href="#cb28-1217" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb28-1218"><a href="#cb28-1218" aria-hidden="true" tabindex="-1"></a>        part <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">^</span>(<span class="dv">1</span> <span class="sc">-</span> nu)) <span class="sc">/</span> <span class="fu">gamma</span>(nu)  <span class="sc">*</span> (<span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> nu) <span class="sc">*</span> d <span class="sc">/</span> range)<span class="sc">^</span>nu</span>
<span id="cb28-1219"><a href="#cb28-1219" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(sigma.sq <span class="sc">*</span> part <span class="sc">*</span> <span class="fu">besselK</span>(d <span class="sc">/</span> range, nu))</span>
<span id="cb28-1220"><a href="#cb28-1220" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb28-1221"><a href="#cb28-1221" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1222"><a href="#cb28-1222" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1223"><a href="#cb28-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1224"><a href="#cb28-1224" aria-hidden="true" tabindex="-1"></a><span class="co"># Define Nimble model code</span></span>
<span id="cb28-1225"><a href="#cb28-1225" aria-hidden="true" tabindex="-1"></a>model_code <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb28-1226"><a href="#cb28-1226" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb28-1227"><a href="#cb28-1227" aria-hidden="true" tabindex="-1"></a>    y[i] <span class="sc">~</span> <span class="fu">dnorm</span>(mu[i], tau)</span>
<span id="cb28-1228"><a href="#cb28-1228" aria-hidden="true" tabindex="-1"></a>    mu[i] <span class="ot">&lt;-</span> <span class="fu">inprod</span>(X[i, <span class="dv">1</span><span class="sc">:</span>P], beta[]) <span class="sc">+</span> spatial_effect[i] <span class="sc">+</span> year_effect[year[i]]</span>
<span id="cb28-1229"><a href="#cb28-1229" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1230"><a href="#cb28-1230" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (q <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nyears) {</span>
<span id="cb28-1231"><a href="#cb28-1231" aria-hidden="true" tabindex="-1"></a>    year_effect[q] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(tau.year))</span>
<span id="cb28-1232"><a href="#cb28-1232" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1233"><a href="#cb28-1233" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>P) {</span>
<span id="cb28-1234"><a href="#cb28-1234" aria-hidden="true" tabindex="-1"></a>    beta[j] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1000</span>)</span>
<span id="cb28-1235"><a href="#cb28-1235" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1236"><a href="#cb28-1236" aria-hidden="true" tabindex="-1"></a>  spatial_effect[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dmnorm</span>(Mu[<span class="dv">1</span><span class="sc">:</span>N], <span class="at">cov =</span> cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N])</span>
<span id="cb28-1237"><a href="#cb28-1237" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-1238"><a href="#cb28-1238" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose the covariance function based on variogram fitting</span></span>
<span id="cb28-1239"><a href="#cb28-1239" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Mat"</span>) {</span>
<span id="cb28-1240"><a href="#cb28-1240" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb28-1241"><a href="#cb28-1241" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb28-1242"><a href="#cb28-1242" aria-hidden="true" tabindex="-1"></a>        cov_matrix[m, n] <span class="ot">&lt;-</span> <span class="fu">matern_covariance</span>(dist_matrix[m, n], range, sigma.sq, nu)</span>
<span id="cb28-1243"><a href="#cb28-1243" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb28-1244"><a href="#cb28-1244" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-1245"><a href="#cb28-1245" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Gau"</span>) {</span>
<span id="cb28-1246"><a href="#cb28-1246" aria-hidden="true" tabindex="-1"></a>    cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb28-1247"><a href="#cb28-1247" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Exp"</span>) {</span>
<span id="cb28-1248"><a href="#cb28-1248" aria-hidden="true" tabindex="-1"></a>    cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N])</span>
<span id="cb28-1249"><a href="#cb28-1249" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Sph"</span>) {</span>
<span id="cb28-1250"><a href="#cb28-1250" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (m <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb28-1251"><a href="#cb28-1251" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (n <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb28-1252"><a href="#cb28-1252" aria-hidden="true" tabindex="-1"></a>        cov_matrix[m, n] <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(dist_matrix[m, n], range, sigma.sq)</span>
<span id="cb28-1253"><a href="#cb28-1253" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb28-1254"><a href="#cb28-1254" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-1255"><a href="#cb28-1255" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-1256"><a href="#cb28-1256" aria-hidden="true" tabindex="-1"></a>  tau <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="fl">0.001</span>, <span class="fl">0.001</span>)</span>
<span id="cb28-1257"><a href="#cb28-1257" aria-hidden="true" tabindex="-1"></a>  sigma.sq <span class="sc">~</span> <span class="fu">dinvgamma</span>(<span class="fl">2.5</span>, <span class="dv">120</span>)</span>
<span id="cb28-1258"><a href="#cb28-1258" aria-hidden="true" tabindex="-1"></a>  phi <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">5</span> <span class="sc">/</span> <span class="dv">1</span>, <span class="dv">5</span> <span class="sc">/</span> <span class="fl">0.1</span>)</span>
<span id="cb28-1259"><a href="#cb28-1259" aria-hidden="true" tabindex="-1"></a>  tau.year <span class="sc">~</span> <span class="fu">dinvgamma</span>(<span class="fl">2.001</span>, <span class="fl">0.667</span>)</span>
<span id="cb28-1260"><a href="#cb28-1260" aria-hidden="true" tabindex="-1"></a>  range <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb28-1261"><a href="#cb28-1261" aria-hidden="true" tabindex="-1"></a>  nu <span class="sc">~</span> <span class="fu">dunif</span>(<span class="fl">0.5</span>, <span class="dv">5</span>)</span>
<span id="cb28-1262"><a href="#cb28-1262" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-1263"><a href="#cb28-1263" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1264"><a href="#cb28-1264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1265"><a href="#cb28-1265" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 3.2.2 SOS in NYC</span></span>
<span id="cb28-1266"><a href="#cb28-1266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1267"><a href="#cb28-1267" aria-hidden="true" tabindex="-1"></a>Most genera showed negative association between temperature and the start of season, suggesting the warmer preseason, the earilier start of season. Only Fraxinus had a positive association, with a median coefficient of 0.15. There are significant genus-level differences in how temperature influences the spring phenology.</span>
<span id="cb28-1268"><a href="#cb28-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1271"><a href="#cb28-1271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1272"><a href="#cb28-1272" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_sos_tavg</span></span>
<span id="cb28-1273"><a href="#cb28-1273" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-1274"><a href="#cb28-1274" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The density of the posterior distribution of regression coefficients for `Temp~avg~` with `SOS` as the response variable for each genus in New York city."</span></span>
<span id="cb28-1275"><a href="#cb28-1275" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb28-1276"><a href="#cb28-1276" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb28-1277"><a href="#cb28-1277" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-1278"><a href="#cb28-1278" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1279"><a href="#cb28-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1280"><a href="#cb28-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1281"><a href="#cb28-1281" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/year_random/"</span></span>
<span id="cb28-1282"><a href="#cb28-1282" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/sp_temp/"</span></span>
<span id="cb28-1283"><a href="#cb28-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1284"><a href="#cb28-1284" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*SOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1285"><a href="#cb28-1285" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1286"><a href="#cb28-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1287"><a href="#cb28-1287" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb28-1288"><a href="#cb28-1288" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb28-1289"><a href="#cb28-1289" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_SOS</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb28-1290"><a href="#cb28-1290" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1291"><a href="#cb28-1291" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb28-1292"><a href="#cb28-1292" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1293"><a href="#cb28-1293" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb28-1294"><a href="#cb28-1294" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb28-1295"><a href="#cb28-1295" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb28-1296"><a href="#cb28-1296" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb28-1297"><a href="#cb28-1297" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb28-1298"><a href="#cb28-1298" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb28-1299"><a href="#cb28-1299" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb28-1300"><a href="#cb28-1300" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb28-1301"><a href="#cb28-1301" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1302"><a href="#cb28-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1303"><a href="#cb28-1303" aria-hidden="true" tabindex="-1"></a>combined_plot2 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb28-1304"><a href="#cb28-1304" aria-hidden="true" tabindex="-1"></a>combined_plot1</span>
<span id="cb28-1305"><a href="#cb28-1305" aria-hidden="true" tabindex="-1"></a>combined_plot2</span>
<span id="cb28-1306"><a href="#cb28-1306" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1307"><a href="#cb28-1307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1308"><a href="#cb28-1308" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 3.2.3 EOS in NYC</span></span>
<span id="cb28-1309"><a href="#cb28-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1310"><a href="#cb28-1310" aria-hidden="true" tabindex="-1"></a>The response of end of season to temperature shows greater variation among genera compared to spring phenology. For Acer, Betula, Liquidambar, Populus, Quercus, Salix, Ulmus, warmer preseason leads to earlier end of season. In contrast, Catya, Celtis, Fracinus and Juglans exhibited positive associations.</span>
<span id="cb28-1311"><a href="#cb28-1311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1314"><a href="#cb28-1314" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1315"><a href="#cb28-1315" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_eos_tavg</span></span>
<span id="cb28-1316"><a href="#cb28-1316" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-1317"><a href="#cb28-1317" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The density of the posterior distribution of regression coefficients for `Temp~avg~` with `EOS` as the response variable for each genus in New York city."</span></span>
<span id="cb28-1318"><a href="#cb28-1318" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb28-1319"><a href="#cb28-1319" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb28-1320"><a href="#cb28-1320" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-1321"><a href="#cb28-1321" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1322"><a href="#cb28-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1323"><a href="#cb28-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1324"><a href="#cb28-1324" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/year_random/"</span></span>
<span id="cb28-1325"><a href="#cb28-1325" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/sp_temp/"</span></span>
<span id="cb28-1326"><a href="#cb28-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1327"><a href="#cb28-1327" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*EOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1328"><a href="#cb28-1328" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1329"><a href="#cb28-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1330"><a href="#cb28-1330" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb28-1331"><a href="#cb28-1331" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb28-1332"><a href="#cb28-1332" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_EOS</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb28-1333"><a href="#cb28-1333" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1334"><a href="#cb28-1334" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb28-1335"><a href="#cb28-1335" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1336"><a href="#cb28-1336" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb28-1337"><a href="#cb28-1337" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb28-1338"><a href="#cb28-1338" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb28-1339"><a href="#cb28-1339" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb28-1340"><a href="#cb28-1340" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb28-1341"><a href="#cb28-1341" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb28-1342"><a href="#cb28-1342" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb28-1343"><a href="#cb28-1343" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb28-1344"><a href="#cb28-1344" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1345"><a href="#cb28-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1346"><a href="#cb28-1346" aria-hidden="true" tabindex="-1"></a>combined_plot1 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb28-1347"><a href="#cb28-1347" aria-hidden="true" tabindex="-1"></a>combined_plot1</span>
<span id="cb28-1348"><a href="#cb28-1348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1349"><a href="#cb28-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1350"><a href="#cb28-1350" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 3.2.4 GreenUp pace in NYC</span></span>
<span id="cb28-1351"><a href="#cb28-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1352"><a href="#cb28-1352" aria-hidden="true" tabindex="-1"></a>The response of green-up pace to temperature shows great variation among genera. For most genera, the warmer the preseason, the faster the green-up pace (shorter green-up length). For Celtis and Ulmus, warmer preseason is associated with slower green-up pace (longer green-up length).</span>
<span id="cb28-1353"><a href="#cb28-1353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1356"><a href="#cb28-1356" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1357"><a href="#cb28-1357" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_greenup_tavg</span></span>
<span id="cb28-1358"><a href="#cb28-1358" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-1359"><a href="#cb28-1359" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The density of the posterior distribution of regression coefficients for `Temp~avg~` with `Green-up pace` as the response variable for each genus in New York city."</span></span>
<span id="cb28-1360"><a href="#cb28-1360" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb28-1361"><a href="#cb28-1361" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb28-1362"><a href="#cb28-1362" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-1363"><a href="#cb28-1363" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1364"><a href="#cb28-1364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1365"><a href="#cb28-1365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1366"><a href="#cb28-1366" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/sp_temp/"</span></span>
<span id="cb28-1367"><a href="#cb28-1367" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*Up</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1368"><a href="#cb28-1368" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1369"><a href="#cb28-1369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1370"><a href="#cb28-1370" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb28-1371"><a href="#cb28-1371" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb28-1372"><a href="#cb28-1372" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb28-1373"><a href="#cb28-1373" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1374"><a href="#cb28-1374" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb28-1375"><a href="#cb28-1375" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1376"><a href="#cb28-1376" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb28-1377"><a href="#cb28-1377" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb28-1378"><a href="#cb28-1378" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb28-1379"><a href="#cb28-1379" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb28-1380"><a href="#cb28-1380" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb28-1381"><a href="#cb28-1381" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb28-1382"><a href="#cb28-1382" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb28-1383"><a href="#cb28-1383" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb28-1384"><a href="#cb28-1384" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1385"><a href="#cb28-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1386"><a href="#cb28-1386" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb28-1387"><a href="#cb28-1387" aria-hidden="true" tabindex="-1"></a>combined_plot</span>
<span id="cb28-1388"><a href="#cb28-1388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1389"><a href="#cb28-1389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1390"><a href="#cb28-1390" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 3.2.5 GreenDown pace in NYC</span></span>
<span id="cb28-1391"><a href="#cb28-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1392"><a href="#cb28-1392" aria-hidden="true" tabindex="-1"></a>The response of green-down pace to temperature shows great variation among genera. For Acer, Betula, Carya, Celtis, Fraxinus, Morus, Platanus and Quercus, the warmer the preseason, the faster the green-down pace (shorter green-down length). For Juglans, Populus, Salix and Liquidambar, warmer preseason is associated with slower green-down pace (longer green-down length).</span>
<span id="cb28-1393"><a href="#cb28-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1396"><a href="#cb28-1396" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1397"><a href="#cb28-1397" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_greendown_tavg</span></span>
<span id="cb28-1398"><a href="#cb28-1398" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-1399"><a href="#cb28-1399" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The density of the posterior distribution of regression coefficients for `Temp~avg~` with `Green-down pace` as the response variable for each genus in New York city."</span></span>
<span id="cb28-1400"><a href="#cb28-1400" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb28-1401"><a href="#cb28-1401" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb28-1402"><a href="#cb28-1402" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-1403"><a href="#cb28-1403" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1404"><a href="#cb28-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1405"><a href="#cb28-1405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1406"><a href="#cb28-1406" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/sp_temp/"</span></span>
<span id="cb28-1407"><a href="#cb28-1407" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*Down</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1408"><a href="#cb28-1408" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1409"><a href="#cb28-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1410"><a href="#cb28-1410" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb28-1411"><a href="#cb28-1411" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb28-1412"><a href="#cb28-1412" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb28-1413"><a href="#cb28-1413" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1414"><a href="#cb28-1414" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb28-1415"><a href="#cb28-1415" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb28-1416"><a href="#cb28-1416" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb28-1417"><a href="#cb28-1417" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb28-1418"><a href="#cb28-1418" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb28-1419"><a href="#cb28-1419" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb28-1420"><a href="#cb28-1420" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb28-1421"><a href="#cb28-1421" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb28-1422"><a href="#cb28-1422" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb28-1423"><a href="#cb28-1423" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb28-1424"><a href="#cb28-1424" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1425"><a href="#cb28-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1426"><a href="#cb28-1426" aria-hidden="true" tabindex="-1"></a>combined_plot3 <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb28-1427"><a href="#cb28-1427" aria-hidden="true" tabindex="-1"></a>combined_plot3</span>
<span id="cb28-1428"><a href="#cb28-1428" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1429"><a href="#cb28-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1430"><a href="#cb28-1430" aria-hidden="true" tabindex="-1"></a><span class="fu">##### 3.2.6 Comparison</span></span>
<span id="cb28-1431"><a href="#cb28-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1432"><a href="#cb28-1432" aria-hidden="true" tabindex="-1"></a>The genus Alnus has fewer data points, leading to non-convergence of the posterior distribution. So it is ignored here.</span>
<span id="cb28-1433"><a href="#cb28-1433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1436"><a href="#cb28-1436" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-1437"><a href="#cb28-1437" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_tavg_comp</span></span>
<span id="cb28-1438"><a href="#cb28-1438" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb28-1439"><a href="#cb28-1439" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb28-1440"><a href="#cb28-1440" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: </span></span>
<span id="cb28-1441"><a href="#cb28-1441" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "The distribution of the posterior of regression coefficients for `Temp~avg~` for each genus in New York city (Thick line: 90% CI, thin line: 95% CI, point: mean value)."</span></span>
<span id="cb28-1442"><a href="#cb28-1442" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "The distribution of the posterior of regression coefficients for `Temp~avg~` for each genus in New York city (Line: 95% CI, point: mean value)."</span></span>
<span id="cb28-1443"><a href="#cb28-1443" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-1444"><a href="#cb28-1444" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1445"><a href="#cb28-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1446"><a href="#cb28-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1447"><a href="#cb28-1447" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/"</span></span>
<span id="cb28-1448"><a href="#cb28-1448" aria-hidden="true" tabindex="-1"></a>SOS_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*SOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1449"><a href="#cb28-1449" aria-hidden="true" tabindex="-1"></a>EOS_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*EOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1450"><a href="#cb28-1450" aria-hidden="true" tabindex="-1"></a>Gup_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*Up</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1451"><a href="#cb28-1451" aria-hidden="true" tabindex="-1"></a>Gdown_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*Down</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-1452"><a href="#cb28-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1453"><a href="#cb28-1453" aria-hidden="true" tabindex="-1"></a>param_sos_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1454"><a href="#cb28-1454" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(SOS_files)) {</span>
<span id="cb28-1455"><a href="#cb28-1455" aria-hidden="true" tabindex="-1"></a>  file <span class="ot">&lt;-</span> SOS_files[i]</span>
<span id="cb28-1456"><a href="#cb28-1456" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb28-1457"><a href="#cb28-1457" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb28-1458"><a href="#cb28-1458" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> genus)</span>
<span id="cb28-1459"><a href="#cb28-1459" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb28-1460"><a href="#cb28-1460" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="sc">!!</span>genus)</span>
<span id="cb28-1461"><a href="#cb28-1461" aria-hidden="true" tabindex="-1"></a>  param_sos_list[[i]] <span class="ot">&lt;-</span> param_data</span>
<span id="cb28-1462"><a href="#cb28-1462" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1463"><a href="#cb28-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1464"><a href="#cb28-1464" aria-hidden="true" tabindex="-1"></a>param_eos_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1465"><a href="#cb28-1465" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(EOS_files)) {</span>
<span id="cb28-1466"><a href="#cb28-1466" aria-hidden="true" tabindex="-1"></a>  file <span class="ot">&lt;-</span> EOS_files[i]</span>
<span id="cb28-1467"><a href="#cb28-1467" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb28-1468"><a href="#cb28-1468" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb28-1469"><a href="#cb28-1469" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> genus)</span>
<span id="cb28-1470"><a href="#cb28-1470" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb28-1471"><a href="#cb28-1471" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="sc">!!</span>genus)</span>
<span id="cb28-1472"><a href="#cb28-1472" aria-hidden="true" tabindex="-1"></a>  param_eos_list[[i]] <span class="ot">&lt;-</span> param_data</span>
<span id="cb28-1473"><a href="#cb28-1473" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1474"><a href="#cb28-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1475"><a href="#cb28-1475" aria-hidden="true" tabindex="-1"></a>param_gup_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1476"><a href="#cb28-1476" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(Gup_files)) {</span>
<span id="cb28-1477"><a href="#cb28-1477" aria-hidden="true" tabindex="-1"></a>  file <span class="ot">&lt;-</span> Gup_files[i]</span>
<span id="cb28-1478"><a href="#cb28-1478" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb28-1479"><a href="#cb28-1479" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb28-1480"><a href="#cb28-1480" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> genus)</span>
<span id="cb28-1481"><a href="#cb28-1481" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb28-1482"><a href="#cb28-1482" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="sc">!!</span>genus)</span>
<span id="cb28-1483"><a href="#cb28-1483" aria-hidden="true" tabindex="-1"></a>  param_gup_list[[i]] <span class="ot">&lt;-</span> param_data</span>
<span id="cb28-1484"><a href="#cb28-1484" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1485"><a href="#cb28-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1486"><a href="#cb28-1486" aria-hidden="true" tabindex="-1"></a>param_gdown_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb28-1487"><a href="#cb28-1487" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(Gdown_files)) {</span>
<span id="cb28-1488"><a href="#cb28-1488" aria-hidden="true" tabindex="-1"></a>  file <span class="ot">&lt;-</span> Gdown_files[i]</span>
<span id="cb28-1489"><a href="#cb28-1489" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb28-1490"><a href="#cb28-1490" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb28-1491"><a href="#cb28-1491" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> genus)</span>
<span id="cb28-1492"><a href="#cb28-1492" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb28-1493"><a href="#cb28-1493" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="sc">!!</span>genus)</span>
<span id="cb28-1494"><a href="#cb28-1494" aria-hidden="true" tabindex="-1"></a>  param_gdown_list[[i]] <span class="ot">&lt;-</span> param_data</span>
<span id="cb28-1495"><a href="#cb28-1495" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1496"><a href="#cb28-1496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1497"><a href="#cb28-1497" aria-hidden="true" tabindex="-1"></a>combined_param_sos_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(param_sos_list) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Parameter <span class="sc">!=</span> <span class="st">"Alnus"</span>)</span>
<span id="cb28-1498"><a href="#cb28-1498" aria-hidden="true" tabindex="-1"></a>combined_param_eos_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(param_eos_list) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Parameter <span class="sc">!=</span> <span class="st">"Alnus"</span>)</span>
<span id="cb28-1499"><a href="#cb28-1499" aria-hidden="true" tabindex="-1"></a>combined_param_gup_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(param_gup_list) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Parameter <span class="sc">!=</span> <span class="st">"Alnus"</span>)</span>
<span id="cb28-1500"><a href="#cb28-1500" aria-hidden="true" tabindex="-1"></a>combined_param_gdown_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(param_gdown_list) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Parameter <span class="sc">!=</span> <span class="st">"Alnus"</span>)</span>
<span id="cb28-1501"><a href="#cb28-1501" aria-hidden="true" tabindex="-1"></a>combined_param_data <span class="ot">&lt;-</span> combined_param_sos_data <span class="sc">%&gt;%</span></span>
<span id="cb28-1502"><a href="#cb28-1502" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">phe_type =</span> <span class="st">"SOS"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb28-1503"><a href="#cb28-1503" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(combined_param_eos_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">phe_type =</span> <span class="st">"EOS"</span>))<span class="sc">%&gt;%</span></span>
<span id="cb28-1504"><a href="#cb28-1504" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(combined_param_gup_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">phe_type =</span> <span class="st">"GreenUp"</span>))<span class="sc">%&gt;%</span></span>
<span id="cb28-1505"><a href="#cb28-1505" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(combined_param_gdown_data <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">phe_type =</span> <span class="st">"GreenDown"</span>))</span>
<span id="cb28-1506"><a href="#cb28-1506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1507"><a href="#cb28-1507" aria-hidden="true" tabindex="-1"></a><span class="co"># ggmcmc</span></span>
<span id="cb28-1508"><a href="#cb28-1508" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(<span class="at">SOS=</span>combined_param_sos_data, <span class="at">EOS=</span>combined_param_eos_data, <span class="at">GreenUp=</span>combined_param_gup_data, <span class="at">GreenDown =</span> combined_param_gdown_data) <span class="sc">%&gt;%</span> </span>
<span id="cb28-1509"><a href="#cb28-1509" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggs_caterpillar</span>(<span class="at">thick_ci =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>),</span>
<span id="cb28-1510"><a href="#cb28-1510" aria-hidden="true" tabindex="-1"></a>                  <span class="at">thin_ci =</span> <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>),</span>
<span id="cb28-1511"><a href="#cb28-1511" aria-hidden="true" tabindex="-1"></a>                  <span class="at">horizontal =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb28-1512"><a href="#cb28-1512" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb28-1513"><a href="#cb28-1513" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Genus"</span>,</span>
<span id="cb28-1514"><a href="#cb28-1514" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"The posterior of regression coefficients for Tavg"</span>) <span class="sc">+</span></span>
<span id="cb28-1515"><a href="#cb28-1515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-1516"><a href="#cb28-1516" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb28-1517"><a href="#cb28-1517" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb28-1518"><a href="#cb28-1518" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb28-1519"><a href="#cb28-1519" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb28-1520"><a href="#cb28-1520" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1521"><a href="#cb28-1521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1522"><a href="#cb28-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1523"><a href="#cb28-1523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1524"><a href="#cb28-1524" aria-hidden="true" tabindex="-1"></a><span class="do">## geom_linerange</span></span>
<span id="cb28-1525"><a href="#cb28-1525" aria-hidden="true" tabindex="-1"></a>summary_data <span class="ot">&lt;-</span> combined_param_data <span class="sc">%&gt;%</span></span>
<span id="cb28-1526"><a href="#cb28-1526" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Parameter, phe_type) <span class="sc">%&gt;%</span></span>
<span id="cb28-1527"><a href="#cb28-1527" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb28-1528"><a href="#cb28-1528" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_value =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-1529"><a href="#cb28-1529" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.025</span>),</span>
<span id="cb28-1530"><a href="#cb28-1530" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper =</span> <span class="fu">quantile</span>(value, <span class="at">probs =</span> <span class="fl">0.975</span>),</span>
<span id="cb28-1531"><a href="#cb28-1531" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb28-1532"><a href="#cb28-1532" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1533"><a href="#cb28-1533" aria-hidden="true" tabindex="-1"></a>summary_data<span class="sc">$</span>phe_type <span class="ot">&lt;-</span> <span class="fu">factor</span>(summary_data<span class="sc">$</span>phe_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenDown"</span>))</span>
<span id="cb28-1534"><a href="#cb28-1534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1535"><a href="#cb28-1535" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(summary_data, <span class="fu">aes</span>(<span class="at">x =</span> Parameter, <span class="at">y =</span> mean_value, <span class="at">color =</span> phe_type)) <span class="sc">+</span></span>
<span id="cb28-1536"><a href="#cb28-1536" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.5</span>)) <span class="sc">+</span>  </span>
<span id="cb28-1537"><a href="#cb28-1537" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), <span class="at">size =</span> <span class="fl">0.5</span>, </span>
<span id="cb28-1538"><a href="#cb28-1538" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.5</span>)) <span class="sc">+</span> </span>
<span id="cb28-1539"><a href="#cb28-1539" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb28-1540"><a href="#cb28-1540" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span></span>
<span id="cb28-1541"><a href="#cb28-1541" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb28-1542"><a href="#cb28-1542" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Genus"</span>,</span>
<span id="cb28-1543"><a href="#cb28-1543" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"The posterior of regression coefficients for Tavg"</span>,</span>
<span id="cb28-1544"><a href="#cb28-1544" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Phenological parameter"</span></span>
<span id="cb28-1545"><a href="#cb28-1545" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1546"><a href="#cb28-1546" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb28-1547"><a href="#cb28-1547" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"SOS"</span> <span class="ot">=</span> <span class="st">"darkgreen"</span>, <span class="st">"GreenUp"</span> <span class="ot">=</span> <span class="st">"darkolivegreen3"</span>, <span class="st">"EOS"</span> <span class="ot">=</span> <span class="st">"chocolate4"</span>,  <span class="st">"GreenDown"</span> <span class="ot">=</span> <span class="st">"coral"</span>)</span>
<span id="cb28-1548"><a href="#cb28-1548" aria-hidden="true" tabindex="-1"></a>    <span class="co">#coral/chocolate</span></span>
<span id="cb28-1549"><a href="#cb28-1549" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb28-1550"><a href="#cb28-1550" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb28-1551"><a href="#cb28-1551" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb28-1552"><a href="#cb28-1552" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>), </span>
<span id="cb28-1553"><a href="#cb28-1553" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)</span>
<span id="cb28-1554"><a href="#cb28-1554" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-1555"><a href="#cb28-1555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1556"><a href="#cb28-1556" aria-hidden="true" tabindex="-1"></a><span class="co"># combined_param_data&lt;- bind_rows(param_data_list) </span></span>
<span id="cb28-1557"><a href="#cb28-1557" aria-hidden="true" tabindex="-1"></a><span class="co"># p &lt;- ggplot(combined_param_data, aes(x = Parameter, y = value, color = phe_type)) +</span></span>
<span id="cb28-1558"><a href="#cb28-1558" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_boxplot(outlier.shape = NA, width = 0.5) + </span></span>
<span id="cb28-1559"><a href="#cb28-1559" aria-hidden="true" tabindex="-1"></a><span class="co">#   theme_minimal() +</span></span>
<span id="cb28-1560"><a href="#cb28-1560" aria-hidden="true" tabindex="-1"></a><span class="co">#   labs(</span></span>
<span id="cb28-1561"><a href="#cb28-1561" aria-hidden="true" tabindex="-1"></a><span class="co">#     x = "Genus",</span></span>
<span id="cb28-1562"><a href="#cb28-1562" aria-hidden="true" tabindex="-1"></a><span class="co">#     y = "The distribution of the posterior of regression coefficients",</span></span>
<span id="cb28-1563"><a href="#cb28-1563" aria-hidden="true" tabindex="-1"></a><span class="co">#     color = "Phenological Type"</span></span>
<span id="cb28-1564"><a href="#cb28-1564" aria-hidden="true" tabindex="-1"></a><span class="co">#   ) +</span></span>
<span id="cb28-1565"><a href="#cb28-1565" aria-hidden="true" tabindex="-1"></a><span class="co">#   theme(</span></span>
<span id="cb28-1566"><a href="#cb28-1566" aria-hidden="true" tabindex="-1"></a><span class="co">#     axis.title = element_text(size = 14),</span></span>
<span id="cb28-1567"><a href="#cb28-1567" aria-hidden="true" tabindex="-1"></a><span class="co">#     axis.text.x = element_text(size = 12, angle = 45, hjust = 1),</span></span>
<span id="cb28-1568"><a href="#cb28-1568" aria-hidden="true" tabindex="-1"></a><span class="co">#     axis.text.y = element_text(size = 12),</span></span>
<span id="cb28-1569"><a href="#cb28-1569" aria-hidden="true" tabindex="-1"></a><span class="co">#     plot.title = element_text(size = 16, face = "bold", hjust = 0.5)</span></span>
<span id="cb28-1570"><a href="#cb28-1570" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb28-1571"><a href="#cb28-1571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1572"><a href="#cb28-1572" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1573"><a href="#cb28-1573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1574"><a href="#cb28-1574" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4 Conclusion and next step</span></span>
<span id="cb28-1575"><a href="#cb28-1575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1576"><a href="#cb28-1576" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The preseason length varies significantly among genera.</span>
<span id="cb28-1577"><a href="#cb28-1577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1578"><a href="#cb28-1578" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Within the city, the relationship between phenology and temperature is still significant.</span>
<span id="cb28-1579"><a href="#cb28-1579" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>The warmer the preseason temperature, the earlier the start of season, considering the spatial autocorrelation of phenology in the model.</span>
<span id="cb28-1580"><a href="#cb28-1580" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>As for green-up pace, for most genera, the warmer preseason leads to faster green-up pace. </span>
<span id="cb28-1581"><a href="#cb28-1581" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>The response of end of season to temperature shows great variation among genera, including both the magnitude and direction.</span>
<span id="cb28-1582"><a href="#cb28-1582" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>As for green-down pace, for most genera, the warmer preseason leads to faster green-down pace. </span>
<span id="cb28-1583"><a href="#cb28-1583" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>The precipitation has no significant impact.</span>
<span id="cb28-1584"><a href="#cb28-1584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1585"><a href="#cb28-1585" aria-hidden="true" tabindex="-1"></a>Next steps:</span>
<span id="cb28-1586"><a href="#cb28-1586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1587"><a href="#cb28-1587" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Future steps:</span>
<span id="cb28-1588"><a href="#cb28-1588" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Test sensitivity by changing buffer size.</span>
<span id="cb28-1589"><a href="#cb28-1589" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Add more taxa (data in DataDen and download latest PS images)</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>