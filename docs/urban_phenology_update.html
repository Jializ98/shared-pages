<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jiali Zhu">
<meta name="dcterms.date" content="2025-03-12">

<title>Urban phenology updates - Share on lab meeting</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-2d01dac5deb81f30d2e298efbbbf2476.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#question-and-hypothesis" id="toc-question-and-hypothesis" class="nav-link" data-scroll-target="#question-and-hypothesis">Question and Hypothesis</a></li>
  <li><a href="#raw-data" id="toc-raw-data" class="nav-link" data-scroll-target="#raw-data">1 Raw data</a>
  <ul class="collapse">
  <li><a href="#read-and-clean-the-wu-data-based-on-ghcnd" id="toc-read-and-clean-the-wu-data-based-on-ghcnd" class="nav-link" data-scroll-target="#read-and-clean-the-wu-data-based-on-ghcnd">1.1 Read and clean the WU data (based on GHCNd)</a></li>
  <li><a href="#shortwave-data-from-daymet" id="toc-shortwave-data-from-daymet" class="nav-link" data-scroll-target="#shortwave-data-from-daymet">1.2 Shortwave data from Daymet</a></li>
  <li><a href="#select-the-street-tree-base-on-wu-data" id="toc-select-the-street-tree-base-on-wu-data" class="nav-link" data-scroll-target="#select-the-street-tree-base-on-wu-data">1.3 Select the street tree base on WU data</a></li>
  </ul></li>
  <li><a href="#method" id="toc-method" class="nav-link" data-scroll-target="#method">2 Method</a>
  <ul class="collapse">
  <li><a href="#phenological-indicators" id="toc-phenological-indicators" class="nav-link" data-scroll-target="#phenological-indicators">2.1 Phenological indicators</a></li>
  <li><a href="#optimal-preseason-length-calculated-by-tempavg" id="toc-optimal-preseason-length-calculated-by-tempavg" class="nav-link" data-scroll-target="#optimal-preseason-length-calculated-by-tempavg">2.2 Optimal preseason length calculated by Temp<sub>avg</sub></a></li>
  <li><a href="#brief-summary-of-the-data" id="toc-brief-summary-of-the-data" class="nav-link" data-scroll-target="#brief-summary-of-the-data">2.3 Brief summary of the data</a></li>
  <li><a href="#spatial-model" id="toc-spatial-model" class="nav-link" data-scroll-target="#spatial-model">2.4 Spatial model</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">3 Results</a>
  <ul class="collapse">
  <li><a href="#sos-in-nyc" id="toc-sos-in-nyc" class="nav-link" data-scroll-target="#sos-in-nyc">3.1 SOS in NYC</a></li>
  <li><a href="#other-phenophases-in-nyc" id="toc-other-phenophases-in-nyc" class="nav-link" data-scroll-target="#other-phenophases-in-nyc">3.2 Other phenophases in NYC</a></li>
  <li><a href="#comparison-across-cities" id="toc-comparison-across-cities" class="nav-link" data-scroll-target="#comparison-across-cities">3.3 Comparison across cities</a></li>
  <li><a href="#prediction" id="toc-prediction" class="nav-link" data-scroll-target="#prediction">3.4 Prediction</a></li>
  </ul></li>
  <li><a href="#model-validation" id="toc-model-validation" class="nav-link" data-scroll-target="#model-validation">4 Model validation</a>
  <ul class="collapse">
  <li><a href="#check-spatial-autocorrelation" id="toc-check-spatial-autocorrelation" class="nav-link" data-scroll-target="#check-spatial-autocorrelation">4.1 Check spatial autocorrelation</a></li>
  <li><a href="#simulation-for-models-validation" id="toc-simulation-for-models-validation" class="nav-link" data-scroll-target="#simulation-for-models-validation">4.2 Simulation for model’s validation</a></li>
  <li><a href="#comparison-with-ols" id="toc-comparison-with-ols" class="nav-link" data-scroll-target="#comparison-with-ols">4.3 Comparison with OLS</a></li>
  </ul></li>
  <li><a href="#conclusion-and-next-step" id="toc-conclusion-and-next-step" class="nav-link" data-scroll-target="#conclusion-and-next-step">5 Conclusion and next step</a>
  <ul class="collapse">
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next steps</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Urban phenology updates - Share on lab meeting</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jiali Zhu </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 12, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<ul>
<li><p>Phenology, the timing of periodic plant life cycle events, is sensitive to biotic and abiotic environment.</p></li>
<li><p>Spatial unevenness of urban thermal environment might lead to the spatial heterogeneity of phenology.</p>
<ul>
<li>Negative correlation between the flowering date and the monthly mean LST in February–April.</li>
</ul>
<div id="fig-katz_2019" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-katz_2019-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="docs/katz_2019.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-katz_2019-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Katz et al., 2019
</figcaption>
</figure>
</div>
<ul>
<li>A significant spatial variation for First flowing date of 35 species, which negatively correlated withdaily LST.</li>
</ul>
<div id="fig-xing_2022" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-xing_2022-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="docs/xing_2022.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-xing_2022-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Xing et al., 2022
</figcaption>
</figure>
</div></li>
<li><p>Require <strong>phenology records and climate information within city</strong>:</p>
<ul>
<li><p>As for <strong>phenology</strong>, we need broader data collection to capture a more comprehensive picture of vegetation and further enable city-to-city comparisons.</p>
<ul>
<li>Medium-resolution satellite data might fail to capture the fine-scale variations in tree phenology within the heterogeneous urban landscapes.</li>
<li>Genus / Species information is lost in remote sensing data</li>
</ul></li>
<li><p>As for <strong>urban micro-climate</strong>.</p>
<ul>
<li>Land surface temperature could not accurately represent tree growing environment.</li>
<li>Decoupling between urban microclimates and surrounding free-air conditions.</li>
</ul></li>
</ul></li>
</ul>
</section>
<section id="question-and-hypothesis" class="level2">
<h2 class="anchored" data-anchor-id="question-and-hypothesis">Question and Hypothesis</h2>
<ul>
<li><p><strong>Question</strong>: What is the spatial heterogeneity of individual tree phenology from the same genus within a city, and across cities located in different climate regions?</p></li>
<li><p><strong>Hypothesis</strong>: The heterogeneous urban landscape amplifies the variation of individual phenology within cities.</p></li>
<li><p><strong>Goal</strong>: <em>Insights into how vegetation adapts to altered environmental conditions under urbanization and predict future pathways under global warming.</em></p></li>
</ul>
</section>
<section id="raw-data" class="level2">
<h2 class="anchored" data-anchor-id="raw-data">1 Raw data</h2>
<section id="read-and-clean-the-wu-data-based-on-ghcnd" class="level3">
<h3 class="anchored" data-anchor-id="read-and-clean-the-wu-data-based-on-ghcnd">1.1 Read and clean the WU data (based on GHCNd)</h3>
<p>The urban microclimate information comes from the <a href="https://www.wunderground.com/">Weather Underground program</a>. There are 4 raw daily variables selected, i.e.&nbsp;AvgTemp, HighTemp, LowTemp and Precipitation_sum (Sum_mm). I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily <a href="https://www.ncei.noaa.gov/products/land-based-station/global-historical-climatology-network-daily">GHCNd</a>.</p>
<p>For initial analysis, I collect the date from 4 cities, i.e.&nbsp;New York, Houston, Detroit, and Seattle.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># No. of WU sites</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Category =</span> <span class="fu">c</span>(<span class="st">"DV"</span>, <span class="st">"NY"</span>, <span class="st">"ST"</span>, <span class="st">"HT"</span>),</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Number_of_Sites =</span> <span class="fu">c</span>(<span class="dv">226</span>, <span class="dv">148</span>, <span class="dv">367</span>, <span class="dv">171</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> Category, <span class="at">y =</span> Number_of_Sites)) <span class="sc">+</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> Number_of_Sites), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Category"</span>, <span class="at">y =</span> <span class="st">"Number of Sites"</span>) <span class="sc">+</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-wu_sites" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-wu_sites-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-wu_sites-1.png" class="img-fluid figure-img" width="528">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wu_sites-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Number of WU sites in each city
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="shortwave-data-from-daymet" class="level3">
<h3 class="anchored" data-anchor-id="shortwave-data-from-daymet">1.2 Shortwave data from Daymet</h3>
<p>To control for the influence of other variables on phenology, I also incorporated shortwave radiation data derived from the <a href="https://daymet.ornl.gov/">Daymet daily dataset</a> with a 1 km resolution. Shortwave radiation was extracted for the specific locations of the trees.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># download</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/raw/"</span>, city, <span class="st">"/Daymet/daily2016-2024/"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_dir, <span class="at">pattern =</span> <span class="st">"srad_daily_2023_ncss</span><span class="sc">\\</span><span class="st">.nc$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>srad_nc <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(file)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>srad_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(srad_nc[[<span class="dv">1</span>]], <span class="at">xy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(srad_df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> srad_1)) <span class="sc">+</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"W/m²"</span>) <span class="sc">+</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Shortwave Radiation (W/m²) - 2023-01-01"</span>, <span class="at">x =</span> <span class="st">"x"</span>, <span class="at">y =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-plot_daymet" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plot_daymet-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-plot_daymet-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot_daymet-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: The shortwave radiation raster in 2023-01-01, NY
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="select-the-street-tree-base-on-wu-data" class="level3">
<h3 class="anchored" data-anchor-id="select-the-street-tree-base-on-wu-data">1.3 Select the street tree base on WU data</h3>
<p>I used the street tree in the above 4 cities, with the phenology records established by Yiluan. These trees are part of the whole inventory, covering 14 genera and being sampled. I select the trees which are within <strong>500 m</strong> buffer around the Weather Underground sites (see <a href="#fig-tree_wu_sites" class="quarto-xref">Figure&nbsp;5</a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>cities <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"NY"</span>, <span class="st">"HT"</span>, <span class="st">"DV"</span>, <span class="st">"ST"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (city <span class="cf">in</span> cities){</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  points_in_buffer <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tree_WU_500_buffer_PS.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  points_in_buffer_sf <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># us_boundary &lt;- st_read("~/urban-niche/data/raw/CONUS/boundary/us_boundarydissolve.shp") %&gt;%</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     st_transform(4326)</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  boundary <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    city,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NY"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DT/City_of_Detroit_Boundary/City_of_Detroit_Boundary.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ST"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/ST/seattle_boundary/CityUGA.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Seattle"</span>),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/HT/HGAC_City_Boundaries/HGAC_City_Boundaries.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Houston"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TP"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/TP/Municipal_Boundary/Municipal_Boundary.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Tampa"</span>),</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DV"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DV/DRCOG_Municipalities/DRCOG_Municipalities.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(city <span class="sc">==</span> <span class="st">"Denver"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/AT/TxDOT_City_Boundaries/Cities.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Austin"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Invalid city abbreviation."</span>)</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  wu_location <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>, city, <span class="st">"/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> boundary, <span class="at">fill =</span> <span class="st">"grey90"</span>) <span class="sc">+</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_sf(data = us_boundary, color = "blue", size = 1) +</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> wu_location, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> points_in_buffer, <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat), <span class="at">color =</span> <span class="st">"red"</span>,<span class="at">size =</span> <span class="fl">0.01</span>, <span class="at">alpha =</span> <span class="fl">0.01</span>) <span class="sc">+</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> city) <span class="sc">+</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  plots[[city]] <span class="ot">=</span> p</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>combined_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-tree_wu_sites" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tree_wu_sites-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-tree_wu_sites-1.png" class="img-fluid figure-img" width="1440">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tree_wu_sites-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Location of WU sites and trees
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="method" class="level2">
<h2 class="anchored" data-anchor-id="method">2 Method</h2>
<section id="phenological-indicators" class="level3">
<h3 class="anchored" data-anchor-id="phenological-indicators">2.1 Phenological indicators</h3>
<p>The tree locations points were overlapped with Planetscope imageries to extract the reflectance values. After smoothing and regression, we could get the EVI curve. The phenological metrics were calculated based on the EVI curve:</p>
<div id="fig-ps_example" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ps_example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="docs/ps_example.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ps_example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Extract reflectance from PlanetScope based on tree location, an example in NY
</figcaption>
</figure>
</div>
<div id="fig-pheno_matrics" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pheno_matrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="docs/pheno_matrix.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pheno_matrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Phenology metrics calculated based on EVI curve from PlanetScope
</figcaption>
</figure>
</div>
<ul>
<li><p>Spring phenology</p>
<ul>
<li><code>SOS</code>: Defined as the day of year when individual tree growing season EVI curves first cross the green-up 50% threshold.</li>
<li><code>Green-up Pace</code>: Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-up 20% threshold to the 80% threshold.</li>
</ul></li>
<li><p>Fall phenology</p>
<ul>
<li><code>EOS</code>: Defined as the day of year when individual tree growing season EVI curves first cross the green-down 50% threshold.</li>
<li><code>Green-down Pace</code>: Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-down 20% threshold to the 80% threshold.</li>
</ul></li>
</ul>
</section>
<section id="optimal-preseason-length-calculated-by-tempavg" class="level3">
<h3 class="anchored" data-anchor-id="optimal-preseason-length-calculated-by-tempavg">2.2 Optimal preseason length calculated by Temp<sub>avg</sub></h3>
<p>Defined as the period (5-180 days, with 5-day steps) before phenological event for which the partial correlation coefficient between mean phenological event date and average temperature was highest, controlling other climate variables. <a href="https://www.pnas.org/doi/10.1073/pnas.1911117117#sec-3">Meng et al., 2020</a>, <a href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2023EF004127">Yin et al., 2024</a></p>
<div id="fig-preseason_concept" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-preseason_concept-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="docs/preseason.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-preseason_concept-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Conceptual diagram for optimal preseason
</figcaption>
</figure>
</div>
<p><a href="#fig-partial_preseason" class="quarto-xref">Figure&nbsp;9</a> displays the distribution of optimal preseason length and partial correlation coefficient calculated by Temp<sub>avg</sub> for <code>SOS</code>, <code>Greenup pace</code>, <code>EOS</code> and <code>Greenup pace</code>, respectively.</p>
<p>Optimal preseason length for spring phenology varies among genera. As for <code>SOS</code>, all genera have negetive partial correlation coefficients, which means the higher preseason average temperature, the earlier start of season. As for <code>Greenup pace</code>, most genera (except Carya, Celtis) have negetive partial correlation coefficients, which means the higher preseason average temperature, the faster green up pace. The preseason length varies significantly among genera.</p>
<p>Both the optimal preseason length for fall phenology and the response direction vary significantly among genera. As for <code>EOS</code>, most genera (except Populus, Platanus) have positive partial correlation coefficients, which means the higher preseason average temperature, the later end of season. As for <code>Greenup pace</code>, there is variation in impact direction among genera. The preseason length also varies significantly among genera.</p>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>tavg_allyear_pcorr <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tavg_allyear_pcorr.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a flag for optimal_pre_length</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_optimal =</span> <span class="fu">ifelse</span>(pre_length_candidate <span class="sc">==</span> optimal_pre_length, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a flag for significant pvalue</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_significant =</span> <span class="fu">ifelse</span>(pvalue_trend <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust transparency</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fu">ifelse</span>(is_optimal, <span class="dv">1</span>, <span class="fl">0.2</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">ifelse</span>(is_significant, <span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fu">ifelse</span>(is_optimal, <span class="dv">4</span>, <span class="fl">1.2</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">shape =</span> <span class="fu">factor</span>(shape, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>)),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>         <span class="at">size =</span> <span class="fu">factor</span>(size, <span class="at">levels =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="dv">4</span>)))</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>sos_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"SOS"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">shape =</span> shape, <span class="at">size =</span> size)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt;= 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="dv">4</span>), </span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Start of season"</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>greenup_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"green-up pace"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt;= 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="dv">4</span>), </span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Green-up pace"</span>,</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>eos_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"EOS"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt;= 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="dv">4</span>), </span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"End of season"</span>,</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>greendown_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"green-down pace"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt;= 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="dv">4</span>), </span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Green-down pace"</span>,</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>sos_p <span class="sc">+</span> greenup_p <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>eos_p <span class="sc">+</span> greendown_p <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-partial_preseason" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-partial_preseason-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-partial_preseason" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-partial_preseason-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-partial_preseason-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-partial_preseason-1.png" class="img-fluid figure-img" data-ref-parent="fig-partial_preseason" width="1248">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-partial_preseason-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Spring phenology
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-partial_preseason" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-partial_preseason-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-partial_preseason-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-partial_preseason-2.png" class="img-fluid figure-img" data-ref-parent="fig-partial_preseason" width="1248">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-partial_preseason-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Fall phenology
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-partial_preseason-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: Distribution of partial correlation coefficient and preseason length, calculated by Temp<sub>avg</sub>
</figcaption>
</figure>
</div>
</section>
<section id="brief-summary-of-the-data" class="level3">
<h3 class="anchored" data-anchor-id="brief-summary-of-the-data">2.3 Brief summary of the data</h3>
<p>So far, we have collected the phenology records and preseason climate information. The overall data variation is shown as below:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fixed_genera <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Acer"</span>, <span class="st">"Alnus"</span>, <span class="st">"Betula"</span>, <span class="st">"Carya"</span>, <span class="st">"Celtis"</span>, <span class="st">"Fraxinus"</span>, </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Juglans"</span>, <span class="st">"Liquidambar"</span>, <span class="st">"Morus"</span>, <span class="st">"Platanus"</span>, <span class="st">"Populus"</span>, </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Quercus"</span>, <span class="st">"Salix"</span>, <span class="st">"Ulmus"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>color_palette <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">viridis</span>(<span class="fu">length</span>(fixed_genera)), fixed_genera)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">map</span>(cities, <span class="cf">function</span>(city){</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>, city, <span class="st">"/tavg_allyear_var.rds"</span>))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  phe_type <span class="ot">=</span> <span class="st">"SOS"</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"SOS"</span>) {</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"EOS"</span>) {</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"GreenUp"</span>) {</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="sc">!!</span>thres) <span class="sc">%&gt;%</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">na.omit</span>()</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  doy_temp_summary <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(genus) <span class="sc">%&gt;%</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_doy =</span> <span class="fu">mean</span>(doy, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">IQR_d =</span> <span class="fu">quantile</span>(doy, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">quantile</span>(doy, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower_whisker_d =</span> <span class="fu">max</span>(<span class="fu">quantile</span>(doy, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> IQR_d, <span class="fu">min</span>(doy, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper_whisker_d =</span> <span class="fu">min</span>(<span class="fu">quantile</span>(doy, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> IQR_d, <span class="fu">max</span>(doy, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_temp =</span> <span class="fu">mean</span>(AvgTemp_mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">IQR_t =</span> <span class="fu">quantile</span>(AvgTemp_mean, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">quantile</span>(AvgTemp_mean, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower_whisker_t =</span> <span class="fu">max</span>(<span class="fu">quantile</span>(AvgTemp_mean, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> IQR_t, <span class="fu">min</span>(AvgTemp_mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper_whisker_t =</span> <span class="fu">min</span>(<span class="fu">quantile</span>(AvgTemp_mean, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> IQR_t, <span class="fu">max</span>(AvgTemp_mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(doy_temp_summary, <span class="fu">aes</span>(<span class="at">x =</span> mean_temp, <span class="at">y =</span> mean_doy, <span class="at">color =</span> genus)) <span class="sc">+</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower_whisker_d, <span class="at">ymax =</span> upper_whisker_d), <span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower_whisker_t, <span class="at">xmax =</span> upper_whisker_t), <span class="at">height =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span>,  <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> color_palette) <span class="sc">+</span> </span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Average preseason temperature"</span>, <span class="at">y =</span> <span class="st">"SOS"</span>, <span class="at">title =</span> city) <span class="sc">+</span></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>)  <span class="sc">&amp;</span> </span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="urban_phenology_update_files/figure-html/data_summary-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>The variation range of phenology (e.g., <code>SOS</code>) and preseason temperature (<code>AvgTemp</code>) in different cities</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="spatial-model" class="level3">
<h3 class="anchored" data-anchor-id="spatial-model">2.4 Spatial model</h3>
<p>I modeled the relationship between the phenology and environmental covariates using a spatial hierarchical model. The response variable (phenology parameter) at location <span class="math inline">\(\mathbf{s}_i\)</span> and in year <span class="math inline">\(\mathbf{t}\)</span>, denoted as <span class="math inline">\(y(\mathbf{s}_i, \mathbf{t})\)</span>, was modeled as following model:</p>
<p><strong>Model: (current use)</strong></p>
<p><span class="math display">\[y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w(\mathbf{s}_i) + u(\mathbf{t}) + \epsilon(\mathbf{s}_i, \mathbf{t})\]</span></p>
<p>where:</p>
<ul>
<li><p><em>Fixed Effects</em>: <span class="math display">\[\mu(\mathbf{s}_i,\mathbf{t}) = \mathbf{X}_{\mathbf{s}_i,\mathbf{t}} \boldsymbol{\beta}\]</span></p>
<ul>
<li><span class="math inline">\(\mathbf{X}_{\mathbf{s}_i,\mathbf{t}} = [1, \text{AvgTemp}_{\mathbf{s}_i,\mathbf{t}}, \text{Precp}_{\mathbf{s}_i,\mathbf{t}}, \text{srad}_{\mathbf{s}_i,\mathbf{t}}]\)</span> is the design matrix of predictors.</li>
<li><span class="math inline">\(\boldsymbol{\beta} = [\beta_0, \beta_1, \beta_2, \beta_3]\)</span> are the regression coefficients for the intercept and covariates.</li>
<li><span class="math inline">\(\beta_1\)</span> is the coefficient for the average temperature, which is the main interest in this study.</li>
</ul></li>
<li><p><em>Spatially Correlated Random Effect</em>: <span class="math display">\[w(\mathbf{s}_i) \sim \text{MVN}(\mathbf{0}, \mathbf{R})\]</span></p>
<ul>
<li><p><span class="math inline">\(\mathbf{R}\)</span> is the spatial correlation matrix defined by a covariance function.</p></li>
<li><p>In MCMC, I chose the optimal covariance function based on the variogram fitting:</p>
<ul>
<li><p>Matérn Covariance Function (if selected): <span class="math display">\[\mathbf{R}_{ij} = \sigma^2 \cdot \frac{2^{1-\nu}}{\Gamma(\nu)} \left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)^\nu K_\nu\left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)\]</span></p></li>
<li><p>Exponential Covariance Function (if selected): <span class="math display">\[\mathbf{R}_{ij} = \sigma^2 \cdot \exp(-\phi D_{ij})\]</span></p></li>
<li><p>Gaussian Covariance Function (if selected): <span class="math display">\[\mathbf{R}_{ij} = \sigma^2 \cdot \exp(-\phi D_{ij}^2)\]</span></p></li>
<li><p>Spherical Covariance Function (if selected):</p></li>
</ul>
<p><span class="math display">\[\mathbf{R}_{ij} =
        \begin{cases}
        \sigma^2 \cdot \left(1 - \frac{3 D_{ij}}{2\rho} + \frac{D_{ij}^3}{2\rho ^3}\right), &amp; D_{ij} \leq \rho \\
        0, &amp; D_{ij} &gt; \rho
        \end{cases}\]</span></p></li>
<li><p>In INLA, a spatial process with a Matérn covariance can be obtained as the weak solution to a stochastic partial differential equation (SPDE). The SPDE method uses the Finite Element Method (FEM) to approximate a spatial Gaussian Random Field (GRF). It constructs a triangulated mesh, where each node serves as a basis for interpolation. Basis functions are defined to be 1 at a node and decay to 0 at neighboring triangles, ensuring local influence. By discretizing the SPDE, the problem transforms into a sparse Gaussian Markov Random Field (GMRF), making computations more efficient for large spatial datasets.</p></li>
</ul></li>
<li><p><em>Year-specific Random Effect</em>: <span class="math display">\[u(\mathbf{t}) \sim \text{N}(0, \tau^2_{\mathbf{t}})\]</span></p>
<ul>
<li><span class="math inline">\(u_{\mathbf{t}}\)</span> captures year-to-year variability, with <span class="math inline">\(\tau^2_{\mathbf{t}}\)</span> being the variance of the year effect.</li>
</ul></li>
<li><p><em>Independent Nugget Effect</em>: <span class="math display">\[\epsilon(\mathbf{s}_i) \sim \text{N}(0, \tau^2)\]</span></p>
<ul>
<li><span class="math inline">\(\epsilon(\mathbf{s}_i, \mathbf{t})\)</span> accounts for measurement error or small-scale variability.</li>
</ul></li>
</ul>
<p><strong>Get the posterior distribution of model parameters</strong>:</p>
<ul>
<li><p><strong>MCMC</strong>: In <code>NIMBLE</code> package, the MCMC algorithm was used to sample from the posterior distribution of the model parameters.</p></li>
<li><p><strong>INLA</strong>: In <code>INLA</code> package, the Integrated Nested Laplace Approximation (INLA) was used to approximate the posterior distribution of the model parameters. Rather than estimating the joint posterior distribution of the parameters via MCMC, INLA focusing on individual posterior marginals of the model parameters, which is enough to make inference of the model parameters and latent effects in most cases.</p></li>
</ul>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">3 Results</h2>
<section id="sos-in-nyc" class="level3">
<h3 class="anchored" data-anchor-id="sos-in-nyc">3.1 SOS in NYC</h3>
<section id="mcmc" class="level4">
<h4 class="anchored" data-anchor-id="mcmc">3.1.1 MCMC</h4>
<p>Code example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  <span class="do">#################### Model Specification ####################</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>model_code <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>      y[i] <span class="sc">~</span> <span class="fu">dnorm</span>(mu[i], tau)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>      mu[i] <span class="ot">&lt;-</span> <span class="fu">inprod</span>(X[i, <span class="dv">1</span><span class="sc">:</span>P], beta[]) <span class="sc">+</span> spatial_effect[i] <span class="sc">+</span> year_effect[year[i]]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (q <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nyears) {</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>      year_effect[q] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(tau.year))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>P) {</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>      beta[j] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1000</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    spatial_effect[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dmnorm</span>(Mu[<span class="dv">1</span><span class="sc">:</span>N], <span class="at">cov =</span> cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N])</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Choose the covariance function based on variogram fitting</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (N_knots <span class="sc">&lt;=</span> N_unique){</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Mat"</span>) {</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> <span class="fu">matern_covariance</span>(knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots], range, sigma.sq, nu) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> <span class="fu">matern_covariance</span>(data_knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots], range, sigma.sq, nu)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Gau"</span>) {</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> data_knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Exp"</span>) {</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> data_knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots])</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Sph"</span>) {</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots], range, sigma.sq) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(data_knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots], range, sigma.sq)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>      knots_cov_chol_inv[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> <span class="fu">inverse</span>(<span class="fu">chol</span>(knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]))</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>      cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="sc">%*%</span> </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        knots_cov_chol_inv[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="sc">%*%</span> <span class="fu">t</span>(knots_cov_chol_inv[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]) <span class="sc">%*%</span> </span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">t</span>(data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots]) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Mat"</span>) {</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span>  <span class="fu">matern_covariance</span>(dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N], range, sigma.sq, nu) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Gau"</span>) {</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Exp"</span>) {</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>        cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Sph"</span>) {</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N], range, sigma.sq) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Priors</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    tau <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="fl">0.001</span>, <span class="fl">0.001</span>)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    sigma.sq <span class="sc">~</span> <span class="fu">dinvgamma</span>(<span class="fl">2.5</span>, <span class="dv">120</span>)</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    phi <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">5</span> <span class="sc">/</span> <span class="dv">1</span>, <span class="dv">5</span> <span class="sc">/</span> <span class="fl">0.1</span>)</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>    tau.year <span class="sc">~</span> <span class="fu">dinvgamma</span>(<span class="fl">2.001</span>, <span class="fl">0.667</span>)</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    range <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    nu <span class="sc">~</span> <span class="fu">dunif</span>(<span class="fl">0.5</span>, <span class="dv">5</span>)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Data inputs</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>  nyears <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(tavg_phe_df<span class="sc">$</span>year))</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(sp_formula, <span class="at">data =</span> tavg_phe_df)</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> tavg_phe_df[[<span class="fu">all.vars</span>(sp_formula)[<span class="dv">1</span>]]]</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>  year_index <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(tavg_phe_df<span class="sc">$</span>year))  <span class="co"># Create fixed year indices</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y, <span class="at">X =</span> X)  <span class="co"># Remove 'year' from data</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>  inits <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">ncol</span>(X)),</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau =</span> <span class="dv">1</span>, <span class="at">sigma.sq =</span> <span class="dv">80</span>, <span class="at">phi =</span> <span class="dv">25</span>, <span class="at">tau.year =</span> <span class="dv">1</span>,</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">range =</span> <span class="fl">0.5</span>,</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">spatial_effect =</span> <span class="fu">rep</span>(<span class="dv">0</span>, N), </span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu =</span> <span class="dv">1</span>,</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_effect =</span> <span class="fu">rep</span>(<span class="dv">0</span>, nyears)</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Change based on semi-variogram fitting</span></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>  constants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> N, <span class="at">N_knots =</span> N_knots, <span class="at">N_unique =</span> N_unique, <span class="at">P =</span> <span class="fu">ncol</span>(X), <span class="at">Mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, N), <span class="at">nyears =</span> nyears, </span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>                    <span class="at">dist_matrix =</span> dist_matrix, <span class="at">knots_dist_matrix =</span> knots_dist_matrix, </span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data_knots_dist_matrix =</span> data_knots_dist_matrix,</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>                    <span class="at">year =</span> year_index, <span class="at">I =</span> <span class="fu">diag</span>(<span class="fl">1e-6</span>,N), <span class="at">cov_type =</span> cov_type)  <span class="co"># Add 'year' to constants</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>  monitors <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    cov_type,</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mat"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"tau.year"</span>, <span class="st">"range"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"nu"</span>, <span class="st">"spatial_effect"</span>, <span class="st">"year_effect"</span>),</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Gau"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"tau"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"phi"</span>, <span class="st">"tau.year"</span>, <span class="st">"spatial_effect"</span>, <span class="st">"year_effect"</span>),</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Exp"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"tau"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"phi"</span>, <span class="st">"tau.year"</span>, <span class="st">"spatial_effect"</span>, <span class="st">"year_effect"</span>),</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sph"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"tau.year"</span>, <span class="st">"range"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"spatial_effect"</span>, <span class="st">"year_effect"</span>),</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Unknown cov_type!"</span>)</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>  ni <span class="ot">&lt;-</span> <span class="dv">10000</span>   <span class="co"># nb iterations </span></span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> <span class="dv">50</span>       <span class="co"># thinning interval</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>  nb <span class="ot">&lt;-</span> ni <span class="sc">/</span> <span class="dv">2</span>    <span class="co"># nb iterations as burn-in </span></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>  nc <span class="ot">&lt;-</span> <span class="dv">1</span>         <span class="co"># nb chains</span></span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>  <span class="do">#################### Run/Save the model ####################</span></span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>  modelMCMCrun <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(<span class="at">code =</span> model_code, <span class="at">data =</span> data, <span class="at">constants =</span> constants, <span class="at">inits =</span> inits, </span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>                             <span class="at">monitors =</span> monitors,</span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>                             <span class="at">niter =</span> ni, <span class="at">nburnin =</span> nb, <span class="at">thin =</span> nt, <span class="at">nchains =</span> nc, <span class="at">setSeed =</span> <span class="dv">2025</span>,</span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>                             <span class="at">progressBar =</span> <span class="cn">TRUE</span>, </span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>                             <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span>, </span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>                             <span class="at">summary =</span> <span class="cn">TRUE</span>, </span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>                             <span class="at">WAIC =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Most genera showed negative association between temperature and the start of season, suggesting the warmer preseason, the earilier start of season. Only Fraxinus had a positive association, with a median coefficient of 0.15. There are significant genus-level differences in how temperature influences the spring phenology.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/year_random/"</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*SOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_SOS</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>combined_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ny_sos_tavg_mcmc_coef" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ny_sos_tavg_mcmc_coef-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-ny_sos_tavg_mcmc_coef-1.png" class="img-fluid figure-img" width="1152">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ny_sos_tavg_mcmc_coef-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: The density of the posterior distribution of regression coefficients for <code>Temp~avg~</code> with <code>SOS</code> as the response variable for each genus in New York city, generated via MCMC.
</figcaption>
</figure>
</div>
</div>
</div>
<p>As for the spatial field, only Salix seems to be ideal. Other genera exhibit either uniform spatial effects or noticeable local variations, even extremely high value.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>spherical_covariance <span class="ot">&lt;-</span> <span class="cf">function</span>(d, range, sigma.sq) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(d), <span class="at">ncol =</span> <span class="fu">ncol</span>(d))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d)) {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(d)) {</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (d[i, j] <span class="sc">&lt;=</span> range) {</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        result[i, j] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> (<span class="dv">3</span> <span class="sc">*</span> d[i, j] <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> range)) <span class="sc">+</span> (d[i, j]<span class="sc">^</span><span class="dv">3</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> range<span class="sc">^</span><span class="dv">3</span>)))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        result[i, j] <span class="ot">&lt;-</span> <span class="fl">0.0</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>matern_covariance <span class="ot">&lt;-</span> <span class="cf">function</span>(d, range, sigma.sq, nu) {</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(d), <span class="at">ncol =</span> <span class="fu">ncol</span>(d))</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d)) {</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(d)) {</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (d[i, j] <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        result[i, j] <span class="ot">&lt;-</span> <span class="fl">0.0</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        part <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">^</span>(<span class="dv">1</span> <span class="sc">-</span> nu)) <span class="sc">/</span> <span class="fu">gamma</span>(nu) <span class="sc">*</span> (<span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> nu) <span class="sc">*</span> d[i, j] <span class="sc">/</span> range)<span class="sc">^</span>nu</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        result[i, j] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> part <span class="sc">*</span> <span class="fu">besselK</span>(<span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> nu) <span class="sc">*</span> d[i, j] <span class="sc">/</span> range, nu)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/year_random/"</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>phe_type <span class="ot">=</span> <span class="st">"SOS"</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"SOS"</span>) {</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>  phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>  direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>  thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"EOS"</span>) {</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>  phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>  direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>  thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"GreenUp"</span>) {</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>  phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>  direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>  thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>  phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>  direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>  thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^"</span>,city,<span class="st">".*"</span>,phe_type,<span class="st">"</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*SOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>plots_mean <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>plots_sd <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>plots_extend <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>  spatial_mean <span class="ot">&lt;-</span> model_data<span class="sc">$</span>summary[<span class="fu">grep</span>(<span class="st">"spatial_effect"</span>, <span class="fu">rownames</span>(model_data<span class="sc">$</span>summary)), <span class="st">"Mean"</span>]</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>  spatial_sd <span class="ot">&lt;-</span> model_data<span class="sc">$</span>summary[<span class="fu">grep</span>(<span class="st">"spatial_effect"</span>, <span class="fu">rownames</span>(model_data<span class="sc">$</span>summary)), <span class="st">"St.Dev."</span>]</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>, city, <span class="st">"/tavg_allyear_var.rds"</span>))  <span class="sc">%&gt;%</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="sc">!!</span>thres <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>  <span class="co"># %&gt;%</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   st_as_sf(coords = c("lon", "lat"), crs = 4326)</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>  OLS_formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(phe_metric, <span class="st">" ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year)"</span>))</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(OLS_formula, <span class="at">data =</span> tavg_allyear_var)</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_allyear_var[[phe_metric]] <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_allyear_var) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_allyear_var, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>  cov_type <span class="ot">&lt;-</span> <span class="fu">as.character</span>(vgm_exn_fit<span class="sc">$</span>model)</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>, city, <span class="st">"/tavg_allyear_var.rds"</span>))  <span class="sc">%&gt;%</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="sc">!!</span>thres <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>  monitors <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>    cov_type,</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mat"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"range"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"nu"</span>),</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Gau"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"tau"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"phi"</span>),</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Exp"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"tau"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"phi"</span>),</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sph"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"range"</span>, <span class="st">"sigma.sq"</span>),</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Unknown cov_type!"</span>)</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>  params <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">range =</span> <span class="cn">NULL</span>, <span class="at">sigma.sq =</span> <span class="cn">NULL</span>, <span class="at">nu =</span> <span class="cn">NULL</span>, <span class="at">phi =</span> <span class="cn">NULL</span>)</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (param <span class="cf">in</span> <span class="fu">names</span>(params)) {</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (param <span class="sc">%in%</span> monitors) {</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>      params[[param]] <span class="ot">&lt;-</span> model_data<span class="sc">$</span>summary[<span class="fu">grep</span>(param, <span class="fu">rownames</span>(model_data<span class="sc">$</span>summary)), <span class="st">"Mean"</span>]</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>  grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon =</span> <span class="fu">seq</span>(<span class="fu">min</span>(tavg_allyear_var<span class="sc">$</span>lon), <span class="fu">max</span>(tavg_allyear_var<span class="sc">$</span>lon), <span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat =</span> <span class="fu">seq</span>(<span class="fu">min</span>(tavg_allyear_var<span class="sc">$</span>lat), <span class="fu">max</span>(tavg_allyear_var<span class="sc">$</span>lat), <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>  coords_known <span class="ot">&lt;-</span> tavg_allyear_var[, <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)]</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>  coords_pred <span class="ot">&lt;-</span> grid[, <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)]</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>  dist_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(coords_known))</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>  dist_matrix_known_pred <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">rbind</span>(coords_pred, coords_known)))[<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(coords_pred), (<span class="fu">nrow</span>(coords_pred) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="fu">nrow</span>(coords_pred) <span class="sc">+</span> <span class="fu">nrow</span>(coords_known))]</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Mat"</span>) {</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>      cov_matrix <span class="ot">&lt;-</span> <span class="fu">matern_covariance</span>(dist_matrix, params<span class="sc">$</span>range, params<span class="sc">$</span>sigma.sq, params<span class="sc">$</span>nu)</span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Gau"</span>) {</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>      cov_matrix <span class="ot">&lt;-</span> params<span class="sc">$</span>sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>params<span class="sc">$</span>phi <span class="sc">*</span> dist_matrix<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Exp"</span>) {</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>      cov_matrix <span class="ot">&lt;-</span> params<span class="sc">$</span>sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>params<span class="sc">$</span>phi <span class="sc">*</span> dist_matrix)</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Sph"</span>) {</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>      cov_matrix <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(<span class="at">d =</span> dist_matrix, <span class="at">range =</span> params<span class="sc">$</span>range, <span class="at">sigma.sq =</span> params<span class="sc">$</span>sigma.sq)</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>  cov_matrix <span class="ot">&lt;-</span> cov_matrix <span class="sc">+</span> <span class="fu">diag</span>(<span class="fl">1e-6</span>, <span class="fu">nrow</span>(dist_matrix))</span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Mat"</span>) {</span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>      cov_matrix_pred <span class="ot">&lt;-</span> <span class="fu">matern_covariance</span>(dist_matrix_known_pred, params<span class="sc">$</span>range, params<span class="sc">$</span>sigma.sq, params<span class="sc">$</span>nu)</span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Gau"</span>) {</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>      cov_matrix_pred <span class="ot">&lt;-</span> params<span class="sc">$</span>sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>params<span class="sc">$</span>phi <span class="sc">*</span> dist_matrix_known_pred<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Exp"</span>) {</span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>      cov_matrix_pred <span class="ot">&lt;-</span> params<span class="sc">$</span>sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>params<span class="sc">$</span>phi <span class="sc">*</span> dist_matrix_known_pred)</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Sph"</span>) {</span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>      cov_matrix_pred <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(<span class="at">d =</span> dist_matrix_known_pred, <span class="at">range =</span> params<span class="sc">$</span>range, <span class="at">sigma.sq =</span> params<span class="sc">$</span>sigma.sq)</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>  spatial_effect_pred <span class="ot">&lt;-</span> cov_matrix_pred <span class="sc">%*%</span> <span class="fu">solve</span>(cov_matrix) <span class="sc">%*%</span> spatial_mean</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>  grid<span class="sc">$</span>spatial_effect <span class="ot">&lt;-</span> spatial_effect_pred</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grid, <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">fill =</span> spatial_effect)) <span class="sc">+</span></span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"Mean"</span>) <span class="sc">+</span></span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>  plots_extend[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tavg_allyear_var$spatial_mean &lt;- spatial_mean</span></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tavg_allyear_var$spatial_sd &lt;- spatial_sd</span></span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># p_mean &lt;- ggplot() +</span></span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   geom_point(data = tavg_allyear_var, aes(x = lon, y = lat, color = spatial_mean), size = 2) +</span></span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +</span></span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   theme_minimal() +</span></span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   ggtitle(paste("Genus:", genus)) +</span></span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   labs(color = "Mean")</span></span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>  <span class="co"># p_sd &lt;- ggplot() +</span></span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   geom_point(data = tavg_allyear_var, aes(x = lon, y = lat, color = spatial_sd), size = 2) +</span></span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   scale_color_gradient(low = "white", high = "red") +</span></span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   theme_minimal() +</span></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   ggtitle(paste("Genus:", genus)) +</span></span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   labs(color = "SD")</span></span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plots_mean[[genus]] &lt;- p_mean</span></span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plots_sd[[genus]] &lt;- p_sd</span></span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>combined_plot_extend <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots_extend, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>combined_plot_extend</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ny_sos_tavg_mcmc_sp" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ny_sos_tavg_mcmc_sp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-ny_sos_tavg_mcmc_sp-1.png" class="img-fluid figure-img" width="1344">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ny_sos_tavg_mcmc_sp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: Spatial fields, generated via MCMC
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="inla" class="level4">
<h4 class="anchored" data-anchor-id="inla">3.1.2 INLA</h4>
<p>Code example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">#################### Prepare the mesh and spde ####################</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="do">### Build the mesh </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>coord <span class="ot">&lt;-</span> <span class="fu">cbind</span>(tavg_allyear_var<span class="sc">$</span>lon, tavg_allyear_var<span class="sc">$</span>lat) <span class="co"># coordinates of observations</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>domain <span class="ot">&lt;-</span> <span class="fu">inla.nonconvex.hull</span>(<span class="fu">as.matrix</span>(coord),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                              <span class="at">concave =</span> <span class="sc">-</span>.<span class="dv">07</span>,<span class="at">convex =</span> <span class="sc">-</span><span class="fl">0.05</span>, <span class="at">resolution=</span><span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">100</span>))</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">&lt;-</span> <span class="fu">inla.mesh.2d</span>(<span class="at">boundary =</span> domain, <span class="at">loc =</span> coord,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">max.edge =</span> <span class="fu">c</span>(<span class="dv">10000</span>, <span class="dv">20000</span>), </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cutoff =</span> <span class="dv">1000</span> <span class="co"># prevent close points from being connected</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># mesh$n</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot() +</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_sf(data=ny_boundary,color='turquoise',fill='transparent') +</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   gg(mesh) +</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_sf(data=tavg_allyear_var_sf,col='purple',size=1.7,alpha=0.5)</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="do">### Build the spde </span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">&lt;-</span> <span class="fu">inla.spde2.matern</span>(<span class="at">mesh =</span> mesh, <span class="at">alpha =</span> <span class="dv">2</span>, <span class="at">constr =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>A.phe <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh, <span class="at">loc =</span> coord)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>s.index <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.index</span>(<span class="at">name =</span> <span class="st">"spatial.field"</span>,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>                                <span class="at">n.spde =</span> spde<span class="sc">$</span>n.spde)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co"># dim(A.phe)</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>coorp <span class="ot">&lt;-</span> <span class="fu">cbind</span>(prediction<span class="sc">$</span>Lon, prediction<span class="sc">$</span>Lat) </span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>A.phe.p <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh, <span class="at">loc =</span> coorp)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="do">#################### Stack the data ####################</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>stk.e <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">tag =</span> <span class="st">"est"</span>,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> tavg_allyear_var[[phe_metric]]),</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, A.phe),</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">effects =</span> <span class="fu">list</span>(<span class="fu">data.frame</span>(<span class="at">Intercept =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(coord)),</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>                            <span class="at">AvgTemp_mean =</span> tavg_allyear_var<span class="sc">$</span>AvgTemp_mean,</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Sum_mm_sum =</span> tavg_allyear_var<span class="sc">$</span>Sum_mm_sum,</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>                            <span class="at">srad_mean =</span> tavg_allyear_var<span class="sc">$</span>srad_mean,</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                            <span class="at">year =</span> tavg_allyear_var<span class="sc">$</span>year), </span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>                 <span class="at">s =</span> s.index)</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>stk.p <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">tag =</span> <span class="st">"pred"</span>,</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="cn">NA</span>),</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, A.phe.p),</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">effects =</span> <span class="fu">list</span>(<span class="fu">data.frame</span>(<span class="at">Intercept =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(coorp)),</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>                            <span class="at">AvgTemp_mean =</span> prediction<span class="sc">$</span>AvgTemp_mean,</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Sum_mm_sum =</span> prediction<span class="sc">$</span>Sum_mm_sum,</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>                            <span class="at">srad_mean =</span> prediction<span class="sc">$</span>srad_mean,</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>                            <span class="at">year =</span> prediction<span class="sc">$</span>year), </span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>                 <span class="at">s =</span> s.index)</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a><span class="co"># stk.full has stk.e and stk.p</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>stk.full <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(stk.e, stk.p)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="do">#################### Run/Save the model ####################</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a><span class="do">### Run the model</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Intercept <span class="sc">+</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> <span class="fu">f</span>(year, <span class="at">model =</span> <span class="st">'iid'</span>) <span class="sc">+</span> <span class="fu">f</span>(spatial.field, <span class="at">model =</span> spde)</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">inla</span>(formula,</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stk.full),</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>            <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">return.marginals =</span> <span class="cn">TRUE</span>, <span class="at">waic =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>            <span class="at">control.predictor =</span> <span class="fu">list</span>(</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>              <span class="at">compute =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>              <span class="at">A =</span> <span class="fu">inla.stack.A</span>(stk.full)</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As for the INLA model, the coefficients do not show significant differences from the MCMC model, with most genera showed negative association between temperature and the start of season.</p>
<p>Why so convergent? INLA first finds the Maximum A Posteriori (MAP) estimate, which is the highest point of the posterior distribution. Then it uses Laplace Approximation, which inherently assumes that the posterior distribution is approximately normal near its peak (the MAP estimate).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/"</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>phe_type <span class="ot">=</span> <span class="st">"GreenDown"</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>plots_mean <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>plots_sd <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>plots_semi <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^"</span>,city,<span class="st">".*"</span>,phe_type,<span class="st">"</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>plots_tavg <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>coef_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co"># for one genus</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># beta_names &lt;- c("beta[0]", "beta[AvgTemp_mean]", "beta[Sum_mm_sum]", "beta[srad_mean]")</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># df_list &lt;- lapply(seq_along(model_data$res$marginals.fixed), function(i) {</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   data.frame(x = model_data$res$marginals.fixed[[i]][,1], </span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">#              density = model_data$res$marginals.fixed[[i]][,2], </span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#              beta = beta_names[i])</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># })</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># df &lt;- bind_rows(df_list)</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  beta_avg_temp <span class="ot">&lt;-</span> model_data<span class="sc">$</span>res<span class="sc">$</span>marginals.fixed[[<span class="dv">2</span>]]</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> beta_avg_temp[, <span class="dv">1</span>],</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> beta_avg_temp[, <span class="dv">2</span>],</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="st">"beta[AvgTemp_mean]"</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>  plot_tavg <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># facet_wrap(~beta, scales = "free", labeller = label_parsed) + </span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Coefficient Value"</span>, <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>  plots_tavg[[genus]] <span class="ot">&lt;-</span> plot_tavg</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>  proj <span class="ot">&lt;-</span> <span class="fu">inla.mesh.projector</span>(model_data<span class="sc">$</span>mesh,<span class="at">dims =</span> <span class="fu">c</span>(<span class="dv">300</span>, <span class="dv">300</span>))</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>  mean_s <span class="ot">&lt;-</span> <span class="fu">inla.mesh.project</span>(proj, model_data<span class="sc">$</span>res<span class="sc">$</span>summary.random<span class="sc">$</span>s<span class="sc">$</span>mean)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>  sd_s <span class="ot">&lt;-</span> <span class="fu">inla.mesh.project</span>(proj, model_data<span class="sc">$</span>res<span class="sc">$</span>summary.random<span class="sc">$</span>s<span class="sc">$</span>sd)</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x =</span> proj<span class="sc">$</span>x, <span class="at">y =</span> proj<span class="sc">$</span>y)</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>mean_s <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(mean_s)</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>sd_s <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(sd_s)</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>  p_mean <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> mean_s)) <span class="sc">+</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis</span>(<span class="at">na.value =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="fl">0.8</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>  p_sd <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> sd_s)) <span class="sc">+</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis</span>(<span class="at">na.value =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Plot the decay of spatial autocorrelation across a user-defined range</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>  spde.est <span class="ot">&lt;-</span> <span class="fu">inla.spde2.result</span>(<span class="at">inla =</span> model_data<span class="sc">$</span>res, <span class="at">name =</span> <span class="st">"spatial.field"</span>,</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>                                <span class="at">spde =</span> model_data<span class="sc">$</span>spde, <span class="at">do.transf =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>  Kappa <span class="ot">=</span> <span class="fu">inla.zmarginal</span>(spde.est<span class="sc">$</span>marginals.kappa[[<span class="dv">1</span>]], <span class="at">silent =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]<span class="sc">$</span>mean</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>  MaxRange <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>  Resolution <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>  d.vec <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, MaxRange, <span class="at">length =</span> Resolution)</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>  Cor.M <span class="ot">&lt;-</span> (Kappa <span class="sc">*</span> d.vec) <span class="sc">*</span> <span class="fu">besselK</span>(Kappa <span class="sc">*</span> d.vec, <span class="dv">1</span>)</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>  Cor.M[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>  CorData <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Distance =</span> d.vec, <span class="at">Correlation =</span> Cor.M)</span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>  p_semi <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(CorData, <span class="fu">aes</span>(<span class="at">x =</span> Distance, <span class="at">y =</span> Correlation)) <span class="sc">+</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> MaxRange) <span class="sc">+</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Distance (m)"</span>, <span class="at">y =</span> <span class="st">"Correlation"</span>, <span class="at">title =</span> <span class="st">"Matern Correlation Function"</span>) <span class="sc">+</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>  plots_mean[[genus]] <span class="ot">&lt;-</span> p_mean</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>  plots_sd[[genus]] <span class="ot">&lt;-</span> p_sd</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>  plots_semi[[genus]] <span class="ot">&lt;-</span> p_semi</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>combined_plot_tavg <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots_tavg, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>combined_plot_tavg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ny_sos_tavg_coef" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ny_sos_tavg_coef-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-ny_sos_tavg_coef-1.png" class="img-fluid figure-img" width="1152">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ny_sos_tavg_coef-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: The density of the posterior distribution of regression coefficients for <code>Temp~avg~</code> with <code>SOS</code> as the response variable for each genus in New York city, generated via INLA.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Compared to the previous MCMC results, these spatial fields appear to be smoother overall, with gradual transitions rather than sharp local variations.Some genera (Ulmus, Alnus) have fewer high/low value clusters due to fewer observations.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>combined_plot_semi <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots_semi, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>combined_plot_mean <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots_mean, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>combined_plot_sd <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots_sd, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>combined_plot_mean</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ny_sos_tavg_sp" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ny_sos_tavg_sp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-ny_sos_tavg_sp-1.png" class="img-fluid figure-img" width="1440">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ny_sos_tavg_sp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13: Spatial fields generated via INLA.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="other-phenophases-in-nyc" class="level3">
<h3 class="anchored" data-anchor-id="other-phenophases-in-nyc">3.2 Other phenophases in NYC</h3>
<p>Since the spatial fiels are more smooth, the coefficient estimates are more valid.</p>
<p>The genus Alnus has fewer data points, leading to non-convergence of the posterior distribution. So it is ignored here.</p>
<p>The magnitude of their responses vary among genera. However, the direction of their response is relatively consistent among most genera, with a 1- to 4-day advancement in SOS, 1-8 days delay in EOS (except Platanus), 1-2 days faster in GreenUp pace (except Celtis), and 1-2 days faster in GreenDown pace (except Carya) as preseason temperature increases 1 degree C.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/"</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^"</span>,city,<span class="st">".*</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>coef_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  phe_type <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">3"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  fixed_summary <span class="ot">&lt;-</span> model_data<span class="sc">$</span>fix_effect <span class="sc">%&gt;%</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">genus =</span> genus, <span class="at">phe_type =</span> phe_type)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(fixed_summary)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>coef_summary_df <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SigAlpha =</span> <span class="fu">ifelse</span>(Sig <span class="sc">==</span> <span class="st">"*"</span>, <span class="dv">1</span>, <span class="fl">0.2</span>),</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>         <span class="at">phe_type =</span> <span class="fu">factor</span>(phe_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Factor <span class="sc">!=</span> <span class="st">"Alnus"</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>coef_summary_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef_summary_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(Factor, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">unique</span>(Factor))), </span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> SigAlpha), <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Lower, <span class="at">ymax =</span> Upper, <span class="at">alpha =</span> SigAlpha), </span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), </span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>phe_type, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>) <span class="sc">+</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> Estimate, <span class="at">y =</span> Estimate), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.9</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">alpha =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">aspect.ratio =</span> <span class="dv">1</span>,</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>coef_summary_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ny_tavg_comp" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ny_tavg_comp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-ny_tavg_comp-1.png" class="img-fluid figure-img" width="960">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ny_tavg_comp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;14: The distribution of the posterior of regression coefficients for <code>Temp~avg~</code> for each genus in New York city (Thick line: 90% CI, thin line: 95% CI, point: mean value).
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="comparison-across-cities" class="level3">
<h3 class="anchored" data-anchor-id="comparison-across-cities">3.3 Comparison across cities</h3>
<p>For SOS, most genera all cities showed negative association between temperature and the start of season. Only some genera in DV and ST had a positive association.</p>
<p>For EOS, the difference among cities is the most obvious. Almost all genera in NY and ST had a positive association, while most genera in DV had a negative association. <strong>Precipitation/humidity/elevation?</strong></p>
<p>For GreenUp, most genera had a positive association.</p>
<p>For GreenDown, almost all genera in DV and NY had a negative association, while most genera in ST and HT had a positive association.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">### INLA</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/"</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^.*</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>coef_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  city <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  phe_type <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">3"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  fixed_summary <span class="ot">&lt;-</span> model_data<span class="sc">$</span>fix_effect <span class="sc">%&gt;%</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">city =</span> city, <span class="at">genus =</span> genus, <span class="at">phe_type =</span> phe_type)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(fixed_summary)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>coef_summary_df <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SigAlpha =</span> <span class="fu">ifelse</span>(Sig <span class="sc">==</span> <span class="st">"*"</span>, <span class="dv">1</span>, <span class="fl">0.2</span>),</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">phe_type =</span> <span class="fu">factor</span>(phe_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)),</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">city =</span> <span class="fu">factor</span>(city, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"NY"</span>, <span class="st">"DV"</span>, <span class="st">"HT"</span>, <span class="st">"ST"</span>)))</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>coef_summary_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef_summary_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(Factor, <span class="at">levels =</span> <span class="fu">unique</span>(Factor)), <span class="at">y =</span> Estimate, <span class="at">color =</span> city)) <span class="sc">+</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> SigAlpha), <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Lower, <span class="at">ymax =</span> Upper, <span class="at">alpha =</span> SigAlpha), </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), </span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">linewidth =</span> <span class="fl">0.5</span>,</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coord_flip() +</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>phe_type, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"NY"</span> <span class="ot">=</span> <span class="st">"darkolivegreen4"</span>, <span class="st">"HT"</span> <span class="ot">=</span> <span class="st">"navyblue"</span>, <span class="st">"DV"</span> <span class="ot">=</span> <span class="st">"chocolate"</span>, <span class="st">"ST"</span> <span class="ot">=</span> <span class="st">"purple"</span>)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>) <span class="sc">+</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(aes(label = Estimate, y = Estimate), vjust = -0.9, show.legend = FALSE, size = 3) +</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">alpha =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>coef_summary_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-city_comp" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-city_comp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-city_comp-1.png" class="img-fluid figure-img" width="960">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-city_comp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;15: The distribution of the posterior of regression coefficients for <code>Temp~avg~</code> on phenology for each genus (Line: 95% CI, point: mean value).
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="prediction" class="level3">
<h3 class="anchored" data-anchor-id="prediction">3.4 Prediction</h3>
<p>More appropriate way to prepresent heterogeneity?</p>
<ul class="task-list">
<li><label><input type="checkbox">The prediction is located at the weather station, because I don’t interpolate the weather data to cover the whole city.</label></li>
</ul>
<p><strong>Out of sample</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>NY_Acer_tavg_SOS <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/NY_Acer_tavg_SOS.rds"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>phe_type <span class="ot">=</span> <span class="st">"SOS"</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>genus <span class="ot">=</span> <span class="st">"Acer"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>mean_doy_acer <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tavg_allyear_var.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(genus <span class="sc">==</span> <span class="sc">!!</span>genus <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> direction <span class="sc">==</span> <span class="st">"up"</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">doy =</span> <span class="fu">mean</span>(doy)) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(doy)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>preseason <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tavg_allyear_pcorr.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(genus <span class="sc">==</span> <span class="sc">!!</span>genus <span class="sc">&amp;</span> type <span class="sc">==</span> <span class="sc">!!</span>phe_type) <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">pre =</span> <span class="fu">mean</span>(optimal_pre_length)) <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(pre)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">=</span> <span class="fu">make_date</span>(<span class="dv">2023</span>) <span class="sc">+</span> <span class="fu">days</span>(<span class="fu">round</span>(mean_doy_acer) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">days</span>(preseason)</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>end_date <span class="ot">=</span> <span class="fu">make_date</span>(<span class="dv">2023</span>) <span class="sc">+</span> <span class="fu">days</span>(<span class="fu">round</span>(mean_doy_acer) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>NY_weather <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>,city,<span class="st">"/"</span>,city,<span class="st">"_wu.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> start_date <span class="sc">&amp;</span> Date <span class="sc">&lt;=</span> end_date) <span class="sc">%&gt;%</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">AvgTemp_mean =</span> <span class="fu">mean</span>(AvgTemp),</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>            <span class="at">Sum_mm_sum =</span> <span class="fu">sum</span>(Sum_mm),</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">year =</span> <span class="fu">as.factor</span>(<span class="dv">2023</span>))</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>NY_srad <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/raw/"</span>,city,<span class="st">"/Daymet/daily2016-2024/srad_wu_2023.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">&gt;=</span> start_date <span class="sc">&amp;</span> time <span class="sc">&lt;=</span> end_date) <span class="sc">%&gt;%</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Site) <span class="sc">%&gt;%</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">srad_mean =</span> <span class="fu">mean</span>(value)) <span class="sc">%&gt;%</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(NY_weather, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Site"</span> <span class="ot">=</span> <span class="st">"name"</span>))</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>,city,<span class="st">"/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(NY_srad, <span class="at">by =</span> <span class="st">"Site"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">inla.stack.index</span>(<span class="at">stack =</span> NY_Acer_tavg_SOS<span class="sc">$</span>stk.full, <span class="at">tag =</span> <span class="st">"pred"</span>)<span class="sc">$</span>data</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>coorp <span class="ot">&lt;-</span> prediction[, <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>)]</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="ot">&lt;-</span> NY_Acer_tavg_SOS<span class="sc">$</span>res<span class="sc">$</span>summary.fitted.values[index, <span class="st">"mean"</span>]</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>pred_ll <span class="ot">&lt;-</span> NY_Acer_tavg_SOS<span class="sc">$</span>res<span class="sc">$</span>summary.fitted.values[index, <span class="st">"0.025quant"</span>]</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>pred_ul <span class="ot">&lt;-</span> NY_Acer_tavg_SOS<span class="sc">$</span>res<span class="sc">$</span>summary.fitted.values[index, <span class="st">"0.975quant"</span>]</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>pred_ph_2023 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">Lon =</span> coorp[, <span class="dv">1</span>], <span class="at">Lat =</span> coorp[, <span class="dv">2</span>],</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> pred_mean, <span class="at">variable =</span> <span class="st">"pred_mean"</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">Lon =</span> coorp[, <span class="dv">1</span>], <span class="at">Lat =</span> coorp[, <span class="dv">2</span>],</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> pred_ll, <span class="at">variable =</span> <span class="st">"pred_ll"</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">Lon =</span> coorp[, <span class="dv">1</span>], <span class="at">Lat =</span> coorp[, <span class="dv">2</span>],</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> pred_ul, <span class="at">variable =</span> <span class="st">"pred_ul"</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>pred_ph_2023<span class="sc">$</span>variable <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(pred_ph_2023<span class="sc">$</span>variable)</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pred_ph_2023) <span class="sc">+</span></span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(Lon, Lat, <span class="at">color  =</span> value)) <span class="sc">+</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Predicted SOS</span><span class="sc">\n</span><span class="st">in 2023"</span>,</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">high =</span> <span class="st">"orange"</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ny_predict" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ny_predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-ny_predict-1.png" class="img-fluid figure-img" width="960">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ny_predict-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;16: Prediction for the <code>SOS</code> of Acer in 2023 in New York city. The prediction are made at the weather station.
</figcaption>
</figure>
</div>
</div>
</div>
<p><strong>In sample</strong></p>
<p>Overall, the fitted values show a high consistency with the actual values, with points concentrated around the 1:1 line. Except for GreenDown, the model’s fitted values exhibit lower variation.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/insample_pred/"</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^NY.*</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  phe_type <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">3"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  compare_one <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">t</span>(model_data<span class="sc">$</span>compare)) <span class="sc">%&gt;%</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">as.numeric</span>(value), </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>           <span class="at">true_value =</span> <span class="fu">as.numeric</span>(true_value),</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">genus =</span> genus,</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">phe_type =</span> phe_type)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  compare <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(compare, compare_one)}</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co"># slope_data &lt;- compare %&gt;%</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">#   group_by(phe_type) %&gt;%</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   summarise(slope = round(coef(lm(value ~ true_value, data = cur_data()))[2], 3),</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="co">#             mean_x = mean(true_value, na.rm = TRUE),</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="co">#             mean_y = mean(value, na.rm = TRUE)) </span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(compare, <span class="fu">aes</span>(<span class="at">x =</span> true_value, <span class="at">y =</span> value, <span class="at">color=</span> genus)) <span class="sc">+</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_smooth(method = "lm", formula = y ~ x, se = FALSE, color = "blue") +</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(data = slope_data, aes(x = mean_x, y = mean_y, label = paste("Slope =", slope)),color = "blue", size = 5, inherit.aes = FALSE) +</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="fu">factor</span>(phe_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)),</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>             <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"True value"</span>, <span class="at">y =</span> <span class="st">"Fitted value"</span>) <span class="sc">+</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ny_predict_insample" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ny_predict_insample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-ny_predict_insample-1.png" class="img-fluid figure-img" width="960">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ny_predict_insample-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;17: Comparison between fitted value and ture value in New York city.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="model-validation" class="level2">
<h2 class="anchored" data-anchor-id="model-validation">4 Model validation</h2>
<section id="check-spatial-autocorrelation" class="level3">
<h3 class="anchored" data-anchor-id="check-spatial-autocorrelation">4.1 Check spatial autocorrelation</h3>
<p>First, I fitted a linear mixed-effects model for each genus with environmental variables (<code>AvgTemp_mean</code>, <code>Sum_mm_sum</code>, and <code>srad_mean</code>) as predictors, with random effects for <code>year</code> and <code>id</code>, which represent temporal (<code>(1 | year)</code>) and spatial (<code>(1 | id)</code>) randomness, respectively.</p>
<p>Then I conducted a variance decomposition analysis and compared the proportion of total variance explained by spatial effects and temporal effects respectively. Generally, spatial and temporal variations are both present, but their contributions vary across different genera. Some genera show higher spatial effects, while others have more balanced contributions from spatial and year components.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/DV/tavg_allyear_var.rds"</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>all_genus <span class="ot">&lt;-</span> <span class="fu">unique</span>(tavg_allyear_var<span class="sc">$</span>genus)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"SOS"</span>) {</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"EOS"</span>) {</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"GreenUp"</span>) {</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (genus <span class="cf">in</span> all_genus) {</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>      tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> thres <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">na.omit</span>()</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>      model <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(phe_metric, <span class="st">" ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year) + (1 | id)"</span>))</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>      full_model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(model, <span class="at">data =</span> tavg_SOS)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>      var_components <span class="ot">&lt;-</span> <span class="fu">VarCorr</span>(full_model)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>      total_variance <span class="ot">&lt;-</span>  var_components<span class="sc">$</span>id[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">+</span>  var_components<span class="sc">$</span>year[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">attr</span>(var_components, <span class="st">"sc"</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>      spatial_contribution <span class="ot">&lt;-</span> var_components<span class="sc">$</span>id[<span class="dv">1</span>, <span class="dv">1</span>]  <span class="sc">/</span> total_variance</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>      year_contribution <span class="ot">&lt;-</span>  var_components<span class="sc">$</span>year[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">/</span> total_variance</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>      residual_contribution <span class="ot">&lt;-</span> <span class="fu">attr</span>(var_components, <span class="st">"sc"</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> total_variance</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>      variance_components <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>            <span class="at">Metric =</span> phe_type,</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>            <span class="at">Genus =</span> genus,</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>            <span class="at">Component =</span> <span class="fu">c</span>(<span class="st">"Spatial"</span>, <span class="st">"Year"</span>, <span class="st">"Residual"</span>),</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>            <span class="at">Variance =</span> <span class="fu">c</span>(spatial_contribution, year_contribution, residual_contribution)</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>          results[[<span class="fu">paste</span>(phe_type, genus, <span class="at">sep =</span> <span class="st">"_"</span>)]] <span class="ot">&lt;-</span> variance_components</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>final_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, results)</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>final_results <span class="ot">&lt;-</span> final_results <span class="sc">%&gt;%</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Metric, Genus) <span class="sc">%&gt;%</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Variance_Proportion =</span> Variance <span class="sc">/</span> <span class="fu">sum</span>(Variance),</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>         <span class="at">Component =</span> <span class="fu">factor</span>(Component, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Spatial"</span>, <span class="st">"Residual"</span>, <span class="st">"Year"</span>)),</span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>         <span class="at">Metric =</span> <span class="fu">factor</span>(Metric, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)))</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(final_results, <span class="fu">aes</span>(<span class="at">x =</span> Genus, <span class="at">y =</span> Variance_Proportion, <span class="at">fill =</span> Component)) <span class="sc">+</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"stack"</span>) <span class="sc">+</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Metric, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Genus"</span>, <span class="at">y =</span> <span class="st">"Variance Proportion"</span>, <span class="at">fill =</span> <span class="st">"Component"</span>) <span class="sc">+</span></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-check_variance" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-check_variance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-check_variance-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-check_variance-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;18: Variance decomposition analysis for spatial and temporal effects
</figcaption>
</figure>
</div>
</div>
</div>
<!-- Using `SOS` as an example, I used `check_heteroscedasticity()` to check for heteroscedasticity in the residuals. The results showed almost every model had heterogenerous residuals. -->
<!-- For fixed-effect model (`SOS` \~ `AvgTemp_mean` + `Sum_mm_sum` + `srad_mean`), `Global Moran I` for regression residuals test indicates the presence of spatial autocorrelation in the residuals. `Lagrange Multiplier` test suggests the spatial model should be applied. -->
<!-- I computed the empirical semivariogram for the residuals to analyze spatial structure. The optimal theoretical semivariogram models (among Exp, Sph, Gau, Mat) were chosen to empirical semivariogram using `fit.variogram()`. -->
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/ST/tavg_allyear_var.rds"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>genera <span class="ot">&lt;-</span> <span class="fu">unique</span>(tavg_allyear_var<span class="sc">$</span>genus)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>variogram_sos <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"up"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  variogram_sos[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">SOS =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>variogram_sos <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_sos)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>variogram_eos <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"down"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>  variogram_eos[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">EOS =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>variogram_eos <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_eos)</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>variogram_up <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"up"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.2</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">doy_diff =</span> <span class="fu">as.numeric</span>(doy_diff))<span class="sc">%&gt;%</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy_diff <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>  variogram_up[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">GreenUp =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>variogram_up <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_up)</span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>variogram_down <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"down"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.2</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">doy_diff =</span> <span class="fu">as.numeric</span>(doy_diff))<span class="sc">%&gt;%</span></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy_diff <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>  variogram_down[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">GreenDown =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>variogram_down <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_down)</span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>variogram_summary <span class="ot">&lt;-</span> variogram_sos <span class="sc">%&gt;%</span></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_eos, <span class="at">by =</span> <span class="st">"genus"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_up, <span class="at">by =</span> <span class="st">"genus"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_down, <span class="at">by =</span> <span class="st">"genus"</span>)</span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(variogram_summary, <span class="at">caption =</span> <span class="st">"Fitted semivariogram model for each genus"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- Sph: 26, Mat: 22, Gau: 4, Exp: 4 HT: Sph, Mat -->
</section>
<section id="simulation-for-models-validation" class="level3">
<h3 class="anchored" data-anchor-id="simulation-for-models-validation">4.2 Simulation for model’s validation</h3>
<p>Potential issue:</p>
<ul class="task-list">
<li><p><label><input type="checkbox" checked="">The variance among years may be captured by the spatial covariance.</label></p></li>
<li><p><label><input type="checkbox" checked="">The covariance matrix is incorrectly specified.</label></p></li>
</ul>
<p>In this step, I primarily aimed to simulate data to verify whether the model is feasible and whether INLA can effectively capture the model parameters and assess uncertainty. Additionally, I examined whether the method can still detect signals when an incorrect covariance matrix is specified.</p>
<p>I simulated the data with the true slope of <code>Avg_temp</code> is <strong>-2</strong>. Both spatial covariance and temporal variance are included, and spatial covariance just happened among the records from the same year. Some records happen in the same location.</p>
<p><strong>The results demonstrate that this modeling approach is feasible.</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">################ Make up the simulation data ################</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>lon_range <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">74.25156</span>, <span class="sc">-</span><span class="fl">73.70623</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>lat_range <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">40.50458</span>, <span class="fl">40.91093</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">200</span> </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>lon <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="at">min =</span> lon_range[<span class="dv">1</span>], <span class="at">max =</span> lon_range[<span class="dv">2</span>])</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>lat <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="at">min =</span> lat_range[<span class="dv">1</span>], <span class="at">max =</span> lat_range[<span class="dv">2</span>])</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="dv">2017</span><span class="sc">:</span><span class="dv">2023</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>nyears <span class="ot">&lt;-</span> <span class="fu">length</span>(years)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>year <span class="ot">&lt;-</span> <span class="fu">sample</span>(years, N, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co"># fix effects: intercept, tavg, precp, srad</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">&lt;-</span> <span class="dv">120</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>tavg <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">0</span>, <span class="dv">25</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>precp <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">0</span>, <span class="dv">500</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>srad <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">300</span>, <span class="dv">450</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(intercept, <span class="sc">-</span><span class="dv">2</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, tavg, precp, srad)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="co"># spatial effect</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>sigma.sq <span class="ot">&lt;-</span> <span class="dv">80</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>spatial_effect <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (y <span class="cf">in</span> years) {</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>  year_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(year <span class="sc">==</span> y)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(year_idx) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    lon_year <span class="ot">&lt;-</span> lon[year_idx]</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    lat_year <span class="ot">&lt;-</span> lat[year_idx]</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    dist_matrix_year <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">cbind</span>(lon_year, lat_year)))</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    cov_matrix_year <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix_year)</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    spatial_effect[year_idx] <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(year_idx)), <span class="at">Sigma =</span> cov_matrix_year)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    spatial_effect[year_idx] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="co"># year effect</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>year_effect <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nyears, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>  year_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(years <span class="sc">==</span> year[i])</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>  mu[i] <span class="ot">&lt;-</span> X[i,] <span class="sc">%*%</span> beta <span class="sc">+</span> spatial_effect[i] <span class="sc">+</span> year_effect[year_idx]</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>  y[i] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> mu[i], <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau))</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">lon =</span> lon,</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">lat =</span> lat,</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> year,</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">AvgTemp_mean =</span> tavg,</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sum_mm_sum =</span> precp,</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">srad_mean =</span> srad,</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatial_effect =</span> spatial_effect,</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">doy =</span> y</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">################ MCMC ################</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co"># dir_path &lt;- "~/phenology-urban/data/proc/urban/sp_model/"</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># files &lt;- list.files(dir_path, pattern = "^SIM_sp_random.*\\.rds$", full.names = TRUE)</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co"># plots &lt;- list()</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co"># for (file in files) {</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   model_data &lt;- readRDS(file)</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   genus &lt;- sub(".*SIM_(.*?)_tavg_SOS_(.*?)\\.rds", "\\2", basename(file))</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_label &lt;- data.frame(Parameter = "beta[2]", Label = "AvgTemp")</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">#     filter(Parameter == "AvgTemp")</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_median &lt;- median(param_data$value)</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_mean &lt;- mean(param_data$value)</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   p &lt;- param_data %&gt;%</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     ggs_density() +</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     theme_bw() +</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     ggtitle(paste("Model:", genus)) +</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">#     theme(plot.title = element_text(hjust = 0.5)) +</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     annotate("text", x = beta_median, y = 0, label = paste0("Median: ", round(beta_median, 2)),vjust = -1.5, color = "red", size = 4) +</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     annotate("text", x = beta_mean, y = 2, label = paste0("Mean: ", round(beta_mean, 2)),vjust = -1.5, color = "red", size = 4)</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   plots[[genus]] &lt;- p</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co"># combined_plot2 &lt;- wrap_plots(plots, ncol = 2)</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="co"># combined_plot2</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="co"># files &lt;- list.files(dir_path, pattern = "^SIM_joint.*\\.rds$", full.names = TRUE)</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="co"># plots &lt;- list()</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="co"># for (file in files) {</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="co">#   model_data &lt;- readRDS(file)</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a><span class="co">#   genus &lt;- sub(".*SIM_(.*?)_tavg_SOS_(.*?)\\.rds", "\\2", basename(file))</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_label &lt;- data.frame(Parameter = "beta[2]", Label = "AvgTemp")</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a><span class="co">#   param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a><span class="co">#     filter(Parameter == "AvgTemp")</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_median &lt;- median(param_data$value)</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_mean &lt;- mean(param_data$value)</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a><span class="co">#   p &lt;- param_data %&gt;%</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="co">#     ggs_density() +</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="co">#     theme_bw() +</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a><span class="co">#     ggtitle(paste("Model:", genus)) +</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a><span class="co">#     theme(plot.title = element_text(hjust = 0.5)) +</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="co">#     annotate("text", x = beta_median, y = 0, label = paste0("Median: ", round(beta_median, 2)),vjust = -1.5, color = "red", size = 4) +</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a><span class="co">#     annotate("text", x = beta_mean, y = 2, label = paste0("Mean: ", round(beta_mean, 2)),vjust = -1.5, color = "red", size = 4)</span></span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a><span class="co">#   plots[[genus]] &lt;- p</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a><span class="co"># combined_plot &lt;- wrap_plots(plots, ncol = 2)</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a><span class="co"># combined_plot</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a><span class="do">################ INLA ################</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/SIM_INLA_tavg_SOS.rds"</span>)</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>genus <span class="ot">=</span> <span class="st">"Simulation"</span></span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a><span class="co"># fixed effect</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>beta_avg_temp <span class="ot">&lt;-</span> model_data<span class="sc">$</span>res<span class="sc">$</span>marginals.fixed</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>df_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(beta_avg_temp), <span class="cf">function</span>(nm) {</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> beta_avg_temp[[nm]][, <span class="dv">1</span>],</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> beta_avg_temp[[nm]][, <span class="dv">2</span>],</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">paste0</span>(<span class="st">"beta["</span>, nm, <span class="st">"]"</span>) </span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, df_list)</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>fix_effect <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(model_data<span class="sc">$</span>res)<span class="sc">$</span>fixed) <span class="sc">%&gt;%</span></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Mean =</span> mean, <span class="at">Lower =</span> <span class="st">`</span><span class="at">0.025quant</span><span class="st">`</span>,<span class="at">Upper =</span> <span class="st">`</span><span class="at">0.975quant</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Sig =</span> <span class="fu">ifelse</span>(Lower<span class="sc">*</span>Upper<span class="sc">&gt;</span><span class="dv">0</span>, <span class="st">"*"</span>, <span class="st">""</span>)) </span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>fix_effect <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">Factor =</span> <span class="fu">rownames</span>(fix_effect),  <span class="co"># Add Factor column</span></span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>  fix_effect, </span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Factor =</span> <span class="fu">case_when</span>(</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>    Factor <span class="sc">==</span> <span class="st">"Intercept"</span> <span class="sc">~</span> <span class="st">"beta[Intercept]"</span>,</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>    Factor <span class="sc">==</span> <span class="st">"AvgTemp_mean"</span> <span class="sc">~</span> <span class="st">"beta[AvgTemp_mean]"</span>,</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>    Factor <span class="sc">==</span> <span class="st">"Sum_mm_sum"</span> <span class="sc">~</span> <span class="st">"beta[Sum_mm_sum]"</span>,</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>    Factor <span class="sc">==</span> <span class="st">"srad_mean"</span> <span class="sc">~</span> <span class="st">"beta[srad_mean]"</span></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>  )) </span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>df_with_mean <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fix_effect <span class="sc">%&gt;%</span> <span class="fu">select</span>(Factor, Mean), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"beta"</span> <span class="ot">=</span> <span class="st">"Factor"</span>))</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>annot_data <span class="ot">&lt;-</span> df_with_mean <span class="sc">%&gt;%</span></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(beta) <span class="sc">%&gt;%</span></span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="fu">first</span>(Mean),</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_density =</span> <span class="fu">max</span>(density)</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>plot_tavg <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_with_mean, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span></span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> Mean, <span class="at">y =</span> max_density <span class="sc">*</span> <span class="fl">0.95</span>, </span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean = "</span>, <span class="fu">round</span>(Mean, <span class="dv">3</span>))),</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> annot_data,</span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">hjust =</span> <span class="fl">1.1</span></span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>beta, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">labeller =</span> label_parsed) <span class="sc">+</span> </span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Coefficient Value"</span>, <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>plot_tavg</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a><span class="co"># spatial field</span></span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>proj <span class="ot">&lt;-</span> <span class="fu">inla.mesh.projector</span>(model_data<span class="sc">$</span>mesh,<span class="at">dims =</span> <span class="fu">c</span>(<span class="dv">300</span>, <span class="dv">300</span>))</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>mean_s <span class="ot">&lt;-</span> <span class="fu">inla.mesh.project</span>(proj, model_data<span class="sc">$</span>res<span class="sc">$</span>summary.random<span class="sc">$</span>s<span class="sc">$</span>mean)</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>sd_s <span class="ot">&lt;-</span> <span class="fu">inla.mesh.project</span>(proj, model_data<span class="sc">$</span>res<span class="sc">$</span>summary.random<span class="sc">$</span>s<span class="sc">$</span>sd)</span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x =</span> proj<span class="sc">$</span>x, <span class="at">y =</span> proj<span class="sc">$</span>y)</span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>mean_s <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(mean_s)</span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>sd_s <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(sd_s)</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>gmean <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> mean_s)) <span class="sc">+</span></span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(<span class="at">na.value =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()  <span class="sc">+</span></span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="fl">0.9</span>))</span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>gsd <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> sd_s)) <span class="sc">+</span></span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(<span class="at">na.value =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="fl">0.9</span>))</span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a>gmean <span class="sc">+</span> gsd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div id="fig-model_sen_check" class="cell quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-model_sen_check-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output-display">
<div id="fig-model_sen_check-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-model_sen_check-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-model_sen_check-1.png" class="img-fluid figure-img" data-ref-parent="fig-model_sen_check" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-model_sen_check-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Distribution of posterior for coeffeicents
</figcaption>
</figure>
</div>
</div>
<div class="cell-output-display">
<div id="fig-model_sen_check-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-model_sen_check-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-model_sen_check-2.png" class="img-fluid figure-img" data-ref-parent="fig-model_sen_check" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-model_sen_check-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Spatial field
</figcaption>
</figure>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-model_sen_check-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19: The distribution of posterior for coeffeicent and spatial field using simulated data and R-INLA.
</figcaption>
</figure>
</div>
</div>
</section>
<section id="comparison-with-ols" class="level3">
<h3 class="anchored" data-anchor-id="comparison-with-ols">4.3 Comparison with OLS</h3>
<p>I think there is no dramatic difference between the OLS and INLA models. However, I believe this is appropriate, as the spatial part does not significantly impact the coefficient, and primarily accounts for the unexplained residuals in the linear regression.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">### INLA</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/ols_model/"</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^.*</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>coef_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  city <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  phe_type <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">3"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  fixed_summary <span class="ot">&lt;-</span> model_data<span class="sc">$</span>fix_effect <span class="sc">%&gt;%</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">city =</span> city, <span class="at">genus =</span> genus, <span class="at">phe_type =</span> phe_type)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(fixed_summary)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>coef_summary_df <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SigAlpha =</span> <span class="fu">ifelse</span>(Sig <span class="sc">==</span> <span class="st">"*"</span>, <span class="dv">1</span>, <span class="fl">0.2</span>),</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>         <span class="at">phe_type =</span> <span class="fu">factor</span>(phe_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)),</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>         <span class="at">city =</span> <span class="fu">factor</span>(city, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"NY"</span>, <span class="st">"DV"</span>, <span class="st">"HT"</span>, <span class="st">"ST"</span>)))</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>coef_summary_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef_summary_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(Factor, <span class="at">levels =</span> <span class="fu">unique</span>(Factor)), <span class="at">y =</span> Estimate, <span class="at">color =</span> city)) <span class="sc">+</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> SigAlpha), <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Lower, <span class="at">ymax =</span> Upper, <span class="at">alpha =</span> SigAlpha), </span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), </span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>                <span class="at">linewidth =</span> <span class="fl">0.5</span>,</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coord_flip() +</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>phe_type, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"NY"</span> <span class="ot">=</span> <span class="st">"darkolivegreen4"</span>, <span class="st">"HT"</span> <span class="ot">=</span> <span class="st">"navyblue"</span>, <span class="st">"DV"</span> <span class="ot">=</span> <span class="st">"chocolate"</span>, <span class="st">"ST"</span> <span class="ot">=</span> <span class="st">"purple"</span>)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>) <span class="sc">+</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(aes(label = Estimate, y = Estimate), vjust = -0.9, show.legend = FALSE, size = 3) +</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">alpha =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>coef_summary_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-city_comp_ols" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-city_comp_ols-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="urban_phenology_update_files/figure-html/fig-city_comp_ols-1.png" class="img-fluid figure-img" width="960">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-city_comp_ols-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;20: The distribution of the posterior of regression coefficients for <code>Temp~avg~</code> on phenology for each genus (Line: 95% CI, point: mean value).
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion-and-next-step" class="level2">
<h2 class="anchored" data-anchor-id="conclusion-and-next-step">5 Conclusion and next step</h2>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<ul>
<li><p>Optimal preseason length for phenology varies among genera.</p></li>
<li><p>Within the city, trees indeed respond to temperature variation, result in phenology variation</p></li>
<li><p>Across cities, some variation patterns noticed.</p></li>
</ul>
</section>
<section id="next-steps" class="level3">
<h3 class="anchored" data-anchor-id="next-steps">Next steps</h3>
<ul>
<li><p><strong>What can the urban phenology heterogenity be used for?</strong> - Goal</p>
<ul>
<li><p>The preview of future warming: compared with the sensitivity in natural environment.</p></li>
<li><p>Fine-scale urban phenology: compared with other urban phenology sensitivity detected at coarser scale.</p></li>
</ul></li>
<li><p>Scale up</p>
<ul>
<li>Cities</li>
<li>Genera</li>
</ul></li>
<li><p>Sensitivity</p>
<ul>
<li>How about use buffer size</li>
</ul></li>
</ul>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb21" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Urban phenology updates - Share on lab meeting"</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Jiali Zhu"</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "today"</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Code"</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 3</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-packages</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zhulabtools)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="fu">load_packages</span>(<span class="fu">c</span>(<span class="st">"dplyr"</span>,<span class="st">"lubridate"</span>, <span class="st">"ggplot2"</span>, <span class="st">"sf"</span>,<span class="st">"sp"</span>, <span class="st">"readr"</span>, <span class="st">"purrr"</span>, <span class="st">"stringr"</span>,<span class="st">"glue"</span>, <span class="st">"tidyr"</span>, <span class="st">"broom"</span>,<span class="st">"lme4"</span>, <span class="st">"knitr"</span>, <span class="st">"broom.mixed"</span>, <span class="st">"ppcor"</span>, <span class="st">"spdep"</span>, <span class="st">"spatialreg"</span>, <span class="st">"lmtest"</span>,<span class="st">"car"</span>, <span class="st">"spBayes"</span>, <span class="st">"coda"</span>, <span class="st">"patchwork"</span>, <span class="st">"performance"</span>, <span class="st">"terra"</span>, <span class="st">"ggpmisc"</span>, <span class="st">"gstat"</span>, <span class="st">"ggmcmc"</span>, <span class="st">"INLA"</span>,<span class="st">"viridis"</span>,<span class="st">"RColorBrewer"</span>))</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="co"># source("~/phenology-urban/script/read_clean_WU.R")</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>select <span class="ot">&lt;-</span> dplyr<span class="sc">::</span>select</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Phenology, the timing of periodic plant life cycle events, is sensitive to biotic and abiotic environment.</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Spatial unevenness of urban thermal environment might lead to the spatial heterogeneity of phenology.</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Negative correlation between the flowering date and the monthly mean LST in February–April.</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>    <span class="al">![Katz et al., 2019](docs/katz_2019.png)</span>{#fig-katz_2019 fig-align="center" width="60%"}</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="in">    -   A significant spatial variation for First flowing date of 35 species, which negatively correlated withdaily LST.</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="in">    ![Xing et al., 2022](docs/xing_2022.png){#fig-xing_2022 fig-align="center" width="60%"}</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Require **phenology records and climate information within city**:</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>As for **phenology**, we need broader data collection to capture a more comprehensive picture of vegetation and further enable city-to-city comparisons.</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="ss">        -   </span>Medium-resolution satellite data might fail to capture the fine-scale variations in tree phenology within the heterogeneous urban landscapes.</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a><span class="ss">        -   </span>Genus / Species information is lost in remote sensing data</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>As for **urban micro-climate**.</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a><span class="ss">        -   </span>Land surface temperature could not accurately represent tree growing environment.</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a><span class="ss">        -   </span>Decoupling between urban microclimates and surrounding free-air conditions.</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a><span class="fu">## Question and Hypothesis</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Question**: What is the spatial heterogeneity of individual tree phenology from the same genus within a city, and across cities located in different climate regions?</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Hypothesis**: The heterogeneous urban landscape amplifies the variation of individual phenology within cities.</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Goal**: *Insights into how vegetation adapts to altered environmental conditions under urbanization and predict future pathways under global warming.*</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a><span class="fu">## 1 Raw data</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1.1 Read and clean the WU data (based on GHCNd)</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>The urban microclimate information comes from the <span class="co">[</span><span class="ot">Weather Underground program</span><span class="co">](https://www.wunderground.com/)</span>. There are 4 raw daily variables selected, i.e. AvgTemp, HighTemp, LowTemp and Precipitation_sum (Sum_mm). I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily <span class="co">[</span><span class="ot">GHCNd</span><span class="co">](https://www.ncei.noaa.gov/products/land-based-station/global-historical-climatology-network-daily)</span>.</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>For initial analysis, I collect the date from 4 cities, i.e. New York, Houston, Detroit, and Seattle.</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-wu_sites</span></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5.5</span></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Number of WU sites in each city"</span></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a><span class="co"># No. of WU sites</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">Category =</span> <span class="fu">c</span>(<span class="st">"DV"</span>, <span class="st">"NY"</span>, <span class="st">"ST"</span>, <span class="st">"HT"</span>),</span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>  <span class="at">Number_of_Sites =</span> <span class="fu">c</span>(<span class="dv">226</span>, <span class="dv">148</span>, <span class="dv">367</span>, <span class="dv">171</span>)</span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> Category, <span class="at">y =</span> Number_of_Sites)) <span class="sc">+</span></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> Number_of_Sites), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Category"</span>, <span class="at">y =</span> <span class="st">"Number of Sites"</span>) <span class="sc">+</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1.2 Shortwave data from Daymet</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>To control for the influence of other variables on phenology, I also incorporated shortwave radiation data derived from the <span class="co">[</span><span class="ot">Daymet daily dataset</span><span class="co">](https://daymet.ornl.gov/)</span> with a 1 km resolution. Shortwave radiation was extracted for the specific locations of the trees.</span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-plot_daymet</span></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The shortwave radiation raster in 2023-01-01, NY"</span></span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a><span class="co"># download</span></span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/raw/"</span>, city, <span class="st">"/Daymet/daily2016-2024/"</span>)</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_dir, <span class="at">pattern =</span> <span class="st">"srad_daily_2023_ncss</span><span class="sc">\\</span><span class="st">.nc$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a>srad_nc <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(file)</span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a>srad_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(srad_nc[[<span class="dv">1</span>]], <span class="at">xy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(srad_df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> srad_1)) <span class="sc">+</span></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"W/m²"</span>) <span class="sc">+</span></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Shortwave Radiation (W/m²) - 2023-01-01"</span>, <span class="at">x =</span> <span class="st">"x"</span>, <span class="at">y =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb21-121"><a href="#cb21-121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-122"><a href="#cb21-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1.3 Select the street tree base on WU data</span></span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a>I used the street tree in the above 4 cities, with the phenology records established by Yiluan. These trees are part of the whole inventory, covering 14 genera and being sampled. I select the trees which are within **500 m** buffer around the Weather Underground sites (see @fig-tree_wu_sites).</span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tree_wu_sites</span></span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a><span class="do">################ For phenology data ################</span></span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>metadata <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"~/lab-data/datasets/vegetation/PS/urban/metadata.csv"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(site <span class="sc">==</span> <span class="sc">!!</span>city)</span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>file_list <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> <span class="st">"~/lab-data/datasets/vegetation/PS/urban/doy"</span>, <span class="at">pattern =</span> <span class="fu">paste0</span>(<span class="st">"^doy_"</span>,city,<span class="st">"_.*</span><span class="sc">\\</span><span class="st">.rds$"</span>), <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> file_list <span class="sc">%&gt;%</span></span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map</span>(<span class="sc">~</span> <span class="fu">readRDS</span>(.x))</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>all_doy <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(data_list)</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>tree_location <span class="ot">&lt;-</span> metadata <span class="sc">%&gt;%</span></span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">genus =</span> <span class="fu">str_extract</span>(taxa, <span class="st">"^[^ ]+"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(all_doy, <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(doy))</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>just_tree_location <span class="ot">&lt;-</span> tree_location <span class="sc">%&gt;%</span></span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id) <span class="sc">%&gt;%</span></span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>wu_location <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>, city, <span class="st">"/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a>wu_buffer <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(wu_location, <span class="at">dist =</span> <span class="dv">500</span>)</span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>intersects <span class="ot">&lt;-</span> <span class="fu">st_intersects</span>(just_tree_location, wu_buffer)</span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>id_buffer <span class="ot">&lt;-</span> just_tree_location <span class="sc">%&gt;%</span></span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">buffer_id =</span> <span class="fu">sapply</span>(intersects, <span class="cf">function</span>(x) <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">==</span> <span class="dv">1</span>) x[<span class="dv">1</span>] <span class="cf">else</span> <span class="cn">NA</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(wu_buffer <span class="sc">%&gt;%</span> <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">buffer_id =</span> <span class="fu">row_number</span>()), <span class="at">by =</span> <span class="st">"buffer_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(buffer_id)) <span class="sc">%&gt;%</span></span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(id, Site) <span class="sc">%&gt;%</span></span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbind</span>(</span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a>    just_tree_location <span class="sc">%&gt;%</span></span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">lengths</span>(intersects) <span class="sc">&gt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a>      <span class="at">Site =</span> {</span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a>        current_row_index <span class="ot">&lt;-</span> <span class="fu">which</span>(just_tree_location<span class="sc">$</span>id <span class="sc">==</span> id)</span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a>        intersected_buffers <span class="ot">&lt;-</span> intersects[[current_row_index]]</span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a>        point_geom <span class="ot">&lt;-</span> geometry</span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a>        buffer_geoms <span class="ot">&lt;-</span> wu_location[intersected_buffers, ]<span class="sc">$</span>geometry</span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a>        distances <span class="ot">&lt;-</span> <span class="fu">st_distance</span>(point_geom, buffer_geoms)</span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a>        nearest_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(distances)</span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a>        wu_buffer<span class="sc">$</span>Site[intersected_buffers[nearest_index]]</span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(id, Site)</span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a>points_in_buffer <span class="ot">&lt;-</span> tree_location <span class="sc">%&gt;%</span></span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(id_buffer, <span class="at">by =</span> <span class="st">"id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Site))</span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a><span class="co"># write_csv(points_in_buffer, paste0("~/phenology-urban/data/proc/urban/", city, "/tree_WU_500_buffer_PS.csv"))</span></span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-tree_wu_sites</span></span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Location of WU sites and trees"</span></span>
<span id="cb21-201"><a href="#cb21-201" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 15</span></span>
<span id="cb21-202"><a href="#cb21-202" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-203"><a href="#cb21-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-204"><a href="#cb21-204" aria-hidden="true" tabindex="-1"></a>cities <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"NY"</span>, <span class="st">"HT"</span>, <span class="st">"DV"</span>, <span class="st">"ST"</span>)</span>
<span id="cb21-205"><a href="#cb21-205" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb21-206"><a href="#cb21-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-207"><a href="#cb21-207" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (city <span class="cf">in</span> cities){</span>
<span id="cb21-208"><a href="#cb21-208" aria-hidden="true" tabindex="-1"></a>  points_in_buffer <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tree_WU_500_buffer_PS.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-209"><a href="#cb21-209" aria-hidden="true" tabindex="-1"></a>  points_in_buffer_sf <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb21-210"><a href="#cb21-210" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb21-211"><a href="#cb21-211" aria-hidden="true" tabindex="-1"></a>  <span class="co"># us_boundary &lt;- st_read("~/urban-niche/data/raw/CONUS/boundary/us_boundarydissolve.shp") %&gt;%</span></span>
<span id="cb21-212"><a href="#cb21-212" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     st_transform(4326)</span></span>
<span id="cb21-213"><a href="#cb21-213" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-214"><a href="#cb21-214" aria-hidden="true" tabindex="-1"></a>  boundary <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb21-215"><a href="#cb21-215" aria-hidden="true" tabindex="-1"></a>    city,</span>
<span id="cb21-216"><a href="#cb21-216" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NY"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-217"><a href="#cb21-217" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb21-218"><a href="#cb21-218" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DT/City_of_Detroit_Boundary/City_of_Detroit_Boundary.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-219"><a href="#cb21-219" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb21-220"><a href="#cb21-220" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ST"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/ST/seattle_boundary/CityUGA.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-221"><a href="#cb21-221" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-222"><a href="#cb21-222" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Seattle"</span>),</span>
<span id="cb21-223"><a href="#cb21-223" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/HT/HGAC_City_Boundaries/HGAC_City_Boundaries.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-224"><a href="#cb21-224" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Houston"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-225"><a href="#cb21-225" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb21-226"><a href="#cb21-226" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TP"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/TP/Municipal_Boundary/Municipal_Boundary.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-227"><a href="#cb21-227" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-228"><a href="#cb21-228" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Tampa"</span>),</span>
<span id="cb21-229"><a href="#cb21-229" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DV"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DV/DRCOG_Municipalities/DRCOG_Municipalities.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-230"><a href="#cb21-230" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(city <span class="sc">==</span> <span class="st">"Denver"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-231"><a href="#cb21-231" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb21-232"><a href="#cb21-232" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/AT/TxDOT_City_Boundaries/Cities.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-233"><a href="#cb21-233" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Austin"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-234"><a href="#cb21-234" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb21-235"><a href="#cb21-235" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Invalid city abbreviation."</span>)</span>
<span id="cb21-236"><a href="#cb21-236" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-237"><a href="#cb21-237" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-238"><a href="#cb21-238" aria-hidden="true" tabindex="-1"></a>  wu_location <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>, city, <span class="st">"/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-239"><a href="#cb21-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb21-240"><a href="#cb21-240" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-241"><a href="#cb21-241" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb21-242"><a href="#cb21-242" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> boundary, <span class="at">fill =</span> <span class="st">"grey90"</span>) <span class="sc">+</span></span>
<span id="cb21-243"><a href="#cb21-243" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_sf(data = us_boundary, color = "blue", size = 1) +</span></span>
<span id="cb21-244"><a href="#cb21-244" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> wu_location, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-245"><a href="#cb21-245" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> points_in_buffer, <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat), <span class="at">color =</span> <span class="st">"red"</span>,<span class="at">size =</span> <span class="fl">0.01</span>, <span class="at">alpha =</span> <span class="fl">0.01</span>) <span class="sc">+</span></span>
<span id="cb21-246"><a href="#cb21-246" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> city) <span class="sc">+</span></span>
<span id="cb21-247"><a href="#cb21-247" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb21-248"><a href="#cb21-248" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb21-249"><a href="#cb21-249" aria-hidden="true" tabindex="-1"></a>  plots[[city]] <span class="ot">=</span> p</span>
<span id="cb21-250"><a href="#cb21-250" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-251"><a href="#cb21-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-252"><a href="#cb21-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-253"><a href="#cb21-253" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb21-254"><a href="#cb21-254" aria-hidden="true" tabindex="-1"></a>combined_plot</span>
<span id="cb21-255"><a href="#cb21-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-256"><a href="#cb21-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-257"><a href="#cb21-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-258"><a href="#cb21-258" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2 Method</span></span>
<span id="cb21-259"><a href="#cb21-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-260"><a href="#cb21-260" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.1 Phenological indicators</span></span>
<span id="cb21-261"><a href="#cb21-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-262"><a href="#cb21-262" aria-hidden="true" tabindex="-1"></a>The tree locations points were overlapped with Planetscope imageries to extract the reflectance values. After smoothing and regression, we could get the EVI curve. The phenological metrics were calculated based on the EVI curve:</span>
<span id="cb21-263"><a href="#cb21-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-264"><a href="#cb21-264" aria-hidden="true" tabindex="-1"></a><span class="al">![Extract reflectance from PlanetScope based on tree location, an example in NY](docs/ps_example.png)</span>{#fig-ps_example  fig-align="center" width="60%"}</span>
<span id="cb21-265"><a href="#cb21-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-266"><a href="#cb21-266" aria-hidden="true" tabindex="-1"></a><span class="al">![Phenology metrics calculated based on EVI curve from PlanetScope](docs/pheno_matrix.png)</span>{#fig-pheno_matrics}</span>
<span id="cb21-267"><a href="#cb21-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-268"><a href="#cb21-268" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span>Spring phenology</span>
<span id="cb21-269"><a href="#cb21-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-270"><a href="#cb21-270" aria-hidden="true" tabindex="-1"></a><span class="ss">    -  </span><span class="in">`SOS`</span>: Defined as the day of year when individual tree growing season EVI curves first cross the green-up 50% threshold.</span>
<span id="cb21-271"><a href="#cb21-271" aria-hidden="true" tabindex="-1"></a><span class="ss">    -  </span><span class="in">`Green-up Pace`</span>: Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-up 20% threshold to the 80% threshold.</span>
<span id="cb21-272"><a href="#cb21-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-273"><a href="#cb21-273" aria-hidden="true" tabindex="-1"></a><span class="ss">-  </span>Fall phenology</span>
<span id="cb21-274"><a href="#cb21-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-275"><a href="#cb21-275" aria-hidden="true" tabindex="-1"></a><span class="ss">    -  </span><span class="in">`EOS`</span>: Defined as the day of year when individual tree growing season EVI curves first cross the green-down 50% threshold.</span>
<span id="cb21-276"><a href="#cb21-276" aria-hidden="true" tabindex="-1"></a><span class="ss">    -  </span><span class="in">`Green-down Pace`</span>: Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-down 20% threshold to the 80% threshold.</span>
<span id="cb21-277"><a href="#cb21-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-278"><a href="#cb21-278" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.2 Optimal preseason length calculated by Temp~avg~</span></span>
<span id="cb21-279"><a href="#cb21-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-280"><a href="#cb21-280" aria-hidden="true" tabindex="-1"></a>Defined as the period (5-180 days, with 5-day steps) before phenological event for which the partial correlation coefficient between mean phenological event date and average temperature was highest, controlling other climate variables. <span class="co">[</span><span class="ot">Meng et al., 2020</span><span class="co">](https://www.pnas.org/doi/10.1073/pnas.1911117117#sec-3)</span>, <span class="co">[</span><span class="ot">Yin et al., 2024</span><span class="co">](https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2023EF004127)</span></span>
<span id="cb21-281"><a href="#cb21-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-282"><a href="#cb21-282" aria-hidden="true" tabindex="-1"></a><span class="al">![Conceptual diagram for optimal preseason](docs/preseason.png)</span>{#fig-preseason_concept}</span>
<span id="cb21-283"><a href="#cb21-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-284"><a href="#cb21-284" aria-hidden="true" tabindex="-1"></a>@fig-partial_preseason displays the distribution of optimal preseason length and partial correlation coefficient calculated by Temp~avg~ for <span class="in">`SOS`</span>, <span class="in">`Greenup pace`</span>, <span class="in">`EOS`</span> and <span class="in">`Greenup pace`</span>, respectively.</span>
<span id="cb21-285"><a href="#cb21-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-286"><a href="#cb21-286" aria-hidden="true" tabindex="-1"></a>Optimal preseason length for spring phenology varies among genera. As for <span class="in">`SOS`</span>, all genera have negetive partial correlation coefficients, which means the higher preseason average temperature, the earlier start of season. As for <span class="in">`Greenup pace`</span>, most genera (except Carya, Celtis) have negetive partial correlation coefficients, which means the higher preseason average temperature, the faster green up pace. The preseason length varies significantly among genera.</span>
<span id="cb21-287"><a href="#cb21-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-288"><a href="#cb21-288" aria-hidden="true" tabindex="-1"></a>Both the optimal preseason length for fall phenology and the response direction vary significantly among genera. As for <span class="in">`EOS`</span>, most genera (except Populus, Platanus) have positive partial correlation coefficients, which means the higher preseason average temperature, the later end of season. As for <span class="in">`Greenup pace`</span>, there is variation in impact direction among genera. The preseason length also varies significantly among genera.</span>
<span id="cb21-289"><a href="#cb21-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-292"><a href="#cb21-292" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-293"><a href="#cb21-293" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-partial_preseason</span></span>
<span id="cb21-294"><a href="#cb21-294" aria-hidden="true" tabindex="-1"></a><span class="co">#| layout-ncol: 1</span></span>
<span id="cb21-295"><a href="#cb21-295" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of partial correlation coefficient and preseason length, calculated by Temp~avg~"</span></span>
<span id="cb21-296"><a href="#cb21-296" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap: </span></span>
<span id="cb21-297"><a href="#cb21-297" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Spring phenology"</span></span>
<span id="cb21-298"><a href="#cb21-298" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Fall phenology"</span></span>
<span id="cb21-299"><a href="#cb21-299" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-300"><a href="#cb21-300" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 13</span></span>
<span id="cb21-301"><a href="#cb21-301" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 6</span></span>
<span id="cb21-302"><a href="#cb21-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-303"><a href="#cb21-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-304"><a href="#cb21-304" aria-hidden="true" tabindex="-1"></a>tavg_allyear_pcorr <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tavg_allyear_pcorr.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-305"><a href="#cb21-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-306"><a href="#cb21-306" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a flag for optimal_pre_length</span></span>
<span id="cb21-307"><a href="#cb21-307" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_optimal =</span> <span class="fu">ifelse</span>(pre_length_candidate <span class="sc">==</span> optimal_pre_length, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb21-308"><a href="#cb21-308" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a flag for significant pvalue</span></span>
<span id="cb21-309"><a href="#cb21-309" aria-hidden="true" tabindex="-1"></a>    <span class="at">is_significant =</span> <span class="fu">ifelse</span>(pvalue_trend <span class="sc">&lt;</span> <span class="fl">0.05</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb21-310"><a href="#cb21-310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust transparency</span></span>
<span id="cb21-311"><a href="#cb21-311" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fu">ifelse</span>(is_optimal, <span class="dv">1</span>, <span class="fl">0.2</span>),</span>
<span id="cb21-312"><a href="#cb21-312" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">ifelse</span>(is_significant, <span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb21-313"><a href="#cb21-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="fu">ifelse</span>(is_optimal, <span class="dv">4</span>, <span class="fl">1.2</span>)</span>
<span id="cb21-314"><a href="#cb21-314" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb21-315"><a href="#cb21-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">shape =</span> <span class="fu">factor</span>(shape, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>)),</span>
<span id="cb21-316"><a href="#cb21-316" aria-hidden="true" tabindex="-1"></a>         <span class="at">size =</span> <span class="fu">factor</span>(size, <span class="at">levels =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="dv">4</span>)))</span>
<span id="cb21-317"><a href="#cb21-317" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-318"><a href="#cb21-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-319"><a href="#cb21-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb21-320"><a href="#cb21-320" aria-hidden="true" tabindex="-1"></a>sos_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"SOS"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb21-321"><a href="#cb21-321" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb21-322"><a href="#cb21-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">shape =</span> shape, <span class="at">size =</span> size)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb21-323"><a href="#cb21-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-324"><a href="#cb21-324" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb21-325"><a href="#cb21-325" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb21-326"><a href="#cb21-326" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb21-327"><a href="#cb21-327" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb21-328"><a href="#cb21-328" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt;= 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb21-329"><a href="#cb21-329" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb21-330"><a href="#cb21-330" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb21-331"><a href="#cb21-331" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb21-332"><a href="#cb21-332" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="dv">4</span>), </span>
<span id="cb21-333"><a href="#cb21-333" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb21-334"><a href="#cb21-334" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-335"><a href="#cb21-335" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb21-336"><a href="#cb21-336" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb21-337"><a href="#cb21-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-338"><a href="#cb21-338" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Start of season"</span>,</span>
<span id="cb21-339"><a href="#cb21-339" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb21-340"><a href="#cb21-340" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb21-341"><a href="#cb21-341" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-342"><a href="#cb21-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb21-343"><a href="#cb21-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb21-344"><a href="#cb21-344" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb21-345"><a href="#cb21-345" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb21-346"><a href="#cb21-346" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb21-347"><a href="#cb21-347" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-348"><a href="#cb21-348" aria-hidden="true" tabindex="-1"></a>greenup_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"green-up pace"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb21-349"><a href="#cb21-349" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb21-350"><a href="#cb21-350" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb21-351"><a href="#cb21-351" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-352"><a href="#cb21-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb21-353"><a href="#cb21-353" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb21-354"><a href="#cb21-354" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb21-355"><a href="#cb21-355" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb21-356"><a href="#cb21-356" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt;= 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb21-357"><a href="#cb21-357" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb21-358"><a href="#cb21-358" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb21-359"><a href="#cb21-359" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb21-360"><a href="#cb21-360" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="dv">4</span>), </span>
<span id="cb21-361"><a href="#cb21-361" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb21-362"><a href="#cb21-362" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-363"><a href="#cb21-363" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb21-364"><a href="#cb21-364" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb21-365"><a href="#cb21-365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-366"><a href="#cb21-366" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Green-up pace"</span>,</span>
<span id="cb21-367"><a href="#cb21-367" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb21-368"><a href="#cb21-368" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb21-369"><a href="#cb21-369" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-370"><a href="#cb21-370" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb21-371"><a href="#cb21-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb21-372"><a href="#cb21-372" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb21-373"><a href="#cb21-373" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb21-374"><a href="#cb21-374" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb21-375"><a href="#cb21-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-376"><a href="#cb21-376" aria-hidden="true" tabindex="-1"></a>eos_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"EOS"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb21-377"><a href="#cb21-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb21-378"><a href="#cb21-378" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb21-379"><a href="#cb21-379" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-380"><a href="#cb21-380" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb21-381"><a href="#cb21-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb21-382"><a href="#cb21-382" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb21-383"><a href="#cb21-383" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb21-384"><a href="#cb21-384" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt;= 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb21-385"><a href="#cb21-385" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb21-386"><a href="#cb21-386" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb21-387"><a href="#cb21-387" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb21-388"><a href="#cb21-388" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="dv">4</span>), </span>
<span id="cb21-389"><a href="#cb21-389" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb21-390"><a href="#cb21-390" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-391"><a href="#cb21-391" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb21-392"><a href="#cb21-392" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb21-393"><a href="#cb21-393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-394"><a href="#cb21-394" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"End of season"</span>,</span>
<span id="cb21-395"><a href="#cb21-395" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb21-396"><a href="#cb21-396" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb21-397"><a href="#cb21-397" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-398"><a href="#cb21-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb21-399"><a href="#cb21-399" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb21-400"><a href="#cb21-400" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb21-401"><a href="#cb21-401" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb21-402"><a href="#cb21-402" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb21-403"><a href="#cb21-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-404"><a href="#cb21-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-405"><a href="#cb21-405" aria-hidden="true" tabindex="-1"></a>greendown_p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>((tavg_allyear_pcorr <span class="sc">%&gt;%</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"green-down pace"</span>)), <span class="fu">aes</span>(<span class="at">x =</span> pre_length_candidate, <span class="at">y =</span> pre_length_trend, <span class="at">color =</span> genus, <span class="at">fill =</span> genus, <span class="at">group =</span> genus)) <span class="sc">+</span></span>
<span id="cb21-406"><a href="#cb21-406" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> <span class="fl">0.1</span>)) <span class="sc">+</span>  <span class="co"># Add lines for trends</span></span>
<span id="cb21-407"><a href="#cb21-407" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> alpha, <span class="at">size =</span> size, <span class="at">shape =</span> shape)) <span class="sc">+</span>  <span class="co"># Add points with alpha and fill</span></span>
<span id="cb21-408"><a href="#cb21-408" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-409"><a href="#cb21-409" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span>  <span class="co"># Use the alpha values directly</span></span>
<span id="cb21-410"><a href="#cb21-410" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_shape_manual</span>(</span>
<span id="cb21-411"><a href="#cb21-411" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Significance"</span>, </span>
<span id="cb21-412"><a href="#cb21-412" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">1</span>),</span>
<span id="cb21-413"><a href="#cb21-413" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"p &lt;= 0.05"</span>, <span class="st">"p &gt; 0.05"</span>)   </span>
<span id="cb21-414"><a href="#cb21-414" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb21-415"><a href="#cb21-415" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(</span>
<span id="cb21-416"><a href="#cb21-416" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Pre-season length"</span>,  </span>
<span id="cb21-417"><a href="#cb21-417" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="dv">4</span>), </span>
<span id="cb21-418"><a href="#cb21-418" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Others"</span>, <span class="st">"Optimal preseason length"</span>)</span>
<span id="cb21-419"><a href="#cb21-419" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-420"><a href="#cb21-420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(</span>
<span id="cb21-421"><a href="#cb21-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">shape =</span> <span class="fu">guide_legend</span>(<span class="at">override.aes =</span> <span class="fu">list</span>(<span class="at">fill =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="cn">NA</span>),<span class="at">color =</span> <span class="st">"black"</span>)))<span class="sc">+</span></span>
<span id="cb21-422"><a href="#cb21-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-423"><a href="#cb21-423" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Green-down pace"</span>,</span>
<span id="cb21-424"><a href="#cb21-424" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Pre-season length"</span>,</span>
<span id="cb21-425"><a href="#cb21-425" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Partial correlation coefficient"</span></span>
<span id="cb21-426"><a href="#cb21-426" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-427"><a href="#cb21-427" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb21-428"><a href="#cb21-428" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb21-429"><a href="#cb21-429" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>), </span>
<span id="cb21-430"><a href="#cb21-430" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb21-431"><a href="#cb21-431" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>))</span>
<span id="cb21-432"><a href="#cb21-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-433"><a href="#cb21-433" aria-hidden="true" tabindex="-1"></a>sos_p <span class="sc">+</span> greenup_p <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb21-434"><a href="#cb21-434" aria-hidden="true" tabindex="-1"></a>eos_p <span class="sc">+</span> greendown_p <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>) <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb21-435"><a href="#cb21-435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-436"><a href="#cb21-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-437"><a href="#cb21-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-438"><a href="#cb21-438" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.3 Brief summary of the data</span></span>
<span id="cb21-439"><a href="#cb21-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-440"><a href="#cb21-440" aria-hidden="true" tabindex="-1"></a>So far, we have collected the phenology records and preseason climate information. The overall data variation is shown as below:</span>
<span id="cb21-441"><a href="#cb21-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-444"><a href="#cb21-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-445"><a href="#cb21-445" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data_summary</span></span>
<span id="cb21-446"><a href="#cb21-446" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The variation range of phenology (e.g., `SOS`) and preseason temperature (`AvgTemp`) in different cities"</span></span>
<span id="cb21-447"><a href="#cb21-447" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-448"><a href="#cb21-448" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb21-449"><a href="#cb21-449" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb21-450"><a href="#cb21-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-451"><a href="#cb21-451" aria-hidden="true" tabindex="-1"></a>fixed_genera <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Acer"</span>, <span class="st">"Alnus"</span>, <span class="st">"Betula"</span>, <span class="st">"Carya"</span>, <span class="st">"Celtis"</span>, <span class="st">"Fraxinus"</span>, </span>
<span id="cb21-452"><a href="#cb21-452" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Juglans"</span>, <span class="st">"Liquidambar"</span>, <span class="st">"Morus"</span>, <span class="st">"Platanus"</span>, <span class="st">"Populus"</span>, </span>
<span id="cb21-453"><a href="#cb21-453" aria-hidden="true" tabindex="-1"></a>                  <span class="st">"Quercus"</span>, <span class="st">"Salix"</span>, <span class="st">"Ulmus"</span>)</span>
<span id="cb21-454"><a href="#cb21-454" aria-hidden="true" tabindex="-1"></a>color_palette <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="fu">viridis</span>(<span class="fu">length</span>(fixed_genera)), fixed_genera)</span>
<span id="cb21-455"><a href="#cb21-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-456"><a href="#cb21-456" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">map</span>(cities, <span class="cf">function</span>(city){</span>
<span id="cb21-457"><a href="#cb21-457" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>, city, <span class="st">"/tavg_allyear_var.rds"</span>))</span>
<span id="cb21-458"><a href="#cb21-458" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-459"><a href="#cb21-459" aria-hidden="true" tabindex="-1"></a>  phe_type <span class="ot">=</span> <span class="st">"SOS"</span></span>
<span id="cb21-460"><a href="#cb21-460" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"SOS"</span>) {</span>
<span id="cb21-461"><a href="#cb21-461" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb21-462"><a href="#cb21-462" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb21-463"><a href="#cb21-463" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb21-464"><a href="#cb21-464" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"EOS"</span>) {</span>
<span id="cb21-465"><a href="#cb21-465" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb21-466"><a href="#cb21-466" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb21-467"><a href="#cb21-467" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb21-468"><a href="#cb21-468" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"GreenUp"</span>) {</span>
<span id="cb21-469"><a href="#cb21-469" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb21-470"><a href="#cb21-470" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb21-471"><a href="#cb21-471" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb21-472"><a href="#cb21-472" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb21-473"><a href="#cb21-473" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb21-474"><a href="#cb21-474" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb21-475"><a href="#cb21-475" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb21-476"><a href="#cb21-476" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb21-477"><a href="#cb21-477" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb21-478"><a href="#cb21-478" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-479"><a href="#cb21-479" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-480"><a href="#cb21-480" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb21-481"><a href="#cb21-481" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="sc">!!</span>thres) <span class="sc">%&gt;%</span></span>
<span id="cb21-482"><a href="#cb21-482" aria-hidden="true" tabindex="-1"></a>      <span class="fu">na.omit</span>()</span>
<span id="cb21-483"><a href="#cb21-483" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-484"><a href="#cb21-484" aria-hidden="true" tabindex="-1"></a>  doy_temp_summary <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb21-485"><a href="#cb21-485" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(genus) <span class="sc">%&gt;%</span></span>
<span id="cb21-486"><a href="#cb21-486" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb21-487"><a href="#cb21-487" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_doy =</span> <span class="fu">mean</span>(doy, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-488"><a href="#cb21-488" aria-hidden="true" tabindex="-1"></a>      <span class="at">IQR_d =</span> <span class="fu">quantile</span>(doy, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">quantile</span>(doy, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-489"><a href="#cb21-489" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower_whisker_d =</span> <span class="fu">max</span>(<span class="fu">quantile</span>(doy, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> IQR_d, <span class="fu">min</span>(doy, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb21-490"><a href="#cb21-490" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper_whisker_d =</span> <span class="fu">min</span>(<span class="fu">quantile</span>(doy, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> IQR_d, <span class="fu">max</span>(doy, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb21-491"><a href="#cb21-491" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_temp =</span> <span class="fu">mean</span>(AvgTemp_mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-492"><a href="#cb21-492" aria-hidden="true" tabindex="-1"></a>      <span class="at">IQR_t =</span> <span class="fu">quantile</span>(AvgTemp_mean, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">quantile</span>(AvgTemp_mean, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-493"><a href="#cb21-493" aria-hidden="true" tabindex="-1"></a>      <span class="at">lower_whisker_t =</span> <span class="fu">max</span>(<span class="fu">quantile</span>(AvgTemp_mean, <span class="fl">0.25</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fl">1.5</span> <span class="sc">*</span> IQR_t, <span class="fu">min</span>(AvgTemp_mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb21-494"><a href="#cb21-494" aria-hidden="true" tabindex="-1"></a>      <span class="at">upper_whisker_t =</span> <span class="fu">min</span>(<span class="fu">quantile</span>(AvgTemp_mean, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fl">1.5</span> <span class="sc">*</span> IQR_t, <span class="fu">max</span>(AvgTemp_mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb21-495"><a href="#cb21-495" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-496"><a href="#cb21-496" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-497"><a href="#cb21-497" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(doy_temp_summary, <span class="fu">aes</span>(<span class="at">x =</span> mean_temp, <span class="at">y =</span> mean_doy, <span class="at">color =</span> genus)) <span class="sc">+</span></span>
<span id="cb21-498"><a href="#cb21-498" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb21-499"><a href="#cb21-499" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower_whisker_d, <span class="at">ymax =</span> upper_whisker_d), <span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-500"><a href="#cb21-500" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbarh</span>(<span class="fu">aes</span>(<span class="at">xmin =</span> lower_whisker_t, <span class="at">xmax =</span> upper_whisker_t), <span class="at">height =</span> <span class="dv">1</span>, <span class="at">linewidth =</span> <span class="dv">1</span>,  <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-501"><a href="#cb21-501" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> color_palette) <span class="sc">+</span> </span>
<span id="cb21-502"><a href="#cb21-502" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Average preseason temperature"</span>, <span class="at">y =</span> <span class="st">"SOS"</span>, <span class="at">title =</span> city) <span class="sc">+</span></span>
<span id="cb21-503"><a href="#cb21-503" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb21-504"><a href="#cb21-504" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb21-505"><a href="#cb21-505" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb21-506"><a href="#cb21-506" aria-hidden="true" tabindex="-1"></a>          <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb21-507"><a href="#cb21-507" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb21-508"><a href="#cb21-508" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb21-509"><a href="#cb21-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-510"><a href="#cb21-510" aria-hidden="true" tabindex="-1"></a><span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">plot_layout</span>(<span class="at">guides =</span> <span class="st">"collect"</span>)  <span class="sc">&amp;</span> </span>
<span id="cb21-511"><a href="#cb21-511" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>)</span>
<span id="cb21-512"><a href="#cb21-512" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-513"><a href="#cb21-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-514"><a href="#cb21-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-515"><a href="#cb21-515" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.4 Spatial model</span></span>
<span id="cb21-516"><a href="#cb21-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-517"><a href="#cb21-517" aria-hidden="true" tabindex="-1"></a>I modeled the relationship between the phenology and environmental covariates using a spatial hierarchical model. The response variable (phenology parameter) at location $\mathbf{s}_i$ and in year $\mathbf{t}$, denoted as $y(\mathbf{s}_i, \mathbf{t})$, was modeled as following model:</span>
<span id="cb21-518"><a href="#cb21-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-519"><a href="#cb21-519" aria-hidden="true" tabindex="-1"></a>**Model: (current use)**</span>
<span id="cb21-520"><a href="#cb21-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-521"><a href="#cb21-521" aria-hidden="true" tabindex="-1"></a>$$y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w(\mathbf{s}_i) + u(\mathbf{t}) + \epsilon(\mathbf{s}_i, \mathbf{t})$$</span>
<span id="cb21-522"><a href="#cb21-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-523"><a href="#cb21-523" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb21-524"><a href="#cb21-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-525"><a href="#cb21-525" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Fixed Effects*: $$\mu(\mathbf{s}_i,\mathbf{t}) = \mathbf{X}_{\mathbf{s}_i,\mathbf{t}} \boldsymbol{\beta}$$</span>
<span id="cb21-526"><a href="#cb21-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-527"><a href="#cb21-527" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\mathbf{X}_{\mathbf{s}_i,\mathbf{t}} = [1, \text{AvgTemp}_{\mathbf{s}_i,\mathbf{t}}, \text{Precp}_{\mathbf{s}_i,\mathbf{t}}, \text{srad}_{\mathbf{s}_i,\mathbf{t}}]$ is the design matrix of predictors.</span>
<span id="cb21-528"><a href="#cb21-528" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\boldsymbol{\beta} = <span class="co">[</span><span class="ot">\beta_0, \beta_1, \beta_2, \beta_3</span><span class="co">]</span>$ are the regression coefficients for the intercept and covariates.</span>
<span id="cb21-529"><a href="#cb21-529" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\beta_1$ is the coefficient for the average temperature, which is the main interest in this study.</span>
<span id="cb21-530"><a href="#cb21-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-531"><a href="#cb21-531" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Spatially Correlated Random Effect*: $$w(\mathbf{s}_i) \sim \text{MVN}(\mathbf{0}, \mathbf{R})$$</span>
<span id="cb21-532"><a href="#cb21-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-533"><a href="#cb21-533" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\mathbf{R}$ is the spatial correlation matrix defined by a covariance function.</span>
<span id="cb21-534"><a href="#cb21-534" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-535"><a href="#cb21-535" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>In MCMC, I chose the optimal covariance function based on the variogram fitting:</span>
<span id="cb21-536"><a href="#cb21-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-537"><a href="#cb21-537" aria-hidden="true" tabindex="-1"></a><span class="ss">        -   </span>Matérn Covariance Function (if selected): $$\mathbf{R}_{ij} = \sigma^2 \cdot \frac{2^{1-\nu}}{\Gamma(\nu)} \left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)^\nu K_\nu\left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)$$</span>
<span id="cb21-538"><a href="#cb21-538" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-539"><a href="#cb21-539" aria-hidden="true" tabindex="-1"></a><span class="ss">        -   </span>Exponential Covariance Function (if selected): $$\mathbf{R}_{ij} = \sigma^2 \cdot \exp(-\phi D_{ij})$$</span>
<span id="cb21-540"><a href="#cb21-540" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-541"><a href="#cb21-541" aria-hidden="true" tabindex="-1"></a><span class="ss">        -   </span>Gaussian Covariance Function (if selected): $$\mathbf{R}_{ij} = \sigma^2 \cdot \exp(-\phi D_{ij}^2)$$</span>
<span id="cb21-542"><a href="#cb21-542" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-543"><a href="#cb21-543" aria-hidden="true" tabindex="-1"></a><span class="ss">        -   </span>Spherical Covariance Function (if selected):</span>
<span id="cb21-544"><a href="#cb21-544" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-545"><a href="#cb21-545" aria-hidden="true" tabindex="-1"></a>        $$\mathbf{R}_{ij} =</span>
<span id="cb21-546"><a href="#cb21-546" aria-hidden="true" tabindex="-1"></a>                \begin{cases}</span>
<span id="cb21-547"><a href="#cb21-547" aria-hidden="true" tabindex="-1"></a>                \sigma^2 \cdot \left(1 - \frac{3 D_{ij}}{2\rho} + \frac{D_{ij}^3}{2\rho ^3}\right), &amp; D_{ij} \leq \rho <span class="sc">\\</span></span>
<span id="cb21-548"><a href="#cb21-548" aria-hidden="true" tabindex="-1"></a>                0, &amp; D_{ij} &gt; \rho</span>
<span id="cb21-549"><a href="#cb21-549" aria-hidden="true" tabindex="-1"></a>                \end{cases}$$</span>
<span id="cb21-550"><a href="#cb21-550" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb21-551"><a href="#cb21-551" aria-hidden="true" tabindex="-1"></a><span class="in">    -   In INLA, a spatial process with a Matérn covariance can be obtained as the weak solution to a stochastic partial differential equation (SPDE). The SPDE method uses the Finite Element Method (FEM) to approximate a spatial Gaussian Random Field (GRF). It constructs a triangulated mesh, where each node serves as a basis for interpolation. Basis functions are defined to be 1 at a node and decay to 0 at neighboring triangles, ensuring local influence. By discretizing the SPDE, the problem transforms into a sparse Gaussian Markov Random Field (GMRF), making computations more efficient for large spatial datasets.</span></span>
<span id="cb21-552"><a href="#cb21-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-553"><a href="#cb21-553" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Year-specific Random Effect*: $$u(\mathbf{t}) \sim \text{N}(0, \tau^2_{\mathbf{t}})$$</span>
<span id="cb21-554"><a href="#cb21-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-555"><a href="#cb21-555" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$u_{\mathbf{t}}$ captures year-to-year variability, with $\tau^2_{\mathbf{t}}$ being the variance of the year effect.</span>
<span id="cb21-556"><a href="#cb21-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-557"><a href="#cb21-557" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Independent Nugget Effect*: $$\epsilon(\mathbf{s}_i) \sim \text{N}(0, \tau^2)$$</span>
<span id="cb21-558"><a href="#cb21-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-559"><a href="#cb21-559" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\epsilon(\mathbf{s}_i, \mathbf{t})$ accounts for measurement error or small-scale variability.</span>
<span id="cb21-560"><a href="#cb21-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-561"><a href="#cb21-561" aria-hidden="true" tabindex="-1"></a>**Get the posterior distribution of model parameters**:</span>
<span id="cb21-562"><a href="#cb21-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-563"><a href="#cb21-563" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**MCMC**: In <span class="in">`NIMBLE`</span> package, the MCMC algorithm was used to sample from the posterior distribution of the model parameters.</span>
<span id="cb21-564"><a href="#cb21-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-565"><a href="#cb21-565" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**INLA**: In <span class="in">`INLA`</span> package, the Integrated Nested Laplace Approximation (INLA) was used to approximate the posterior distribution of the model parameters. Rather than estimating the joint posterior distribution of the parameters via MCMC, INLA focusing on individual posterior marginals of the model parameters, which is enough to make inference of the model parameters and latent effects in most cases.</span>
<span id="cb21-566"><a href="#cb21-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-567"><a href="#cb21-567" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3 Results</span></span>
<span id="cb21-568"><a href="#cb21-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-569"><a href="#cb21-569" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.1 SOS in NYC</span></span>
<span id="cb21-570"><a href="#cb21-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-571"><a href="#cb21-571" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 3.1.1 MCMC</span></span>
<span id="cb21-572"><a href="#cb21-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-573"><a href="#cb21-573" aria-hidden="true" tabindex="-1"></a>Code example:</span>
<span id="cb21-574"><a href="#cb21-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-577"><a href="#cb21-577" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-578"><a href="#cb21-578" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mcmc_code</span></span>
<span id="cb21-579"><a href="#cb21-579" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-580"><a href="#cb21-580" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-581"><a href="#cb21-581" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb21-582"><a href="#cb21-582" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-583"><a href="#cb21-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-584"><a href="#cb21-584" aria-hidden="true" tabindex="-1"></a>  <span class="do">#################### Model Specification ####################</span></span>
<span id="cb21-585"><a href="#cb21-585" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-586"><a href="#cb21-586" aria-hidden="true" tabindex="-1"></a>model_code <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb21-587"><a href="#cb21-587" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb21-588"><a href="#cb21-588" aria-hidden="true" tabindex="-1"></a>      y[i] <span class="sc">~</span> <span class="fu">dnorm</span>(mu[i], tau)</span>
<span id="cb21-589"><a href="#cb21-589" aria-hidden="true" tabindex="-1"></a>      mu[i] <span class="ot">&lt;-</span> <span class="fu">inprod</span>(X[i, <span class="dv">1</span><span class="sc">:</span>P], beta[]) <span class="sc">+</span> spatial_effect[i] <span class="sc">+</span> year_effect[year[i]]</span>
<span id="cb21-590"><a href="#cb21-590" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-591"><a href="#cb21-591" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (q <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nyears) {</span>
<span id="cb21-592"><a href="#cb21-592" aria-hidden="true" tabindex="-1"></a>      year_effect[q] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">sqrt</span>(tau.year))</span>
<span id="cb21-593"><a href="#cb21-593" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-594"><a href="#cb21-594" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>P) {</span>
<span id="cb21-595"><a href="#cb21-595" aria-hidden="true" tabindex="-1"></a>      beta[j] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1000</span>)</span>
<span id="cb21-596"><a href="#cb21-596" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-597"><a href="#cb21-597" aria-hidden="true" tabindex="-1"></a>    spatial_effect[<span class="dv">1</span><span class="sc">:</span>N] <span class="sc">~</span> <span class="fu">dmnorm</span>(Mu[<span class="dv">1</span><span class="sc">:</span>N], <span class="at">cov =</span> cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N])</span>
<span id="cb21-598"><a href="#cb21-598" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-599"><a href="#cb21-599" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Choose the covariance function based on variogram fitting</span></span>
<span id="cb21-600"><a href="#cb21-600" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (N_knots <span class="sc">&lt;=</span> N_unique){</span>
<span id="cb21-601"><a href="#cb21-601" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Mat"</span>) {</span>
<span id="cb21-602"><a href="#cb21-602" aria-hidden="true" tabindex="-1"></a>        knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> <span class="fu">matern_covariance</span>(knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots], range, sigma.sq, nu) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]</span>
<span id="cb21-603"><a href="#cb21-603" aria-hidden="true" tabindex="-1"></a>        data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> <span class="fu">matern_covariance</span>(data_knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots], range, sigma.sq, nu)</span>
<span id="cb21-604"><a href="#cb21-604" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Gau"</span>) {</span>
<span id="cb21-605"><a href="#cb21-605" aria-hidden="true" tabindex="-1"></a>        knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]</span>
<span id="cb21-606"><a href="#cb21-606" aria-hidden="true" tabindex="-1"></a>        data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> data_knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots]<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb21-607"><a href="#cb21-607" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Exp"</span>) {</span>
<span id="cb21-608"><a href="#cb21-608" aria-hidden="true" tabindex="-1"></a>        knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]</span>
<span id="cb21-609"><a href="#cb21-609" aria-hidden="true" tabindex="-1"></a>        data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> data_knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots])</span>
<span id="cb21-610"><a href="#cb21-610" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Sph"</span>) {</span>
<span id="cb21-611"><a href="#cb21-611" aria-hidden="true" tabindex="-1"></a>        knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots], range, sigma.sq) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]</span>
<span id="cb21-612"><a href="#cb21-612" aria-hidden="true" tabindex="-1"></a>        data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(data_knots_dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots], range, sigma.sq)</span>
<span id="cb21-613"><a href="#cb21-613" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-614"><a href="#cb21-614" aria-hidden="true" tabindex="-1"></a>      knots_cov_chol_inv[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="ot">&lt;-</span> <span class="fu">inverse</span>(<span class="fu">chol</span>(knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]))</span>
<span id="cb21-615"><a href="#cb21-615" aria-hidden="true" tabindex="-1"></a>      cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="sc">%*%</span> </span>
<span id="cb21-616"><a href="#cb21-616" aria-hidden="true" tabindex="-1"></a>        knots_cov_chol_inv[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots] <span class="sc">%*%</span> <span class="fu">t</span>(knots_cov_chol_inv[<span class="dv">1</span><span class="sc">:</span>N_knots, <span class="dv">1</span><span class="sc">:</span>N_knots]) <span class="sc">%*%</span> </span>
<span id="cb21-617"><a href="#cb21-617" aria-hidden="true" tabindex="-1"></a>        <span class="fu">t</span>(data_knots_cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N_knots]) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]</span>
<span id="cb21-618"><a href="#cb21-618" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb21-619"><a href="#cb21-619" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Mat"</span>) {</span>
<span id="cb21-620"><a href="#cb21-620" aria-hidden="true" tabindex="-1"></a>        cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span>  <span class="fu">matern_covariance</span>(dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N], range, sigma.sq, nu) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]</span>
<span id="cb21-621"><a href="#cb21-621" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Gau"</span>) {</span>
<span id="cb21-622"><a href="#cb21-622" aria-hidden="true" tabindex="-1"></a>        cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]<span class="sc">^</span><span class="dv">2</span>) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]</span>
<span id="cb21-623"><a href="#cb21-623" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Exp"</span>) {</span>
<span id="cb21-624"><a href="#cb21-624" aria-hidden="true" tabindex="-1"></a>        cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]</span>
<span id="cb21-625"><a href="#cb21-625" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Sph"</span>) {</span>
<span id="cb21-626"><a href="#cb21-626" aria-hidden="true" tabindex="-1"></a>        cov_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N] <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(dist_matrix[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N], range, sigma.sq) <span class="sc">+</span> I[<span class="dv">1</span><span class="sc">:</span>N, <span class="dv">1</span><span class="sc">:</span>N]</span>
<span id="cb21-627"><a href="#cb21-627" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-628"><a href="#cb21-628" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-629"><a href="#cb21-629" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-630"><a href="#cb21-630" aria-hidden="true" tabindex="-1"></a>    <span class="do">### Priors</span></span>
<span id="cb21-631"><a href="#cb21-631" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-632"><a href="#cb21-632" aria-hidden="true" tabindex="-1"></a>    tau <span class="sc">~</span> <span class="fu">dgamma</span>(<span class="fl">0.001</span>, <span class="fl">0.001</span>)</span>
<span id="cb21-633"><a href="#cb21-633" aria-hidden="true" tabindex="-1"></a>    sigma.sq <span class="sc">~</span> <span class="fu">dinvgamma</span>(<span class="fl">2.5</span>, <span class="dv">120</span>)</span>
<span id="cb21-634"><a href="#cb21-634" aria-hidden="true" tabindex="-1"></a>    phi <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">5</span> <span class="sc">/</span> <span class="dv">1</span>, <span class="dv">5</span> <span class="sc">/</span> <span class="fl">0.1</span>)</span>
<span id="cb21-635"><a href="#cb21-635" aria-hidden="true" tabindex="-1"></a>    tau.year <span class="sc">~</span> <span class="fu">dinvgamma</span>(<span class="fl">2.001</span>, <span class="fl">0.667</span>)</span>
<span id="cb21-636"><a href="#cb21-636" aria-hidden="true" tabindex="-1"></a>    range <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb21-637"><a href="#cb21-637" aria-hidden="true" tabindex="-1"></a>    nu <span class="sc">~</span> <span class="fu">dunif</span>(<span class="fl">0.5</span>, <span class="dv">5</span>)</span>
<span id="cb21-638"><a href="#cb21-638" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb21-639"><a href="#cb21-639" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-640"><a href="#cb21-640" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Data inputs</span></span>
<span id="cb21-641"><a href="#cb21-641" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-642"><a href="#cb21-642" aria-hidden="true" tabindex="-1"></a>  nyears <span class="ot">&lt;-</span> <span class="fu">length</span>(<span class="fu">unique</span>(tavg_phe_df<span class="sc">$</span>year))</span>
<span id="cb21-643"><a href="#cb21-643" aria-hidden="true" tabindex="-1"></a>  X <span class="ot">&lt;-</span> <span class="fu">model.matrix</span>(sp_formula, <span class="at">data =</span> tavg_phe_df)</span>
<span id="cb21-644"><a href="#cb21-644" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> tavg_phe_df[[<span class="fu">all.vars</span>(sp_formula)[<span class="dv">1</span>]]]</span>
<span id="cb21-645"><a href="#cb21-645" aria-hidden="true" tabindex="-1"></a>  year_index <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">factor</span>(tavg_phe_df<span class="sc">$</span>year))  <span class="co"># Create fixed year indices</span></span>
<span id="cb21-646"><a href="#cb21-646" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y, <span class="at">X =</span> X)  <span class="co"># Remove 'year' from data</span></span>
<span id="cb21-647"><a href="#cb21-647" aria-hidden="true" tabindex="-1"></a>  inits <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb21-648"><a href="#cb21-648" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">ncol</span>(X)),</span>
<span id="cb21-649"><a href="#cb21-649" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau =</span> <span class="dv">1</span>, <span class="at">sigma.sq =</span> <span class="dv">80</span>, <span class="at">phi =</span> <span class="dv">25</span>, <span class="at">tau.year =</span> <span class="dv">1</span>,</span>
<span id="cb21-650"><a href="#cb21-650" aria-hidden="true" tabindex="-1"></a>    <span class="at">range =</span> <span class="fl">0.5</span>,</span>
<span id="cb21-651"><a href="#cb21-651" aria-hidden="true" tabindex="-1"></a>    <span class="at">spatial_effect =</span> <span class="fu">rep</span>(<span class="dv">0</span>, N), </span>
<span id="cb21-652"><a href="#cb21-652" aria-hidden="true" tabindex="-1"></a>    <span class="at">nu =</span> <span class="dv">1</span>,</span>
<span id="cb21-653"><a href="#cb21-653" aria-hidden="true" tabindex="-1"></a>    <span class="at">year_effect =</span> <span class="fu">rep</span>(<span class="dv">0</span>, nyears)</span>
<span id="cb21-654"><a href="#cb21-654" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-655"><a href="#cb21-655" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-656"><a href="#cb21-656" aria-hidden="true" tabindex="-1"></a>  <span class="do">### Change based on semi-variogram fitting</span></span>
<span id="cb21-657"><a href="#cb21-657" aria-hidden="true" tabindex="-1"></a>  constants <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> N, <span class="at">N_knots =</span> N_knots, <span class="at">N_unique =</span> N_unique, <span class="at">P =</span> <span class="fu">ncol</span>(X), <span class="at">Mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, N), <span class="at">nyears =</span> nyears, </span>
<span id="cb21-658"><a href="#cb21-658" aria-hidden="true" tabindex="-1"></a>                    <span class="at">dist_matrix =</span> dist_matrix, <span class="at">knots_dist_matrix =</span> knots_dist_matrix, </span>
<span id="cb21-659"><a href="#cb21-659" aria-hidden="true" tabindex="-1"></a>                    <span class="at">data_knots_dist_matrix =</span> data_knots_dist_matrix,</span>
<span id="cb21-660"><a href="#cb21-660" aria-hidden="true" tabindex="-1"></a>                    <span class="at">year =</span> year_index, <span class="at">I =</span> <span class="fu">diag</span>(<span class="fl">1e-6</span>,N), <span class="at">cov_type =</span> cov_type)  <span class="co"># Add 'year' to constants</span></span>
<span id="cb21-661"><a href="#cb21-661" aria-hidden="true" tabindex="-1"></a>  monitors <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb21-662"><a href="#cb21-662" aria-hidden="true" tabindex="-1"></a>    cov_type,</span>
<span id="cb21-663"><a href="#cb21-663" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mat"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"tau.year"</span>, <span class="st">"range"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"nu"</span>, <span class="st">"spatial_effect"</span>, <span class="st">"year_effect"</span>),</span>
<span id="cb21-664"><a href="#cb21-664" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Gau"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"tau"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"phi"</span>, <span class="st">"tau.year"</span>, <span class="st">"spatial_effect"</span>, <span class="st">"year_effect"</span>),</span>
<span id="cb21-665"><a href="#cb21-665" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Exp"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"tau"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"phi"</span>, <span class="st">"tau.year"</span>, <span class="st">"spatial_effect"</span>, <span class="st">"year_effect"</span>),</span>
<span id="cb21-666"><a href="#cb21-666" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sph"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"beta"</span>, <span class="st">"tau.year"</span>, <span class="st">"range"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"spatial_effect"</span>, <span class="st">"year_effect"</span>),</span>
<span id="cb21-667"><a href="#cb21-667" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Unknown cov_type!"</span>)</span>
<span id="cb21-668"><a href="#cb21-668" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-669"><a href="#cb21-669" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-670"><a href="#cb21-670" aria-hidden="true" tabindex="-1"></a>  ni <span class="ot">&lt;-</span> <span class="dv">10000</span>   <span class="co"># nb iterations </span></span>
<span id="cb21-671"><a href="#cb21-671" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> <span class="dv">50</span>       <span class="co"># thinning interval</span></span>
<span id="cb21-672"><a href="#cb21-672" aria-hidden="true" tabindex="-1"></a>  nb <span class="ot">&lt;-</span> ni <span class="sc">/</span> <span class="dv">2</span>    <span class="co"># nb iterations as burn-in </span></span>
<span id="cb21-673"><a href="#cb21-673" aria-hidden="true" tabindex="-1"></a>  nc <span class="ot">&lt;-</span> <span class="dv">1</span>         <span class="co"># nb chains</span></span>
<span id="cb21-674"><a href="#cb21-674" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-675"><a href="#cb21-675" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-676"><a href="#cb21-676" aria-hidden="true" tabindex="-1"></a>  <span class="do">#################### Run/Save the model ####################</span></span>
<span id="cb21-677"><a href="#cb21-677" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-678"><a href="#cb21-678" aria-hidden="true" tabindex="-1"></a>  modelMCMCrun <span class="ot">&lt;-</span> <span class="fu">nimbleMCMC</span>(<span class="at">code =</span> model_code, <span class="at">data =</span> data, <span class="at">constants =</span> constants, <span class="at">inits =</span> inits, </span>
<span id="cb21-679"><a href="#cb21-679" aria-hidden="true" tabindex="-1"></a>                             <span class="at">monitors =</span> monitors,</span>
<span id="cb21-680"><a href="#cb21-680" aria-hidden="true" tabindex="-1"></a>                             <span class="at">niter =</span> ni, <span class="at">nburnin =</span> nb, <span class="at">thin =</span> nt, <span class="at">nchains =</span> nc, <span class="at">setSeed =</span> <span class="dv">2025</span>,</span>
<span id="cb21-681"><a href="#cb21-681" aria-hidden="true" tabindex="-1"></a>                             <span class="at">progressBar =</span> <span class="cn">TRUE</span>, </span>
<span id="cb21-682"><a href="#cb21-682" aria-hidden="true" tabindex="-1"></a>                             <span class="at">samplesAsCodaMCMC =</span> <span class="cn">TRUE</span>, </span>
<span id="cb21-683"><a href="#cb21-683" aria-hidden="true" tabindex="-1"></a>                             <span class="at">summary =</span> <span class="cn">TRUE</span>, </span>
<span id="cb21-684"><a href="#cb21-684" aria-hidden="true" tabindex="-1"></a>                             <span class="at">WAIC =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-685"><a href="#cb21-685" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-686"><a href="#cb21-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-687"><a href="#cb21-687" aria-hidden="true" tabindex="-1"></a>Most genera showed negative association between temperature and the start of season, suggesting the warmer preseason, the earilier start of season. Only Fraxinus had a positive association, with a median coefficient of 0.15. There are significant genus-level differences in how temperature influences the spring phenology.</span>
<span id="cb21-688"><a href="#cb21-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-691"><a href="#cb21-691" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-692"><a href="#cb21-692" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_sos_tavg_mcmc_coef</span></span>
<span id="cb21-693"><a href="#cb21-693" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-694"><a href="#cb21-694" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb21-695"><a href="#cb21-695" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb21-696"><a href="#cb21-696" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-697"><a href="#cb21-697" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb21-698"><a href="#cb21-698" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The density of the posterior distribution of regression coefficients for `Temp~avg~` with `SOS` as the response variable for each genus in New York city, generated via MCMC."</span></span>
<span id="cb21-699"><a href="#cb21-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-700"><a href="#cb21-700" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/year_random/"</span></span>
<span id="cb21-701"><a href="#cb21-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-702"><a href="#cb21-702" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*SOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-703"><a href="#cb21-703" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-704"><a href="#cb21-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-705"><a href="#cb21-705" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb21-706"><a href="#cb21-706" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb21-707"><a href="#cb21-707" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*NY_(.*?)_tavg_SOS</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-708"><a href="#cb21-708" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb21-709"><a href="#cb21-709" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb21-710"><a href="#cb21-710" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb21-711"><a href="#cb21-711" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb21-712"><a href="#cb21-712" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb21-713"><a href="#cb21-713" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb21-714"><a href="#cb21-714" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb21-715"><a href="#cb21-715" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb21-716"><a href="#cb21-716" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb21-717"><a href="#cb21-717" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb21-718"><a href="#cb21-718" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb21-719"><a href="#cb21-719" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-720"><a href="#cb21-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-721"><a href="#cb21-721" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb21-722"><a href="#cb21-722" aria-hidden="true" tabindex="-1"></a>combined_plot</span>
<span id="cb21-723"><a href="#cb21-723" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-724"><a href="#cb21-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-725"><a href="#cb21-725" aria-hidden="true" tabindex="-1"></a>As for the spatial field, only Salix seems to be ideal. Other genera exhibit either uniform spatial effects or noticeable local variations, even extremely high value.</span>
<span id="cb21-726"><a href="#cb21-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-729"><a href="#cb21-729" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-730"><a href="#cb21-730" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_sos_tavg_mcmc_sp</span></span>
<span id="cb21-731"><a href="#cb21-731" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-732"><a href="#cb21-732" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 14</span></span>
<span id="cb21-733"><a href="#cb21-733" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 7</span></span>
<span id="cb21-734"><a href="#cb21-734" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-735"><a href="#cb21-735" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb21-736"><a href="#cb21-736" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Spatial fields, generated via MCMC"</span></span>
<span id="cb21-737"><a href="#cb21-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-738"><a href="#cb21-738" aria-hidden="true" tabindex="-1"></a>spherical_covariance <span class="ot">&lt;-</span> <span class="cf">function</span>(d, range, sigma.sq) {</span>
<span id="cb21-739"><a href="#cb21-739" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(d), <span class="at">ncol =</span> <span class="fu">ncol</span>(d))</span>
<span id="cb21-740"><a href="#cb21-740" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d)) {</span>
<span id="cb21-741"><a href="#cb21-741" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(d)) {</span>
<span id="cb21-742"><a href="#cb21-742" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (d[i, j] <span class="sc">&lt;=</span> range) {</span>
<span id="cb21-743"><a href="#cb21-743" aria-hidden="true" tabindex="-1"></a>        result[i, j] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> (<span class="dv">3</span> <span class="sc">*</span> d[i, j] <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> range)) <span class="sc">+</span> (d[i, j]<span class="sc">^</span><span class="dv">3</span> <span class="sc">/</span> (<span class="dv">2</span> <span class="sc">*</span> range<span class="sc">^</span><span class="dv">3</span>)))</span>
<span id="cb21-744"><a href="#cb21-744" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb21-745"><a href="#cb21-745" aria-hidden="true" tabindex="-1"></a>        result[i, j] <span class="ot">&lt;-</span> <span class="fl">0.0</span></span>
<span id="cb21-746"><a href="#cb21-746" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-747"><a href="#cb21-747" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-748"><a href="#cb21-748" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-749"><a href="#cb21-749" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb21-750"><a href="#cb21-750" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-751"><a href="#cb21-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-752"><a href="#cb21-752" aria-hidden="true" tabindex="-1"></a>matern_covariance <span class="ot">&lt;-</span> <span class="cf">function</span>(d, range, sigma.sq, nu) {</span>
<span id="cb21-753"><a href="#cb21-753" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">nrow</span>(d), <span class="at">ncol =</span> <span class="fu">ncol</span>(d))</span>
<span id="cb21-754"><a href="#cb21-754" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(d)) {</span>
<span id="cb21-755"><a href="#cb21-755" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(d)) {</span>
<span id="cb21-756"><a href="#cb21-756" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (d[i, j] <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb21-757"><a href="#cb21-757" aria-hidden="true" tabindex="-1"></a>        result[i, j] <span class="ot">&lt;-</span> <span class="fl">0.0</span></span>
<span id="cb21-758"><a href="#cb21-758" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb21-759"><a href="#cb21-759" aria-hidden="true" tabindex="-1"></a>        part <span class="ot">&lt;-</span> (<span class="dv">2</span><span class="sc">^</span>(<span class="dv">1</span> <span class="sc">-</span> nu)) <span class="sc">/</span> <span class="fu">gamma</span>(nu) <span class="sc">*</span> (<span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> nu) <span class="sc">*</span> d[i, j] <span class="sc">/</span> range)<span class="sc">^</span>nu</span>
<span id="cb21-760"><a href="#cb21-760" aria-hidden="true" tabindex="-1"></a>        result[i, j] <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> part <span class="sc">*</span> <span class="fu">besselK</span>(<span class="fu">sqrt</span>(<span class="dv">2</span> <span class="sc">*</span> nu) <span class="sc">*</span> d[i, j] <span class="sc">/</span> range, nu)</span>
<span id="cb21-761"><a href="#cb21-761" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb21-762"><a href="#cb21-762" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-763"><a href="#cb21-763" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-764"><a href="#cb21-764" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb21-765"><a href="#cb21-765" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-766"><a href="#cb21-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-767"><a href="#cb21-767" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/year_random/"</span></span>
<span id="cb21-768"><a href="#cb21-768" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb21-769"><a href="#cb21-769" aria-hidden="true" tabindex="-1"></a>phe_type <span class="ot">=</span> <span class="st">"SOS"</span></span>
<span id="cb21-770"><a href="#cb21-770" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"SOS"</span>) {</span>
<span id="cb21-771"><a href="#cb21-771" aria-hidden="true" tabindex="-1"></a>  phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb21-772"><a href="#cb21-772" aria-hidden="true" tabindex="-1"></a>  direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb21-773"><a href="#cb21-773" aria-hidden="true" tabindex="-1"></a>  thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb21-774"><a href="#cb21-774" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"EOS"</span>) {</span>
<span id="cb21-775"><a href="#cb21-775" aria-hidden="true" tabindex="-1"></a>  phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb21-776"><a href="#cb21-776" aria-hidden="true" tabindex="-1"></a>  direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb21-777"><a href="#cb21-777" aria-hidden="true" tabindex="-1"></a>  thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb21-778"><a href="#cb21-778" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"GreenUp"</span>) {</span>
<span id="cb21-779"><a href="#cb21-779" aria-hidden="true" tabindex="-1"></a>  phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb21-780"><a href="#cb21-780" aria-hidden="true" tabindex="-1"></a>  direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb21-781"><a href="#cb21-781" aria-hidden="true" tabindex="-1"></a>  thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb21-782"><a href="#cb21-782" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb21-783"><a href="#cb21-783" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb21-784"><a href="#cb21-784" aria-hidden="true" tabindex="-1"></a>  phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb21-785"><a href="#cb21-785" aria-hidden="true" tabindex="-1"></a>  direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb21-786"><a href="#cb21-786" aria-hidden="true" tabindex="-1"></a>  thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb21-787"><a href="#cb21-787" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb21-788"><a href="#cb21-788" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-789"><a href="#cb21-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-790"><a href="#cb21-790" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^"</span>,city,<span class="st">".*"</span>,phe_type,<span class="st">"</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb21-791"><a href="#cb21-791" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^NY.*SOS</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-792"><a href="#cb21-792" aria-hidden="true" tabindex="-1"></a>plots_mean <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-793"><a href="#cb21-793" aria-hidden="true" tabindex="-1"></a>plots_sd <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-794"><a href="#cb21-794" aria-hidden="true" tabindex="-1"></a>plots_extend <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-795"><a href="#cb21-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-796"><a href="#cb21-796" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb21-797"><a href="#cb21-797" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb21-798"><a href="#cb21-798" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-799"><a href="#cb21-799" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-800"><a href="#cb21-800" aria-hidden="true" tabindex="-1"></a>  spatial_mean <span class="ot">&lt;-</span> model_data<span class="sc">$</span>summary[<span class="fu">grep</span>(<span class="st">"spatial_effect"</span>, <span class="fu">rownames</span>(model_data<span class="sc">$</span>summary)), <span class="st">"Mean"</span>]</span>
<span id="cb21-801"><a href="#cb21-801" aria-hidden="true" tabindex="-1"></a>  spatial_sd <span class="ot">&lt;-</span> model_data<span class="sc">$</span>summary[<span class="fu">grep</span>(<span class="st">"spatial_effect"</span>, <span class="fu">rownames</span>(model_data<span class="sc">$</span>summary)), <span class="st">"St.Dev."</span>]</span>
<span id="cb21-802"><a href="#cb21-802" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-803"><a href="#cb21-803" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>, city, <span class="st">"/tavg_allyear_var.rds"</span>))  <span class="sc">%&gt;%</span></span>
<span id="cb21-804"><a href="#cb21-804" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="sc">!!</span>thres <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb21-805"><a href="#cb21-805" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb21-806"><a href="#cb21-806" aria-hidden="true" tabindex="-1"></a>  <span class="co"># %&gt;%</span></span>
<span id="cb21-807"><a href="#cb21-807" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   st_as_sf(coords = c("lon", "lat"), crs = 4326)</span></span>
<span id="cb21-808"><a href="#cb21-808" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb21-809"><a href="#cb21-809" aria-hidden="true" tabindex="-1"></a>  OLS_formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(phe_metric, <span class="st">" ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year)"</span>))</span>
<span id="cb21-810"><a href="#cb21-810" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(OLS_formula, <span class="at">data =</span> tavg_allyear_var)</span>
<span id="cb21-811"><a href="#cb21-811" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_allyear_var[[phe_metric]] <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb21-812"><a href="#cb21-812" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_allyear_var) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb21-813"><a href="#cb21-813" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_allyear_var, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-814"><a href="#cb21-814" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb21-815"><a href="#cb21-815" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb21-816"><a href="#cb21-816" aria-hidden="true" tabindex="-1"></a>  cov_type <span class="ot">&lt;-</span> <span class="fu">as.character</span>(vgm_exn_fit<span class="sc">$</span>model)</span>
<span id="cb21-817"><a href="#cb21-817" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-818"><a href="#cb21-818" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-819"><a href="#cb21-819" aria-hidden="true" tabindex="-1"></a>  tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>, city, <span class="st">"/tavg_allyear_var.rds"</span>))  <span class="sc">%&gt;%</span></span>
<span id="cb21-820"><a href="#cb21-820" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="sc">!!</span>thres <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb21-821"><a href="#cb21-821" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb21-822"><a href="#cb21-822" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-823"><a href="#cb21-823" aria-hidden="true" tabindex="-1"></a>  monitors <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb21-824"><a href="#cb21-824" aria-hidden="true" tabindex="-1"></a>    cov_type,</span>
<span id="cb21-825"><a href="#cb21-825" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Mat"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"range"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"nu"</span>),</span>
<span id="cb21-826"><a href="#cb21-826" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Gau"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"tau"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"phi"</span>),</span>
<span id="cb21-827"><a href="#cb21-827" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Exp"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"tau"</span>, <span class="st">"sigma.sq"</span>, <span class="st">"phi"</span>),</span>
<span id="cb21-828"><a href="#cb21-828" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Sph"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"range"</span>, <span class="st">"sigma.sq"</span>),</span>
<span id="cb21-829"><a href="#cb21-829" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Unknown cov_type!"</span>)</span>
<span id="cb21-830"><a href="#cb21-830" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-831"><a href="#cb21-831" aria-hidden="true" tabindex="-1"></a>  params <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">range =</span> <span class="cn">NULL</span>, <span class="at">sigma.sq =</span> <span class="cn">NULL</span>, <span class="at">nu =</span> <span class="cn">NULL</span>, <span class="at">phi =</span> <span class="cn">NULL</span>)</span>
<span id="cb21-832"><a href="#cb21-832" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (param <span class="cf">in</span> <span class="fu">names</span>(params)) {</span>
<span id="cb21-833"><a href="#cb21-833" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (param <span class="sc">%in%</span> monitors) {</span>
<span id="cb21-834"><a href="#cb21-834" aria-hidden="true" tabindex="-1"></a>      params[[param]] <span class="ot">&lt;-</span> model_data<span class="sc">$</span>summary[<span class="fu">grep</span>(param, <span class="fu">rownames</span>(model_data<span class="sc">$</span>summary)), <span class="st">"Mean"</span>]</span>
<span id="cb21-835"><a href="#cb21-835" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-836"><a href="#cb21-836" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-837"><a href="#cb21-837" aria-hidden="true" tabindex="-1"></a>  grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb21-838"><a href="#cb21-838" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon =</span> <span class="fu">seq</span>(<span class="fu">min</span>(tavg_allyear_var<span class="sc">$</span>lon), <span class="fu">max</span>(tavg_allyear_var<span class="sc">$</span>lon), <span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb21-839"><a href="#cb21-839" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat =</span> <span class="fu">seq</span>(<span class="fu">min</span>(tavg_allyear_var<span class="sc">$</span>lat), <span class="fu">max</span>(tavg_allyear_var<span class="sc">$</span>lat), <span class="at">length.out =</span> <span class="dv">100</span>)</span>
<span id="cb21-840"><a href="#cb21-840" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-841"><a href="#cb21-841" aria-hidden="true" tabindex="-1"></a>  coords_known <span class="ot">&lt;-</span> tavg_allyear_var[, <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)]</span>
<span id="cb21-842"><a href="#cb21-842" aria-hidden="true" tabindex="-1"></a>  coords_pred <span class="ot">&lt;-</span> grid[, <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>)]</span>
<span id="cb21-843"><a href="#cb21-843" aria-hidden="true" tabindex="-1"></a>  dist_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(coords_known))</span>
<span id="cb21-844"><a href="#cb21-844" aria-hidden="true" tabindex="-1"></a>  dist_matrix_known_pred <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">rbind</span>(coords_pred, coords_known)))[<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(coords_pred), (<span class="fu">nrow</span>(coords_pred) <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(<span class="fu">nrow</span>(coords_pred) <span class="sc">+</span> <span class="fu">nrow</span>(coords_known))]</span>
<span id="cb21-845"><a href="#cb21-845" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-846"><a href="#cb21-846" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Mat"</span>) {</span>
<span id="cb21-847"><a href="#cb21-847" aria-hidden="true" tabindex="-1"></a>      cov_matrix <span class="ot">&lt;-</span> <span class="fu">matern_covariance</span>(dist_matrix, params<span class="sc">$</span>range, params<span class="sc">$</span>sigma.sq, params<span class="sc">$</span>nu)</span>
<span id="cb21-848"><a href="#cb21-848" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Gau"</span>) {</span>
<span id="cb21-849"><a href="#cb21-849" aria-hidden="true" tabindex="-1"></a>      cov_matrix <span class="ot">&lt;-</span> params<span class="sc">$</span>sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>params<span class="sc">$</span>phi <span class="sc">*</span> dist_matrix<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb21-850"><a href="#cb21-850" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Exp"</span>) {</span>
<span id="cb21-851"><a href="#cb21-851" aria-hidden="true" tabindex="-1"></a>      cov_matrix <span class="ot">&lt;-</span> params<span class="sc">$</span>sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>params<span class="sc">$</span>phi <span class="sc">*</span> dist_matrix)</span>
<span id="cb21-852"><a href="#cb21-852" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Sph"</span>) {</span>
<span id="cb21-853"><a href="#cb21-853" aria-hidden="true" tabindex="-1"></a>      cov_matrix <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(<span class="at">d =</span> dist_matrix, <span class="at">range =</span> params<span class="sc">$</span>range, <span class="at">sigma.sq =</span> params<span class="sc">$</span>sigma.sq)</span>
<span id="cb21-854"><a href="#cb21-854" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-855"><a href="#cb21-855" aria-hidden="true" tabindex="-1"></a>  cov_matrix <span class="ot">&lt;-</span> cov_matrix <span class="sc">+</span> <span class="fu">diag</span>(<span class="fl">1e-6</span>, <span class="fu">nrow</span>(dist_matrix))</span>
<span id="cb21-856"><a href="#cb21-856" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-857"><a href="#cb21-857" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Mat"</span>) {</span>
<span id="cb21-858"><a href="#cb21-858" aria-hidden="true" tabindex="-1"></a>      cov_matrix_pred <span class="ot">&lt;-</span> <span class="fu">matern_covariance</span>(dist_matrix_known_pred, params<span class="sc">$</span>range, params<span class="sc">$</span>sigma.sq, params<span class="sc">$</span>nu)</span>
<span id="cb21-859"><a href="#cb21-859" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Gau"</span>) {</span>
<span id="cb21-860"><a href="#cb21-860" aria-hidden="true" tabindex="-1"></a>      cov_matrix_pred <span class="ot">&lt;-</span> params<span class="sc">$</span>sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>params<span class="sc">$</span>phi <span class="sc">*</span> dist_matrix_known_pred<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb21-861"><a href="#cb21-861" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Exp"</span>) {</span>
<span id="cb21-862"><a href="#cb21-862" aria-hidden="true" tabindex="-1"></a>      cov_matrix_pred <span class="ot">&lt;-</span> params<span class="sc">$</span>sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>params<span class="sc">$</span>phi <span class="sc">*</span> dist_matrix_known_pred)</span>
<span id="cb21-863"><a href="#cb21-863" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (cov_type <span class="sc">==</span> <span class="st">"Sph"</span>) {</span>
<span id="cb21-864"><a href="#cb21-864" aria-hidden="true" tabindex="-1"></a>      cov_matrix_pred <span class="ot">&lt;-</span> <span class="fu">spherical_covariance</span>(<span class="at">d =</span> dist_matrix_known_pred, <span class="at">range =</span> params<span class="sc">$</span>range, <span class="at">sigma.sq =</span> params<span class="sc">$</span>sigma.sq)</span>
<span id="cb21-865"><a href="#cb21-865" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-866"><a href="#cb21-866" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-867"><a href="#cb21-867" aria-hidden="true" tabindex="-1"></a>  spatial_effect_pred <span class="ot">&lt;-</span> cov_matrix_pred <span class="sc">%*%</span> <span class="fu">solve</span>(cov_matrix) <span class="sc">%*%</span> spatial_mean</span>
<span id="cb21-868"><a href="#cb21-868" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-869"><a href="#cb21-869" aria-hidden="true" tabindex="-1"></a>  grid<span class="sc">$</span>spatial_effect <span class="ot">&lt;-</span> spatial_effect_pred</span>
<span id="cb21-870"><a href="#cb21-870" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(grid, <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">fill =</span> spatial_effect)) <span class="sc">+</span></span>
<span id="cb21-871"><a href="#cb21-871" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb21-872"><a href="#cb21-872" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb21-873"><a href="#cb21-873" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb21-874"><a href="#cb21-874" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb21-875"><a href="#cb21-875" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">fill =</span> <span class="st">"Mean"</span>) <span class="sc">+</span></span>
<span id="cb21-876"><a href="#cb21-876" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb21-877"><a href="#cb21-877" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-878"><a href="#cb21-878" aria-hidden="true" tabindex="-1"></a>  plots_extend[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb21-879"><a href="#cb21-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-880"><a href="#cb21-880" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tavg_allyear_var$spatial_mean &lt;- spatial_mean</span></span>
<span id="cb21-881"><a href="#cb21-881" aria-hidden="true" tabindex="-1"></a>  <span class="co"># tavg_allyear_var$spatial_sd &lt;- spatial_sd</span></span>
<span id="cb21-882"><a href="#cb21-882" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb21-883"><a href="#cb21-883" aria-hidden="true" tabindex="-1"></a>  <span class="co"># p_mean &lt;- ggplot() +</span></span>
<span id="cb21-884"><a href="#cb21-884" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   geom_point(data = tavg_allyear_var, aes(x = lon, y = lat, color = spatial_mean), size = 2) +</span></span>
<span id="cb21-885"><a href="#cb21-885" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +</span></span>
<span id="cb21-886"><a href="#cb21-886" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   theme_minimal() +</span></span>
<span id="cb21-887"><a href="#cb21-887" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   ggtitle(paste("Genus:", genus)) +</span></span>
<span id="cb21-888"><a href="#cb21-888" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   labs(color = "Mean")</span></span>
<span id="cb21-889"><a href="#cb21-889" aria-hidden="true" tabindex="-1"></a>  <span class="co"># p_sd &lt;- ggplot() +</span></span>
<span id="cb21-890"><a href="#cb21-890" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   geom_point(data = tavg_allyear_var, aes(x = lon, y = lat, color = spatial_sd), size = 2) +</span></span>
<span id="cb21-891"><a href="#cb21-891" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   scale_color_gradient(low = "white", high = "red") +</span></span>
<span id="cb21-892"><a href="#cb21-892" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   theme_minimal() +</span></span>
<span id="cb21-893"><a href="#cb21-893" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   ggtitle(paste("Genus:", genus)) +</span></span>
<span id="cb21-894"><a href="#cb21-894" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   labs(color = "SD")</span></span>
<span id="cb21-895"><a href="#cb21-895" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plots_mean[[genus]] &lt;- p_mean</span></span>
<span id="cb21-896"><a href="#cb21-896" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plots_sd[[genus]] &lt;- p_sd</span></span>
<span id="cb21-897"><a href="#cb21-897" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-898"><a href="#cb21-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-899"><a href="#cb21-899" aria-hidden="true" tabindex="-1"></a>combined_plot_extend <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots_extend, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb21-900"><a href="#cb21-900" aria-hidden="true" tabindex="-1"></a>combined_plot_extend</span>
<span id="cb21-901"><a href="#cb21-901" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-902"><a href="#cb21-902" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-903"><a href="#cb21-903" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 3.1.2 INLA</span></span>
<span id="cb21-904"><a href="#cb21-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-905"><a href="#cb21-905" aria-hidden="true" tabindex="-1"></a>Code example:</span>
<span id="cb21-906"><a href="#cb21-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-909"><a href="#cb21-909" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-910"><a href="#cb21-910" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: inla_code</span></span>
<span id="cb21-911"><a href="#cb21-911" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-912"><a href="#cb21-912" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-913"><a href="#cb21-913" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb21-914"><a href="#cb21-914" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-915"><a href="#cb21-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-916"><a href="#cb21-916" aria-hidden="true" tabindex="-1"></a><span class="do">#################### Prepare the mesh and spde ####################</span></span>
<span id="cb21-917"><a href="#cb21-917" aria-hidden="true" tabindex="-1"></a><span class="do">### Build the mesh </span></span>
<span id="cb21-918"><a href="#cb21-918" aria-hidden="true" tabindex="-1"></a>coord <span class="ot">&lt;-</span> <span class="fu">cbind</span>(tavg_allyear_var<span class="sc">$</span>lon, tavg_allyear_var<span class="sc">$</span>lat) <span class="co"># coordinates of observations</span></span>
<span id="cb21-919"><a href="#cb21-919" aria-hidden="true" tabindex="-1"></a>domain <span class="ot">&lt;-</span> <span class="fu">inla.nonconvex.hull</span>(<span class="fu">as.matrix</span>(coord),</span>
<span id="cb21-920"><a href="#cb21-920" aria-hidden="true" tabindex="-1"></a>                              <span class="at">concave =</span> <span class="sc">-</span>.<span class="dv">07</span>,<span class="at">convex =</span> <span class="sc">-</span><span class="fl">0.05</span>, <span class="at">resolution=</span><span class="fu">c</span>(<span class="dv">100</span>,<span class="dv">100</span>))</span>
<span id="cb21-921"><a href="#cb21-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-922"><a href="#cb21-922" aria-hidden="true" tabindex="-1"></a>mesh <span class="ot">&lt;-</span> <span class="fu">inla.mesh.2d</span>(<span class="at">boundary =</span> domain, <span class="at">loc =</span> coord,</span>
<span id="cb21-923"><a href="#cb21-923" aria-hidden="true" tabindex="-1"></a>                     <span class="at">max.edge =</span> <span class="fu">c</span>(<span class="dv">10000</span>, <span class="dv">20000</span>), </span>
<span id="cb21-924"><a href="#cb21-924" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cutoff =</span> <span class="dv">1000</span> <span class="co"># prevent close points from being connected</span></span>
<span id="cb21-925"><a href="#cb21-925" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-926"><a href="#cb21-926" aria-hidden="true" tabindex="-1"></a><span class="co"># mesh$n</span></span>
<span id="cb21-927"><a href="#cb21-927" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot() +</span></span>
<span id="cb21-928"><a href="#cb21-928" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_sf(data=ny_boundary,color='turquoise',fill='transparent') +</span></span>
<span id="cb21-929"><a href="#cb21-929" aria-hidden="true" tabindex="-1"></a><span class="co">#   gg(mesh) +</span></span>
<span id="cb21-930"><a href="#cb21-930" aria-hidden="true" tabindex="-1"></a><span class="co">#   geom_sf(data=tavg_allyear_var_sf,col='purple',size=1.7,alpha=0.5)</span></span>
<span id="cb21-931"><a href="#cb21-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-932"><a href="#cb21-932" aria-hidden="true" tabindex="-1"></a><span class="do">### Build the spde </span></span>
<span id="cb21-933"><a href="#cb21-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-934"><a href="#cb21-934" aria-hidden="true" tabindex="-1"></a>spde <span class="ot">&lt;-</span> <span class="fu">inla.spde2.matern</span>(<span class="at">mesh =</span> mesh, <span class="at">alpha =</span> <span class="dv">2</span>, <span class="at">constr =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-935"><a href="#cb21-935" aria-hidden="true" tabindex="-1"></a>A.phe <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh, <span class="at">loc =</span> coord)</span>
<span id="cb21-936"><a href="#cb21-936" aria-hidden="true" tabindex="-1"></a>s.index <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.index</span>(<span class="at">name =</span> <span class="st">"spatial.field"</span>,</span>
<span id="cb21-937"><a href="#cb21-937" aria-hidden="true" tabindex="-1"></a>                                <span class="at">n.spde =</span> spde<span class="sc">$</span>n.spde)</span>
<span id="cb21-938"><a href="#cb21-938" aria-hidden="true" tabindex="-1"></a><span class="co"># dim(A.phe)</span></span>
<span id="cb21-939"><a href="#cb21-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-940"><a href="#cb21-940" aria-hidden="true" tabindex="-1"></a>coorp <span class="ot">&lt;-</span> <span class="fu">cbind</span>(prediction<span class="sc">$</span>Lon, prediction<span class="sc">$</span>Lat) </span>
<span id="cb21-941"><a href="#cb21-941" aria-hidden="true" tabindex="-1"></a>A.phe.p <span class="ot">&lt;-</span> <span class="fu">inla.spde.make.A</span>(<span class="at">mesh =</span> mesh, <span class="at">loc =</span> coorp)</span>
<span id="cb21-942"><a href="#cb21-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-943"><a href="#cb21-943" aria-hidden="true" tabindex="-1"></a><span class="do">#################### Stack the data ####################</span></span>
<span id="cb21-944"><a href="#cb21-944" aria-hidden="true" tabindex="-1"></a>stk.e <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(</span>
<span id="cb21-945"><a href="#cb21-945" aria-hidden="true" tabindex="-1"></a>  <span class="at">tag =</span> <span class="st">"est"</span>,</span>
<span id="cb21-946"><a href="#cb21-946" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> tavg_allyear_var[[phe_metric]]),</span>
<span id="cb21-947"><a href="#cb21-947" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, A.phe),</span>
<span id="cb21-948"><a href="#cb21-948" aria-hidden="true" tabindex="-1"></a>  <span class="at">effects =</span> <span class="fu">list</span>(<span class="fu">data.frame</span>(<span class="at">Intercept =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(coord)),</span>
<span id="cb21-949"><a href="#cb21-949" aria-hidden="true" tabindex="-1"></a>                            <span class="at">AvgTemp_mean =</span> tavg_allyear_var<span class="sc">$</span>AvgTemp_mean,</span>
<span id="cb21-950"><a href="#cb21-950" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Sum_mm_sum =</span> tavg_allyear_var<span class="sc">$</span>Sum_mm_sum,</span>
<span id="cb21-951"><a href="#cb21-951" aria-hidden="true" tabindex="-1"></a>                            <span class="at">srad_mean =</span> tavg_allyear_var<span class="sc">$</span>srad_mean,</span>
<span id="cb21-952"><a href="#cb21-952" aria-hidden="true" tabindex="-1"></a>                            <span class="at">year =</span> tavg_allyear_var<span class="sc">$</span>year), </span>
<span id="cb21-953"><a href="#cb21-953" aria-hidden="true" tabindex="-1"></a>                 <span class="at">s =</span> s.index)</span>
<span id="cb21-954"><a href="#cb21-954" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-955"><a href="#cb21-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-956"><a href="#cb21-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-957"><a href="#cb21-957" aria-hidden="true" tabindex="-1"></a>stk.p <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(</span>
<span id="cb21-958"><a href="#cb21-958" aria-hidden="true" tabindex="-1"></a>  <span class="at">tag =</span> <span class="st">"pred"</span>,</span>
<span id="cb21-959"><a href="#cb21-959" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> <span class="cn">NA</span>),</span>
<span id="cb21-960"><a href="#cb21-960" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="fu">list</span>(<span class="dv">1</span>, A.phe.p),</span>
<span id="cb21-961"><a href="#cb21-961" aria-hidden="true" tabindex="-1"></a>  <span class="at">effects =</span> <span class="fu">list</span>(<span class="fu">data.frame</span>(<span class="at">Intercept =</span> <span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(coorp)),</span>
<span id="cb21-962"><a href="#cb21-962" aria-hidden="true" tabindex="-1"></a>                            <span class="at">AvgTemp_mean =</span> prediction<span class="sc">$</span>AvgTemp_mean,</span>
<span id="cb21-963"><a href="#cb21-963" aria-hidden="true" tabindex="-1"></a>                            <span class="at">Sum_mm_sum =</span> prediction<span class="sc">$</span>Sum_mm_sum,</span>
<span id="cb21-964"><a href="#cb21-964" aria-hidden="true" tabindex="-1"></a>                            <span class="at">srad_mean =</span> prediction<span class="sc">$</span>srad_mean,</span>
<span id="cb21-965"><a href="#cb21-965" aria-hidden="true" tabindex="-1"></a>                            <span class="at">year =</span> prediction<span class="sc">$</span>year), </span>
<span id="cb21-966"><a href="#cb21-966" aria-hidden="true" tabindex="-1"></a>                 <span class="at">s =</span> s.index)</span>
<span id="cb21-967"><a href="#cb21-967" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-968"><a href="#cb21-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-969"><a href="#cb21-969" aria-hidden="true" tabindex="-1"></a><span class="co"># stk.full has stk.e and stk.p</span></span>
<span id="cb21-970"><a href="#cb21-970" aria-hidden="true" tabindex="-1"></a>stk.full <span class="ot">&lt;-</span> <span class="fu">inla.stack</span>(stk.e, stk.p)</span>
<span id="cb21-971"><a href="#cb21-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-972"><a href="#cb21-972" aria-hidden="true" tabindex="-1"></a><span class="do">#################### Run/Save the model ####################</span></span>
<span id="cb21-973"><a href="#cb21-973" aria-hidden="true" tabindex="-1"></a><span class="do">### Run the model</span></span>
<span id="cb21-974"><a href="#cb21-974" aria-hidden="true" tabindex="-1"></a>formula <span class="ot">&lt;-</span> y <span class="sc">~</span> <span class="dv">0</span> <span class="sc">+</span> Intercept <span class="sc">+</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> <span class="fu">f</span>(year, <span class="at">model =</span> <span class="st">'iid'</span>) <span class="sc">+</span> <span class="fu">f</span>(spatial.field, <span class="at">model =</span> spde)</span>
<span id="cb21-975"><a href="#cb21-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-976"><a href="#cb21-976" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">inla</span>(formula,</span>
<span id="cb21-977"><a href="#cb21-977" aria-hidden="true" tabindex="-1"></a>            <span class="at">family =</span> <span class="st">"gaussian"</span>,</span>
<span id="cb21-978"><a href="#cb21-978" aria-hidden="true" tabindex="-1"></a>            <span class="at">data =</span> <span class="fu">inla.stack.data</span>(stk.full),</span>
<span id="cb21-979"><a href="#cb21-979" aria-hidden="true" tabindex="-1"></a>            <span class="at">control.compute =</span> <span class="fu">list</span>(<span class="at">return.marginals =</span> <span class="cn">TRUE</span>, <span class="at">waic =</span> <span class="cn">TRUE</span>),</span>
<span id="cb21-980"><a href="#cb21-980" aria-hidden="true" tabindex="-1"></a>            <span class="at">control.predictor =</span> <span class="fu">list</span>(</span>
<span id="cb21-981"><a href="#cb21-981" aria-hidden="true" tabindex="-1"></a>              <span class="at">compute =</span> <span class="cn">TRUE</span>,</span>
<span id="cb21-982"><a href="#cb21-982" aria-hidden="true" tabindex="-1"></a>              <span class="at">A =</span> <span class="fu">inla.stack.A</span>(stk.full)</span>
<span id="cb21-983"><a href="#cb21-983" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb21-984"><a href="#cb21-984" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-985"><a href="#cb21-985" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-986"><a href="#cb21-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-987"><a href="#cb21-987" aria-hidden="true" tabindex="-1"></a>As for the INLA model, the coefficients do not show significant differences from the MCMC model, with most genera showed negative association between temperature and the start of season.</span>
<span id="cb21-988"><a href="#cb21-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-989"><a href="#cb21-989" aria-hidden="true" tabindex="-1"></a>Why so convergent? INLA first finds the Maximum A Posteriori (MAP) estimate, which is the highest point of the posterior distribution. Then it uses Laplace Approximation, which inherently assumes that the posterior distribution is approximately normal near its peak (the MAP estimate).</span>
<span id="cb21-990"><a href="#cb21-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-993"><a href="#cb21-993" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-994"><a href="#cb21-994" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_sos_tavg_coef</span></span>
<span id="cb21-995"><a href="#cb21-995" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-996"><a href="#cb21-996" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb21-997"><a href="#cb21-997" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb21-998"><a href="#cb21-998" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-999"><a href="#cb21-999" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb21-1000"><a href="#cb21-1000" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The density of the posterior distribution of regression coefficients for `Temp~avg~` with `SOS` as the response variable for each genus in New York city, generated via INLA."</span></span>
<span id="cb21-1001"><a href="#cb21-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1002"><a href="#cb21-1002" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/"</span></span>
<span id="cb21-1003"><a href="#cb21-1003" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb21-1004"><a href="#cb21-1004" aria-hidden="true" tabindex="-1"></a>phe_type <span class="ot">=</span> <span class="st">"GreenDown"</span></span>
<span id="cb21-1005"><a href="#cb21-1005" aria-hidden="true" tabindex="-1"></a>plots_mean <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-1006"><a href="#cb21-1006" aria-hidden="true" tabindex="-1"></a>plots_sd <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-1007"><a href="#cb21-1007" aria-hidden="true" tabindex="-1"></a>plots_semi <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-1008"><a href="#cb21-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1009"><a href="#cb21-1009" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^"</span>,city,<span class="st">".*"</span>,phe_type,<span class="st">"</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb21-1010"><a href="#cb21-1010" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-1011"><a href="#cb21-1011" aria-hidden="true" tabindex="-1"></a>plots_tavg <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-1012"><a href="#cb21-1012" aria-hidden="true" tabindex="-1"></a>coef_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb21-1013"><a href="#cb21-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1014"><a href="#cb21-1014" aria-hidden="true" tabindex="-1"></a><span class="co"># for one genus</span></span>
<span id="cb21-1015"><a href="#cb21-1015" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb21-1016"><a href="#cb21-1016" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb21-1017"><a href="#cb21-1017" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1018"><a href="#cb21-1018" aria-hidden="true" tabindex="-1"></a>  <span class="co"># beta_names &lt;- c("beta[0]", "beta[AvgTemp_mean]", "beta[Sum_mm_sum]", "beta[srad_mean]")</span></span>
<span id="cb21-1019"><a href="#cb21-1019" aria-hidden="true" tabindex="-1"></a>  <span class="co"># df_list &lt;- lapply(seq_along(model_data$res$marginals.fixed), function(i) {</span></span>
<span id="cb21-1020"><a href="#cb21-1020" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   data.frame(x = model_data$res$marginals.fixed[[i]][,1], </span></span>
<span id="cb21-1021"><a href="#cb21-1021" aria-hidden="true" tabindex="-1"></a>  <span class="co">#              density = model_data$res$marginals.fixed[[i]][,2], </span></span>
<span id="cb21-1022"><a href="#cb21-1022" aria-hidden="true" tabindex="-1"></a>  <span class="co">#              beta = beta_names[i])</span></span>
<span id="cb21-1023"><a href="#cb21-1023" aria-hidden="true" tabindex="-1"></a>  <span class="co"># })</span></span>
<span id="cb21-1024"><a href="#cb21-1024" aria-hidden="true" tabindex="-1"></a>  <span class="co"># df &lt;- bind_rows(df_list)</span></span>
<span id="cb21-1025"><a href="#cb21-1025" aria-hidden="true" tabindex="-1"></a>  beta_avg_temp <span class="ot">&lt;-</span> model_data<span class="sc">$</span>res<span class="sc">$</span>marginals.fixed[[<span class="dv">2</span>]]</span>
<span id="cb21-1026"><a href="#cb21-1026" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-1027"><a href="#cb21-1027" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> beta_avg_temp[, <span class="dv">1</span>],</span>
<span id="cb21-1028"><a href="#cb21-1028" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> beta_avg_temp[, <span class="dv">2</span>],</span>
<span id="cb21-1029"><a href="#cb21-1029" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="st">"beta[AvgTemp_mean]"</span></span>
<span id="cb21-1030"><a href="#cb21-1030" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1031"><a href="#cb21-1031" aria-hidden="true" tabindex="-1"></a>  plot_tavg <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span></span>
<span id="cb21-1032"><a href="#cb21-1032" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb21-1033"><a href="#cb21-1033" aria-hidden="true" tabindex="-1"></a>    <span class="co"># facet_wrap(~beta, scales = "free", labeller = label_parsed) + </span></span>
<span id="cb21-1034"><a href="#cb21-1034" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb21-1035"><a href="#cb21-1035" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Coefficient Value"</span>, <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb21-1036"><a href="#cb21-1036" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb21-1037"><a href="#cb21-1037" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb21-1038"><a href="#cb21-1038" aria-hidden="true" tabindex="-1"></a>  plots_tavg[[genus]] <span class="ot">&lt;-</span> plot_tavg</span>
<span id="cb21-1039"><a href="#cb21-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1040"><a href="#cb21-1040" aria-hidden="true" tabindex="-1"></a>  proj <span class="ot">&lt;-</span> <span class="fu">inla.mesh.projector</span>(model_data<span class="sc">$</span>mesh,<span class="at">dims =</span> <span class="fu">c</span>(<span class="dv">300</span>, <span class="dv">300</span>))</span>
<span id="cb21-1041"><a href="#cb21-1041" aria-hidden="true" tabindex="-1"></a>  mean_s <span class="ot">&lt;-</span> <span class="fu">inla.mesh.project</span>(proj, model_data<span class="sc">$</span>res<span class="sc">$</span>summary.random<span class="sc">$</span>s<span class="sc">$</span>mean)</span>
<span id="cb21-1042"><a href="#cb21-1042" aria-hidden="true" tabindex="-1"></a>  sd_s <span class="ot">&lt;-</span> <span class="fu">inla.mesh.project</span>(proj, model_data<span class="sc">$</span>res<span class="sc">$</span>summary.random<span class="sc">$</span>s<span class="sc">$</span>sd)</span>
<span id="cb21-1043"><a href="#cb21-1043" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x =</span> proj<span class="sc">$</span>x, <span class="at">y =</span> proj<span class="sc">$</span>y)</span>
<span id="cb21-1044"><a href="#cb21-1044" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>mean_s <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(mean_s)</span>
<span id="cb21-1045"><a href="#cb21-1045" aria-hidden="true" tabindex="-1"></a>  df<span class="sc">$</span>sd_s <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(sd_s)</span>
<span id="cb21-1046"><a href="#cb21-1046" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-1047"><a href="#cb21-1047" aria-hidden="true" tabindex="-1"></a>  p_mean <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> mean_s)) <span class="sc">+</span></span>
<span id="cb21-1048"><a href="#cb21-1048" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb21-1049"><a href="#cb21-1049" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis</span>(<span class="at">na.value =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb21-1050"><a href="#cb21-1050" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb21-1051"><a href="#cb21-1051" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="fl">0.8</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb21-1052"><a href="#cb21-1052" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb21-1053"><a href="#cb21-1053" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-1054"><a href="#cb21-1054" aria-hidden="true" tabindex="-1"></a>  p_sd <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> sd_s)) <span class="sc">+</span></span>
<span id="cb21-1055"><a href="#cb21-1055" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb21-1056"><a href="#cb21-1056" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_viridis</span>(<span class="at">na.value =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb21-1057"><a href="#cb21-1057" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb21-1058"><a href="#cb21-1058" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()<span class="sc">+</span></span>
<span id="cb21-1059"><a href="#cb21-1059" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb21-1060"><a href="#cb21-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1061"><a href="#cb21-1061" aria-hidden="true" tabindex="-1"></a>  <span class="co">#Plot the decay of spatial autocorrelation across a user-defined range</span></span>
<span id="cb21-1062"><a href="#cb21-1062" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-1063"><a href="#cb21-1063" aria-hidden="true" tabindex="-1"></a>  spde.est <span class="ot">&lt;-</span> <span class="fu">inla.spde2.result</span>(<span class="at">inla =</span> model_data<span class="sc">$</span>res, <span class="at">name =</span> <span class="st">"spatial.field"</span>,</span>
<span id="cb21-1064"><a href="#cb21-1064" aria-hidden="true" tabindex="-1"></a>                                <span class="at">spde =</span> model_data<span class="sc">$</span>spde, <span class="at">do.transf =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-1065"><a href="#cb21-1065" aria-hidden="true" tabindex="-1"></a>  Kappa <span class="ot">=</span> <span class="fu">inla.zmarginal</span>(spde.est<span class="sc">$</span>marginals.kappa[[<span class="dv">1</span>]], <span class="at">silent =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]<span class="sc">$</span>mean</span>
<span id="cb21-1066"><a href="#cb21-1066" aria-hidden="true" tabindex="-1"></a>  MaxRange <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb21-1067"><a href="#cb21-1067" aria-hidden="true" tabindex="-1"></a>  Resolution <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb21-1068"><a href="#cb21-1068" aria-hidden="true" tabindex="-1"></a>  d.vec <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, MaxRange, <span class="at">length =</span> Resolution)</span>
<span id="cb21-1069"><a href="#cb21-1069" aria-hidden="true" tabindex="-1"></a>  Cor.M <span class="ot">&lt;-</span> (Kappa <span class="sc">*</span> d.vec) <span class="sc">*</span> <span class="fu">besselK</span>(Kappa <span class="sc">*</span> d.vec, <span class="dv">1</span>)</span>
<span id="cb21-1070"><a href="#cb21-1070" aria-hidden="true" tabindex="-1"></a>  Cor.M[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb21-1071"><a href="#cb21-1071" aria-hidden="true" tabindex="-1"></a>  CorData <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Distance =</span> d.vec, <span class="at">Correlation =</span> Cor.M)</span>
<span id="cb21-1072"><a href="#cb21-1072" aria-hidden="true" tabindex="-1"></a>  p_semi <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(CorData, <span class="fu">aes</span>(<span class="at">x =</span> Distance, <span class="at">y =</span> Correlation)) <span class="sc">+</span></span>
<span id="cb21-1073"><a href="#cb21-1073" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb21-1074"><a href="#cb21-1074" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> MaxRange) <span class="sc">+</span></span>
<span id="cb21-1075"><a href="#cb21-1075" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Distance (m)"</span>, <span class="at">y =</span> <span class="st">"Correlation"</span>, <span class="at">title =</span> <span class="st">"Matern Correlation Function"</span>) <span class="sc">+</span></span>
<span id="cb21-1076"><a href="#cb21-1076" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb21-1077"><a href="#cb21-1077" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb21-1078"><a href="#cb21-1078" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb21-1079"><a href="#cb21-1079" aria-hidden="true" tabindex="-1"></a>  plots_mean[[genus]] <span class="ot">&lt;-</span> p_mean</span>
<span id="cb21-1080"><a href="#cb21-1080" aria-hidden="true" tabindex="-1"></a>  plots_sd[[genus]] <span class="ot">&lt;-</span> p_sd</span>
<span id="cb21-1081"><a href="#cb21-1081" aria-hidden="true" tabindex="-1"></a>  plots_semi[[genus]] <span class="ot">&lt;-</span> p_semi</span>
<span id="cb21-1082"><a href="#cb21-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1083"><a href="#cb21-1083" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1084"><a href="#cb21-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1085"><a href="#cb21-1085" aria-hidden="true" tabindex="-1"></a>combined_plot_tavg <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots_tavg, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb21-1086"><a href="#cb21-1086" aria-hidden="true" tabindex="-1"></a>combined_plot_tavg</span>
<span id="cb21-1087"><a href="#cb21-1087" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1088"><a href="#cb21-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1089"><a href="#cb21-1089" aria-hidden="true" tabindex="-1"></a>Compared to the previous MCMC results, these spatial fields appear to be smoother overall, with gradual transitions rather than sharp local variations.Some genera (Ulmus, Alnus) have fewer high/low value clusters due to fewer observations.</span>
<span id="cb21-1090"><a href="#cb21-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1093"><a href="#cb21-1093" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1094"><a href="#cb21-1094" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_sos_tavg_sp</span></span>
<span id="cb21-1095"><a href="#cb21-1095" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-1096"><a href="#cb21-1096" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 15</span></span>
<span id="cb21-1097"><a href="#cb21-1097" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb21-1098"><a href="#cb21-1098" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-1099"><a href="#cb21-1099" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb21-1100"><a href="#cb21-1100" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Spatial fields generated via INLA."</span></span>
<span id="cb21-1101"><a href="#cb21-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1102"><a href="#cb21-1102" aria-hidden="true" tabindex="-1"></a>combined_plot_semi <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots_semi, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb21-1103"><a href="#cb21-1103" aria-hidden="true" tabindex="-1"></a>combined_plot_mean <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots_mean, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb21-1104"><a href="#cb21-1104" aria-hidden="true" tabindex="-1"></a>combined_plot_sd <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots_sd, <span class="at">ncol =</span> <span class="dv">5</span>)</span>
<span id="cb21-1105"><a href="#cb21-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1106"><a href="#cb21-1106" aria-hidden="true" tabindex="-1"></a>combined_plot_mean</span>
<span id="cb21-1107"><a href="#cb21-1107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1108"><a href="#cb21-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1109"><a href="#cb21-1109" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.2 Other phenophases in NYC</span></span>
<span id="cb21-1110"><a href="#cb21-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1111"><a href="#cb21-1111" aria-hidden="true" tabindex="-1"></a>Since the spatial fiels are more smooth, the coefficient estimates are more valid.</span>
<span id="cb21-1112"><a href="#cb21-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1113"><a href="#cb21-1113" aria-hidden="true" tabindex="-1"></a>The genus Alnus has fewer data points, leading to non-convergence of the posterior distribution. So it is ignored here.</span>
<span id="cb21-1114"><a href="#cb21-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1115"><a href="#cb21-1115" aria-hidden="true" tabindex="-1"></a>The magnitude of their responses vary among genera. However, the direction of their response is relatively consistent among most genera, with a 1- to 4-day advancement in SOS, 1-8 days delay in EOS (except Platanus), 1-2 days faster in GreenUp pace (except Celtis), and 1-2 days faster in GreenDown pace (except Carya) as preseason temperature increases 1 degree C.</span>
<span id="cb21-1116"><a href="#cb21-1116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1119"><a href="#cb21-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1120"><a href="#cb21-1120" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_tavg_comp</span></span>
<span id="cb21-1121"><a href="#cb21-1121" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-1122"><a href="#cb21-1122" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb21-1123"><a href="#cb21-1123" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb21-1124"><a href="#cb21-1124" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The distribution of the posterior of regression coefficients for `Temp~avg~` for each genus in New York city (Thick line: 90% CI, thin line: 95% CI, point: mean value)."</span></span>
<span id="cb21-1125"><a href="#cb21-1125" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-1126"><a href="#cb21-1126" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb21-1127"><a href="#cb21-1127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1128"><a href="#cb21-1128" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/"</span></span>
<span id="cb21-1129"><a href="#cb21-1129" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb21-1130"><a href="#cb21-1130" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^"</span>,city,<span class="st">".*</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb21-1131"><a href="#cb21-1131" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-1132"><a href="#cb21-1132" aria-hidden="true" tabindex="-1"></a>coef_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb21-1133"><a href="#cb21-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1134"><a href="#cb21-1134" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb21-1135"><a href="#cb21-1135" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb21-1136"><a href="#cb21-1136" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1137"><a href="#cb21-1137" aria-hidden="true" tabindex="-1"></a>  phe_type <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">3"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1138"><a href="#cb21-1138" aria-hidden="true" tabindex="-1"></a>  fixed_summary <span class="ot">&lt;-</span> model_data<span class="sc">$</span>fix_effect <span class="sc">%&gt;%</span></span>
<span id="cb21-1139"><a href="#cb21-1139" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">genus =</span> genus, <span class="at">phe_type =</span> phe_type)</span>
<span id="cb21-1140"><a href="#cb21-1140" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb21-1141"><a href="#cb21-1141" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(fixed_summary)</span>
<span id="cb21-1142"><a href="#cb21-1142" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1143"><a href="#cb21-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1144"><a href="#cb21-1144" aria-hidden="true" tabindex="-1"></a>coef_summary_df <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb21-1145"><a href="#cb21-1145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SigAlpha =</span> <span class="fu">ifelse</span>(Sig <span class="sc">==</span> <span class="st">"*"</span>, <span class="dv">1</span>, <span class="fl">0.2</span>),</span>
<span id="cb21-1146"><a href="#cb21-1146" aria-hidden="true" tabindex="-1"></a>         <span class="at">phe_type =</span> <span class="fu">factor</span>(phe_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb21-1147"><a href="#cb21-1147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Factor <span class="sc">!=</span> <span class="st">"Alnus"</span>)</span>
<span id="cb21-1148"><a href="#cb21-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1149"><a href="#cb21-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1150"><a href="#cb21-1150" aria-hidden="true" tabindex="-1"></a>coef_summary_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef_summary_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(Factor, <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">unique</span>(Factor))), </span>
<span id="cb21-1151"><a href="#cb21-1151" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y =</span> Estimate)) <span class="sc">+</span></span>
<span id="cb21-1152"><a href="#cb21-1152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> SigAlpha), <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb21-1153"><a href="#cb21-1153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Lower, <span class="at">ymax =</span> Upper, <span class="at">alpha =</span> SigAlpha), </span>
<span id="cb21-1154"><a href="#cb21-1154" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), </span>
<span id="cb21-1155"><a href="#cb21-1155" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb21-1156"><a href="#cb21-1156" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-1157"><a href="#cb21-1157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb21-1158"><a href="#cb21-1158" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>phe_type, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span> </span>
<span id="cb21-1159"><a href="#cb21-1159" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb21-1160"><a href="#cb21-1160" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span></span>
<span id="cb21-1161"><a href="#cb21-1161" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>) <span class="sc">+</span></span>
<span id="cb21-1162"><a href="#cb21-1162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +</span></span>
<span id="cb21-1163"><a href="#cb21-1163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> Estimate, <span class="at">y =</span> Estimate), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.9</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb21-1164"><a href="#cb21-1164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">alpha =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb21-1165"><a href="#cb21-1165" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb21-1166"><a href="#cb21-1166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">aspect.ratio =</span> <span class="dv">1</span>,</span>
<span id="cb21-1167"><a href="#cb21-1167" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb21-1168"><a href="#cb21-1168" aria-hidden="true" tabindex="-1"></a>coef_summary_plot</span>
<span id="cb21-1169"><a href="#cb21-1169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1170"><a href="#cb21-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1171"><a href="#cb21-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1172"><a href="#cb21-1172" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.3 Comparison across cities</span></span>
<span id="cb21-1173"><a href="#cb21-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1174"><a href="#cb21-1174" aria-hidden="true" tabindex="-1"></a>For SOS, most genera all cities showed negative association between temperature and the start of season. Only some genera in DV and ST had a positive association.</span>
<span id="cb21-1175"><a href="#cb21-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1176"><a href="#cb21-1176" aria-hidden="true" tabindex="-1"></a>For EOS, the difference among cities is the most obvious. Almost all genera in NY and ST had a positive association, while most genera in DV had a negative association. **Precipitation/humidity/elevation?**</span>
<span id="cb21-1177"><a href="#cb21-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1178"><a href="#cb21-1178" aria-hidden="true" tabindex="-1"></a>For GreenUp, most genera had a positive association.</span>
<span id="cb21-1179"><a href="#cb21-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1180"><a href="#cb21-1180" aria-hidden="true" tabindex="-1"></a>For GreenDown, almost all genera in DV and NY had a negative association, while most genera in ST and HT had a positive association.</span>
<span id="cb21-1181"><a href="#cb21-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1184"><a href="#cb21-1184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1185"><a href="#cb21-1185" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-city_comp</span></span>
<span id="cb21-1186"><a href="#cb21-1186" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-1187"><a href="#cb21-1187" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The distribution of the posterior of regression coefficients for `Temp~avg~` on phenology for each genus (Line: 95% CI, point: mean value)."</span></span>
<span id="cb21-1188"><a href="#cb21-1188" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-1189"><a href="#cb21-1189" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb21-1190"><a href="#cb21-1190" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb21-1191"><a href="#cb21-1191" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb21-1192"><a href="#cb21-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1193"><a href="#cb21-1193" aria-hidden="true" tabindex="-1"></a><span class="do">### INLA</span></span>
<span id="cb21-1194"><a href="#cb21-1194" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/"</span></span>
<span id="cb21-1195"><a href="#cb21-1195" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^.*</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb21-1196"><a href="#cb21-1196" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-1197"><a href="#cb21-1197" aria-hidden="true" tabindex="-1"></a>coef_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb21-1198"><a href="#cb21-1198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1199"><a href="#cb21-1199" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb21-1200"><a href="#cb21-1200" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb21-1201"><a href="#cb21-1201" aria-hidden="true" tabindex="-1"></a>  city <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1202"><a href="#cb21-1202" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1203"><a href="#cb21-1203" aria-hidden="true" tabindex="-1"></a>  phe_type <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">3"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1204"><a href="#cb21-1204" aria-hidden="true" tabindex="-1"></a>  fixed_summary <span class="ot">&lt;-</span> model_data<span class="sc">$</span>fix_effect <span class="sc">%&gt;%</span></span>
<span id="cb21-1205"><a href="#cb21-1205" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">city =</span> city, <span class="at">genus =</span> genus, <span class="at">phe_type =</span> phe_type)</span>
<span id="cb21-1206"><a href="#cb21-1206" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb21-1207"><a href="#cb21-1207" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(fixed_summary)</span>
<span id="cb21-1208"><a href="#cb21-1208" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1209"><a href="#cb21-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1210"><a href="#cb21-1210" aria-hidden="true" tabindex="-1"></a>coef_summary_df <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb21-1211"><a href="#cb21-1211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SigAlpha =</span> <span class="fu">ifelse</span>(Sig <span class="sc">==</span> <span class="st">"*"</span>, <span class="dv">1</span>, <span class="fl">0.2</span>),</span>
<span id="cb21-1212"><a href="#cb21-1212" aria-hidden="true" tabindex="-1"></a>         <span class="at">phe_type =</span> <span class="fu">factor</span>(phe_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)),</span>
<span id="cb21-1213"><a href="#cb21-1213" aria-hidden="true" tabindex="-1"></a>         <span class="at">city =</span> <span class="fu">factor</span>(city, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"NY"</span>, <span class="st">"DV"</span>, <span class="st">"HT"</span>, <span class="st">"ST"</span>)))</span>
<span id="cb21-1214"><a href="#cb21-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1215"><a href="#cb21-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1216"><a href="#cb21-1216" aria-hidden="true" tabindex="-1"></a>coef_summary_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef_summary_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(Factor, <span class="at">levels =</span> <span class="fu">unique</span>(Factor)), <span class="at">y =</span> Estimate, <span class="at">color =</span> city)) <span class="sc">+</span></span>
<span id="cb21-1217"><a href="#cb21-1217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> SigAlpha), <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb21-1218"><a href="#cb21-1218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Lower, <span class="at">ymax =</span> Upper, <span class="at">alpha =</span> SigAlpha), </span>
<span id="cb21-1219"><a href="#cb21-1219" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), </span>
<span id="cb21-1220"><a href="#cb21-1220" aria-hidden="true" tabindex="-1"></a>                <span class="at">linewidth =</span> <span class="fl">0.5</span>,</span>
<span id="cb21-1221"><a href="#cb21-1221" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb21-1222"><a href="#cb21-1222" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-1223"><a href="#cb21-1223" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coord_flip() +</span></span>
<span id="cb21-1224"><a href="#cb21-1224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>phe_type, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb21-1225"><a href="#cb21-1225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb21-1226"><a href="#cb21-1226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span></span>
<span id="cb21-1227"><a href="#cb21-1227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb21-1228"><a href="#cb21-1228" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"NY"</span> <span class="ot">=</span> <span class="st">"darkolivegreen4"</span>, <span class="st">"HT"</span> <span class="ot">=</span> <span class="st">"navyblue"</span>, <span class="st">"DV"</span> <span class="ot">=</span> <span class="st">"chocolate"</span>, <span class="st">"ST"</span> <span class="ot">=</span> <span class="st">"purple"</span>)</span>
<span id="cb21-1229"><a href="#cb21-1229" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-1230"><a href="#cb21-1230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>) <span class="sc">+</span></span>
<span id="cb21-1231"><a href="#cb21-1231" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +</span></span>
<span id="cb21-1232"><a href="#cb21-1232" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(aes(label = Estimate, y = Estimate), vjust = -0.9, show.legend = FALSE, size = 3) +</span></span>
<span id="cb21-1233"><a href="#cb21-1233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">alpha =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb21-1234"><a href="#cb21-1234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb21-1235"><a href="#cb21-1235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb21-1236"><a href="#cb21-1236" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb21-1237"><a href="#cb21-1237" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>))</span>
<span id="cb21-1238"><a href="#cb21-1238" aria-hidden="true" tabindex="-1"></a>coef_summary_plot</span>
<span id="cb21-1239"><a href="#cb21-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1240"><a href="#cb21-1240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1241"><a href="#cb21-1241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1242"><a href="#cb21-1242" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.4 Prediction</span></span>
<span id="cb21-1243"><a href="#cb21-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1244"><a href="#cb21-1244" aria-hidden="true" tabindex="-1"></a>More appropriate way to prepresent heterogeneity?</span>
<span id="cb21-1245"><a href="#cb21-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1246"><a href="#cb21-1246" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[ ]</span> The prediction is located at the weather station, because I don't interpolate the weather data to cover the whole city.</span>
<span id="cb21-1247"><a href="#cb21-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1248"><a href="#cb21-1248" aria-hidden="true" tabindex="-1"></a>**Out of sample**</span>
<span id="cb21-1249"><a href="#cb21-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1252"><a href="#cb21-1252" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1253"><a href="#cb21-1253" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_predict</span></span>
<span id="cb21-1254"><a href="#cb21-1254" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-1255"><a href="#cb21-1255" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb21-1256"><a href="#cb21-1256" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Prediction for the `SOS` of Acer in 2023 in New York city. The prediction are made at the weather station."</span></span>
<span id="cb21-1257"><a href="#cb21-1257" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-1258"><a href="#cb21-1258" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb21-1259"><a href="#cb21-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1260"><a href="#cb21-1260" aria-hidden="true" tabindex="-1"></a>NY_Acer_tavg_SOS <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/NY_Acer_tavg_SOS.rds"</span>)</span>
<span id="cb21-1261"><a href="#cb21-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1262"><a href="#cb21-1262" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb21-1263"><a href="#cb21-1263" aria-hidden="true" tabindex="-1"></a>phe_type <span class="ot">=</span> <span class="st">"SOS"</span></span>
<span id="cb21-1264"><a href="#cb21-1264" aria-hidden="true" tabindex="-1"></a>genus <span class="ot">=</span> <span class="st">"Acer"</span></span>
<span id="cb21-1265"><a href="#cb21-1265" aria-hidden="true" tabindex="-1"></a>mean_doy_acer <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tavg_allyear_var.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-1266"><a href="#cb21-1266" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(genus <span class="sc">==</span> <span class="sc">!!</span>genus <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> direction <span class="sc">==</span> <span class="st">"up"</span> ) <span class="sc">%&gt;%</span></span>
<span id="cb21-1267"><a href="#cb21-1267" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">doy =</span> <span class="fu">mean</span>(doy)) <span class="sc">%&gt;%</span></span>
<span id="cb21-1268"><a href="#cb21-1268" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(doy)</span>
<span id="cb21-1269"><a href="#cb21-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1270"><a href="#cb21-1270" aria-hidden="true" tabindex="-1"></a>preseason <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tavg_allyear_pcorr.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-1271"><a href="#cb21-1271" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(genus <span class="sc">==</span> <span class="sc">!!</span>genus <span class="sc">&amp;</span> type <span class="sc">==</span> <span class="sc">!!</span>phe_type) <span class="sc">%&gt;%</span></span>
<span id="cb21-1272"><a href="#cb21-1272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">pre =</span> <span class="fu">mean</span>(optimal_pre_length)) <span class="sc">%&gt;%</span></span>
<span id="cb21-1273"><a href="#cb21-1273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(pre)</span>
<span id="cb21-1274"><a href="#cb21-1274" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">=</span> <span class="fu">make_date</span>(<span class="dv">2023</span>) <span class="sc">+</span> <span class="fu">days</span>(<span class="fu">round</span>(mean_doy_acer) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">-</span> <span class="fu">days</span>(preseason)</span>
<span id="cb21-1275"><a href="#cb21-1275" aria-hidden="true" tabindex="-1"></a>end_date <span class="ot">=</span> <span class="fu">make_date</span>(<span class="dv">2023</span>) <span class="sc">+</span> <span class="fu">days</span>(<span class="fu">round</span>(mean_doy_acer) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb21-1276"><a href="#cb21-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1277"><a href="#cb21-1277" aria-hidden="true" tabindex="-1"></a>NY_weather <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>,city,<span class="st">"/"</span>,city,<span class="st">"_wu.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-1278"><a href="#cb21-1278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">&gt;=</span> start_date <span class="sc">&amp;</span> Date <span class="sc">&lt;=</span> end_date) <span class="sc">%&gt;%</span></span>
<span id="cb21-1279"><a href="#cb21-1279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb21-1280"><a href="#cb21-1280" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">AvgTemp_mean =</span> <span class="fu">mean</span>(AvgTemp),</span>
<span id="cb21-1281"><a href="#cb21-1281" aria-hidden="true" tabindex="-1"></a>            <span class="at">Sum_mm_sum =</span> <span class="fu">sum</span>(Sum_mm),</span>
<span id="cb21-1282"><a href="#cb21-1282" aria-hidden="true" tabindex="-1"></a>            <span class="at">year =</span> <span class="fu">as.factor</span>(<span class="dv">2023</span>))</span>
<span id="cb21-1283"><a href="#cb21-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1284"><a href="#cb21-1284" aria-hidden="true" tabindex="-1"></a>NY_srad <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/raw/"</span>,city,<span class="st">"/Daymet/daily2016-2024/srad_wu_2023.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-1285"><a href="#cb21-1285" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(time <span class="sc">&gt;=</span> start_date <span class="sc">&amp;</span> time <span class="sc">&lt;=</span> end_date) <span class="sc">%&gt;%</span></span>
<span id="cb21-1286"><a href="#cb21-1286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Site) <span class="sc">%&gt;%</span></span>
<span id="cb21-1287"><a href="#cb21-1287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">srad_mean =</span> <span class="fu">mean</span>(value)) <span class="sc">%&gt;%</span></span>
<span id="cb21-1288"><a href="#cb21-1288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(NY_weather, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Site"</span> <span class="ot">=</span> <span class="st">"name"</span>))</span>
<span id="cb21-1289"><a href="#cb21-1289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1290"><a href="#cb21-1290" aria-hidden="true" tabindex="-1"></a>prediction <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>,city,<span class="st">"/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-1291"><a href="#cb21-1291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(NY_srad, <span class="at">by =</span> <span class="st">"Site"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-1292"><a href="#cb21-1292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb21-1293"><a href="#cb21-1293" aria-hidden="true" tabindex="-1"></a>index <span class="ot">&lt;-</span> <span class="fu">inla.stack.index</span>(<span class="at">stack =</span> NY_Acer_tavg_SOS<span class="sc">$</span>stk.full, <span class="at">tag =</span> <span class="st">"pred"</span>)<span class="sc">$</span>data</span>
<span id="cb21-1294"><a href="#cb21-1294" aria-hidden="true" tabindex="-1"></a>coorp <span class="ot">&lt;-</span> prediction[, <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>)]</span>
<span id="cb21-1295"><a href="#cb21-1295" aria-hidden="true" tabindex="-1"></a>pred_mean <span class="ot">&lt;-</span> NY_Acer_tavg_SOS<span class="sc">$</span>res<span class="sc">$</span>summary.fitted.values[index, <span class="st">"mean"</span>]</span>
<span id="cb21-1296"><a href="#cb21-1296" aria-hidden="true" tabindex="-1"></a>pred_ll <span class="ot">&lt;-</span> NY_Acer_tavg_SOS<span class="sc">$</span>res<span class="sc">$</span>summary.fitted.values[index, <span class="st">"0.025quant"</span>]</span>
<span id="cb21-1297"><a href="#cb21-1297" aria-hidden="true" tabindex="-1"></a>pred_ul <span class="ot">&lt;-</span> NY_Acer_tavg_SOS<span class="sc">$</span>res<span class="sc">$</span>summary.fitted.values[index, <span class="st">"0.975quant"</span>]</span>
<span id="cb21-1298"><a href="#cb21-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1299"><a href="#cb21-1299" aria-hidden="true" tabindex="-1"></a>pred_ph_2023 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb21-1300"><a href="#cb21-1300" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb21-1301"><a href="#cb21-1301" aria-hidden="true" tabindex="-1"></a>    <span class="at">Lon =</span> coorp[, <span class="dv">1</span>], <span class="at">Lat =</span> coorp[, <span class="dv">2</span>],</span>
<span id="cb21-1302"><a href="#cb21-1302" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> pred_mean, <span class="at">variable =</span> <span class="st">"pred_mean"</span></span>
<span id="cb21-1303"><a href="#cb21-1303" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb21-1304"><a href="#cb21-1304" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb21-1305"><a href="#cb21-1305" aria-hidden="true" tabindex="-1"></a>    <span class="at">Lon =</span> coorp[, <span class="dv">1</span>], <span class="at">Lat =</span> coorp[, <span class="dv">2</span>],</span>
<span id="cb21-1306"><a href="#cb21-1306" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> pred_ll, <span class="at">variable =</span> <span class="st">"pred_ll"</span></span>
<span id="cb21-1307"><a href="#cb21-1307" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb21-1308"><a href="#cb21-1308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb21-1309"><a href="#cb21-1309" aria-hidden="true" tabindex="-1"></a>    <span class="at">Lon =</span> coorp[, <span class="dv">1</span>], <span class="at">Lat =</span> coorp[, <span class="dv">2</span>],</span>
<span id="cb21-1310"><a href="#cb21-1310" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> pred_ul, <span class="at">variable =</span> <span class="st">"pred_ul"</span></span>
<span id="cb21-1311"><a href="#cb21-1311" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1312"><a href="#cb21-1312" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-1313"><a href="#cb21-1313" aria-hidden="true" tabindex="-1"></a>pred_ph_2023<span class="sc">$</span>variable <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(pred_ph_2023<span class="sc">$</span>variable)</span>
<span id="cb21-1314"><a href="#cb21-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1315"><a href="#cb21-1315" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pred_ph_2023) <span class="sc">+</span></span>
<span id="cb21-1316"><a href="#cb21-1316" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(Lon, Lat, <span class="at">color  =</span> value)) <span class="sc">+</span></span>
<span id="cb21-1317"><a href="#cb21-1317" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable, <span class="at">nrow =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-1318"><a href="#cb21-1318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-1319"><a href="#cb21-1319" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_gradient</span>(</span>
<span id="cb21-1320"><a href="#cb21-1320" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"Predicted SOS</span><span class="sc">\n</span><span class="st">in 2023"</span>,</span>
<span id="cb21-1321"><a href="#cb21-1321" aria-hidden="true" tabindex="-1"></a>    <span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">high =</span> <span class="st">"orange"</span></span>
<span id="cb21-1322"><a href="#cb21-1322" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-1323"><a href="#cb21-1323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span>
<span id="cb21-1324"><a href="#cb21-1324" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1325"><a href="#cb21-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1326"><a href="#cb21-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1327"><a href="#cb21-1327" aria-hidden="true" tabindex="-1"></a>**In sample**</span>
<span id="cb21-1328"><a href="#cb21-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1329"><a href="#cb21-1329" aria-hidden="true" tabindex="-1"></a>Overall, the fitted values show a high consistency with the actual values, with points concentrated around the 1:1 line. Except for GreenDown, the model's fitted values exhibit lower variation.</span>
<span id="cb21-1330"><a href="#cb21-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1333"><a href="#cb21-1333" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1334"><a href="#cb21-1334" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_predict_insample</span></span>
<span id="cb21-1335"><a href="#cb21-1335" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-1336"><a href="#cb21-1336" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb21-1337"><a href="#cb21-1337" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb21-1338"><a href="#cb21-1338" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Comparison between fitted value and ture value in New York city."</span></span>
<span id="cb21-1339"><a href="#cb21-1339" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-1340"><a href="#cb21-1340" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb21-1341"><a href="#cb21-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1342"><a href="#cb21-1342" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/inla_year_random/insample_pred/"</span></span>
<span id="cb21-1343"><a href="#cb21-1343" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^NY.*</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb21-1344"><a href="#cb21-1344" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-1345"><a href="#cb21-1345" aria-hidden="true" tabindex="-1"></a>compare <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb21-1346"><a href="#cb21-1346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1347"><a href="#cb21-1347" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb21-1348"><a href="#cb21-1348" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb21-1349"><a href="#cb21-1349" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1350"><a href="#cb21-1350" aria-hidden="true" tabindex="-1"></a>  phe_type <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">3"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1351"><a href="#cb21-1351" aria-hidden="true" tabindex="-1"></a>  compare_one <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">t</span>(model_data<span class="sc">$</span>compare)) <span class="sc">%&gt;%</span></span>
<span id="cb21-1352"><a href="#cb21-1352" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">as.numeric</span>(value), </span>
<span id="cb21-1353"><a href="#cb21-1353" aria-hidden="true" tabindex="-1"></a>           <span class="at">true_value =</span> <span class="fu">as.numeric</span>(true_value),</span>
<span id="cb21-1354"><a href="#cb21-1354" aria-hidden="true" tabindex="-1"></a>           <span class="at">genus =</span> genus,</span>
<span id="cb21-1355"><a href="#cb21-1355" aria-hidden="true" tabindex="-1"></a>           <span class="at">phe_type =</span> phe_type)</span>
<span id="cb21-1356"><a href="#cb21-1356" aria-hidden="true" tabindex="-1"></a>  compare <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(compare, compare_one)}</span>
<span id="cb21-1357"><a href="#cb21-1357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1358"><a href="#cb21-1358" aria-hidden="true" tabindex="-1"></a><span class="co"># slope_data &lt;- compare %&gt;%</span></span>
<span id="cb21-1359"><a href="#cb21-1359" aria-hidden="true" tabindex="-1"></a><span class="co">#   group_by(phe_type) %&gt;%</span></span>
<span id="cb21-1360"><a href="#cb21-1360" aria-hidden="true" tabindex="-1"></a><span class="co">#   summarise(slope = round(coef(lm(value ~ true_value, data = cur_data()))[2], 3),</span></span>
<span id="cb21-1361"><a href="#cb21-1361" aria-hidden="true" tabindex="-1"></a><span class="co">#             mean_x = mean(true_value, na.rm = TRUE),</span></span>
<span id="cb21-1362"><a href="#cb21-1362" aria-hidden="true" tabindex="-1"></a><span class="co">#             mean_y = mean(value, na.rm = TRUE)) </span></span>
<span id="cb21-1363"><a href="#cb21-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1364"><a href="#cb21-1364" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(compare, <span class="fu">aes</span>(<span class="at">x =</span> true_value, <span class="at">y =</span> value, <span class="at">color=</span> genus)) <span class="sc">+</span></span>
<span id="cb21-1365"><a href="#cb21-1365" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb21-1366"><a href="#cb21-1366" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb21-1367"><a href="#cb21-1367" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_smooth(method = "lm", formula = y ~ x, se = FALSE, color = "blue") +</span></span>
<span id="cb21-1368"><a href="#cb21-1368" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(data = slope_data, aes(x = mean_x, y = mean_y, label = paste("Slope =", slope)),color = "blue", size = 5, inherit.aes = FALSE) +</span></span>
<span id="cb21-1369"><a href="#cb21-1369" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> <span class="fu">factor</span>(phe_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)),</span>
<span id="cb21-1370"><a href="#cb21-1370" aria-hidden="true" tabindex="-1"></a>             <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb21-1371"><a href="#cb21-1371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"True value"</span>, <span class="at">y =</span> <span class="st">"Fitted value"</span>) <span class="sc">+</span></span>
<span id="cb21-1372"><a href="#cb21-1372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>()</span>
<span id="cb21-1373"><a href="#cb21-1373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1374"><a href="#cb21-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1375"><a href="#cb21-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1376"><a href="#cb21-1376" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4 Model validation</span></span>
<span id="cb21-1377"><a href="#cb21-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1378"><a href="#cb21-1378" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4.1 Check spatial autocorrelation</span></span>
<span id="cb21-1379"><a href="#cb21-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1380"><a href="#cb21-1380" aria-hidden="true" tabindex="-1"></a>First, I fitted a linear mixed-effects model for each genus with environmental variables (<span class="in">`AvgTemp_mean`</span>, <span class="in">`Sum_mm_sum`</span>, and <span class="in">`srad_mean`</span>) as predictors, with random effects for <span class="in">`year`</span> and <span class="in">`id`</span>, which represent temporal (<span class="in">`(1 | year)`</span>) and spatial (<span class="in">`(1 | id)`</span>) randomness, respectively.</span>
<span id="cb21-1381"><a href="#cb21-1381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1382"><a href="#cb21-1382" aria-hidden="true" tabindex="-1"></a>Then I conducted a variance decomposition analysis and compared the proportion of total variance explained by spatial effects and temporal effects respectively. Generally, spatial and temporal variations are both present, but their contributions vary across different genera. Some genera show higher spatial effects, while others have more balanced contributions from spatial and year components.</span>
<span id="cb21-1383"><a href="#cb21-1383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1386"><a href="#cb21-1386" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1387"><a href="#cb21-1387" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-check_variance</span></span>
<span id="cb21-1388"><a href="#cb21-1388" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-1389"><a href="#cb21-1389" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-1390"><a href="#cb21-1390" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Variance decomposition analysis for spatial and temporal effects"</span></span>
<span id="cb21-1391"><a href="#cb21-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1392"><a href="#cb21-1392" aria-hidden="true" tabindex="-1"></a>tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/DV/tavg_allyear_var.rds"</span>)</span>
<span id="cb21-1393"><a href="#cb21-1393" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb21-1394"><a href="#cb21-1394" aria-hidden="true" tabindex="-1"></a>all_genus <span class="ot">&lt;-</span> <span class="fu">unique</span>(tavg_allyear_var<span class="sc">$</span>genus)</span>
<span id="cb21-1395"><a href="#cb21-1395" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-1396"><a href="#cb21-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1397"><a href="#cb21-1397" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb21-1398"><a href="#cb21-1398" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"SOS"</span>) {</span>
<span id="cb21-1399"><a href="#cb21-1399" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb21-1400"><a href="#cb21-1400" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb21-1401"><a href="#cb21-1401" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb21-1402"><a href="#cb21-1402" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"EOS"</span>) {</span>
<span id="cb21-1403"><a href="#cb21-1403" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy"</span></span>
<span id="cb21-1404"><a href="#cb21-1404" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb21-1405"><a href="#cb21-1405" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb21-1406"><a href="#cb21-1406" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (phe_type <span class="sc">==</span> <span class="st">"GreenUp"</span>) {</span>
<span id="cb21-1407"><a href="#cb21-1407" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb21-1408"><a href="#cb21-1408" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"up"</span></span>
<span id="cb21-1409"><a href="#cb21-1409" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb21-1410"><a href="#cb21-1410" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb21-1411"><a href="#cb21-1411" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb21-1412"><a href="#cb21-1412" aria-hidden="true" tabindex="-1"></a>    phe_metric <span class="ot">&lt;-</span> <span class="st">"doy_diff"</span></span>
<span id="cb21-1413"><a href="#cb21-1413" aria-hidden="true" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> <span class="st">"down"</span></span>
<span id="cb21-1414"><a href="#cb21-1414" aria-hidden="true" tabindex="-1"></a>    thres <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb21-1415"><a href="#cb21-1415" aria-hidden="true" tabindex="-1"></a>    tavg_allyear_var<span class="sc">$</span>doy_diff <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(tavg_allyear_var<span class="sc">$</span>doy_diff)</span>
<span id="cb21-1416"><a href="#cb21-1416" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-1417"><a href="#cb21-1417" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-1418"><a href="#cb21-1418" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (genus <span class="cf">in</span> all_genus) {</span>
<span id="cb21-1419"><a href="#cb21-1419" aria-hidden="true" tabindex="-1"></a>      tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb21-1420"><a href="#cb21-1420" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="sc">!!</span>direction <span class="sc">&amp;</span> thres <span class="sc">==</span> thres <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb21-1421"><a href="#cb21-1421" aria-hidden="true" tabindex="-1"></a>        <span class="fu">na.omit</span>()</span>
<span id="cb21-1422"><a href="#cb21-1422" aria-hidden="true" tabindex="-1"></a>      model <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste0</span>(phe_metric, <span class="st">" ~ AvgTemp_mean + Sum_mm_sum + srad_mean + (1|year) + (1 | id)"</span>))</span>
<span id="cb21-1423"><a href="#cb21-1423" aria-hidden="true" tabindex="-1"></a>      full_model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(model, <span class="at">data =</span> tavg_SOS)</span>
<span id="cb21-1424"><a href="#cb21-1424" aria-hidden="true" tabindex="-1"></a>      var_components <span class="ot">&lt;-</span> <span class="fu">VarCorr</span>(full_model)</span>
<span id="cb21-1425"><a href="#cb21-1425" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-1426"><a href="#cb21-1426" aria-hidden="true" tabindex="-1"></a>      total_variance <span class="ot">&lt;-</span>  var_components<span class="sc">$</span>id[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">+</span>  var_components<span class="sc">$</span>year[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">attr</span>(var_components, <span class="st">"sc"</span>)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb21-1427"><a href="#cb21-1427" aria-hidden="true" tabindex="-1"></a>      spatial_contribution <span class="ot">&lt;-</span> var_components<span class="sc">$</span>id[<span class="dv">1</span>, <span class="dv">1</span>]  <span class="sc">/</span> total_variance</span>
<span id="cb21-1428"><a href="#cb21-1428" aria-hidden="true" tabindex="-1"></a>      year_contribution <span class="ot">&lt;-</span>  var_components<span class="sc">$</span>year[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">/</span> total_variance</span>
<span id="cb21-1429"><a href="#cb21-1429" aria-hidden="true" tabindex="-1"></a>      residual_contribution <span class="ot">&lt;-</span> <span class="fu">attr</span>(var_components, <span class="st">"sc"</span>)<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> total_variance</span>
<span id="cb21-1430"><a href="#cb21-1430" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb21-1431"><a href="#cb21-1431" aria-hidden="true" tabindex="-1"></a>      variance_components <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-1432"><a href="#cb21-1432" aria-hidden="true" tabindex="-1"></a>            <span class="at">Metric =</span> phe_type,</span>
<span id="cb21-1433"><a href="#cb21-1433" aria-hidden="true" tabindex="-1"></a>            <span class="at">Genus =</span> genus,</span>
<span id="cb21-1434"><a href="#cb21-1434" aria-hidden="true" tabindex="-1"></a>            <span class="at">Component =</span> <span class="fu">c</span>(<span class="st">"Spatial"</span>, <span class="st">"Year"</span>, <span class="st">"Residual"</span>),</span>
<span id="cb21-1435"><a href="#cb21-1435" aria-hidden="true" tabindex="-1"></a>            <span class="at">Variance =</span> <span class="fu">c</span>(spatial_contribution, year_contribution, residual_contribution)</span>
<span id="cb21-1436"><a href="#cb21-1436" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb21-1437"><a href="#cb21-1437" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb21-1438"><a href="#cb21-1438" aria-hidden="true" tabindex="-1"></a>          results[[<span class="fu">paste</span>(phe_type, genus, <span class="at">sep =</span> <span class="st">"_"</span>)]] <span class="ot">&lt;-</span> variance_components</span>
<span id="cb21-1439"><a href="#cb21-1439" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-1440"><a href="#cb21-1440" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1441"><a href="#cb21-1441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1442"><a href="#cb21-1442" aria-hidden="true" tabindex="-1"></a>final_results <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, results)</span>
<span id="cb21-1443"><a href="#cb21-1443" aria-hidden="true" tabindex="-1"></a>final_results <span class="ot">&lt;-</span> final_results <span class="sc">%&gt;%</span></span>
<span id="cb21-1444"><a href="#cb21-1444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Metric, Genus) <span class="sc">%&gt;%</span></span>
<span id="cb21-1445"><a href="#cb21-1445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Variance_Proportion =</span> Variance <span class="sc">/</span> <span class="fu">sum</span>(Variance),</span>
<span id="cb21-1446"><a href="#cb21-1446" aria-hidden="true" tabindex="-1"></a>         <span class="at">Component =</span> <span class="fu">factor</span>(Component, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Spatial"</span>, <span class="st">"Residual"</span>, <span class="st">"Year"</span>)),</span>
<span id="cb21-1447"><a href="#cb21-1447" aria-hidden="true" tabindex="-1"></a>         <span class="at">Metric =</span> <span class="fu">factor</span>(Metric, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)))</span>
<span id="cb21-1448"><a href="#cb21-1448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1449"><a href="#cb21-1449" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(final_results, <span class="fu">aes</span>(<span class="at">x =</span> Genus, <span class="at">y =</span> Variance_Proportion, <span class="at">fill =</span> Component)) <span class="sc">+</span></span>
<span id="cb21-1450"><a href="#cb21-1450" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"stack"</span>) <span class="sc">+</span></span>
<span id="cb21-1451"><a href="#cb21-1451" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Metric, <span class="at">scales =</span> <span class="st">"free_x"</span>) <span class="sc">+</span></span>
<span id="cb21-1452"><a href="#cb21-1452" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Genus"</span>, <span class="at">y =</span> <span class="st">"Variance Proportion"</span>, <span class="at">fill =</span> <span class="st">"Component"</span>) <span class="sc">+</span></span>
<span id="cb21-1453"><a href="#cb21-1453" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb21-1454"><a href="#cb21-1454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb21-1455"><a href="#cb21-1455" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">"Set2"</span>) </span>
<span id="cb21-1456"><a href="#cb21-1456" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1457"><a href="#cb21-1457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1458"><a href="#cb21-1458" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Using `SOS` as an example, I used `check_heteroscedasticity()` to check for heteroscedasticity in the residuals. The results showed almost every model had heterogenerous residuals. --&gt;</span></span>
<span id="cb21-1459"><a href="#cb21-1459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1460"><a href="#cb21-1460" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- For fixed-effect model (`SOS` \~ `AvgTemp_mean` + `Sum_mm_sum` + `srad_mean`), `Global Moran I` for regression residuals test indicates the presence of spatial autocorrelation in the residuals. `Lagrange Multiplier` test suggests the spatial model should be applied. --&gt;</span></span>
<span id="cb21-1461"><a href="#cb21-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1462"><a href="#cb21-1462" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- I computed the empirical semivariogram for the residuals to analyze spatial structure. The optimal theoretical semivariogram models (among Exp, Sph, Gau, Mat) were chosen to empirical semivariogram using `fit.variogram()`. --&gt;</span></span>
<span id="cb21-1463"><a href="#cb21-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1466"><a href="#cb21-1466" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1467"><a href="#cb21-1467" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check_sp_auto</span></span>
<span id="cb21-1468"><a href="#cb21-1468" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-1469"><a href="#cb21-1469" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-1470"><a href="#cb21-1470" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-1471"><a href="#cb21-1471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1472"><a href="#cb21-1472" aria-hidden="true" tabindex="-1"></a>tavg_allyear_var <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/ST/tavg_allyear_var.rds"</span>)</span>
<span id="cb21-1473"><a href="#cb21-1473" aria-hidden="true" tabindex="-1"></a>genera <span class="ot">&lt;-</span> <span class="fu">unique</span>(tavg_allyear_var<span class="sc">$</span>genus)</span>
<span id="cb21-1474"><a href="#cb21-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1475"><a href="#cb21-1475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1476"><a href="#cb21-1476" aria-hidden="true" tabindex="-1"></a>variogram_sos <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-1477"><a href="#cb21-1477" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb21-1478"><a href="#cb21-1478" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb21-1479"><a href="#cb21-1479" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb21-1480"><a href="#cb21-1480" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"up"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb21-1481"><a href="#cb21-1481" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb21-1482"><a href="#cb21-1482" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb21-1483"><a href="#cb21-1483" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb21-1484"><a href="#cb21-1484" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb21-1485"><a href="#cb21-1485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1486"><a href="#cb21-1486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb21-1487"><a href="#cb21-1487" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-1488"><a href="#cb21-1488" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb21-1489"><a href="#cb21-1489" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb21-1490"><a href="#cb21-1490" aria-hidden="true" tabindex="-1"></a>  variogram_sos[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-1491"><a href="#cb21-1491" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb21-1492"><a href="#cb21-1492" aria-hidden="true" tabindex="-1"></a>    <span class="at">SOS =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb21-1493"><a href="#cb21-1493" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1494"><a href="#cb21-1494" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1495"><a href="#cb21-1495" aria-hidden="true" tabindex="-1"></a>variogram_sos <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_sos)</span>
<span id="cb21-1496"><a href="#cb21-1496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1497"><a href="#cb21-1497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1498"><a href="#cb21-1498" aria-hidden="true" tabindex="-1"></a>variogram_eos <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-1499"><a href="#cb21-1499" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb21-1500"><a href="#cb21-1500" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb21-1501"><a href="#cb21-1501" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb21-1502"><a href="#cb21-1502" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"down"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.5</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb21-1503"><a href="#cb21-1503" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb21-1504"><a href="#cb21-1504" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb21-1505"><a href="#cb21-1505" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb21-1506"><a href="#cb21-1506" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb21-1507"><a href="#cb21-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1508"><a href="#cb21-1508" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb21-1509"><a href="#cb21-1509" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-1510"><a href="#cb21-1510" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb21-1511"><a href="#cb21-1511" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb21-1512"><a href="#cb21-1512" aria-hidden="true" tabindex="-1"></a>  variogram_eos[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-1513"><a href="#cb21-1513" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb21-1514"><a href="#cb21-1514" aria-hidden="true" tabindex="-1"></a>    <span class="at">EOS =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb21-1515"><a href="#cb21-1515" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1516"><a href="#cb21-1516" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1517"><a href="#cb21-1517" aria-hidden="true" tabindex="-1"></a>variogram_eos <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_eos)</span>
<span id="cb21-1518"><a href="#cb21-1518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1519"><a href="#cb21-1519" aria-hidden="true" tabindex="-1"></a>variogram_up <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-1520"><a href="#cb21-1520" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb21-1521"><a href="#cb21-1521" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb21-1522"><a href="#cb21-1522" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb21-1523"><a href="#cb21-1523" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"up"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.2</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb21-1524"><a href="#cb21-1524" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">doy_diff =</span> <span class="fu">as.numeric</span>(doy_diff))<span class="sc">%&gt;%</span></span>
<span id="cb21-1525"><a href="#cb21-1525" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb21-1526"><a href="#cb21-1526" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy_diff <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb21-1527"><a href="#cb21-1527" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb21-1528"><a href="#cb21-1528" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb21-1529"><a href="#cb21-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1530"><a href="#cb21-1530" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb21-1531"><a href="#cb21-1531" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-1532"><a href="#cb21-1532" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb21-1533"><a href="#cb21-1533" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb21-1534"><a href="#cb21-1534" aria-hidden="true" tabindex="-1"></a>  variogram_up[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-1535"><a href="#cb21-1535" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb21-1536"><a href="#cb21-1536" aria-hidden="true" tabindex="-1"></a>    <span class="at">GreenUp =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb21-1537"><a href="#cb21-1537" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1538"><a href="#cb21-1538" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1539"><a href="#cb21-1539" aria-hidden="true" tabindex="-1"></a>variogram_up <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_up)</span>
<span id="cb21-1540"><a href="#cb21-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1541"><a href="#cb21-1541" aria-hidden="true" tabindex="-1"></a>variogram_down <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-1542"><a href="#cb21-1542" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">14</span>) {</span>
<span id="cb21-1543"><a href="#cb21-1543" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">=</span> genera[i]</span>
<span id="cb21-1544"><a href="#cb21-1544" aria-hidden="true" tabindex="-1"></a>  tavg_SOS <span class="ot">&lt;-</span> tavg_allyear_var <span class="sc">%&gt;%</span></span>
<span id="cb21-1545"><a href="#cb21-1545" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(direction <span class="sc">==</span> <span class="st">"down"</span> <span class="sc">&amp;</span> thres <span class="sc">==</span> <span class="fl">0.2</span> <span class="sc">&amp;</span> genus <span class="sc">==</span> <span class="sc">!!</span>genus) <span class="sc">%&gt;%</span></span>
<span id="cb21-1546"><a href="#cb21-1546" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">doy_diff =</span> <span class="fu">as.numeric</span>(doy_diff))<span class="sc">%&gt;%</span></span>
<span id="cb21-1547"><a href="#cb21-1547" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb21-1548"><a href="#cb21-1548" aria-hidden="true" tabindex="-1"></a>  random_OLS <span class="ot">&lt;-</span> <span class="fu">lmer</span>(doy_diff <span class="sc">~</span> AvgTemp_mean <span class="sc">+</span> Sum_mm_sum <span class="sc">+</span> srad_mean <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>year), <span class="at">data =</span> tavg_SOS)</span>
<span id="cb21-1549"><a href="#cb21-1549" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(check_heteroscedasticity(random_OLS))</span></span>
<span id="cb21-1550"><a href="#cb21-1550" aria-hidden="true" tabindex="-1"></a>  tavg_SOS<span class="sc">$</span>residual_random <span class="ot">&lt;-</span> tavg_SOS<span class="sc">$</span>doy <span class="sc">-</span> <span class="fu">fitted</span>(random_OLS)</span>
<span id="cb21-1551"><a href="#cb21-1551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1552"><a href="#cb21-1552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coordinates</span>(tavg_SOS) <span class="ot">&lt;-</span> <span class="er">~</span> lon <span class="sc">+</span> lat</span>
<span id="cb21-1553"><a href="#cb21-1553" aria-hidden="true" tabindex="-1"></a>  vgm.emt <span class="ot">&lt;-</span> <span class="fu">variogram</span>(residual_random <span class="sc">~</span> <span class="dv">1</span>, tavg_SOS, <span class="at">cloud =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-1554"><a href="#cb21-1554" aria-hidden="true" tabindex="-1"></a>  vgm.las.init <span class="ot">&lt;-</span> <span class="fu">vgm</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"Exp"</span>, <span class="st">"Sph"</span>, <span class="st">"Gau"</span>, <span class="st">"Mat"</span>))</span>
<span id="cb21-1555"><a href="#cb21-1555" aria-hidden="true" tabindex="-1"></a>  vgm_exn_fit <span class="ot">&lt;-</span> <span class="fu">fit.variogram</span>(vgm.emt, vgm.las.init)</span>
<span id="cb21-1556"><a href="#cb21-1556" aria-hidden="true" tabindex="-1"></a>  variogram_down[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-1557"><a href="#cb21-1557" aria-hidden="true" tabindex="-1"></a>    <span class="at">genus =</span> genus,</span>
<span id="cb21-1558"><a href="#cb21-1558" aria-hidden="true" tabindex="-1"></a>    <span class="at">GreenDown =</span> vgm_exn_fit<span class="sc">$</span>model</span>
<span id="cb21-1559"><a href="#cb21-1559" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1560"><a href="#cb21-1560" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1561"><a href="#cb21-1561" aria-hidden="true" tabindex="-1"></a>variogram_down <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, variogram_down)</span>
<span id="cb21-1562"><a href="#cb21-1562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1563"><a href="#cb21-1563" aria-hidden="true" tabindex="-1"></a>variogram_summary <span class="ot">&lt;-</span> variogram_sos <span class="sc">%&gt;%</span></span>
<span id="cb21-1564"><a href="#cb21-1564" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_eos, <span class="at">by =</span> <span class="st">"genus"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-1565"><a href="#cb21-1565" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_up, <span class="at">by =</span> <span class="st">"genus"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-1566"><a href="#cb21-1566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(variogram_down, <span class="at">by =</span> <span class="st">"genus"</span>)</span>
<span id="cb21-1567"><a href="#cb21-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1568"><a href="#cb21-1568" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(variogram_summary, <span class="at">caption =</span> <span class="st">"Fitted semivariogram model for each genus"</span>)</span>
<span id="cb21-1569"><a href="#cb21-1569" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1570"><a href="#cb21-1570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1571"><a href="#cb21-1571" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Sph: 26, Mat: 22, Gau: 4, Exp: 4 HT: Sph, Mat --&gt;</span></span>
<span id="cb21-1572"><a href="#cb21-1572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1573"><a href="#cb21-1573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1574"><a href="#cb21-1574" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4.2 Simulation for model's validation</span></span>
<span id="cb21-1575"><a href="#cb21-1575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1576"><a href="#cb21-1576" aria-hidden="true" tabindex="-1"></a>Potential issue:</span>
<span id="cb21-1577"><a href="#cb21-1577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1578"><a href="#cb21-1578" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[x]</span> The variance among years may be captured by the spatial covariance.</span>
<span id="cb21-1579"><a href="#cb21-1579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1580"><a href="#cb21-1580" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="va">[x]</span> The covariance matrix is incorrectly specified.</span>
<span id="cb21-1581"><a href="#cb21-1581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1582"><a href="#cb21-1582" aria-hidden="true" tabindex="-1"></a>In this step, I primarily aimed to simulate data to verify whether the model is feasible and whether INLA can effectively capture the model parameters and assess uncertainty. Additionally, I examined whether the method can still detect signals when an incorrect covariance matrix is specified.</span>
<span id="cb21-1583"><a href="#cb21-1583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1584"><a href="#cb21-1584" aria-hidden="true" tabindex="-1"></a>I simulated the data with the true slope of <span class="in">`Avg_temp`</span> is **-2**. Both spatial covariance and temporal variance are included, and spatial covariance just happened among the records from the same year. Some records happen in the same location.</span>
<span id="cb21-1585"><a href="#cb21-1585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1586"><a href="#cb21-1586" aria-hidden="true" tabindex="-1"></a>**The results demonstrate that this modeling approach is feasible.**</span>
<span id="cb21-1587"><a href="#cb21-1587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1590"><a href="#cb21-1590" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1591"><a href="#cb21-1591" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-model_simulate</span></span>
<span id="cb21-1592"><a href="#cb21-1592" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-1593"><a href="#cb21-1593" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-1594"><a href="#cb21-1594" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: false</span></span>
<span id="cb21-1595"><a href="#cb21-1595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1596"><a href="#cb21-1596" aria-hidden="true" tabindex="-1"></a><span class="do">################ Make up the simulation data ################</span></span>
<span id="cb21-1597"><a href="#cb21-1597" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb21-1598"><a href="#cb21-1598" aria-hidden="true" tabindex="-1"></a>lon_range <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">74.25156</span>, <span class="sc">-</span><span class="fl">73.70623</span>)</span>
<span id="cb21-1599"><a href="#cb21-1599" aria-hidden="true" tabindex="-1"></a>lat_range <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">40.50458</span>, <span class="fl">40.91093</span>)</span>
<span id="cb21-1600"><a href="#cb21-1600" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">200</span> </span>
<span id="cb21-1601"><a href="#cb21-1601" aria-hidden="true" tabindex="-1"></a>lon <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="at">min =</span> lon_range[<span class="dv">1</span>], <span class="at">max =</span> lon_range[<span class="dv">2</span>])</span>
<span id="cb21-1602"><a href="#cb21-1602" aria-hidden="true" tabindex="-1"></a>lat <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="at">min =</span> lat_range[<span class="dv">1</span>], <span class="at">max =</span> lat_range[<span class="dv">2</span>])</span>
<span id="cb21-1603"><a href="#cb21-1603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1604"><a href="#cb21-1604" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="dv">2017</span><span class="sc">:</span><span class="dv">2023</span></span>
<span id="cb21-1605"><a href="#cb21-1605" aria-hidden="true" tabindex="-1"></a>nyears <span class="ot">&lt;-</span> <span class="fu">length</span>(years)</span>
<span id="cb21-1606"><a href="#cb21-1606" aria-hidden="true" tabindex="-1"></a>year <span class="ot">&lt;-</span> <span class="fu">sample</span>(years, N, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-1607"><a href="#cb21-1607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1608"><a href="#cb21-1608" aria-hidden="true" tabindex="-1"></a><span class="co"># fix effects: intercept, tavg, precp, srad</span></span>
<span id="cb21-1609"><a href="#cb21-1609" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">&lt;-</span> <span class="dv">120</span></span>
<span id="cb21-1610"><a href="#cb21-1610" aria-hidden="true" tabindex="-1"></a>tavg <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">0</span>, <span class="dv">25</span>)</span>
<span id="cb21-1611"><a href="#cb21-1611" aria-hidden="true" tabindex="-1"></a>precp <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">0</span>, <span class="dv">500</span>)</span>
<span id="cb21-1612"><a href="#cb21-1612" aria-hidden="true" tabindex="-1"></a>srad <span class="ot">&lt;-</span> <span class="fu">runif</span>(N, <span class="dv">300</span>, <span class="dv">450</span>)</span>
<span id="cb21-1613"><a href="#cb21-1613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1614"><a href="#cb21-1614" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="fu">c</span>(intercept, <span class="sc">-</span><span class="dv">2</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>)</span>
<span id="cb21-1615"><a href="#cb21-1615" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="dv">1</span>, tavg, precp, srad)</span>
<span id="cb21-1616"><a href="#cb21-1616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1617"><a href="#cb21-1617" aria-hidden="true" tabindex="-1"></a><span class="co"># spatial effect</span></span>
<span id="cb21-1618"><a href="#cb21-1618" aria-hidden="true" tabindex="-1"></a>sigma.sq <span class="ot">&lt;-</span> <span class="dv">80</span></span>
<span id="cb21-1619"><a href="#cb21-1619" aria-hidden="true" tabindex="-1"></a>phi <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb21-1620"><a href="#cb21-1620" aria-hidden="true" tabindex="-1"></a>spatial_effect <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb21-1621"><a href="#cb21-1621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1622"><a href="#cb21-1622" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (y <span class="cf">in</span> years) {</span>
<span id="cb21-1623"><a href="#cb21-1623" aria-hidden="true" tabindex="-1"></a>  year_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(year <span class="sc">==</span> y)</span>
<span id="cb21-1624"><a href="#cb21-1624" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(year_idx) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb21-1625"><a href="#cb21-1625" aria-hidden="true" tabindex="-1"></a>    lon_year <span class="ot">&lt;-</span> lon[year_idx]</span>
<span id="cb21-1626"><a href="#cb21-1626" aria-hidden="true" tabindex="-1"></a>    lat_year <span class="ot">&lt;-</span> lat[year_idx]</span>
<span id="cb21-1627"><a href="#cb21-1627" aria-hidden="true" tabindex="-1"></a>    dist_matrix_year <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">cbind</span>(lon_year, lat_year)))</span>
<span id="cb21-1628"><a href="#cb21-1628" aria-hidden="true" tabindex="-1"></a>    cov_matrix_year <span class="ot">&lt;-</span> sigma.sq <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span>phi <span class="sc">*</span> dist_matrix_year)</span>
<span id="cb21-1629"><a href="#cb21-1629" aria-hidden="true" tabindex="-1"></a>    spatial_effect[year_idx] <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(<span class="dv">1</span>, <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(year_idx)), <span class="at">Sigma =</span> cov_matrix_year)</span>
<span id="cb21-1630"><a href="#cb21-1630" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb21-1631"><a href="#cb21-1631" aria-hidden="true" tabindex="-1"></a>    spatial_effect[year_idx] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb21-1632"><a href="#cb21-1632" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb21-1633"><a href="#cb21-1633" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1634"><a href="#cb21-1634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1635"><a href="#cb21-1635" aria-hidden="true" tabindex="-1"></a><span class="co"># year effect</span></span>
<span id="cb21-1636"><a href="#cb21-1636" aria-hidden="true" tabindex="-1"></a>year_effect <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nyears, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">1</span>)</span>
<span id="cb21-1637"><a href="#cb21-1637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1638"><a href="#cb21-1638" aria-hidden="true" tabindex="-1"></a>mu <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb21-1639"><a href="#cb21-1639" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">numeric</span>(N)</span>
<span id="cb21-1640"><a href="#cb21-1640" aria-hidden="true" tabindex="-1"></a>tau <span class="ot">&lt;-</span> <span class="dv">1</span> </span>
<span id="cb21-1641"><a href="#cb21-1641" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>N) {</span>
<span id="cb21-1642"><a href="#cb21-1642" aria-hidden="true" tabindex="-1"></a>  year_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(years <span class="sc">==</span> year[i])</span>
<span id="cb21-1643"><a href="#cb21-1643" aria-hidden="true" tabindex="-1"></a>  mu[i] <span class="ot">&lt;-</span> X[i,] <span class="sc">%*%</span> beta <span class="sc">+</span> spatial_effect[i] <span class="sc">+</span> year_effect[year_idx]</span>
<span id="cb21-1644"><a href="#cb21-1644" aria-hidden="true" tabindex="-1"></a>  y[i] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="at">mean =</span> mu[i], <span class="at">sd =</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span>tau))</span>
<span id="cb21-1645"><a href="#cb21-1645" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1646"><a href="#cb21-1646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1647"><a href="#cb21-1647" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-1648"><a href="#cb21-1648" aria-hidden="true" tabindex="-1"></a>  <span class="at">lon =</span> lon,</span>
<span id="cb21-1649"><a href="#cb21-1649" aria-hidden="true" tabindex="-1"></a>  <span class="at">lat =</span> lat,</span>
<span id="cb21-1650"><a href="#cb21-1650" aria-hidden="true" tabindex="-1"></a>  <span class="at">year =</span> year,</span>
<span id="cb21-1651"><a href="#cb21-1651" aria-hidden="true" tabindex="-1"></a>  <span class="at">AvgTemp_mean =</span> tavg,</span>
<span id="cb21-1652"><a href="#cb21-1652" aria-hidden="true" tabindex="-1"></a>  <span class="at">Sum_mm_sum =</span> precp,</span>
<span id="cb21-1653"><a href="#cb21-1653" aria-hidden="true" tabindex="-1"></a>  <span class="at">srad_mean =</span> srad,</span>
<span id="cb21-1654"><a href="#cb21-1654" aria-hidden="true" tabindex="-1"></a>  <span class="at">spatial_effect =</span> spatial_effect,</span>
<span id="cb21-1655"><a href="#cb21-1655" aria-hidden="true" tabindex="-1"></a>  <span class="at">doy =</span> y</span>
<span id="cb21-1656"><a href="#cb21-1656" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-1657"><a href="#cb21-1657" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1658"><a href="#cb21-1658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1661"><a href="#cb21-1661" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1662"><a href="#cb21-1662" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-model_simulate_check</span></span>
<span id="cb21-1663"><a href="#cb21-1663" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb21-1664"><a href="#cb21-1664" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 3</span></span>
<span id="cb21-1665"><a href="#cb21-1665" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The distribution of posterior for Temp coeffeicent using simulated data."</span></span>
<span id="cb21-1666"><a href="#cb21-1666" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-1667"><a href="#cb21-1667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1668"><a href="#cb21-1668" aria-hidden="true" tabindex="-1"></a><span class="do">################ Result form Nimble using 4 model ################</span></span>
<span id="cb21-1669"><a href="#cb21-1669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1670"><a href="#cb21-1670" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/sp_model/"</span></span>
<span id="cb21-1671"><a href="#cb21-1671" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> <span class="st">"^SIM.*Exp</span><span class="sc">\\</span><span class="st">.rds$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-1672"><a href="#cb21-1672" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb21-1673"><a href="#cb21-1673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1674"><a href="#cb21-1674" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb21-1675"><a href="#cb21-1675" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb21-1676"><a href="#cb21-1676" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">".*SIM_(.*?)_tavg_SOS_Exp</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1677"><a href="#cb21-1677" aria-hidden="true" tabindex="-1"></a>  beta_label <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Parameter =</span> <span class="st">"beta[2]"</span>, <span class="at">Label =</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb21-1678"><a href="#cb21-1678" aria-hidden="true" tabindex="-1"></a>  param_data <span class="ot">&lt;-</span> <span class="fu">ggs</span>(model_data<span class="sc">$</span>samples, <span class="at">par_labels =</span> beta_label) <span class="sc">%&gt;%</span></span>
<span id="cb21-1679"><a href="#cb21-1679" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(Parameter <span class="sc">==</span> <span class="st">"AvgTemp"</span>)</span>
<span id="cb21-1680"><a href="#cb21-1680" aria-hidden="true" tabindex="-1"></a>  beta_median <span class="ot">&lt;-</span> <span class="fu">median</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb21-1681"><a href="#cb21-1681" aria-hidden="true" tabindex="-1"></a>  beta_mean <span class="ot">&lt;-</span> <span class="fu">mean</span>(param_data<span class="sc">$</span>value)</span>
<span id="cb21-1682"><a href="#cb21-1682" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> param_data <span class="sc">%&gt;%</span></span>
<span id="cb21-1683"><a href="#cb21-1683" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggs_density</span>() <span class="sc">+</span></span>
<span id="cb21-1684"><a href="#cb21-1684" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb21-1685"><a href="#cb21-1685" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Model:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb21-1686"><a href="#cb21-1686" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) <span class="sc">+</span></span>
<span id="cb21-1687"><a href="#cb21-1687" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_median, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Median: "</span>, <span class="fu">round</span>(beta_median, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb21-1688"><a href="#cb21-1688" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> beta_mean, <span class="at">y =</span> <span class="dv">2</span>, <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean: "</span>, <span class="fu">round</span>(beta_mean, <span class="dv">2</span>)),<span class="at">vjust =</span> <span class="sc">-</span><span class="fl">1.5</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>)</span>
<span id="cb21-1689"><a href="#cb21-1689" aria-hidden="true" tabindex="-1"></a>  plots[[genus]] <span class="ot">&lt;-</span> p</span>
<span id="cb21-1690"><a href="#cb21-1690" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1691"><a href="#cb21-1691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1692"><a href="#cb21-1692" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb21-1693"><a href="#cb21-1693" aria-hidden="true" tabindex="-1"></a>combined_plot</span>
<span id="cb21-1694"><a href="#cb21-1694" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1695"><a href="#cb21-1695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1698"><a href="#cb21-1698" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1699"><a href="#cb21-1699" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-model_sen_check</span></span>
<span id="cb21-1700"><a href="#cb21-1700" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-1701"><a href="#cb21-1701" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb21-1702"><a href="#cb21-1702" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The distribution of posterior for coeffeicent and spatial field using simulated data and R-INLA."</span></span>
<span id="cb21-1703"><a href="#cb21-1703" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-subcap: </span></span>
<span id="cb21-1704"><a href="#cb21-1704" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Distribution of posterior for coeffeicents"</span></span>
<span id="cb21-1705"><a href="#cb21-1705" aria-hidden="true" tabindex="-1"></a><span class="co">#|   - "Spatial field"</span></span>
<span id="cb21-1706"><a href="#cb21-1706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1707"><a href="#cb21-1707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1708"><a href="#cb21-1708" aria-hidden="true" tabindex="-1"></a><span class="do">################ MCMC ################</span></span>
<span id="cb21-1709"><a href="#cb21-1709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1710"><a href="#cb21-1710" aria-hidden="true" tabindex="-1"></a><span class="co"># dir_path &lt;- "~/phenology-urban/data/proc/urban/sp_model/"</span></span>
<span id="cb21-1711"><a href="#cb21-1711" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-1712"><a href="#cb21-1712" aria-hidden="true" tabindex="-1"></a><span class="co"># files &lt;- list.files(dir_path, pattern = "^SIM_sp_random.*\\.rds$", full.names = TRUE)</span></span>
<span id="cb21-1713"><a href="#cb21-1713" aria-hidden="true" tabindex="-1"></a><span class="co"># plots &lt;- list()</span></span>
<span id="cb21-1714"><a href="#cb21-1714" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-1715"><a href="#cb21-1715" aria-hidden="true" tabindex="-1"></a><span class="co"># for (file in files) {</span></span>
<span id="cb21-1716"><a href="#cb21-1716" aria-hidden="true" tabindex="-1"></a><span class="co">#   model_data &lt;- readRDS(file)</span></span>
<span id="cb21-1717"><a href="#cb21-1717" aria-hidden="true" tabindex="-1"></a><span class="co">#   genus &lt;- sub(".*SIM_(.*?)_tavg_SOS_(.*?)\\.rds", "\\2", basename(file))</span></span>
<span id="cb21-1718"><a href="#cb21-1718" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb21-1719"><a href="#cb21-1719" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_label &lt;- data.frame(Parameter = "beta[2]", Label = "AvgTemp")</span></span>
<span id="cb21-1720"><a href="#cb21-1720" aria-hidden="true" tabindex="-1"></a><span class="co">#   param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%</span></span>
<span id="cb21-1721"><a href="#cb21-1721" aria-hidden="true" tabindex="-1"></a><span class="co">#     filter(Parameter == "AvgTemp")</span></span>
<span id="cb21-1722"><a href="#cb21-1722" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_median &lt;- median(param_data$value)</span></span>
<span id="cb21-1723"><a href="#cb21-1723" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_mean &lt;- mean(param_data$value)</span></span>
<span id="cb21-1724"><a href="#cb21-1724" aria-hidden="true" tabindex="-1"></a><span class="co">#   p &lt;- param_data %&gt;%</span></span>
<span id="cb21-1725"><a href="#cb21-1725" aria-hidden="true" tabindex="-1"></a><span class="co">#     ggs_density() +</span></span>
<span id="cb21-1726"><a href="#cb21-1726" aria-hidden="true" tabindex="-1"></a><span class="co">#     theme_bw() +</span></span>
<span id="cb21-1727"><a href="#cb21-1727" aria-hidden="true" tabindex="-1"></a><span class="co">#     ggtitle(paste("Model:", genus)) +</span></span>
<span id="cb21-1728"><a href="#cb21-1728" aria-hidden="true" tabindex="-1"></a><span class="co">#     theme(plot.title = element_text(hjust = 0.5)) +</span></span>
<span id="cb21-1729"><a href="#cb21-1729" aria-hidden="true" tabindex="-1"></a><span class="co">#     annotate("text", x = beta_median, y = 0, label = paste0("Median: ", round(beta_median, 2)),vjust = -1.5, color = "red", size = 4) +</span></span>
<span id="cb21-1730"><a href="#cb21-1730" aria-hidden="true" tabindex="-1"></a><span class="co">#     annotate("text", x = beta_mean, y = 2, label = paste0("Mean: ", round(beta_mean, 2)),vjust = -1.5, color = "red", size = 4)</span></span>
<span id="cb21-1731"><a href="#cb21-1731" aria-hidden="true" tabindex="-1"></a><span class="co">#   plots[[genus]] &lt;- p</span></span>
<span id="cb21-1732"><a href="#cb21-1732" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb21-1733"><a href="#cb21-1733" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-1734"><a href="#cb21-1734" aria-hidden="true" tabindex="-1"></a><span class="co"># combined_plot2 &lt;- wrap_plots(plots, ncol = 2)</span></span>
<span id="cb21-1735"><a href="#cb21-1735" aria-hidden="true" tabindex="-1"></a><span class="co"># combined_plot2</span></span>
<span id="cb21-1736"><a href="#cb21-1736" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-1737"><a href="#cb21-1737" aria-hidden="true" tabindex="-1"></a><span class="co"># files &lt;- list.files(dir_path, pattern = "^SIM_joint.*\\.rds$", full.names = TRUE)</span></span>
<span id="cb21-1738"><a href="#cb21-1738" aria-hidden="true" tabindex="-1"></a><span class="co"># plots &lt;- list()</span></span>
<span id="cb21-1739"><a href="#cb21-1739" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-1740"><a href="#cb21-1740" aria-hidden="true" tabindex="-1"></a><span class="co"># for (file in files) {</span></span>
<span id="cb21-1741"><a href="#cb21-1741" aria-hidden="true" tabindex="-1"></a><span class="co">#   model_data &lt;- readRDS(file)</span></span>
<span id="cb21-1742"><a href="#cb21-1742" aria-hidden="true" tabindex="-1"></a><span class="co">#   genus &lt;- sub(".*SIM_(.*?)_tavg_SOS_(.*?)\\.rds", "\\2", basename(file))</span></span>
<span id="cb21-1743"><a href="#cb21-1743" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb21-1744"><a href="#cb21-1744" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_label &lt;- data.frame(Parameter = "beta[2]", Label = "AvgTemp")</span></span>
<span id="cb21-1745"><a href="#cb21-1745" aria-hidden="true" tabindex="-1"></a><span class="co">#   param_data &lt;- ggs(model_data$samples, par_labels = beta_label) %&gt;%</span></span>
<span id="cb21-1746"><a href="#cb21-1746" aria-hidden="true" tabindex="-1"></a><span class="co">#     filter(Parameter == "AvgTemp")</span></span>
<span id="cb21-1747"><a href="#cb21-1747" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_median &lt;- median(param_data$value)</span></span>
<span id="cb21-1748"><a href="#cb21-1748" aria-hidden="true" tabindex="-1"></a><span class="co">#   beta_mean &lt;- mean(param_data$value)</span></span>
<span id="cb21-1749"><a href="#cb21-1749" aria-hidden="true" tabindex="-1"></a><span class="co">#   p &lt;- param_data %&gt;%</span></span>
<span id="cb21-1750"><a href="#cb21-1750" aria-hidden="true" tabindex="-1"></a><span class="co">#     ggs_density() +</span></span>
<span id="cb21-1751"><a href="#cb21-1751" aria-hidden="true" tabindex="-1"></a><span class="co">#     theme_bw() +</span></span>
<span id="cb21-1752"><a href="#cb21-1752" aria-hidden="true" tabindex="-1"></a><span class="co">#     ggtitle(paste("Model:", genus)) +</span></span>
<span id="cb21-1753"><a href="#cb21-1753" aria-hidden="true" tabindex="-1"></a><span class="co">#     theme(plot.title = element_text(hjust = 0.5)) +</span></span>
<span id="cb21-1754"><a href="#cb21-1754" aria-hidden="true" tabindex="-1"></a><span class="co">#     annotate("text", x = beta_median, y = 0, label = paste0("Median: ", round(beta_median, 2)),vjust = -1.5, color = "red", size = 4) +</span></span>
<span id="cb21-1755"><a href="#cb21-1755" aria-hidden="true" tabindex="-1"></a><span class="co">#     annotate("text", x = beta_mean, y = 2, label = paste0("Mean: ", round(beta_mean, 2)),vjust = -1.5, color = "red", size = 4)</span></span>
<span id="cb21-1756"><a href="#cb21-1756" aria-hidden="true" tabindex="-1"></a><span class="co">#   plots[[genus]] &lt;- p</span></span>
<span id="cb21-1757"><a href="#cb21-1757" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb21-1758"><a href="#cb21-1758" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-1759"><a href="#cb21-1759" aria-hidden="true" tabindex="-1"></a><span class="co"># combined_plot &lt;- wrap_plots(plots, ncol = 2)</span></span>
<span id="cb21-1760"><a href="#cb21-1760" aria-hidden="true" tabindex="-1"></a><span class="co"># combined_plot</span></span>
<span id="cb21-1761"><a href="#cb21-1761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1762"><a href="#cb21-1762" aria-hidden="true" tabindex="-1"></a><span class="do">################ INLA ################</span></span>
<span id="cb21-1763"><a href="#cb21-1763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1764"><a href="#cb21-1764" aria-hidden="true" tabindex="-1"></a>model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/SIM_INLA_tavg_SOS.rds"</span>)</span>
<span id="cb21-1765"><a href="#cb21-1765" aria-hidden="true" tabindex="-1"></a>genus <span class="ot">=</span> <span class="st">"Simulation"</span></span>
<span id="cb21-1766"><a href="#cb21-1766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1767"><a href="#cb21-1767" aria-hidden="true" tabindex="-1"></a><span class="co"># fixed effect</span></span>
<span id="cb21-1768"><a href="#cb21-1768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1769"><a href="#cb21-1769" aria-hidden="true" tabindex="-1"></a>beta_avg_temp <span class="ot">&lt;-</span> model_data<span class="sc">$</span>res<span class="sc">$</span>marginals.fixed</span>
<span id="cb21-1770"><a href="#cb21-1770" aria-hidden="true" tabindex="-1"></a>df_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(beta_avg_temp), <span class="cf">function</span>(nm) {</span>
<span id="cb21-1771"><a href="#cb21-1771" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(</span>
<span id="cb21-1772"><a href="#cb21-1772" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> beta_avg_temp[[nm]][, <span class="dv">1</span>],</span>
<span id="cb21-1773"><a href="#cb21-1773" aria-hidden="true" tabindex="-1"></a>    <span class="at">density =</span> beta_avg_temp[[nm]][, <span class="dv">2</span>],</span>
<span id="cb21-1774"><a href="#cb21-1774" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fu">paste0</span>(<span class="st">"beta["</span>, nm, <span class="st">"]"</span>) </span>
<span id="cb21-1775"><a href="#cb21-1775" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1776"><a href="#cb21-1776" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-1777"><a href="#cb21-1777" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, df_list)</span>
<span id="cb21-1778"><a href="#cb21-1778" aria-hidden="true" tabindex="-1"></a>fix_effect <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(model_data<span class="sc">$</span>res)<span class="sc">$</span>fixed) <span class="sc">%&gt;%</span></span>
<span id="cb21-1779"><a href="#cb21-1779" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">Mean =</span> mean, <span class="at">Lower =</span> <span class="st">`</span><span class="at">0.025quant</span><span class="st">`</span>,<span class="at">Upper =</span> <span class="st">`</span><span class="at">0.975quant</span><span class="st">`</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-1780"><a href="#cb21-1780" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Sig =</span> <span class="fu">ifelse</span>(Lower<span class="sc">*</span>Upper<span class="sc">&gt;</span><span class="dv">0</span>, <span class="st">"*"</span>, <span class="st">""</span>)) </span>
<span id="cb21-1781"><a href="#cb21-1781" aria-hidden="true" tabindex="-1"></a>fix_effect <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb21-1782"><a href="#cb21-1782" aria-hidden="true" tabindex="-1"></a>  <span class="at">Factor =</span> <span class="fu">rownames</span>(fix_effect),  <span class="co"># Add Factor column</span></span>
<span id="cb21-1783"><a href="#cb21-1783" aria-hidden="true" tabindex="-1"></a>  fix_effect, </span>
<span id="cb21-1784"><a href="#cb21-1784" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> <span class="cn">NULL</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-1785"><a href="#cb21-1785" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Factor =</span> <span class="fu">case_when</span>(</span>
<span id="cb21-1786"><a href="#cb21-1786" aria-hidden="true" tabindex="-1"></a>    Factor <span class="sc">==</span> <span class="st">"Intercept"</span> <span class="sc">~</span> <span class="st">"beta[Intercept]"</span>,</span>
<span id="cb21-1787"><a href="#cb21-1787" aria-hidden="true" tabindex="-1"></a>    Factor <span class="sc">==</span> <span class="st">"AvgTemp_mean"</span> <span class="sc">~</span> <span class="st">"beta[AvgTemp_mean]"</span>,</span>
<span id="cb21-1788"><a href="#cb21-1788" aria-hidden="true" tabindex="-1"></a>    Factor <span class="sc">==</span> <span class="st">"Sum_mm_sum"</span> <span class="sc">~</span> <span class="st">"beta[Sum_mm_sum]"</span>,</span>
<span id="cb21-1789"><a href="#cb21-1789" aria-hidden="true" tabindex="-1"></a>    Factor <span class="sc">==</span> <span class="st">"srad_mean"</span> <span class="sc">~</span> <span class="st">"beta[srad_mean]"</span></span>
<span id="cb21-1790"><a href="#cb21-1790" aria-hidden="true" tabindex="-1"></a>  )) </span>
<span id="cb21-1791"><a href="#cb21-1791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1792"><a href="#cb21-1792" aria-hidden="true" tabindex="-1"></a>df_with_mean <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb21-1793"><a href="#cb21-1793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(fix_effect <span class="sc">%&gt;%</span> <span class="fu">select</span>(Factor, Mean), <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"beta"</span> <span class="ot">=</span> <span class="st">"Factor"</span>))</span>
<span id="cb21-1794"><a href="#cb21-1794" aria-hidden="true" tabindex="-1"></a>annot_data <span class="ot">&lt;-</span> df_with_mean <span class="sc">%&gt;%</span></span>
<span id="cb21-1795"><a href="#cb21-1795" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(beta) <span class="sc">%&gt;%</span></span>
<span id="cb21-1796"><a href="#cb21-1796" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb21-1797"><a href="#cb21-1797" aria-hidden="true" tabindex="-1"></a>    <span class="at">Mean =</span> <span class="fu">first</span>(Mean),</span>
<span id="cb21-1798"><a href="#cb21-1798" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_density =</span> <span class="fu">max</span>(density)</span>
<span id="cb21-1799"><a href="#cb21-1799" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-1800"><a href="#cb21-1800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1801"><a href="#cb21-1801" aria-hidden="true" tabindex="-1"></a>plot_tavg <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_with_mean, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> density)) <span class="sc">+</span></span>
<span id="cb21-1802"><a href="#cb21-1802" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb21-1803"><a href="#cb21-1803" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(</span>
<span id="cb21-1804"><a href="#cb21-1804" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> Mean, <span class="at">y =</span> max_density <span class="sc">*</span> <span class="fl">0.95</span>, </span>
<span id="cb21-1805"><a href="#cb21-1805" aria-hidden="true" tabindex="-1"></a>        <span class="at">label =</span> <span class="fu">paste0</span>(<span class="st">"Mean = "</span>, <span class="fu">round</span>(Mean, <span class="dv">3</span>))),</span>
<span id="cb21-1806"><a href="#cb21-1806" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> annot_data,</span>
<span id="cb21-1807"><a href="#cb21-1807" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">hjust =</span> <span class="fl">1.1</span></span>
<span id="cb21-1808"><a href="#cb21-1808" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-1809"><a href="#cb21-1809" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>beta, <span class="at">scales =</span> <span class="st">"free"</span>, <span class="at">labeller =</span> label_parsed) <span class="sc">+</span> </span>
<span id="cb21-1810"><a href="#cb21-1810" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb21-1811"><a href="#cb21-1811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Coefficient Value"</span>, <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb21-1812"><a href="#cb21-1812" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">paste</span>(<span class="st">"Genus:"</span>, genus)) <span class="sc">+</span></span>
<span id="cb21-1813"><a href="#cb21-1813" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>)</span>
<span id="cb21-1814"><a href="#cb21-1814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1815"><a href="#cb21-1815" aria-hidden="true" tabindex="-1"></a>plot_tavg</span>
<span id="cb21-1816"><a href="#cb21-1816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1817"><a href="#cb21-1817" aria-hidden="true" tabindex="-1"></a><span class="co"># spatial field</span></span>
<span id="cb21-1818"><a href="#cb21-1818" aria-hidden="true" tabindex="-1"></a>proj <span class="ot">&lt;-</span> <span class="fu">inla.mesh.projector</span>(model_data<span class="sc">$</span>mesh,<span class="at">dims =</span> <span class="fu">c</span>(<span class="dv">300</span>, <span class="dv">300</span>))</span>
<span id="cb21-1819"><a href="#cb21-1819" aria-hidden="true" tabindex="-1"></a>mean_s <span class="ot">&lt;-</span> <span class="fu">inla.mesh.project</span>(proj, model_data<span class="sc">$</span>res<span class="sc">$</span>summary.random<span class="sc">$</span>s<span class="sc">$</span>mean)</span>
<span id="cb21-1820"><a href="#cb21-1820" aria-hidden="true" tabindex="-1"></a>sd_s <span class="ot">&lt;-</span> <span class="fu">inla.mesh.project</span>(proj, model_data<span class="sc">$</span>res<span class="sc">$</span>summary.random<span class="sc">$</span>s<span class="sc">$</span>sd)</span>
<span id="cb21-1821"><a href="#cb21-1821" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x =</span> proj<span class="sc">$</span>x, <span class="at">y =</span> proj<span class="sc">$</span>y)</span>
<span id="cb21-1822"><a href="#cb21-1822" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>mean_s <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(mean_s)</span>
<span id="cb21-1823"><a href="#cb21-1823" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>sd_s <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(sd_s)</span>
<span id="cb21-1824"><a href="#cb21-1824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1825"><a href="#cb21-1825" aria-hidden="true" tabindex="-1"></a>gmean <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> mean_s)) <span class="sc">+</span></span>
<span id="cb21-1826"><a href="#cb21-1826" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb21-1827"><a href="#cb21-1827" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(<span class="at">na.value =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb21-1828"><a href="#cb21-1828" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span> <span class="fu">theme_bw</span>()  <span class="sc">+</span></span>
<span id="cb21-1829"><a href="#cb21-1829" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="fl">0.9</span>))</span>
<span id="cb21-1830"><a href="#cb21-1830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1831"><a href="#cb21-1831" aria-hidden="true" tabindex="-1"></a>gsd <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> sd_s)) <span class="sc">+</span></span>
<span id="cb21-1832"><a href="#cb21-1832" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb21-1833"><a href="#cb21-1833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>(<span class="at">na.value =</span> <span class="st">"transparent"</span>) <span class="sc">+</span></span>
<span id="cb21-1834"><a href="#cb21-1834" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-1835"><a href="#cb21-1835" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb21-1836"><a href="#cb21-1836" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">vjust =</span> <span class="fl">0.9</span>))</span>
<span id="cb21-1837"><a href="#cb21-1837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1838"><a href="#cb21-1838" aria-hidden="true" tabindex="-1"></a>gmean <span class="sc">+</span> gsd</span>
<span id="cb21-1839"><a href="#cb21-1839" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1840"><a href="#cb21-1840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1841"><a href="#cb21-1841" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4.3 Comparison with OLS</span></span>
<span id="cb21-1842"><a href="#cb21-1842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1843"><a href="#cb21-1843" aria-hidden="true" tabindex="-1"></a>I think there is no dramatic difference between the OLS and INLA models. However, I believe this is appropriate, as the spatial part does not significantly impact the coefficient, and primarily accounts for the unexplained residuals in the linear regression.</span>
<span id="cb21-1844"><a href="#cb21-1844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1847"><a href="#cb21-1847" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb21-1848"><a href="#cb21-1848" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-city_comp_ols</span></span>
<span id="cb21-1849"><a href="#cb21-1849" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb21-1850"><a href="#cb21-1850" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The distribution of the posterior of regression coefficients for `Temp~avg~` on phenology for each genus (Line: 95% CI, point: mean value)."</span></span>
<span id="cb21-1851"><a href="#cb21-1851" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb21-1852"><a href="#cb21-1852" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb21-1853"><a href="#cb21-1853" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb21-1854"><a href="#cb21-1854" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb21-1855"><a href="#cb21-1855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1856"><a href="#cb21-1856" aria-hidden="true" tabindex="-1"></a><span class="do">### INLA</span></span>
<span id="cb21-1857"><a href="#cb21-1857" aria-hidden="true" tabindex="-1"></a>dir_path <span class="ot">&lt;-</span> <span class="st">"~/phenology-urban/data/proc/urban/ols_model/"</span></span>
<span id="cb21-1858"><a href="#cb21-1858" aria-hidden="true" tabindex="-1"></a>pattern <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">"^.*</span><span class="sc">\\</span><span class="st">.rds$"</span>)</span>
<span id="cb21-1859"><a href="#cb21-1859" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_path, <span class="at">pattern =</span> pattern, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-1860"><a href="#cb21-1860" aria-hidden="true" tabindex="-1"></a>coef_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb21-1861"><a href="#cb21-1861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1862"><a href="#cb21-1862" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (file <span class="cf">in</span> files) {</span>
<span id="cb21-1863"><a href="#cb21-1863" aria-hidden="true" tabindex="-1"></a>  model_data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(file)</span>
<span id="cb21-1864"><a href="#cb21-1864" aria-hidden="true" tabindex="-1"></a>  city <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">1"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1865"><a href="#cb21-1865" aria-hidden="true" tabindex="-1"></a>  genus <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">2"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1866"><a href="#cb21-1866" aria-hidden="true" tabindex="-1"></a>  phe_type <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">"(.*?)_(.*?)_tavg_(.*?)</span><span class="sc">\\</span><span class="st">.rds"</span>, <span class="st">"</span><span class="sc">\\</span><span class="st">3"</span>, <span class="fu">basename</span>(file))</span>
<span id="cb21-1867"><a href="#cb21-1867" aria-hidden="true" tabindex="-1"></a>  fixed_summary <span class="ot">&lt;-</span> model_data<span class="sc">$</span>fix_effect <span class="sc">%&gt;%</span></span>
<span id="cb21-1868"><a href="#cb21-1868" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">city =</span> city, <span class="at">genus =</span> genus, <span class="at">phe_type =</span> phe_type)</span>
<span id="cb21-1869"><a href="#cb21-1869" aria-hidden="true" tabindex="-1"></a>  coef_summary <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb21-1870"><a href="#cb21-1870" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rbind</span>(fixed_summary)</span>
<span id="cb21-1871"><a href="#cb21-1871" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-1872"><a href="#cb21-1872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1873"><a href="#cb21-1873" aria-hidden="true" tabindex="-1"></a>coef_summary_df <span class="ot">&lt;-</span> coef_summary <span class="sc">%&gt;%</span></span>
<span id="cb21-1874"><a href="#cb21-1874" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SigAlpha =</span> <span class="fu">ifelse</span>(Sig <span class="sc">==</span> <span class="st">"*"</span>, <span class="dv">1</span>, <span class="fl">0.2</span>),</span>
<span id="cb21-1875"><a href="#cb21-1875" aria-hidden="true" tabindex="-1"></a>         <span class="at">phe_type =</span> <span class="fu">factor</span>(phe_type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)),</span>
<span id="cb21-1876"><a href="#cb21-1876" aria-hidden="true" tabindex="-1"></a>         <span class="at">city =</span> <span class="fu">factor</span>(city, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"NY"</span>, <span class="st">"DV"</span>, <span class="st">"HT"</span>, <span class="st">"ST"</span>)))</span>
<span id="cb21-1877"><a href="#cb21-1877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1878"><a href="#cb21-1878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1879"><a href="#cb21-1879" aria-hidden="true" tabindex="-1"></a>coef_summary_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(coef_summary_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">factor</span>(Factor, <span class="at">levels =</span> <span class="fu">unique</span>(Factor)), <span class="at">y =</span> Estimate, <span class="at">color =</span> city)) <span class="sc">+</span></span>
<span id="cb21-1880"><a href="#cb21-1880" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> SigAlpha), <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), <span class="at">size =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb21-1881"><a href="#cb21-1881" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> Lower, <span class="at">ymax =</span> Upper, <span class="at">alpha =</span> SigAlpha), </span>
<span id="cb21-1882"><a href="#cb21-1882" aria-hidden="true" tabindex="-1"></a>                <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">w =</span> <span class="fl">0.5</span>), </span>
<span id="cb21-1883"><a href="#cb21-1883" aria-hidden="true" tabindex="-1"></a>                <span class="at">linewidth =</span> <span class="fl">0.5</span>,</span>
<span id="cb21-1884"><a href="#cb21-1884" aria-hidden="true" tabindex="-1"></a>                <span class="at">width =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb21-1885"><a href="#cb21-1885" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">alpha =</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-1886"><a href="#cb21-1886" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coord_flip() +</span></span>
<span id="cb21-1887"><a href="#cb21-1887" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>phe_type, <span class="at">scales =</span> <span class="st">"free"</span>) <span class="sc">+</span></span>
<span id="cb21-1888"><a href="#cb21-1888" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="st">"Estimate"</span>) <span class="sc">+</span></span>
<span id="cb21-1889"><a href="#cb21-1889" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_identity</span>() <span class="sc">+</span></span>
<span id="cb21-1890"><a href="#cb21-1890" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(</span>
<span id="cb21-1891"><a href="#cb21-1891" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"NY"</span> <span class="ot">=</span> <span class="st">"darkolivegreen4"</span>, <span class="st">"HT"</span> <span class="ot">=</span> <span class="st">"navyblue"</span>, <span class="st">"DV"</span> <span class="ot">=</span> <span class="st">"chocolate"</span>, <span class="st">"ST"</span> <span class="ot">=</span> <span class="st">"purple"</span>)</span>
<span id="cb21-1892"><a href="#cb21-1892" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-1893"><a href="#cb21-1893" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>) <span class="sc">+</span></span>
<span id="cb21-1894"><a href="#cb21-1894" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(aes(label = Sig, y = Upper + 0.05), hjust = -0.5, show.legend = FALSE, size = 3) +</span></span>
<span id="cb21-1895"><a href="#cb21-1895" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_text(aes(label = Estimate, y = Estimate), vjust = -0.9, show.legend = FALSE, size = 3) +</span></span>
<span id="cb21-1896"><a href="#cb21-1896" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">alpha =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb21-1897"><a href="#cb21-1897" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb21-1898"><a href="#cb21-1898" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb21-1899"><a href="#cb21-1899" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb21-1900"><a href="#cb21-1900" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">12</span>, <span class="at">face =</span> <span class="st">"bold"</span>)</span>
<span id="cb21-1901"><a href="#cb21-1901" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-1902"><a href="#cb21-1902" aria-hidden="true" tabindex="-1"></a>coef_summary_plot</span>
<span id="cb21-1903"><a href="#cb21-1903" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1904"><a href="#cb21-1904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1905"><a href="#cb21-1905" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5 Conclusion and next step</span></span>
<span id="cb21-1906"><a href="#cb21-1906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1907"><a href="#cb21-1907" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conclusion</span></span>
<span id="cb21-1908"><a href="#cb21-1908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1909"><a href="#cb21-1909" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Optimal preseason length for phenology varies among genera.</span>
<span id="cb21-1910"><a href="#cb21-1910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1911"><a href="#cb21-1911" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Within the city, trees indeed respond to temperature variation, result in phenology variation</span>
<span id="cb21-1912"><a href="#cb21-1912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1913"><a href="#cb21-1913" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Across cities, some variation patterns noticed.</span>
<span id="cb21-1914"><a href="#cb21-1914" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1915"><a href="#cb21-1915" aria-hidden="true" tabindex="-1"></a><span class="fu">### Next steps</span></span>
<span id="cb21-1916"><a href="#cb21-1916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1917"><a href="#cb21-1917" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**What can the urban phenology heterogenity be used for?** - Goal</span>
<span id="cb21-1918"><a href="#cb21-1918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1919"><a href="#cb21-1919" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>The preview of future warming: compared with the sensitivity in natural environment.</span>
<span id="cb21-1920"><a href="#cb21-1920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1921"><a href="#cb21-1921" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Fine-scale urban phenology: compared with other urban phenology sensitivity detected at coarser scale.</span>
<span id="cb21-1922"><a href="#cb21-1922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1923"><a href="#cb21-1923" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Scale up</span>
<span id="cb21-1924"><a href="#cb21-1924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1925"><a href="#cb21-1925" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Cities</span>
<span id="cb21-1926"><a href="#cb21-1926" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Genera</span>
<span id="cb21-1927"><a href="#cb21-1927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1928"><a href="#cb21-1928" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Sensitivity</span>
<span id="cb21-1929"><a href="#cb21-1929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1930"><a href="#cb21-1930" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>How about use buffer size</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>