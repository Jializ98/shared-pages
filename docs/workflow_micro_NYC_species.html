<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jiali Zhu">
<meta name="dcterms.date" content="2025-04-10">

<title>Urban phenology</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-2d01dac5deb81f30d2e298efbbbf2476.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-search-results"></div>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#question-and-hypothesis" id="toc-question-and-hypothesis" class="nav-link" data-scroll-target="#question-and-hypothesis">Question and Hypothesis</a></li>
  <li><a href="#raw-data" id="toc-raw-data" class="nav-link" data-scroll-target="#raw-data">1 Raw data</a>
  <ul class="collapse">
  <li><a href="#read-and-clean-the-wu-data-based-on-ghcnd" id="toc-read-and-clean-the-wu-data-based-on-ghcnd" class="nav-link" data-scroll-target="#read-and-clean-the-wu-data-based-on-ghcnd">1.1 Read and clean the WU data (based on GHCNd)</a></li>
  <li><a href="#shortwave-data-from-daymet" id="toc-shortwave-data-from-daymet" class="nav-link" data-scroll-target="#shortwave-data-from-daymet">1.2 Shortwave data from Daymet</a></li>
  <li><a href="#select-the-street-tree-base-on-wu-data" id="toc-select-the-street-tree-base-on-wu-data" class="nav-link" data-scroll-target="#select-the-street-tree-base-on-wu-data">1.3 Select the street tree base on WU data</a></li>
  </ul></li>
  <li><a href="#method" id="toc-method" class="nav-link" data-scroll-target="#method">2 Method</a>
  <ul class="collapse">
  <li><a href="#phenological-indicators" id="toc-phenological-indicators" class="nav-link" data-scroll-target="#phenological-indicators">2.1 Phenological indicators</a></li>
  <li><a href="#spatial-model" id="toc-spatial-model" class="nav-link" data-scroll-target="#spatial-model">2.2 Spatial model</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">3 Results</a>
  <ul class="collapse">
  <li><a href="#genus-level" id="toc-genus-level" class="nav-link" data-scroll-target="#genus-level">3.1 Genus level</a></li>
  <li><a href="#species-level" id="toc-species-level" class="nav-link" data-scroll-target="#species-level">3.2 Species level</a></li>
  </ul></li>
  <li><a href="#conclusion-and-next-step" id="toc-conclusion-and-next-step" class="nav-link" data-scroll-target="#conclusion-and-next-step">4 Conclusion and next step</a>
  <ul class="collapse">
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#next-steps" id="toc-next-steps" class="nav-link" data-scroll-target="#next-steps">Next steps</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Urban phenology</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jiali Zhu </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 10, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<ul>
<li><p>Phenology, the timing of periodic plant life cycle events, is sensitive to biotic and abiotic environment, especially the temperature (Meng et al., 2020).</p></li>
<li><p>The significant Urban Heat Island effect leads to the shifts in urban phenology (L. Yang et al., 2023; Y. Zhou, 2022)</p>
<ul>
<li>Treat city as a whole.</li>
<li>Compare it to rural areas.</li>
</ul></li>
<li><p>Spatial unevenness of urban thermal environment might lead to the heterogeneity of phenology within the city.</p>
<ul>
<li>Negative correlation between the flowering date and the monthly mean LST in February–April.</li>
</ul>
<div id="fig-katz_2019" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-katz_2019-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="docs/katz_2019.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-katz_2019-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Katz et al., 2019
</figcaption>
</figure>
</div>
<ul>
<li>A significant spatial variation for First flowing date of 35 species, which negatively correlated withdaily LST.</li>
</ul>
<div id="fig-xing_2022" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-xing_2022-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="docs/xing_2022.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-xing_2022-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Xing et al., 2022
</figcaption>
</figure>
</div></li>
</ul>
</section>
<section id="question-and-hypothesis" class="level2">
<h2 class="anchored" data-anchor-id="question-and-hypothesis">Question and Hypothesis</h2>
<ul>
<li><p><strong>Question</strong>: What is the spatial heterogeneity of individual tree phenology within a city, and across cities located in different climate regions? (genus and species level)</p></li>
<li><p><strong>Hypothesis</strong>:</p>
<ul>
<li>There is a significant spatial heterogeneity.</li>
<li>Spatial heterogeneity in urban phenology is driven by the heterogeneous urban thermal environment</li>
<li>The magnitude and direction of this effect may differ among cities.</li>
</ul></li>
<li><p><strong>Goal</strong>:</p>
<ul>
<li>Insights into how vegetation adapts to altered environmental conditions under urbanization.</li>
<li>Addresses the biological and societal consequences of phenological changes.</li>
</ul></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>cities <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"HT"</span>, <span class="st">"NY"</span>, <span class="st">"ST"</span>, <span class="st">"DV"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>phe_type <span class="ot">&lt;-</span> <span class="st">"GreenDown"</span> </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>model_input_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/species_level/tidy_model_input.R"</span>)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (city <span class="cf">in</span> cities) {</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  points_in_buffer <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tree_WU_500_buffer_PS.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  all_sites_temp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>,city,<span class="st">"/"</span>,city,<span class="st">"_wu.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(Date, HighTemp, AvgTemp, LowTemp, Sum_mm, name)) <span class="sc">%&gt;%</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">season =</span> <span class="fu">case_when</span>(</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(Date) <span class="sc">%in%</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span> <span class="sc">~</span> <span class="st">"spring"</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(Date) <span class="sc">%in%</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">8</span> <span class="sc">~</span> <span class="st">"summer"</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(Date) <span class="sc">%in%</span> <span class="dv">9</span><span class="sc">:</span><span class="dv">11</span> <span class="sc">~</span> <span class="st">"fall"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">~</span> <span class="st">"winter"</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(Date),</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">year =</span> <span class="fu">if_else</span>(<span class="fu">month</span>(Date) <span class="sc">==</span> <span class="dv">12</span>, year <span class="sc">+</span> <span class="dv">1</span>, year)) <span class="sc">%&gt;%</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, year, season) <span class="sc">%&gt;%</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">Avg_AvgTemp =</span> <span class="fu">mean</span>(AvgTemp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">Sum_Sum_mm =</span> <span class="fu">sum</span>(Sum_mm, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">AvgTemp_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(AvgTemp)),</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">Sum_mm_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(Sum_mm)),</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  srad_daily <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/raw/"</span>,city,<span class="st">"/Daymet/daily2016-2024/srad_daily_2016-2023.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, value, date)  <span class="sc">%&gt;%</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">season =</span> <span class="fu">case_when</span>(</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span> <span class="sc">~</span> <span class="st">"spring"</span>,</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">8</span> <span class="sc">~</span> <span class="st">"summer"</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">9</span><span class="sc">:</span><span class="dv">11</span> <span class="sc">~</span> <span class="st">"fall"</span>,</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">~</span> <span class="st">"winter"</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>           <span class="at">year =</span> <span class="fu">if_else</span>(<span class="fu">month</span>(date) <span class="sc">==</span> <span class="dv">12</span>, year <span class="sc">+</span> <span class="dv">1</span>, year)) <span class="sc">%&gt;%</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id, year, season) <span class="sc">%&gt;%</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">Avg_srad =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">srad_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)),</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  model_input_all <span class="ot">&lt;-</span> <span class="fu">prepare_data</span>(phe_type, points_in_buffer, all_sites_temp, srad_daily)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  model_input_list[[city]] <span class="ot">&lt;-</span> model_input_all</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>city_names <span class="ot">&lt;-</span> <span class="fu">names</span>(model_input_list)</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(city_names, <span class="cf">function</span>(city) {</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    model_input_list[[city]] <span class="sc">%&gt;%</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(canonicalname) <span class="sc">%&gt;%</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">city =</span> city)</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>species_city_count <span class="ot">&lt;-</span> combined <span class="sc">%&gt;%</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(city, canonicalname) <span class="sc">%&gt;%</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(canonicalname, <span class="at">name =</span> <span class="st">"n_cities"</span>)</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>common_species <span class="ot">&lt;-</span> species_city_count <span class="sc">%&gt;%</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_cities <span class="sc">==</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(canonicalname)</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>top10_species <span class="ot">&lt;-</span> combined <span class="sc">%&gt;%</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(canonicalname <span class="sc">%in%</span> common_species) <span class="sc">%&gt;%</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(canonicalname, <span class="at">name =</span> <span class="st">"total_count"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_count)) <span class="sc">%&gt;%</span></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>top10_species</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- ### 2.1 Species level -->
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/species_level/run_inla.R"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (city <span class="cf">in</span> cities) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/"</span>, city, <span class="st">"/"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"GreenDown"</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(phe_types, <span class="cf">function</span>(phe_type) {</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    model_input_all <span class="ot">&lt;-</span> model_input_list[[city]] <span class="sc">%&gt;%</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(canonicalname <span class="sc">%in%</span> top10_species<span class="sc">$</span>canonicalname)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># prepare_data(phe_type, points_in_buffer, all_sites_temp, srad_daily)</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">run_inla_species</span>(model_input_all, r_output_dir, phe_type, city)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<!-- ### 2.2 Genus level -->
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/genus_level/run_inla_fixpre.R"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_genus/"</span>, city, <span class="st">"/"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(phe_types, <span class="cf">function</span>(phe_type) {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  model_input_all <span class="ot">&lt;-</span> <span class="fu">prepare_data</span>(phe_type, points_in_buffer, all_sites_temp, srad_daily)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">run_inla_genus</span>(model_input_all, r_output_dir, phe_type, city)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="raw-data" class="level2">
<h2 class="anchored" data-anchor-id="raw-data">1 Raw data</h2>
<section id="read-and-clean-the-wu-data-based-on-ghcnd" class="level3">
<h3 class="anchored" data-anchor-id="read-and-clean-the-wu-data-based-on-ghcnd">1.1 Read and clean the WU data (based on GHCNd)</h3>
<p>The urban microclimate information comes from the <a href="https://www.wunderground.com/">Weather Underground program</a>. There are 4 raw daily variables selected, i.e.&nbsp;AvgTemp, HighTemp, LowTemp and SumPrcp. I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily <a href="https://www.ncei.noaa.gov/products/land-based-station/global-historical-climatology-network-daily">GHCNd</a>.</p>
<p>For initial analysis, I collect the date from 4 cities, i.e.&nbsp;New York, Houston, Detroit, and Seattle.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># No. of WU sites</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Category =</span> <span class="fu">c</span>(<span class="st">"DV"</span>, <span class="st">"NY"</span>, <span class="st">"ST"</span>, <span class="st">"HT"</span>),</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Number_of_Sites =</span> <span class="fu">c</span>(<span class="dv">226</span>, <span class="dv">148</span>, <span class="dv">367</span>, <span class="dv">171</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> Category, <span class="at">y =</span> Number_of_Sites)) <span class="sc">+</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> Number_of_Sites), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Category"</span>, <span class="at">y =</span> <span class="st">"Number of Sites"</span>) <span class="sc">+</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-wu_sites" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-wu_sites-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_species_files/figure-html/fig-wu_sites-1.png" class="img-fluid figure-img" width="528">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wu_sites-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Number of WU sites in each city
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>cities <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"NY"</span>, <span class="st">"HT"</span>, <span class="st">"DV"</span>, <span class="st">"ST"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (city <span class="cf">in</span> cities){</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  points_in_buffer <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tree_WU_500_buffer_PS.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  points_in_buffer_sf <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># us_boundary &lt;- st_read("~/urban-niche/data/raw/CONUS/boundary/us_boundarydissolve.shp") %&gt;%</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     st_transform(4326)</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  boundary <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    city,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NY"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DT/City_of_Detroit_Boundary/City_of_Detroit_Boundary.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ST"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/ST/seattle_boundary/CityUGA.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Seattle"</span>),</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/HT/HGAC_City_Boundaries/HGAC_City_Boundaries.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Houston"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TP"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/TP/Municipal_Boundary/Municipal_Boundary.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Tampa"</span>),</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DV"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DV/DRCOG_Municipalities/DRCOG_Municipalities.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(city <span class="sc">==</span> <span class="st">"Denver"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/AT/TxDOT_City_Boundaries/Cities.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Austin"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Invalid city abbreviation."</span>)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  wu_location <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>, city, <span class="st">"/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> boundary, <span class="at">fill =</span> <span class="st">"grey90"</span>) <span class="sc">+</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_sf(data = us_boundary, color = "blue", size = 1) +</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> wu_location, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_point(data = points_in_buffer, aes(x = lon, y = lat), color = "red",size = 0.01, alpha = 0.01) +</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> city) <span class="sc">+</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>  plots[[city]] <span class="ot">=</span> p</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>combined_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-tree_wu_sites" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tree_wu_sites-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_species_files/figure-html/fig-tree_wu_sites-1.png" class="img-fluid figure-img" width="1440">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tree_wu_sites-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: Location of WU sites and trees
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="shortwave-data-from-daymet" class="level3">
<h3 class="anchored" data-anchor-id="shortwave-data-from-daymet">1.2 Shortwave data from Daymet</h3>
<p>To control for the influence of other variables on phenology, I also incorporated shortwave radiation data derived from the <a href="https://daymet.ornl.gov/">Daymet daily dataset</a> with a 1 km resolution. Shortwave radiation was extracted for the specific locations of the trees.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># download</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/raw/"</span>, city, <span class="st">"/Daymet/daily2016-2024/"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_dir, <span class="at">pattern =</span> <span class="st">"srad_daily_2023_ncss</span><span class="sc">\\</span><span class="st">.nc$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>srad_nc <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(file)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>srad_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(srad_nc[[<span class="dv">1</span>]], <span class="at">xy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(srad_df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> srad_1)) <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"W/m²"</span>) <span class="sc">+</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Shortwave Radiation (W/m²) - 2023-01-01"</span>, <span class="at">x =</span> <span class="st">"x"</span>, <span class="at">y =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-plot_daymet" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-plot_daymet-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_species_files/figure-html/fig-plot_daymet-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-plot_daymet-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: The shortwave radiation raster in 2023-01-01, NY
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="select-the-street-tree-base-on-wu-data" class="level3">
<h3 class="anchored" data-anchor-id="select-the-street-tree-base-on-wu-data">1.3 Select the street tree base on WU data</h3>
<p>I used the street tree in the above 4 cities, with the phenology records established by Yiluan. These trees are part of the whole inventory, covering 14 genera and being sampled. I select the trees which are within <strong>500 m</strong> buffer around the Weather Underground sites (see <a href="#fig-tree_wu_sites2" class="quarto-xref">Figure&nbsp;6</a>).</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>points_in_buffer <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/NY/tree_WU_500_buffer_PS.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>points_in_buffer_sf <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># us_boundary &lt;- st_read("~/urban-niche/data/raw/CONUS/boundary/us_boundarydissolve.shp") %&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#     st_transform(4326)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>boundary <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>wu_location <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/NY/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>wu_buffer <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(wu_location, <span class="at">dist =</span> <span class="dv">500</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> boundary, <span class="at">fill =</span> <span class="st">"grey90"</span>) <span class="sc">+</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_sf(data = us_boundary, color = "blue", size = 1) +</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wu_buffer, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wu_location, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> points_in_buffer, <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">alpha =</span> <span class="fl">0.01</span>), <span class="at">color =</span> <span class="st">"red"</span>,<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"NY"</span>) <span class="sc">+</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">74.05</span>, <span class="sc">-</span><span class="fl">73.95</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">40.7</span>, <span class="fl">40.75</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-tree_wu_sites2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tree_wu_sites2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_species_files/figure-html/fig-tree_wu_sites2-1.png" class="img-fluid figure-img" width="1440">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tree_wu_sites2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Location of WU sites and trees, zoom in NY
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="method" class="level2">
<h2 class="anchored" data-anchor-id="method">2 Method</h2>
<section id="phenological-indicators" class="level3">
<h3 class="anchored" data-anchor-id="phenological-indicators">2.1 Phenological indicators</h3>
<p>The tree locations points were overlapped with Planetscope imageries to extract the reflectance values. After smoothing and regression, we could get the EVI curve. The phenological metrics were calculated based on the EVI curve:</p>
<div id="fig-ps_example" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ps_example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="docs/ps_example.png" class="img-fluid quarto-figure quarto-figure-center figure-img" style="width:60.0%">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ps_example-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Extract reflectance from PlanetScope based on tree location, an example in NY
</figcaption>
</figure>
</div>
<div id="fig-pheno_matrics" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pheno_matrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="docs/pheno_matrix.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-pheno_matrics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Phenology metrics calculated based on EVI curve from PlanetScope
</figcaption>
</figure>
</div>
<ul>
<li><p>Spring phenology</p>
<ul>
<li><code>SOS</code>: Defined as the day of year when individual tree growing season EVI curves first cross the green-up 50% threshold.</li>
<li><code>Green-up Pace</code>: Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-up 20% threshold to the 80% threshold.</li>
</ul></li>
<li><p>Fall phenology</p>
<ul>
<li><code>EOS</code>: Defined as the day of year when individual tree growing season EVI curves first cross the green-down 50% threshold.</li>
<li><code>Green-down Pace</code>: Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-down 20% threshold to the 80% threshold.</li>
</ul></li>
<li><p>Preseason: Defined as the time span (in days) to calculate the average temperature and precipitation.</p>
<ul>
<li><code>SOS</code>: Winter.</li>
<li><code>Green-up Pace</code>: Spring</li>
<li><code>EOS</code>: Summer</li>
<li><code>Green-down Pace</code>: Fall</li>
</ul></li>
</ul>
</section>
<section id="spatial-model" class="level3">
<h3 class="anchored" data-anchor-id="spatial-model">2.2 Spatial model</h3>
<p>I modeled the relationship between the phenology and environmental covariates using a spatial hierarchical model. The response variable (phenology parameter) at location <span class="math inline">\(\mathbf{s}_i\)</span> and in year <span class="math inline">\(\mathbf{t}\)</span>, denoted as <span class="math inline">\(y(\mathbf{s}_i, \mathbf{t})\)</span>, was modeled as following model:</p>
<p><strong>Model:</strong></p>
<p><span class="math display">\[y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w(\mathbf{s}_i) + u(\mathbf{t}) + \epsilon(\mathbf{s}_i, \mathbf{t})\]</span></p>
<p>where:</p>
<ul>
<li><p><em>Fixed Effects</em>: <span class="math display">\[\mu(\mathbf{s}_i,\mathbf{t}) = \mathbf{X}_{\mathbf{s}_i,\mathbf{t}} \boldsymbol{\beta}\]</span></p>
<ul>
<li><span class="math inline">\(\mathbf{X}_{\mathbf{s}_i,\mathbf{t}} = [1, \text{AvgTemp}_{\mathbf{s}_i,\mathbf{t}}, \text{Precp}_{\mathbf{s}_i,\mathbf{t}}, \text{srad}_{\mathbf{s}_i,\mathbf{t}}]\)</span> is the design matrix of predictors.</li>
<li><span class="math inline">\(\boldsymbol{\beta} = [\beta_0, \beta_1, \beta_2, \beta_3]\)</span> are the regression coefficients for the intercept and covariates.</li>
<li><span class="math inline">\(\beta_1\)</span> is the coefficient for the average temperature, which is the main interest in this study.</li>
</ul></li>
<li><p><em>Spatially Correlated Random Effect</em>: <span class="math display">\[w(\mathbf{s}_i) \sim \text{MVN}(\mathbf{0}, \mathbf{R})\]</span></p>
<ul>
<li><p><span class="math inline">\(\mathbf{R}\)</span> is the spatial correlation matrix defined by a covariance function.</p></li>
<li><p>In INLA, a spatial process with a Matérn covariance can be obtained as the weak solution to a stochastic partial differential equation (SPDE). The SPDE method uses the Finite Element Method (FEM) to approximate a spatial Gaussian Random Field (GRF). It constructs a triangulated mesh, where each node serves as a basis for interpolation. Basis functions are defined to be 1 at a node and decay to 0 at neighboring triangles, ensuring local influence. By discretizing the SPDE, the problem transforms into a sparse Gaussian Markov Random Field (GMRF), making computations more efficient for large spatial datasets.</p>
<ul>
<li>Matérn Covariance Function (if selected): <span class="math display">\[\mathbf{R}_{ij} = \sigma^2 \cdot \frac{2^{1-\nu}}{\Gamma(\nu)} \left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)^\nu K_\nu\left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)\]</span></li>
</ul></li>
</ul></li>
<li><p><em>Year-specific Random Effect</em>: <span class="math display">\[u(\mathbf{t}) \sim \text{N}(0, \tau^2_{\mathbf{t}})\]</span></p>
<ul>
<li><span class="math inline">\(u_{\mathbf{t}}\)</span> captures year-to-year variability, with <span class="math inline">\(\tau^2_{\mathbf{t}}\)</span> being the variance of the year effect.</li>
</ul></li>
<li><p><em>Independent Nugget Effect</em>: <span class="math display">\[\epsilon(\mathbf{s}_i) \sim \text{N}(0, \tau^2)\]</span></p>
<ul>
<li><span class="math inline">\(\epsilon(\mathbf{s}_i, \mathbf{t})\)</span> accounts for measurement error or small-scale variability.</li>
</ul></li>
</ul>
<p><strong>Get the posterior distribution of model parameters</strong>:</p>
<ul>
<li><strong>INLA</strong>: In <code>INLA</code> package, the Integrated Nested Laplace Approximation (INLA) was used to approximate the posterior distribution of the model parameters. Rather than estimating the joint posterior distribution of the parameters via MCMC, INLA focusing on individual posterior marginals of the model parameters, which is enough to make inference of the model parameters and latent effects in most cases.</li>
</ul>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">3 Results</h2>
<section id="genus-level" class="level3">
<h3 class="anchored" data-anchor-id="genus-level">3.1 Genus level</h3>
<section id="new-york-city" class="level4">
<h4 class="anchored" data-anchor-id="new-york-city">New York City</h4>
<p>Most genera showed negative association between temperature and the SOS, either significant or insignificant, suggesting the warmer winter, the earilier start of season. There are significant genus-level differences in how temperature influences the spring phenology.</p>
<p>The response to temperature is more consistent in the EOS. The response to temperature is positive for all genera, suggesting the warmer summer, the later end of season.</p>
<p>For GreenUp and GreenDown, there is not significant association between temperature and the phenology metrics.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_genus/NY/"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/genus_level/run_inla_fixpre.R"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>plots_coef <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">plot_coef_genus_city</span>(r_output_dir, phe_type)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  plots_coef[[phe_type]] <span class="ot">&lt;-</span> p1<span class="sc">$</span>coef_summary_plot</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>ny_genus <span class="ot">=</span> <span class="fu">wrap_plots</span>(plots_coef, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>ny_genus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ny_genus" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ny_genus-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_species_files/figure-html/fig-ny_genus-1.png" class="img-fluid figure-img" width="960">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ny_genus-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;9: The distribution of the posterior of regression coefficients for <code>Temp~avg~</code> for each genus in New York city.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="comparison-across-4-cities" class="level4">
<h4 class="anchored" data-anchor-id="comparison-across-4-cities">Comparison across 4 cities</h4>
<p>The response of SOS and EOS to temperature is consistent across cities: the warmer winter, the earilier start of season; the warmer summer, the later end of season.</p>
<p>The difference in response among cities is obvious. For SOS, most genera all cities showed negative association between temperature and the start of season. Only some genera in DV and ST had a positive association.</p>
<p>For EOS, the difference among cities is the most obvious. Genera in NY and ST had a higher positive association than those genera in DV. <strong>Precipitation/humidity/elevation?</strong></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_genus/"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/genus_level/run_inla_fixpre.R"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>plots_coef <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  plots_coef[[phe_type]] <span class="ot">&lt;-</span> <span class="fu">plot_coef_genus_cities</span>(r_output_dir, phe_type)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>cities_genus <span class="ot">=</span> <span class="fu">wrap_plots</span>(plots_coef, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>cities_genus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-cities_genus" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cities_genus-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_species_files/figure-html/fig-cities_genus-1.png" class="img-fluid figure-img" width="960">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cities_genus-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;10: The distribution of the posterior of regression coefficients for <code>Temp~avg~</code> on phenology for each genus.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="species-level" class="level3">
<h3 class="anchored" data-anchor-id="species-level">3.2 Species level</h3>
<p>Given the tree diversity within each genera, I also explored the species-level response to temperature. Here, I select 10 most abundant species shared by these 4 cities:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>species_table <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Canonical_Name,            <span class="sc">~</span>Common_Name,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Fraxinus pennsylvanica"</span>,   <span class="st">"Green Ash"</span>,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ulmus americana"</span>,          <span class="st">"American Elm"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Acer rubrum"</span>,              <span class="st">"Red Maple"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Quercus rubra"</span>,            <span class="st">"Northern Red Oak"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Acer saccharinum"</span>,         <span class="st">"Silver Maple"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Fraxinus americana"</span>,       <span class="st">"White Ash"</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ulmus pumila"</span>,             <span class="st">"Siberian Elm"</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Betula nigra"</span>,             <span class="st">"River Birch"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Quercus macrocarpa"</span>,       <span class="st">"Bur Oak"</span>,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Juglans nigra"</span>,            <span class="st">"Black Walnut"</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(species_table, <span class="at">caption =</span> <span class="st">"Top 10 Common Urban Tree Species"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Top 10 Common Urban Tree Species</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Canonical_Name</th>
<th style="text-align: left;">Common_Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Fraxinus pennsylvanica</td>
<td style="text-align: left;">Green Ash</td>
</tr>
<tr class="even">
<td style="text-align: left;">Ulmus americana</td>
<td style="text-align: left;">American Elm</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Acer rubrum</td>
<td style="text-align: left;">Red Maple</td>
</tr>
<tr class="even">
<td style="text-align: left;">Quercus rubra</td>
<td style="text-align: left;">Northern Red Oak</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Acer saccharinum</td>
<td style="text-align: left;">Silver Maple</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fraxinus americana</td>
<td style="text-align: left;">White Ash</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Ulmus pumila</td>
<td style="text-align: left;">Siberian Elm</td>
</tr>
<tr class="even">
<td style="text-align: left;">Betula nigra</td>
<td style="text-align: left;">River Birch</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Quercus macrocarpa</td>
<td style="text-align: left;">Bur Oak</td>
</tr>
<tr class="even">
<td style="text-align: left;">Juglans nigra</td>
<td style="text-align: left;">Black Walnut</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="new-york-city-1" class="level4">
<h4 class="anchored" data-anchor-id="new-york-city-1">New York City</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/NY/"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/species_level/run_inla.R"</span>)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>plots_coef <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">plot_coef_sp_city</span>(r_output_dir, phe_type)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  plots_coef[[phe_type]] <span class="ot">&lt;-</span> p1<span class="sc">$</span>coef_summary_plot</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>ny_sp <span class="ot">=</span> <span class="fu">wrap_plots</span>(plots_coef, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>ny_sp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-ny_sp" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ny_sp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_species_files/figure-html/fig-ny_sp-1.png" class="img-fluid figure-img" width="960">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ny_sp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;11: The distribution of the posterior of regression coefficients for <code>Temp~avg~</code> for each species in New York city.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="comparison-across-4-cities-1" class="level4">
<h4 class="anchored" data-anchor-id="comparison-across-4-cities-1">Comparison across 4 cities</h4>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/species_level/run_inla.R"</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>plots_coef <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  plots_coef[[phe_type]] <span class="ot">&lt;-</span> <span class="fu">plot_coef_sp_cities</span>(r_output_dir, phe_type)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>cities_sp <span class="ot">=</span> <span class="fu">wrap_plots</span>(plots_coef, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>cities_sp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-cities_sp" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cities_sp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="workflow_micro_NYC_species_files/figure-html/fig-cities_sp-1.png" class="img-fluid figure-img" width="960">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cities_sp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12: The distribution of the posterior of regression coefficients for <code>Temp~avg~</code> on phenology for each species
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="conclusion-and-next-step" class="level2">
<h2 class="anchored" data-anchor-id="conclusion-and-next-step">4 Conclusion and next step</h2>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<ul>
<li><p>Within the city, trees indeed respond to temperature variation, result in phenology variation.</p></li>
<li><p>Across cities, response variation patterns noticed.</p></li>
</ul>
</section>
<section id="next-steps" class="level3">
<h3 class="anchored" data-anchor-id="next-steps">Next steps</h3>
<ul>
<li><p><strong>What can the urban phenology heterogenity be used for?</strong> - Goal</p>
<ul>
<li><p>The preview of future warming: compared with the sensitivity in natural environment.</p></li>
<li><p>Fine-scale urban phenology: compared with other urban phenology sensitivity detected at coarser scale</p></li>
</ul></li>
<li><p>Scale up</p>
<ul>
<li>Cities</li>
<li>Genera</li>
</ul></li>
</ul>
<!-- #### Denver -->
<!-- ```{r} -->
<!-- r_output_dir <- paste0("~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/DV/") -->
<!-- source("~/phenology-urban/script/species_level/run_inla.R") -->
<!-- plots_coef <- list() -->
<!-- phe_types <- c("SOS", "EOS", "GreenUp", "GreenDown") -->
<!-- for (phe_type in phe_types) { -->
<!--   p1 <- plot_coef_sp_city(r_output_dir, phe_type) -->
<!--   plots_coef[[phe_type]] <- p1$coef_summary_plot -->
<!-- } -->
<!-- dv_sp = wrap_plots(plots_coef, ncol = 2) -->
<!-- dv_sp -->
<!-- ``` -->
<!-- #### Seattle -->
<!-- ```{r} -->
<!-- r_output_dir <- paste0("~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/ST/") -->
<!-- source("~/phenology-urban/script/species_level/run_inla.R") -->
<!-- plots_coef <- list() -->
<!-- phe_types <- c("SOS", "EOS", "GreenUp", "GreenDown") -->
<!-- for (phe_type in phe_types) { -->
<!--   p1 <- plot_coef_sp_city(r_output_dir, phe_type) -->
<!--   plots_coef[[phe_type]] <- p1$coef_summary_plot -->
<!-- } -->
<!-- st_sp = wrap_plots(plots_coef, ncol = 2) -->
<!-- st_sp -->
<!-- ``` -->
<!-- #### Houston -->
<!-- ```{r} -->
<!-- r_output_dir <- paste0("~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/HT/") -->
<!-- source("~/phenology-urban/script/species_level/run_inla.R") -->
<!-- plots_coef <- list() -->
<!-- phe_types <- c("SOS", "EOS", "GreenUp", "GreenDown") -->
<!-- for (phe_type in phe_types) { -->
<!--   p1 <- plot_coef_sp_city(r_output_dir, phe_type) -->
<!--   plots_coef[[phe_type]] <- p1$coef_summary_plot -->
<!-- } -->
<!-- ht_sp = wrap_plots(plots_coef, ncol = 2) -->
<!-- ht_sp -->
<!-- ``` -->


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb13" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Urban phenology"</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Jiali Zhu"</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> "today"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-overflow: wrap</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Code"</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="an">editor:</span><span class="co"> visual</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="an">toc:</span><span class="co"> true</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="an">toc-depth:</span><span class="co"> 3</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Phenology, the timing of periodic plant life cycle events, is sensitive to biotic and abiotic environment, especially the temperature (Meng et al., 2020).</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The significant Urban Heat Island effect leads to the shifts in urban phenology (L. Yang et al., 2023; Y. Zhou, 2022)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Treat city as a whole.</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Compare it to rural areas.</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Spatial unevenness of urban thermal environment might lead to the heterogeneity of phenology within the city.</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Negative correlation between the flowering date and the monthly mean LST in February–April.</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="al">![Katz et al., 2019](docs/katz_2019.png)</span>{#fig-katz_2019 fig-align="center" width="60%"}</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="in">    -   A significant spatial variation for First flowing date of 35 species, which negatively correlated withdaily LST.</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="in">    ![Xing et al., 2022](docs/xing_2022.png){#fig-xing_2022 fig-align="center" width="60%"}</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="fu">## Question and Hypothesis</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Question**: What is the spatial heterogeneity of individual tree phenology within a city, and across cities located in different climate regions? (genus and species level)</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Hypothesis**:</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>There is a significant spatial heterogeneity.</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Spatial heterogeneity in urban phenology is driven by the heterogeneous urban thermal environment</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>The magnitude and direction of this effect may differ among cities.</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Goal**:</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Insights into how vegetation adapts to altered environmental conditions under urbanization.</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Addresses the biological and societal consequences of phenological changes.</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-packages</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Install and load 'zhulabtools' package</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(zhulabtools)</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a><span class="co"># Manage packages: check, install, and load specific packages</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a><span class="fu">check_install_packages</span>(<span class="fu">c</span>(<span class="st">"dplyr"</span>,<span class="st">"lubridate"</span>, <span class="st">"ggplot2"</span>, <span class="st">"sf"</span>,<span class="st">"sp"</span>, <span class="st">"readr"</span>, <span class="st">"purrr"</span>, <span class="st">"stringr"</span>,<span class="st">"glue"</span>, <span class="st">"tidyr"</span>, <span class="st">"broom"</span>,<span class="st">"lme4"</span>, <span class="st">"broom.mixed"</span>, <span class="st">"ppcor"</span>, <span class="st">"spdep"</span>, <span class="st">"spatialreg"</span>, <span class="st">"lmtest"</span>,<span class="st">"car"</span>, <span class="st">"spBayes"</span>, <span class="st">"coda"</span>, <span class="st">"patchwork"</span>, <span class="st">"performance"</span>, <span class="st">"terra"</span>, <span class="st">"ggpmisc"</span>, <span class="st">"gstat"</span>, <span class="st">"ggmcmc"</span>, <span class="st">"taxize"</span>, <span class="st">"INLA"</span>, <span class="st">"stats"</span>, <span class="st">"knitr"</span>, <span class="st">"tibble"</span>, <span class="st">"viridis"</span>, <span class="st">"kableExtra"</span>))</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(plotbiomes)) {</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>  devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">"valentinitnelav/plotbiomes"</span>)</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a><span class="fu">load_packages</span>(<span class="fu">c</span>(<span class="st">"dplyr"</span>,<span class="st">"lubridate"</span>, <span class="st">"ggplot2"</span>, <span class="st">"sf"</span>,<span class="st">"sp"</span>, <span class="st">"readr"</span>, <span class="st">"purrr"</span>, <span class="st">"stringr"</span>,<span class="st">"glue"</span>, <span class="st">"tidyr"</span>, <span class="st">"broom"</span>,<span class="st">"lme4"</span>, <span class="st">"broom.mixed"</span>, <span class="st">"ppcor"</span>, <span class="st">"spdep"</span>, <span class="st">"spatialreg"</span>, <span class="st">"lmtest"</span>,<span class="st">"car"</span>, <span class="st">"spBayes"</span>, <span class="st">"coda"</span>, <span class="st">"patchwork"</span>, <span class="st">"performance"</span>, <span class="st">"terra"</span>, <span class="st">"ggpmisc"</span>, <span class="st">"gstat"</span>, <span class="st">"ggmcmc"</span>, <span class="st">"taxize"</span>, <span class="st">"INLA"</span>, <span class="st">"stats"</span>, <span class="st">"tibble"</span>, <span class="st">"viridis"</span>, <span class="st">"kableExtra"</span>))</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>select <span class="ot">&lt;-</span> dplyr<span class="sc">::</span>select <span class="co"># Avoid masking by base R's select function</span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: read_wu_data2</span></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>cities <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"HT"</span>, <span class="st">"NY"</span>, <span class="st">"ST"</span>, <span class="st">"DV"</span>)</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>phe_type <span class="ot">&lt;-</span> <span class="st">"GreenDown"</span> </span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>model_input_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/species_level/tidy_model_input.R"</span>)</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (city <span class="cf">in</span> cities) {</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>  points_in_buffer <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tree_WU_500_buffer_PS.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>  all_sites_temp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>,city,<span class="st">"/"</span>,city,<span class="st">"_wu.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(Date, HighTemp, AvgTemp, LowTemp, Sum_mm, name)) <span class="sc">%&gt;%</span></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">season =</span> <span class="fu">case_when</span>(</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(Date) <span class="sc">%in%</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span> <span class="sc">~</span> <span class="st">"spring"</span>,</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(Date) <span class="sc">%in%</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">8</span> <span class="sc">~</span> <span class="st">"summer"</span>,</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(Date) <span class="sc">%in%</span> <span class="dv">9</span><span class="sc">:</span><span class="dv">11</span> <span class="sc">~</span> <span class="st">"fall"</span>,</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(Date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">~</span> <span class="st">"winter"</span></span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(Date),</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>           <span class="at">year =</span> <span class="fu">if_else</span>(<span class="fu">month</span>(Date) <span class="sc">==</span> <span class="dv">12</span>, year <span class="sc">+</span> <span class="dv">1</span>, year)) <span class="sc">%&gt;%</span></span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(name, year, season) <span class="sc">%&gt;%</span></span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>      <span class="at">Avg_AvgTemp =</span> <span class="fu">mean</span>(AvgTemp, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>      <span class="at">Sum_Sum_mm =</span> <span class="fu">sum</span>(Sum_mm, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">AvgTemp_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(AvgTemp)),</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">Sum_mm_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(Sum_mm)),</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>  srad_daily <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/raw/"</span>,city,<span class="st">"/Daymet/daily2016-2024/srad_daily_2016-2023.rds"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(id, value, date)  <span class="sc">%&gt;%</span></span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">season =</span> <span class="fu">case_when</span>(</span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">3</span><span class="sc">:</span><span class="dv">5</span> <span class="sc">~</span> <span class="st">"spring"</span>,</span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">6</span><span class="sc">:</span><span class="dv">8</span> <span class="sc">~</span> <span class="st">"summer"</span>,</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="dv">9</span><span class="sc">:</span><span class="dv">11</span> <span class="sc">~</span> <span class="st">"fall"</span>,</span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>      <span class="fu">month</span>(date) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">~</span> <span class="st">"winter"</span></span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a>    )) <span class="sc">%&gt;%</span></span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date),</span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>           <span class="at">year =</span> <span class="fu">if_else</span>(<span class="fu">month</span>(date) <span class="sc">==</span> <span class="dv">12</span>, year <span class="sc">+</span> <span class="dv">1</span>, year)) <span class="sc">%&gt;%</span></span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(id, year, season) <span class="sc">%&gt;%</span></span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>      <span class="at">Avg_srad =</span> <span class="fu">mean</span>(value, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>      <span class="at">srad_count =</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(value)),</span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a>  model_input_all <span class="ot">&lt;-</span> <span class="fu">prepare_data</span>(phe_type, points_in_buffer, all_sites_temp, srad_daily)</span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>  model_input_list[[city]] <span class="ot">&lt;-</span> model_input_all</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a>city_names <span class="ot">&lt;-</span> <span class="fu">names</span>(model_input_list)</span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(city_names, <span class="cf">function</span>(city) {</span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>    model_input_list[[city]] <span class="sc">%&gt;%</span></span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(canonicalname) <span class="sc">%&gt;%</span></span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">city =</span> city)</span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a>species_city_count <span class="ot">&lt;-</span> combined <span class="sc">%&gt;%</span></span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(city, canonicalname) <span class="sc">%&gt;%</span></span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(canonicalname, <span class="at">name =</span> <span class="st">"n_cities"</span>)</span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a>common_species <span class="ot">&lt;-</span> species_city_count <span class="sc">%&gt;%</span></span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_cities <span class="sc">==</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(canonicalname)</span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a>top10_species <span class="ot">&lt;-</span> combined <span class="sc">%&gt;%</span></span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(canonicalname <span class="sc">%in%</span> common_species) <span class="sc">%&gt;%</span></span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(canonicalname, <span class="at">name =</span> <span class="st">"total_count"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(total_count)) <span class="sc">%&gt;%</span></span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a>top10_species</span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> 2.1 Species level --&gt;</span></span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: species</span></span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: False</span></span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/species_level/run_inla.R"</span>)</span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (city <span class="cf">in</span> cities) {</span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a>  r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/"</span>, city, <span class="st">"/"</span>)</span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a>  phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"GreenDown"</span>)</span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lapply</span>(phe_types, <span class="cf">function</span>(phe_type) {</span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a>    model_input_all <span class="ot">&lt;-</span> model_input_list[[city]] <span class="sc">%&gt;%</span></span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(canonicalname <span class="sc">%in%</span> top10_species<span class="sc">$</span>canonicalname)</span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a>      <span class="co"># prepare_data(phe_type, points_in_buffer, all_sites_temp, srad_daily)</span></span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a>    <span class="fu">run_inla_species</span>(model_input_all, r_output_dir, phe_type, city)</span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">###</span><span class="co"> 2.2 Genus level --&gt;</span></span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: genus</span></span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: False</span></span>
<span id="cb13-180"><a href="#cb13-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-181"><a href="#cb13-181" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/genus_level/run_inla_fixpre.R"</span>)</span>
<span id="cb13-182"><a href="#cb13-182" aria-hidden="true" tabindex="-1"></a>r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_genus/"</span>, city, <span class="st">"/"</span>)</span>
<span id="cb13-183"><a href="#cb13-183" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb13-184"><a href="#cb13-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-185"><a href="#cb13-185" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(phe_types, <span class="cf">function</span>(phe_type) {</span>
<span id="cb13-186"><a href="#cb13-186" aria-hidden="true" tabindex="-1"></a>  model_input_all <span class="ot">&lt;-</span> <span class="fu">prepare_data</span>(phe_type, points_in_buffer, all_sites_temp, srad_daily)</span>
<span id="cb13-187"><a href="#cb13-187" aria-hidden="true" tabindex="-1"></a>  <span class="fu">run_inla_genus</span>(model_input_all, r_output_dir, phe_type, city)</span>
<span id="cb13-188"><a href="#cb13-188" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb13-189"><a href="#cb13-189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-190"><a href="#cb13-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-191"><a href="#cb13-191" aria-hidden="true" tabindex="-1"></a><span class="fu">## 1 Raw data</span></span>
<span id="cb13-192"><a href="#cb13-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-193"><a href="#cb13-193" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1.1 Read and clean the WU data (based on GHCNd)</span></span>
<span id="cb13-194"><a href="#cb13-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-195"><a href="#cb13-195" aria-hidden="true" tabindex="-1"></a>The urban microclimate information comes from the <span class="co">[</span><span class="ot">Weather Underground program</span><span class="co">](https://www.wunderground.com/)</span>. There are 4 raw daily variables selected, i.e. AvgTemp, HighTemp, LowTemp and SumPrcp. I flagged the records which are unknown or questionable according to the methods applied by Global Historical Climatology Network daily <span class="co">[</span><span class="ot">GHCNd</span><span class="co">](https://www.ncei.noaa.gov/products/land-based-station/global-historical-climatology-network-daily)</span>.</span>
<span id="cb13-196"><a href="#cb13-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-197"><a href="#cb13-197" aria-hidden="true" tabindex="-1"></a>For initial analysis, I collect the date from 4 cities, i.e. New York, Houston, Detroit, and Seattle.</span>
<span id="cb13-198"><a href="#cb13-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-201"><a href="#cb13-201" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-202"><a href="#cb13-202" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-wu_sites</span></span>
<span id="cb13-203"><a href="#cb13-203" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb13-204"><a href="#cb13-204" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 5.5</span></span>
<span id="cb13-205"><a href="#cb13-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Number of WU sites in each city"</span></span>
<span id="cb13-206"><a href="#cb13-206" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb13-207"><a href="#cb13-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-208"><a href="#cb13-208" aria-hidden="true" tabindex="-1"></a><span class="co"># No. of WU sites</span></span>
<span id="cb13-209"><a href="#cb13-209" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-210"><a href="#cb13-210" aria-hidden="true" tabindex="-1"></a>  <span class="at">Category =</span> <span class="fu">c</span>(<span class="st">"DV"</span>, <span class="st">"NY"</span>, <span class="st">"ST"</span>, <span class="st">"HT"</span>),</span>
<span id="cb13-211"><a href="#cb13-211" aria-hidden="true" tabindex="-1"></a>  <span class="at">Number_of_Sites =</span> <span class="fu">c</span>(<span class="dv">226</span>, <span class="dv">148</span>, <span class="dv">367</span>, <span class="dv">171</span>)</span>
<span id="cb13-212"><a href="#cb13-212" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-213"><a href="#cb13-213" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> Category, <span class="at">y =</span> Number_of_Sites)) <span class="sc">+</span></span>
<span id="cb13-214"><a href="#cb13-214" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>) <span class="sc">+</span></span>
<span id="cb13-215"><a href="#cb13-215" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> Number_of_Sites), <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb13-216"><a href="#cb13-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Category"</span>, <span class="at">y =</span> <span class="st">"Number of Sites"</span>) <span class="sc">+</span></span>
<span id="cb13-217"><a href="#cb13-217" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb13-218"><a href="#cb13-218" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb13-219"><a href="#cb13-219" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">18</span>),</span>
<span id="cb13-220"><a href="#cb13-220" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">20</span>)) <span class="sc">+</span></span>
<span id="cb13-221"><a href="#cb13-221" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb13-222"><a href="#cb13-222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-223"><a href="#cb13-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-226"><a href="#cb13-226" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-227"><a href="#cb13-227" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-tree_wu_sites</span></span>
<span id="cb13-228"><a href="#cb13-228" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb13-229"><a href="#cb13-229" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Location of WU sites and trees"</span></span>
<span id="cb13-230"><a href="#cb13-230" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 15</span></span>
<span id="cb13-231"><a href="#cb13-231" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb13-232"><a href="#cb13-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-233"><a href="#cb13-233" aria-hidden="true" tabindex="-1"></a>cities <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"NY"</span>, <span class="st">"HT"</span>, <span class="st">"DV"</span>, <span class="st">"ST"</span>)</span>
<span id="cb13-234"><a href="#cb13-234" aria-hidden="true" tabindex="-1"></a>plots <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb13-235"><a href="#cb13-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-236"><a href="#cb13-236" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (city <span class="cf">in</span> cities){</span>
<span id="cb13-237"><a href="#cb13-237" aria-hidden="true" tabindex="-1"></a>  points_in_buffer <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/"</span>,city,<span class="st">"/tree_WU_500_buffer_PS.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-238"><a href="#cb13-238" aria-hidden="true" tabindex="-1"></a>  points_in_buffer_sf <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb13-239"><a href="#cb13-239" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb13-240"><a href="#cb13-240" aria-hidden="true" tabindex="-1"></a>  <span class="co"># us_boundary &lt;- st_read("~/urban-niche/data/raw/CONUS/boundary/us_boundarydissolve.shp") %&gt;%</span></span>
<span id="cb13-241"><a href="#cb13-241" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     st_transform(4326)</span></span>
<span id="cb13-242"><a href="#cb13-242" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-243"><a href="#cb13-243" aria-hidden="true" tabindex="-1"></a>  boundary <span class="ot">&lt;-</span> <span class="cf">switch</span>(</span>
<span id="cb13-244"><a href="#cb13-244" aria-hidden="true" tabindex="-1"></a>    city,</span>
<span id="cb13-245"><a href="#cb13-245" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NY"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-246"><a href="#cb13-246" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb13-247"><a href="#cb13-247" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DT/City_of_Detroit_Boundary/City_of_Detroit_Boundary.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-248"><a href="#cb13-248" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb13-249"><a href="#cb13-249" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ST"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/ST/seattle_boundary/CityUGA.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-250"><a href="#cb13-250" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-251"><a href="#cb13-251" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Seattle"</span>),</span>
<span id="cb13-252"><a href="#cb13-252" aria-hidden="true" tabindex="-1"></a>    <span class="st">"HT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/HT/HGAC_City_Boundaries/HGAC_City_Boundaries.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-253"><a href="#cb13-253" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Houston"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-254"><a href="#cb13-254" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb13-255"><a href="#cb13-255" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TP"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/TP/Municipal_Boundary/Municipal_Boundary.shp"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-256"><a href="#cb13-256" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-257"><a href="#cb13-257" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(NAME <span class="sc">==</span> <span class="st">"Tampa"</span>),</span>
<span id="cb13-258"><a href="#cb13-258" aria-hidden="true" tabindex="-1"></a>    <span class="st">"DV"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/DV/DRCOG_Municipalities/DRCOG_Municipalities.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-259"><a href="#cb13-259" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(city <span class="sc">==</span> <span class="st">"Denver"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-260"><a href="#cb13-260" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb13-261"><a href="#cb13-261" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AT"</span> <span class="ot">=</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/AT/TxDOT_City_Boundaries/Cities.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-262"><a href="#cb13-262" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(CITY_NM <span class="sc">==</span> <span class="st">"Austin"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-263"><a href="#cb13-263" aria-hidden="true" tabindex="-1"></a>      <span class="fu">st_transform</span>(<span class="dv">4326</span>),</span>
<span id="cb13-264"><a href="#cb13-264" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Invalid city abbreviation."</span>)</span>
<span id="cb13-265"><a href="#cb13-265" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-266"><a href="#cb13-266" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-267"><a href="#cb13-267" aria-hidden="true" tabindex="-1"></a>  wu_location <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/"</span>, city, <span class="st">"/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-268"><a href="#cb13-268" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb13-269"><a href="#cb13-269" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-270"><a href="#cb13-270" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb13-271"><a href="#cb13-271" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> boundary, <span class="at">fill =</span> <span class="st">"grey90"</span>) <span class="sc">+</span></span>
<span id="cb13-272"><a href="#cb13-272" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_sf(data = us_boundary, color = "blue", size = 1) +</span></span>
<span id="cb13-273"><a href="#cb13-273" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> wu_location, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb13-274"><a href="#cb13-274" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_point(data = points_in_buffer, aes(x = lon, y = lat), color = "red",size = 0.01, alpha = 0.01) +</span></span>
<span id="cb13-275"><a href="#cb13-275" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> city) <span class="sc">+</span></span>
<span id="cb13-276"><a href="#cb13-276" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb13-277"><a href="#cb13-277" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb13-278"><a href="#cb13-278" aria-hidden="true" tabindex="-1"></a>  plots[[city]] <span class="ot">=</span> p</span>
<span id="cb13-279"><a href="#cb13-279" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-280"><a href="#cb13-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-281"><a href="#cb13-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-282"><a href="#cb13-282" aria-hidden="true" tabindex="-1"></a>combined_plot <span class="ot">&lt;-</span> <span class="fu">wrap_plots</span>(plots, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb13-283"><a href="#cb13-283" aria-hidden="true" tabindex="-1"></a>combined_plot</span>
<span id="cb13-284"><a href="#cb13-284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-285"><a href="#cb13-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-286"><a href="#cb13-286" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1.2 Shortwave data from Daymet</span></span>
<span id="cb13-287"><a href="#cb13-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-288"><a href="#cb13-288" aria-hidden="true" tabindex="-1"></a>To control for the influence of other variables on phenology, I also incorporated shortwave radiation data derived from the <span class="co">[</span><span class="ot">Daymet daily dataset</span><span class="co">](https://daymet.ornl.gov/)</span> with a 1 km resolution. Shortwave radiation was extracted for the specific locations of the trees.</span>
<span id="cb13-289"><a href="#cb13-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-292"><a href="#cb13-292" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-293"><a href="#cb13-293" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-plot_daymet</span></span>
<span id="cb13-294"><a href="#cb13-294" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb13-295"><a href="#cb13-295" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The shortwave radiation raster in 2023-01-01, NY"</span></span>
<span id="cb13-296"><a href="#cb13-296" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb13-297"><a href="#cb13-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-298"><a href="#cb13-298" aria-hidden="true" tabindex="-1"></a><span class="co"># download</span></span>
<span id="cb13-299"><a href="#cb13-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-300"><a href="#cb13-300" aria-hidden="true" tabindex="-1"></a>city <span class="ot">=</span> <span class="st">"NY"</span></span>
<span id="cb13-301"><a href="#cb13-301" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/raw/"</span>, city, <span class="st">"/Daymet/daily2016-2024/"</span>)</span>
<span id="cb13-302"><a href="#cb13-302" aria-hidden="true" tabindex="-1"></a>file <span class="ot">&lt;-</span> <span class="fu">list.files</span>(data_dir, <span class="at">pattern =</span> <span class="st">"srad_daily_2023_ncss</span><span class="sc">\\</span><span class="st">.nc$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-303"><a href="#cb13-303" aria-hidden="true" tabindex="-1"></a>srad_nc <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(file)</span>
<span id="cb13-304"><a href="#cb13-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-305"><a href="#cb13-305" aria-hidden="true" tabindex="-1"></a>srad_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(srad_nc[[<span class="dv">1</span>]], <span class="at">xy =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-306"><a href="#cb13-306" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(srad_df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">fill =</span> srad_1)) <span class="sc">+</span></span>
<span id="cb13-307"><a href="#cb13-307" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_raster</span>() <span class="sc">+</span></span>
<span id="cb13-308"><a href="#cb13-308" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">name =</span> <span class="st">"W/m²"</span>) <span class="sc">+</span></span>
<span id="cb13-309"><a href="#cb13-309" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Shortwave Radiation (W/m²) - 2023-01-01"</span>, <span class="at">x =</span> <span class="st">"x"</span>, <span class="at">y =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb13-310"><a href="#cb13-310" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb13-311"><a href="#cb13-311" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-312"><a href="#cb13-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-313"><a href="#cb13-313" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1.3 Select the street tree base on WU data</span></span>
<span id="cb13-314"><a href="#cb13-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-315"><a href="#cb13-315" aria-hidden="true" tabindex="-1"></a>I used the street tree in the above 4 cities, with the phenology records established by Yiluan. These trees are part of the whole inventory, covering 14 genera and being sampled. I select the trees which are within **500 m** buffer around the Weather Underground sites (see @fig-tree_wu_sites2).</span>
<span id="cb13-316"><a href="#cb13-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-319"><a href="#cb13-319" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-320"><a href="#cb13-320" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-tree_wu_sites2</span></span>
<span id="cb13-321"><a href="#cb13-321" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb13-322"><a href="#cb13-322" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Location of WU sites and trees, zoom in NY"</span></span>
<span id="cb13-323"><a href="#cb13-323" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 15</span></span>
<span id="cb13-324"><a href="#cb13-324" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb13-325"><a href="#cb13-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-326"><a href="#cb13-326" aria-hidden="true" tabindex="-1"></a>points_in_buffer <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/NY/tree_WU_500_buffer_PS.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-327"><a href="#cb13-327" aria-hidden="true" tabindex="-1"></a>points_in_buffer_sf <span class="ot">&lt;-</span> points_in_buffer <span class="sc">%&gt;%</span></span>
<span id="cb13-328"><a href="#cb13-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb13-329"><a href="#cb13-329" aria-hidden="true" tabindex="-1"></a><span class="co"># us_boundary &lt;- st_read("~/urban-niche/data/raw/CONUS/boundary/us_boundarydissolve.shp") %&gt;%</span></span>
<span id="cb13-330"><a href="#cb13-330" aria-hidden="true" tabindex="-1"></a><span class="co">#     st_transform(4326)</span></span>
<span id="cb13-331"><a href="#cb13-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-332"><a href="#cb13-332" aria-hidden="true" tabindex="-1"></a>boundary <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"~/urban-cooling/data/raw/WU/NY/Untitled/nybb_dissolved.shp"</span>,<span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-333"><a href="#cb13-333" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb13-334"><a href="#cb13-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-335"><a href="#cb13-335" aria-hidden="true" tabindex="-1"></a>wu_location <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(<span class="st">"~/urban-cooling/data/raw/WU/NY/location.csv"</span>), <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-336"><a href="#cb13-336" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"Lon"</span>, <span class="st">"Lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb13-337"><a href="#cb13-337" aria-hidden="true" tabindex="-1"></a>wu_buffer <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(wu_location, <span class="at">dist =</span> <span class="dv">500</span>)</span>
<span id="cb13-338"><a href="#cb13-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-339"><a href="#cb13-339" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb13-340"><a href="#cb13-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> boundary, <span class="at">fill =</span> <span class="st">"grey90"</span>) <span class="sc">+</span></span>
<span id="cb13-341"><a href="#cb13-341" aria-hidden="true" tabindex="-1"></a>  <span class="co"># geom_sf(data = us_boundary, color = "blue", size = 1) +</span></span>
<span id="cb13-342"><a href="#cb13-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wu_buffer, <span class="at">fill =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb13-343"><a href="#cb13-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> wu_location, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span></span>
<span id="cb13-344"><a href="#cb13-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> points_in_buffer, <span class="fu">aes</span>(<span class="at">x =</span> lon, <span class="at">y =</span> lat, <span class="at">alpha =</span> <span class="fl">0.01</span>), <span class="at">color =</span> <span class="st">"red"</span>,<span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb13-345"><a href="#cb13-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"NY"</span>) <span class="sc">+</span></span>
<span id="cb13-346"><a href="#cb13-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">74.05</span>, <span class="sc">-</span><span class="fl">73.95</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fl">40.7</span>, <span class="fl">40.75</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb13-347"><a href="#cb13-347" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb13-348"><a href="#cb13-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>, <span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span>
<span id="cb13-349"><a href="#cb13-349" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-350"><a href="#cb13-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-351"><a href="#cb13-351" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2 Method</span></span>
<span id="cb13-352"><a href="#cb13-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-353"><a href="#cb13-353" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.1 Phenological indicators</span></span>
<span id="cb13-354"><a href="#cb13-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-355"><a href="#cb13-355" aria-hidden="true" tabindex="-1"></a>The tree locations points were overlapped with Planetscope imageries to extract the reflectance values. After smoothing and regression, we could get the EVI curve. The phenological metrics were calculated based on the EVI curve:</span>
<span id="cb13-356"><a href="#cb13-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-357"><a href="#cb13-357" aria-hidden="true" tabindex="-1"></a><span class="al">![Extract reflectance from PlanetScope based on tree location, an example in NY](docs/ps_example.png)</span>{#fig-ps_example fig-align="center" width="60%"}</span>
<span id="cb13-358"><a href="#cb13-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-359"><a href="#cb13-359" aria-hidden="true" tabindex="-1"></a><span class="al">![Phenology metrics calculated based on EVI curve from PlanetScope](docs/pheno_matrix.png)</span>{#fig-pheno_matrics}</span>
<span id="cb13-360"><a href="#cb13-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-361"><a href="#cb13-361" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Spring phenology</span>
<span id="cb13-362"><a href="#cb13-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-363"><a href="#cb13-363" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`SOS`</span>: Defined as the day of year when individual tree growing season EVI curves first cross the green-up 50% threshold.</span>
<span id="cb13-364"><a href="#cb13-364" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`Green-up Pace`</span>: Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-up 20% threshold to the 80% threshold.</span>
<span id="cb13-365"><a href="#cb13-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-366"><a href="#cb13-366" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Fall phenology</span>
<span id="cb13-367"><a href="#cb13-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-368"><a href="#cb13-368" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`EOS`</span>: Defined as the day of year when individual tree growing season EVI curves first cross the green-down 50% threshold.</span>
<span id="cb13-369"><a href="#cb13-369" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`Green-down Pace`</span>: Defined as the time span (in days) required for the individual tree growing season EVI curves to transition from the green-down 20% threshold to the 80% threshold.</span>
<span id="cb13-370"><a href="#cb13-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-371"><a href="#cb13-371" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Preseason: Defined as the time span (in days) to calculate the average temperature and precipitation.</span>
<span id="cb13-372"><a href="#cb13-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-373"><a href="#cb13-373" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`SOS`</span>: Winter.</span>
<span id="cb13-374"><a href="#cb13-374" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`Green-up Pace`</span>: Spring</span>
<span id="cb13-375"><a href="#cb13-375" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`EOS`</span>: Summer</span>
<span id="cb13-376"><a href="#cb13-376" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span><span class="in">`Green-down Pace`</span>: Fall</span>
<span id="cb13-377"><a href="#cb13-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-378"><a href="#cb13-378" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2.2 Spatial model</span></span>
<span id="cb13-379"><a href="#cb13-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-380"><a href="#cb13-380" aria-hidden="true" tabindex="-1"></a>I modeled the relationship between the phenology and environmental covariates using a spatial hierarchical model. The response variable (phenology parameter) at location $\mathbf{s}_i$ and in year $\mathbf{t}$, denoted as $y(\mathbf{s}_i, \mathbf{t})$, was modeled as following model:</span>
<span id="cb13-381"><a href="#cb13-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-382"><a href="#cb13-382" aria-hidden="true" tabindex="-1"></a>**Model:**</span>
<span id="cb13-383"><a href="#cb13-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-384"><a href="#cb13-384" aria-hidden="true" tabindex="-1"></a>$$y(\mathbf{s}_i, \mathbf{t}) = \mu(\mathbf{s}_i,\mathbf{t}) + w(\mathbf{s}_i) + u(\mathbf{t}) + \epsilon(\mathbf{s}_i, \mathbf{t})$$</span>
<span id="cb13-385"><a href="#cb13-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-386"><a href="#cb13-386" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb13-387"><a href="#cb13-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-388"><a href="#cb13-388" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Fixed Effects*: $$\mu(\mathbf{s}_i,\mathbf{t}) = \mathbf{X}_{\mathbf{s}_i,\mathbf{t}} \boldsymbol{\beta}$$</span>
<span id="cb13-389"><a href="#cb13-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-390"><a href="#cb13-390" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\mathbf{X}_{\mathbf{s}_i,\mathbf{t}} = [1, \text{AvgTemp}_{\mathbf{s}_i,\mathbf{t}}, \text{Precp}_{\mathbf{s}_i,\mathbf{t}}, \text{srad}_{\mathbf{s}_i,\mathbf{t}}]$ is the design matrix of predictors.</span>
<span id="cb13-391"><a href="#cb13-391" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\boldsymbol{\beta} = <span class="co">[</span><span class="ot">\beta_0, \beta_1, \beta_2, \beta_3</span><span class="co">]</span>$ are the regression coefficients for the intercept and covariates.</span>
<span id="cb13-392"><a href="#cb13-392" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\beta_1$ is the coefficient for the average temperature, which is the main interest in this study.</span>
<span id="cb13-393"><a href="#cb13-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-394"><a href="#cb13-394" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Spatially Correlated Random Effect*: $$w(\mathbf{s}_i) \sim \text{MVN}(\mathbf{0}, \mathbf{R})$$</span>
<span id="cb13-395"><a href="#cb13-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-396"><a href="#cb13-396" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\mathbf{R}$ is the spatial correlation matrix defined by a covariance function.</span>
<span id="cb13-397"><a href="#cb13-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-398"><a href="#cb13-398" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>In INLA, a spatial process with a Matérn covariance can be obtained as the weak solution to a stochastic partial differential equation (SPDE). The SPDE method uses the Finite Element Method (FEM) to approximate a spatial Gaussian Random Field (GRF). It constructs a triangulated mesh, where each node serves as a basis for interpolation. Basis functions are defined to be 1 at a node and decay to 0 at neighboring triangles, ensuring local influence. By discretizing the SPDE, the problem transforms into a sparse Gaussian Markov Random Field (GMRF), making computations more efficient for large spatial datasets.</span>
<span id="cb13-399"><a href="#cb13-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-400"><a href="#cb13-400" aria-hidden="true" tabindex="-1"></a><span class="ss">        -   </span>Matérn Covariance Function (if selected): $$\mathbf{R}_{ij} = \sigma^2 \cdot \frac{2^{1-\nu}}{\Gamma(\nu)} \left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)^\nu K_\nu\left(\frac{\sqrt{2\nu} D_{ij}}{\rho}\right)$$</span>
<span id="cb13-401"><a href="#cb13-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-402"><a href="#cb13-402" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Year-specific Random Effect*: $$u(\mathbf{t}) \sim \text{N}(0, \tau^2_{\mathbf{t}})$$</span>
<span id="cb13-403"><a href="#cb13-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-404"><a href="#cb13-404" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$u_{\mathbf{t}}$ captures year-to-year variability, with $\tau^2_{\mathbf{t}}$ being the variance of the year effect.</span>
<span id="cb13-405"><a href="#cb13-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-406"><a href="#cb13-406" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>*Independent Nugget Effect*: $$\epsilon(\mathbf{s}_i) \sim \text{N}(0, \tau^2)$$</span>
<span id="cb13-407"><a href="#cb13-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-408"><a href="#cb13-408" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>$\epsilon(\mathbf{s}_i, \mathbf{t})$ accounts for measurement error or small-scale variability.</span>
<span id="cb13-409"><a href="#cb13-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-410"><a href="#cb13-410" aria-hidden="true" tabindex="-1"></a>**Get the posterior distribution of model parameters**:</span>
<span id="cb13-411"><a href="#cb13-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-412"><a href="#cb13-412" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**INLA**: In <span class="in">`INLA`</span> package, the Integrated Nested Laplace Approximation (INLA) was used to approximate the posterior distribution of the model parameters. Rather than estimating the joint posterior distribution of the parameters via MCMC, INLA focusing on individual posterior marginals of the model parameters, which is enough to make inference of the model parameters and latent effects in most cases.</span>
<span id="cb13-413"><a href="#cb13-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-414"><a href="#cb13-414" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3 Results</span></span>
<span id="cb13-415"><a href="#cb13-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-416"><a href="#cb13-416" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.1 Genus level</span></span>
<span id="cb13-417"><a href="#cb13-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-418"><a href="#cb13-418" aria-hidden="true" tabindex="-1"></a><span class="fu">#### New York City</span></span>
<span id="cb13-419"><a href="#cb13-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-420"><a href="#cb13-420" aria-hidden="true" tabindex="-1"></a>Most genera showed negative association between temperature and the SOS, either significant or insignificant, suggesting the warmer winter, the earilier start of season. There are significant genus-level differences in how temperature influences the spring phenology.</span>
<span id="cb13-421"><a href="#cb13-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-422"><a href="#cb13-422" aria-hidden="true" tabindex="-1"></a>The response to temperature is more consistent in the EOS. The response to temperature is positive for all genera, suggesting the warmer summer, the later end of season.</span>
<span id="cb13-423"><a href="#cb13-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-424"><a href="#cb13-424" aria-hidden="true" tabindex="-1"></a>For GreenUp and GreenDown, there is not significant association between temperature and the phenology metrics.</span>
<span id="cb13-425"><a href="#cb13-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-428"><a href="#cb13-428" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-429"><a href="#cb13-429" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_genus</span></span>
<span id="cb13-430"><a href="#cb13-430" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb13-431"><a href="#cb13-431" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb13-432"><a href="#cb13-432" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb13-433"><a href="#cb13-433" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The distribution of the posterior of regression coefficients for `Temp~avg~` for each genus in New York city."</span></span>
<span id="cb13-434"><a href="#cb13-434" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb13-435"><a href="#cb13-435" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb13-436"><a href="#cb13-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-437"><a href="#cb13-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-438"><a href="#cb13-438" aria-hidden="true" tabindex="-1"></a>r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_genus/NY/"</span>)</span>
<span id="cb13-439"><a href="#cb13-439" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/genus_level/run_inla_fixpre.R"</span>)</span>
<span id="cb13-440"><a href="#cb13-440" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb13-441"><a href="#cb13-441" aria-hidden="true" tabindex="-1"></a>plots_coef <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb13-442"><a href="#cb13-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-443"><a href="#cb13-443" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb13-444"><a href="#cb13-444" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">plot_coef_genus_city</span>(r_output_dir, phe_type)</span>
<span id="cb13-445"><a href="#cb13-445" aria-hidden="true" tabindex="-1"></a>  plots_coef[[phe_type]] <span class="ot">&lt;-</span> p1<span class="sc">$</span>coef_summary_plot</span>
<span id="cb13-446"><a href="#cb13-446" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-447"><a href="#cb13-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-448"><a href="#cb13-448" aria-hidden="true" tabindex="-1"></a>ny_genus <span class="ot">=</span> <span class="fu">wrap_plots</span>(plots_coef, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb13-449"><a href="#cb13-449" aria-hidden="true" tabindex="-1"></a>ny_genus</span>
<span id="cb13-450"><a href="#cb13-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-451"><a href="#cb13-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-452"><a href="#cb13-452" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Comparison across 4 cities</span></span>
<span id="cb13-453"><a href="#cb13-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-454"><a href="#cb13-454" aria-hidden="true" tabindex="-1"></a>The response of SOS and EOS to temperature is consistent across cities: the warmer winter, the earilier start of season; the warmer summer, the later end of season.</span>
<span id="cb13-455"><a href="#cb13-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-456"><a href="#cb13-456" aria-hidden="true" tabindex="-1"></a>The difference in response among cities is obvious. For SOS, most genera all cities showed negative association between temperature and the start of season. Only some genera in DV and ST had a positive association.</span>
<span id="cb13-457"><a href="#cb13-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-458"><a href="#cb13-458" aria-hidden="true" tabindex="-1"></a>For EOS, the difference among cities is the most obvious. Genera in NY and ST had a higher positive association than those genera in DV. **Precipitation/humidity/elevation?**</span>
<span id="cb13-459"><a href="#cb13-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-462"><a href="#cb13-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-463"><a href="#cb13-463" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cities_genus</span></span>
<span id="cb13-464"><a href="#cb13-464" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb13-465"><a href="#cb13-465" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The distribution of the posterior of regression coefficients for `Temp~avg~` on phenology for each genus."</span></span>
<span id="cb13-466"><a href="#cb13-466" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb13-467"><a href="#cb13-467" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb13-468"><a href="#cb13-468" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb13-469"><a href="#cb13-469" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb13-470"><a href="#cb13-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-471"><a href="#cb13-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-472"><a href="#cb13-472" aria-hidden="true" tabindex="-1"></a>r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_genus/"</span>)</span>
<span id="cb13-473"><a href="#cb13-473" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/genus_level/run_inla_fixpre.R"</span>)</span>
<span id="cb13-474"><a href="#cb13-474" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb13-475"><a href="#cb13-475" aria-hidden="true" tabindex="-1"></a>plots_coef <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb13-476"><a href="#cb13-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-477"><a href="#cb13-477" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb13-478"><a href="#cb13-478" aria-hidden="true" tabindex="-1"></a>  plots_coef[[phe_type]] <span class="ot">&lt;-</span> <span class="fu">plot_coef_genus_cities</span>(r_output_dir, phe_type)</span>
<span id="cb13-479"><a href="#cb13-479" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-480"><a href="#cb13-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-481"><a href="#cb13-481" aria-hidden="true" tabindex="-1"></a>cities_genus <span class="ot">=</span> <span class="fu">wrap_plots</span>(plots_coef, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb13-482"><a href="#cb13-482" aria-hidden="true" tabindex="-1"></a>cities_genus</span>
<span id="cb13-483"><a href="#cb13-483" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-484"><a href="#cb13-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-485"><a href="#cb13-485" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3.2 Species level</span></span>
<span id="cb13-486"><a href="#cb13-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-487"><a href="#cb13-487" aria-hidden="true" tabindex="-1"></a>Given the tree diversity within each genera, I also explored the species-level response to temperature. Here, I select 10 most abundant species shared by these 4 cities:</span>
<span id="cb13-488"><a href="#cb13-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-491"><a href="#cb13-491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-492"><a href="#cb13-492" aria-hidden="true" tabindex="-1"></a>species_table <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb13-493"><a href="#cb13-493" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span>Canonical_Name,            <span class="sc">~</span>Common_Name,</span>
<span id="cb13-494"><a href="#cb13-494" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Fraxinus pennsylvanica"</span>,   <span class="st">"Green Ash"</span>,</span>
<span id="cb13-495"><a href="#cb13-495" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ulmus americana"</span>,          <span class="st">"American Elm"</span>,</span>
<span id="cb13-496"><a href="#cb13-496" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Acer rubrum"</span>,              <span class="st">"Red Maple"</span>,</span>
<span id="cb13-497"><a href="#cb13-497" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Quercus rubra"</span>,            <span class="st">"Northern Red Oak"</span>,</span>
<span id="cb13-498"><a href="#cb13-498" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Acer saccharinum"</span>,         <span class="st">"Silver Maple"</span>,</span>
<span id="cb13-499"><a href="#cb13-499" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Fraxinus americana"</span>,       <span class="st">"White Ash"</span>,</span>
<span id="cb13-500"><a href="#cb13-500" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Ulmus pumila"</span>,             <span class="st">"Siberian Elm"</span>,</span>
<span id="cb13-501"><a href="#cb13-501" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Betula nigra"</span>,             <span class="st">"River Birch"</span>,</span>
<span id="cb13-502"><a href="#cb13-502" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Quercus macrocarpa"</span>,       <span class="st">"Bur Oak"</span>,</span>
<span id="cb13-503"><a href="#cb13-503" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Juglans nigra"</span>,            <span class="st">"Black Walnut"</span></span>
<span id="cb13-504"><a href="#cb13-504" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-505"><a href="#cb13-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-506"><a href="#cb13-506" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(species_table, <span class="at">caption =</span> <span class="st">"Top 10 Common Urban Tree Species"</span>)</span>
<span id="cb13-507"><a href="#cb13-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-508"><a href="#cb13-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-509"><a href="#cb13-509" aria-hidden="true" tabindex="-1"></a><span class="fu">#### New York City</span></span>
<span id="cb13-510"><a href="#cb13-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-513"><a href="#cb13-513" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-514"><a href="#cb13-514" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ny_sp</span></span>
<span id="cb13-515"><a href="#cb13-515" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb13-516"><a href="#cb13-516" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb13-517"><a href="#cb13-517" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb13-518"><a href="#cb13-518" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The distribution of the posterior of regression coefficients for `Temp~avg~` for each species in New York city."</span></span>
<span id="cb13-519"><a href="#cb13-519" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb13-520"><a href="#cb13-520" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb13-521"><a href="#cb13-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-522"><a href="#cb13-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-523"><a href="#cb13-523" aria-hidden="true" tabindex="-1"></a>r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/NY/"</span>)</span>
<span id="cb13-524"><a href="#cb13-524" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/species_level/run_inla.R"</span>)</span>
<span id="cb13-525"><a href="#cb13-525" aria-hidden="true" tabindex="-1"></a>plots_coef <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb13-526"><a href="#cb13-526" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb13-527"><a href="#cb13-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-528"><a href="#cb13-528" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb13-529"><a href="#cb13-529" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">plot_coef_sp_city</span>(r_output_dir, phe_type)</span>
<span id="cb13-530"><a href="#cb13-530" aria-hidden="true" tabindex="-1"></a>  plots_coef[[phe_type]] <span class="ot">&lt;-</span> p1<span class="sc">$</span>coef_summary_plot</span>
<span id="cb13-531"><a href="#cb13-531" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-532"><a href="#cb13-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-533"><a href="#cb13-533" aria-hidden="true" tabindex="-1"></a>ny_sp <span class="ot">=</span> <span class="fu">wrap_plots</span>(plots_coef, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb13-534"><a href="#cb13-534" aria-hidden="true" tabindex="-1"></a>ny_sp</span>
<span id="cb13-535"><a href="#cb13-535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-536"><a href="#cb13-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-537"><a href="#cb13-537" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Comparison across 4 cities</span></span>
<span id="cb13-538"><a href="#cb13-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-541"><a href="#cb13-541" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb13-542"><a href="#cb13-542" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cities_sp</span></span>
<span id="cb13-543"><a href="#cb13-543" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: true</span></span>
<span id="cb13-544"><a href="#cb13-544" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The distribution of the posterior of regression coefficients for `Temp~avg~` on phenology for each species"</span></span>
<span id="cb13-545"><a href="#cb13-545" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb13-546"><a href="#cb13-546" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 10</span></span>
<span id="cb13-547"><a href="#cb13-547" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 8</span></span>
<span id="cb13-548"><a href="#cb13-548" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb13-549"><a href="#cb13-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-550"><a href="#cb13-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-551"><a href="#cb13-551" aria-hidden="true" tabindex="-1"></a>r_output_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/"</span>)</span>
<span id="cb13-552"><a href="#cb13-552" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"~/phenology-urban/script/species_level/run_inla.R"</span>)</span>
<span id="cb13-553"><a href="#cb13-553" aria-hidden="true" tabindex="-1"></a>phe_types <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"SOS"</span>, <span class="st">"EOS"</span>, <span class="st">"GreenUp"</span>, <span class="st">"GreenDown"</span>)</span>
<span id="cb13-554"><a href="#cb13-554" aria-hidden="true" tabindex="-1"></a>plots_coef <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb13-555"><a href="#cb13-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-556"><a href="#cb13-556" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (phe_type <span class="cf">in</span> phe_types) {</span>
<span id="cb13-557"><a href="#cb13-557" aria-hidden="true" tabindex="-1"></a>  plots_coef[[phe_type]] <span class="ot">&lt;-</span> <span class="fu">plot_coef_sp_cities</span>(r_output_dir, phe_type)</span>
<span id="cb13-558"><a href="#cb13-558" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-559"><a href="#cb13-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-560"><a href="#cb13-560" aria-hidden="true" tabindex="-1"></a>cities_sp <span class="ot">=</span> <span class="fu">wrap_plots</span>(plots_coef, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb13-561"><a href="#cb13-561" aria-hidden="true" tabindex="-1"></a>cities_sp</span>
<span id="cb13-562"><a href="#cb13-562" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb13-563"><a href="#cb13-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-564"><a href="#cb13-564" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4 Conclusion and next step</span></span>
<span id="cb13-565"><a href="#cb13-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-566"><a href="#cb13-566" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conclusion</span></span>
<span id="cb13-567"><a href="#cb13-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-568"><a href="#cb13-568" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Within the city, trees indeed respond to temperature variation, result in phenology variation.</span>
<span id="cb13-569"><a href="#cb13-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-570"><a href="#cb13-570" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Across cities, response variation patterns noticed.</span>
<span id="cb13-571"><a href="#cb13-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-572"><a href="#cb13-572" aria-hidden="true" tabindex="-1"></a><span class="fu">### Next steps</span></span>
<span id="cb13-573"><a href="#cb13-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-574"><a href="#cb13-574" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**What can the urban phenology heterogenity be used for?** - Goal</span>
<span id="cb13-575"><a href="#cb13-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-576"><a href="#cb13-576" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>The preview of future warming: compared with the sensitivity in natural environment.</span>
<span id="cb13-577"><a href="#cb13-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-578"><a href="#cb13-578" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Fine-scale urban phenology: compared with other urban phenology sensitivity detected at coarser scale</span>
<span id="cb13-579"><a href="#cb13-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-580"><a href="#cb13-580" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Scale up</span>
<span id="cb13-581"><a href="#cb13-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-582"><a href="#cb13-582" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Cities</span>
<span id="cb13-583"><a href="#cb13-583" aria-hidden="true" tabindex="-1"></a><span class="ss">    -   </span>Genera</span>
<span id="cb13-584"><a href="#cb13-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-585"><a href="#cb13-585" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #### Denver --&gt;</span></span>
<span id="cb13-586"><a href="#cb13-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-587"><a href="#cb13-587" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb13-588"><a href="#cb13-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-589"><a href="#cb13-589" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- r_output_dir &lt;- paste0("~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/DV/") --&gt;</span></span>
<span id="cb13-590"><a href="#cb13-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-591"><a href="#cb13-591" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- source("~/phenology-urban/script/species_level/run_inla.R") --&gt;</span></span>
<span id="cb13-592"><a href="#cb13-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-593"><a href="#cb13-593" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- plots_coef &lt;- list() --&gt;</span></span>
<span id="cb13-594"><a href="#cb13-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-595"><a href="#cb13-595" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- phe_types &lt;- c("SOS", "EOS", "GreenUp", "GreenDown") --&gt;</span></span>
<span id="cb13-596"><a href="#cb13-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-597"><a href="#cb13-597" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- for (phe_type in phe_types) { --&gt;</span></span>
<span id="cb13-598"><a href="#cb13-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-599"><a href="#cb13-599" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   p1 &lt;- plot_coef_sp_city(r_output_dir, phe_type) --&gt;</span></span>
<span id="cb13-600"><a href="#cb13-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-601"><a href="#cb13-601" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   plots_coef[[phe_type]] &lt;- p1$coef_summary_plot --&gt;</span></span>
<span id="cb13-602"><a href="#cb13-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-603"><a href="#cb13-603" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- } --&gt;</span></span>
<span id="cb13-604"><a href="#cb13-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-605"><a href="#cb13-605" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- dv_sp = wrap_plots(plots_coef, ncol = 2) --&gt;</span></span>
<span id="cb13-606"><a href="#cb13-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-607"><a href="#cb13-607" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- dv_sp --&gt;</span></span>
<span id="cb13-608"><a href="#cb13-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-609"><a href="#cb13-609" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb13-610"><a href="#cb13-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-611"><a href="#cb13-611" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #### Seattle --&gt;</span></span>
<span id="cb13-612"><a href="#cb13-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-613"><a href="#cb13-613" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb13-614"><a href="#cb13-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-615"><a href="#cb13-615" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- r_output_dir &lt;- paste0("~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/ST/") --&gt;</span></span>
<span id="cb13-616"><a href="#cb13-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-617"><a href="#cb13-617" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- source("~/phenology-urban/script/species_level/run_inla.R") --&gt;</span></span>
<span id="cb13-618"><a href="#cb13-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-619"><a href="#cb13-619" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- plots_coef &lt;- list() --&gt;</span></span>
<span id="cb13-620"><a href="#cb13-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-621"><a href="#cb13-621" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- phe_types &lt;- c("SOS", "EOS", "GreenUp", "GreenDown") --&gt;</span></span>
<span id="cb13-622"><a href="#cb13-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-623"><a href="#cb13-623" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- for (phe_type in phe_types) { --&gt;</span></span>
<span id="cb13-624"><a href="#cb13-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-625"><a href="#cb13-625" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   p1 &lt;- plot_coef_sp_city(r_output_dir, phe_type) --&gt;</span></span>
<span id="cb13-626"><a href="#cb13-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-627"><a href="#cb13-627" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   plots_coef[[phe_type]] &lt;- p1$coef_summary_plot --&gt;</span></span>
<span id="cb13-628"><a href="#cb13-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-629"><a href="#cb13-629" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- } --&gt;</span></span>
<span id="cb13-630"><a href="#cb13-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-631"><a href="#cb13-631" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- st_sp = wrap_plots(plots_coef, ncol = 2) --&gt;</span></span>
<span id="cb13-632"><a href="#cb13-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-633"><a href="#cb13-633" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- st_sp --&gt;</span></span>
<span id="cb13-634"><a href="#cb13-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-635"><a href="#cb13-635" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
<span id="cb13-636"><a href="#cb13-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-637"><a href="#cb13-637" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- #### Houston --&gt;</span></span>
<span id="cb13-638"><a href="#cb13-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-639"><a href="#cb13-639" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ```{r} --&gt;</span></span>
<span id="cb13-640"><a href="#cb13-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-641"><a href="#cb13-641" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- r_output_dir &lt;- paste0("~/phenology-urban/data/proc/urban/sp_model/fixed_preseason/inla_year_random_species10/HT/") --&gt;</span></span>
<span id="cb13-642"><a href="#cb13-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-643"><a href="#cb13-643" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- source("~/phenology-urban/script/species_level/run_inla.R") --&gt;</span></span>
<span id="cb13-644"><a href="#cb13-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-645"><a href="#cb13-645" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- plots_coef &lt;- list() --&gt;</span></span>
<span id="cb13-646"><a href="#cb13-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-647"><a href="#cb13-647" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- phe_types &lt;- c("SOS", "EOS", "GreenUp", "GreenDown") --&gt;</span></span>
<span id="cb13-648"><a href="#cb13-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-649"><a href="#cb13-649" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- for (phe_type in phe_types) { --&gt;</span></span>
<span id="cb13-650"><a href="#cb13-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-651"><a href="#cb13-651" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   p1 &lt;- plot_coef_sp_city(r_output_dir, phe_type) --&gt;</span></span>
<span id="cb13-652"><a href="#cb13-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-653"><a href="#cb13-653" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--   plots_coef[[phe_type]] &lt;- p1$coef_summary_plot --&gt;</span></span>
<span id="cb13-654"><a href="#cb13-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-655"><a href="#cb13-655" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- } --&gt;</span></span>
<span id="cb13-656"><a href="#cb13-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-657"><a href="#cb13-657" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ht_sp = wrap_plots(plots_coef, ncol = 2) --&gt;</span></span>
<span id="cb13-658"><a href="#cb13-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-659"><a href="#cb13-659" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ht_sp --&gt;</span></span>
<span id="cb13-660"><a href="#cb13-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-661"><a href="#cb13-661" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ``` --&gt;</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>